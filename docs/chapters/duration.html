<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.475">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Microeconometrics with R - 13&nbsp; Duration models</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../chapters/rum.html" rel="next">
<link href="../chapters/count.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script><script src="../site_libs/kePrint/kePrint.js"></script><link href="../site_libs/lightable/lightable.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }"><div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Duration models</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Microeconometrics with R</a> 
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">Preface</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../OLS.html" class="sidebar-item-text sidebar-link">Ordinary least squares estimator</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/simple_regression.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Simple linear regression model</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/simple_regression_properties.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Statistical properties of the simple linear estimator</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/multiple_regression.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Multiple regression model</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/coefficients.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Interpretation of the Coefficients</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../beyond_OLS.html" class="sidebar-item-text sidebar-link">Beyond the OLS estimator</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/maximum_likelihood.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Maximum likelihood estimator</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/non_spherical.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Non-spherical disturbances</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/endogeneity.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Endogeneity</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/treateff.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Treatment effect</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/spatial.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Spatial econometrics</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../special_responses.html" class="sidebar-item-text sidebar-link">Special responses</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/binomial.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Binomial models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/tobit.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Censored and truncated models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/count.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Count data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/duration.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Duration models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/rum.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Discrete choice models</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../references.html" class="sidebar-item-text sidebar-link">References</a>
  </div>
</li>
    </ul>
</div>
</nav><!-- margin-sidebar --><div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li>
<a href="#sec-kaplan_maier" id="toc-sec-kaplan_maier" class="nav-link active" data-scroll-target="#sec-kaplan_maier"><span class="toc-section-number">13.1</span>  Kaplan-Meier non-parametric estimator</a>
  <ul class="collapse">
<li><a href="#uncensored-sample" id="toc-uncensored-sample" class="nav-link" data-scroll-target="#uncensored-sample">Uncensored sample</a></li>
  <li><a href="#censored-sample" id="toc-censored-sample" class="nav-link" data-scroll-target="#censored-sample">Censored sample</a></li>
  <li><a href="#different-groups" id="toc-different-groups" class="nav-link" data-scroll-target="#different-groups">Different groups</a></li>
  </ul>
</li>
  <li>
<a href="#sec-param_duration" id="toc-sec-param_duration" class="nav-link" data-scroll-target="#sec-param_duration"><span class="toc-section-number">13.2</span>  Parametric and semi-parametric estimators</a>
  <ul class="collapse">
<li><a href="#constant-hazard-and-the-exponential-distribution" id="toc-constant-hazard-and-the-exponential-distribution" class="nav-link" data-scroll-target="#constant-hazard-and-the-exponential-distribution">Constant hazard and the exponential distribution</a></li>
  <li><a href="#estimation" id="toc-estimation" class="nav-link" data-scroll-target="#estimation">Estimation</a></li>
  <li><a href="#accelerated-failure-time-model" id="toc-accelerated-failure-time-model" class="nav-link" data-scroll-target="#accelerated-failure-time-model">Accelerated failure time model</a></li>
  <li><a href="#proportional-hazard-models" id="toc-proportional-hazard-models" class="nav-link" data-scroll-target="#proportional-hazard-models">Proportional hazard models</a></li>
  </ul>
</li>
  <li>
<a href="#sec-heter_duration" id="toc-sec-heter_duration" class="nav-link" data-scroll-target="#sec-heter_duration"><span class="toc-section-number">13.3</span>  Heterogeneity</a>
  <ul class="collapse">
<li><a href="#detecting-heterogeneity" id="toc-detecting-heterogeneity" class="nav-link" data-scroll-target="#detecting-heterogeneity">Detecting heterogeneity</a></li>
  <li><a href="#weibull-gamma-model" id="toc-weibull-gamma-model" class="nav-link" data-scroll-target="#weibull-gamma-model">Weibull-Gamma model</a></li>
  </ul>
</li>
  <li>
<a href="#sec-misc_duration" id="toc-sec-misc_duration" class="nav-link" data-scroll-target="#sec-misc_duration"><span class="toc-section-number">13.4</span>  Other models</a>
  <ul class="collapse">
<li><a href="#multi-state-models" id="toc-multi-state-models" class="nav-link" data-scroll-target="#multi-state-models">Multi-state models</a></li>
  <li><a href="#grouped-data" id="toc-grouped-data" class="nav-link" data-scroll-target="#grouped-data">Grouped data</a></li>
  <li><a href="#interval-regression" id="toc-interval-regression" class="nav-link" data-scroll-target="#interval-regression">Interval regression</a></li>
  </ul>
</li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span id="sec-duration" class="quarto-section-identifier d-none d-lg-block"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Duration models</span></span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header><p>When the response is a duration, specific models are used, which comes from the biostatistics (eg lifetime after an hearth transplant) and operations research (eg lifetime of a light bulb) literature. These data are called <strong>duration</strong> or <strong>transition</strong> data. The latter term indicates that we are interested in the time span of the transition from one state to another, the latter being called <strong>death</strong> and <strong>failure</strong>, respectively in the biostatistics and the operations research fields. For a given time, the observations for which the transition didn’t take place are called <strong>at-risk</strong> observations. </p>
<p>Duration data have two main characteristics, that require the use of specific models. The first is that they are continuous-positive variables. The second is that they are often censored, especially right-censored; for example, trying to modelize the length of unemployment spells, we’ll use survey data on employment realized in a given period (for example 2 years). At the end of the survey, some individuals are still unemployed because the spell is not finished, so that the duration of their spell is not observed, but only the fact that it is greater than the observed duration at the end of the survey.</p>
<p>Denote <span class="math inline">\(t\)</span> as the duration response. Its distribution is given by a probability <span class="math inline">\(\mbox{P}(T \leq t) =F(t)\)</span> and a density function <span class="math inline">\(f(t)\)</span>. The survival function is often used, which is <span class="math inline">\(S(t) = P(T &gt; t) = 1 - F(t)\)</span>.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> For example, if <span class="math inline">\(T\)</span> is measured in month and if <span class="math inline">\(t = 12\)</span>, <span class="math inline">\(F(12) = 0.8\)</span> means that 80% of unemployment spells are less than 1 year, and <span class="math inline">\(S(12) = 0.2\)</span> means that 20% of unemployment spells are more than 1 year. For a small variation of the spell (say <span class="math inline">\(dt = 1\)</span> month), <span class="math inline">\(f(t)dt\)</span> is the probability that the length of the spell is between <span class="math inline">\(t\)</span> and <span class="math inline">\(t + dt\)</span> (between 12 and 13 months in our example). Assume that <span class="math inline">\(f(12) = 0.06\)</span>. It means that 6% of the spells ends between the 12<sup>th</sup> and the 13<sup>th</sup> month. If we divide by <span class="math inline">\(S(12) = 0.2\)</span>, we get <span class="math inline">\(f(12) / S(12) = 0.3\)</span>, which means that 30% of the spells of at least one year ends during the 13<sup>th</sup> month. This is called the <strong>hazard function</strong> and it plays a central role in duration analysis. More formally, the hazard function is defined by:</p>
<p><span id="eq-hazard_function"><span class="math display">\[
\theta(t)=  \lim_{dt \rightarrow 0} \frac{\mbox{P}(t \leq T &lt; t + dt \mid T &gt; t)}{dt} = \lim_{dt \rightarrow 0} \frac{F(t + dt) - F(t)}{1 - F(t)} = \frac{f(t)}{S(t)}
\tag{13.1}\]</span></span></p>
<p>The hazard function is also the derivative of the opposite of the logarithm of the survival function: <span class="math inline">\(\frac{\partial \ln S}{\partial t} = \frac{- f(t)}{S(t)} = - \theta(t)\)</span> Inversely, the log survival function is a primitive of the hazard, so that, using the fact that <span class="math inline">\(S(0) = 1\)</span>, the <strong>cumulative hazard</strong> function <span class="math inline">\(\Lambda(t)\)</span> is: </p>
<p><span id="eq-cummulative_hazard"><span class="math display">\[
\Lambda(t) = \int_{0} ^ t \theta(s) ds = - \ln S(t)
\tag{13.2}\]</span></span></p>
<p>Now consider the area under the survival curve: <span class="math inline">\(\int_{0} ^ {+\infty} S(t) dt\)</span>. Integrating by part, we get: <span class="math inline">\(\int_0 ^ {+\infty} S(t) dt = \left[t S(t)\right]_0 ^ {+\infty} - \int_{0} ^ {+\infty} -f(t) t dt = \int_{0} ^ {+\infty} f(t) t dt\)</span> as <span class="math inline">\(\lim_{t \rightarrow + \infty} S(t) t = 0\)</span>. Therefore, this area is the expected value of the duration of the spell.</p>
<p>The hazard and survival functions can also be defined in terms of discrete time either because the duration is intrinsically discrete or because it is rounded to a given time unit (weeks or months, for example). Consider that the event is observed for <span class="math inline">\(K\)</span> distinct times, denoted by <span class="math inline">\(t_1, t_2, \ldots t_k, \ldots t_K\)</span>. If there are no ties, which means that all the events occur at a specific time, then <span class="math inline">\(K=N\)</span>. The <strong>discrete-time hazard</strong> function is the probability of transition at time <span class="math inline">\(t_j\)</span> given survival to time <span class="math inline">\(t_j\)</span>:</p>
<p><span class="math display">\[\theta_j = P(T = t_j \mid T \geq t_j) = \frac{f^d(t_j)}{S^d(t_{j-})}\]</span></p>
<p>where <span class="math inline">\(S^d(t_{j-})\)</span> is the value of the survival function just before <span class="math inline">\(t_j\)</span>. The <strong>discrete-time survivor function</strong> is obtained from the hazard function: <span class="math inline">\(S^d(t) = P(T \geq t) = \prod_{j | t_j \leq t} (1 - \theta_j)\)</span>. For example, the probability of surviving at least to <span class="math inline">\(t_2\)</span> is: <span class="math inline">\(S^d(t_2) = (1 - \theta_1) (1 - \theta_2)\)</span>. The first term is the probability of no transition at <span class="math inline">\(t_1\)</span>, and the second one is the probability of no transition at <span class="math inline">\(t_2\)</span> conditional on surviving to just before <span class="math inline">\(t_2\)</span>.</p>
<p><a href="#sec-kaplan_maier"><span>Section&nbsp;13.1</span></a> is devoted to the non-parametric estimation of the survival function. <a href="#sec-param_duration"><span>Section&nbsp;13.2</span></a> presents different parametric and semi-parametric estimators. <a href="#sec-heter_duration"><span>Section&nbsp;13.3</span></a> tackles the problem of heterogeneity in duration models. Finally, <a href="#sec-misc_duration"><span>Section&nbsp;13.4</span></a> presents miscellaneous duration models.</p>
<p>Duration analysis using <strong>R</strong> is performed using the <strong>survival</strong> package, which is a “recommended” package, which means that it comes with any <strong>R</strong> distribution.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/therneau/survival">survival</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="sec-kaplan_maier" class="level2" data-number="13.1"><h2 data-number="13.1" class="anchored" data-anchor-id="sec-kaplan_maier">
<span class="header-section-number">13.1</span> Kaplan-Meier non-parametric estimator</h2>
<p> The Kaplan-Meier estimator is a non-parametric estimator of the survival function. As such, it is very useful as a primary tool before developing more complicated parametric models.</p>
<section id="uncensored-sample" class="level3"><h3 class="anchored" data-anchor-id="uncensored-sample">Uncensored sample</h3>
<p> To demonstrate this estimator, it is convenient to use first uncensored data. This is the case of the <code>oil</code> <span class="citation" data-cites="FAVE:PESA:SHAR:94">(<a href="#ref-FAVE:PESA:SHAR:94" role="doc-biblioref">Favero, Pesaran, and Sharma 1994</a>)</span> data set which indicates the number of months between the discovery of an oil field and the beginning of development. For each failure times <span class="math inline">\(t_k\)</span>, we count the number of events <span class="math inline">\(d_k\)</span> (the number of spells ending at time <span class="math inline">\(t_k\)</span>) and the number of observations at-risk, i.e., the number of spells which haven’t ended just before <span class="math inline">\(t_k\)</span>, denoted by <span class="math inline">\(r_k\)</span>. For the <code>oil</code> data set, we have 53 observations and the first ordered values of duration are: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">oil</span> <span class="op">%&gt;%</span> <span class="fu">arrange</span><span class="op">(</span><span class="va">dur</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">pull</span><span class="op">(</span><span class="va">dur</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">head</span></span>
<span><span class="co">## [1]  1  3  3  7  8 10</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Therefore, <span class="math inline">\(t_1 = 1\)</span> and <span class="math inline">\(r_1 = 53\)</span> because all the spells are at risk just before time is equal to 1. The hazard function for <span class="math inline">\(t_1\)</span> is then estimated by <span class="math inline">\(1/53 = 0.0189\)</span>, and the survival function by <span class="math inline">\(1 - 1/53 = 0.981\)</span>, which means that the estimated probability that the spell is greater than 1 month is <span class="math inline">\(98.1\)</span>%. For <span class="math inline">\(t_2= 3\)</span>, we have <span class="math inline">\(d_2 = 2\)</span> and the number of observations at risk are the ongoing spells just before time is equal to 2, which is <span class="math inline">\(r_2 = r_1 - d_1 = 52\)</span>. The hazard function for <span class="math inline">\(t_2 = 3\)</span> is then <span class="math inline">\(d_2 / r_2 = 2 / 52 = 0.038\)</span>, which means that the estimated probability of ending at time 3 for spells which are at least 1 month long is <span class="math inline">\(3.8\)</span>%. The survival function for time equal to 3 is therefore:<span class="math inline">\((1 - d_1 / r_1) \times (1 - d_2 / r_2) = 0.981 \times 0.961 = 0.943\)</span>. Note that as <span class="math inline">\(r_1 = N\)</span> and <span class="math inline">\(r_2 = r_1 - d_1 = N - d_1\)</span>, the estimated survival probability for <span class="math inline">\(t_2\)</span> is <span class="math inline">\((1 - d_1 / N)(1 - d_2 / (N - d_1))\)</span>, which simplifies to <span class="math inline">\(1 - (d_1 + d_2) / N\)</span>. For <span class="math inline">\(t_3 = 7\)</span>, we have <span class="math inline">\(d_3 / r_3 = 1 / 50 = 0.02\)</span> and the survival function can be either estimated by <span class="math inline">\(0.943 \times (1 - 0.02)\)</span> or by <span class="math inline">\((1 - 4 / 53) = 0.9245\)</span>.</p>
<p>The whole survival series can be easily obtained with the following code; we first create a frequency table of durations (the durations are then automatically arranged in an increasing order), the <code>n</code> column then contains the number of spells that end at each period. We then compute the cumulative sums of this counts <code>cumn</code> and the survival probabilities as the cumulative count divided by <span class="math inline">\(N\)</span>. </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">surv_tb</span> <span class="op">&lt;-</span> <span class="va">oil</span> <span class="op">%&gt;%</span> <span class="fu">count</span><span class="op">(</span><span class="va">dur</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>cumn <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumsum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>, surv <span class="op">=</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">cumn</span> <span class="op">/</span> <span class="fl">53</span><span class="op">)</span></span>
<span><span class="va">surv_tb</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 46 × 4
    dur     n  cumn  surv
  &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt;
1     1     1     1 0.981
2     3     2     3 0.943
3     7     1     4 0.925
4     8     1     5 0.906
5    10     2     7 0.868
# ℹ 41 more rows</code></pre>
</div>
</div>
<p>A more complex calculus (but which will prove to be useful if there are censored spells) consists of computing the number of spells at risk, the hazard and then the survival function as the cumulative product of 1 minus the hazard rate. </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">oil</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">count</span><span class="op">(</span><span class="va">dur</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>cumn <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumsum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>,</span>
<span>           at_risk <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">dur</span> <span class="op">==</span> <span class="fl">1</span>, <span class="fl">53</span>, <span class="fl">53</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lag.html">lag</a></span><span class="op">(</span><span class="va">cumn</span><span class="op">)</span><span class="op">)</span>,</span>
<span>           hazard <span class="op">=</span> <span class="va">n</span> <span class="op">/</span> <span class="va">at_risk</span>,</span>
<span>           surv <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumprod</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">hazard</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 46 × 6
    dur     n  cumn at_risk hazard  surv
  &lt;int&gt; &lt;int&gt; &lt;int&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
1     1     1     1      53 0.0189 0.981
2     3     2     3      52 0.0385 0.943
3     7     1     4      50 0.02   0.925
4     8     1     5      49 0.0204 0.906
5    10     2     7      48 0.0417 0.868
# ℹ 41 more rows</code></pre>
</div>
</div>
<p>The survival function can also be plotted. As it is a step function, using the <code>geom_step</code> function is particularly useful, see <a href="#fig-survcurve">Figure&nbsp;<span>13.1</span></a>. </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">km_oil</span> <span class="op">&lt;-</span> <span class="va">surv_tb</span> <span class="op">%&gt;%</span> <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span><span class="va">dur</span>, <span class="va">surv</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu">geom_step</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">km_oil</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-survcurve" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="duration_files/figure-html/fig-survcurve-1.png" class="img-fluid figure-img" style="width:60.0%"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;13.1: Survival curve for the oil data set</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Reminding that <span class="math inline">\(\frac{\partial \ln S(t)}{\partial t} = - \lambda(t)\)</span>, it is useful to use a logarithmic y-axis as, the hazard is then the slope (in absolute value) of the curve (see <a href="#fig-logsurvcurve">Figure&nbsp;<span>13.2</span></a>). In particular, the constant hazard hypothesis would induce a roughly linear survival curve. </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">km_oil</span> <span class="op">+</span> <span class="fu">coord_cartesian</span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">150</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">scale_y_continuous</span><span class="op">(</span>trans <span class="op">=</span> <span class="st">"log"</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.01</span>, <span class="fl">0.1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">geom_smooth</span><span class="op">(</span>se <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-logsurvcurve" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="duration_files/figure-html/fig-logsurvcurve-1.png" class="img-fluid figure-img" style="width:60.0%"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;13.2: Survival curve for the oil data set with a log scale</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>We can see in this example that the hazard rate seems to be roughly constant for a wide range of values of duration (0-100 months) and then decreasing for high values of duration (<span class="math inline">\(&gt;100\)</span>). The Kaplan-Meier estimator can also be computed using the <code>survreg::surfit</code> function, with the usual formula-data interface. The response must be a <code>Surv</code> object, and the right-hand side of the formula is just an intercept. A <code>Surv</code> object is obtained using the <code>Surv</code> function. With uncensored data, its only argument is the duration response. We then have: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">dur</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>, data <span class="op">=</span> <span class="va">oil</span><span class="op">)</span></span>
<span><span class="va">sf</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call: survfit(formula = Surv(dur) ~ 1, data = oil)

      n events median 0.95LCL 0.95UCL
[1,] 53     53     51      28      72</code></pre>
</div>
</div>
<p>The <code>print</code> method returns the number of observations (<code>n</code>) the number of events (<code>events</code>), which is equal to the number of observations if all the spells are uncensored, the median spell duration and its 95% confidence interval. The <code>print.summary</code> function returns a table with one row for each time some spells end. The object returned by <code>survfit</code> is not a data frame, but the <code>broom:tidy</code> method coerces it easily to a tibble: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">broom</span><span class="fu">::</span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op">(</span><span class="va">sf</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 46 × 8
   time n.risk n.event n.censor estimate std.error conf.high
  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;
1     1     53       1        0    0.981    0.0190     1    
2     3     52       2        0    0.943    0.0336     1    
3     7     50       1        0    0.925    0.0392     0.998
4     8     49       1        0    0.906    0.0443     0.988
5    10     48       2        0    0.868    0.0536     0.964
# ℹ 41 more rows
# ℹ 1 more variable: conf.low &lt;dbl&gt;</code></pre>
</div>
</div>
<p>There is a <code>plot</code> method for <code>survfit</code> objects that draws the survival curve and its confidence interval. </p>
</section><section id="censored-sample" class="level3"><h3 class="anchored" data-anchor-id="censored-sample">Censored sample</h3>
<p> When there are censored observations, the computation is modified. Consider the <code>retirement</code> data set <span class="citation" data-cites="AN:CHRI:GUPT:04">(<a href="#ref-AN:CHRI:GUPT:04" role="doc-biblioref">An, Christensen, and Gupta 2004</a>)</span>. It contains the joint duration until retirement for both spouses of 243 couples in Denmark. </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">retirement</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2,430 × 17
     id period  agem  agef dum84 unemp year0  durm  durf censm censf
  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1     1      1    52    54     0   9.2    81    10     6     0     1
2     1      2    53    55     0   9.8    81    10     6     0     1
3     1      3    54    56     0  10.5    81    10     6     0     1
4     1      4    55    57     1  10.1    81    10     6     0     1
5     1      5    56    58     1   9.1    81    10     6     0     1
# ℹ 2,425 more rows
# ℹ 6 more variables: skillm &lt;dbl&gt;, skillf &lt;dbl&gt;, owner &lt;dbl&gt;,
#   province &lt;dbl&gt;, year &lt;dbl&gt;, dum84bis &lt;dbl&gt;</code></pre>
</div>
</div>
<p><code>id</code> is the couple identifier, there are several annual observations for every couple (because some covariates are time-varying), the duration until retirement for males is <code>durm</code> and <code>censm</code> is a dummy which equals 1 if the observation is right-censored. The corresponding variables for women are <code>durf</code> and <code>censf</code>. We’ll concentrate on women. To get one observation for each woman, we simply select these two variables, which are time-invariant, and we keep only the distinct rows: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ret</span> <span class="op">&lt;-</span> <span class="va">retirement</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">select</span><span class="op">(</span><span class="va">id</span>, duration <span class="op">=</span> <span class="va">durf</span>, censored <span class="op">=</span> <span class="va">censf</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="fu">mutate</span><span class="op">(</span>censored <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">censored</span> <span class="op">==</span> <span class="fl">1</span>, <span class="st">"yes"</span>, <span class="st">"no"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>    <span class="va">distinct</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As there is no transition before 7, we set duration to 6 for durations lower than 7. We then construct a table containing for each period the number of events and the number of censored spells; we first count the occurrence of any duration-censored combinations, we then pivot the tibble in order to have one line for each duration and two columns for the number of events (<code>"no"</code>) and the number of censored observations (<code>"yes"</code>) for which we give finally more relevant names. </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ret_tbl</span> <span class="op">&lt;-</span> <span class="va">ret</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>duration <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">duration</span> <span class="op">&lt;</span> <span class="fl">7</span>, <span class="fl">6</span>, <span class="va">duration</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">count</span><span class="op">(</span><span class="va">duration</span>, <span class="va">censored</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">pivot_wider</span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">censored</span>, values_from <span class="op">=</span> <span class="va">n</span>, values_fill <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">rename</span><span class="op">(</span>event <span class="op">=</span> <span class="va">no</span>, censored <span class="op">=</span> <span class="va">yes</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div style="page-break-after: always;"></div>
<p>For each discrete time, we define the cumulative number of spells that exit the sample <code>cumn</code>, either because of transition or censoring. The number of observations at-risk just before <span class="math inline">\(t_j\)</span> is equal to the total sample size minus the lag of <code>cumn</code>: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ret_tbl</span> <span class="op">&lt;-</span> <span class="va">ret_tbl</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>cumn <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumsum</a></span><span class="op">(</span><span class="va">event</span> <span class="op">+</span> <span class="va">censored</span><span class="op">)</span>,</span>
<span>           atrisk <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">duration</span> <span class="op">==</span> <span class="fl">6</span>, <span class="fl">243</span>, <span class="fl">243</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lag.html">lag</a></span><span class="op">(</span><span class="va">cumn</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, we compute the hazard <span class="math inline">\(\hat{\theta}_j\)</span> as the ratio of the number of events at <span class="math inline">\(t_j\)</span> and the number of observations at risk just before <span class="math inline">\(t_j\)</span> and the survival <span class="math inline">\(\hat{S}_j\)</span> as the cumulative product of <span class="math inline">\((1 -\hat{\theta}_j)\)</span>. </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ret_tbl</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>hazard <span class="op">=</span> <span class="va">event</span> <span class="op">/</span> <span class="va">atrisk</span>,</span>
<span>           surv <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumprod</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">hazard</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 7
  duration censored event  cumn atrisk hazard   surv
     &lt;dbl&gt;    &lt;int&gt; &lt;int&gt; &lt;int&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
1        6       25     0    25    243 0      1     
2        7       11    21    57    218 0.0963 0.904 
3        8       12    12    81    186 0.0645 0.845 
4        9       10    17   108    162 0.105  0.757 
5       10       14   121   243    135 0.896  0.0785</code></pre>
</div>
</div>
<p>The same results are easily obtained using <code>survfit</code>. Once again, a formula-data interface is used, the response being a <code>Surv</code> object. In the context of a sample with right-censored observations, this object is obtained using the <code>Surv</code> function with two arguments:</p>
<ul>
<li>
<code>time</code> : the duration (observed or right-censored),</li>
<li>
<code>event</code> : a dummy for observed duration (i.e., uncensored observations). It can be either a boolean, 0/1 or 1/2.</li>
</ul>
<p>If the <code>Surv</code> function is used with two unnamed arguments, it is assumed that these two arguments are <code>time</code> and <code>event</code> in that order. We use in our example a boolean obtained from the <code>cens</code> variable: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">surv_ret</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">duration</span>, <span class="va">censored</span> <span class="op">==</span> <span class="st">"no"</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>, data <span class="op">=</span> <span class="va">ret</span><span class="op">)</span></span>
<span><span class="fu">broom</span><span class="fu">::</span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op">(</span><span class="va">surv_ret</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">slice</span><span class="op">(</span><span class="op">-</span> <span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 8
   time n.risk n.event n.censor estimate std.error conf.high
  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;
1     7    218      21       11   0.904     0.0221     0.944
2     8    186      12       12   0.845     0.0293     0.895
3     9    162      17       10   0.757     0.0398     0.818
4    10    135     121       14   0.0785    0.256      0.130
# ℹ 1 more variable: conf.low &lt;dbl&gt;</code></pre>
</div>
</div>
<p></p>
</section><section id="different-groups" class="level3"><h3 class="anchored" data-anchor-id="different-groups">Different groups</h3>
<p> When the observations belong to two or more groups, the survival curves can be estimated for each group. <!-- We now use the `recall` data set, initially used by @KATZ:86 and latter by @SUEY:95. It contains 1045 spells of unemployment from 1980.  --></p>
<p>We now use the <code>unemp_teachers</code> data set, initially used by <span class="citation" data-cites="KAST:VAND:22">Kastoryano and Klaauw (<a href="#ref-KAST:VAND:22" role="doc-biblioref">2022</a>)</span>. It contains 3064 observations of unemployed Dutch teachers. Some of them performed a training; they are identified by a dummy called <code>training</code>. We restrict the sample to those who didn’t perform a training and we measure the duration in years: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">unteach</span> <span class="op">&lt;-</span> <span class="va">unemp_teachers</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span> <span class="va">training</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="op">-</span> <span class="va">training</span>, <span class="op">-</span> <span class="va">time_training</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>time <span class="op">=</span> <span class="va">time</span> <span class="op">/</span> <span class="fl">365.25</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">unteach</span>, <span class="fl">3</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 9
  gender lowsk   age  wage  time spell uidur month  year
  &lt;fct&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1 female     0  48.5 14.0  0.586     1   822     8  2007
2 female     0  53.3 12.4  0.151     1    91     6  2007
3 female     0  50.9  7.99 0.501     1   183     8  2006</code></pre>
</div>
</div>
<!-- ```{r} -->
<!-- recall %>% head(3) -->
<!-- ``` -->
<!-- The analysis of @KATZ:86 showed that an important transition from unemployment was a recall from the previous employer. The `end` covariate indicates the different modalities of transition: -->
<!-- ```{r} -->
<!-- recall %>% count(end) -->
<!-- ``` -->
<!-- We consider the `new-job` and `recall` modalities as an indication of a complete spell and we use `survfit` with a factor and not an intercept as previously. More precisely, we use the `race` covariate to analyze wheter the survival function differ between whites and non-whites. -->
<!-- We now use the `unemp_duration` data set used by @WICH:WILK:08 who analyzed unemployment duration (in days) in Germany, for 21775 unemployment spells that started in 1996 and 1997 in West Germany: -->
<!-- ```{r} -->
<!-- unemp_duration %>% print(n = 3) -->
<!-- ``` -->
<!-- `wage` is the last daily wage before unemployment. To fit two survival curves for males and females, we use `survfit` with  -->
<!-- a formula where the right-hand side is now a factor and not just an intercept: -->
<!-- ```{r} -->
<!-- survfit_sex <- survfit(Surv(duration, censored == "no") ~ gender,  -->
<!--                        unemp_duration) -->
<!-- broom::tidy(survfit_sex) %>% print(n = 3) -->
<!-- ``` -->
<!-- ```{r} -->
<!-- survfit_race <- survfit(Surv(duration,  -->
<!--                              end %in% c("new-job", "recall")) ~ race, recall) -->
<!-- broom::tidy(survfit_race) %>% print(n = 3) -->
<!-- ``` -->
<p>We use <code>survfit</code>, this time with a factor, more precisely the gender factor to compute separate survival curves for males and females: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">survfit_gender</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html">survfit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">spell</span><span class="op">)</span> <span class="op">~</span> <span class="va">gender</span>, <span class="va">unteach</span><span class="op">)</span></span>
<span><span class="fu">broom</span><span class="fu">::</span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html">tidy</a></span><span class="op">(</span><span class="va">survfit_gender</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 450 × 9
    time n.risk n.event n.censor estimate std.error conf.high
   &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;
1 0.0110   1805       4        0    0.998   0.00111     1.00 
2 0.0137   1801       7        0    0.994   0.00184     0.998
3 0.0164   1794       6        0    0.991   0.00230     0.995
# ℹ 447 more rows
# ℹ 2 more variables: conf.low &lt;dbl&gt;, strata &lt;chr&gt;</code></pre>
</div>
</div>
<p>The <strong>survminer</strong> package provides the <strong>ggsurvplot</strong> function, based on <strong>ggplot2</strong>, which enables to draw nice and highly customizable survival curves, as in <a href="#fig-survival_curve">Figure&nbsp;<span>13.3</span></a> where we set the <code>risk.table</code> argument to <code>TRUE</code> in order to have a table of observations at risk just below the figure.</p>
<!-- ```{r} -->
<!-- #| label: fig-survival_curve -->
<!-- #| fig-cap: "Survival curves for unemployment duration in the United States" -->
<!-- #| fig-width: 8 -->
<!-- #| fig-height: 8 -->

<!-- survminer::ggsurvplot(survfit_race, risk.table = TRUE, conf.int = TRUE) -->
<!-- ``` -->
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">survminer</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/survminer/man/ggsurvplot.html">ggsurvplot</a></span><span class="op">(</span><span class="va">survfit_gender</span>, risk.table <span class="op">=</span> <span class="cn">TRUE</span>, conf.int <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-survival_curve" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="duration_files/figure-html/fig-survival_curve-1.png" class="img-fluid figure-img" style="width:60.0%"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;13.3: Survival curves for unemployment duration in the United States</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p> The hypothesis of identical survival curves can be tested using a log-rank test. Denoting <span class="math inline">\(d_{tg}\)</span> and <span class="math inline">\(r_{tg}\)</span> as the number of failures and the number of observations at risk for the <span class="math inline">\(t\)</span><sup>th</sup> duration and the g<sup>th</sup> group, under the hypothesis of identical survival curves, the fitted number of failures is: <span class="math display">\[\hat{d}_{tg}=\frac{d_{t1} + d_{t2}}{r_{t1} + r_{t2}} r_{tg}\]</span></p>
<p>The test statistic is based on <span class="math inline">\(\sum_t (d_{tg} - \hat{d}_{tg})\)</span>. Note that the value for the second group is necessarily the opposite of the one for the first group. The variance of this statistic is:</p>
<p><span class="math display">\[V = \frac{r_{t1}r_{t2}(r_t - d_t) d_t}{r_t^2(r_t-1)}\]</span></p>
<p>The statistic is then <span class="math inline">\(\left(\sum_t (d_{tg} - \hat{d}_{tg})\right) ^ 2 / V\)</span> and is <span class="math inline">\(\chi ^ 2\)</span> with 1 degree of freedom under the hypothesis of same survival. This test can be computed using the <code>survival::surfdiff</code> function, with the same syntax as the one used for <code>survfit</code>:</p>
<!-- ```{r} -->
<!-- survdiff(Surv(duration, censored == "no") ~ gender, unemp_duration) -->
<!-- ``` -->
<!-- ```{r} -->
<!-- survdiff(Surv(duration, end %in% c("new-job", "recall")) ~ race, recall) -->
<!-- ``` -->
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/survdiff.html">survdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">spell</span><span class="op">)</span> <span class="op">~</span> <span class="va">gender</span>, <span class="va">unteach</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
survdiff(formula = Surv(time, spell) ~ gender, data = unteach)

                 N Observed Expected (O-E)^2/E (O-E)^2/V
gender=female 1805     1600     1488      8.44      47.7
gender=male    319      222      334     37.60      47.7

 Chisq= 47.7  on 1 degrees of freedom, p= 5e-12 </code></pre>
</div>
</div>
<p>The hypothesis of identical survival for males and females is highly rejected. <!-- The hypothesis of identical survival for whites and non-whites is highly rejected. --> </p>
</section></section><section id="sec-param_duration" class="level2" data-number="13.2"><h2 data-number="13.2" class="anchored" data-anchor-id="sec-param_duration">
<span class="header-section-number">13.2</span> Parametric and semi-parametric estimators</h2>
<p>In this section, we introduce covariates that may explain the length of the duration, or the value of the hazard function. Two kinds of models can be developed. The full parametric model specifies the whole distribution of the hazard function. On the contrary, in a semi-parametric approach, the hazard is the product of two component, the first depending on time and some parameters and the second depending only on the covariates and some other parameters. Then, only the second component is estimated, and therefore, the shape of the hazard doesn’t need to be specified. We’ll first consider the benchmark exponential model, for which the hazard is constant.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p>
<section id="constant-hazard-and-the-exponential-distribution" class="level3"><h3 class="anchored" data-anchor-id="constant-hazard-and-the-exponential-distribution">Constant hazard and the exponential distribution</h3>
<p> Consider the special case where the hazard is a constant <span class="math inline">\(\theta\)</span>. From <a href="#eq-cummulative_hazard">Equation&nbsp;<span>13.2</span></a>, the cumulative hazard is then: <span class="math inline">\(\Lambda(t) = \int_0 ^ {t} \theta ds = \theta t = - \ln S(t)\)</span>. The survival function is then <span class="math inline">\(S(t) = e^{-\theta t}\)</span> and the opposite of its derivative is the density function <span class="math inline">\(f(t) = \theta e ^ {-\theta t}\)</span>. Therefore, if the hazard is constant, the distribution of <span class="math inline">\(T\)</span> is the exponential distribution with parameter <span class="math inline">\(\theta\)</span>, which will be denoted by: <span class="math inline">\(T \sim E (\theta)\)</span>.</p>
<p>The <strong>moment generating function</strong> of <span class="math inline">\(T\)</span> for the exponential distribution is: </p>
<p><span class="math display">\[M(s) = \mbox{E}\left(e^{sT}\right) = \int_0 ^ {+\infty}e^{st}\theta e^{-\theta t} dt =  \frac{\theta}{\theta - s}\]</span></p>
<p>for <span class="math inline">\(\theta &gt; s\)</span>. The <strong>cumulant generating function</strong> is the logarithm of the moment generating function:</p>
<p><span class="math display">\[
K(s) =\ln M(s) = \ln \theta - \ln(\theta - s)
\]</span></p>
<p>and the limit for <span class="math inline">\(s\rightarrow 0\)</span> of its first two derivatives with respect to <span class="math inline">\(s\)</span> are the expected value and the variance of <span class="math inline">\(T\)</span>. Therefore, <span class="math inline">\(\mbox{E}(T)= \frac{1}{\theta}\)</span> and <span class="math inline">\(\mbox{V}(T) = \frac{1}{\theta ^ 2}\)</span>. Therefore, for the exponential distribution, the mean equals the standard deviation. Moreover, the unit of measurement of <span class="math inline">\(\theta\)</span> is the inverse of the time unit, so that <span class="math inline">\(\theta dt\)</span> is a number without units.</p>
<p>Denote <span class="math inline">\(Z=\int_0 ^ T \theta(s) ds\)</span> as the cumulative hazard. This is a transformation of the time-scale such that <span class="math inline">\(dZ = \frac{\partial Z}{\partial T} dT = \theta(T) dT\)</span>. With constant hazard, <span class="math inline">\(Z\)</span> is simply proportional to <span class="math inline">\(T\)</span>, as <span class="math inline">\(dZ = \theta dT\)</span>, and the cumulative hazard is then <span class="math inline">\(\theta T\)</span>. For example, if the constant hazard is 0.1 and the time is measured in days, a variation of 1 in the initial time scale (1 day) corresponds to a variation of 0.1 on the transformed time scale. As the hazard is positive, we have:</p>
<p><span class="math display">\[ \mbox{P}(T \geq t) = \mbox{P}\left(\int_0 ^ T \theta(s) ds \geq
\int_0 ^ t \theta(s) ds\right) = \mbox{P}(Z \geq z) \]</span></p>
<p>As <span class="math inline">\(\mbox{P}(T \geq t) = e^ {-\int_0 ^ t \theta(s) ds}\)</span>, we finally get: <span class="math inline">\(\mbox{P}(Z \geq z) = e ^ {-z}\)</span>, which means that <span class="math inline">\(Z\)</span>, the cumulative hazard, is a unit exponential random variable: <span class="math inline">\(Z \sim E(1)\)</span>.</p>
<p>Finally, consider the moment generating function of <span class="math inline">\(\ln T\)</span> with <span class="math inline">\(T \sim E(\theta)\)</span>: </p>
<p><span class="math display">\[M(s)_{\ln T} = \mbox{E}\left( e ^ {s\ln T}\right) = \mbox{E}\left(T ^ s\right) = \int_0^{+\infty}t ^ s \theta e ^ {-\theta t}dt = \frac{\Gamma (1 + s)}{\theta ^ s}\]</span></p>
<p>with <span class="math inline">\(\Gamma(z) = \int_0^{+\infty}t^{z-1}e^{-t}dt\)</span> the Gamma function. The corresponding cumulant generating function is: <span class="math inline">\(K(s)_{\ln T} = \ln \Gamma(1 + s) - s\ln \theta\)</span>, from which we obtain the expected value <span class="math inline">\(\psi(1) - \ln \theta\)</span> and the variance, <span class="math inline">\(\psi'(1)\)</span>, where <span class="math inline">\(\psi\)</span> and <span class="math inline">\(\psi'\)</span> are the first and second derivatives of <span class="math inline">\(\ln \Gamma\)</span>. <span class="math inline">\(\psi\)</span> is called the digamma function and <span class="math inline">\(\psi(1)=-\gamma\)</span>, <span class="math inline">\(\gamma \approx 0.57721\)</span> being the Euler-Mascheronni constant. <span class="math inline">\(\psi'\)</span> is called the trigamma function and <span class="math inline">\(\psi'(1) = \pi ^ 2 / 6\)</span>. As <span class="math inline">\(Z = \theta T \sim E(1)\)</span>, the density of <span class="math inline">\(Z\)</span> is <span class="math inline">\(g(Z) = e ^ {-Z}\)</span>. Consider now <span class="math inline">\(U = \ln Z\)</span>. The density of <span class="math inline">\(U\)</span> is:</p>
<p><span class="math display">\[
f(U) = e ^ {- e ^ U}\left| \frac{dZ}{dU}\right| =  e ^ {- e ^ U} e ^ U
\]</span> which is the Gumbel distribution, also known as the extreme value distribution of type 1, for which <span class="math inline">\(F(U) = 1 - e^{-e^U}\)</span>, <span class="math inline">\(S(U) = e^{-e^U}\)</span>, <span class="math inline">\(\mbox{E}(U) = - \gamma\)</span> and <span class="math inline">\(\mbox{V}(U) = \pi ^ 2 / 6\)</span>.<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> As <span class="math inline">\(U = \ln Z = \ln T + \ln \theta\)</span>, we can write: </p>
<p><span class="math display">\[
\ln T = - \ln \theta + U
\]</span></p>
<p>Now consider that the hazard depends on some covariates and denote <span class="math inline">\(\theta_n\)</span> the value of the hazard for individual <span class="math inline">\(n\)</span>. Then we can write the exponential model in the following regression form:</p>
<p><span id="eq-duration_regression"><span class="math display">\[
\ln T_n = - \ln \theta_n + U_n = -(\gamma + \ln \theta_n) + (U_n + \gamma) = -(\gamma + \ln \theta_n) + W_n
\tag{13.3}\]</span></span></p>
<p>Then <span class="math inline">\(\mbox{E}(\ln T_n\mid z_n) = -(\gamma +\ln \theta_n)\)</span>, <span class="math inline">\(\mbox{E}(W\mid x_n) = 0\)</span> and <span class="math inline">\(\mbox{V}(W\mid x_n) = \pi ^ 2 / 6\)</span>. <span class="math inline">\(\theta\)</span> can be parametrized as <span class="math inline">\(e ^ {-\alpha + \beta ^ \top x_n}\)</span>, so that <span class="math inline">\(\ln T_n = (\alpha-\gamma) + \beta^\top x_n + W_n\)</span>. </p>
</section><section id="estimation" class="level3"><h3 class="anchored" data-anchor-id="estimation">Estimation</h3>
<p> Duration models are estimated by maximum likelihood. For censored observations, the contribution to the likelihood is the probability of surviving at the censoring time, which is <span class="math inline">\(S(t_n \mid x_n)\)</span>. For uncensored observations, this is the density function: <span class="math inline">\(f(t_n \mid x_n)\)</span>. Therefore, denoting <span class="math inline">\(d_n\)</span> a dummy for complete (uncensored) observations, we get:</p>
<p><span class="math display">\[
\ln L = \sum_{n=1} ^ N \left[d_n \ln f(t_n \mid x_n) + (1 - d_n) \ln S(t_n \mid x_n)\right]
\]</span> The log-likelihood function can also be expressed in terms of the hazard function, as <span class="math inline">\(\theta_n = f_n / S_n\)</span>:</p>
<p><span class="math display">\[
\ln L = \sum_{n=1} ^ N \left[d_n \ln \theta(t_n \mid x_n) + \ln S(t_n \mid x_n)\right]
\]</span> If there are no censored observations and if the distribution of time is exponential, <a href="#eq-duration_regression">Equation&nbsp;<span>13.3</span></a> can be estimated by least squares, which will be consistent, although inefficient. The <code>oil</code> data set doesn’t have censored observations. Therefore, OLS estimation is consistent, even if it is less efficient than maximum likelihood if the distribution is really exponential. We estimated a model by maximum likelihood in <a href="maximum_likelihood.html#sec-ml_est_expon"><span>Section&nbsp;5.2.2</span></a>, with <code>p98</code> and <code>varp98</code> as covariates. We reproduce this estimation using <code>surveg</code> and we compare the results with those obtained using <code>lm</code>. The <code>survreg</code> function has a <code>dist</code> argument that we set to <code>"exponential"</code>. The response should be generated using the <code>Surv</code> function, with the duration as the only argument in this example, as all the observations are uncensored: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/survreg.html">survreg</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">dur</span><span class="op">)</span> <span class="op">~</span> <span class="va">p98</span> <span class="op">+</span> <span class="va">varp98</span>, <span class="va">oil</span>, dist <span class="op">=</span> <span class="st">"exponential"</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">summary</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
survreg(formula = Surv(dur) ~ p98 + varp98, data = oil, dist = "exponential")
            Value Std. Error    z      p
(Intercept) 1.440      0.551 2.61 0.0089
p98         0.830      0.493 1.68 0.0924
varp98      0.295      0.157 1.88 0.0597

Scale fixed at 1 

Exponential distribution
Loglik(model)= -258.5   Loglik(intercept only)= -272.6
    Chisq= 28.2 on 2 degrees of freedom, p= 7.5e-07 
Number of Newton-Raphson Iterations: 4 
n= 53 </code></pre>
</div>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">dur</span><span class="op">)</span> <span class="op">~</span> <span class="va">p98</span> <span class="op">+</span> <span class="va">varp98</span>, <span class="va">oil</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">gaze</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       Estimate Std. Error t value Pr(&gt;|t|)
p98       0.948      0.446    2.12    0.039
varp98    0.226      0.146    1.55    0.127</code></pre>
</div>
</div>
<p>As expected, the two sets of slopes are rather close, but the ML estimator doesn’t seem to be more efficient in this example. <span class="math inline">\(\beta_k\)</span> is the derivative of <span class="math inline">\(\ln T_n\)</span> with <span class="math inline">\(x_{nk}\)</span>, so that <span class="math inline">\(d T_n / T_n = \beta_k dx_{nk}\)</span>. Moreover, <span class="math inline">\(d \theta_n / \theta_n = -\beta_k dx_{nk}\)</span>.</p>
<p>We then estimate the model for unemployment duration of Dutch teachers using as covariates the age, gender and (in log) last hourly wage: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">un_exp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survreg.html">survreg</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">spell</span><span class="op">)</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">gender</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">wage</span><span class="op">)</span>,</span>
<span>                  <span class="va">unteach</span>, dist <span class="op">=</span> <span class="st">"exponential"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">un_exp</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept)         age  gendermale   log(wage) 
   -2.63528     0.02794     0.14972     0.36472 </code></pre>
</div>
</div>
<p>The results indicate that male unemployment spell duration are 15% longer than those for females. One more year of age increases the length of the spell by 2.79%. Finally, 1% of more previous wage increases the duration of the spell by 0.36%.</p>
</section><section id="accelerated-failure-time-model" class="level3"><h3 class="anchored" data-anchor-id="accelerated-failure-time-model">Accelerated failure time model</h3>
<p> The previous model is a special case of a class of models called <strong>accelerated failure time</strong> (<strong>AFT</strong>), for which the duration can be written as: <span class="math inline">\(T_n = Z / \lambda_n\)</span>, <span class="math inline">\(\lambda_n = e ^ {\gamma ^ \top z_n}\)</span>, and <span class="math inline">\(Z\)</span> is a random variable that doesn’t depend on <span class="math inline">\(\gamma\)</span> and <span class="math inline">\(x_n\)</span>. <span class="math inline">\(\lambda_n\)</span> therefore has a multiplicative effect on failure time, and failure time is decelerated if <span class="math inline">\(\lambda &lt; 1\)</span> and accelerated if <span class="math inline">\(\lambda &gt; 1\)</span>. The exponential model is such a model, with <span class="math inline">\(Z \sim E(1)\)</span>, or equivalently <span class="math inline">\(U = \ln Z\)</span> is an extreme value of type-1. Therefore, the AFT models are based on the following specification:</p>
<p><span class="math display">\[
\ln T_n = - \ln \lambda_n + U_n
\]</span> where <span class="math inline">\(\lambda_n\)</span> can be parametrized as <span class="math inline">\(e^{-\gamma ^ \top z_n}\)</span>, so that <span class="math inline">\(\ln T_n = \gamma ^ \top z_n + U_n\)</span>. Different choices of the distribution of <span class="math inline">\(U_n\)</span> lead to different flavors of AFT models. The basic exponential model is an AFT model with <span class="math inline">\(U\)</span> following an extreme value type-1 distribution. Two natural extensions of this model consist of introducing a supplementary parameter <span class="math inline">\(\sigma = 1 / \delta\)</span> or considering different distributions for <span class="math inline">\(U\)</span>:</p>
<p><span class="math display">\[
\ln T_n = - \ln \lambda_n + \frac{1}{\delta} U_n = - \ln \lambda_n + \sigma U_n
\]</span></p>
<p>Keeping for the moment the hypothesis that <span class="math inline">\(U_n\)</span> is type-1 extreme value, as <span class="math inline">\(U = \delta \ln \lambda T\)</span>, the density of <span class="math inline">\(T\)</span> is then:</p>
<p><span class="math display">\[
f(T) = e ^ {\delta \ln(\lambda T)} e ^ {- e ^ {\delta \ln(\lambda T)}} \frac{dU}{dT} = (\lambda T) ^ \delta e ^ {- (\lambda T) ^ \delta} \frac{\delta}{T} = \delta \lambda ^ \delta T ^ {\delta - 1} e ^ {-(\lambda T) ^ \delta}
\]</span></p>
<p>and the corresponding survival function is: <span class="math inline">\(S(t) = e ^ {-(\lambda t) ^ \delta}\)</span>. This is a Weibull distribution, with a shape parameter equal to <span class="math inline">\(\delta\)</span> and a scale parameter equal to <span class="math inline">\(\frac{1}{\lambda}\)</span>. The corresponding hazard function is: <span class="math inline">\(\theta(t) = \delta \lambda ^ \delta t ^ {\delta - 1}\)</span>. This <strong>Weibull model</strong> is the most common model used in duration analysis. It is particularly appealing, as it is very easy to estimate and because it can deal with either a hazard function that increases (<span class="math inline">\(\delta &gt; 1\)</span>) or decrease (<span class="math inline">\(\delta &lt; 1\)</span>) with time. In the first case, there is a <strong>positive time dependence</strong> and in the second case, a <strong>negative time dependence</strong>. Obviously, the Weibull model reduces to the exponential model if <span class="math inline">\(\delta = 1\)</span>. With <span class="math inline">\(\lambda_n = e ^ {- \gamma z_n}\)</span> and denoting <span class="math inline">\(\epsilon_n = \ln T_n - \gamma ^ \top z_n\)</span>, the hazard and the survival functions are:</p>
<p><span id="eq-hazard_weibull_aft"><span class="math display">\[
\theta(t) = \delta t ^ {\delta - 1}e ^ {- \delta\gamma ^ \top z} = \frac{\delta}{t} e^ {\delta \epsilon} \;\mbox{and} \; S(t) = e^{-t ^ \delta e ^ {-\delta \gamma ^\top z}}
\tag{13.4}\]</span></span></p>
<p>The log-likelihood function is then:</p>
<p><span class="math display">\[
\ln L = \sum_{n=1} ^ n d_n \left[\ln \delta - \ln t + \delta \epsilon_n\right] - e ^ {\delta\epsilon}
\]</span> <!-- A more general model is obtained by specifying $e ^ U$ as a gamma --> <!-- variate (and not as a unit exponentional distribution). In this case, --> <!-- the density of $Z = e ^ U = (\lambda T) ^ \sigma$ is --> <!-- $f(Z)=\frac{z ^ {m - 1} e ^ {-z}}{\Gamma(m)}$ (which reduces to --> <!-- $e ^ {-z}$ if $m=1$). The density of $T$ is then, noting that --> <!-- $dZ = \sigma \lambda ^ \sigma T ^ {\sigma - 1}$ --></p>
<!-- $$ -->
<!-- f(t) = \sigma \lambda ^ \sigma T ^ {\sigma - 1} \frac{(\lambda T) ^ {\sigma(m - 1)} e ^ {-(\lambda T) ^ \sigma}}{\Gamma(m)} = \sigma \Lambda ^ {\sigma m} T ^{\sigma m - 1} e ^ {- (\lambda T) ^ \sigma} / \Gamma(m) -->
<!-- $$ -->
<!-- which is a **generalized gamma distribution** with shape parameters -->
<!-- $p = \sigma$ and $d = \sigma m$ and scale parameter $a = 1 / \lambda$. -->
<!-- This reduce to: -->
<!-- -   the gamma distribution if $p = \sigma = 1$, -->
<!-- -   the Weibull distribution if $d = p$ (or $m = 1$), -->
<!-- -   the exponential distribution if $p = d = 1$ (or $\sigma = m = 1$). -->
<!-- The hazard function (which has no closed-form) is very flexible: it is -->
<!-- (denoting $d = \sigma m$): -->
<!-- -   monotonically increasing if $\sigma > 1$ and $d > 1$, -->
<!-- -   monotonically decreasing if $\sigma < 1$ and $d < 1$, -->
<!-- -   U-shaped if $\sigma < 1$ and $d > 1$, -->
<!-- -   inverted U-shaped if $\sigma > 1$ and $d < 1$. -->
<p> With <span class="math inline">\(U \sim \mathcal{N}(0, 1)\)</span>, <span class="math inline">\(\ln T = - \ln \lambda + \sigma U \sim \mathcal{N}(-\ln \lambda, \sigma)\)</span> and therefore the time duration is log-normal and the hazard function is:</p>
<p><span class="math display">\[
\theta(t) = \frac{1}{\sigma t} \frac{\phi\left(\frac{\ln t + \ln \lambda}{\sigma}\right)}{1 - \Phi\left(\frac{\ln t + \ln \lambda}{\sigma}\right)} = \frac{1}{\sigma t} r\left(\frac{\ln t + \ln \lambda}{\sigma}\right)
\]</span></p>
<p>with <span class="math inline">\(\phi\)</span> and <span class="math inline">\(\Phi\)</span> the density and the probability functions of a standard normal variable and <span class="math inline">\(r(z) = \phi(z) / \left(1 - \Phi(z)\right)\)</span> is the inverse Mills’ ratio. With, as previously, <span class="math inline">\(\ln \lambda = - \gamma ^ \top z\)</span>, in terms of <span class="math inline">\(\epsilon = \ln t - \gamma ^ \top z\)</span>, we have:</p>
<p><span class="math display">\[
\theta(t) = \frac{1}{\sigma t}\frac{\phi(\epsilon/\sigma)}{1 - \Phi(\epsilon/\sigma)}
\; \mbox{and}\; S(t) = 1 - \Phi(\epsilon/\sigma)
\]</span> The hazard function is then inverted U-shaped, whatever the value of <span class="math inline">\(\sigma\)</span>.</p>
<p><span class="math display">\[
\ln L = \sum_{n=1} ^ n d_n \left[-\ln \sigma - \ln t + \ln \phi(\epsilon_n/\sigma) \right] + (1 - d) \ln (1 - \Phi(\epsilon/\sigma))
\]</span> Finally, consider that the distribution of <span class="math inline">\(U\)</span> is standard logistic, so that <span class="math inline">\(f(u) = \frac{e^u}{(1 + e ^ u) ^ 2}\)</span>. As <span class="math inline">\(\delta \ln T \lambda = U\)</span>, <span class="math inline">\(\frac{dU}{dT} = \delta / T\)</span> and the density of <span class="math inline">\(T\)</span> is then:</p>
<p><span class="math display">\[
f(T) = \frac{ (\lambda T) ^ \delta}{\left(1 + (\lambda T) ^ \delta\right) ^ 2} \delta / T = \frac{\delta v T ^ {\delta - 1}}{(1 + v T ^ \delta) ^ 2}
\]</span></p>
<p>with <span class="math inline">\(v = \lambda ^ \delta\)</span>. The cumulative density and the survival function are <span class="math inline">\(F(t) = \frac{vT ^ \delta}{1 + vT ^ \delta}\)</span> and <span class="math inline">\(S(t) = \frac{1}{1 + vT ^ \delta}\)</span>, so that the hazard function is:</p>
<p><span class="math display">\[
\theta(t) = \delta \frac{v t ^ {\delta - 1}}{1 + v t ^ \delta}
\]</span> which is the <strong>log-logistic model</strong>. In terms of <span class="math inline">\(\epsilon\)</span>, we have:</p>
<p><span class="math display">\[
\theta(t)  = \frac{\delta}{t}\frac{e ^ {\delta\epsilon}}{1 + e ^ {\delta\epsilon}},\; S(t) = \frac{1}{1 + e ^ {\delta\epsilon}}
\]</span> and the following log-likelihood function:</p>
<p><span class="math display">\[
\ln L = \sum_{n=1} ^ n d_n \left[\ln \delta - \ln t + \delta\epsilon_n \right] - (1 + d_n) \ln (1 + e^ {\delta\epsilon})
\]</span></p>
<p>If <span class="math inline">\(\delta = 1\)</span>, the hazard reduces to <span class="math inline">\(\theta(t) = v / (1 + vT)\)</span> and is therefore decreasing from <span class="math inline">\(v\)</span> for <span class="math inline">\(T\rightarrow 0\)</span> to 0 for <span class="math inline">\(T\rightarrow + \infty\)</span>. The derivative of the hazard function is:</p>
<p><span class="math display">\[
\theta'(t) = - \frac{\delta v T ^ {\delta - 2}}{\left(1 + vT ^ \delta\right) ^ 2} \left[v T ^ \delta + (1 - \delta)\right]
\]</span></p>
<p>If <span class="math inline">\(\delta &lt; 1\)</span> <span class="math inline">\(\theta'(t)\)</span> is negative for all <span class="math inline">\(T\)</span>, so that the hazard function is decreasing, from <span class="math inline">\(+\infty\)</span> to 0. Finally, if <span class="math inline">\(\delta &gt; 1\)</span>, the hazard function is inverted U-shaped, with a maximum for <span class="math inline">\(T=\left(\frac{\delta - 1}{v}\right) ^ {1 / \delta}\)</span> and tends to 0 for <span class="math inline">\(T \rightarrow 0\)</span> and <span class="math inline">\(T \rightarrow + \infty\)</span>. </p>
<p>All these models are estimated by updating the exponential model previously estimated: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">un_wei</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">un_exp</span>, dist <span class="op">=</span> <span class="st">"weibull"</span><span class="op">)</span></span>
<span><span class="va">un_lnorm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">un_exp</span>, dist <span class="op">=</span> <span class="st">"lognormal"</span><span class="op">)</span></span>
<span><span class="va">un_llog</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">un_exp</span>, dist <span class="op">=</span> <span class="st">"loglogistic"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We first plot the hazard curves for a specific individual: we choose a male aged 35 with a last hourly wage of 10. We then compute <span class="math inline">\(\hat{\lambda}\)</span> for the different models:</p>
<!-- x <- c(1, 31, 0, 7, 0, 2, 1, 1, 7, rep(0, 14)) -->
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">35</span>, <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">l_llog</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">un_llog</span><span class="op">)</span> <span class="op">*</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">l_wei</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">un_wei</span><span class="op">)</span> <span class="op">*</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">l_lnorm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">un_lnorm</span><span class="op">)</span> <span class="op">*</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>survreg</code> objects have a <code>scale</code> object, which is the estimation of <span class="math inline">\(\sigma\)</span> with our notations. As the Weibull and the log-logistic are expressed in term of <span class="math inline">\(\delta\)</span>, we take the inverse of this parameter for these two distributions.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">s_llog</span> <span class="op">&lt;-</span> <span class="va">un_llog</span><span class="op">$</span><span class="va">scale</span> <span class="op">^</span> <span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">s_lnorm</span> <span class="op">&lt;-</span> <span class="va">un_lnorm</span><span class="op">$</span><span class="va">scale</span></span>
<span><span class="va">s_wei</span> <span class="op">&lt;-</span> <span class="va">un_wei</span><span class="op">$</span><span class="va">scale</span> <span class="op">^</span> <span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span> </span>
<span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"log-log"</span> <span class="op">=</span> <span class="va">s_llog</span>, <span class="st">"log-normal"</span> <span class="op">=</span> <span class="va">s_lnorm</span>, <span class="st">"weibul"</span> <span class="op">=</span> <span class="va">s_wei</span><span class="op">)</span></span>
<span><span class="co">##    log-log log-normal     weibul </span></span>
<span><span class="co">##     1.7530     0.9948     1.1789</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><span class="math inline">\(\delta\)</span> being larger than one for the log-logistic, we have an inverted U-shaped distribution for the hazard function. For the Weibull model, <span class="math inline">\(\delta &lt; 1\)</span>, the hazard curve is then increasing. We can then write functions for the hazards functions and plot them using <code>geom_function</code> (see <a href="#fig-hazard_ud">Figure&nbsp;<span>13.4</span></a>). </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">lnorm</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">d</span><span class="op">)</span> <span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="va">s_lnorm</span> <span class="op">*</span> <span class="va">d</span><span class="op">)</span> <span class="op">*</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">d</span> <span class="op">*</span> <span class="va">l_lnorm</span><span class="op">)</span> <span class="op">/</span> <span class="va">s_lnorm</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">pnorm</a></span><span class="op">(</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">d</span> <span class="op">*</span> <span class="va">l_lnorm</span><span class="op">)</span> <span class="op">/</span> <span class="va">s_lnorm</span><span class="op">)</span>, lower.tail <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">loglog</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">d</span><span class="op">)</span> <span class="va">s_llog</span> <span class="op">*</span> <span class="va">l_llog</span> <span class="op">^</span> <span class="va">s_llog</span> <span class="op">*</span> </span>
<span>  <span class="va">d</span> <span class="op">^</span> <span class="op">(</span><span class="va">s_llog</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="op">(</span><span class="va">l_llog</span> <span class="op">*</span> <span class="va">d</span><span class="op">)</span> <span class="op">^</span> <span class="va">s_llog</span><span class="op">)</span></span>
<span><span class="va">weib</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">d</span><span class="op">)</span> <span class="va">s_wei</span> <span class="op">*</span> <span class="va">l_wei</span> <span class="op">^</span> <span class="va">s_wei</span> <span class="op">*</span> <span class="va">d</span> <span class="op">^</span> <span class="op">(</span><span class="va">s_wei</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_function</span><span class="op">(</span>fun <span class="op">=</span> <span class="va">lnorm</span>, <span class="fu">aes</span><span class="op">(</span>linetype <span class="op">=</span> <span class="st">"log-normal"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_function</span><span class="op">(</span>fun <span class="op">=</span> <span class="va">loglog</span>, <span class="fu">aes</span><span class="op">(</span>linetype <span class="op">=</span> <span class="st">"log-log"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_function</span><span class="op">(</span>fun <span class="op">=</span> <span class="va">weib</span>, <span class="fu">aes</span><span class="op">(</span>linetype <span class="op">=</span> <span class="st">"weibull"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">labs</span><span class="op">(</span>linetype <span class="op">=</span> <span class="st">"distribution"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-hazard_ud" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="duration_files/figure-html/fig-hazard_ud-1.png" class="img-fluid figure-img" style="width:60.0%"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;13.4: Hazard functions for employment duration</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>The results of the four AFT models are presented in <a href="#tbl-acc_failure">Table&nbsp;<span>13.1</span></a>.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="tbl-acc_failure" class="anchored">

<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<caption>Table&nbsp;13.1:  Accelerated failure time model for unemployment duration </caption>
 <thead><tr>
<th style="text-align:left;">   </th>
   <th style="text-align:center;"> exponential </th>
   <th style="text-align:center;"> weibull </th>
   <th style="text-align:center;"> log-logistic </th>
   <th style="text-align:center;"> log-normal </th>
  </tr></thead>
<tbody>
<tr>
<td style="text-align:left;"> (Intercept) </td>
   <td style="text-align:center;"> −2.635 </td>
   <td style="text-align:center;"> −2.511 </td>
   <td style="text-align:center;"> −2.705 </td>
   <td style="text-align:center;"> −2.634 </td>
  </tr>
<tr>
<td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.149) </td>
   <td style="text-align:center;"> (0.128) </td>
   <td style="text-align:center;"> (0.138) </td>
   <td style="text-align:center;"> (0.140) </td>
  </tr>
<tr>
<td style="text-align:left;"> age </td>
   <td style="text-align:center;"> 0.028 </td>
   <td style="text-align:center;"> 0.026 </td>
   <td style="text-align:center;"> 0.022 </td>
   <td style="text-align:center;"> 0.022 </td>
  </tr>
<tr>
<td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.002) </td>
   <td style="text-align:center;"> (0.002) </td>
   <td style="text-align:center;"> (0.002) </td>
   <td style="text-align:center;"> (0.002) </td>
  </tr>
<tr>
<td style="text-align:left;"> gendermale </td>
   <td style="text-align:center;"> 0.150 </td>
   <td style="text-align:center;"> 0.132 </td>
   <td style="text-align:center;"> 0.117 </td>
   <td style="text-align:center;"> 0.108 </td>
  </tr>
<tr>
<td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.076) </td>
   <td style="text-align:center;"> (0.065) </td>
   <td style="text-align:center;"> (0.068) </td>
   <td style="text-align:center;"> (0.067) </td>
  </tr>
<tr>
<td style="text-align:left;"> log(wage) </td>
   <td style="text-align:center;"> 0.365 </td>
   <td style="text-align:center;"> 0.350 </td>
   <td style="text-align:center;"> 0.310 </td>
   <td style="text-align:center;"> 0.270 </td>
  </tr>
<tr>
<td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.061) </td>
   <td style="text-align:center;"> (0.051) </td>
   <td style="text-align:center;"> (0.057) </td>
   <td style="text-align:center;"> (0.058) </td>
  </tr>
<tr>
<td style="text-align:left;"> Log(scale) </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> −0.165 </td>
   <td style="text-align:center;"> −0.561 </td>
   <td style="text-align:center;"> −0.005 </td>
  </tr>
<tr>
<td style="text-align:left;box-shadow: 0px 1.5px">  </td>
   <td style="text-align:center;box-shadow: 0px 1.5px">  </td>
   <td style="text-align:center;box-shadow: 0px 1.5px"> (0.018) </td>
   <td style="text-align:center;box-shadow: 0px 1.5px"> (0.019) </td>
   <td style="text-align:center;box-shadow: 0px 1.5px"> (0.017) </td>
  </tr>
<tr>
<td style="text-align:left;"> Num.Obs. </td>
   <td style="text-align:center;"> 2124 </td>
   <td style="text-align:center;"> 2124 </td>
   <td style="text-align:center;"> 2124 </td>
   <td style="text-align:center;"> 2124 </td>
  </tr>
<tr>
<td style="text-align:left;"> AIC </td>
   <td style="text-align:center;"> 442.5 </td>
   <td style="text-align:center;"> 369.4 </td>
   <td style="text-align:center;"> 294.6 </td>
   <td style="text-align:center;"> 294.4 </td>
  </tr>
<tr>
<td style="text-align:left;"> BIC </td>
   <td style="text-align:center;"> 465.1 </td>
   <td style="text-align:center;"> 397.7 </td>
   <td style="text-align:center;"> 322.9 </td>
   <td style="text-align:center;"> 322.7 </td>
  </tr>
<tr>
<td style="text-align:left;"> RMSE </td>
   <td style="text-align:center;"> 0.36 </td>
   <td style="text-align:center;"> 0.35 </td>
   <td style="text-align:center;"> 0.33 </td>
   <td style="text-align:center;"> 0.33 </td>
  </tr>
</tbody>
</table>
</div>
</div>
</div>
</section><section id="proportional-hazard-models" class="level3"><h3 class="anchored" data-anchor-id="proportional-hazard-models">Proportional hazard models</h3>
<p> The <strong>proportional hazard</strong> (<strong>PH</strong>) models starts with the specification of the hazard function. More specifically, it is assumed that the hazard function can be written as the product of two terms:</p>
<p><span class="math display">\[
\theta(t | x) = \lambda(t, \rho) f(x, \gamma)
\]</span></p>
<ul>
<li>the first depends only on the duration and on some unknown parameters; it is called the baseline hazard,</li>
<li>the second depends on some covariates and some unknown parameters, but not on duration; it is parametrized as <span class="math inline">\(e ^ {\gamma ^ \top z} = e ^ {\alpha + \beta ^ \top x}\)</span>. Consider two individuals characterized by two sets of values for the covariates <span class="math inline">\(x_1\)</span> and <span class="math inline">\(x_2\)</span>. The ratio of their hazard for a given duration is:</li>
</ul>
<p><span class="math display">\[
\frac{\theta(t|x = x_1)}{\theta(t|x = x_2)}= \frac{f(x_1, \gamma)}{f(x_2, \gamma)} = \frac{e^ {\alpha + \beta ^ \top x_1}}{e ^  {\alpha + \beta ^ \top x_2}} = e ^ {\beta(x_1 - x_2)}
\]</span> and therefore doesn’t depend on the duration. This model is called for this reason the <strong>proportional hazard model</strong>. The marginal effect of one covariate on the hazard is:</p>
<p><span class="math display">\[
\frac{\partial \theta(t|x)}{\partial x_k} = \lambda(t, \rho) \frac{\partial f}{\partial x_k} = \lambda(t, \rho) \beta_k f(x, \gamma) = \beta_k\theta(t, x)
\]</span></p>
<p>Therefore, the marginal effect is proportional to the hazard; more precisely, it is just <span class="math inline">\(\beta_k\)</span> times the hazard. Note that the parametrization is the opposite of the one used for the AFT models. Therefore, the interpretation of the coefficients should be modified: a positive value of <span class="math inline">\(\beta_k\)</span> means that the covariate has a positive effect on the hazard and therefore a negative effect on the duration. The most common used PH models are the exponential and the Weibull model. For the Weibull model, the hazard and the corresponding survival functions are generally parametrized as:</p>
<p><span id="eq-hazard_weibull_ph"><span class="math display">\[
\theta(t_n) = \delta t_n ^ {\delta - 1} e^{\gamma ^ \top z_n}\;\mbox{and}\; S(t_n) = e ^ {- t_n ^ \delta e ^ {\gamma^\top z_n}}
\tag{13.5}\]</span></span></p>
<p>This is exactly the same hazard function as <a href="#eq-hazard_weibull_aft">Equation&nbsp;<span>13.4</span></a> with a different parametrization: starting from the PH coefficients, the AFT coefficients are <span class="math inline">\(- \gamma / \delta\)</span>. The exponential model is obtained as the special case of <a href="#eq-hazard_weibull_ph">Equation&nbsp;<span>13.5</span></a> where <span class="math inline">\(\delta=1\)</span>. In this case, the two vectors of coefficients of the AFT and the PH models are just opposite. The Weibull and the exponential models are the only two models which belong to the AFM and the PH family. Two more specifications of proportional hazard models are often used, namely the generalized Weibull and the Gompertz models.</p>
<p>The Cox proportional hazard model <span class="citation" data-cites="COX:72 COX:75">(<a href="#ref-COX:72" role="doc-biblioref">Cox 1972</a>, <a href="#ref-COX:75" role="doc-biblioref">1975</a>)</span> is semi-parametric, as only the <span class="math inline">\(f()\)</span> function is estimated and not the baseline hazard function. It is better understood using a simple example. Without lack of generality, consider that the observations are arranged in an increasing order of duration. Consider a sample of size 4, with <span class="math inline">\(t = (2, 3, 5, 8)\)</span>. For time <span class="math inline">\(t_1 = 2\)</span>, all the observations are at risk (none of them failed before). Consider the probability that one observation <span class="math inline">\(n\)</span> fails at time <span class="math inline">\(t_1=2\)</span>, given that it was at risk. This writes: <span class="math inline">\(P(t_n = t_1 | t_n \geq t_1)=\lambda(t_1) f(x_n, \gamma)\)</span>. The probability that an observation fails at <span class="math inline">\(t_1 = 2\)</span> is the sum of this expression for the four observations: <span class="math inline">\(\lambda(t_1)\sum_{n = 1} ^ 4 f(x_n, \gamma)\)</span>. Finally, the probability that observation <span class="math inline">\(n\)</span> fails given that one observation fails is:</p>
<p><span class="math display">\[\frac{\lambda(t_1)f(x_n, \gamma)}{\lambda(t_1)\sum_{n = 1} ^ 4 f(x_n, \gamma)} = \frac{f(x_n, \gamma)}{\sum_{n = 1} ^ 4 f(x_n, \gamma)}\]</span></p>
<p>This probability therefore doesn’t depend on the baseline hazard function. Moreover, if <span class="math inline">\(f(x_n, \gamma) = e ^ {\gamma^\top z_n}\)</span>, it has a logit form: <span class="math inline">\(e^{\gamma^\top z_n} / \sum_n e^{\gamma^\top z_n}\)</span>. As this is the first observation that failed for <span class="math inline">\(t_1 = 2\)</span>, the contribution of this observation is:</p>
<p><span class="math display">\[\frac{e^{\gamma^\top z_1}}{e^{\gamma^\top z_1} + e^{\gamma^\top z_2} + e^{\gamma^\top z_3}+e^{\gamma^\top z_4}}\]</span></p>
<p>The reasoning is similar for <span class="math inline">\(t_2 = 3\)</span>. The set of observations at risk is the last three observations and the contribution of observation <span class="math inline">\(2\)</span> is then:</p>
<p><span class="math display">\[\frac{e^{\gamma^\top z_2}}{e^{\gamma^\top z_2} + e^{\gamma^\top z_3} + e^{\gamma^\top z_4}}\]</span></p>
<p>For observation 3, the set of observations at risk reduces to observations 3 and 4:</p>
<p><span class="math display">\[\frac{e^{\gamma^\top z_3}}{e^{\gamma^\top z_3} + e^{\gamma^\top z_4}}\]</span></p>
<p>Finally, for the last observation, the set of observations at risk is only this observation, so that the contribution of observation <span class="math inline">\(4\)</span> is:</p>
<p><span class="math display">\[\frac{e^{\gamma^\top z_4}}{e^{\gamma^\top z_4}} = 1\]</span></p>
<p> The <strong>partial likelihood</strong> for the whole sample is the product of these four contributions:</p>
<p><span class="math display">\[
L = \frac{e^{\gamma^\top z_1}}{e^{\gamma^\top z_1} + e^{\gamma^\top z_2} + e^{\gamma^\top z_3} + e^{\gamma^\top z_4} }\times\frac{e^{\gamma^\top z_2}}{e^{\gamma^\top z_2} + e^{\gamma^\top z_3} + e^{\gamma^\top z_4} }\times \frac{e^{\gamma^\top z_3}}{e^{\gamma^\top z_3} + e^{\gamma^\top z_4}} \times 1
\]</span></p>
<p>A more general expression is obtained by denoting <span class="math inline">\(R_n\)</span> the set of observations for which <span class="math inline">\(t_m \geq t_n\)</span>, i.e., the set of observations at risk at time <span class="math inline">\(t_n\)</span>:</p>
<p><span class="math display">\[L = \prod_{n=1}^N\frac{e^{\gamma ^ \top z_n}}{\sum_{n \in R_n}e^{\gamma ^ \top z_n}}\]</span></p>
<p>and the partial log-likelihood is therefore:</p>
<p><span class="math display">\[\ln L = \sum_{n=1}^N\left(\gamma ^ \top z_n - \ln \sum_{n \in R_n}e^{\gamma ^ \top z_n}\right)\]</span> An interesting feature of Cox proportional hazard model is that the duration response is only used as a way to order the observations. For example, if <span class="math inline">\(t = (1, 2, 3, 4)\)</span> instead of <span class="math inline">\(t = (2, 3, 5, 8)\)</span>, we would obtain exactly the same likelihood and therefore the same fitted parameters. Censored observations contribute only to the partial likelihood as elements of the set of observations at risk for some observations. For example, if observation <span class="math inline">\(2\)</span> is censored, the likelihood is:</p>
<p><span class="math display">\[L = \frac{e^{\gamma^\top z_1}}{e^{\gamma^\top z_1} + e^{\gamma^\top z_2} + e^{\gamma^\top z_3} + e^{\gamma^\top z_4} }\times \frac{e^{\gamma^\top z_3}}{e^{\gamma^\top z_3} + e^{\gamma^\top z_4}} \times 1\]</span></p>
<p>and the general formula for the partial log-likelihood is, denoting <span class="math inline">\(d_n\)</span> a dummy equal to 0 if observation <span class="math inline">\(n\)</span> is censored and 1 otherwise:</p>
<p><span class="math display">\[\ln L = \sum_{n=1}^Nd_n\left(\gamma ^ \top z_n - \ln \sum_{n \in R_n}e^{\gamma ^ \top z_n}\right)\]</span></p>
<p>Consider now that the sample includes ties, for example <span class="math inline">\(t = (2, 4, 4, 8)\)</span>. Durations for <span class="math inline">\(n = 2\)</span> and <span class="math inline">\(n = 3\)</span> are equal because of rounding measures, and we don’t know which observation failed first. If the event occured first for <span class="math inline">\(n=2\)</span>, the probability for observations <span class="math inline">\(2\)</span> and <span class="math inline">\(3\)</span> is:</p>
<p><span class="math display">\[\frac{e^{\gamma^\top z_2}}{e^{\gamma^\top z_2} + e^{\gamma^\top z_3} + e^{\gamma^\top z_4}} + \frac{e^{\gamma^\top z_3}}{e^{\gamma^\top z_3} + e^{\gamma^\top z_4}}\]</span> On the contrary, if the event occurs first for <span class="math inline">\(n=3\)</span>:</p>
<p><span class="math display">\[
\frac{e^{\gamma^\top z_3}}{e^{\gamma^\top z_2} + e^{\gamma^\top z_3} + e^{\gamma^\top z_4}} + \frac{e^{\gamma^\top z_2}}{e^{\gamma^\top z_2} + e^{\gamma^\top z_4} }
\]</span> The probability for observations <span class="math inline">\(2\)</span> and <span class="math inline">\(3\)</span> is the sum of these two probabilities and the partial likelihood is then:</p>
<p><span class="math display">\[
\left(\frac{e^{\gamma^\top z_2}}{e^{\gamma^\top z_2} + e^{\gamma^\top z_3} + e^{\gamma^\top z_4}} + \frac{e^{\gamma^\top z_3}}{e^{\gamma^\top z_3} + e^{\gamma^\top z_4}}+\frac{e^{\gamma^\top z_3}}{e^{\gamma^\top z_2} + e^{\gamma^\top z_3} + e^{\gamma^\top z_4}} + \frac{e^{\gamma^\top z_2}}{e^{\gamma^\top z_2} + e^{\gamma^\top z_4}}\right)
\]</span></p>
<p>Therefore, in the case of a tie with two observations, the product of two probabilities is replaced by the sum of four probabilities. If there were a tie with three observations, the product of three probabilities would be replaced by the sum of 18 probabilities. More generally, with a tie of <span class="math inline">\(k\)</span> observations, the number of probabilities that should be computed is <span class="math inline">\(k\times k!\)</span>. For example, with <span class="math inline">\(k=10\)</span>, more than <span class="math inline">\(30\)</span> million probabilities should be computed. Therefore, this formula can only be applied when there are few and “thin” ties. Otherwise, approximations have been proposed by Breslow and Efron. The <code><a href="https://rdrr.io/pkg/survival/man/coxph.html">survival::coxph</a></code> function fits the Cox proportional hazard regression model. We’ve already estimated the Weibull model using the <code><a href="https://rdrr.io/pkg/survival/man/survreg.html">survival::survreg</a></code> function in its accelerated failure time parametrization. <code><a href="https://rdrr.io/pkg/micsr/man/weibreg.html">micsr::weibreg</a></code> enables to estimate the Weibull model using either the AFT or the proportional hazard parametrization, using the <code>model</code> argument: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">weib_aft</span> <span class="op">&lt;-</span> <span class="fu">weibreg</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">spell</span><span class="op">)</span> <span class="op">~</span> <span class="va">gender</span> <span class="op">+</span> <span class="va">age</span> <span class="op">+</span></span>
<span>                      <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">wage</span><span class="op">)</span>, <span class="va">unteach</span>, model <span class="op">=</span> <span class="st">"aft"</span><span class="op">)</span></span>
<span><span class="va">weib_ph</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">weib_aft</span>, model <span class="op">=</span> <span class="st">"ph"</span><span class="op">)</span></span>
<span><span class="va">cox</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">spell</span><span class="op">)</span> <span class="op">~</span> <span class="va">gender</span> <span class="op">+</span> <span class="va">age</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">wage</span><span class="op">)</span>,</span>
<span>             <span class="va">unteach</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The results are presented in <a href="#tbl-weib_ph">Table&nbsp;<span>13.2</span></a>. As stated previously, starting from the PH coefficient, the AFT is obtained as the opposite divided by <span class="math inline">\(\delta\)</span>; for example, for age: <span class="math inline">\(-(-0.031 / 1.179) = 0.026\)</span>. Obviously, the value of the log-likelihood function is the same for the PH and the AFT versions of the Weibull model.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="tbl-weib_ph" class="anchored">

<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<caption>Table&nbsp;13.2:  Weibull model (AFT and PH) and Cox semi-parametric model for the unemployment data set </caption>
 <thead><tr>
<th style="text-align:left;">   </th>
   <th style="text-align:center;"> Weibull (AFT) </th>
   <th style="text-align:center;"> Weibull (PH) </th>
   <th style="text-align:center;"> Cox model </th>
  </tr></thead>
<tbody>
<tr>
<td style="text-align:left;"> (Intercept) </td>
   <td style="text-align:center;"> −2.511 </td>
   <td style="text-align:center;"> 2.961 </td>
   <td style="text-align:center;">  </td>
  </tr>
<tr>
<td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.128) </td>
   <td style="text-align:center;"> (0.155) </td>
   <td style="text-align:center;">  </td>
  </tr>
<tr>
<td style="text-align:left;"> gendermale </td>
   <td style="text-align:center;"> 0.132 </td>
   <td style="text-align:center;"> −0.156 </td>
   <td style="text-align:center;"> −0.137 </td>
  </tr>
<tr>
<td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.065) </td>
   <td style="text-align:center;"> (0.076) </td>
   <td style="text-align:center;"> (0.076) </td>
  </tr>
<tr>
<td style="text-align:left;"> age </td>
   <td style="text-align:center;"> 0.026 </td>
   <td style="text-align:center;"> −0.031 </td>
   <td style="text-align:center;"> −0.028 </td>
  </tr>
<tr>
<td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.002) </td>
   <td style="text-align:center;"> (0.003) </td>
   <td style="text-align:center;"> (0.002) </td>
  </tr>
<tr>
<td style="text-align:left;"> log(wage) </td>
   <td style="text-align:center;"> 0.350 </td>
   <td style="text-align:center;"> −0.412 </td>
   <td style="text-align:center;"> −0.371 </td>
  </tr>
<tr>
<td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.051) </td>
   <td style="text-align:center;"> (0.061) </td>
   <td style="text-align:center;"> (0.061) </td>
  </tr>
<tr>
<td style="text-align:left;"> shape </td>
   <td style="text-align:center;"> 1.179 </td>
   <td style="text-align:center;"> 1.179 </td>
   <td style="text-align:center;">  </td>
  </tr>
<tr>
<td style="text-align:left;box-shadow: 0px 1.5px">  </td>
   <td style="text-align:center;box-shadow: 0px 1.5px"> (0.021) </td>
   <td style="text-align:center;box-shadow: 0px 1.5px"> (0.021) </td>
   <td style="text-align:center;box-shadow: 0px 1.5px">  </td>
  </tr>
<tr>
<td style="text-align:left;"> Num.Obs. </td>
   <td style="text-align:center;"> 2124 </td>
   <td style="text-align:center;"> 2124 </td>
   <td style="text-align:center;"> 2124 </td>
  </tr>
<tr>
<td style="text-align:left;"> AIC </td>
   <td style="text-align:center;"> 369.4 </td>
   <td style="text-align:center;"> 369.4 </td>
   <td style="text-align:center;"> 24745.2 </td>
  </tr>
<tr>
<td style="text-align:left;"> BIC </td>
   <td style="text-align:center;"> 397.7 </td>
   <td style="text-align:center;"> 397.7 </td>
   <td style="text-align:center;"> 24762.2 </td>
  </tr>
<tr>
<td style="text-align:left;"> Log.Lik. </td>
   <td style="text-align:center;"> −179.682 </td>
   <td style="text-align:center;"> −179.682 </td>
   <td style="text-align:center;">  </td>
  </tr>
<tr>
<td style="text-align:left;"> RMSE </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> 0.91 </td>
  </tr>
</tbody>
</table>
</div>
</div>
</div>
<div style="page-break-after: always;"></div>
</section></section><section id="sec-heter_duration" class="level2" data-number="13.3"><h2 data-number="13.3" class="anchored" data-anchor-id="sec-heter_duration">
<span class="header-section-number">13.3</span> Heterogeneity</h2>
<p>Consider a population with two groups characterized by two different constant hazard rates, 0.4 for the first group and 0.1 for the second group.<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> If there are 100 individuals in both groups, the number of events (observations at risk) for the first group is <span class="math inline">\(0.4 \times 100 = 40\)</span> (60) for the first period, <span class="math inline">\(0.4 \times 60 = 24\)</span> (36) for the second and <span class="math inline">\(0.4 \times 36 = 21.6\)</span> (12.96) for the third. For the second group, we get <span class="math inline">\(0.1 \times 100 = 10\)</span> (90) for the first period, <span class="math inline">\(0.1 \times 90 = 9\)</span> (81), <span class="math inline">\(0.1 \times 81 = 8.1\)</span> (72.9) and <span class="math inline">\(0.1 \times 72.9 = 7.29\)</span> (65.61). Summing for the two groups, we get 50 (150), 33 (117), 22.5 (94.5). The hazard is then <span class="math inline">\(50 / 200 = 0.25\)</span> for the first period, <span class="math inline">\(33/150 = 0.22\)</span> for the second one and <span class="math inline">\(22.5 / 117 = 0.1923\)</span> for the third period. The hazard rate for the whole population is therefore decreasing, although it is constant for every individual. This result is easy to understand because, as times goes on, the proportion of individuals with the low hazard rate in the observations at risk is increasing. It is therefore important to detect the presence of heterogeneity and, in the presence of heterogeneity, to fit models that take heterogeneity into account.</p>
<section id="detecting-heterogeneity" class="level3"><h3 class="anchored" data-anchor-id="detecting-heterogeneity">Detecting heterogeneity</h3>
<p> If heterogeneity is present, fitting a model that doesn’t take it into account results in a wrong specification that can be tested using <strong>generalized residuals</strong>. In the context of duration models, integrated hazards can be considered as generalized residuals, as, if the specification is correct, their distribution is a unit exponential. Using the accelerating failure specification, remember that the integrated hazard is <span class="math inline">\(\epsilon_n = \Lambda(t_n) = - \ln S(t_n) = e ^ {\delta (\ln t - \gamma ^ \top z_n)}\)</span>. The distribution of <span class="math inline">\(\epsilon_n\)</span> doesn’t depend on <span class="math inline">\(x_n\)</span> and , being a unit exponential distribution, its first four uncentered moments are <span class="math inline">\(1, 2, 6, 24\)</span>. To get an idea of the relevance of the specification, we can plot minus the log of the empirical survival (which is the number of observations <span class="math inline">\(m\)</span> such that <span class="math inline">\(\epsilon_m &gt; \epsilon_n\)</span> divided by the total number of observations) against the generalized residuals; the points should then be grossly aligned on the 45<sup>o</sup> line. For censored observations, the duration is not known and the integrated hazard is replaced by its expectation. Denoting <span class="math inline">\(L\)</span> the censoring time, the expectation is:</p>
<p><span class="math display">\[
\mbox{E}(\epsilon(T) \mid T \geq L)=\int_{\epsilon(L)} ^ {+\infty}\frac{\epsilon f(\epsilon)}{S(\epsilon(L))} d\epsilon =
\frac{1}{e^ {-\epsilon(L)}} \int_{\epsilon(L)} ^ {+\infty}\epsilon e ^ {- \epsilon}d\epsilon =
\epsilon(L) + 1
\]</span> </p>
<p> <a href="#fig-gres_weibull">Figure&nbsp;<span>13.5</span></a> plots the generalized residuals, that has been computed using the <code><a href="https://rdrr.io/pkg/micsr/man/weibreg.html">micsr::gres</a></code> function. The fit seems excellent for low values of the generalized residuals, and bad for values higher than 4 (about 2% of the sample).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">weib</span> <span class="op">&lt;-</span> <span class="fu">weibreg</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">spell</span><span class="op">)</span> <span class="op">~</span> <span class="va">gender</span> <span class="op">+</span> <span class="va">age</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">wage</span><span class="op">)</span>,</span>
<span>                <span class="va">unteach</span><span class="op">)</span></span>
<span><span class="va">un_gres</span> <span class="op">&lt;-</span> <span class="fu">gres</span><span class="op">(</span><span class="va">weib</span><span class="op">)</span></span>
<span><span class="va">N</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/nobs.html">nobs</a></span><span class="op">(</span><span class="va">weib</span><span class="op">)</span></span>
<span><span class="va">int_haz</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span>gres <span class="op">=</span> <span class="va">un_gres</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">group_by</span><span class="op">(</span><span class="va">gres</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">summarise</span><span class="op">(</span>n <span class="op">=</span> <span class="fu">n</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">arrange</span><span class="op">(</span><span class="va">gres</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>cumn <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumsum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>, esurv <span class="op">=</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">cumn</span> <span class="op">/</span> <span class="va">N</span>, ech <span class="op">=</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">esurv</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">int_haz</span> <span class="op">%&gt;%</span> <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span><span class="va">gres</span>, <span class="va">ech</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu">geom_step</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_abline</span><span class="op">(</span>intercept <span class="op">=</span> <span class="fl">0</span>, slope <span class="op">=</span> <span class="fl">1</span>, linetype <span class="op">=</span> <span class="st">"dotted"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-gres_weibull" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="duration_files/figure-html/fig-gres_weibull-1.png" class="img-fluid figure-img" style="width:60.0%"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;13.5: Generalized residuals for the Weibull model</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>The empirical moments are: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="fl">2</span><span class="op">:</span><span class="fl">4</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">un_gres</span> <span class="op">^</span> <span class="va">i</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## [1]  2.012  5.918 22.307</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Conducting a conditional moment test, we get: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">cmtest</span><span class="op">(</span><span class="va">weib</span>, powers <span class="op">=</span> <span class="fl">2</span><span class="op">:</span><span class="fl">4</span>, opg <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">gaze</span></span>
<span><span class="co">## chisq = 3.860, df: 3, pval = 0.277</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and the hypothesis of a correct specification is therefore not rejected. </p>
</section><section id="weibull-gamma-model" class="level3"><h3 class="anchored" data-anchor-id="weibull-gamma-model">Weibull-Gamma model</h3>
<p> To take into account the heterogeneity, we can use mixing distributions, either finite (taking for example two categories of individuals as in the introductory example) or infinite. We’ll present in this section a model very widely used for its simplicity, the Weibull-Gamma model. Assume that the survival function for individual <span class="math inline">\(n\)</span> is:</p>
<p><span id="eq-cond_surv_weibull"><span class="math display">\[
S(t_n\mid x_n,\nu_n) = e ^ {-\mu_n\nu_n t_n ^ \delta}
\tag{13.6}\]</span></span></p>
<p>where as usual, <span class="math inline">\(\mu_n = e ^ {\alpha + \beta x_n}\)</span>. <span class="math inline">\(\nu_n\)</span> is an unobserved term that is specific to the individual. If it were observed, we would get the usual Weibull model. As it is unobserved, we have to consider the unconditional survival function, i.e., we have to integrate out <a href="#eq-cond_surv_weibull">Equation&nbsp;<span>13.6</span></a> with <span class="math inline">\(\nu\)</span>. Denoting <span class="math inline">\(f\)</span> the density of <span class="math inline">\(\nu\)</span>, we get:</p>
<p><span id="eq-uncond_surv_weibull"><span class="math display">\[
S(t_n\mid x_n) = \int_0 ^ {+ \infty} e ^ {-\mu_n\nu t_n ^ \delta}f(\nu)d\nu
\tag{13.7}\]</span></span></p>
<p>If the regression contains an intercept, the mean of <span class="math inline">\(\nu\)</span> is not identified and can be set to 1. The one-parameter Gamma distribution is:</p>
<p><span class="math display">\[
f(\nu) = \frac{\rho ^ \rho \nu ^ {\rho - 1} e ^  {-\rho \nu}}{\Gamma(\rho)}
\]</span> with <span class="math inline">\(\mbox{E}(\nu) = 1\)</span> and <span class="math inline">\(\mbox{V}(\nu) = 1 / \rho\)</span>. Using this mixing distribution, we get:</p>
<p><span class="math display">\[
S(t_n\mid x_n) = \int_0 ^ {+ \infty} e ^ {-\mu_n\nu t_n ^ \delta}\frac{\rho ^ \rho \nu ^ {\rho - 1} e ^  {-\rho \nu}}{\Gamma(\rho)}d\nu=
\frac{\rho ^ \rho}{\Gamma(\rho)}\int_0 ^ {+ \infty} e ^ {-\nu(\mu_n\nu t_n ^ \delta + \rho)}\nu ^ {\rho - 1} d\nu
\]</span> With the change of variable: <span class="math inline">\(u = \nu(\mu_n\nu t_n ^ \delta + \rho)\)</span>:</p>
<p><span class="math display">\[
S(t_n\mid x_n) = \int_0 ^ {+\infty} e ^ {-\mu_n\nu t_n ^ \delta}\frac{\rho ^ \rho \nu ^ {\rho - 1} e ^  {-\rho \nu}}{\Gamma(\rho)}d\nu=
\frac{\rho ^ \rho}{\Gamma(\rho)}\frac{1}{(\mu_n t_n ^ \delta + \rho) ^ \rho}\int_0 ^ {+\infty} e ^ {-u}u ^ {\rho - 1} d\nu
\]</span> which simplifies to: <span class="math inline">\(\left(\frac{\mu_n t_n ^ \delta}{\rho} + 1\right) ^ {-\rho}\)</span>. As <span class="math inline">\(\rho\)</span> is the inverse of the variance, it is simpler to parametrize the survival function with <span class="math inline">\(\chi = 1 / \rho\)</span>, so that the hypothesis of homogeneity is simply <span class="math inline">\(\chi = 0\)</span>:</p>
<p><span class="math display">\[
S(t_n\mid x_n) = \frac{1}{\left(1 + \chi\mu_n t_n ^ \delta\right) ^ \frac{1}{\chi}}
\]</span></p>
<p>The density is obtained as the opposite of the derivative of the survival function. The corresponding hazard function is:</p>
<p><span class="math display">\[
\theta(t_n \mid x_n) =
\frac{\delta  \mu_n t_n ^ {\delta - 1}}{1 + \chi\mu_n t_n ^ \delta}
\]</span> and the log-likelihood function is then:</p>
<p><span class="math display">\[
\ln L = \sum_{n=1} ^ n d_n \left[\ln \delta + (\delta - 1)\ln t + \ln \mu_n \right] - (1/\chi + d_n)\ln \left(1+\chi\mu_n t_n ^ \delta\right)
\]</span></p>
<p>as <span class="math inline">\(\chi \rightarrow 0\)</span>, <span class="math inline">\(\ln \left(1 + \chi \mu_n t_n ^ \delta\right)\rightarrow \chi\mu_n t_n ^ \delta\)</span> so that the Weibull is obtained as the limiting case where the variance of the mixing distribution tends to 0. Remember from <a href="#tbl-acc_failure">Table&nbsp;<span>13.1</span></a> that, for the Weibull AFT model, the scale parameter was <span class="math inline">\(\sigma = 0.85\)</span>, which corresponds to <span class="math inline">\(\delta = 1 / 0.85 = 1.18\)</span> and therefore to an increasing hazard rate. The <code><a href="https://rdrr.io/pkg/micsr/man/weibreg.html">micsr::weibreg</a></code> function estimates the Weibull-Gamma model when the <code>mixing</code> argument is set to <code>TRUE</code>: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">weib</span> <span class="op">&lt;-</span> <span class="fu">weibreg</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">spell</span><span class="op">)</span> <span class="op">~</span> <span class="va">gender</span> <span class="op">+</span> <span class="va">age</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">wage</span><span class="op">)</span>,</span>
<span>                  <span class="va">unteach</span><span class="op">)</span></span>
<span><span class="va">weib</span> <span class="op">%&gt;%</span> <span class="fu">gaze</span><span class="op">(</span>coef <span class="op">=</span> <span class="st">"shape"</span><span class="op">)</span></span>
<span><span class="co">##       Estimate Std. Error z-value Pr(&gt;|z|)</span></span>
<span><span class="co">## shape   1.1789     0.0215      55   &lt;2e-16</span></span>
<span><span class="va">gweib</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">weib</span>, mixing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">gweib</span> <span class="op">%&gt;%</span> <span class="fu">gaze</span><span class="op">(</span>coef <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"shape"</span>, <span class="st">"var"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">##       Estimate Std. Error z-value Pr(&gt;|z|)</span></span>
<span><span class="co">## shape   1.5978     0.0635   25.15  &lt; 2e-16</span></span>
<span><span class="co">## var     0.7017     0.1039    6.75  1.5e-11</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The supplementary parameter (<span class="math inline">\(\chi\)</span>) is called <code>"var"</code> and is highly significantly different from 0, so that the hypothesis of homogeneity is highly rejected. Note also that the shape parameter is much higher than previously. </p>
</section></section><section id="sec-misc_duration" class="level2" data-number="13.4"><h2 data-number="13.4" class="anchored" data-anchor-id="sec-misc_duration">
<span class="header-section-number">13.4</span> Other models</h2>
<section id="multi-state-models" class="level3"><h3 class="anchored" data-anchor-id="multi-state-models">Multi-state models</h3>
<p>Consider now the case where several events are possible, for example two events denoted <span class="math inline">\(a\)</span> and <span class="math inline">\(b\)</span>. Let <span class="math inline">\(\tilde{t}_n^a\)</span> and <span class="math inline">\(\tilde{t}_n^b\)</span> be the duration for individual <span class="math inline">\(n\)</span> for the two events <span class="math inline">\(a\)</span> and <span class="math inline">\(b\)</span>. The observed duration is <span class="math inline">\(t_n\)</span>. Three cases should be considered:</p>
<ul>
<li>
<span class="math inline">\(t_n &lt; \mbox{min}(\tilde{t}_n^a, \tilde{t}_n^b)\)</span> (which means that <span class="math inline">\(t_n &lt; \tilde{t}_n ^a\)</span> and <span class="math inline">\(t_n &lt; \tilde{t}_n^b\)</span>), the observation is then censored,</li>
<li>
<span class="math inline">\(t_n = \mbox{min}(\tilde{t}_n^a, \tilde{t}_n^b)\)</span>, the event is:
<ul>
<li>
<span class="math inline">\(a\)</span> if <span class="math inline">\(\tilde{t}_n ^ a &lt; \tilde{t}_n ^ b\)</span>,</li>
<li>
<span class="math inline">\(b\)</span> if <span class="math inline">\(\tilde{t}_n ^ a &gt; \tilde{t}_n ^ b\)</span>.</li>
</ul>
</li>
</ul>
<p> The <strong>competing risk</strong> model is a very simple multi-state model which extends the Cox proportional hazard model to the multi-state case. Consider for example state <span class="math inline">\(a\)</span>. For an observation <span class="math inline">\(n\)</span>, if the event <span class="math inline">\(a\)</span> is observed, we have an observation of a complete spell. Otherwise, if the event is <span class="math inline">\(b\)</span>, this means that <span class="math inline">\(t_n = \tilde{t}_n^b &lt; \tilde{t}_n^a\)</span> and the observation is censored as far as we are interested in state <span class="math inline">\(a\)</span>. We can therefore estimate the competing risk model with two independent Cox PH models:</p>
<ul>
<li>for the first, the event is <span class="math inline">\(a\)</span> and censoring occurs either if the observation is censored or if the event is <span class="math inline">\(b\)</span>,</li>
<li>for the second, the event is <span class="math inline">\(b\)</span> and censoring occurs either if the observation is censored or if the event is <span class="math inline">\(a\)</span>,</li>
</ul>
<p> <!-- For example, [@BIER:CARV:07]\index[author]{Bierens}\index[author]{Carvalho} consider the duration between prison release and a new crime for former prisoners. The event can take the form of a felony or a misdemeanor and the duration is censored if no new crime has been committed during the period of survey. The survey stops on April 16, 1988 and, as the date of release depends on the individuals, so does the censoring time. The sample contains $16355$  individuals from $11$ states. --></p>
<p>Consider the <code>recall</code> data set, initially used by <span class="citation" data-cites="KATZ:86">Katz (<a href="#ref-KATZ:86" role="doc-biblioref">1986</a>)</span> and later by <span class="citation" data-cites="SUEY:95">Sueyoshi (<a href="#ref-SUEY:95" role="doc-biblioref">1995</a>)</span>. It contains 1045 spells of unemployment in 1980. </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">recall</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,045 × 16
     id spell end      duration   age sex    educ race     nb ui   
  &lt;dbl&gt; &lt;dbl&gt; &lt;fct&gt;       &lt;dbl&gt; &lt;int&gt; &lt;fct&gt; &lt;int&gt; &lt;fct&gt; &lt;int&gt; &lt;fct&gt;
1     4     1 recall         17    26 male      5 white     3 yes  
2     7     2 recall         39    24 male      8 white     4 no   
3     7     3 censored       40    23 male      8 white     4 no   
# ℹ 1,042 more rows
# ℹ 6 more variables: marital &lt;fct&gt;, unemp &lt;int&gt;, wifemp &lt;fct&gt;,
#   homeowner &lt;fct&gt;, occupation &lt;fct&gt;, industry &lt;fct&gt;</code></pre>
</div>
</div>
<p>The analysis of <span class="citation" data-cites="KATZ:86">Katz (<a href="#ref-KATZ:86" role="doc-biblioref">1986</a>)</span> showed that an important transition from unemployment was a recall from the previous employer. The <code>end</code> covariate indicates the different modalities of transition: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">recall</span> <span class="op">%&gt;%</span> <span class="fu">count</span><span class="op">(</span><span class="va">end</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 2
  end          n
  &lt;fct&gt;    &lt;int&gt;
1 new-job    218
2 recall     593
3 censored   234</code></pre>
</div>
</div>
<p>We consider the <code>new-job</code> and <code>recall</code> modalities as an indication of a complete spell. The model for unemployment spells is estimated using as covariates the age, sex, years of education, number of dependents (<code>nb</code>), a dummy for unemployment insurance during the spell (<code>ui</code>), marital status, county unemployment rate (<code>unemp</code>), wife’s employment status, a dummy for home ownership and factors for occupation and industry. The competing risk model can then be estimated using the following two calls to <code>coxph</code>: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">un_recall</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">duration</span>, <span class="va">end</span> <span class="op">==</span> <span class="st">"recall"</span><span class="op">)</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">sex</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span></span>
<span>                     <span class="va">race</span> <span class="op">+</span> <span class="va">unemp</span> <span class="op">+</span> <span class="va">wifemp</span> <span class="op">+</span> <span class="va">homeowner</span> <span class="op">+</span> </span>
<span>                     <span class="va">occupation</span> <span class="op">+</span> <span class="va">industry</span>, <span class="va">recall</span><span class="op">)</span></span>
<span><span class="va">un_new</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">duration</span>, <span class="va">end</span> <span class="op">==</span> <span class="st">"new-job"</span><span class="op">)</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">sex</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> </span>
<span>                  <span class="va">race</span> <span class="op">+</span> <span class="va">unemp</span> <span class="op">+</span> <span class="va">wifemp</span> <span class="op">+</span> <span class="va">homeowner</span> <span class="op">+</span> </span>
<span>                  <span class="va">occupation</span> <span class="op">+</span> <span class="va">industry</span>, <span class="va">recall</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>where the <code>event</code> argument is a dummy equal to <code>TRUE</code> when <code>end</code> equals <code>"recall"</code> for the first regression and <code>"new-job"</code> for the second regression. The competing risk model can be estimated more simply with a simple call to <code>coxph</code> when the <code>event</code> argument is a factor for which the first level indicates censored observations. In the <code>recall</code> data set, the first level is <code>"new-job"</code>, so that we need to change the order of the levels using <code>relevel</code>: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">recall</span> <span class="op">%&gt;%</span> <span class="fu">pull</span><span class="op">(</span><span class="va">end</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">levels</span></span>
<span><span class="co">## [1] "new-job"  "recall"   "censored"</span></span>
<span><span class="va">recall</span> <span class="op">&lt;-</span> <span class="va">recall</span> <span class="op">%&gt;%</span> <span class="fu">mutate</span><span class="op">(</span>end <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/relevel.html">relevel</a></span><span class="op">(</span><span class="va">end</span>, <span class="st">"censored"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">recall</span> <span class="op">%&gt;%</span> <span class="fu">pull</span><span class="op">(</span><span class="va">end</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">levels</span></span>
<span><span class="co">## [1] "censored" "new-job"  "recall"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Moreover, the <code>id</code> argument is mandatory. This is the individual identifier and it is really useful only when there are several observations for the same individuals, which is not the case here. We therefore create an <code>idspell</code> variable before proceeding to the estimation. To save space, we use a very limited subset of covariates. </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">recall</span> <span class="op">&lt;-</span> <span class="va">recall</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">add_column</span><span class="op">(</span>id_spell <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">recall</span><span class="op">)</span>, .before <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">duration</span>, <span class="va">end</span><span class="op">)</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">sex</span>, data <span class="op">=</span> <span class="va">recall</span>, id <span class="op">=</span> <span class="va">id_spell</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(duration, end) ~ age + sex, data = recall, 
    id = id_spell)

           
1:2           coef exp(coef) se(coef) robust se  z    p
  age       -0.017     0.983    0.008     0.008 -2 0.02
  sexfemale -0.381     0.683    0.189     0.190 -2 0.04

           
1:3           coef exp(coef) se(coef) robust se  z     p
  age        0.022     1.022    0.004     0.004  6 2e-09
  sexfemale -0.386     0.680    0.119     0.122 -3 0.002

 States:  1= (s0), 2= new-job, 3= recall 

Likelihood ratio test=56  on 4 df, p=2e-11
n= 1045, unique id= 1045, number of events= 811 </code></pre>
</div>
</div>
</section><section id="grouped-data" class="level3"><h3 class="anchored" data-anchor-id="grouped-data">Grouped data</h3>
<p> Duration is often recorded not as a continuous variable, but as a set of intervals. For example, unemployment duration may not be measured in days, but in months or years. In this case, the model must be written in terms of discrete time. Denote <span class="math inline">\(t_0, t_1, t_2, ... t_T\)</span> (with <span class="math inline">\(t_0=0\)</span>) and <span class="math inline">\(a\)</span> the interval defined by <span class="math inline">\(t_{a-1} \leq t&lt; t_a\)</span>. The survival at time <span class="math inline">\(t_a\)</span> is such that <span class="math inline">\(- \ln S(t_a) = \int_0 ^ {t_a} \theta(s) ds\)</span>. Therefore, for the <span class="math inline">\(a\)</span><sup>th</sup> interval, we have:</p>
<p><span class="math display">\[
- \ln S(t_a) + \ln S(t_{a-1}) = - \ln \frac{S(t_a)}{S(t_{a-1})} =  \int _{t_{a-1}} ^ {t_a} \theta(s) ds
\]</span> The hazard in the <span class="math inline">\(a\)</span><sup>th</sup> interval is the probability of an event in this interval (which is the difference in survival) divided by the initial value of the survival:</p>
<p><span class="math display">\[
\theta_a = \frac{S(t_{a-1}) - S(t_a)}{S(t_{a-1})}= 1 - e ^ {-\int _{t_{a-1}} ^ {t_a} \theta(s) ds}
\]</span> Now assume a proportional hazard: <span class="math inline">\(\theta (s) = \lambda(s) e^ {\gamma^\top z_s}\)</span>. Denoting <span class="math inline">\(\delta_a = \ln \int_{t_{a-1}} ^ {t_a} \lambda(s) d_s\)</span>, we get:</p>
<p><span class="math display">\[
\theta_a = 1 - e ^ {- e ^ {\delta_a + \gamma ^ \top z_{t_{a-1}}}} = F(\delta_a + \gamma ^ \top z_{t_{a-1}})
\]</span> Where <span class="math inline">\(F\)</span> is the CDF of the extreme value type 1 distribution. Note that the covariates may be time-varying from one interval to another. In a given interval, values of the covariates are measured at the beginning of the interval. The discrete survival function at the beginning of this interval is:</p>
<p><span class="math display">\[
S_{t_{a-1}} = \prod_{s = 1} ^ {a-1} (1 - \theta_s) = \prod_{s = 1} ^ {a-1} (1 - F(\delta_s + \beta ^ \top x_{t_{s-1}}))
\]</span> The probability of a transition in the <span class="math inline">\(a\)</span><sup>th</sup> interval is the product of the discrete hazard for interval <span class="math inline">\(a\)</span> and the value of the survival function at the beginning of this interval (i.e., <span class="math inline">\(t_{a-1}\)</span>). For observation <span class="math inline">\(n\)</span>, the contribution to the likelihood is then:</p>
<p><span class="math display">\[
F(\delta_{a_n} + \gamma ^ \top z_{nt_{a-1}})\prod_{s = 1} ^ {a_n-1} (1 - F(\delta_s + \gamma ^ \top z_{nt_{s-1}}))
\]</span> Finally, the log-likelihood is, denoting <span class="math inline">\(F_{ns} = F(\delta_s + \gamma ^ \top z_{nt_{s-1}})\)</span> and <span class="math inline">\(y_{ns}\)</span> a dummy equal to 1 if <span class="math inline">\(n\)</span> has a transition in the <span class="math inline">\(s\)</span><sup>th</sup> interval and 0 otherwise:</p>
<p><span id="eq-binomial_duration"><span class="math display">\[
\begin{array}{rcl}
\ln L &amp;=&amp; \sum_{n=1} ^ N \left[\sum_{s=1} ^ {a_{n-1}}\ln (1 - F_{ns}) +\ln F_{na_n}\right]\\
&amp;=&amp; \sum_{n=1} ^ N \sum_{s=1} ^ {a_n}\left[(1 - y_{ns})\ln (1 - F_{ns}) +y_{ns}\ln F_{ns}\right]
\end{array}
\tag{13.8}\]</span></span></p>
<p>This is an unbalanced pooled binomial model, the number of observation for each individual being the index of the interval of its transition. <a href="#eq-binomial_duration">Equation&nbsp;<span>13.8</span></a> deals correctly with right-censored observation as, in this case, <span class="math inline">\(y_{na_n} = 0\)</span> and the correct term (<span class="math inline">\(1 - F_{na_n}\)</span>) is introduced in the log-likelihood. A specific set of <span class="math inline">\(\delta_s\)</span> parameters can be estimated, which enables to retrieve from the estimation the shape of the hazard function. </p>
<p> An alternative to this binomial model is to start with the proportional hazard formulation: <span class="math inline">\(\theta(t) = \lambda(t) e ^ {-\gamma ^ \top z}\)</span><a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a> and to compute the integrated hazard: <span class="math inline">\(\int_0 ^ t\theta(s)d s = e ^ {-\gamma ^ \top z_t}\int_0 ^ t \lambda(s)ds = e ^ {\delta_t - \gamma ^ \top z_t}\)</span> where <span class="math inline">\(\gamma_t\)</span> is defined as: <span class="math inline">\(\ln \int_0 ^ t \lambda(s)ds\)</span>. As the integrated hazard is the opposite of the logarithm of the survival function, we have: <span class="math inline">\(S(t) = e ^ {- e ^ {\delta_t - \gamma ^ \top z_t}}\)</span>. The probability of transition in the <span class="math inline">\(a\)</span><sup>th</sup> interval is <span class="math inline">\(S(t_{a-1}) - S(t_a) = F(t_a) - F(t_{a - 1})\)</span>, with <span class="math inline">\(F(z) = 1 - e ^ {- e ^ z}\)</span> the CDF of the extreme value type 1 distribution. Therefore, the log-likelihood is:</p>
<p><span class="math display">\[
\ln L = \sum_{n=1} ^ N \sum_{s = 1} ^ {A} y_{ns} \ln\left[F(\delta_{t_s} - \gamma ^ \top z_{nt_s}) - F(\delta_{t_{s-1}} - \gamma ^ \top z_{nt_{s-1}})\right]
\]</span> which is the ordered model (see <a href="binomial.html#eq-probord">Equation&nbsp;<span>10.17</span></a>), <span class="math inline">\(\delta_t\)</span> being a set of threshold. With censored observations, denoting <span class="math inline">\(d_n\)</span> a dummy for complete observations, the log-likelihood becomes:</p>
<p><span class="math display">\[
\begin{array}{rl}
\ln L = \sum_{n=1} ^ N y_{ns}\sum_{s = 1} ^ {A}&amp; \left(d_n\ln\left[F(\delta_{t_{a_n}} - \gamma ^ \top z_n) - F(\delta_{t_{a_n-1}} - \gamma ^ \top z_n)\right]\right.\\
&amp;+ \left.(1 - d_n) \ln\left[1 - F(\delta_{t_{a_n}} - \gamma ^ \top z_n)\right]\right)
\end{array}
\]</span> With the <code><a href="https://rdrr.io/pkg/micsr/man/ordreg.html">micsr::ordreg</a></code> function, the response can be a <code>Surv</code> objects in order to take into account censored observations.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">form_ord</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span><span class="va">duration</span>, <span class="va">end</span> <span class="op">==</span> <span class="st">"recall"</span><span class="op">)</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">sex</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> <span class="va">race</span> <span class="op">+</span> </span>
<span>  <span class="va">nb</span> <span class="op">+</span> <span class="va">ui</span> <span class="op">+</span> <span class="va">marital</span> <span class="op">+</span> <span class="va">unemp</span> <span class="op">+</span> <span class="va">wifemp</span> <span class="op">+</span> <span class="va">homeowner</span> <span class="op">+</span> <span class="va">occupation</span> <span class="op">+</span> <span class="va">industry</span></span>
<span><span class="va">recall_ord</span> <span class="op">&lt;-</span> <span class="fu">ordreg</span><span class="op">(</span><span class="va">form_ord</span>, <span class="va">recall</span>, link <span class="op">=</span> <span class="st">"cloglog"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- basehaz_ord <- coef(recall_ord, subset = "threshold") -->
<p>To estimate the binomial model, we first need to construct the pooled sample, i.e., to get one line for one period for every spell. We first create a data frame with only the identifiers for the individual and the spell and the duration. We then nest the data frame by the two identifiers. This results in a new column called <code>data</code> that contains, for each observation a one-line one-column tibble containing the duration of the spell. Using <code>mutate</code>, we then create a new column in <code>data</code> containing integers from 1 to the given value of <code>duration</code> for each observation. We then ungroup and remove the duration column. </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">durations</span> <span class="op">&lt;-</span> <span class="va">recall</span><span class="op">$</span><span class="va">duration</span> <span class="op">%&gt;%</span> <span class="va">unique</span></span>
<span><span class="va">pooled</span> <span class="op">&lt;-</span> <span class="va">recall</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">spell</span>, <span class="va">id</span>, <span class="va">duration</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">nest_by</span><span class="op">(</span><span class="va">spell</span>, <span class="va">id</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>period <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">data</span><span class="op">$</span><span class="va">duration</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">unnest</span><span class="op">(</span>cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">period</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="va">ungroup</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="op">-</span> <span class="va">duration</span><span class="op">)</span></span>
<span><span class="va">pooled</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 14,646 × 3
  spell    id period
  &lt;dbl&gt; &lt;dbl&gt;  &lt;int&gt;
1     1     4      1
2     1     4      2
3     1     4      3
# ℹ 14,643 more rows</code></pre>
</div>
</div>
<p>There are some periods without observations of an event or a censoring. Observations for these periods should be removed: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">durations</span> <span class="op">&lt;-</span> <span class="va">recall</span> <span class="op">%&gt;%</span> <span class="fu">pull</span><span class="op">(</span><span class="va">duration</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">unique</span></span>
<span><span class="va">pooled</span> <span class="op">&lt;-</span> <span class="va">pooled</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">period</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">durations</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally we join this tibble with the initial tibble, and we create the event variable (<code>end</code> should be <code>"recall"</code> and the period should be equal to the duration). </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">recall_pooled</span> <span class="op">&lt;-</span> <span class="va">pooled</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">recall</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"spell"</span>, <span class="st">"id"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>event <span class="op">=</span> <span class="op">(</span><span class="va">end</span> <span class="op">==</span> <span class="st">"recall"</span> <span class="op">&amp;</span> <span class="va">period</span> <span class="op">==</span> <span class="va">duration</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We then estimate different flavors of binomial models, using the same formula than for the ordered model, except that the response is now <code>event</code> and that dummies for periods are added: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">form_binom</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">form_ord</span>, <span class="va">event</span> <span class="op">~</span> <span class="va">.</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">period</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">recall_binom</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span><span class="va">form_binom</span>, family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">binomial</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"cloglog"</span><span class="op">)</span>, </span>
<span>                    data <span class="op">=</span> <span class="va">recall_pooled</span><span class="op">)</span></span>
<span><span class="va">recall_probit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">recall_binom</span>, family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">binomial</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"probit"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">recall_logit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">recall_probit</span>, family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">binomial</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"logit"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Results are presented in <a href="#tbl-recall_results">Table&nbsp;<span>13.3</span></a>.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="tbl-recall_results" class="anchored">

<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<caption>Table&nbsp;13.3:  Estimation of the grouped duration model for the recall data set </caption>
 <thead><tr>
<th style="text-align:left;">   </th>
   <th style="text-align:center;"> ordered cloglog </th>
   <th style="text-align:center;"> binomial cloglog </th>
   <th style="text-align:center;"> probit </th>
  </tr></thead>
<tbody>
<tr>
<td style="text-align:left;"> age </td>
   <td style="text-align:center;"> −0.014 (0.004) </td>
   <td style="text-align:center;"> 0.014 (0.004) </td>
   <td style="text-align:center;"> 0.006 (0.002) </td>
  </tr>
<tr>
<td style="text-align:left;"> female </td>
   <td style="text-align:center;"> 0.014 (0.155) </td>
   <td style="text-align:center;"> −0.016 (0.155) </td>
   <td style="text-align:center;"> 0.006 (0.073) </td>
  </tr>
<tr>
<td style="text-align:left;"> educ </td>
   <td style="text-align:center;"> 0.032 (0.022) </td>
   <td style="text-align:center;"> −0.030 (0.022) </td>
   <td style="text-align:center;"> −0.016 (0.011) </td>
  </tr>
<tr>
<td style="text-align:left;"> non-white </td>
   <td style="text-align:center;"> 0.240 (0.097) </td>
   <td style="text-align:center;"> −0.240 (0.097) </td>
   <td style="text-align:center;"> −0.117 (0.048) </td>
  </tr>
<tr>
<td style="text-align:left;"> No of dependents </td>
   <td style="text-align:center;"> 0.002 (0.029) </td>
   <td style="text-align:center;"> −0.002 (0.029) </td>
   <td style="text-align:center;"> −0.005 (0.015) </td>
  </tr>
<tr>
<td style="text-align:left;"> UI receipt </td>
   <td style="text-align:center;"> 0.191 (0.096) </td>
   <td style="text-align:center;"> −0.187 (0.096) </td>
   <td style="text-align:center;"> −0.084 (0.047) </td>
  </tr>
<tr>
<td style="text-align:left;"> married </td>
   <td style="text-align:center;"> −0.044 (0.146) </td>
   <td style="text-align:center;"> 0.044 (0.146) </td>
   <td style="text-align:center;"> 0.036 (0.071) </td>
  </tr>
<tr>
<td style="text-align:left;"> Area unemploy. </td>
   <td style="text-align:center;"> 0.007 (0.017) </td>
   <td style="text-align:center;"> −0.007 (0.017) </td>
   <td style="text-align:center;"> −0.003 (0.008) </td>
  </tr>
<tr>
<td style="text-align:left;"> Wife works </td>
   <td style="text-align:center;"> −0.123 (0.100) </td>
   <td style="text-align:center;"> 0.127 (0.100) </td>
   <td style="text-align:center;"> 0.065 (0.051) </td>
  </tr>
<tr>
<td style="text-align:left;box-shadow: 0px 1.5px"> Homeowner </td>
   <td style="text-align:center;box-shadow: 0px 1.5px"> −0.387 (0.099) </td>
   <td style="text-align:center;box-shadow: 0px 1.5px"> 0.391 (0.098) </td>
   <td style="text-align:center;box-shadow: 0px 1.5px"> 0.206 (0.049) </td>
  </tr>
<tr>
<td style="text-align:left;"> Industry indicators </td>
   <td style="text-align:center;"> Yes </td>
   <td style="text-align:center;"> Yes </td>
   <td style="text-align:center;"> Yes </td>
  </tr>
<tr>
<td style="text-align:left;"> Occup. indicators </td>
   <td style="text-align:center;"> Yes </td>
   <td style="text-align:center;"> Yes </td>
   <td style="text-align:center;"> Yes </td>
  </tr>
<tr>
<td style="text-align:left;"> Num.Obs. </td>
   <td style="text-align:center;"> 1045 </td>
   <td style="text-align:center;"> 13246 </td>
   <td style="text-align:center;"> 13246 </td>
  </tr>
<tr>
<td style="text-align:left;"> AIC </td>
   <td style="text-align:center;"> 4431.5 </td>
   <td style="text-align:center;"> 4443.6 </td>
   <td style="text-align:center;"> 4449.0 </td>
  </tr>
<tr>
<td style="text-align:left;"> BIC </td>
   <td style="text-align:center;"> 4693.9 </td>
   <td style="text-align:center;"> 4848.1 </td>
   <td style="text-align:center;"> 4853.5 </td>
  </tr>
<tr>
<td style="text-align:left;"> Log.Lik. </td>
   <td style="text-align:center;"> −2162.733 </td>
   <td style="text-align:center;"> −2167.804 </td>
   <td style="text-align:center;"> −2170.479 </td>
  </tr>
<tr>
<td style="text-align:left;"> F </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> 7.861 </td>
   <td style="text-align:center;"> 7.661 </td>
  </tr>
<tr>
<td style="text-align:left;"> RMSE </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> 0.20 </td>
   <td style="text-align:center;"> 0.20 </td>
  </tr>
</tbody>
</table>
</div>
</div>
</div>
<p> </p>
<!-- $$ -->
<!-- \prod_{s = 0} ^ {a_n-1} (1 - F(\ln \lambda_{os} + \beta ^ \top x_{nt_{s-1}})) F(\ln \lambda_{oa_n} + \beta ^ \top x_{nt_{a-1}}) ^ {d_n} (1 - F(\ln \lambda_{oa_n} + \beta ^ \top x_{nt_{a-1}})) ^ {1 - d_n} -->
<!-- $$ -->
<!-- Finally, the log-likelihood is, denoting $F_{ns} = F(\ln \lambda_{os} + \beta ^ \top x_{nt_{s-1}})$ -->
<!-- $$ -->
<!-- \ln L = \sum_{n=1} ^ N \left[\sum_{s=0} ^ {a_{n}}\ln (1 - F_{ns}) +d_n\left(\ln F_{na_{n-1}} - \ln(1 - F_{na_n})\right)\right] -->
<!-- $$ -->
<!-- https://www.itl.nist.gov/div898/handbook/eda/section3/eda366g.htm -->
</section><section id="interval-regression" class="level3"><h3 class="anchored" data-anchor-id="interval-regression">Interval regression</h3>
<p> Sometimes, the exact value of the response is not known, but only an interval that contains the value. For example, income is often indicated this way in individual surveys:</p>
<ul>
<li>less than $10,000,</li>
<li>from $10 to $20,000 dollars,</li>
<li>from $20 to $50,000 dollars,</li>
<li>more than $50,000 dollars.</li>
</ul>
<p>Note that, in this case, there is no bound for the last category, so that we also have a right-censoring problem. Denote <span class="math inline">\(\mu_l\)</span> and <span class="math inline">\(\mu_u\)</span> as the lower and the upper bounds of the interval and <span class="math inline">\(f\)</span> the density of the distribution of the variable of interest. The three different cases are presented in <a href="#fig-intervreg">Figure&nbsp;<span>13.6</span></a>. The variable of interest is represented on the horizontal axis and its distribution by the density curve. The lower and upper bounds are respectively denoted <span class="math inline">\(\mu_l\)</span> and <span class="math inline">\(\mu_u\)</span>. For <a href="#fig-intervreg">Figure&nbsp;<span>13.6</span></a> (a), we have <span class="math inline">\(\mu_l = 0\)</span>, so that the interval is left-censored. In <a href="#fig-intervreg">Figure&nbsp;<span>13.6</span></a> (b), both the lower and the upper bounds are observed. Finally, in <a href="#fig-intervreg">Figure&nbsp;<span>13.6</span></a> (c), only the lower bound is observed and the interval is therefore right-censored. Denoting <span class="math inline">\(F(y_n;\theta_n)\)</span> the cumulative density function for <span class="math inline">\(y\)</span>, the general formula for the probability that enters the likelihood function for one observation is: <span class="math inline">\(F(\mu^u_n ; \theta_n) - F(\mu^l_n ; \theta_n)\)</span> which simplifies respectively to <span class="math inline">\(F(\mu^l_n)\)</span> and <span class="math inline">\(1 - F(\mu^u_n)\)</span> for the cases where <span class="math inline">\(\mu_l = 0\)</span> (left-censored interval) and <span class="math inline">\(\mu_u = \infty\)</span> (right-censored interval).</p>
<div id="fig-intervreg" class="quarto-layout-panel">
<figure class="figure"><div class="quarto-layout-row quarto-layout-valign-top">
<div class="quarto-figure-spacer quarto-layout-cell" style="flex-basis: 5.0%;justify-content: center;">
<p>&nbsp;</p>
</div>
<div class="quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 40.0%;justify-content: center;">
<div id="fig-hanno" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="./tikz/fig/intervalreg2.png" class="img-fluid figure-img" data-ref-parent="fig-intervreg"></p>
<p></p><figcaption class="figure-caption">(a) Left-censored interval</figcaption><p></p>
</figure>
</div>
</div>
<div class="quarto-figure-spacer quarto-layout-cell" style="flex-basis: 10.0%;justify-content: center;">
<p>&nbsp;</p>
</div>
<div class="quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 40.0%;justify-content: center;">
<div id="fig-surus" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="./tikz/fig/intervalreg.png" class="img-fluid figure-img" data-ref-parent="fig-intervreg"></p>
<p></p><figcaption class="figure-caption">(b) Uncensored interval</figcaption><p></p>
</figure>
</div>
</div>
<div class="quarto-figure-spacer quarto-layout-cell" style="flex-basis: 5.0%;justify-content: center;">
<p>&nbsp;</p>
</div>
</div>
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="quarto-figure-spacer quarto-layout-cell" style="flex-basis: 30.0%;justify-content: center;">
<p>&nbsp;</p>
</div>
<div class="quarto-layout-cell quarto-layout-cell-subref" style="flex-basis: 40.0%;justify-content: center;">
<div id="fig-hanno" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="./tikz/fig/intervalreg3.png" class="img-fluid figure-img" data-ref-parent="fig-intervreg"></p>
<p></p><figcaption class="figure-caption">(c) Right-censored interval</figcaption><p></p>
</figure>
</div>
</div>
<div class="quarto-figure-spacer quarto-layout-cell" style="flex-basis: 30.0%;justify-content: center;">
<p>&nbsp;</p>
</div>
</div>
<p></p><figcaption class="figure-caption">Figure&nbsp;13.6: Interval regression</figcaption><p></p>
</figure>
</div>
<p>Popular choices of distribution functions are the log-normal and the Weibull distribution. For the first, a simple parametrization is to set the mean of <span class="math inline">\(\ln y\)</span> equal to <span class="math inline">\(\gamma ^ \top z_n\)</span> and its standard deviation to <span class="math inline">\(\sigma\)</span>. The probability is then:</p>
<p><span class="math display">\[
\Phi\left(\frac{\ln \mu_n ^ u - \gamma ^ \top z_n}{\sigma}\right) -
\Phi\left(\frac{\ln \mu_n ^ l - \gamma ^ \top z_n}{\sigma}\right)
\]</span></p>
<p>For the Weibull distribution, the cumulative density function is: <span class="math inline">\(F(y ; \lambda, \delta) = 1 - e ^ { -\left(\frac{y}{\lambda}\right) ^ \delta}\)</span> and the expected value is proportional to <span class="math inline">\(\lambda\)</span> (<span class="math inline">\(\mbox{E}(y) = \lambda \Gamma(1 + 1 / \delta)\)</span>). Setting <span class="math inline">\(\lambda_n = e^ {\gamma ^ \top z_n}\)</span>, we get:</p>
<p><span class="math display">\[
e^{-\delta e^{(\ln \mu_n ^ l- \gamma^\top z_n)}} - e^{- \delta e^{(\ln \mu_n ^ u - \gamma^\top z_n)}}
\]</span> An interesting case of interval response occurs in ecological economics, for which one of the methods used to estimate the value of non-market resources is contingent valuation. Consider for example the <code>kakadu</code> data set, which was used by <span class="citation" data-cites="CARS:WILK:IMBE:94">Carson, Wilks, and Imber (<a href="#ref-CARS:WILK:IMBE:94" role="doc-biblioref">1994</a>)</span> and <span class="citation" data-cites="WERN:99">Werner (<a href="#ref-WERN:99" role="doc-biblioref">1999</a>)</span>. The study concerns the Kakadu Conservation Zone, a part of the Kakadu National Park, and the survey aimed to measure the willingness to pay to preserve this zone from mining. The double-bounded, discrete-choice elicitation method of <span class="citation" data-cites="HANE:91">Hanemann (<a href="#ref-HANE:91" role="doc-biblioref">1991</a>)</span> is used; a respondent is asked whether they are willing to pay a pre-chosen randomly assigned amount to preserve the zone. If the answer is yes (no), they are asked whether he is willing to pay a higher (lower) pre-chosen amount. Four sets of dollar amounts were used (<span class="math inline">\([A: 100, 250, 50], [B: 50, 100, 20], [C: 20, 50, 5], \mbox{ and } [D:5, 20, 2]\)</span>). The response is therefore a factor with four modalities: (no, yes), (yes, no), (no, no) and (yes, yes). For the first two levels, the interval is closed as the willingness to pay is in the interval formed by the two successive amounts. For (no, no), the willing to pay is lower than the second amount and for (yes, yes), it is greater than the second amount. In the <code>kakadu</code> data set, the lower and the upper bonds are respectively <code>lower</code> and <code>upper</code>, and <code>NA</code>s indicate unbounded willingness to pay. The interval regression model can be estimated using the <code><a href="https://rdrr.io/pkg/survival/man/survreg.html">survival::survreg</a></code> function. The response should be a <code>Surv</code> object with the <code>time</code> and <code>time2</code> arguments set to the lower and to the upper bounds and the <code>type</code> argument set to <code>"interval2"</code>. The set of covariates is the one used by <span class="citation" data-cites="WERN:99">Werner (<a href="#ref-WERN:99" role="doc-biblioref">1999</a>)</span>, table 4, p.&nbsp;484. The results are presented in table <a href="#tbl-intkakadu">Table&nbsp;<span>13.4</span></a>. </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">kakadu</span> <span class="op">&lt;-</span> <span class="va">kakadu</span> <span class="op">%&gt;%</span> <span class="fu">mutate</span><span class="op">(</span>upper <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">upper</span> <span class="op">==</span> <span class="fl">999</span>, <span class="cn">NA</span>, <span class="va">upper</span><span class="op">)</span>,</span>
<span>                           lower <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">lower</span> <span class="op">==</span> <span class="fl">0</span>, <span class="cn">NA</span>, <span class="va">lower</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">kak_weil</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survreg.html">survreg</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html">Surv</a></span><span class="op">(</span>time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">lower</span><span class="op">)</span>, time2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">upper</span><span class="op">)</span>, </span>
<span>                         type <span class="op">=</span> <span class="st">"interval2"</span><span class="op">)</span> <span class="op">~</span> <span class="va">jobs</span> <span class="op">+</span> <span class="va">lowrisk</span> <span class="op">+</span> </span>
<span>                      <span class="va">aboriginal</span> <span class="op">+</span> <span class="va">finben</span> <span class="op">+</span> <span class="va">mineparks</span> <span class="op">+</span> <span class="va">moreparks</span> <span class="op">+</span> </span>
<span>                      <span class="va">envcon</span> <span class="op">+</span> <span class="va">age</span> <span class="op">+</span> <span class="va">income</span> <span class="op">+</span> <span class="va">major</span>, </span>
<span>                    <span class="va">kakadu</span>, dist <span class="op">=</span> <span class="st">"weibull"</span><span class="op">)</span></span>
<span><span class="va">kak_ln</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">kak_weil</span>, dist <span class="op">=</span> <span class="st">"lognormal"</span><span class="op">)</span></span>
<span><span class="fu">modelsummary</span><span class="fu">::</span><span class="fu"><a href="https://modelsummary.com/man/msummary.html">msummary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>Weibull <span class="op">=</span> <span class="va">kak_weil</span>, `Log-normal` <span class="op">=</span> <span class="va">kak_ln</span><span class="op">)</span>, </span>
<span>                       output <span class="op">=</span> <span class="st">"kableExtra"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="tbl-intkakadu" class="anchored">

<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<caption>Table&nbsp;13.4:  Interval regression for the Kakadu data set </caption>
 <thead><tr>
<th style="text-align:left;">   </th>
   <th style="text-align:center;"> Weibull </th>
   <th style="text-align:center;"> Log-normal </th>
  </tr></thead>
<tbody>
<tr>
<td style="text-align:left;"> (Intercept) </td>
   <td style="text-align:center;"> 2.026 </td>
   <td style="text-align:center;"> 1.428 </td>
  </tr>
<tr>
<td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.269) </td>
   <td style="text-align:center;"> (0.308) </td>
  </tr>
<tr>
<td style="text-align:left;"> jobs </td>
   <td style="text-align:center;"> −0.191 </td>
   <td style="text-align:center;"> −0.206 </td>
  </tr>
<tr>
<td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.033) </td>
   <td style="text-align:center;"> (0.040) </td>
  </tr>
<tr>
<td style="text-align:left;"> lowrisk </td>
   <td style="text-align:center;"> −0.271 </td>
   <td style="text-align:center;"> −0.294 </td>
  </tr>
<tr>
<td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.035) </td>
   <td style="text-align:center;"> (0.038) </td>
  </tr>
<tr>
<td style="text-align:left;"> aboriginal </td>
   <td style="text-align:center;"> 0.064 </td>
   <td style="text-align:center;"> 0.073 </td>
  </tr>
<tr>
<td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.031) </td>
   <td style="text-align:center;"> (0.036) </td>
  </tr>
<tr>
<td style="text-align:left;"> finben </td>
   <td style="text-align:center;"> −0.245 </td>
   <td style="text-align:center;"> −0.256 </td>
  </tr>
<tr>
<td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.036) </td>
   <td style="text-align:center;"> (0.040) </td>
  </tr>
<tr>
<td style="text-align:left;"> mineparks </td>
   <td style="text-align:center;"> 0.329 </td>
   <td style="text-align:center;"> 0.384 </td>
  </tr>
<tr>
<td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.034) </td>
   <td style="text-align:center;"> (0.039) </td>
  </tr>
<tr>
<td style="text-align:left;"> moreparks </td>
   <td style="text-align:center;"> 0.142 </td>
   <td style="text-align:center;"> 0.182 </td>
  </tr>
<tr>
<td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.032) </td>
   <td style="text-align:center;"> (0.039) </td>
  </tr>
<tr>
<td style="text-align:left;"> envconyes </td>
   <td style="text-align:center;"> 0.221 </td>
   <td style="text-align:center;"> 0.204 </td>
  </tr>
<tr>
<td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.078) </td>
   <td style="text-align:center;"> (0.086) </td>
  </tr>
<tr>
<td style="text-align:left;"> age </td>
   <td style="text-align:center;"> −0.010 </td>
   <td style="text-align:center;"> −0.015 </td>
  </tr>
<tr>
<td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.002) </td>
   <td style="text-align:center;"> (0.003) </td>
  </tr>
<tr>
<td style="text-align:left;"> income </td>
   <td style="text-align:center;"> 0.006 </td>
   <td style="text-align:center;"> 0.007 </td>
  </tr>
<tr>
<td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.002) </td>
   <td style="text-align:center;"> (0.003) </td>
  </tr>
<tr>
<td style="text-align:left;"> majoryes </td>
   <td style="text-align:center;"> 0.186 </td>
   <td style="text-align:center;"> 0.205 </td>
  </tr>
<tr>
<td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.076) </td>
   <td style="text-align:center;"> (0.084) </td>
  </tr>
<tr>
<td style="text-align:left;"> Log(scale) </td>
   <td style="text-align:center;"> 0.034 </td>
   <td style="text-align:center;"> 0.279 </td>
  </tr>
<tr>
<td style="text-align:left;box-shadow: 0px 1.5px">  </td>
   <td style="text-align:center;box-shadow: 0px 1.5px"> (0.051) </td>
   <td style="text-align:center;box-shadow: 0px 1.5px"> (0.049) </td>
  </tr>
<tr>
<td style="text-align:left;"> Num.Obs. </td>
   <td style="text-align:center;"> 1827 </td>
   <td style="text-align:center;"> 1827 </td>
  </tr>
<tr>
<td style="text-align:left;"> RMSE </td>
   <td style="text-align:center;"> 16.99 </td>
   <td style="text-align:center;"> 12.41 </td>
  </tr>
</tbody>
</table>
</div>
</div>
</div>
<p>In this example, the log-normal model fits slightly better the data than the Weibull model. The <code>predict</code> methods enables to obtain the fitted values (or the predicted values if a new data frame is provided). The argument <code>type</code> can be set to its default value <code>"response"</code> to get fitted value of the response or to <code>"link"</code> to obtain the linear predictor. For example, the mean and the median values of the willingness to pay are, for the two models: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">kak_weil</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">kak_weil</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## [1] 13.212  7.714</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">kak_ln</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">kak_ln</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## [1] 9.418 4.909</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">

</div>
<div class="cell" data-layout-align="center">

</div>


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography">
<div id="ref-AN:CHRI:GUPT:04" class="csl-entry" role="doc-biblioentry">
An, Mark Y., Bent Jesper Christensen, and Nabanita Datta Gupta. 2004. <span>“Multivariate Mixed Proportional Hazard Modelling of the Joint Retirement of Married Couples.”</span> <em>Journal of Applied Econometrics</em> 19 (6): 687–704. <a href="https://doi.org/10.1002/jae.783">https://doi.org/10.1002/jae.783</a>.
</div>
<div id="ref-CAME:TRIV:05" class="csl-entry" role="doc-biblioentry">
Cameron, A. Colin, and Pravin K. Trivedi. 2005. <em>Microeconometrics</em>. Cambridge University Press. <a href="https://EconPapers.repec.org/RePEc:cup:cbooks:9780521848053">https://EconPapers.repec.org/RePEc:cup:cbooks:9780521848053</a>.
</div>
<div id="ref-CARS:WILK:IMBE:94" class="csl-entry" role="doc-biblioentry">
Carson, Richard T., Leanne Wilks, and David Imber. 1994. <span>“Valuing the Preservation of Australia’s Kakadu Conservation Zone.”</span> <em>Oxford Economic Papers</em> 46: 727–49. <a href="http://www.jstor.org/stable/2663496">http://www.jstor.org/stable/2663496</a>.
</div>
<div id="ref-COX:72" class="csl-entry" role="doc-biblioentry">
Cox, D. R. 1972. <span>“Regression Models and Life-Tables.”</span> <em>Journal of the Royal Statistical Society. Series B (Methodological)</em> 34 (2): 187–220. <a href="http://www.jstor.org/stable/2985181">http://www.jstor.org/stable/2985181</a>.
</div>
<div id="ref-COX:75" class="csl-entry" role="doc-biblioentry">
———. 1975. <span>“Partial Likelihood.”</span> <em>Biometrika</em> 62 (2): 269–76. <a href="http://www.jstor.org/stable/2335362">http://www.jstor.org/stable/2335362</a>.
</div>
<div id="ref-FAVE:PESA:SHAR:94" class="csl-entry" role="doc-biblioentry">
Favero, Carlo A., M. Hashem Pesaran, and Sunil Sharma. 1994. <span>“A Duration Model of Irreversible Oil Investment: Theory and Empirical Evidence.”</span> <em>Journal of Applied Econometrics</em> 9: S95–112. <a href="http://www.jstor.org/stable/2285225">http://www.jstor.org/stable/2285225</a>.
</div>
<div id="ref-HANE:91" class="csl-entry" role="doc-biblioentry">
Hanemann, W. Michael. 1991. <span>“Willingness to Pay and Willingness to Accept: How Much Can They Differ?”</span> <em>The American Economic Review</em> 81 (3): 635–47. <a href="http://www.jstor.org/stable/2006525">http://www.jstor.org/stable/2006525</a>.
</div>
<div id="ref-KAST:VAND:22" class="csl-entry" role="doc-biblioentry">
Kastoryano, Stephen, and Bas van der Klaauw. 2022. <span>“Dynamic Evaluation of Job Search Assistance.”</span> <em>Journal of Applied Econometrics</em> 37 (2): 227–41. <a href="https://doi.org/10.1002/jae.2866">https://doi.org/10.1002/jae.2866</a>.
</div>
<div id="ref-KATZ:86" class="csl-entry" role="doc-biblioentry">
Katz, Lawrence F. 1986. <span>“<span class="nocase">Layoffs, Recall and the Duration of Unemployment</span>.”</span> NBER Working Papers 1825. National Bureau of Economic Research, Inc. <a href="https://ideas.repec.org/p/nbr/nberwo/1825.html">https://ideas.repec.org/p/nbr/nberwo/1825.html</a>.
</div>
<div id="ref-LANC:90" class="csl-entry" role="doc-biblioentry">
Lancaster, Tony. 1990. In <em>The Econometric Analysis of Transition Data</em>. Econometric Society Monographs. Cambridge University Press.
</div>
<div id="ref-SUEY:95" class="csl-entry" role="doc-biblioentry">
Sueyoshi, Glenn T. 1995. <span>“<span class="nocase">A Class of Binary Response Models for Grouped Duration Data</span>.”</span> <em>Journal of Applied Econometrics</em> 10 (4): 411–31. <a href="https://ideas.repec.org/a/jae/japmet/v10y1995i4p411-31.html">https://ideas.repec.org/a/jae/japmet/v10y1995i4p411-31.html</a>.
</div>
<div id="ref-WERN:99" class="csl-entry" role="doc-biblioentry">
Werner, Megan. 1999. <span>“Allowing for Zeros in Dichotomous-Choice Contingent-Valuation Models.”</span> <em>Journal of Business &amp; Economic Statistics</em> 17 (4): 479–86. <a href="http://www.jstor.org/stable/1392405">http://www.jstor.org/stable/1392405</a>.
</div>
</div>
</section></section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><hr>
<ol>
<li id="fn1"><p>The survival function is sometimes defined as <span class="math inline">\(S(t) = P(T \geq t)\)</span>, see <span class="citation" data-cites="CAME:TRIV:05">Cameron and Trivedi (<a href="#ref-CAME:TRIV:05" role="doc-biblioref">2005</a>)</span>.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>This section relies heavily on <span class="citation" data-cites="LANC:90">Lancaster (<a href="#ref-LANC:90" role="doc-biblioref">1990</a>)</span>. pp.&nbsp;17-20.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>More precisely, this is the Gumbel distribution (minimum); for the Gumbel distribution (maximum), <span class="math inline">\(F(U) = \exp (- \exp (- U))\)</span>.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>This example is from <span class="citation" data-cites="CAME:TRIV:05">Cameron and Trivedi (<a href="#ref-CAME:TRIV:05" role="doc-biblioref">2005</a>)</span>, p.&nbsp;611.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>Note that we used <span class="math inline">\(-\gamma\)</span> instead of <span class="math inline">\(\gamma\)</span>, like for the AFT models, for a reason that will be clear later in this section.<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="../chapters/count.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Count data</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../chapters/rum.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Discrete choice models</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb60" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Duration models {#sec-duration}</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"../_commonR.R"</span>)</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>When the response is a duration, specific models are used, which comes</span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>from the biostatistics (eg lifetime after an hearth transplant) and operations research (eg lifetime of a light bulb) literature. These data are called **duration** or **transition** data. The latter term indicates that we are interested in the time span of the transition from one state to another, the latter being called **death** and **failure**, respectively in the biostatistics and the operations research fields. For a given time, the observations for which the transition didn't take place are called **at-risk** observations. </span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{at-risk observations}</span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>Duration data have two main characteristics, that require the use of</span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a>specific models. The first is that they are continuous-positive variables. </span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a>The second is that they are often censored, especially right-censored; for example, trying to modelize the length of unemployment spells, we'll use survey data on employment realized in a given period (for example 2 years). At the end of the survey, some individuals are still unemployed because the spell is not finished, so that the duration of their spell is not observed, but only the fact that it is greater than the observed duration at the end of the survey.</span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a>Denote $t$ as the duration response. Its distribution is given by a</span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a>probability $\mbox{P}(T \leq t) =F(t)$ and a density function $f(t)$.</span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true" tabindex="-1"></a>The survival function is often used, which is</span>
<span id="cb60-19"><a href="#cb60-19" aria-hidden="true" tabindex="-1"></a>$S(t) = P(T &gt; t) = 1 - F(t)$.^[The survival function is sometimes defined as</span>
<span id="cb60-20"><a href="#cb60-20" aria-hidden="true" tabindex="-1"></a>    $S(t) = P(T \geq t)$, see @CAME:TRIV:05\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Cameron}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Trivedi}.] For example, if $T$ is measured in</span>
<span id="cb60-21"><a href="#cb60-21" aria-hidden="true" tabindex="-1"></a>month and if $t = 12$, $F(12) = 0.8$ means that 80% of unemployment</span>
<span id="cb60-22"><a href="#cb60-22" aria-hidden="true" tabindex="-1"></a>spells are less than 1 year, and $S(12) = 0.2$ means that 20% of</span>
<span id="cb60-23"><a href="#cb60-23" aria-hidden="true" tabindex="-1"></a>unemployment spells are more than 1 year. For a small variation of the</span>
<span id="cb60-24"><a href="#cb60-24" aria-hidden="true" tabindex="-1"></a>spell (say $dt = 1$ month), $f(t)dt$ is the probability that the length</span>
<span id="cb60-25"><a href="#cb60-25" aria-hidden="true" tabindex="-1"></a>of the spell is between $t$ and $t + dt$ (between 12 and 13 months in</span>
<span id="cb60-26"><a href="#cb60-26" aria-hidden="true" tabindex="-1"></a>our example). Assume that $f(12) = 0.06$. It means that 6% of the spells</span>
<span id="cb60-27"><a href="#cb60-27" aria-hidden="true" tabindex="-1"></a>ends between the 12^th^ and the 13^th^ month. If we divide by</span>
<span id="cb60-28"><a href="#cb60-28" aria-hidden="true" tabindex="-1"></a>$S(12) = 0.2$, we get $f(12) / S(12) = 0.3$, which means that 30% of the</span>
<span id="cb60-29"><a href="#cb60-29" aria-hidden="true" tabindex="-1"></a>spells of at least one year ends during the 13^th^ month. This is called</span>
<span id="cb60-30"><a href="#cb60-30" aria-hidden="true" tabindex="-1"></a>the **hazard function**\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{hazard function} and it plays a central role in duration analysis.</span>
<span id="cb60-31"><a href="#cb60-31" aria-hidden="true" tabindex="-1"></a>More formally, the hazard function is defined by:</span>
<span id="cb60-32"><a href="#cb60-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-33"><a href="#cb60-33" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-34"><a href="#cb60-34" aria-hidden="true" tabindex="-1"></a>\theta(t)=  \lim_{dt \rightarrow 0} \frac{\mbox{P}(t \leq T &lt; t + dt \mid T &gt; t)}{dt} = \lim_{dt \rightarrow 0} \frac{F(t + dt) - F(t)}{1 - F(t)} = \frac{f(t)}{S(t)}</span>
<span id="cb60-35"><a href="#cb60-35" aria-hidden="true" tabindex="-1"></a>$$ {#eq-hazard_function}</span>
<span id="cb60-36"><a href="#cb60-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-37"><a href="#cb60-37" aria-hidden="true" tabindex="-1"></a>The hazard function is also the derivative of the opposite of the</span>
<span id="cb60-38"><a href="#cb60-38" aria-hidden="true" tabindex="-1"></a>logarithm of the survival function:</span>
<span id="cb60-39"><a href="#cb60-39" aria-hidden="true" tabindex="-1"></a>$\frac{\partial \ln S}{\partial t} = \frac{- f(t)}{S(t)} = - \theta(t)$</span>
<span id="cb60-40"><a href="#cb60-40" aria-hidden="true" tabindex="-1"></a>Inversely, the log survival function is a primitive of the hazard,</span>
<span id="cb60-41"><a href="#cb60-41" aria-hidden="true" tabindex="-1"></a>so that, using the fact that $S(0) = 1$, the **cumulative hazard**</span>
<span id="cb60-42"><a href="#cb60-42" aria-hidden="true" tabindex="-1"></a>function $\Lambda(t)$ is: \index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{cumulative hazard}</span>
<span id="cb60-43"><a href="#cb60-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-44"><a href="#cb60-44" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-45"><a href="#cb60-45" aria-hidden="true" tabindex="-1"></a>\Lambda(t) = \int_{0} ^ t \theta(s) ds = - \ln S(t)</span>
<span id="cb60-46"><a href="#cb60-46" aria-hidden="true" tabindex="-1"></a>$$ {#eq-cummulative_hazard}</span>
<span id="cb60-47"><a href="#cb60-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-48"><a href="#cb60-48" aria-hidden="true" tabindex="-1"></a>Now consider the area under the survival curve:</span>
<span id="cb60-49"><a href="#cb60-49" aria-hidden="true" tabindex="-1"></a>$\int_{0} ^ {+\infty} S(t) dt$. Integrating by part, we get:</span>
<span id="cb60-50"><a href="#cb60-50" aria-hidden="true" tabindex="-1"></a>$\int_0 ^ {+\infty} S(t) dt = \left<span class="co">[</span><span class="ot">t S(t)\right</span><span class="co">]</span>_0 ^ {+\infty} - \int_{0} ^ {+\infty} -f(t) t dt = \int_{0} ^ {+\infty} f(t) t dt$</span>
<span id="cb60-51"><a href="#cb60-51" aria-hidden="true" tabindex="-1"></a>as $\lim_{t \rightarrow + \infty} S(t) t = 0$. Therefore, this area is</span>
<span id="cb60-52"><a href="#cb60-52" aria-hidden="true" tabindex="-1"></a>the expected value of the duration of the spell.</span>
<span id="cb60-53"><a href="#cb60-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-54"><a href="#cb60-54" aria-hidden="true" tabindex="-1"></a>The hazard and survival functions can also be defined in terms of</span>
<span id="cb60-55"><a href="#cb60-55" aria-hidden="true" tabindex="-1"></a>discrete time either because the duration is intrinsically discrete or</span>
<span id="cb60-56"><a href="#cb60-56" aria-hidden="true" tabindex="-1"></a>because it is rounded to a given time unit (weeks or months, for</span>
<span id="cb60-57"><a href="#cb60-57" aria-hidden="true" tabindex="-1"></a>example). Consider that the event is observed for $K$ distinct </span>
<span id="cb60-58"><a href="#cb60-58" aria-hidden="true" tabindex="-1"></a>times, denoted by $t_1, t_2, \ldots t_k, \ldots t_K$. If there are no ties,</span>
<span id="cb60-59"><a href="#cb60-59" aria-hidden="true" tabindex="-1"></a>which means that all the events occur at a specific time, then $K=N$.</span>
<span id="cb60-60"><a href="#cb60-60" aria-hidden="true" tabindex="-1"></a>The **discrete-time hazard** function is the probability of transition</span>
<span id="cb60-61"><a href="#cb60-61" aria-hidden="true" tabindex="-1"></a>at time $t_j$ given survival to time $t_j$:\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{discrete-time hazard}</span>
<span id="cb60-62"><a href="#cb60-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-63"><a href="#cb60-63" aria-hidden="true" tabindex="-1"></a>$$\theta_j = P(T = t_j \mid T \geq t_j) = \frac{f^d(t_j)}{S^d(t_{j-})}$$</span>
<span id="cb60-64"><a href="#cb60-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-65"><a href="#cb60-65" aria-hidden="true" tabindex="-1"></a>where $S^d(t_{j-})$ is the value of the survival function just before</span>
<span id="cb60-66"><a href="#cb60-66" aria-hidden="true" tabindex="-1"></a>$t_j$. The **discrete-time survivor function** is obtained from the</span>
<span id="cb60-67"><a href="#cb60-67" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{discrete-time survivor functions}</span>
<span id="cb60-68"><a href="#cb60-68" aria-hidden="true" tabindex="-1"></a>hazard function: $S^d(t) = P(T \geq t) = \prod_{j | t_j \leq t} (1 - \theta_j)$. </span>
<span id="cb60-69"><a href="#cb60-69" aria-hidden="true" tabindex="-1"></a>For example, the probability of surviving at least to $t_2$ is: $S^d(t_2) = (1 - \theta_1) (1 - \theta_2)$. The first term is the probability of no transition at $t_1$, and the second one is the probability of no transition at $t_2$ conditional on surviving to just before $t_2$.</span>
<span id="cb60-70"><a href="#cb60-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-71"><a href="#cb60-71" aria-hidden="true" tabindex="-1"></a>@sec-kaplan_maier is devoted to the non-parametric estimation of the survival function.  @sec-param_duration presents different parametric and semi-parametric estimators. @sec-heter_duration tackles the problem of heterogeneity in duration models. Finally, @sec-misc_duration presents miscellaneous duration models.</span>
<span id="cb60-72"><a href="#cb60-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-73"><a href="#cb60-73" aria-hidden="true" tabindex="-1"></a>Duration analysis using **R** is performed using the **survival** package, which is a "recommended" package, which means that it comes with any **R** distribution. </span>
<span id="cb60-74"><a href="#cb60-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-77"><a href="#cb60-77" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb60-78"><a href="#cb60-78" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb60-79"><a href="#cb60-79" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb60-80"><a href="#cb60-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-81"><a href="#cb60-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-82"><a href="#cb60-82" aria-hidden="true" tabindex="-1"></a><span class="fu">## Kaplan-Meier non-parametric estimator {#sec-kaplan_maier}</span></span>
<span id="cb60-83"><a href="#cb60-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-84"><a href="#cb60-84" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{Kaplan-Meier estimator|(}</span>
<span id="cb60-85"><a href="#cb60-85" aria-hidden="true" tabindex="-1"></a>The Kaplan-Meier estimator is a non-parametric estimator of the survival</span>
<span id="cb60-86"><a href="#cb60-86" aria-hidden="true" tabindex="-1"></a>function. As such, it is very useful as a primary tool before</span>
<span id="cb60-87"><a href="#cb60-87" aria-hidden="true" tabindex="-1"></a>developing more complicated parametric models.</span>
<span id="cb60-88"><a href="#cb60-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-89"><a href="#cb60-89" aria-hidden="true" tabindex="-1"></a><span class="fu">### Uncensored sample</span></span>
<span id="cb60-90"><a href="#cb60-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-91"><a href="#cb60-91" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{Kaplan-Meier estimator!uncensored sample|(}</span>
<span id="cb60-92"><a href="#cb60-92" aria-hidden="true" tabindex="-1"></a>To demonstrate this estimator, it is convenient to use first uncensored</span>
<span id="cb60-93"><a href="#cb60-93" aria-hidden="true" tabindex="-1"></a>data. This is the case of the <span class="in">`oil`</span> <span class="co">[</span><span class="ot">@FAVE:PESA:SHAR:94</span><span class="co">]</span>\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Favero}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Pesaran}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Sharma} data set which</span>
<span id="cb60-94"><a href="#cb60-94" aria-hidden="true" tabindex="-1"></a>indicates the number of months between the discovery of an oil field and</span>
<span id="cb60-95"><a href="#cb60-95" aria-hidden="true" tabindex="-1"></a>the beginning of development. For each failure times $t_k$, we count the</span>
<span id="cb60-96"><a href="#cb60-96" aria-hidden="true" tabindex="-1"></a>number of events $d_k$ (the number of spells ending at time $t_k$) and</span>
<span id="cb60-97"><a href="#cb60-97" aria-hidden="true" tabindex="-1"></a>the number of observations at-risk, i.e., the number of spells which</span>
<span id="cb60-98"><a href="#cb60-98" aria-hidden="true" tabindex="-1"></a>haven't ended just before $t_k$, denoted by $r_k$.</span>
<span id="cb60-99"><a href="#cb60-99" aria-hidden="true" tabindex="-1"></a>For the <span class="in">`oil`</span> data set, we have 53 observations and the first ordered</span>
<span id="cb60-100"><a href="#cb60-100" aria-hidden="true" tabindex="-1"></a>values of duration are:</span>
<span id="cb60-101"><a href="#cb60-101" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">(</span><span class="co">]</span>{oil}{micsr.data}</span>
<span id="cb60-102"><a href="#cb60-102" aria-hidden="true" tabindex="-1"></a>\idxfun{arrange}{dplyr}\idxfun{pull}{dplyr}\idxfun{head}{utils}</span>
<span id="cb60-103"><a href="#cb60-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-104"><a href="#cb60-104" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb60-105"><a href="#cb60-105" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb60-106"><a href="#cb60-106" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: true</span></span>
<span id="cb60-107"><a href="#cb60-107" aria-hidden="true" tabindex="-1"></a>oil <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(dur) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(dur) <span class="sc">%&gt;%</span> head</span>
<span id="cb60-108"><a href="#cb60-108" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb60-109"><a href="#cb60-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-110"><a href="#cb60-110" aria-hidden="true" tabindex="-1"></a>Therefore, $t_1 = 1$ and $r_1 = 53$ because all the spells are at risk</span>
<span id="cb60-111"><a href="#cb60-111" aria-hidden="true" tabindex="-1"></a>just before time is equal to 1. The hazard function for $t_1$ is then</span>
<span id="cb60-112"><a href="#cb60-112" aria-hidden="true" tabindex="-1"></a>estimated by $1/53 = 0.0189$, and the survival function by</span>
<span id="cb60-113"><a href="#cb60-113" aria-hidden="true" tabindex="-1"></a>$1 - 1/53 = 0.981$, which means that the estimated probability that the</span>
<span id="cb60-114"><a href="#cb60-114" aria-hidden="true" tabindex="-1"></a>spell is greater than 1 month is $98.1$%. For $t_2= 3$, we have</span>
<span id="cb60-115"><a href="#cb60-115" aria-hidden="true" tabindex="-1"></a>$d_2 = 2$ and the number of observations at risk are the ongoing spells</span>
<span id="cb60-116"><a href="#cb60-116" aria-hidden="true" tabindex="-1"></a>just before time is equal to 2, which is $r_2 = r_1 - d_1 = 52$. The hazard</span>
<span id="cb60-117"><a href="#cb60-117" aria-hidden="true" tabindex="-1"></a>function for $t_2 = 3$ is then $d_2 / r_2 = 2 / 52 = 0.038$, which means</span>
<span id="cb60-118"><a href="#cb60-118" aria-hidden="true" tabindex="-1"></a>that the estimated probability of ending at time 3 for spells which are</span>
<span id="cb60-119"><a href="#cb60-119" aria-hidden="true" tabindex="-1"></a>at least 1 month long is $3.8$%. The survival function for time equal to 3</span>
<span id="cb60-120"><a href="#cb60-120" aria-hidden="true" tabindex="-1"></a>is therefore:$(1 - d_1 / r_1) \times (1 - d_2 / r_2) = 0.981 \times 0.961 = 0.943$.</span>
<span id="cb60-121"><a href="#cb60-121" aria-hidden="true" tabindex="-1"></a>Note that as $r_1 = N$ and $r_2 = r_1 - d_1 = N - d_1$, the estimated</span>
<span id="cb60-122"><a href="#cb60-122" aria-hidden="true" tabindex="-1"></a>survival probability for $t_2$ is $(1 - d_1 / N)(1 - d_2 / (N - d_1))$,</span>
<span id="cb60-123"><a href="#cb60-123" aria-hidden="true" tabindex="-1"></a>which simplifies to $1 - (d_1 + d_2) / N$. For $t_3 = 7$, we have</span>
<span id="cb60-124"><a href="#cb60-124" aria-hidden="true" tabindex="-1"></a>$d_3 / r_3 = 1 / 50 = 0.02$ and the survival function can be either</span>
<span id="cb60-125"><a href="#cb60-125" aria-hidden="true" tabindex="-1"></a>estimated by $0.943 \times (1 - 0.02)$ or by $(1 - 4 / 53) = 0.9245$.</span>
<span id="cb60-126"><a href="#cb60-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-127"><a href="#cb60-127" aria-hidden="true" tabindex="-1"></a>The whole survival series can be easily obtained with the following</span>
<span id="cb60-128"><a href="#cb60-128" aria-hidden="true" tabindex="-1"></a>code; we first create a frequency table of durations (the durations are</span>
<span id="cb60-129"><a href="#cb60-129" aria-hidden="true" tabindex="-1"></a>then automatically arranged in an increasing order), the <span class="in">`n`</span> column then</span>
<span id="cb60-130"><a href="#cb60-130" aria-hidden="true" tabindex="-1"></a>contains the number of spells that end at each period. We then compute</span>
<span id="cb60-131"><a href="#cb60-131" aria-hidden="true" tabindex="-1"></a>the cumulative sums of this counts <span class="in">`cumn`</span> and the survival probabilities</span>
<span id="cb60-132"><a href="#cb60-132" aria-hidden="true" tabindex="-1"></a>as the cumulative count divided by $N$.</span>
<span id="cb60-133"><a href="#cb60-133" aria-hidden="true" tabindex="-1"></a>\idxfun{count}{dplyr}\idxfun{mutate}{dplyr}\idxfun{cumsum}{base}</span>
<span id="cb60-134"><a href="#cb60-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-135"><a href="#cb60-135" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb60-136"><a href="#cb60-136" aria-hidden="true" tabindex="-1"></a>surv_tb <span class="ot">&lt;-</span> oil <span class="sc">%&gt;%</span> <span class="fu">count</span>(dur) <span class="sc">%&gt;%</span> </span>
<span id="cb60-137"><a href="#cb60-137" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cumn =</span> <span class="fu">cumsum</span>(n), <span class="at">surv =</span> <span class="dv">1</span> <span class="sc">-</span> cumn <span class="sc">/</span> <span class="dv">53</span>)</span>
<span id="cb60-138"><a href="#cb60-138" aria-hidden="true" tabindex="-1"></a>surv_tb</span>
<span id="cb60-139"><a href="#cb60-139" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb60-140"><a href="#cb60-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-141"><a href="#cb60-141" aria-hidden="true" tabindex="-1"></a>A more complex calculus (but which will prove to be useful if there are</span>
<span id="cb60-142"><a href="#cb60-142" aria-hidden="true" tabindex="-1"></a>censored spells) consists of computing the number of spells at risk, the</span>
<span id="cb60-143"><a href="#cb60-143" aria-hidden="true" tabindex="-1"></a>hazard and then the survival function as the cumulative product of 1</span>
<span id="cb60-144"><a href="#cb60-144" aria-hidden="true" tabindex="-1"></a>minus the hazard rate.</span>
<span id="cb60-145"><a href="#cb60-145" aria-hidden="true" tabindex="-1"></a>\idxfun{count}{dplyr}\idxfun{cumsum}{base}\idxfun{ifelse}{base}\idxfun{lag}{dplyr}\idxfun{cumprod}{base}</span>
<span id="cb60-146"><a href="#cb60-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-147"><a href="#cb60-147" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb60-148"><a href="#cb60-148" aria-hidden="true" tabindex="-1"></a>oil <span class="sc">%&gt;%</span> </span>
<span id="cb60-149"><a href="#cb60-149" aria-hidden="true" tabindex="-1"></a>    <span class="fu">count</span>(dur) <span class="sc">%&gt;%</span></span>
<span id="cb60-150"><a href="#cb60-150" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">cumn =</span> <span class="fu">cumsum</span>(n),</span>
<span id="cb60-151"><a href="#cb60-151" aria-hidden="true" tabindex="-1"></a>           <span class="at">at_risk =</span>  <span class="fu">ifelse</span>(dur <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">53</span>, <span class="dv">53</span> <span class="sc">-</span> <span class="fu">lag</span>(cumn)),</span>
<span id="cb60-152"><a href="#cb60-152" aria-hidden="true" tabindex="-1"></a>           <span class="at">hazard =</span> n <span class="sc">/</span> at_risk,</span>
<span id="cb60-153"><a href="#cb60-153" aria-hidden="true" tabindex="-1"></a>           <span class="at">surv =</span> <span class="fu">cumprod</span>(<span class="dv">1</span> <span class="sc">-</span> hazard))</span>
<span id="cb60-154"><a href="#cb60-154" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb60-155"><a href="#cb60-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-156"><a href="#cb60-156" aria-hidden="true" tabindex="-1"></a>The survival function can also be plotted. As it is a step function,</span>
<span id="cb60-157"><a href="#cb60-157" aria-hidden="true" tabindex="-1"></a>using the <span class="in">`geom_step`</span> function is particularly useful, see</span>
<span id="cb60-158"><a href="#cb60-158" aria-hidden="true" tabindex="-1"></a>@fig-survcurve.</span>
<span id="cb60-159"><a href="#cb60-159" aria-hidden="true" tabindex="-1"></a>\idxfun{ggplot}{ggplot2}\idxfun{aes}{ggplot2}\idxfun{geom<span class="sc">\_</span>step}{ggplot2}</span>
<span id="cb60-160"><a href="#cb60-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-161"><a href="#cb60-161" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb60-162"><a href="#cb60-162" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-survcurve</span></span>
<span id="cb60-163"><a href="#cb60-163" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Survival curve for the oil data set"</span></span>
<span id="cb60-164"><a href="#cb60-164" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb60-165"><a href="#cb60-165" aria-hidden="true" tabindex="-1"></a>km_oil <span class="ot">&lt;-</span> surv_tb <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(dur, surv)) <span class="sc">+</span> <span class="fu">geom_step</span>()</span>
<span id="cb60-166"><a href="#cb60-166" aria-hidden="true" tabindex="-1"></a>km_oil</span>
<span id="cb60-167"><a href="#cb60-167" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb60-168"><a href="#cb60-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-169"><a href="#cb60-169" aria-hidden="true" tabindex="-1"></a>Reminding that $\frac{\partial \ln S(t)}{\partial t} = - \lambda(t)$, it</span>
<span id="cb60-170"><a href="#cb60-170" aria-hidden="true" tabindex="-1"></a>is useful to use a logarithmic y-axis as, the hazard is then the slope</span>
<span id="cb60-171"><a href="#cb60-171" aria-hidden="true" tabindex="-1"></a>(in absolute value) of the curve (see @fig-logsurvcurve). In particular,</span>
<span id="cb60-172"><a href="#cb60-172" aria-hidden="true" tabindex="-1"></a>the constant hazard hypothesis would induce a roughly linear survival</span>
<span id="cb60-173"><a href="#cb60-173" aria-hidden="true" tabindex="-1"></a>curve.\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{constant hazard hypothesis}</span>
<span id="cb60-174"><a href="#cb60-174" aria-hidden="true" tabindex="-1"></a>\idxfun{coord<span class="sc">\_</span>cartesian}{ggplot2}\idxfun{scale<span class="sc">\_</span>y<span class="sc">\_</span>continuous}{ggplot2}\idxfun{geom<span class="sc">\_</span>smooth}{ggplot2}</span>
<span id="cb60-175"><a href="#cb60-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-176"><a href="#cb60-176" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb60-177"><a href="#cb60-177" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-logsurvcurve</span></span>
<span id="cb60-178"><a href="#cb60-178" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb60-179"><a href="#cb60-179" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb60-180"><a href="#cb60-180" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Survival curve for the oil data set with a log scale"</span></span>
<span id="cb60-181"><a href="#cb60-181" aria-hidden="true" tabindex="-1"></a>km_oil <span class="sc">+</span> <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">150</span>)) <span class="sc">+</span></span>
<span id="cb60-182"><a href="#cb60-182" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">trans =</span> <span class="st">"log"</span>, <span class="at">breaks =</span> <span class="fu">c</span>(<span class="fl">0.01</span>, <span class="fl">0.1</span>, <span class="dv">1</span>)) <span class="sc">+</span> </span>
<span id="cb60-183"><a href="#cb60-183" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="at">se =</span> <span class="cn">FALSE</span>)</span>
<span id="cb60-184"><a href="#cb60-184" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb60-185"><a href="#cb60-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-186"><a href="#cb60-186" aria-hidden="true" tabindex="-1"></a>We can see in this example that the hazard rate seems to be roughly</span>
<span id="cb60-187"><a href="#cb60-187" aria-hidden="true" tabindex="-1"></a>constant for a wide range of values of duration (0-100 months) and then</span>
<span id="cb60-188"><a href="#cb60-188" aria-hidden="true" tabindex="-1"></a>decreasing for high values of duration ($&gt;100$).</span>
<span id="cb60-189"><a href="#cb60-189" aria-hidden="true" tabindex="-1"></a>The Kaplan-Meier estimator can also be computed using the</span>
<span id="cb60-190"><a href="#cb60-190" aria-hidden="true" tabindex="-1"></a><span class="in">`survreg::surfit`</span> function, with the usual formula-data interface. The</span>
<span id="cb60-191"><a href="#cb60-191" aria-hidden="true" tabindex="-1"></a>response must be a <span class="in">`Surv`</span> object, and the right-hand side of the formula</span>
<span id="cb60-192"><a href="#cb60-192" aria-hidden="true" tabindex="-1"></a>is just an intercept. A <span class="in">`Surv`</span> object is obtained using the <span class="in">`Surv`</span></span>
<span id="cb60-193"><a href="#cb60-193" aria-hidden="true" tabindex="-1"></a>function. With uncensored data, its only argument is the duration</span>
<span id="cb60-194"><a href="#cb60-194" aria-hidden="true" tabindex="-1"></a>response. We then have:</span>
<span id="cb60-195"><a href="#cb60-195" aria-hidden="true" tabindex="-1"></a>\idxfun{survfit}{survival}\idxfun{Surv}{survival}</span>
<span id="cb60-196"><a href="#cb60-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-197"><a href="#cb60-197" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb60-198"><a href="#cb60-198" aria-hidden="true" tabindex="-1"></a>sf <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(dur) <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> oil)</span>
<span id="cb60-199"><a href="#cb60-199" aria-hidden="true" tabindex="-1"></a>sf</span>
<span id="cb60-200"><a href="#cb60-200" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb60-201"><a href="#cb60-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-202"><a href="#cb60-202" aria-hidden="true" tabindex="-1"></a>The <span class="in">`print`</span> method returns the number of observations (<span class="in">`n`</span>) the number</span>
<span id="cb60-203"><a href="#cb60-203" aria-hidden="true" tabindex="-1"></a>of events (<span class="in">`events`</span>), which is equal to the number of observations if</span>
<span id="cb60-204"><a href="#cb60-204" aria-hidden="true" tabindex="-1"></a>all the spells are uncensored, the median spell duration and its 95%</span>
<span id="cb60-205"><a href="#cb60-205" aria-hidden="true" tabindex="-1"></a>confidence interval. The <span class="in">`print.summary`</span> function returns a table with one row</span>
<span id="cb60-206"><a href="#cb60-206" aria-hidden="true" tabindex="-1"></a>for each time some spells end. The object</span>
<span id="cb60-207"><a href="#cb60-207" aria-hidden="true" tabindex="-1"></a>returned by <span class="in">`survfit`</span> is not a data frame, but the <span class="in">`broom:tidy`</span> method coerces it easily to a tibble:</span>
<span id="cb60-208"><a href="#cb60-208" aria-hidden="true" tabindex="-1"></a>\idxfun{tidy}{broom}</span>
<span id="cb60-209"><a href="#cb60-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-210"><a href="#cb60-210" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb60-211"><a href="#cb60-211" aria-hidden="true" tabindex="-1"></a>broom<span class="sc">::</span><span class="fu">tidy</span>(sf)</span>
<span id="cb60-212"><a href="#cb60-212" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb60-213"><a href="#cb60-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-214"><a href="#cb60-214" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">)</span><span class="co">]</span>{oil}{micsr.data}</span>
<span id="cb60-215"><a href="#cb60-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-216"><a href="#cb60-216" aria-hidden="true" tabindex="-1"></a>There is a <span class="in">`plot`</span> method for <span class="in">`survfit`</span> objects that draws the survival curve and its confidence interval.</span>
<span id="cb60-217"><a href="#cb60-217" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{Kaplan-Meier estimator!uncensored sample|)}</span>
<span id="cb60-218"><a href="#cb60-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-219"><a href="#cb60-219" aria-hidden="true" tabindex="-1"></a><span class="fu">### Censored sample</span></span>
<span id="cb60-220"><a href="#cb60-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-221"><a href="#cb60-221" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{Kaplan-Meier estimator!censored sample|(}</span>
<span id="cb60-222"><a href="#cb60-222" aria-hidden="true" tabindex="-1"></a>When there are censored observations, the computation is modified.</span>
<span id="cb60-223"><a href="#cb60-223" aria-hidden="true" tabindex="-1"></a>Consider the <span class="in">`retirement`</span> data set <span class="co">[</span><span class="ot">@AN:CHRI:GUPT:04</span><span class="co">]</span>\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{An}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Christensen}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Gupta}. It contains the joint</span>
<span id="cb60-224"><a href="#cb60-224" aria-hidden="true" tabindex="-1"></a>duration until retirement for both spouses of 243 couples in Denmark.</span>
<span id="cb60-225"><a href="#cb60-225" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">(</span><span class="co">]</span>{retirement}{micsr.data}</span>
<span id="cb60-226"><a href="#cb60-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-227"><a href="#cb60-227" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb60-228"><a href="#cb60-228" aria-hidden="true" tabindex="-1"></a>retirement</span>
<span id="cb60-229"><a href="#cb60-229" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb60-230"><a href="#cb60-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-231"><a href="#cb60-231" aria-hidden="true" tabindex="-1"></a><span class="in">`id`</span> is the couple identifier, there are several annual observations for</span>
<span id="cb60-232"><a href="#cb60-232" aria-hidden="true" tabindex="-1"></a>every couple (because some covariates are time-varying), the duration</span>
<span id="cb60-233"><a href="#cb60-233" aria-hidden="true" tabindex="-1"></a>until retirement for males is <span class="in">`durm`</span> and <span class="in">`censm`</span> is a dummy which equals</span>
<span id="cb60-234"><a href="#cb60-234" aria-hidden="true" tabindex="-1"></a>1 if the observation is right-censored. The corresponding variables</span>
<span id="cb60-235"><a href="#cb60-235" aria-hidden="true" tabindex="-1"></a>for women are <span class="in">`durf`</span> and <span class="in">`censf`</span>. We'll concentrate on women. To get one observation for each</span>
<span id="cb60-236"><a href="#cb60-236" aria-hidden="true" tabindex="-1"></a>woman, we simply select these two variables, which are time-invariant,</span>
<span id="cb60-237"><a href="#cb60-237" aria-hidden="true" tabindex="-1"></a>and we keep only the distinct rows:</span>
<span id="cb60-238"><a href="#cb60-238" aria-hidden="true" tabindex="-1"></a>\idxfun{select}{dplyr}\idxfun{mutate}{dplyr}\idxfun{ifelse}{base}\idxfun{distinct}{dplyr}</span>
<span id="cb60-239"><a href="#cb60-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-240"><a href="#cb60-240" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb60-241"><a href="#cb60-241" aria-hidden="true" tabindex="-1"></a>ret <span class="ot">&lt;-</span> retirement <span class="sc">%&gt;%</span></span>
<span id="cb60-242"><a href="#cb60-242" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(id, <span class="at">duration =</span> durf, <span class="at">censored =</span> censf) <span class="sc">%&gt;%</span> </span>
<span id="cb60-243"><a href="#cb60-243" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">censored =</span> <span class="fu">ifelse</span>(censored <span class="sc">==</span> <span class="dv">1</span>, <span class="st">"yes"</span>, <span class="st">"no"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb60-244"><a href="#cb60-244" aria-hidden="true" tabindex="-1"></a>    distinct</span>
<span id="cb60-245"><a href="#cb60-245" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb60-246"><a href="#cb60-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-247"><a href="#cb60-247" aria-hidden="true" tabindex="-1"></a>As there is no transition before 7, we set duration to 6 for durations lower than 7.</span>
<span id="cb60-248"><a href="#cb60-248" aria-hidden="true" tabindex="-1"></a>We then construct a table containing for each period the number of</span>
<span id="cb60-249"><a href="#cb60-249" aria-hidden="true" tabindex="-1"></a>events and the number of censored spells; we first count the occurrence of any duration-censored combinations, we then pivot the tibble in order to have one line for each duration and two columns for the number of events (<span class="in">`"no"`</span>) and the number of censored observations (<span class="in">`"yes"`</span>) for which we give finally more relevant names.</span>
<span id="cb60-250"><a href="#cb60-250" aria-hidden="true" tabindex="-1"></a>\idxfun{mutate}{dplyr}\idxfun{ifelse}{base}\idxfun{count}{dplyr}\idxfun{pivot<span class="sc">\_</span>wider}{tidyr}\idxfun{rename}{dplyr}</span>
<span id="cb60-251"><a href="#cb60-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-252"><a href="#cb60-252" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb60-253"><a href="#cb60-253" aria-hidden="true" tabindex="-1"></a>ret_tbl <span class="ot">&lt;-</span> ret <span class="sc">%&gt;%</span> </span>
<span id="cb60-254"><a href="#cb60-254" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">duration =</span> <span class="fu">ifelse</span>(duration <span class="sc">&lt;</span> <span class="dv">7</span>, <span class="dv">6</span>, duration)) <span class="sc">%&gt;%</span> </span>
<span id="cb60-255"><a href="#cb60-255" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(duration, censored) <span class="sc">%&gt;%</span> </span>
<span id="cb60-256"><a href="#cb60-256" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> censored, <span class="at">values_from =</span> n, <span class="at">values_fill =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb60-257"><a href="#cb60-257" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">event =</span> no, <span class="at">censored =</span> yes)</span>
<span id="cb60-258"><a href="#cb60-258" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb60-259"><a href="#cb60-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-260"><a href="#cb60-260" aria-hidden="true" tabindex="-1"></a>\newpage</span>
<span id="cb60-261"><a href="#cb60-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-262"><a href="#cb60-262" aria-hidden="true" tabindex="-1"></a>For each discrete time, we define the cumulative number of spells that exit the</span>
<span id="cb60-263"><a href="#cb60-263" aria-hidden="true" tabindex="-1"></a>sample <span class="in">`cumn`</span>, either because of transition or censoring. The number of observations at-risk just before $t_j$ is equal to the total</span>
<span id="cb60-264"><a href="#cb60-264" aria-hidden="true" tabindex="-1"></a>sample size minus the lag of <span class="in">`cumn`</span>:</span>
<span id="cb60-265"><a href="#cb60-265" aria-hidden="true" tabindex="-1"></a>\idxfun{mutate}{dplyr}\idxfun{cumsum}{base}\idxfun{ifelse}{base}\idxfun{lag}{dplyr}</span>
<span id="cb60-266"><a href="#cb60-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-267"><a href="#cb60-267" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb60-268"><a href="#cb60-268" aria-hidden="true" tabindex="-1"></a>ret_tbl <span class="ot">&lt;-</span> ret_tbl <span class="sc">%&gt;%</span></span>
<span id="cb60-269"><a href="#cb60-269" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">cumn =</span> <span class="fu">cumsum</span>(event <span class="sc">+</span> censored),</span>
<span id="cb60-270"><a href="#cb60-270" aria-hidden="true" tabindex="-1"></a>           <span class="at">atrisk =</span> <span class="fu">ifelse</span>(duration <span class="sc">==</span> <span class="dv">6</span>, <span class="dv">243</span>, <span class="dv">243</span> <span class="sc">-</span> <span class="fu">lag</span>(cumn)))</span>
<span id="cb60-271"><a href="#cb60-271" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb60-272"><a href="#cb60-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-273"><a href="#cb60-273" aria-hidden="true" tabindex="-1"></a>Finally, we compute the hazard $\hat{\theta}_j$ as the ratio of the number of events at $t_j$ and the</span>
<span id="cb60-274"><a href="#cb60-274" aria-hidden="true" tabindex="-1"></a>number of observations at risk just before $t_j$ and the survival $\hat{S}_j$ as the</span>
<span id="cb60-275"><a href="#cb60-275" aria-hidden="true" tabindex="-1"></a>cumulative product of $(1 -\hat{\theta}_j)$.</span>
<span id="cb60-276"><a href="#cb60-276" aria-hidden="true" tabindex="-1"></a>\idxfun{mutate}{dplyr}\idxfun{cumprod}{base}</span>
<span id="cb60-277"><a href="#cb60-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-278"><a href="#cb60-278" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb60-279"><a href="#cb60-279" aria-hidden="true" tabindex="-1"></a>ret_tbl <span class="sc">%&gt;%</span></span>
<span id="cb60-280"><a href="#cb60-280" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">hazard =</span> event <span class="sc">/</span> atrisk,</span>
<span id="cb60-281"><a href="#cb60-281" aria-hidden="true" tabindex="-1"></a>           <span class="at">surv =</span> <span class="fu">cumprod</span>(<span class="dv">1</span> <span class="sc">-</span> hazard))</span>
<span id="cb60-282"><a href="#cb60-282" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb60-283"><a href="#cb60-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-284"><a href="#cb60-284" aria-hidden="true" tabindex="-1"></a>The same results are easily obtained using <span class="in">`survfit`</span>. Once again, a</span>
<span id="cb60-285"><a href="#cb60-285" aria-hidden="true" tabindex="-1"></a>formula-data interface is used, the response being a <span class="in">`Surv`</span> object. In</span>
<span id="cb60-286"><a href="#cb60-286" aria-hidden="true" tabindex="-1"></a>the context of a sample with right-censored observations, this object is</span>
<span id="cb60-287"><a href="#cb60-287" aria-hidden="true" tabindex="-1"></a>obtained using the <span class="in">`Surv`</span> function with two arguments:</span>
<span id="cb60-288"><a href="#cb60-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-289"><a href="#cb60-289" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`time`</span> : the duration (observed or right-censored),</span>
<span id="cb60-290"><a href="#cb60-290" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`event`</span> : a dummy for observed duration (i.e., uncensored</span>
<span id="cb60-291"><a href="#cb60-291" aria-hidden="true" tabindex="-1"></a>    observations). It can be either a boolean, 0/1 or</span>
<span id="cb60-292"><a href="#cb60-292" aria-hidden="true" tabindex="-1"></a>    1/2.</span>
<span id="cb60-293"><a href="#cb60-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-294"><a href="#cb60-294" aria-hidden="true" tabindex="-1"></a>If the <span class="in">`Surv`</span> function is used with two unnamed arguments, it is assumed</span>
<span id="cb60-295"><a href="#cb60-295" aria-hidden="true" tabindex="-1"></a>that these two arguments are <span class="in">`time`</span> and <span class="in">`event`</span> in that order.</span>
<span id="cb60-296"><a href="#cb60-296" aria-hidden="true" tabindex="-1"></a>We use in our example a boolean obtained from the <span class="in">`cens`</span> variable:</span>
<span id="cb60-297"><a href="#cb60-297" aria-hidden="true" tabindex="-1"></a>\idxfun{survfit}{survival}\idxfun{Surv}{survival}\idxfun{tidy}{broom}\idxfun{slice}{dplyr}</span>
<span id="cb60-298"><a href="#cb60-298" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">)</span><span class="co">]</span>{retirement}{micsr.data}</span>
<span id="cb60-299"><a href="#cb60-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-300"><a href="#cb60-300" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb60-301"><a href="#cb60-301" aria-hidden="true" tabindex="-1"></a>surv_ret <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(duration, censored <span class="sc">==</span> <span class="st">"no"</span>) <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> ret)</span>
<span id="cb60-302"><a href="#cb60-302" aria-hidden="true" tabindex="-1"></a>broom<span class="sc">::</span><span class="fu">tidy</span>(surv_ret) <span class="sc">%&gt;%</span> <span class="fu">slice</span>(<span class="sc">-</span> (<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>))</span>
<span id="cb60-303"><a href="#cb60-303" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb60-304"><a href="#cb60-304" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{Kaplan-Meier estimator!censored sample|)}</span>
<span id="cb60-305"><a href="#cb60-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-306"><a href="#cb60-306" aria-hidden="true" tabindex="-1"></a><span class="fu">### Different groups</span></span>
<span id="cb60-307"><a href="#cb60-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-308"><a href="#cb60-308" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{Kaplan-Meier estimator!different groups|(}</span>
<span id="cb60-309"><a href="#cb60-309" aria-hidden="true" tabindex="-1"></a>When the observations belong to two or more groups, the survival curves</span>
<span id="cb60-310"><a href="#cb60-310" aria-hidden="true" tabindex="-1"></a>can be estimated for each group. </span>
<span id="cb60-311"><a href="#cb60-311" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- We now use the `recall` data set, initially used by @KATZ:86 and latter by @SUEY:95. It contains 1045 spells of unemployment from 1980.  --&gt;</span></span>
<span id="cb60-312"><a href="#cb60-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-313"><a href="#cb60-313" aria-hidden="true" tabindex="-1"></a>We now use the <span class="in">`unemp_teachers`</span> data set, initially used by @KAST:VAND:22\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Kastoryano}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{van der Klaauw}. It contains 3064 observations of unemployed Dutch teachers. Some of them performed a training; they are identified by a dummy called <span class="in">`training`</span>. We restrict the sample to those who didn't perform a training and we measure the duration in years:</span>
<span id="cb60-314"><a href="#cb60-314" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">(</span><span class="co">]</span>{unemp<span class="sc">\_</span>teachers}{micsr.data}</span>
<span id="cb60-315"><a href="#cb60-315" aria-hidden="true" tabindex="-1"></a>\idxfun{filter}{dplyr}\idxfun{select}{dplyr}\idxfun{mutate}{dplyr}\idxfun{head}{utils}</span>
<span id="cb60-316"><a href="#cb60-316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-319"><a href="#cb60-319" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb60-320"><a href="#cb60-320" aria-hidden="true" tabindex="-1"></a>unteach <span class="ot">&lt;-</span> unemp_teachers <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span> training) <span class="sc">%&gt;%</span> </span>
<span id="cb60-321"><a href="#cb60-321" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span> training, <span class="sc">-</span> time_training) <span class="sc">%&gt;%</span> </span>
<span id="cb60-322"><a href="#cb60-322" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">time =</span> time <span class="sc">/</span> <span class="fl">365.25</span>)</span>
<span id="cb60-323"><a href="#cb60-323" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(unteach, <span class="dv">3</span>)</span>
<span id="cb60-324"><a href="#cb60-324" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb60-325"><a href="#cb60-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-326"><a href="#cb60-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-327"><a href="#cb60-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-328"><a href="#cb60-328" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ```{r} --&gt;</span></span>
<span id="cb60-329"><a href="#cb60-329" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- recall %&gt;% head(3) --&gt;</span></span>
<span id="cb60-330"><a href="#cb60-330" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ``` --&gt;</span></span>
<span id="cb60-331"><a href="#cb60-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-332"><a href="#cb60-332" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- The analysis of @KATZ:86 showed that an important transition from unemployment was a recall from the previous employer. The `end` covariate indicates the different modalities of transition: --&gt;</span></span>
<span id="cb60-333"><a href="#cb60-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-334"><a href="#cb60-334" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ```{r} --&gt;</span></span>
<span id="cb60-335"><a href="#cb60-335" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- recall %&gt;% count(end) --&gt;</span></span>
<span id="cb60-336"><a href="#cb60-336" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ``` --&gt;</span></span>
<span id="cb60-337"><a href="#cb60-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-338"><a href="#cb60-338" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- We consider the `new-job` and `recall` modalities as an indication of a complete spell and we use `survfit` with a factor and not an intercept as previously. More precisely, we use the `race` covariate to analyze wheter the survival function differ between whites and non-whites. --&gt;</span></span>
<span id="cb60-339"><a href="#cb60-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-340"><a href="#cb60-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-341"><a href="#cb60-341" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- We now use the `unemp_duration` data set used by @WICH:WILK:08 who analyzed unemployment duration (in days) in Germany, for 21775 unemployment spells that started in 1996 and 1997 in West Germany: --&gt;</span></span>
<span id="cb60-342"><a href="#cb60-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-343"><a href="#cb60-343" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ```{r} --&gt;</span></span>
<span id="cb60-344"><a href="#cb60-344" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- unemp_duration %&gt;% print(n = 3) --&gt;</span></span>
<span id="cb60-345"><a href="#cb60-345" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ``` --&gt;</span></span>
<span id="cb60-346"><a href="#cb60-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-347"><a href="#cb60-347" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- `wage` is the last daily wage before unemployment. To fit two survival curves for males and females, we use `survfit` with  --&gt;</span></span>
<span id="cb60-348"><a href="#cb60-348" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- a formula where the right-hand side is now a factor and not just an intercept: --&gt;</span></span>
<span id="cb60-349"><a href="#cb60-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-350"><a href="#cb60-350" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ```{r} --&gt;</span></span>
<span id="cb60-351"><a href="#cb60-351" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- survfit_sex &lt;- survfit(Surv(duration, censored == "no") ~ gender,  --&gt;</span></span>
<span id="cb60-352"><a href="#cb60-352" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--                        unemp_duration) --&gt;</span></span>
<span id="cb60-353"><a href="#cb60-353" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- broom::tidy(survfit_sex) %&gt;% print(n = 3) --&gt;</span></span>
<span id="cb60-354"><a href="#cb60-354" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ``` --&gt;</span></span>
<span id="cb60-355"><a href="#cb60-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-356"><a href="#cb60-356" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ```{r} --&gt;</span></span>
<span id="cb60-357"><a href="#cb60-357" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- survfit_race &lt;- survfit(Surv(duration,  --&gt;</span></span>
<span id="cb60-358"><a href="#cb60-358" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--                              end %in% c("new-job", "recall")) ~ race, recall) --&gt;</span></span>
<span id="cb60-359"><a href="#cb60-359" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- broom::tidy(survfit_race) %&gt;% print(n = 3) --&gt;</span></span>
<span id="cb60-360"><a href="#cb60-360" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ``` --&gt;</span></span>
<span id="cb60-361"><a href="#cb60-361" aria-hidden="true" tabindex="-1"></a>\idxfun{tidy}{broom}\idxfun{ggplot}{ggplot2}\idxfun{aes}{ggplot2}\idxfun{geom<span class="sc">\_</span>line}{ggplot2}</span>
<span id="cb60-362"><a href="#cb60-362" aria-hidden="true" tabindex="-1"></a>\idxfun{scale<span class="sc">\_</span>y<span class="sc">\_</span>continuous}{ggplot2}</span>
<span id="cb60-363"><a href="#cb60-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-366"><a href="#cb60-366" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb60-367"><a href="#cb60-367" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb60-368"><a href="#cb60-368" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb60-369"><a href="#cb60-369" aria-hidden="true" tabindex="-1"></a><span class="co"># survfit_race %&gt;% tidy %&gt;% </span></span>
<span id="cb60-370"><a href="#cb60-370" aria-hidden="true" tabindex="-1"></a><span class="co">#   ggplot(aes(time, estimate)) + geom_line(aes(linetype = strata)) + </span></span>
<span id="cb60-371"><a href="#cb60-371" aria-hidden="true" tabindex="-1"></a><span class="co">#   scale_y_continuous(trans = "log")</span></span>
<span id="cb60-372"><a href="#cb60-372" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb60-373"><a href="#cb60-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-374"><a href="#cb60-374" aria-hidden="true" tabindex="-1"></a>We use <span class="in">`survfit`</span>, this time with a factor, more precisely the gender factor to compute separate survival curves for males and females:</span>
<span id="cb60-375"><a href="#cb60-375" aria-hidden="true" tabindex="-1"></a>\idxfun{survfit}{survival}\idxfun{Surv}{survival}\idxfun{tidy}{broom}</span>
<span id="cb60-376"><a href="#cb60-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-379"><a href="#cb60-379" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb60-380"><a href="#cb60-380" aria-hidden="true" tabindex="-1"></a>survfit_gender <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(time, spell) <span class="sc">~</span> gender, unteach)</span>
<span id="cb60-381"><a href="#cb60-381" aria-hidden="true" tabindex="-1"></a>broom<span class="sc">::</span><span class="fu">tidy</span>(survfit_gender) <span class="sc">%&gt;%</span> <span class="fu">print</span>(<span class="at">n =</span> <span class="dv">3</span>)</span>
<span id="cb60-382"><a href="#cb60-382" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb60-383"><a href="#cb60-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-384"><a href="#cb60-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-385"><a href="#cb60-385" aria-hidden="true" tabindex="-1"></a>The **survminer** package provides the **ggsurvplot** function, based on **ggplot2**, which enables to draw nice and highly customizable survival curves, as in @fig-survival_curve where we set the <span class="in">`risk.table`</span> argument to <span class="in">`TRUE`</span> in order to have a table of observations at risk just below the figure.</span>
<span id="cb60-386"><a href="#cb60-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-387"><a href="#cb60-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-388"><a href="#cb60-388" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ```{r} --&gt;</span></span>
<span id="cb60-389"><a href="#cb60-389" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #| label: fig-survival_curve --&gt;</span></span>
<span id="cb60-390"><a href="#cb60-390" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #| fig-cap: "Survival curves for unemployment duration in the United States" --&gt;</span></span>
<span id="cb60-391"><a href="#cb60-391" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #| fig-width: 8 --&gt;</span></span>
<span id="cb60-392"><a href="#cb60-392" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #| fig-height: 8 --&gt;</span></span>
<span id="cb60-393"><a href="#cb60-393" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- survminer::ggsurvplot(survfit_race, risk.table = TRUE, conf.int = TRUE) --&gt;</span></span>
<span id="cb60-394"><a href="#cb60-394" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ``` --&gt;</span></span>
<span id="cb60-395"><a href="#cb60-395" aria-hidden="true" tabindex="-1"></a>\idxfun{ggsurvplot}{survminer}</span>
<span id="cb60-396"><a href="#cb60-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-397"><a href="#cb60-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-400"><a href="#cb60-400" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb60-401"><a href="#cb60-401" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-survival_curve</span></span>
<span id="cb60-402"><a href="#cb60-402" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Survival curves for unemployment duration in the United States"</span></span>
<span id="cb60-403"><a href="#cb60-403" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 8</span></span>
<span id="cb60-404"><a href="#cb60-404" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 8</span></span>
<span id="cb60-405"><a href="#cb60-405" aria-hidden="true" tabindex="-1"></a>survminer<span class="sc">::</span><span class="fu">ggsurvplot</span>(survfit_gender, <span class="at">risk.table =</span> <span class="cn">TRUE</span>, <span class="at">conf.int =</span> <span class="cn">TRUE</span>)</span>
<span id="cb60-406"><a href="#cb60-406" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb60-407"><a href="#cb60-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-408"><a href="#cb60-408" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{log-rank test}</span>
<span id="cb60-409"><a href="#cb60-409" aria-hidden="true" tabindex="-1"></a>The hypothesis of identical survival curves can be tested using a</span>
<span id="cb60-410"><a href="#cb60-410" aria-hidden="true" tabindex="-1"></a>log-rank test. Denoting $d_{tg}$ and $r_{tg}$ as the number of failures and</span>
<span id="cb60-411"><a href="#cb60-411" aria-hidden="true" tabindex="-1"></a>the number of observations at risk for the $t$^th^ duration and the</span>
<span id="cb60-412"><a href="#cb60-412" aria-hidden="true" tabindex="-1"></a>g^th^ group, under the hypothesis of identical survival curves, the</span>
<span id="cb60-413"><a href="#cb60-413" aria-hidden="true" tabindex="-1"></a>fitted number of failures is:</span>
<span id="cb60-414"><a href="#cb60-414" aria-hidden="true" tabindex="-1"></a>$$\hat{d}_{tg}=\frac{d_{t1} + d_{t2}}{r_{t1} + r_{t2}} r_{tg}$$</span>
<span id="cb60-415"><a href="#cb60-415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-416"><a href="#cb60-416" aria-hidden="true" tabindex="-1"></a>The test statistic is based on $\sum_t (d_{tg} - \hat{d}_{tg})$. Note</span>
<span id="cb60-417"><a href="#cb60-417" aria-hidden="true" tabindex="-1"></a>that the value for the second group is necessarily the opposite of the one</span>
<span id="cb60-418"><a href="#cb60-418" aria-hidden="true" tabindex="-1"></a>for the first group.</span>
<span id="cb60-419"><a href="#cb60-419" aria-hidden="true" tabindex="-1"></a>The variance of this statistic is:</span>
<span id="cb60-420"><a href="#cb60-420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-421"><a href="#cb60-421" aria-hidden="true" tabindex="-1"></a>$$V = \frac{r_{t1}r_{t2}(r_t - d_t) d_t}{r_t^2(r_t-1)}$$</span>
<span id="cb60-422"><a href="#cb60-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-423"><a href="#cb60-423" aria-hidden="true" tabindex="-1"></a>The statistic is then</span>
<span id="cb60-424"><a href="#cb60-424" aria-hidden="true" tabindex="-1"></a>$\left(\sum_t (d_{tg} - \hat{d}_{tg})\right) ^ 2 / V$ and is $\chi ^ 2$</span>
<span id="cb60-425"><a href="#cb60-425" aria-hidden="true" tabindex="-1"></a>with 1 degree of freedom under the hypothesis of same survival.</span>
<span id="cb60-426"><a href="#cb60-426" aria-hidden="true" tabindex="-1"></a>This test can be computed using the <span class="in">`survival::surfdiff`</span> function, with the same syntax as the one used for <span class="in">`survfit`</span>:</span>
<span id="cb60-427"><a href="#cb60-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-428"><a href="#cb60-428" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ```{r} --&gt;</span></span>
<span id="cb60-429"><a href="#cb60-429" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- survdiff(Surv(duration, censored == "no") ~ gender, unemp_duration) --&gt;</span></span>
<span id="cb60-430"><a href="#cb60-430" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ``` --&gt;</span></span>
<span id="cb60-431"><a href="#cb60-431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-432"><a href="#cb60-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-433"><a href="#cb60-433" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ```{r} --&gt;</span></span>
<span id="cb60-434"><a href="#cb60-434" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- survdiff(Surv(duration, end %in% c("new-job", "recall")) ~ race, recall) --&gt;</span></span>
<span id="cb60-435"><a href="#cb60-435" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ``` --&gt;</span></span>
<span id="cb60-436"><a href="#cb60-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-437"><a href="#cb60-437" aria-hidden="true" tabindex="-1"></a>\idxfun{survdiff}{survival}\idxfun{Surv}{survival}</span>
<span id="cb60-438"><a href="#cb60-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-441"><a href="#cb60-441" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb60-442"><a href="#cb60-442" aria-hidden="true" tabindex="-1"></a><span class="fu">survdiff</span>(<span class="fu">Surv</span>(time, spell) <span class="sc">~</span> gender, unteach)</span>
<span id="cb60-443"><a href="#cb60-443" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb60-444"><a href="#cb60-444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-445"><a href="#cb60-445" aria-hidden="true" tabindex="-1"></a>The hypothesis of identical survival for males and females is highly rejected.</span>
<span id="cb60-446"><a href="#cb60-446" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- The hypothesis of identical survival for whites and non-whites is highly rejected. --&gt;</span></span>
<span id="cb60-447"><a href="#cb60-447" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{Kaplan-Meier estimator!different groups|)}</span>
<span id="cb60-448"><a href="#cb60-448" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">)</span><span class="co">]</span>{unemp<span class="sc">\_</span>teachers}{micsr.data}</span>
<span id="cb60-449"><a href="#cb60-449" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{Kaplan-Meier estimator|)}</span>
<span id="cb60-450"><a href="#cb60-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-451"><a href="#cb60-451" aria-hidden="true" tabindex="-1"></a><span class="fu">## Parametric and semi-parametric estimators {#sec-param_duration}</span></span>
<span id="cb60-452"><a href="#cb60-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-453"><a href="#cb60-453" aria-hidden="true" tabindex="-1"></a>In this section, we introduce covariates that may explain the length of the duration, or the value of the hazard function. Two kinds of models can be developed. The full parametric model specifies the whole distribution of the hazard function. On the contrary, in a semi-parametric approach, the hazard is the product of two component, the first depending on time and some parameters and the second depending only on the covariates and some other parameters. Then, only the second component is estimated, and therefore, the shape of the hazard doesn't need to be specified. We'll first consider the benchmark exponential model, for which the hazard is constant.^<span class="co">[</span><span class="ot">This section relies heavily on @LANC:90. pp. 17-20.\index[author]{Lancaster}</span><span class="co">]</span></span>
<span id="cb60-454"><a href="#cb60-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-455"><a href="#cb60-455" aria-hidden="true" tabindex="-1"></a><span class="fu">### Constant hazard and the exponential distribution</span></span>
<span id="cb60-456"><a href="#cb60-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-457"><a href="#cb60-457" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{exponential distribution|(}</span>
<span id="cb60-458"><a href="#cb60-458" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{exponential model|(}</span>
<span id="cb60-459"><a href="#cb60-459" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{hazard function!constant|(}</span>
<span id="cb60-460"><a href="#cb60-460" aria-hidden="true" tabindex="-1"></a>Consider the special case where the hazard is a constant $\theta$. From @eq-cummulative_hazard, the cumulative hazard is then: $\Lambda(t) = \int_0 ^ {t} \theta ds = \theta t = - \ln S(t)$. The survival function is then $S(t) = e^{-\theta t}$ and the opposite of its</span>
<span id="cb60-461"><a href="#cb60-461" aria-hidden="true" tabindex="-1"></a>derivative is the density function $f(t) = \theta e ^ {-\theta t}$.</span>
<span id="cb60-462"><a href="#cb60-462" aria-hidden="true" tabindex="-1"></a>Therefore, if the hazard is constant, the distribution of $T$ is the</span>
<span id="cb60-463"><a href="#cb60-463" aria-hidden="true" tabindex="-1"></a>exponential distribution with parameter $\theta$, which will be denoted by:</span>
<span id="cb60-464"><a href="#cb60-464" aria-hidden="true" tabindex="-1"></a>$T \sim E (\theta)$.</span>
<span id="cb60-465"><a href="#cb60-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-466"><a href="#cb60-466" aria-hidden="true" tabindex="-1"></a>The **moment generating function** of $T$ for the exponential distribution is:</span>
<span id="cb60-467"><a href="#cb60-467" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{moment generating function}</span>
<span id="cb60-468"><a href="#cb60-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-469"><a href="#cb60-469" aria-hidden="true" tabindex="-1"></a>$$M(s) = \mbox{E}\left(e^{sT}\right) = \int_0 ^ {+\infty}e^{st}\theta e^{-\theta t} dt =  \frac{\theta}{\theta - s}$$</span>
<span id="cb60-470"><a href="#cb60-470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-471"><a href="#cb60-471" aria-hidden="true" tabindex="-1"></a>for $\theta &gt; s$. The **cumulant generating function** is the logarithm</span>
<span id="cb60-472"><a href="#cb60-472" aria-hidden="true" tabindex="-1"></a>of the moment generating function:\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{cumulant generating function}</span>
<span id="cb60-473"><a href="#cb60-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-474"><a href="#cb60-474" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-475"><a href="#cb60-475" aria-hidden="true" tabindex="-1"></a>K(s) =\ln M(s) = \ln \theta - \ln(\theta - s)</span>
<span id="cb60-476"><a href="#cb60-476" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-477"><a href="#cb60-477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-478"><a href="#cb60-478" aria-hidden="true" tabindex="-1"></a>and the limit for $s\rightarrow 0$ of its first two derivatives with</span>
<span id="cb60-479"><a href="#cb60-479" aria-hidden="true" tabindex="-1"></a>respect to $s$ are the expected value and the variance of $T$.</span>
<span id="cb60-480"><a href="#cb60-480" aria-hidden="true" tabindex="-1"></a>Therefore, $\mbox{E}(T)= \frac{1}{\theta}$ and</span>
<span id="cb60-481"><a href="#cb60-481" aria-hidden="true" tabindex="-1"></a>$\mbox{V}(T) = \frac{1}{\theta ^ 2}$. Therefore, for the exponential distribution, the mean equals the standard deviation. Moreover, the unit of measurement of $\theta$ is the inverse of the time unit, so that $\theta dt$ is a number without units.</span>
<span id="cb60-482"><a href="#cb60-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-483"><a href="#cb60-483" aria-hidden="true" tabindex="-1"></a>Denote $Z=\int_0 ^ T \theta(s) ds$ as the cumulative hazard. This is a</span>
<span id="cb60-484"><a href="#cb60-484" aria-hidden="true" tabindex="-1"></a>transformation of the time-scale such that</span>
<span id="cb60-485"><a href="#cb60-485" aria-hidden="true" tabindex="-1"></a>$dZ = \frac{\partial Z}{\partial T} dT = \theta(T) dT$. With constant</span>
<span id="cb60-486"><a href="#cb60-486" aria-hidden="true" tabindex="-1"></a>hazard, $Z$ is simply proportional to $T$, as $dZ = \theta dT$, and the cumulative hazard is then $\theta T$. For example, if the constant hazard is 0.1 and the time is measured in days, a variation of 1 in the initial time scale (1 day) corresponds to a variation of 0.1 on the transformed time scale.</span>
<span id="cb60-487"><a href="#cb60-487" aria-hidden="true" tabindex="-1"></a>As the hazard is positive, we have:\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{constant hazard hypothesis}</span>
<span id="cb60-488"><a href="#cb60-488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-489"><a href="#cb60-489" aria-hidden="true" tabindex="-1"></a>$$ \mbox{P}(T \geq t) = \mbox{P}\left(\int_0 ^ T \theta(s) ds \geq</span>
<span id="cb60-490"><a href="#cb60-490" aria-hidden="true" tabindex="-1"></a>\int_0 ^ t \theta(s) ds\right) = \mbox{P}(Z \geq z) $$</span>
<span id="cb60-491"><a href="#cb60-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-492"><a href="#cb60-492" aria-hidden="true" tabindex="-1"></a>As $\mbox{P}(T \geq t) = e^ {-\int_0 ^ t \theta(s) ds}$, we finally get:</span>
<span id="cb60-493"><a href="#cb60-493" aria-hidden="true" tabindex="-1"></a>$\mbox{P}(Z \geq z) = e ^ {-z}$, which means that $Z$, the cumulative</span>
<span id="cb60-494"><a href="#cb60-494" aria-hidden="true" tabindex="-1"></a>hazard, is a unit exponential random variable: $Z \sim E(1)$.</span>
<span id="cb60-495"><a href="#cb60-495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-496"><a href="#cb60-496" aria-hidden="true" tabindex="-1"></a>Finally, consider the moment generating function of $\ln T$ with</span>
<span id="cb60-497"><a href="#cb60-497" aria-hidden="true" tabindex="-1"></a>$T \sim E(\theta)$:</span>
<span id="cb60-498"><a href="#cb60-498" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{moment generating function}</span>
<span id="cb60-499"><a href="#cb60-499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-500"><a href="#cb60-500" aria-hidden="true" tabindex="-1"></a>$$M(s)_{\ln T} = \mbox{E}\left( e ^ {s\ln T}\right) = \mbox{E}\left(T ^ s\right) = \int_0^{+\infty}t ^ s \theta e ^ {-\theta t}dt = \frac{\Gamma (1 + s)}{\theta ^ s}$$</span>
<span id="cb60-501"><a href="#cb60-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-502"><a href="#cb60-502" aria-hidden="true" tabindex="-1"></a>with $\Gamma(z) = \int_0^{+\infty}t^{z-1}e^{-t}dt$  the Gamma</span>
<span id="cb60-503"><a href="#cb60-503" aria-hidden="true" tabindex="-1"></a>function\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{Gamma function}. The corresponding cumulant generating function is:</span>
<span id="cb60-504"><a href="#cb60-504" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{cumulant generating function}</span>
<span id="cb60-505"><a href="#cb60-505" aria-hidden="true" tabindex="-1"></a>$K(s)_{\ln T} = \ln \Gamma(1 + s) - s\ln \theta$, from which we obtain</span>
<span id="cb60-506"><a href="#cb60-506" aria-hidden="true" tabindex="-1"></a>the expected value $\psi(1) - \ln \theta$ and the variance, $\psi'(1)$,</span>
<span id="cb60-507"><a href="#cb60-507" aria-hidden="true" tabindex="-1"></a>where $\psi$ and $\psi'$ are the first and second derivatives of</span>
<span id="cb60-508"><a href="#cb60-508" aria-hidden="true" tabindex="-1"></a>$\ln \Gamma$. $\psi$ is called the digamma\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{digamma function} function and $\psi(1)=-\gamma$, $\gamma \approx 0.57721$ being the Euler-Mascheronni constant\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{Euler-Mascheronni constant}. $\psi'$ is called the trigamma\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{trigamma function} function and</span>
<span id="cb60-509"><a href="#cb60-509" aria-hidden="true" tabindex="-1"></a>$\psi'(1) = \pi ^ 2 / 6$. As $Z = \theta T \sim E(1)$, the density of $Z$ is $g(Z) = e ^ {-Z}$. Consider now $U = \ln Z$. The density of $U$ is:</span>
<span id="cb60-510"><a href="#cb60-510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-511"><a href="#cb60-511" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-512"><a href="#cb60-512" aria-hidden="true" tabindex="-1"></a>f(U) = e ^ {- e ^ U}\left| \frac{dZ}{dU}\right| =  e ^ {- e ^ U} e ^ U</span>
<span id="cb60-513"><a href="#cb60-513" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-514"><a href="#cb60-514" aria-hidden="true" tabindex="-1"></a>which is the Gumbel distribution, also known as the extreme value distribution of type 1, for which $F(U) = 1 - e^{-e^U}$, $S(U) = e^{-e^U}$, $\mbox{E}(U) = - \gamma$ and $\mbox{V}(U) = \pi ^ 2 / 6$.^<span class="co">[</span><span class="ot">More precisely, this is the Gumbel distribution (minimum); for the Gumbel distribution (maximum), $F(U) = \exp (- \exp (- U))$.</span><span class="co">]</span> As $U = \ln Z = \ln T + \ln \theta$, we can write:</span>
<span id="cb60-515"><a href="#cb60-515" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{extreme value distribution of type 1}</span>
<span id="cb60-516"><a href="#cb60-516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-517"><a href="#cb60-517" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-518"><a href="#cb60-518" aria-hidden="true" tabindex="-1"></a>\ln T = - \ln \theta + U</span>
<span id="cb60-519"><a href="#cb60-519" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-520"><a href="#cb60-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-521"><a href="#cb60-521" aria-hidden="true" tabindex="-1"></a>Now consider that the hazard depends on some covariates and denote $\theta_n$ the value of the hazard for individual $n$. Then we can write the exponential model in the following regression form:</span>
<span id="cb60-522"><a href="#cb60-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-523"><a href="#cb60-523" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-524"><a href="#cb60-524" aria-hidden="true" tabindex="-1"></a>\ln T_n = - \ln \theta_n + U_n = -(\gamma + \ln \theta_n) + (U_n + \gamma) = -(\gamma + \ln \theta_n) + W_n</span>
<span id="cb60-525"><a href="#cb60-525" aria-hidden="true" tabindex="-1"></a>$$ {#eq-duration_regression}</span>
<span id="cb60-526"><a href="#cb60-526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-527"><a href="#cb60-527" aria-hidden="true" tabindex="-1"></a>Then $\mbox{E}(\ln T_n\mid z_n) = -(\gamma +\ln \theta_n)$, $\mbox{E}(W\mid x_n) = 0$ and $\mbox{V}(W\mid x_n) = \pi ^ 2 / 6$. $\theta$ can be parametrized as</span>
<span id="cb60-528"><a href="#cb60-528" aria-hidden="true" tabindex="-1"></a>$e ^ {-\alpha + \beta ^ \top x_n}$, so that $\ln T_n =  (\alpha-\gamma) + \beta^\top x_n + W_n$.</span>
<span id="cb60-529"><a href="#cb60-529" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{exponential distribution|)}</span>
<span id="cb60-530"><a href="#cb60-530" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{exponential model|)}</span>
<span id="cb60-531"><a href="#cb60-531" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{hazard function!constant|)}</span>
<span id="cb60-532"><a href="#cb60-532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-533"><a href="#cb60-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-534"><a href="#cb60-534" aria-hidden="true" tabindex="-1"></a><span class="fu">### Estimation</span></span>
<span id="cb60-535"><a href="#cb60-535" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-536"><a href="#cb60-536" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{maximum likelihood estimator!exponential model|(}</span>
<span id="cb60-537"><a href="#cb60-537" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{exponential model!maximum likelihood estimator|(}</span>
<span id="cb60-538"><a href="#cb60-538" aria-hidden="true" tabindex="-1"></a>Duration models are estimated by maximum likelihood. For censored observations, the contribution to the likelihood is the probability of surviving at the censoring time, which is $S(t_n \mid x_n)$. For uncensored observations, this is the density function: $f(t_n \mid x_n)$. Therefore, denoting $d_n$ a dummy for complete (uncensored) observations, we get:</span>
<span id="cb60-539"><a href="#cb60-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-540"><a href="#cb60-540" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-541"><a href="#cb60-541" aria-hidden="true" tabindex="-1"></a>\ln L = \sum_{n=1} ^ N \left<span class="co">[</span><span class="ot">d_n \ln f(t_n \mid x_n) + (1 - d_n) \ln S(t_n \mid x_n)\right</span><span class="co">]</span></span>
<span id="cb60-542"><a href="#cb60-542" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-543"><a href="#cb60-543" aria-hidden="true" tabindex="-1"></a>The log-likelihood function can also be expressed in terms of the hazard function, as $\theta_n = f_n / S_n$:</span>
<span id="cb60-544"><a href="#cb60-544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-545"><a href="#cb60-545" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-546"><a href="#cb60-546" aria-hidden="true" tabindex="-1"></a>\ln L = \sum_{n=1} ^ N \left<span class="co">[</span><span class="ot">d_n \ln \theta(t_n \mid x_n) + \ln S(t_n \mid x_n)\right</span><span class="co">]</span></span>
<span id="cb60-547"><a href="#cb60-547" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-548"><a href="#cb60-548" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{maximum likelihood estimator!exponential model|)}</span>
<span id="cb60-549"><a href="#cb60-549" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{exponential model!maximum likelihood estimator|)}</span>
<span id="cb60-550"><a href="#cb60-550" aria-hidden="true" tabindex="-1"></a>If there are no censored observations and if the distribution of time is exponential, @eq-duration_regression can be estimated by least squares, which will be consistent, although inefficient.</span>
<span id="cb60-551"><a href="#cb60-551" aria-hidden="true" tabindex="-1"></a>The <span class="in">`oil`</span> data set doesn't have censored observations. Therefore, OLS estimation is consistent, even if it is less efficient than maximum likelihood if the distribution is really exponential. We estimated a model by maximum likelihood in @sec-ml_est_expon, with <span class="in">`p98`</span> and <span class="in">`varp98`</span> as covariates. We reproduce this estimation using <span class="in">`surveg`</span> and we compare the results with those obtained using <span class="in">`lm`</span>. The <span class="in">`survreg`</span> function has a <span class="in">`dist`</span> argument that we set to <span class="in">`"exponential"`</span>. The response should be generated using the <span class="in">`Surv`</span> function, with the duration as the only argument in this example, as all the observations are uncensored:</span>
<span id="cb60-552"><a href="#cb60-552" aria-hidden="true" tabindex="-1"></a>\idxdata{oil}{micsr.data}</span>
<span id="cb60-553"><a href="#cb60-553" aria-hidden="true" tabindex="-1"></a>\idxfun{survreg}{survival}\idxfun{Surv}{survival}\idxfun{lm}{stats}\idxfun{gaze}{micsr}</span>
<span id="cb60-554"><a href="#cb60-554" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-557"><a href="#cb60-557" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb60-558"><a href="#cb60-558" aria-hidden="true" tabindex="-1"></a><span class="fu">survreg</span>(<span class="fu">Surv</span>(dur) <span class="sc">~</span> p98 <span class="sc">+</span> varp98, oil, <span class="at">dist =</span> <span class="st">"exponential"</span>) <span class="sc">%&gt;%</span> summary</span>
<span id="cb60-559"><a href="#cb60-559" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(<span class="fu">log</span>(dur) <span class="sc">~</span> p98 <span class="sc">+</span> varp98, oil) <span class="sc">%&gt;%</span> gaze</span>
<span id="cb60-560"><a href="#cb60-560" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb60-561"><a href="#cb60-561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-562"><a href="#cb60-562" aria-hidden="true" tabindex="-1"></a>As expected, the two sets of slopes are rather close, but the ML estimator doesn't seem to be more efficient in this example.</span>
<span id="cb60-563"><a href="#cb60-563" aria-hidden="true" tabindex="-1"></a>$\beta_k$ is the derivative of  $\ln T_n$ with $x_{nk}$, so that $d T_n / T_n = \beta_k dx_{nk}$. Moreover, $d \theta_n / \theta_n = -\beta_k dx_{nk}$.</span>
<span id="cb60-564"><a href="#cb60-564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-565"><a href="#cb60-565" aria-hidden="true" tabindex="-1"></a>We then estimate the model for unemployment duration of Dutch teachers using as covariates the age, gender and (in log) last hourly wage:</span>
<span id="cb60-566"><a href="#cb60-566" aria-hidden="true" tabindex="-1"></a>\idxfun{survreg}{survival}\idxfun{Surv}{survival}\idxfun{coef}{stats}</span>
<span id="cb60-567"><a href="#cb60-567" aria-hidden="true" tabindex="-1"></a>\idxdata{unemp<span class="sc">\_</span>teachers}{micsr.data}</span>
<span id="cb60-568"><a href="#cb60-568" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-571"><a href="#cb60-571" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb60-572"><a href="#cb60-572" aria-hidden="true" tabindex="-1"></a>un_exp <span class="ot">&lt;-</span> <span class="fu">survreg</span>(<span class="fu">Surv</span>(time, spell) <span class="sc">~</span> age <span class="sc">+</span> gender <span class="sc">+</span> <span class="fu">log</span>(wage),</span>
<span id="cb60-573"><a href="#cb60-573" aria-hidden="true" tabindex="-1"></a>                  unteach, <span class="at">dist =</span> <span class="st">"exponential"</span>)</span>
<span id="cb60-574"><a href="#cb60-574" aria-hidden="true" tabindex="-1"></a><span class="fu">coef</span>(un_exp)</span>
<span id="cb60-575"><a href="#cb60-575" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb60-576"><a href="#cb60-576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-577"><a href="#cb60-577" aria-hidden="true" tabindex="-1"></a>The results indicate that male unemployment spell duration are <span class="in">`r round(coef(un_exp)["gendermale"] * 100)`</span>% longer than those for females. One more year of age increases the length of the spell by <span class="in">`r round(coef(un_exp)["age"] * 100, 2)`</span>%. Finally, 1% of more previous wage increases the duration of the spell by <span class="in">`r round(coef(un_exp)["log(wage)"], 2)`</span>%.</span>
<span id="cb60-578"><a href="#cb60-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-579"><a href="#cb60-579" aria-hidden="true" tabindex="-1"></a><span class="fu">### Accelerated failure time model</span></span>
<span id="cb60-580"><a href="#cb60-580" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-581"><a href="#cb60-581" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{accelerated failure time model|(}</span>
<span id="cb60-582"><a href="#cb60-582" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{accelerated failure time model!exponential model|(}</span>
<span id="cb60-583"><a href="#cb60-583" aria-hidden="true" tabindex="-1"></a>The previous model is a special case of a class of models called</span>
<span id="cb60-584"><a href="#cb60-584" aria-hidden="true" tabindex="-1"></a>**accelerated failure time** (**AFT**), for which the duration can be written</span>
<span id="cb60-585"><a href="#cb60-585" aria-hidden="true" tabindex="-1"></a>as: $T_n = Z / \lambda_n$, $\lambda_n = e ^ {\gamma ^ \top z_n}$, and $Z$ is a random</span>
<span id="cb60-586"><a href="#cb60-586" aria-hidden="true" tabindex="-1"></a>variable that doesn't depend on $\gamma$ and $x_n$. $\lambda_n$</span>
<span id="cb60-587"><a href="#cb60-587" aria-hidden="true" tabindex="-1"></a>therefore has a multiplicative effect on failure time, and failure time</span>
<span id="cb60-588"><a href="#cb60-588" aria-hidden="true" tabindex="-1"></a>is decelerated if $\lambda &lt; 1$ and accelerated if $\lambda &gt; 1$.</span>
<span id="cb60-589"><a href="#cb60-589" aria-hidden="true" tabindex="-1"></a>The exponential model is such a model, with $Z \sim E(1)$, or</span>
<span id="cb60-590"><a href="#cb60-590" aria-hidden="true" tabindex="-1"></a>equivalently $U = \ln Z$ is an extreme value of type-1. Therefore, the AFT models are based on the following specification:</span>
<span id="cb60-591"><a href="#cb60-591" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-592"><a href="#cb60-592" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-593"><a href="#cb60-593" aria-hidden="true" tabindex="-1"></a>\ln T_n = - \ln \lambda_n + U_n</span>
<span id="cb60-594"><a href="#cb60-594" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-595"><a href="#cb60-595" aria-hidden="true" tabindex="-1"></a>where $\lambda_n$ can be parametrized as $e^{-\gamma ^ \top z_n}$, so that $\ln T_n = \gamma ^ \top z_n + U_n$. Different choices of the distribution of $U_n$ lead to different flavors of AFT models. The basic exponential model is an AFT model with $U$ following an extreme value type-1 distribution. </span>
<span id="cb60-596"><a href="#cb60-596" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{accelerated failure time model!exponential model|)}</span>
<span id="cb60-597"><a href="#cb60-597" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{accelerated failure time model!weibul model|(}</span>
<span id="cb60-598"><a href="#cb60-598" aria-hidden="true" tabindex="-1"></a>Two natural extensions of this model consist of introducing a supplementary parameter $\sigma = 1 / \delta$ or considering different distributions for $U$:</span>
<span id="cb60-599"><a href="#cb60-599" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-600"><a href="#cb60-600" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-601"><a href="#cb60-601" aria-hidden="true" tabindex="-1"></a>\ln T_n = - \ln \lambda_n + \frac{1}{\delta} U_n = - \ln \lambda_n + \sigma U_n</span>
<span id="cb60-602"><a href="#cb60-602" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-603"><a href="#cb60-603" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-604"><a href="#cb60-604" aria-hidden="true" tabindex="-1"></a>Keeping for the moment the hypothesis that $U_n$ is type-1 extreme value, as $U = \delta \ln \lambda T$, the density of $T$ is then:</span>
<span id="cb60-605"><a href="#cb60-605" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-606"><a href="#cb60-606" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-607"><a href="#cb60-607" aria-hidden="true" tabindex="-1"></a>f(T) = e ^ {\delta \ln(\lambda T)} e ^ {- e ^ {\delta \ln(\lambda T)}} \frac{dU}{dT} = (\lambda T) ^ \delta e ^ {- (\lambda T) ^ \delta} \frac{\delta}{T} = \delta \lambda ^ \delta T ^ {\delta - 1} e ^ {-(\lambda T) ^ \delta}</span>
<span id="cb60-608"><a href="#cb60-608" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-609"><a href="#cb60-609" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-610"><a href="#cb60-610" aria-hidden="true" tabindex="-1"></a>and the corresponding survival function is: $S(t) = e ^ {-(\lambda t) ^ \delta}$.</span>
<span id="cb60-611"><a href="#cb60-611" aria-hidden="true" tabindex="-1"></a>This is a Weibull distribution,\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{Weibull distribution} with a shape parameter equal to $\delta$</span>
<span id="cb60-612"><a href="#cb60-612" aria-hidden="true" tabindex="-1"></a>and a scale parameter equal to $\frac{1}{\lambda}$. The corresponding</span>
<span id="cb60-613"><a href="#cb60-613" aria-hidden="true" tabindex="-1"></a>hazard function is: $\theta(t) = \delta \lambda ^ \delta t ^ {\delta - 1}$.</span>
<span id="cb60-614"><a href="#cb60-614" aria-hidden="true" tabindex="-1"></a>This **Weibull model** is the most common model used in duration</span>
<span id="cb60-615"><a href="#cb60-615" aria-hidden="true" tabindex="-1"></a>analysis. It is particularly appealing, as it is very easy to estimate</span>
<span id="cb60-616"><a href="#cb60-616" aria-hidden="true" tabindex="-1"></a>and because it can deal with either a hazard function that increases</span>
<span id="cb60-617"><a href="#cb60-617" aria-hidden="true" tabindex="-1"></a>($\delta &gt; 1$) or decrease ($\delta &lt; 1$) with time. In the first case,</span>
<span id="cb60-618"><a href="#cb60-618" aria-hidden="true" tabindex="-1"></a>there is a **positive time dependence** and in the second case, a</span>
<span id="cb60-619"><a href="#cb60-619" aria-hidden="true" tabindex="-1"></a>**negative time dependence**. Obviously, the Weibull model reduces to the</span>
<span id="cb60-620"><a href="#cb60-620" aria-hidden="true" tabindex="-1"></a>exponential model if $\delta = 1$. With $\lambda_n = e ^ {- \gamma z_n}$ and denoting $\epsilon_n = \ln T_n - \gamma ^ \top z_n$, the hazard and the survival functions are:</span>
<span id="cb60-621"><a href="#cb60-621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-622"><a href="#cb60-622" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-623"><a href="#cb60-623" aria-hidden="true" tabindex="-1"></a>\theta(t) = \delta t ^ {\delta - 1}e ^ {- \delta\gamma ^ \top z} = \frac{\delta}{t} e^ {\delta \epsilon} \;\mbox{and} \; S(t) = e^{-t ^ \delta e ^ {-\delta \gamma ^\top z}}</span>
<span id="cb60-624"><a href="#cb60-624" aria-hidden="true" tabindex="-1"></a>$$ {#eq-hazard_weibull_aft}</span>
<span id="cb60-625"><a href="#cb60-625" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-626"><a href="#cb60-626" aria-hidden="true" tabindex="-1"></a>The log-likelihood function is then:</span>
<span id="cb60-627"><a href="#cb60-627" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-628"><a href="#cb60-628" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-629"><a href="#cb60-629" aria-hidden="true" tabindex="-1"></a>\ln L = \sum_{n=1} ^ n d_n \left<span class="co">[</span><span class="ot">\ln \delta - \ln t + \delta \epsilon_n\right</span><span class="co">]</span> - e ^ {\delta\epsilon}</span>
<span id="cb60-630"><a href="#cb60-630" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-631"><a href="#cb60-631" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{accelerated failure time model!weibul model|)}</span>
<span id="cb60-632"><a href="#cb60-632" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- A more general model is obtained by specifying $e ^ U$ as a gamma --&gt;</span></span>
<span id="cb60-633"><a href="#cb60-633" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- variate (and not as a unit exponentional distribution). In this case, --&gt;</span></span>
<span id="cb60-634"><a href="#cb60-634" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- the density of $Z = e ^ U = (\lambda T) ^ \sigma$ is --&gt;</span></span>
<span id="cb60-635"><a href="#cb60-635" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $f(Z)=\frac{z ^ {m - 1} e ^ {-z}}{\Gamma(m)}$ (which reduces to --&gt;</span></span>
<span id="cb60-636"><a href="#cb60-636" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $e ^ {-z}$ if $m=1$). The density of $T$ is then, noting that --&gt;</span></span>
<span id="cb60-637"><a href="#cb60-637" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $dZ = \sigma \lambda ^ \sigma T ^ {\sigma - 1}$ --&gt;</span></span>
<span id="cb60-638"><a href="#cb60-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-639"><a href="#cb60-639" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb60-640"><a href="#cb60-640" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- f(t) = \sigma \lambda ^ \sigma T ^ {\sigma - 1} \frac{(\lambda T) ^ {\sigma(m - 1)} e ^ {-(\lambda T) ^ \sigma}}{\Gamma(m)} = \sigma \Lambda ^ {\sigma m} T ^{\sigma m - 1} e ^ {- (\lambda T) ^ \sigma} / \Gamma(m) --&gt;</span></span>
<span id="cb60-641"><a href="#cb60-641" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb60-642"><a href="#cb60-642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-643"><a href="#cb60-643" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- which is a **generalized gamma distribution** with shape parameters --&gt;</span></span>
<span id="cb60-644"><a href="#cb60-644" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $p = \sigma$ and $d = \sigma m$ and scale parameter $a = 1 / \lambda$. --&gt;</span></span>
<span id="cb60-645"><a href="#cb60-645" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- This reduce to: --&gt;</span></span>
<span id="cb60-646"><a href="#cb60-646" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-647"><a href="#cb60-647" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- -   the gamma distribution if $p = \sigma = 1$, --&gt;</span></span>
<span id="cb60-648"><a href="#cb60-648" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- -   the Weibull distribution if $d = p$ (or $m = 1$), --&gt;</span></span>
<span id="cb60-649"><a href="#cb60-649" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- -   the exponential distribution if $p = d = 1$ (or $\sigma = m = 1$). --&gt;</span></span>
<span id="cb60-650"><a href="#cb60-650" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-651"><a href="#cb60-651" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- The hazard function (which has no closed-form) is very flexible: it is --&gt;</span></span>
<span id="cb60-652"><a href="#cb60-652" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- (denoting $d = \sigma m$): --&gt;</span></span>
<span id="cb60-653"><a href="#cb60-653" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-654"><a href="#cb60-654" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- -   monotonically increasing if $\sigma &gt; 1$ and $d &gt; 1$, --&gt;</span></span>
<span id="cb60-655"><a href="#cb60-655" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- -   monotonically decreasing if $\sigma &lt; 1$ and $d &lt; 1$, --&gt;</span></span>
<span id="cb60-656"><a href="#cb60-656" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- -   U-shaped if $\sigma &lt; 1$ and $d &gt; 1$, --&gt;</span></span>
<span id="cb60-657"><a href="#cb60-657" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- -   inverted U-shaped if $\sigma &gt; 1$ and $d &lt; 1$. --&gt;</span></span>
<span id="cb60-658"><a href="#cb60-658" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-659"><a href="#cb60-659" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{accelerated failure time model!log-normal model|(}</span>
<span id="cb60-660"><a href="#cb60-660" aria-hidden="true" tabindex="-1"></a>With $U \sim \mathcal{N}(0, 1)$,</span>
<span id="cb60-661"><a href="#cb60-661" aria-hidden="true" tabindex="-1"></a>$\ln T = - \ln \lambda + \sigma U \sim \mathcal{N}(-\ln \lambda, \sigma)$ and therefore</span>
<span id="cb60-662"><a href="#cb60-662" aria-hidden="true" tabindex="-1"></a>the time duration is log-normal and the hazard function is:</span>
<span id="cb60-663"><a href="#cb60-663" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-664"><a href="#cb60-664" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-665"><a href="#cb60-665" aria-hidden="true" tabindex="-1"></a>\theta(t) = \frac{1}{\sigma t} \frac{\phi\left(\frac{\ln t + \ln \lambda}{\sigma}\right)}{1 - \Phi\left(\frac{\ln t + \ln \lambda}{\sigma}\right)} = \frac{1}{\sigma t} r\left(\frac{\ln t + \ln \lambda}{\sigma}\right)</span>
<span id="cb60-666"><a href="#cb60-666" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-667"><a href="#cb60-667" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-668"><a href="#cb60-668" aria-hidden="true" tabindex="-1"></a>with $\phi$ and $\Phi$ the density and the probability functions of a</span>
<span id="cb60-669"><a href="#cb60-669" aria-hidden="true" tabindex="-1"></a>standard normal variable and $r(z) = \phi(z) / \left(1 - \Phi(z)\right)$</span>
<span id="cb60-670"><a href="#cb60-670" aria-hidden="true" tabindex="-1"></a>is the inverse Mills' ratio. With, as previously, $\ln \lambda = - \gamma ^ \top z$, in terms of $\epsilon = \ln t - \gamma ^ \top z$, we have:</span>
<span id="cb60-671"><a href="#cb60-671" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-672"><a href="#cb60-672" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-673"><a href="#cb60-673" aria-hidden="true" tabindex="-1"></a>\theta(t) = \frac{1}{\sigma t}\frac{\phi(\epsilon/\sigma)}{1 - \Phi(\epsilon/\sigma)} </span>
<span id="cb60-674"><a href="#cb60-674" aria-hidden="true" tabindex="-1"></a>\; \mbox{and}\; S(t) = 1 - \Phi(\epsilon/\sigma)</span>
<span id="cb60-675"><a href="#cb60-675" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-676"><a href="#cb60-676" aria-hidden="true" tabindex="-1"></a>The hazard function is then inverted U-shaped, whatever the value of $\sigma$.</span>
<span id="cb60-677"><a href="#cb60-677" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-678"><a href="#cb60-678" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-679"><a href="#cb60-679" aria-hidden="true" tabindex="-1"></a>\ln L = \sum_{n=1} ^ n d_n \left<span class="co">[</span><span class="ot">-\ln \sigma - \ln t + \ln \phi(\epsilon_n/\sigma) \right</span><span class="co">]</span> + (1 - d) \ln (1 - \Phi(\epsilon/\sigma))</span>
<span id="cb60-680"><a href="#cb60-680" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-681"><a href="#cb60-681" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{accelerated failure time model!log-normal model|)}</span>
<span id="cb60-682"><a href="#cb60-682" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{accelerated failure time model!log-logistic model|(}</span>
<span id="cb60-683"><a href="#cb60-683" aria-hidden="true" tabindex="-1"></a>Finally, consider that the distribution of $U$ is standard logistic, so</span>
<span id="cb60-684"><a href="#cb60-684" aria-hidden="true" tabindex="-1"></a>that $f(u) = \frac{e^u}{(1 + e ^ u) ^ 2}$. As</span>
<span id="cb60-685"><a href="#cb60-685" aria-hidden="true" tabindex="-1"></a>$\delta \ln T \lambda = U$, $\frac{dU}{dT} = \delta / T$ and the density</span>
<span id="cb60-686"><a href="#cb60-686" aria-hidden="true" tabindex="-1"></a>of $T$ is then:</span>
<span id="cb60-687"><a href="#cb60-687" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-688"><a href="#cb60-688" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-689"><a href="#cb60-689" aria-hidden="true" tabindex="-1"></a>f(T) = \frac{ (\lambda T) ^ \delta}{\left(1 + (\lambda T) ^ \delta\right) ^ 2} \delta / T = \frac{\delta v T ^ {\delta - 1}}{(1 + v T ^ \delta) ^ 2}</span>
<span id="cb60-690"><a href="#cb60-690" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-691"><a href="#cb60-691" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-692"><a href="#cb60-692" aria-hidden="true" tabindex="-1"></a>with $v = \lambda ^ \delta$. The cumulative density and the survival</span>
<span id="cb60-693"><a href="#cb60-693" aria-hidden="true" tabindex="-1"></a>function are $F(t) = \frac{vT ^ \delta}{1 + vT ^ \delta}$ and</span>
<span id="cb60-694"><a href="#cb60-694" aria-hidden="true" tabindex="-1"></a>$S(t) = \frac{1}{1 + vT ^ \delta}$, so that the hazard function is:</span>
<span id="cb60-695"><a href="#cb60-695" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-696"><a href="#cb60-696" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-697"><a href="#cb60-697" aria-hidden="true" tabindex="-1"></a>\theta(t) = \delta \frac{v t ^ {\delta - 1}}{1 + v t ^ \delta}</span>
<span id="cb60-698"><a href="#cb60-698" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-699"><a href="#cb60-699" aria-hidden="true" tabindex="-1"></a>which is the **log-logistic model**. In terms of $\epsilon$, we have:</span>
<span id="cb60-700"><a href="#cb60-700" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-701"><a href="#cb60-701" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-702"><a href="#cb60-702" aria-hidden="true" tabindex="-1"></a>\theta(t)  = \frac{\delta}{t}\frac{e ^ {\delta\epsilon}}{1 + e ^ {\delta\epsilon}},\; S(t) = \frac{1}{1 + e ^ {\delta\epsilon}}</span>
<span id="cb60-703"><a href="#cb60-703" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-704"><a href="#cb60-704" aria-hidden="true" tabindex="-1"></a>and the following log-likelihood function:</span>
<span id="cb60-705"><a href="#cb60-705" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-706"><a href="#cb60-706" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-707"><a href="#cb60-707" aria-hidden="true" tabindex="-1"></a>\ln L = \sum_{n=1} ^ n d_n \left<span class="co">[</span><span class="ot">\ln \delta - \ln t + \delta\epsilon_n \right</span><span class="co">]</span> - (1 + d_n) \ln (1 + e^ {\delta\epsilon})</span>
<span id="cb60-708"><a href="#cb60-708" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-709"><a href="#cb60-709" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-710"><a href="#cb60-710" aria-hidden="true" tabindex="-1"></a>If $\delta = 1$, the hazard reduces to $\theta(t) = v / (1 + vT)$ and is</span>
<span id="cb60-711"><a href="#cb60-711" aria-hidden="true" tabindex="-1"></a>therefore decreasing from $v$ for $T\rightarrow 0$ to 0 for</span>
<span id="cb60-712"><a href="#cb60-712" aria-hidden="true" tabindex="-1"></a>$T\rightarrow + \infty$.</span>
<span id="cb60-713"><a href="#cb60-713" aria-hidden="true" tabindex="-1"></a>The derivative of the hazard function is:</span>
<span id="cb60-714"><a href="#cb60-714" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-715"><a href="#cb60-715" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-716"><a href="#cb60-716" aria-hidden="true" tabindex="-1"></a>\theta'(t) = - \frac{\delta v T ^ {\delta - 2}}{\left(1 + vT ^ \delta\right) ^ 2} \left<span class="co">[</span><span class="ot">v T ^ \delta + (1 - \delta)\right</span><span class="co">]</span></span>
<span id="cb60-717"><a href="#cb60-717" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-718"><a href="#cb60-718" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-719"><a href="#cb60-719" aria-hidden="true" tabindex="-1"></a>If $\delta &lt; 1$ $\theta'(t)$ is negative for all $T$, so that the hazard</span>
<span id="cb60-720"><a href="#cb60-720" aria-hidden="true" tabindex="-1"></a>function is decreasing, from $+\infty$ to 0.</span>
<span id="cb60-721"><a href="#cb60-721" aria-hidden="true" tabindex="-1"></a>Finally, if $\delta &gt; 1$, the hazard function is inverted U-shaped, with a</span>
<span id="cb60-722"><a href="#cb60-722" aria-hidden="true" tabindex="-1"></a>maximum for $T=\left(\frac{\delta - 1}{v}\right) ^ {1 / \delta}$ and</span>
<span id="cb60-723"><a href="#cb60-723" aria-hidden="true" tabindex="-1"></a>tends to 0 for $T \rightarrow 0$ and $T \rightarrow + \infty$.</span>
<span id="cb60-724"><a href="#cb60-724" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{accelerated failure time model!log-logistic model|)}</span>
<span id="cb60-725"><a href="#cb60-725" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{accelerated failure time model|)}</span>
<span id="cb60-726"><a href="#cb60-726" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-727"><a href="#cb60-727" aria-hidden="true" tabindex="-1"></a>All these models are estimated by updating the exponential model previously estimated:</span>
<span id="cb60-728"><a href="#cb60-728" aria-hidden="true" tabindex="-1"></a>\idxfun{update}{stats}</span>
<span id="cb60-729"><a href="#cb60-729" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">(</span><span class="co">]</span>{unemp<span class="sc">\_</span>teachers}{micsr.data}</span>
<span id="cb60-730"><a href="#cb60-730" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-733"><a href="#cb60-733" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb60-734"><a href="#cb60-734" aria-hidden="true" tabindex="-1"></a>un_wei <span class="ot">&lt;-</span> <span class="fu">update</span>(un_exp, <span class="at">dist =</span> <span class="st">"weibull"</span>)</span>
<span id="cb60-735"><a href="#cb60-735" aria-hidden="true" tabindex="-1"></a>un_lnorm <span class="ot">&lt;-</span> <span class="fu">update</span>(un_exp, <span class="at">dist =</span> <span class="st">"lognormal"</span>)</span>
<span id="cb60-736"><a href="#cb60-736" aria-hidden="true" tabindex="-1"></a>un_llog <span class="ot">&lt;-</span> <span class="fu">update</span>(un_exp, <span class="at">dist =</span> <span class="st">"loglogistic"</span>)</span>
<span id="cb60-737"><a href="#cb60-737" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb60-738"><a href="#cb60-738" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-739"><a href="#cb60-739" aria-hidden="true" tabindex="-1"></a>We first plot the hazard curves for a specific individual: we choose a male aged 35 with a last hourly wage of 10. We then compute $\hat{\lambda}$ for the different models:</span>
<span id="cb60-740"><a href="#cb60-740" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-741"><a href="#cb60-741" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- x &lt;- c(1, 31, 0, 7, 0, 2, 1, 1, 7, rep(0, 14)) --&gt;</span></span>
<span id="cb60-742"><a href="#cb60-742" aria-hidden="true" tabindex="-1"></a>\idxfun{coef}{stats}</span>
<span id="cb60-743"><a href="#cb60-743" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-746"><a href="#cb60-746" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb60-747"><a href="#cb60-747" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">35</span>, <span class="dv">1</span>, <span class="fu">log</span>(<span class="dv">10</span>))</span>
<span id="cb60-748"><a href="#cb60-748" aria-hidden="true" tabindex="-1"></a>l_llog <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="sc">-</span> <span class="fu">sum</span>(<span class="fu">coef</span>(un_llog) <span class="sc">*</span> x))</span>
<span id="cb60-749"><a href="#cb60-749" aria-hidden="true" tabindex="-1"></a>l_wei <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="sc">-</span> <span class="fu">sum</span>(<span class="fu">coef</span>(un_wei) <span class="sc">*</span> x))</span>
<span id="cb60-750"><a href="#cb60-750" aria-hidden="true" tabindex="-1"></a>l_lnorm <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="sc">-</span> <span class="fu">sum</span>(<span class="fu">coef</span>(un_lnorm) <span class="sc">*</span> x))</span>
<span id="cb60-751"><a href="#cb60-751" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb60-752"><a href="#cb60-752" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-753"><a href="#cb60-753" aria-hidden="true" tabindex="-1"></a><span class="in">`survreg`</span> objects have a <span class="in">`scale`</span> object, which is the estimation of $\sigma$ with our notations. As the Weibull and the log-logistic are expressed in term of $\delta$, we take the inverse of this parameter for these two distributions.</span>
<span id="cb60-754"><a href="#cb60-754" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-757"><a href="#cb60-757" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb60-758"><a href="#cb60-758" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: true</span></span>
<span id="cb60-759"><a href="#cb60-759" aria-hidden="true" tabindex="-1"></a>s_llog <span class="ot">&lt;-</span> un_llog<span class="sc">$</span>scale <span class="sc">^</span> (<span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb60-760"><a href="#cb60-760" aria-hidden="true" tabindex="-1"></a>s_lnorm <span class="ot">&lt;-</span> un_lnorm<span class="sc">$</span>scale</span>
<span id="cb60-761"><a href="#cb60-761" aria-hidden="true" tabindex="-1"></a>s_wei <span class="ot">&lt;-</span> un_wei<span class="sc">$</span>scale <span class="sc">^</span> (<span class="sc">-</span><span class="dv">1</span>) </span>
<span id="cb60-762"><a href="#cb60-762" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="st">"log-log"</span> <span class="ot">=</span> s_llog, <span class="st">"log-normal"</span> <span class="ot">=</span> s_lnorm, <span class="st">"weibul"</span> <span class="ot">=</span> s_wei)</span>
<span id="cb60-763"><a href="#cb60-763" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb60-764"><a href="#cb60-764" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-765"><a href="#cb60-765" aria-hidden="true" tabindex="-1"></a>$\delta$ being larger than one for the log-logistic, we have an inverted U-shaped distribution for the hazard function. For the Weibull model, $\delta &lt; 1$, the hazard curve is then increasing. </span>
<span id="cb60-766"><a href="#cb60-766" aria-hidden="true" tabindex="-1"></a>We can then write functions for the hazards functions and plot them using <span class="in">`geom_function`</span> (see @fig-hazard_ud).</span>
<span id="cb60-767"><a href="#cb60-767" aria-hidden="true" tabindex="-1"></a>\idxfun{ggplot}{ggplot2}\idxfun{dnorm}{stats}\idxfun{pnorm}{stats}\idxfun{geom<span class="sc">\_</span>function}{ggplot2}\idxfun{aes}{ggplot2}</span>
<span id="cb60-768"><a href="#cb60-768" aria-hidden="true" tabindex="-1"></a>\idxfun{scale<span class="sc">\_</span>x<span class="sc">\_</span>continuous}{ggplot2}\idxfun{labs}{ggplot2}</span>
<span id="cb60-769"><a href="#cb60-769" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-772"><a href="#cb60-772" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb60-773"><a href="#cb60-773" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-hazard_ud</span></span>
<span id="cb60-774"><a href="#cb60-774" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Hazard functions for employment duration"</span></span>
<span id="cb60-775"><a href="#cb60-775" aria-hidden="true" tabindex="-1"></a>lnorm <span class="ot">&lt;-</span> <span class="cf">function</span>(d) <span class="dv">1</span> <span class="sc">/</span> (s_lnorm <span class="sc">*</span> d) <span class="sc">*</span> </span>
<span id="cb60-776"><a href="#cb60-776" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dnorm</span>( (<span class="fu">log</span>(d <span class="sc">*</span> l_lnorm) <span class="sc">/</span> s_lnorm)) <span class="sc">/</span> </span>
<span id="cb60-777"><a href="#cb60-777" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pnorm</span>( (<span class="fu">log</span>(d <span class="sc">*</span> l_lnorm) <span class="sc">/</span> s_lnorm), <span class="at">lower.tail =</span> <span class="cn">FALSE</span>)</span>
<span id="cb60-778"><a href="#cb60-778" aria-hidden="true" tabindex="-1"></a>loglog <span class="ot">&lt;-</span> <span class="cf">function</span>(d) s_llog <span class="sc">*</span> l_llog <span class="sc">^</span> s_llog <span class="sc">*</span> </span>
<span id="cb60-779"><a href="#cb60-779" aria-hidden="true" tabindex="-1"></a>  d <span class="sc">^</span> (s_llog <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> (l_llog <span class="sc">*</span> d) <span class="sc">^</span> s_llog)</span>
<span id="cb60-780"><a href="#cb60-780" aria-hidden="true" tabindex="-1"></a>weib <span class="ot">&lt;-</span> <span class="cf">function</span>(d) s_wei <span class="sc">*</span> l_wei <span class="sc">^</span> s_wei <span class="sc">*</span> d <span class="sc">^</span> (s_wei <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb60-781"><a href="#cb60-781" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb60-782"><a href="#cb60-782" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_function</span>(<span class="at">fun =</span> lnorm, <span class="fu">aes</span>(<span class="at">linetype =</span> <span class="st">"log-normal"</span>)) <span class="sc">+</span> </span>
<span id="cb60-783"><a href="#cb60-783" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_function</span>(<span class="at">fun =</span> loglog, <span class="fu">aes</span>(<span class="at">linetype =</span> <span class="st">"log-log"</span>)) <span class="sc">+</span></span>
<span id="cb60-784"><a href="#cb60-784" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_function</span>(<span class="at">fun =</span> weib, <span class="fu">aes</span>(<span class="at">linetype =</span> <span class="st">"weibull"</span>)) <span class="sc">+</span> </span>
<span id="cb60-785"><a href="#cb60-785" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">2</span>)) <span class="sc">+</span> </span>
<span id="cb60-786"><a href="#cb60-786" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">linetype =</span> <span class="st">"distribution"</span>)</span>
<span id="cb60-787"><a href="#cb60-787" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb60-788"><a href="#cb60-788" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-789"><a href="#cb60-789" aria-hidden="true" tabindex="-1"></a>The results of the four AFT models are presented in @tbl-acc_failure.</span>
<span id="cb60-790"><a href="#cb60-790" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-793"><a href="#cb60-793" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb60-794"><a href="#cb60-794" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb60-795"><a href="#cb60-795" aria-hidden="true" tabindex="-1"></a>gof_omit_cox <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"iter"</span>, <span class="st">"n"</span>, <span class="st">"nevent"</span>, <span class="st">"statistic.log"</span>, <span class="st">"p.value.log"</span>, </span>
<span id="cb60-796"><a href="#cb60-796" aria-hidden="true" tabindex="-1"></a>              <span class="st">"statistic.sc"</span>, <span class="st">"p.value.sc"</span>, <span class="st">"statistic.wald"</span>, <span class="st">"p.value.wald"</span>, </span>
<span id="cb60-797"><a href="#cb60-797" aria-hidden="true" tabindex="-1"></a>              <span class="st">"statistic.robust"</span>, <span class="st">"p.value.robust"</span>, <span class="st">"r.squared.max"</span>)</span>
<span id="cb60-798"><a href="#cb60-798" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-799"><a href="#cb60-799" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb60-800"><a href="#cb60-800" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-801"><a href="#cb60-801" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-804"><a href="#cb60-804" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb60-805"><a href="#cb60-805" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb60-806"><a href="#cb60-806" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-acc_failure</span></span>
<span id="cb60-807"><a href="#cb60-807" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Accelerated failure time model for unemployment duration"</span></span>
<span id="cb60-808"><a href="#cb60-808" aria-hidden="true" tabindex="-1"></a>modelsummary<span class="sc">::</span><span class="fu">msummary</span>(<span class="fu">list</span>(<span class="at">exponential =</span> un_exp, <span class="at">weibull =</span> un_wei, </span>
<span id="cb60-809"><a href="#cb60-809" aria-hidden="true" tabindex="-1"></a>                            <span class="st">`</span><span class="at">log-logistic</span><span class="st">`</span> <span class="ot">=</span> un_llog, <span class="st">`</span><span class="at">log-normal</span><span class="st">`</span> <span class="ot">=</span> un_lnorm),</span>
<span id="cb60-810"><a href="#cb60-810" aria-hidden="true" tabindex="-1"></a>                       <span class="at">coef_omit =</span> <span class="st">"(occupation|industry)"</span>, <span class="at">output =</span> <span class="st">"kableExtra"</span>)</span>
<span id="cb60-811"><a href="#cb60-811" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb60-812"><a href="#cb60-812" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">)</span><span class="co">]</span>{unemp<span class="sc">\_</span>teachers}{micsr.data}</span>
<span id="cb60-813"><a href="#cb60-813" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-814"><a href="#cb60-814" aria-hidden="true" tabindex="-1"></a><span class="fu">### Proportional hazard models</span></span>
<span id="cb60-815"><a href="#cb60-815" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-816"><a href="#cb60-816" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{proportional hazard model|(}</span>
<span id="cb60-817"><a href="#cb60-817" aria-hidden="true" tabindex="-1"></a>The **proportional hazard** (**PH**) models  starts with the specification of the hazard function. More specifically, it is assumed that the hazard function can be written as the product of two terms:</span>
<span id="cb60-818"><a href="#cb60-818" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-819"><a href="#cb60-819" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-820"><a href="#cb60-820" aria-hidden="true" tabindex="-1"></a>\theta(t | x) = \lambda(t, \rho) f(x, \gamma)</span>
<span id="cb60-821"><a href="#cb60-821" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-822"><a href="#cb60-822" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-823"><a href="#cb60-823" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>the first depends only on the duration and on some unknown</span>
<span id="cb60-824"><a href="#cb60-824" aria-hidden="true" tabindex="-1"></a>    parameters; it is called the baseline hazard,</span>
<span id="cb60-825"><a href="#cb60-825" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>the second depends on some covariates and some unknown</span>
<span id="cb60-826"><a href="#cb60-826" aria-hidden="true" tabindex="-1"></a>    parameters, but not on duration; it is parametrized as $e ^ {\gamma ^ \top z} = e ^ {\alpha + \beta ^ \top x}$.</span>
<span id="cb60-827"><a href="#cb60-827" aria-hidden="true" tabindex="-1"></a>Consider two individuals characterized by two sets of values for the</span>
<span id="cb60-828"><a href="#cb60-828" aria-hidden="true" tabindex="-1"></a>covariates $x_1$ and $x_2$. The ratio of their hazard for a given</span>
<span id="cb60-829"><a href="#cb60-829" aria-hidden="true" tabindex="-1"></a>duration is:</span>
<span id="cb60-830"><a href="#cb60-830" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-831"><a href="#cb60-831" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-832"><a href="#cb60-832" aria-hidden="true" tabindex="-1"></a>\frac{\theta(t|x = x_1)}{\theta(t|x = x_2)}= \frac{f(x_1, \gamma)}{f(x_2, \gamma)} = \frac{e^ {\alpha + \beta ^ \top x_1}}{e ^  {\alpha + \beta ^ \top x_2}} = e ^ {\beta(x_1 - x_2)}</span>
<span id="cb60-833"><a href="#cb60-833" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-834"><a href="#cb60-834" aria-hidden="true" tabindex="-1"></a>and therefore doesn't depend on the duration. This model is called for</span>
<span id="cb60-835"><a href="#cb60-835" aria-hidden="true" tabindex="-1"></a>this reason the **proportional hazard model**. The marginal effect of</span>
<span id="cb60-836"><a href="#cb60-836" aria-hidden="true" tabindex="-1"></a>one covariate on the hazard is:</span>
<span id="cb60-837"><a href="#cb60-837" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-838"><a href="#cb60-838" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-839"><a href="#cb60-839" aria-hidden="true" tabindex="-1"></a>\frac{\partial \theta(t|x)}{\partial x_k} = \lambda(t, \rho) \frac{\partial f}{\partial x_k} = \lambda(t, \rho) \beta_k f(x, \gamma) = \beta_k\theta(t, x)</span>
<span id="cb60-840"><a href="#cb60-840" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-841"><a href="#cb60-841" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-842"><a href="#cb60-842" aria-hidden="true" tabindex="-1"></a>Therefore, the marginal effect is proportional to the hazard; more precisely, it is</span>
<span id="cb60-843"><a href="#cb60-843" aria-hidden="true" tabindex="-1"></a>just $\beta_k$ times the hazard. Note that the parametrization is the opposite of the one used for the AFT models. Therefore, the interpretation of the coefficients should be modified: a positive value of $\beta_k$ means that the covariate has a positive effect on the hazard and therefore a negative effect on the duration. The most common used PH models are the exponential and the Weibull model. For the Weibull model, the hazard and the corresponding survival functions are generally parametrized as:</span>
<span id="cb60-844"><a href="#cb60-844" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-845"><a href="#cb60-845" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-846"><a href="#cb60-846" aria-hidden="true" tabindex="-1"></a>\theta(t_n) = \delta t_n ^ {\delta - 1} e^{\gamma ^ \top z_n}\;\mbox{and}\; S(t_n) = e ^ {- t_n ^ \delta e ^ {\gamma^\top z_n}}</span>
<span id="cb60-847"><a href="#cb60-847" aria-hidden="true" tabindex="-1"></a>$$ {#eq-hazard_weibull_ph}</span>
<span id="cb60-848"><a href="#cb60-848" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-849"><a href="#cb60-849" aria-hidden="true" tabindex="-1"></a>This is exactly the same hazard function as @eq-hazard_weibull_aft with a different  parametrization: starting from the PH coefficients, the AFT coefficients are $- \gamma / \delta$. </span>
<span id="cb60-850"><a href="#cb60-850" aria-hidden="true" tabindex="-1"></a>The exponential model is obtained as the special case of @eq-hazard_weibull_ph where $\delta=1$. In this case, the two vectors of coefficients of the AFT and the PH models are just opposite. </span>
<span id="cb60-851"><a href="#cb60-851" aria-hidden="true" tabindex="-1"></a>The Weibull and the exponential models are the only two models which</span>
<span id="cb60-852"><a href="#cb60-852" aria-hidden="true" tabindex="-1"></a>belong to the AFM and the PH family.</span>
<span id="cb60-853"><a href="#cb60-853" aria-hidden="true" tabindex="-1"></a>Two more specifications of proportional hazard models are often used,</span>
<span id="cb60-854"><a href="#cb60-854" aria-hidden="true" tabindex="-1"></a>namely the generalized Weibull and the Gompertz models.</span>
<span id="cb60-855"><a href="#cb60-855" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-856"><a href="#cb60-856" aria-hidden="true" tabindex="-1"></a>The Cox proportional hazard model <span class="co">[</span><span class="ot">@COX:72; @COX:75</span><span class="co">]</span>\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Cox} is semi-parametric, as only the $f()$</span>
<span id="cb60-857"><a href="#cb60-857" aria-hidden="true" tabindex="-1"></a>function is estimated and not the baseline hazard function. It is better</span>
<span id="cb60-858"><a href="#cb60-858" aria-hidden="true" tabindex="-1"></a>understood using a simple example. Without lack of generality, consider</span>
<span id="cb60-859"><a href="#cb60-859" aria-hidden="true" tabindex="-1"></a>that the observations are arranged in an increasing order of duration.</span>
<span id="cb60-860"><a href="#cb60-860" aria-hidden="true" tabindex="-1"></a>Consider a sample of size 4, with $t = (2, 3, 5, 8)$. For time</span>
<span id="cb60-861"><a href="#cb60-861" aria-hidden="true" tabindex="-1"></a>$t_1 = 2$, all the observations are at risk (none of them failed</span>
<span id="cb60-862"><a href="#cb60-862" aria-hidden="true" tabindex="-1"></a>before). Consider the probability that one observation $n$ fails at time</span>
<span id="cb60-863"><a href="#cb60-863" aria-hidden="true" tabindex="-1"></a>$t_1=2$, given that it was at risk. This writes:</span>
<span id="cb60-864"><a href="#cb60-864" aria-hidden="true" tabindex="-1"></a>$P(t_n = t_1 | t_n \geq t_1)=\lambda(t_1) f(x_n, \gamma)$. The</span>
<span id="cb60-865"><a href="#cb60-865" aria-hidden="true" tabindex="-1"></a>probability that an observation fails at $t_1 = 2$ is the sum of this</span>
<span id="cb60-866"><a href="#cb60-866" aria-hidden="true" tabindex="-1"></a>expression for the four observations:</span>
<span id="cb60-867"><a href="#cb60-867" aria-hidden="true" tabindex="-1"></a>$\lambda(t_1)\sum_{n = 1} ^ 4 f(x_n, \gamma)$. Finally, the probability</span>
<span id="cb60-868"><a href="#cb60-868" aria-hidden="true" tabindex="-1"></a>that observation $n$ fails given that one observation fails is:</span>
<span id="cb60-869"><a href="#cb60-869" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-870"><a href="#cb60-870" aria-hidden="true" tabindex="-1"></a>$$\frac{\lambda(t_1)f(x_n, \gamma)}{\lambda(t_1)\sum_{n = 1} ^ 4 f(x_n, \gamma)} = \frac{f(x_n, \gamma)}{\sum_{n = 1} ^ 4 f(x_n, \gamma)}$$</span>
<span id="cb60-871"><a href="#cb60-871" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-872"><a href="#cb60-872" aria-hidden="true" tabindex="-1"></a>This probability therefore doesn't depend on the baseline hazard</span>
<span id="cb60-873"><a href="#cb60-873" aria-hidden="true" tabindex="-1"></a>function. Moreover, if $f(x_n, \gamma) = e ^ {\gamma^\top z_n}$, it has a</span>
<span id="cb60-874"><a href="#cb60-874" aria-hidden="true" tabindex="-1"></a>logit form: $e^{\gamma^\top z_n} / \sum_n e^{\gamma^\top z_n}$. As this is</span>
<span id="cb60-875"><a href="#cb60-875" aria-hidden="true" tabindex="-1"></a>the first observation that failed for $t_1 = 2$, the contribution of this</span>
<span id="cb60-876"><a href="#cb60-876" aria-hidden="true" tabindex="-1"></a>observation is:</span>
<span id="cb60-877"><a href="#cb60-877" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-878"><a href="#cb60-878" aria-hidden="true" tabindex="-1"></a>$$\frac{e^{\gamma^\top z_1}}{e^{\gamma^\top z_1} + e^{\gamma^\top z_2} + e^{\gamma^\top z_3}+e^{\gamma^\top z_4}}$$</span>
<span id="cb60-879"><a href="#cb60-879" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-880"><a href="#cb60-880" aria-hidden="true" tabindex="-1"></a>The reasoning is similar for $t_2 = 3$. The set of observations at risk</span>
<span id="cb60-881"><a href="#cb60-881" aria-hidden="true" tabindex="-1"></a>is the last three observations and the contribution of observation $2$</span>
<span id="cb60-882"><a href="#cb60-882" aria-hidden="true" tabindex="-1"></a>is then:</span>
<span id="cb60-883"><a href="#cb60-883" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-884"><a href="#cb60-884" aria-hidden="true" tabindex="-1"></a>$$\frac{e^{\gamma^\top z_2}}{e^{\gamma^\top z_2} + e^{\gamma^\top z_3} + e^{\gamma^\top z_4}}$$</span>
<span id="cb60-885"><a href="#cb60-885" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-886"><a href="#cb60-886" aria-hidden="true" tabindex="-1"></a>For observation 3, the set of observations at risk reduces to</span>
<span id="cb60-887"><a href="#cb60-887" aria-hidden="true" tabindex="-1"></a>observations 3 and 4:</span>
<span id="cb60-888"><a href="#cb60-888" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-889"><a href="#cb60-889" aria-hidden="true" tabindex="-1"></a>$$\frac{e^{\gamma^\top z_3}}{e^{\gamma^\top z_3} + e^{\gamma^\top z_4}}$$</span>
<span id="cb60-890"><a href="#cb60-890" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-891"><a href="#cb60-891" aria-hidden="true" tabindex="-1"></a>Finally, for the last observation, the set of observations at risk is</span>
<span id="cb60-892"><a href="#cb60-892" aria-hidden="true" tabindex="-1"></a>only this observation, so that the contribution of observation $4$ is:</span>
<span id="cb60-893"><a href="#cb60-893" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-894"><a href="#cb60-894" aria-hidden="true" tabindex="-1"></a>$$\frac{e^{\gamma^\top z_4}}{e^{\gamma^\top z_4}} = 1$$</span>
<span id="cb60-895"><a href="#cb60-895" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-896"><a href="#cb60-896" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{partial likelihood}</span>
<span id="cb60-897"><a href="#cb60-897" aria-hidden="true" tabindex="-1"></a>The **partial likelihood** for the whole sample is the product of these</span>
<span id="cb60-898"><a href="#cb60-898" aria-hidden="true" tabindex="-1"></a>four contributions:</span>
<span id="cb60-899"><a href="#cb60-899" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-900"><a href="#cb60-900" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-901"><a href="#cb60-901" aria-hidden="true" tabindex="-1"></a>L = \frac{e^{\gamma^\top z_1}}{e^{\gamma^\top z_1} + e^{\gamma^\top z_2} + e^{\gamma^\top z_3} + e^{\gamma^\top z_4} }\times\frac{e^{\gamma^\top z_2}}{e^{\gamma^\top z_2} + e^{\gamma^\top z_3} + e^{\gamma^\top z_4} }\times \frac{e^{\gamma^\top z_3}}{e^{\gamma^\top z_3} + e^{\gamma^\top z_4}} \times 1</span>
<span id="cb60-902"><a href="#cb60-902" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-903"><a href="#cb60-903" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-904"><a href="#cb60-904" aria-hidden="true" tabindex="-1"></a>A more general expression is obtained by denoting $R_n$ the set of</span>
<span id="cb60-905"><a href="#cb60-905" aria-hidden="true" tabindex="-1"></a>observations for which $t_m \geq t_n$, i.e., the set of observations at</span>
<span id="cb60-906"><a href="#cb60-906" aria-hidden="true" tabindex="-1"></a>risk at time $t_n$:</span>
<span id="cb60-907"><a href="#cb60-907" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-908"><a href="#cb60-908" aria-hidden="true" tabindex="-1"></a>$$L = \prod_{n=1}^N\frac{e^{\gamma ^ \top z_n}}{\sum_{n \in R_n}e^{\gamma ^ \top z_n}}$$</span>
<span id="cb60-909"><a href="#cb60-909" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-910"><a href="#cb60-910" aria-hidden="true" tabindex="-1"></a>and the partial log-likelihood is therefore:</span>
<span id="cb60-911"><a href="#cb60-911" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-912"><a href="#cb60-912" aria-hidden="true" tabindex="-1"></a>$$\ln L = \sum_{n=1}^N\left(\gamma ^ \top z_n - \ln \sum_{n \in R_n}e^{\gamma ^ \top z_n}\right)$$</span>
<span id="cb60-913"><a href="#cb60-913" aria-hidden="true" tabindex="-1"></a>An interesting feature of Cox proportional hazard model is that the</span>
<span id="cb60-914"><a href="#cb60-914" aria-hidden="true" tabindex="-1"></a>duration response is only used as a way to order the observations. For</span>
<span id="cb60-915"><a href="#cb60-915" aria-hidden="true" tabindex="-1"></a>example, if $t = (1, 2, 3, 4)$ instead of $t = (2, 3, 5, 8)$, we would</span>
<span id="cb60-916"><a href="#cb60-916" aria-hidden="true" tabindex="-1"></a>obtain exactly the same likelihood and therefore the same fitted</span>
<span id="cb60-917"><a href="#cb60-917" aria-hidden="true" tabindex="-1"></a>parameters. Censored observations contribute only to the partial likelihood as elements of the</span>
<span id="cb60-918"><a href="#cb60-918" aria-hidden="true" tabindex="-1"></a>set of observations at risk for some observations. For example, if</span>
<span id="cb60-919"><a href="#cb60-919" aria-hidden="true" tabindex="-1"></a>observation $2$ is censored, the likelihood is:</span>
<span id="cb60-920"><a href="#cb60-920" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-921"><a href="#cb60-921" aria-hidden="true" tabindex="-1"></a>$$L = \frac{e^{\gamma^\top z_1}}{e^{\gamma^\top z_1} + e^{\gamma^\top z_2} + e^{\gamma^\top z_3} + e^{\gamma^\top z_4} }\times \frac{e^{\gamma^\top z_3}}{e^{\gamma^\top z_3} + e^{\gamma^\top z_4}} \times 1$$</span>
<span id="cb60-922"><a href="#cb60-922" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-923"><a href="#cb60-923" aria-hidden="true" tabindex="-1"></a>and the general formula for the partial log-likelihood is, denoting</span>
<span id="cb60-924"><a href="#cb60-924" aria-hidden="true" tabindex="-1"></a>$d_n$ a dummy equal to 0 if observation $n$ is censored and 1</span>
<span id="cb60-925"><a href="#cb60-925" aria-hidden="true" tabindex="-1"></a>otherwise:</span>
<span id="cb60-926"><a href="#cb60-926" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-927"><a href="#cb60-927" aria-hidden="true" tabindex="-1"></a>$$\ln L = \sum_{n=1}^Nd_n\left(\gamma ^ \top z_n - \ln \sum_{n \in R_n}e^{\gamma ^ \top z_n}\right)$$</span>
<span id="cb60-928"><a href="#cb60-928" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-929"><a href="#cb60-929" aria-hidden="true" tabindex="-1"></a>Consider now that the sample includes ties, for example</span>
<span id="cb60-930"><a href="#cb60-930" aria-hidden="true" tabindex="-1"></a>$t = (2, 4, 4, 8)$. Durations for $n = 2$ and $n = 3$ are equal because</span>
<span id="cb60-931"><a href="#cb60-931" aria-hidden="true" tabindex="-1"></a>of rounding measures, and we don't know which observation failed first. If</span>
<span id="cb60-932"><a href="#cb60-932" aria-hidden="true" tabindex="-1"></a>the event occured first for $n=2$, the probability for observations $2$</span>
<span id="cb60-933"><a href="#cb60-933" aria-hidden="true" tabindex="-1"></a>and $3$ is:</span>
<span id="cb60-934"><a href="#cb60-934" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-935"><a href="#cb60-935" aria-hidden="true" tabindex="-1"></a>$$\frac{e^{\gamma^\top z_2}}{e^{\gamma^\top z_2} + e^{\gamma^\top z_3} + e^{\gamma^\top z_4}} + \frac{e^{\gamma^\top z_3}}{e^{\gamma^\top z_3} + e^{\gamma^\top z_4}}$$</span>
<span id="cb60-936"><a href="#cb60-936" aria-hidden="true" tabindex="-1"></a>On the contrary, if the event occurs first for $n=3$:</span>
<span id="cb60-937"><a href="#cb60-937" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-938"><a href="#cb60-938" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-939"><a href="#cb60-939" aria-hidden="true" tabindex="-1"></a>\frac{e^{\gamma^\top z_3}}{e^{\gamma^\top z_2} + e^{\gamma^\top z_3} + e^{\gamma^\top z_4}} + \frac{e^{\gamma^\top z_2}}{e^{\gamma^\top z_2} + e^{\gamma^\top z_4} }</span>
<span id="cb60-940"><a href="#cb60-940" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-941"><a href="#cb60-941" aria-hidden="true" tabindex="-1"></a>The probability for observations $2$ and $3$ is the sum of these two</span>
<span id="cb60-942"><a href="#cb60-942" aria-hidden="true" tabindex="-1"></a>probabilities and the partial likelihood is then:</span>
<span id="cb60-943"><a href="#cb60-943" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-944"><a href="#cb60-944" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-945"><a href="#cb60-945" aria-hidden="true" tabindex="-1"></a>\left(\frac{e^{\gamma^\top z_2}}{e^{\gamma^\top z_2} + e^{\gamma^\top z_3} + e^{\gamma^\top z_4}} + \frac{e^{\gamma^\top z_3}}{e^{\gamma^\top z_3} + e^{\gamma^\top z_4}}+\frac{e^{\gamma^\top z_3}}{e^{\gamma^\top z_2} + e^{\gamma^\top z_3} + e^{\gamma^\top z_4}} + \frac{e^{\gamma^\top z_2}}{e^{\gamma^\top z_2} + e^{\gamma^\top z_4}}\right)</span>
<span id="cb60-946"><a href="#cb60-946" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-947"><a href="#cb60-947" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-948"><a href="#cb60-948" aria-hidden="true" tabindex="-1"></a>Therefore, in the case of a tie with two observations, the product of</span>
<span id="cb60-949"><a href="#cb60-949" aria-hidden="true" tabindex="-1"></a>two probabilities is replaced by the sum of four probabilities. If there</span>
<span id="cb60-950"><a href="#cb60-950" aria-hidden="true" tabindex="-1"></a>were a tie with three observations, the product of three probabilities would</span>
<span id="cb60-951"><a href="#cb60-951" aria-hidden="true" tabindex="-1"></a>be replaced by the sum of 18 probabilities. More generally, with a tie</span>
<span id="cb60-952"><a href="#cb60-952" aria-hidden="true" tabindex="-1"></a>of $k$ observations, the number of probabilities that should be computed</span>
<span id="cb60-953"><a href="#cb60-953" aria-hidden="true" tabindex="-1"></a>is $k\times k!$. For example, with $k=10$, more than $30$ million</span>
<span id="cb60-954"><a href="#cb60-954" aria-hidden="true" tabindex="-1"></a>probabilities should be computed. Therefore, this formula can only be</span>
<span id="cb60-955"><a href="#cb60-955" aria-hidden="true" tabindex="-1"></a>applied when there are few and "thin" ties. Otherwise,</span>
<span id="cb60-956"><a href="#cb60-956" aria-hidden="true" tabindex="-1"></a>approximations have been proposed by Breslow and Efron.</span>
<span id="cb60-957"><a href="#cb60-957" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{proportional hazard model|)}</span>
<span id="cb60-958"><a href="#cb60-958" aria-hidden="true" tabindex="-1"></a>The <span class="in">`survival::coxph`</span> function fits the Cox proportional hazard regression model. We've already estimated the Weibull model using the <span class="in">`survival::survreg`</span> function in its accelerated failure time parametrization. <span class="in">`micsr::weibreg`</span> enables to estimate the Weibull model using either the AFT or the proportional hazard parametrization, using the <span class="in">`model`</span> argument:</span>
<span id="cb60-959"><a href="#cb60-959" aria-hidden="true" tabindex="-1"></a>\idxfun{weibreg}{micsr}\idxfun{Surv}{survival}\idxfun{update}{stats}\idxfun{coxph}{survival}</span>
<span id="cb60-960"><a href="#cb60-960" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">(</span><span class="co">]</span>{unemp<span class="sc">\_</span>teachers}{micsr.data}</span>
<span id="cb60-961"><a href="#cb60-961" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-964"><a href="#cb60-964" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb60-965"><a href="#cb60-965" aria-hidden="true" tabindex="-1"></a>weib_aft <span class="ot">&lt;-</span> <span class="fu">weibreg</span>(<span class="fu">Surv</span>(time, spell) <span class="sc">~</span> gender <span class="sc">+</span> age <span class="sc">+</span></span>
<span id="cb60-966"><a href="#cb60-966" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">log</span>(wage), unteach, <span class="at">model =</span> <span class="st">"aft"</span>)</span>
<span id="cb60-967"><a href="#cb60-967" aria-hidden="true" tabindex="-1"></a>weib_ph <span class="ot">&lt;-</span> <span class="fu">update</span>(weib_aft, <span class="at">model =</span> <span class="st">"ph"</span>)</span>
<span id="cb60-968"><a href="#cb60-968" aria-hidden="true" tabindex="-1"></a>cox <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(time, spell) <span class="sc">~</span> gender <span class="sc">+</span> age <span class="sc">+</span> <span class="fu">log</span>(wage),</span>
<span id="cb60-969"><a href="#cb60-969" aria-hidden="true" tabindex="-1"></a>             unteach)</span>
<span id="cb60-970"><a href="#cb60-970" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb60-971"><a href="#cb60-971" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-972"><a href="#cb60-972" aria-hidden="true" tabindex="-1"></a>The results are presented in @tbl-weib_ph. As stated previously, starting from the PH coefficient, the AFT is obtained as the opposite divided by $\delta$; for example, for age: $-(<span class="in">`r round(coef(weib_ph)["age"], 3)`</span> / <span class="in">`r round(coef(weib_ph)["shape"], 3)`</span>) = <span class="in">`r - round(coef(weib_ph)["age"] / coef(weib_ph)["shape"], 3)`</span>$. Obviously, the value of the log-likelihood function is the same for the PH and the AFT versions of the Weibull model. </span>
<span id="cb60-973"><a href="#cb60-973" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-976"><a href="#cb60-976" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb60-977"><a href="#cb60-977" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-weib_ph</span></span>
<span id="cb60-978"><a href="#cb60-978" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Weibull model (AFT and PH) and Cox semi-parametric model for the unemployment data set"</span></span>
<span id="cb60-979"><a href="#cb60-979" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb60-980"><a href="#cb60-980" aria-hidden="true" tabindex="-1"></a>modelsummary<span class="sc">::</span><span class="fu">msummary</span>(<span class="fu">list</span>(<span class="st">"Weibull (AFT)"</span> <span class="ot">=</span> weib_aft, </span>
<span id="cb60-981"><a href="#cb60-981" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"Weibull (PH)"</span> <span class="ot">=</span> weib_ph,</span>
<span id="cb60-982"><a href="#cb60-982" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"Cox model"</span> <span class="ot">=</span> cox), <span class="at">output =</span> <span class="st">"kableExtra"</span>)</span>
<span id="cb60-983"><a href="#cb60-983" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb60-984"><a href="#cb60-984" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-985"><a href="#cb60-985" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">)</span><span class="co">]</span>{unemp<span class="sc">\_</span>teachers}{micsr.data}</span>
<span id="cb60-986"><a href="#cb60-986" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-987"><a href="#cb60-987" aria-hidden="true" tabindex="-1"></a>\newpage</span>
<span id="cb60-988"><a href="#cb60-988" aria-hidden="true" tabindex="-1"></a><span class="fu">## Heterogeneity {#sec-heter_duration}</span></span>
<span id="cb60-989"><a href="#cb60-989" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-990"><a href="#cb60-990" aria-hidden="true" tabindex="-1"></a>Consider a population with two groups characterized by two different constant hazard rates,\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{constant hazard hypothesis} 0.4 for the first group and 0.1 for the second group.^<span class="co">[</span><span class="ot">This example is from @CAME:TRIV:05, p. 611.\index[author]{Cameron}\index[author]{Trivedi}</span><span class="co">]</span> If there are 100 individuals in both groups, the number of events (observations at risk) for the first group is $0.4 \times 100 = 40$ (60) for the first period, $0.4 \times 60 = 24$ (36) for the second and $0.4 \times 36 = 21.6$ (12.96) for the third. For the second group, we get $0.1 \times 100 = 10$ (90) for the first period, $0.1 \times 90 = 9$ (81), $0.1 \times 81 = 8.1$ (72.9) and $0.1 \times 72.9 = 7.29$ (65.61). Summing for the two groups, we get 50 (150), 33 (117), 22.5 (94.5). The hazard is then $50 / 200 = 0.25$ for the first period, $33/150 = 0.22$ for the second one and $22.5 / 117 = 0.1923$ for the third period. The hazard rate for the whole population is therefore decreasing, although it is constant for every individual. This result is easy to understand because, as times goes on, the proportion of individuals with the low hazard rate in the observations at risk is increasing.</span>
<span id="cb60-991"><a href="#cb60-991" aria-hidden="true" tabindex="-1"></a>It is therefore important to detect the presence of heterogeneity and, in the presence of heterogeneity, to fit models that take heterogeneity into account.</span>
<span id="cb60-992"><a href="#cb60-992" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-993"><a href="#cb60-993" aria-hidden="true" tabindex="-1"></a><span class="fu">### Detecting heterogeneity</span></span>
<span id="cb60-994"><a href="#cb60-994" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-995"><a href="#cb60-995" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{generalized residuals!Weibull model|(}</span>
<span id="cb60-996"><a href="#cb60-996" aria-hidden="true" tabindex="-1"></a>If heterogeneity is present, fitting a model that doesn't take it into account results in a wrong specification that can be tested using **generalized residuals**. In the context of duration models, integrated hazards can be considered as generalized residuals, as, if the specification is correct, their distribution is a unit exponential. Using the accelerating failure specification, remember that the integrated hazard is $\epsilon_n = \Lambda(t_n) = - \ln S(t_n) = e ^ {\delta (\ln t - \gamma ^ \top z_n)}$. The distribution of $\epsilon_n$ doesn't depend on $x_n$ and , being a unit exponential distribution, its first four uncentered moments are $1, 2, 6, 24$. To get an idea of the relevance of the specification, we can plot minus the log of the empirical survival (which is the number of observations $m$ such that $\epsilon_m &gt; \epsilon_n$ divided by the total number of observations) against the generalized residuals; the points should then be grossly aligned on the 45^o^ line. For censored observations, the duration is not known and the integrated hazard is replaced by its expectation. Denoting $L$ the censoring time, the expectation is:</span>
<span id="cb60-997"><a href="#cb60-997" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-998"><a href="#cb60-998" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-999"><a href="#cb60-999" aria-hidden="true" tabindex="-1"></a>\mbox{E}(\epsilon(T) \mid T \geq L)=\int_{\epsilon(L)} ^ {+\infty}\frac{\epsilon f(\epsilon)}{S(\epsilon(L))} d\epsilon =</span>
<span id="cb60-1000"><a href="#cb60-1000" aria-hidden="true" tabindex="-1"></a>\frac{1}{e^ {-\epsilon(L)}} \int_{\epsilon(L)} ^ {+\infty}\epsilon e ^ {- \epsilon}d\epsilon =</span>
<span id="cb60-1001"><a href="#cb60-1001" aria-hidden="true" tabindex="-1"></a>\epsilon(L) + 1</span>
<span id="cb60-1002"><a href="#cb60-1002" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-1003"><a href="#cb60-1003" aria-hidden="true" tabindex="-1"></a>\idxfun{weibreg}{micsr}\idxfun{Surv}{survival}\idxfun{gres}{micsr}\idxfun{nobs}{stats}</span>
<span id="cb60-1004"><a href="#cb60-1004" aria-hidden="true" tabindex="-1"></a>\idxfun{tibble}{tibble}\idxfun{group<span class="sc">\_</span>by}{dplyr}\idxfun{summarise}{dplyr}\idxfun{arrange}{dplyr}</span>
<span id="cb60-1005"><a href="#cb60-1005" aria-hidden="true" tabindex="-1"></a>\idxfun{mutate}{dplyr}\idxfun{cumsum}{base}\idxfun{ggplot}{ggplot2}\idxfun{aes}{ggplot2}</span>
<span id="cb60-1006"><a href="#cb60-1006" aria-hidden="true" tabindex="-1"></a>\idxfun{geom<span class="sc">\_</span>step}{ggplot2}\idxfun{geom<span class="sc">\_</span>abline}{ggplot2}</span>
<span id="cb60-1007"><a href="#cb60-1007" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">(</span><span class="co">]</span>{unemp<span class="sc">\_</span>teachers}{micsr.data}</span>
<span id="cb60-1008"><a href="#cb60-1008" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1009"><a href="#cb60-1009" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{generalized residuals!Weibull model|)}</span>
<span id="cb60-1010"><a href="#cb60-1010" aria-hidden="true" tabindex="-1"></a>@fig-gres_weibull plots the generalized residuals, that has been computed using the <span class="in">`micsr::gres`</span> function\idxfun{gres}{micsr}. The fit seems excellent for low values of the generalized residuals, and bad for values higher than 4 (about 2% of the sample).</span>
<span id="cb60-1011"><a href="#cb60-1011" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1014"><a href="#cb60-1014" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb60-1015"><a href="#cb60-1015" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Generalized residuals for the Weibull model"</span></span>
<span id="cb60-1016"><a href="#cb60-1016" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-gres_weibull</span></span>
<span id="cb60-1017"><a href="#cb60-1017" aria-hidden="true" tabindex="-1"></a>weib <span class="ot">&lt;-</span> <span class="fu">weibreg</span>(<span class="fu">Surv</span>(time, spell) <span class="sc">~</span> gender <span class="sc">+</span> age <span class="sc">+</span> <span class="fu">log</span>(wage),</span>
<span id="cb60-1018"><a href="#cb60-1018" aria-hidden="true" tabindex="-1"></a>                unteach)</span>
<span id="cb60-1019"><a href="#cb60-1019" aria-hidden="true" tabindex="-1"></a>un_gres <span class="ot">&lt;-</span> <span class="fu">gres</span>(weib)</span>
<span id="cb60-1020"><a href="#cb60-1020" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="fu">nobs</span>(weib)</span>
<span id="cb60-1021"><a href="#cb60-1021" aria-hidden="true" tabindex="-1"></a>int_haz <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">gres =</span> un_gres) <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(gres) <span class="sc">%&gt;%</span> </span>
<span id="cb60-1022"><a href="#cb60-1022" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(gres) <span class="sc">%&gt;%</span> </span>
<span id="cb60-1023"><a href="#cb60-1023" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cumn =</span> <span class="fu">cumsum</span>(n), <span class="at">esurv =</span> <span class="dv">1</span> <span class="sc">-</span> cumn <span class="sc">/</span> N, <span class="at">ech =</span> <span class="sc">-</span> <span class="fu">log</span>(esurv))</span>
<span id="cb60-1024"><a href="#cb60-1024" aria-hidden="true" tabindex="-1"></a>int_haz <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(gres, ech)) <span class="sc">+</span> <span class="fu">geom_step</span>() <span class="sc">+</span> </span>
<span id="cb60-1025"><a href="#cb60-1025" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dotted"</span>)</span>
<span id="cb60-1026"><a href="#cb60-1026" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb60-1027"><a href="#cb60-1027" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1028"><a href="#cb60-1028" aria-hidden="true" tabindex="-1"></a>The empirical moments are:</span>
<span id="cb60-1029"><a href="#cb60-1029" aria-hidden="true" tabindex="-1"></a>\idxfun{sapply}{base}</span>
<span id="cb60-1030"><a href="#cb60-1030" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1033"><a href="#cb60-1033" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb60-1034"><a href="#cb60-1034" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: true</span></span>
<span id="cb60-1035"><a href="#cb60-1035" aria-hidden="true" tabindex="-1"></a><span class="fu">sapply</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>, <span class="cf">function</span>(i) <span class="fu">mean</span>(un_gres <span class="sc">^</span> i))</span>
<span id="cb60-1036"><a href="#cb60-1036" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb60-1037"><a href="#cb60-1037" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1038"><a href="#cb60-1038" aria-hidden="true" tabindex="-1"></a>Conducting a conditional moment test, we get:</span>
<span id="cb60-1039"><a href="#cb60-1039" aria-hidden="true" tabindex="-1"></a>\idxfun{cmtest}{micsr}\idxfun{gaze}{micsr}</span>
<span id="cb60-1040"><a href="#cb60-1040" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{conditional moment test!Weibull model}</span>
<span id="cb60-1041"><a href="#cb60-1041" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1044"><a href="#cb60-1044" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb60-1045"><a href="#cb60-1045" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: true</span></span>
<span id="cb60-1046"><a href="#cb60-1046" aria-hidden="true" tabindex="-1"></a><span class="fu">cmtest</span>(weib, <span class="at">powers =</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>, <span class="at">opg =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> gaze</span>
<span id="cb60-1047"><a href="#cb60-1047" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb60-1048"><a href="#cb60-1048" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1049"><a href="#cb60-1049" aria-hidden="true" tabindex="-1"></a>and the hypothesis of a correct specification is therefore not rejected.</span>
<span id="cb60-1050"><a href="#cb60-1050" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">)</span><span class="co">]</span>{unemp<span class="sc">\_</span>teachers}{micsr.data}</span>
<span id="cb60-1051"><a href="#cb60-1051" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1052"><a href="#cb60-1052" aria-hidden="true" tabindex="-1"></a><span class="fu">### Weibull-Gamma model</span></span>
<span id="cb60-1053"><a href="#cb60-1053" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1054"><a href="#cb60-1054" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{Weibull-Gamma model|(}</span>
<span id="cb60-1055"><a href="#cb60-1055" aria-hidden="true" tabindex="-1"></a>To take into account the heterogeneity, we can use mixing distributions, either finite (taking for example two categories of individuals as in the introductory example) or infinite. We'll present in this section a model very widely used for its simplicity, the Weibull-Gamma model. Assume that the survival function for individual $n$ is: </span>
<span id="cb60-1056"><a href="#cb60-1056" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1057"><a href="#cb60-1057" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-1058"><a href="#cb60-1058" aria-hidden="true" tabindex="-1"></a>S(t_n\mid x_n,\nu_n) = e ^ {-\mu_n\nu_n t_n ^ \delta}</span>
<span id="cb60-1059"><a href="#cb60-1059" aria-hidden="true" tabindex="-1"></a>$$ {#eq-cond_surv_weibull}</span>
<span id="cb60-1060"><a href="#cb60-1060" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1061"><a href="#cb60-1061" aria-hidden="true" tabindex="-1"></a>where as usual, $\mu_n = e ^ {\alpha + \beta x_n}$. $\nu_n$ is an unobserved term that is specific to the individual. If it were observed, we would get the usual Weibull model. As it is unobserved, we have to consider the unconditional survival function, i.e., we have to integrate out @eq-cond_surv_weibull with $\nu$. Denoting $f$ the density of $\nu$, we get:</span>
<span id="cb60-1062"><a href="#cb60-1062" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1063"><a href="#cb60-1063" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-1064"><a href="#cb60-1064" aria-hidden="true" tabindex="-1"></a>S(t_n\mid x_n) = \int_0 ^ {+ \infty} e ^ {-\mu_n\nu t_n ^ \delta}f(\nu)d\nu</span>
<span id="cb60-1065"><a href="#cb60-1065" aria-hidden="true" tabindex="-1"></a>$$ {#eq-uncond_surv_weibull}</span>
<span id="cb60-1066"><a href="#cb60-1066" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1067"><a href="#cb60-1067" aria-hidden="true" tabindex="-1"></a>If the regression contains an intercept, the mean of $\nu$ is not identified and can be set to 1. The one-parameter Gamma distribution is:</span>
<span id="cb60-1068"><a href="#cb60-1068" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1069"><a href="#cb60-1069" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-1070"><a href="#cb60-1070" aria-hidden="true" tabindex="-1"></a>f(\nu) = \frac{\rho ^ \rho \nu ^ {\rho - 1} e ^  {-\rho \nu}}{\Gamma(\rho)}</span>
<span id="cb60-1071"><a href="#cb60-1071" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-1072"><a href="#cb60-1072" aria-hidden="true" tabindex="-1"></a>with $\mbox{E}(\nu) = 1$ and $\mbox{V}(\nu) = 1 / \rho$. Using this mixing distribution, we get:</span>
<span id="cb60-1073"><a href="#cb60-1073" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1074"><a href="#cb60-1074" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-1075"><a href="#cb60-1075" aria-hidden="true" tabindex="-1"></a>S(t_n\mid x_n) = \int_0 ^ {+ \infty} e ^ {-\mu_n\nu t_n ^ \delta}\frac{\rho ^ \rho \nu ^ {\rho - 1} e ^  {-\rho \nu}}{\Gamma(\rho)}d\nu=</span>
<span id="cb60-1076"><a href="#cb60-1076" aria-hidden="true" tabindex="-1"></a>\frac{\rho ^ \rho}{\Gamma(\rho)}\int_0 ^ {+ \infty} e ^ {-\nu(\mu_n\nu t_n ^ \delta + \rho)}\nu ^ {\rho - 1} d\nu</span>
<span id="cb60-1077"><a href="#cb60-1077" aria-hidden="true" tabindex="-1"></a>$$ </span>
<span id="cb60-1078"><a href="#cb60-1078" aria-hidden="true" tabindex="-1"></a>With the change of variable: $u = \nu(\mu_n\nu t_n ^ \delta + \rho)$:</span>
<span id="cb60-1079"><a href="#cb60-1079" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1080"><a href="#cb60-1080" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-1081"><a href="#cb60-1081" aria-hidden="true" tabindex="-1"></a>S(t_n\mid x_n) = \int_0 ^ {+\infty} e ^ {-\mu_n\nu t_n ^ \delta}\frac{\rho ^ \rho \nu ^ {\rho - 1} e ^  {-\rho \nu}}{\Gamma(\rho)}d\nu=</span>
<span id="cb60-1082"><a href="#cb60-1082" aria-hidden="true" tabindex="-1"></a>\frac{\rho ^ \rho}{\Gamma(\rho)}\frac{1}{(\mu_n t_n ^ \delta + \rho) ^ \rho}\int_0 ^ {+\infty} e ^ {-u}u ^ {\rho - 1} d\nu</span>
<span id="cb60-1083"><a href="#cb60-1083" aria-hidden="true" tabindex="-1"></a>$$ </span>
<span id="cb60-1084"><a href="#cb60-1084" aria-hidden="true" tabindex="-1"></a>which simplifies to: $\left(\frac{\mu_n t_n ^ \delta}{\rho} + 1\right) ^ {-\rho}$.</span>
<span id="cb60-1085"><a href="#cb60-1085" aria-hidden="true" tabindex="-1"></a>As $\rho$ is the inverse of the variance, it is simpler to parametrize the survival function with $\chi = 1 / \rho$, so that the hypothesis of homogeneity is simply $\chi = 0$:</span>
<span id="cb60-1086"><a href="#cb60-1086" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1087"><a href="#cb60-1087" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-1088"><a href="#cb60-1088" aria-hidden="true" tabindex="-1"></a>S(t_n\mid x_n) = \frac{1}{\left(1 + \chi\mu_n t_n ^ \delta\right) ^ \frac{1}{\chi}}</span>
<span id="cb60-1089"><a href="#cb60-1089" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-1090"><a href="#cb60-1090" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1091"><a href="#cb60-1091" aria-hidden="true" tabindex="-1"></a>The density is obtained as the opposite of the derivative of the survival function. The corresponding hazard function is:</span>
<span id="cb60-1092"><a href="#cb60-1092" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1093"><a href="#cb60-1093" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-1094"><a href="#cb60-1094" aria-hidden="true" tabindex="-1"></a>\theta(t_n \mid x_n) = </span>
<span id="cb60-1095"><a href="#cb60-1095" aria-hidden="true" tabindex="-1"></a>\frac{\delta  \mu_n t_n ^ {\delta - 1}}{1 + \chi\mu_n t_n ^ \delta}</span>
<span id="cb60-1096"><a href="#cb60-1096" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-1097"><a href="#cb60-1097" aria-hidden="true" tabindex="-1"></a>and the log-likelihood function is then:</span>
<span id="cb60-1098"><a href="#cb60-1098" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1099"><a href="#cb60-1099" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-1100"><a href="#cb60-1100" aria-hidden="true" tabindex="-1"></a>\ln L = \sum_{n=1} ^ n d_n \left<span class="co">[</span><span class="ot">\ln \delta + (\delta - 1)\ln t + \ln \mu_n \right</span><span class="co">]</span> - (1/\chi + d_n)\ln \left(1+\chi\mu_n t_n ^ \delta\right)</span>
<span id="cb60-1101"><a href="#cb60-1101" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-1102"><a href="#cb60-1102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1103"><a href="#cb60-1103" aria-hidden="true" tabindex="-1"></a>as $\chi \rightarrow 0$, $\ln \left(1 + \chi \mu_n t_n ^ \delta\right)\rightarrow \chi\mu_n t_n ^ \delta$ so that the Weibull is obtained as the limiting case where the variance of the mixing distribution tends to 0. </span>
<span id="cb60-1104"><a href="#cb60-1104" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{Weibull-Gamma model|)}</span>
<span id="cb60-1105"><a href="#cb60-1105" aria-hidden="true" tabindex="-1"></a>Remember from @tbl-acc_failure that, for the Weibull AFT model, the scale parameter was $\sigma = <span class="in">`r round(un_wei$scale, 2)`</span>$, which corresponds to $\delta = 1 / <span class="in">`r round(un_wei$scale, 2)`</span> = <span class="in">`r round(1/ un_wei$scale, 2)`</span>$ and therefore to an increasing hazard rate. The <span class="in">`micsr::weibreg`</span> function estimates the Weibull-Gamma model when the <span class="in">`mixing`</span> argument is set to <span class="in">`TRUE`</span>:</span>
<span id="cb60-1106"><a href="#cb60-1106" aria-hidden="true" tabindex="-1"></a>\idxfun{weibreg}{micsr}\idxfun{gaze}{micsr}\idxfun{update}{stats}\idxfun{Surv}{survival}</span>
<span id="cb60-1107"><a href="#cb60-1107" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">(</span><span class="co">]</span>{unemp<span class="sc">\_</span>teachers}{micsr.data}</span>
<span id="cb60-1108"><a href="#cb60-1108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1111"><a href="#cb60-1111" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb60-1112"><a href="#cb60-1112" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: mixing_gamma</span></span>
<span id="cb60-1113"><a href="#cb60-1113" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: true</span></span>
<span id="cb60-1114"><a href="#cb60-1114" aria-hidden="true" tabindex="-1"></a>weib <span class="ot">&lt;-</span> <span class="fu">weibreg</span>(<span class="fu">Surv</span>(time, spell) <span class="sc">~</span> gender <span class="sc">+</span> age <span class="sc">+</span> <span class="fu">log</span>(wage),</span>
<span id="cb60-1115"><a href="#cb60-1115" aria-hidden="true" tabindex="-1"></a>                  unteach)</span>
<span id="cb60-1116"><a href="#cb60-1116" aria-hidden="true" tabindex="-1"></a>weib <span class="sc">%&gt;%</span> <span class="fu">gaze</span>(<span class="at">coef =</span> <span class="st">"shape"</span>)</span>
<span id="cb60-1117"><a href="#cb60-1117" aria-hidden="true" tabindex="-1"></a>gweib <span class="ot">&lt;-</span> <span class="fu">update</span>(weib, <span class="at">mixing =</span> <span class="cn">TRUE</span>)</span>
<span id="cb60-1118"><a href="#cb60-1118" aria-hidden="true" tabindex="-1"></a>gweib <span class="sc">%&gt;%</span> <span class="fu">gaze</span>(<span class="at">coef =</span> <span class="fu">c</span>(<span class="st">"shape"</span>, <span class="st">"var"</span>))</span>
<span id="cb60-1119"><a href="#cb60-1119" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb60-1120"><a href="#cb60-1120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1121"><a href="#cb60-1121" aria-hidden="true" tabindex="-1"></a>The supplementary parameter ($\chi$) is called <span class="in">`"var"`</span> and is highly significantly different from 0, so that the hypothesis of homogeneity is highly rejected. Note also that the shape parameter is much higher than previously.</span>
<span id="cb60-1122"><a href="#cb60-1122" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">)</span><span class="co">]</span>{unemp<span class="sc">\_</span>teachers}{micsr.data}</span>
<span id="cb60-1123"><a href="#cb60-1123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1124"><a href="#cb60-1124" aria-hidden="true" tabindex="-1"></a><span class="fu">## Other models {#sec-misc_duration}</span></span>
<span id="cb60-1125"><a href="#cb60-1125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1126"><a href="#cb60-1126" aria-hidden="true" tabindex="-1"></a><span class="fu">### Multi-state models</span></span>
<span id="cb60-1127"><a href="#cb60-1127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1128"><a href="#cb60-1128" aria-hidden="true" tabindex="-1"></a>Consider now the case where several events are possible, for example two</span>
<span id="cb60-1129"><a href="#cb60-1129" aria-hidden="true" tabindex="-1"></a>events denoted $a$ and $b$. Let $\tilde{t}_n^a$ and $\tilde{t}_n^b$ be the</span>
<span id="cb60-1130"><a href="#cb60-1130" aria-hidden="true" tabindex="-1"></a>duration for individual $n$ for the two events $a$ and $b$. The observed</span>
<span id="cb60-1131"><a href="#cb60-1131" aria-hidden="true" tabindex="-1"></a>duration is $t_n$. Three cases should be considered:</span>
<span id="cb60-1132"><a href="#cb60-1132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1133"><a href="#cb60-1133" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>$t_n &lt; \mbox{min}(\tilde{t}_n^a, \tilde{t}_n^b)$ (which means that</span>
<span id="cb60-1134"><a href="#cb60-1134" aria-hidden="true" tabindex="-1"></a>    $t_n &lt; \tilde{t}_n ^a$ and $t_n &lt; \tilde{t}_n^b$), the observation</span>
<span id="cb60-1135"><a href="#cb60-1135" aria-hidden="true" tabindex="-1"></a>    is then censored,</span>
<span id="cb60-1136"><a href="#cb60-1136" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>$t_n = \mbox{min}(\tilde{t}_n^a, \tilde{t}_n^b)$, the event is:</span>
<span id="cb60-1137"><a href="#cb60-1137" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>$a$ if $\tilde{t}_n ^ a &lt; \tilde{t}_n ^ b$,</span>
<span id="cb60-1138"><a href="#cb60-1138" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>$b$ if $\tilde{t}_n ^ a &gt; \tilde{t}_n ^ b$.</span>
<span id="cb60-1139"><a href="#cb60-1139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1140"><a href="#cb60-1140" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{competing risk model|(}</span>
<span id="cb60-1141"><a href="#cb60-1141" aria-hidden="true" tabindex="-1"></a>The **competing risk** model is a very simple multi-state model which extends the Cox proportional hazard model to the multi-state case. Consider for example state $a$. For an observation $n$, if the event $a$ is observed, we have an observation of a complete spell. Otherwise, if the event is $b$, this means that $t_n = \tilde{t}_n^b &lt; \tilde{t}_n^a$ and the observation is censored as far as we are interested in state $a$. We can therefore estimate the competing risk model with two independent Cox PH models:</span>
<span id="cb60-1142"><a href="#cb60-1142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1143"><a href="#cb60-1143" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>for the first, the event is $a$ and censoring occurs either if the observation is censored or if the event is $b$,</span>
<span id="cb60-1144"><a href="#cb60-1144" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>for the second, the event is $b$ and censoring occurs either if the observation is censored or if the event is $a$,</span>
<span id="cb60-1145"><a href="#cb60-1145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1146"><a href="#cb60-1146" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{competing risk model|)}</span>
<span id="cb60-1147"><a href="#cb60-1147" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- For example, [@BIER:CARV:07]\index[author]{Bierens}\index[author]{Carvalho} consider the duration between prison release and a new crime for former prisoners. The event can take the form of a felony or a misdemeanor and the duration is censored if no new crime has been committed during the period of survey. The survey stops on April 16, 1988 and, as the date of release depends on the individuals, so does the censoring time. The sample contains $16355$  individuals from $11$ states. --&gt;</span></span>
<span id="cb60-1148"><a href="#cb60-1148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1149"><a href="#cb60-1149" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">(</span><span class="co">]</span>{recall}{micsr.data}</span>
<span id="cb60-1150"><a href="#cb60-1150" aria-hidden="true" tabindex="-1"></a>Consider the <span class="in">`recall`</span> data set, initially used by @KATZ:86\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Katz} and later by @SUEY:95\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Sueyoshi}. It contains 1045 spells of unemployment in 1980.</span>
<span id="cb60-1151"><a href="#cb60-1151" aria-hidden="true" tabindex="-1"></a>\idxfun{head}{utils}</span>
<span id="cb60-1152"><a href="#cb60-1152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1155"><a href="#cb60-1155" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb60-1156"><a href="#cb60-1156" aria-hidden="true" tabindex="-1"></a>recall <span class="sc">%&gt;%</span> <span class="fu">print</span>(<span class="at">n =</span> <span class="dv">3</span>)</span>
<span id="cb60-1157"><a href="#cb60-1157" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb60-1158"><a href="#cb60-1158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1159"><a href="#cb60-1159" aria-hidden="true" tabindex="-1"></a>The analysis of @KATZ:86\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Katz} showed that an important transition from unemployment was a recall from the previous employer. The <span class="in">`end`</span> covariate indicates the different modalities of transition:</span>
<span id="cb60-1160"><a href="#cb60-1160" aria-hidden="true" tabindex="-1"></a>\idxfun{count}{dplyr}</span>
<span id="cb60-1161"><a href="#cb60-1161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1164"><a href="#cb60-1164" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb60-1165"><a href="#cb60-1165" aria-hidden="true" tabindex="-1"></a>recall <span class="sc">%&gt;%</span> <span class="fu">count</span>(end)</span>
<span id="cb60-1166"><a href="#cb60-1166" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb60-1167"><a href="#cb60-1167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1168"><a href="#cb60-1168" aria-hidden="true" tabindex="-1"></a>We consider the <span class="in">`new-job`</span> and <span class="in">`recall`</span> modalities as an indication of a complete spell. The model for unemployment spells is estimated using as covariates the age, sex, years of education, number of dependents (<span class="in">`nb`</span>), a dummy for unemployment insurance during the spell (<span class="in">`ui`</span>), marital status, county unemployment rate (<span class="in">`unemp`</span>), wife's employment status, a dummy for home ownership and factors for occupation and industry. The competing risk model can then be estimated using the following two calls to <span class="in">`coxph`</span>:</span>
<span id="cb60-1169"><a href="#cb60-1169" aria-hidden="true" tabindex="-1"></a>\idxfun{coxph}{survival}\idxfun{Surv}{survival}</span>
<span id="cb60-1170"><a href="#cb60-1170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1173"><a href="#cb60-1173" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb60-1174"><a href="#cb60-1174" aria-hidden="true" tabindex="-1"></a>un_recall <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(duration, end <span class="sc">==</span> <span class="st">"recall"</span>) <span class="sc">~</span> age <span class="sc">+</span> sex <span class="sc">+</span> educ <span class="sc">+</span></span>
<span id="cb60-1175"><a href="#cb60-1175" aria-hidden="true" tabindex="-1"></a>                     race <span class="sc">+</span> unemp <span class="sc">+</span> wifemp <span class="sc">+</span> homeowner <span class="sc">+</span> </span>
<span id="cb60-1176"><a href="#cb60-1176" aria-hidden="true" tabindex="-1"></a>                     occupation <span class="sc">+</span> industry, recall)</span>
<span id="cb60-1177"><a href="#cb60-1177" aria-hidden="true" tabindex="-1"></a>un_new <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(duration, end <span class="sc">==</span> <span class="st">"new-job"</span>) <span class="sc">~</span> age <span class="sc">+</span> sex <span class="sc">+</span> educ <span class="sc">+</span> </span>
<span id="cb60-1178"><a href="#cb60-1178" aria-hidden="true" tabindex="-1"></a>                  race <span class="sc">+</span> unemp <span class="sc">+</span> wifemp <span class="sc">+</span> homeowner <span class="sc">+</span> </span>
<span id="cb60-1179"><a href="#cb60-1179" aria-hidden="true" tabindex="-1"></a>                  occupation <span class="sc">+</span> industry, recall)</span>
<span id="cb60-1180"><a href="#cb60-1180" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb60-1181"><a href="#cb60-1181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1182"><a href="#cb60-1182" aria-hidden="true" tabindex="-1"></a>where the <span class="in">`event`</span> argument is a dummy equal to <span class="in">`TRUE`</span> when <span class="in">`end`</span> equals <span class="in">`"recall"`</span> for the first regression and <span class="in">`"new-job"`</span> for the second regression. The competing risk model can be estimated more simply with a simple call to <span class="in">`coxph`</span> when the <span class="in">`event`</span> argument is a factor for which the first level indicates censored observations. In the <span class="in">`recall`</span> data set, the first level is <span class="in">`"new-job"`</span>, so that we need to change the order of the levels using <span class="in">`relevel`</span>:</span>
<span id="cb60-1183"><a href="#cb60-1183" aria-hidden="true" tabindex="-1"></a>\idxfun{pull}{dplyr}\idxfun{relevel}{stats}\idxfun{mutate}{dplyr}</span>
<span id="cb60-1184"><a href="#cb60-1184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1187"><a href="#cb60-1187" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb60-1188"><a href="#cb60-1188" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: true</span></span>
<span id="cb60-1189"><a href="#cb60-1189" aria-hidden="true" tabindex="-1"></a>recall <span class="sc">%&gt;%</span> <span class="fu">pull</span>(end) <span class="sc">%&gt;%</span> levels</span>
<span id="cb60-1190"><a href="#cb60-1190" aria-hidden="true" tabindex="-1"></a>recall <span class="ot">&lt;-</span> recall <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">end =</span> <span class="fu">relevel</span>(end, <span class="st">"censored"</span>))</span>
<span id="cb60-1191"><a href="#cb60-1191" aria-hidden="true" tabindex="-1"></a>recall <span class="sc">%&gt;%</span> <span class="fu">pull</span>(end) <span class="sc">%&gt;%</span> levels</span>
<span id="cb60-1192"><a href="#cb60-1192" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb60-1193"><a href="#cb60-1193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1194"><a href="#cb60-1194" aria-hidden="true" tabindex="-1"></a>Moreover, the <span class="in">`id`</span> argument is mandatory. This is the individual identifier and it is really useful only when there are several observations for the same individuals, which is not the case here. We therefore create an <span class="in">`idspell`</span> variable before proceeding to the estimation. To save space, we use a very limited subset of covariates.</span>
<span id="cb60-1195"><a href="#cb60-1195" aria-hidden="true" tabindex="-1"></a>\idxfun{add<span class="sc">\_</span>column}{tibble}\idxfun{nrow}{base}\idxfun{coxph}{survival}\idxfun{Surv}{survival}</span>
<span id="cb60-1196"><a href="#cb60-1196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1199"><a href="#cb60-1199" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb60-1200"><a href="#cb60-1200" aria-hidden="true" tabindex="-1"></a>recall <span class="ot">&lt;-</span> recall <span class="sc">%&gt;%</span> </span>
<span id="cb60-1201"><a href="#cb60-1201" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_column</span>(<span class="at">id_spell =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(recall), <span class="at">.before =</span> <span class="dv">1</span>)</span>
<span id="cb60-1202"><a href="#cb60-1202" aria-hidden="true" tabindex="-1"></a><span class="fu">coxph</span>(<span class="fu">Surv</span>(duration, end) <span class="sc">~</span> age <span class="sc">+</span> sex, <span class="at">data =</span> recall, <span class="at">id =</span> id_spell)</span>
<span id="cb60-1203"><a href="#cb60-1203" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb60-1204"><a href="#cb60-1204" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">)</span><span class="co">]</span>{recall}{micsr.data}</span>
<span id="cb60-1205"><a href="#cb60-1205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1206"><a href="#cb60-1206" aria-hidden="true" tabindex="-1"></a><span class="fu">### Grouped data</span></span>
<span id="cb60-1207"><a href="#cb60-1207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1208"><a href="#cb60-1208" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{grouped data|(}</span>
<span id="cb60-1209"><a href="#cb60-1209" aria-hidden="true" tabindex="-1"></a>Duration is often recorded not as a continuous variable, but as a set of intervals. For example, unemployment duration may not be measured in days, but in months or years. In this case, the model must be written in terms of discrete time. Denote $t_0, t_1, t_2, ... t_T$ (with $t_0=0$) and $a$ the interval defined by $t_{a-1} \leq t&lt; t_a$. The survival at time $t_a$ is such that </span>
<span id="cb60-1210"><a href="#cb60-1210" aria-hidden="true" tabindex="-1"></a>$- \ln S(t_a) = \int_0 ^ {t_a} \theta(s) ds$. Therefore, for the $a$^th^ interval, we have:</span>
<span id="cb60-1211"><a href="#cb60-1211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1212"><a href="#cb60-1212" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-1213"><a href="#cb60-1213" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>\ln S(t_a) + \ln S(t_{a-1}) = - \ln \frac{S(t_a)}{S(t_{a-1})} =  \int _{t_{a-1}} ^ {t_a} \theta(s) ds</span>
<span id="cb60-1214"><a href="#cb60-1214" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-1215"><a href="#cb60-1215" aria-hidden="true" tabindex="-1"></a>The hazard in the $a$^th^ interval is the probability of an event in this interval (which is the difference in survival) divided by the initial value of the survival:</span>
<span id="cb60-1216"><a href="#cb60-1216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1217"><a href="#cb60-1217" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-1218"><a href="#cb60-1218" aria-hidden="true" tabindex="-1"></a>\theta_a = \frac{S(t_{a-1}) - S(t_a)}{S(t_{a-1})}= 1 - e ^ {-\int _{t_{a-1}} ^ {t_a} \theta(s) ds}</span>
<span id="cb60-1219"><a href="#cb60-1219" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-1220"><a href="#cb60-1220" aria-hidden="true" tabindex="-1"></a>Now assume a proportional hazard: $\theta (s) =  \lambda(s) e^ {\gamma^\top z_s}$. Denoting $\delta_a = \ln \int_{t_{a-1}} ^ {t_a} \lambda(s) d_s$, we get:</span>
<span id="cb60-1221"><a href="#cb60-1221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1222"><a href="#cb60-1222" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-1223"><a href="#cb60-1223" aria-hidden="true" tabindex="-1"></a>\theta_a = 1 - e ^ {- e ^ {\delta_a + \gamma ^ \top z_{t_{a-1}}}} = F(\delta_a + \gamma ^ \top z_{t_{a-1}})</span>
<span id="cb60-1224"><a href="#cb60-1224" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-1225"><a href="#cb60-1225" aria-hidden="true" tabindex="-1"></a>Where $F$ is the CDF of the extreme value type 1 distribution. Note that the covariates may be time-varying from one interval to another. In a given interval, values of the covariates are measured at the beginning of the interval.</span>
<span id="cb60-1226"><a href="#cb60-1226" aria-hidden="true" tabindex="-1"></a>The discrete survival function at the beginning of this interval is:</span>
<span id="cb60-1227"><a href="#cb60-1227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1228"><a href="#cb60-1228" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-1229"><a href="#cb60-1229" aria-hidden="true" tabindex="-1"></a>S_{t_{a-1}} = \prod_{s = 1} ^ {a-1} (1 - \theta_s) = \prod_{s = 1} ^ {a-1} (1 - F(\delta_s + \beta ^ \top x_{t_{s-1}}))</span>
<span id="cb60-1230"><a href="#cb60-1230" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-1231"><a href="#cb60-1231" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{grouped data!binomial model|(}</span>
<span id="cb60-1232"><a href="#cb60-1232" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{binomial model!duration data|(}</span>
<span id="cb60-1233"><a href="#cb60-1233" aria-hidden="true" tabindex="-1"></a>The probability of a transition in the $a$^th^ interval is the product of the discrete hazard for interval $a$ and the value of the survival function at the beginning of this interval (i.e., $t_{a-1}$). For observation $n$, the contribution to the likelihood is then:</span>
<span id="cb60-1234"><a href="#cb60-1234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1235"><a href="#cb60-1235" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-1236"><a href="#cb60-1236" aria-hidden="true" tabindex="-1"></a>F(\delta_{a_n} + \gamma ^ \top z_{nt_{a-1}})\prod_{s = 1} ^ {a_n-1} (1 - F(\delta_s + \gamma ^ \top z_{nt_{s-1}}))</span>
<span id="cb60-1237"><a href="#cb60-1237" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-1238"><a href="#cb60-1238" aria-hidden="true" tabindex="-1"></a>Finally, the log-likelihood is, denoting $F_{ns} = F(\delta_s + \gamma ^ \top z_{nt_{s-1}})$ and $y_{ns}$ a dummy equal to 1 if $n$ has a transition in the $s$^th^ interval and 0 otherwise:</span>
<span id="cb60-1239"><a href="#cb60-1239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1240"><a href="#cb60-1240" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-1241"><a href="#cb60-1241" aria-hidden="true" tabindex="-1"></a>\begin{array}{rcl}</span>
<span id="cb60-1242"><a href="#cb60-1242" aria-hidden="true" tabindex="-1"></a>\ln L &amp;=&amp; \sum_{n=1} ^ N \left<span class="co">[</span><span class="ot">\sum_{s=1} ^ {a_{n-1}}\ln (1 - F_{ns}) +\ln F_{na_n}\right</span><span class="co">]</span><span class="sc">\\</span></span>
<span id="cb60-1243"><a href="#cb60-1243" aria-hidden="true" tabindex="-1"></a>&amp;=&amp; \sum_{n=1} ^ N \sum_{s=1} ^ {a_n}\left<span class="co">[</span><span class="ot">(1 - y_{ns})\ln (1 - F_{ns}) +y_{ns}\ln F_{ns}\right</span><span class="co">]</span></span>
<span id="cb60-1244"><a href="#cb60-1244" aria-hidden="true" tabindex="-1"></a>\end{array}</span>
<span id="cb60-1245"><a href="#cb60-1245" aria-hidden="true" tabindex="-1"></a>$$ {#eq-binomial_duration}</span>
<span id="cb60-1246"><a href="#cb60-1246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1247"><a href="#cb60-1247" aria-hidden="true" tabindex="-1"></a>This is an unbalanced pooled binomial model, the number of observation for each individual being the index of the interval of its transition. @eq-binomial_duration deals correctly with right-censored observation as, in this case, $y_{na_n} = 0$ and the correct term ($1 - F_{na_n}$) is introduced in the log-likelihood. </span>
<span id="cb60-1248"><a href="#cb60-1248" aria-hidden="true" tabindex="-1"></a>A specific set of $\delta_s$ parameters can be estimated, which enables to retrieve from the estimation the shape of the hazard function.</span>
<span id="cb60-1249"><a href="#cb60-1249" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{grouped data!binomial model|)}</span>
<span id="cb60-1250"><a href="#cb60-1250" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{binomial model!duration data|)}</span>
<span id="cb60-1251"><a href="#cb60-1251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1252"><a href="#cb60-1252" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{grouped data!ordered model|(}</span>
<span id="cb60-1253"><a href="#cb60-1253" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{ordered model!duration data|(}</span>
<span id="cb60-1254"><a href="#cb60-1254" aria-hidden="true" tabindex="-1"></a>An alternative to this binomial model is to start with the proportional hazard formulation: $\theta(t) = \lambda(t) e ^ {-\gamma ^ \top z}$^<span class="co">[</span><span class="ot">Note that we used $-\gamma$ instead of $\gamma$, like for the AFT models, for a reason that will be clear later in this section.</span><span class="co">]</span> and to compute the integrated hazard: $\int_0 ^ t\theta(s)d s = e ^ {-\gamma ^ \top z_t}\int_0 ^ t \lambda(s)ds = e ^ {\delta_t - \gamma ^ \top z_t}$ where $\gamma_t$ is defined as: $\ln \int_0 ^ t \lambda(s)ds$. As the integrated hazard is the opposite of the logarithm of the survival function, we have: $S(t) = e ^ {- e ^ {\delta_t - \gamma ^ \top z_t}}$. The probability of transition in the $a$^th^ interval is $S(t_{a-1}) - S(t_a) = F(t_a) - F(t_{a - 1})$, with $F(z) = 1  - e ^ {- e ^ z}$ the CDF of the extreme value type 1 distribution. Therefore, the log-likelihood is:</span>
<span id="cb60-1255"><a href="#cb60-1255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1256"><a href="#cb60-1256" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-1257"><a href="#cb60-1257" aria-hidden="true" tabindex="-1"></a>\ln L = \sum_{n=1} ^ N \sum_{s = 1} ^ {A} y_{ns} \ln\left<span class="co">[</span><span class="ot">F(\delta_{t_s} - \gamma ^ \top z_{nt_s}) - F(\delta_{t_{s-1}} - \gamma ^ \top z_{nt_{s-1}})\right</span><span class="co">]</span></span>
<span id="cb60-1258"><a href="#cb60-1258" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-1259"><a href="#cb60-1259" aria-hidden="true" tabindex="-1"></a>which is the ordered model (see @eq-probord), $\delta_t$ being a set of threshold. With censored observations, denoting $d_n$ a dummy for complete observations, the log-likelihood becomes:</span>
<span id="cb60-1260"><a href="#cb60-1260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1261"><a href="#cb60-1261" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-1262"><a href="#cb60-1262" aria-hidden="true" tabindex="-1"></a>\begin{array}{rl}</span>
<span id="cb60-1263"><a href="#cb60-1263" aria-hidden="true" tabindex="-1"></a>\ln L = \sum_{n=1} ^ N y_{ns}\sum_{s = 1} ^ {A}&amp; \left(d_n\ln\left<span class="co">[</span><span class="ot">F(\delta_{t_{a_n}} - \gamma ^ \top z_n) - F(\delta_{t_{a_n-1}} - \gamma ^ \top z_n)\right</span><span class="co">]</span>\right.<span class="sc">\\</span></span>
<span id="cb60-1264"><a href="#cb60-1264" aria-hidden="true" tabindex="-1"></a>&amp;+ \left.(1 - d_n) \ln\left<span class="co">[</span><span class="ot">1 - F(\delta_{t_{a_n}} - \gamma ^ \top z_n)\right</span><span class="co">]</span>\right)</span>
<span id="cb60-1265"><a href="#cb60-1265" aria-hidden="true" tabindex="-1"></a>\end{array}</span>
<span id="cb60-1266"><a href="#cb60-1266" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-1267"><a href="#cb60-1267" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{grouped data!ordered model|)}</span>
<span id="cb60-1268"><a href="#cb60-1268" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{ordered model!duration data|)}</span>
<span id="cb60-1269"><a href="#cb60-1269" aria-hidden="true" tabindex="-1"></a>\idxfun{ordreg}{micsr}\idxfun{Surv}{survival}\idxfun{coef}{stats}</span>
<span id="cb60-1270"><a href="#cb60-1270" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">(</span><span class="co">]</span>{recall}{micsr.data}</span>
<span id="cb60-1271"><a href="#cb60-1271" aria-hidden="true" tabindex="-1"></a>With the <span class="in">`micsr::ordreg`</span> function, the response can be a <span class="in">`Surv`</span> objects in order to take into account censored observations.</span>
<span id="cb60-1272"><a href="#cb60-1272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1275"><a href="#cb60-1275" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb60-1276"><a href="#cb60-1276" aria-hidden="true" tabindex="-1"></a>form_ord <span class="ot">&lt;-</span> <span class="fu">Surv</span>(duration, end <span class="sc">==</span> <span class="st">"recall"</span>) <span class="sc">~</span> age <span class="sc">+</span> sex <span class="sc">+</span> educ <span class="sc">+</span> race <span class="sc">+</span> </span>
<span id="cb60-1277"><a href="#cb60-1277" aria-hidden="true" tabindex="-1"></a>  nb <span class="sc">+</span> ui <span class="sc">+</span> marital <span class="sc">+</span> unemp <span class="sc">+</span> wifemp <span class="sc">+</span> homeowner <span class="sc">+</span> occupation <span class="sc">+</span> industry</span>
<span id="cb60-1278"><a href="#cb60-1278" aria-hidden="true" tabindex="-1"></a>recall_ord <span class="ot">&lt;-</span> <span class="fu">ordreg</span>(form_ord, recall, <span class="at">link =</span> <span class="st">"cloglog"</span>)</span>
<span id="cb60-1279"><a href="#cb60-1279" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb60-1280"><a href="#cb60-1280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1281"><a href="#cb60-1281" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- basehaz_ord &lt;- coef(recall_ord, subset = "threshold") --&gt;</span></span>
<span id="cb60-1282"><a href="#cb60-1282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1283"><a href="#cb60-1283" aria-hidden="true" tabindex="-1"></a>To estimate the binomial model, we first need to construct the pooled sample, i.e., to get one line for one period for every spell. We first create a data frame with only the identifiers for the individual and the spell and the duration. We then nest the data frame by the two identifiers. This results in a new column called <span class="in">`data`</span> that contains, for each observation a one-line one-column tibble containing the duration of the spell. Using <span class="in">`mutate`</span>, we then create a new column in <span class="in">`data`</span> containing integers from 1 to the given value of <span class="in">`duration`</span> for each observation. We then ungroup and remove the duration column.</span>
<span id="cb60-1284"><a href="#cb60-1284" aria-hidden="true" tabindex="-1"></a>\idxfun{unique}{base}\idxfun{select}{dplyr}\idxfun{nest<span class="sc">\_</span>by}{dplyr}\idxfun{unnest}{tidyr}</span>
<span id="cb60-1285"><a href="#cb60-1285" aria-hidden="true" tabindex="-1"></a>\idxfun{ungroup}{dplyr}</span>
<span id="cb60-1286"><a href="#cb60-1286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1289"><a href="#cb60-1289" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb60-1290"><a href="#cb60-1290" aria-hidden="true" tabindex="-1"></a>durations <span class="ot">&lt;-</span> recall<span class="sc">$</span>duration <span class="sc">%&gt;%</span> unique</span>
<span id="cb60-1291"><a href="#cb60-1291" aria-hidden="true" tabindex="-1"></a>pooled <span class="ot">&lt;-</span> recall <span class="sc">%&gt;%</span> </span>
<span id="cb60-1292"><a href="#cb60-1292" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(spell, id, duration) <span class="sc">%&gt;%</span> </span>
<span id="cb60-1293"><a href="#cb60-1293" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest_by</span>(spell, id) <span class="sc">%&gt;%</span> </span>
<span id="cb60-1294"><a href="#cb60-1294" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">period =</span> <span class="fu">list</span>(<span class="dv">1</span><span class="sc">:</span>data<span class="sc">$</span>duration)) <span class="sc">%&gt;%</span> </span>
<span id="cb60-1295"><a href="#cb60-1295" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(<span class="at">cols =</span> <span class="fu">c</span>(data, period)) <span class="sc">%&gt;%</span> </span>
<span id="cb60-1296"><a href="#cb60-1296" aria-hidden="true" tabindex="-1"></a>  ungroup <span class="sc">%&gt;%</span> </span>
<span id="cb60-1297"><a href="#cb60-1297" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span> duration)</span>
<span id="cb60-1298"><a href="#cb60-1298" aria-hidden="true" tabindex="-1"></a>pooled <span class="sc">%&gt;%</span> <span class="fu">print</span>(<span class="at">n =</span> <span class="dv">3</span>)</span>
<span id="cb60-1299"><a href="#cb60-1299" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb60-1300"><a href="#cb60-1300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1301"><a href="#cb60-1301" aria-hidden="true" tabindex="-1"></a>There are some periods without observations of an event or a censoring. Observations for these periods should be removed:</span>
<span id="cb60-1302"><a href="#cb60-1302" aria-hidden="true" tabindex="-1"></a>\idxfun{pull}{dplyr}\idxfun{unique}{base}\idxfun{filter}{dplyr}</span>
<span id="cb60-1303"><a href="#cb60-1303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1306"><a href="#cb60-1306" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb60-1307"><a href="#cb60-1307" aria-hidden="true" tabindex="-1"></a>durations <span class="ot">&lt;-</span> recall <span class="sc">%&gt;%</span> <span class="fu">pull</span>(duration) <span class="sc">%&gt;%</span> unique</span>
<span id="cb60-1308"><a href="#cb60-1308" aria-hidden="true" tabindex="-1"></a>pooled <span class="ot">&lt;-</span> pooled <span class="sc">%&gt;%</span> <span class="fu">filter</span>(period <span class="sc">%in%</span> durations)</span>
<span id="cb60-1309"><a href="#cb60-1309" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb60-1310"><a href="#cb60-1310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1311"><a href="#cb60-1311" aria-hidden="true" tabindex="-1"></a>Finally we join this tibble with the initial tibble, and we create the event variable (<span class="in">`end`</span> should be <span class="in">`"recall"`</span> and the period should be equal to the duration).</span>
<span id="cb60-1312"><a href="#cb60-1312" aria-hidden="true" tabindex="-1"></a>\idxfun{left<span class="sc">\_</span>join}{dplyr}\idxfun{mutate}{dplyr}</span>
<span id="cb60-1313"><a href="#cb60-1313" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb60-1316"><a href="#cb60-1316" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb60-1317"><a href="#cb60-1317" aria-hidden="true" tabindex="-1"></a>recall_pooled <span class="ot">&lt;-</span> pooled <span class="sc">%&gt;%</span> </span>
<span id="cb60-1318"><a href="#cb60-1318" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(recall, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"spell"</span>, <span class="st">"id"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb60-1319"><a href="#cb60-1319" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">event =</span> (end <span class="sc">==</span> <span class="st">"recall"</span> <span class="sc">&amp;</span> period <span class="sc">==</span> duration))</span>
<span id="cb60-1320"><a href="#cb60-1320" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb60-1321"><a href="#cb60-1321" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb60-1322"><a href="#cb60-1322" aria-hidden="true" tabindex="-1"></a>We then estimate different flavors of binomial models, using the same formula than for the ordered model, except that the response is now <span class="in">`event`</span> and that dummies for periods are added:</span>
<span id="cb60-1323"><a href="#cb60-1323" aria-hidden="true" tabindex="-1"></a>\idxfun{update}{stats}\idxfun{factor}{base}\idxfun{glm}{stats}\idxfun{binomial}{stats}</span>
<span id="cb60-1324"><a href="#cb60-1324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1327"><a href="#cb60-1327" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb60-1328"><a href="#cb60-1328" aria-hidden="true" tabindex="-1"></a>form_binom <span class="ot">&lt;-</span> <span class="fu">update</span>(form_ord, event <span class="sc">~</span> . <span class="sc">+</span> <span class="fu">factor</span>(period))</span>
<span id="cb60-1329"><a href="#cb60-1329" aria-hidden="true" tabindex="-1"></a>recall_binom <span class="ot">&lt;-</span> <span class="fu">glm</span>(form_binom, <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"cloglog"</span>), </span>
<span id="cb60-1330"><a href="#cb60-1330" aria-hidden="true" tabindex="-1"></a>                    <span class="at">data =</span> recall_pooled)</span>
<span id="cb60-1331"><a href="#cb60-1331" aria-hidden="true" tabindex="-1"></a>recall_probit <span class="ot">&lt;-</span> <span class="fu">update</span>(recall_binom, <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"probit"</span>))</span>
<span id="cb60-1332"><a href="#cb60-1332" aria-hidden="true" tabindex="-1"></a>recall_logit <span class="ot">&lt;-</span> <span class="fu">update</span>(recall_probit, <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>))</span>
<span id="cb60-1333"><a href="#cb60-1333" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb60-1334"><a href="#cb60-1334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1335"><a href="#cb60-1335" aria-hidden="true" tabindex="-1"></a>Results are presented in @tbl-recall_results.</span>
<span id="cb60-1336"><a href="#cb60-1336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1339"><a href="#cb60-1339" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb60-1340"><a href="#cb60-1340" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb60-1341"><a href="#cb60-1341" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-recall_results</span></span>
<span id="cb60-1342"><a href="#cb60-1342" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Estimation of the grouped duration model for the recall data set"</span></span>
<span id="cb60-1343"><a href="#cb60-1343" aria-hidden="true" tabindex="-1"></a>rows <span class="ot">&lt;-</span> <span class="fu">tribble</span>( <span class="sc">~</span> term, <span class="sc">~</span> <span class="st">`</span><span class="at">ordered cloglog</span><span class="st">`</span>, <span class="sc">~</span> <span class="st">`</span><span class="at">binomial cloglog</span><span class="st">`</span>, <span class="sc">~</span> probit,</span>
<span id="cb60-1344"><a href="#cb60-1344" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"Industry indicators"</span>, <span class="st">"Yes"</span>, <span class="st">"Yes"</span>, <span class="st">"Yes"</span>,</span>
<span id="cb60-1345"><a href="#cb60-1345" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"Occup. indicators"</span>, <span class="st">"Yes"</span>, <span class="st">"Yes"</span>, <span class="st">"Yes"</span>)</span>
<span id="cb60-1346"><a href="#cb60-1346" aria-hidden="true" tabindex="-1"></a><span class="fu">attr</span>(rows, <span class="st">"position"</span>) <span class="ot">&lt;-</span> <span class="dv">11</span><span class="sc">:</span><span class="dv">12</span></span>
<span id="cb60-1347"><a href="#cb60-1347" aria-hidden="true" tabindex="-1"></a>modelsummary<span class="sc">::</span><span class="fu">msummary</span>(<span class="fu">list</span>(<span class="st">"ordered cloglog"</span> <span class="ot">=</span> recall_ord, <span class="st">"binomial cloglog"</span> <span class="ot">=</span> recall_binom, <span class="st">"probit"</span> <span class="ot">=</span> recall_probit),</span>
<span id="cb60-1348"><a href="#cb60-1348" aria-hidden="true" tabindex="-1"></a>                       <span class="at">coef_map =</span> <span class="fu">c</span>(<span class="at">age =</span> <span class="st">"age"</span>, <span class="at">sexfemale =</span> <span class="st">"female"</span>, <span class="at">educ =</span> <span class="st">"educ"</span>, </span>
<span id="cb60-1349"><a href="#cb60-1349" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">"racenonwhite"</span> <span class="ot">=</span> <span class="st">"non-white"</span>, <span class="st">"nb"</span> <span class="ot">=</span> <span class="st">"No of dependents"</span>,</span>
<span id="cb60-1350"><a href="#cb60-1350" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">"uiyes"</span> <span class="ot">=</span> <span class="st">"UI receipt"</span>, <span class="st">"maritalmarried"</span> <span class="ot">=</span> <span class="st">"married"</span>,</span>
<span id="cb60-1351"><a href="#cb60-1351" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">"unemp"</span> <span class="ot">=</span> <span class="st">"Area unemploy."</span>, <span class="st">"wifempyes"</span> <span class="ot">=</span> <span class="st">"Wife works"</span>, <span class="at">homeowneryes =</span> <span class="st">"Homeowner"</span>),</span>
<span id="cb60-1352"><a href="#cb60-1352" aria-hidden="true" tabindex="-1"></a>                       <span class="at">estimate =</span> <span class="st">"{estimate} ({std.error})"</span>, <span class="at">statistic =</span> <span class="cn">NULL</span>,</span>
<span id="cb60-1353"><a href="#cb60-1353" aria-hidden="true" tabindex="-1"></a>                       <span class="at">add_rows =</span> rows,</span>
<span id="cb60-1354"><a href="#cb60-1354" aria-hidden="true" tabindex="-1"></a>                       <span class="at">output =</span> <span class="st">"kableExtra"</span></span>
<span id="cb60-1355"><a href="#cb60-1355" aria-hidden="true" tabindex="-1"></a>                       )</span>
<span id="cb60-1356"><a href="#cb60-1356" aria-hidden="true" tabindex="-1"></a>basehas_binom <span class="ot">&lt;-</span> <span class="fu">coef</span>(recall_binom)[<span class="fu">grep</span>(<span class="st">"factor"</span>, </span>
<span id="cb60-1357"><a href="#cb60-1357" aria-hidden="true" tabindex="-1"></a>                                         <span class="fu">names</span>(<span class="fu">coef</span>(recall_probit)))]</span>
<span id="cb60-1358"><a href="#cb60-1358" aria-hidden="true" tabindex="-1"></a>haz_binom <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="fu">exp</span>(<span class="fu">c</span>(<span class="dv">0</span>, basehas_binom) <span class="sc">-</span> <span class="fl">3.57</span>))</span>
<span id="cb60-1359"><a href="#cb60-1359" aria-hidden="true" tabindex="-1"></a><span class="co">#, coef_omit = "(factor|industry|occupation|Intercept)")</span></span>
<span id="cb60-1360"><a href="#cb60-1360" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb60-1361"><a href="#cb60-1361" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{grouped data|)}</span>
<span id="cb60-1362"><a href="#cb60-1362" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">)</span><span class="co">]</span>{recall}{micsr.data}</span>
<span id="cb60-1363"><a href="#cb60-1363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1364"><a href="#cb60-1364" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb60-1365"><a href="#cb60-1365" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \prod_{s = 0} ^ {a_n-1} (1 - F(\ln \lambda_{os} + \beta ^ \top x_{nt_{s-1}})) F(\ln \lambda_{oa_n} + \beta ^ \top x_{nt_{a-1}}) ^ {d_n} (1 - F(\ln \lambda_{oa_n} + \beta ^ \top x_{nt_{a-1}})) ^ {1 - d_n} --&gt;</span></span>
<span id="cb60-1366"><a href="#cb60-1366" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb60-1367"><a href="#cb60-1367" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Finally, the log-likelihood is, denoting $F_{ns} = F(\ln \lambda_{os} + \beta ^ \top x_{nt_{s-1}})$ --&gt;</span></span>
<span id="cb60-1368"><a href="#cb60-1368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1369"><a href="#cb60-1369" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb60-1370"><a href="#cb60-1370" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \ln L = \sum_{n=1} ^ N \left[\sum_{s=0} ^ {a_{n}}\ln (1 - F_{ns}) +d_n\left(\ln F_{na_{n-1}} - \ln(1 - F_{na_n})\right)\right] --&gt;</span></span>
<span id="cb60-1371"><a href="#cb60-1371" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb60-1372"><a href="#cb60-1372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1373"><a href="#cb60-1373" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- https://www.itl.nist.gov/div898/handbook/eda/section3/eda366g.htm --&gt;</span></span>
<span id="cb60-1374"><a href="#cb60-1374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1375"><a href="#cb60-1375" aria-hidden="true" tabindex="-1"></a><span class="fu">### Interval regression</span></span>
<span id="cb60-1376"><a href="#cb60-1376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1377"><a href="#cb60-1377" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{interval regession model|(}</span>
<span id="cb60-1378"><a href="#cb60-1378" aria-hidden="true" tabindex="-1"></a>Sometimes, the exact value of the response is not known, but only an</span>
<span id="cb60-1379"><a href="#cb60-1379" aria-hidden="true" tabindex="-1"></a>interval that contains the value. For example, income is often</span>
<span id="cb60-1380"><a href="#cb60-1380" aria-hidden="true" tabindex="-1"></a>indicated this way in individual surveys:</span>
<span id="cb60-1381"><a href="#cb60-1381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1382"><a href="#cb60-1382" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>less than $10,000,</span>
<span id="cb60-1383"><a href="#cb60-1383" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>from $10 to $20,000 dollars,</span>
<span id="cb60-1384"><a href="#cb60-1384" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>from $20 to $50,000 dollars,</span>
<span id="cb60-1385"><a href="#cb60-1385" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>more than $50,000 dollars.</span>
<span id="cb60-1386"><a href="#cb60-1386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1387"><a href="#cb60-1387" aria-hidden="true" tabindex="-1"></a>Note that, in this case, there is no bound for the last category, so</span>
<span id="cb60-1388"><a href="#cb60-1388" aria-hidden="true" tabindex="-1"></a>that we also have a right-censoring problem.</span>
<span id="cb60-1389"><a href="#cb60-1389" aria-hidden="true" tabindex="-1"></a>Denote $\mu_l$ and $\mu_u$ as the lower and the upper bounds of the</span>
<span id="cb60-1390"><a href="#cb60-1390" aria-hidden="true" tabindex="-1"></a>interval and $f$ the density of the distribution of the variable of</span>
<span id="cb60-1391"><a href="#cb60-1391" aria-hidden="true" tabindex="-1"></a>interest. The three different cases are presented in</span>
<span id="cb60-1392"><a href="#cb60-1392" aria-hidden="true" tabindex="-1"></a>@fig-intervreg.</span>
<span id="cb60-1393"><a href="#cb60-1393" aria-hidden="true" tabindex="-1"></a>The variable of interest is represented on the horizontal axis and its</span>
<span id="cb60-1394"><a href="#cb60-1394" aria-hidden="true" tabindex="-1"></a>distribution by the density curve. The lower and upper bounds</span>
<span id="cb60-1395"><a href="#cb60-1395" aria-hidden="true" tabindex="-1"></a>are respectively denoted $\mu_l$ and $\mu_u$. For @fig-intervreg (a),</span>
<span id="cb60-1396"><a href="#cb60-1396" aria-hidden="true" tabindex="-1"></a>we have $\mu_l = 0$, so that the interval is left-censored. In @fig-intervreg (b), both the lower and the upper bounds are</span>
<span id="cb60-1397"><a href="#cb60-1397" aria-hidden="true" tabindex="-1"></a>observed. Finally, in @fig-intervreg (c), only the lower bound is</span>
<span id="cb60-1398"><a href="#cb60-1398" aria-hidden="true" tabindex="-1"></a>observed and the interval is therefore right-censored.</span>
<span id="cb60-1399"><a href="#cb60-1399" aria-hidden="true" tabindex="-1"></a>Denoting $F(y_n;\theta_n)$ the cumulative density function for $y$,</span>
<span id="cb60-1400"><a href="#cb60-1400" aria-hidden="true" tabindex="-1"></a>the general formula for the probability that enters the likelihood</span>
<span id="cb60-1401"><a href="#cb60-1401" aria-hidden="true" tabindex="-1"></a>function for one observation is: $F(\mu^u_n ; \theta_n) - F(\mu^l_n ;</span>
<span id="cb60-1402"><a href="#cb60-1402" aria-hidden="true" tabindex="-1"></a>\theta_n)$ which simplifies respectively to $F(\mu^l_n)$ and $1 -</span>
<span id="cb60-1403"><a href="#cb60-1403" aria-hidden="true" tabindex="-1"></a>F(\mu^u_n)$ for the cases where $\mu_l = 0$ (left-censored interval)</span>
<span id="cb60-1404"><a href="#cb60-1404" aria-hidden="true" tabindex="-1"></a>and $\mu_u = \infty$ (right-censored interval).</span>
<span id="cb60-1405"><a href="#cb60-1405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1406"><a href="#cb60-1406" aria-hidden="true" tabindex="-1"></a>::: {#fig-intervreg layout="[<span class="co">[</span><span class="ot">-5,40,-10,40,-5</span><span class="co">]</span>, <span class="co">[</span><span class="ot">-30,40,-30</span><span class="co">]</span>]"}</span>
<span id="cb60-1407"><a href="#cb60-1407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1408"><a href="#cb60-1408" aria-hidden="true" tabindex="-1"></a><span class="al">![Left-censored interval](./tikz/fig/intervalreg2)</span>{#fig-hanno}</span>
<span id="cb60-1409"><a href="#cb60-1409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1410"><a href="#cb60-1410" aria-hidden="true" tabindex="-1"></a><span class="al">![Uncensored interval](./tikz/fig/intervalreg)</span>{#fig-surus}</span>
<span id="cb60-1411"><a href="#cb60-1411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1412"><a href="#cb60-1412" aria-hidden="true" tabindex="-1"></a><span class="al">![Right-censored interval](./tikz/fig/intervalreg3)</span>{#fig-hanno}</span>
<span id="cb60-1413"><a href="#cb60-1413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1414"><a href="#cb60-1414" aria-hidden="true" tabindex="-1"></a>Interval regression</span>
<span id="cb60-1415"><a href="#cb60-1415" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb60-1416"><a href="#cb60-1416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1417"><a href="#cb60-1417" aria-hidden="true" tabindex="-1"></a>Popular choices of distribution functions are the log-normal and the</span>
<span id="cb60-1418"><a href="#cb60-1418" aria-hidden="true" tabindex="-1"></a>Weibull distribution. For the first, a simple parametrization is to set</span>
<span id="cb60-1419"><a href="#cb60-1419" aria-hidden="true" tabindex="-1"></a>the mean of $\ln y$ equal to $\gamma ^ \top z_n$ and its standard</span>
<span id="cb60-1420"><a href="#cb60-1420" aria-hidden="true" tabindex="-1"></a>deviation to $\sigma$. The probability is then:</span>
<span id="cb60-1421"><a href="#cb60-1421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1422"><a href="#cb60-1422" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-1423"><a href="#cb60-1423" aria-hidden="true" tabindex="-1"></a>\Phi\left(\frac{\ln \mu_n ^ u - \gamma ^ \top z_n}{\sigma}\right) - </span>
<span id="cb60-1424"><a href="#cb60-1424" aria-hidden="true" tabindex="-1"></a>\Phi\left(\frac{\ln \mu_n ^ l - \gamma ^ \top z_n}{\sigma}\right)</span>
<span id="cb60-1425"><a href="#cb60-1425" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-1426"><a href="#cb60-1426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1427"><a href="#cb60-1427" aria-hidden="true" tabindex="-1"></a>For the Weibull distribution, the cumulative density function is:</span>
<span id="cb60-1428"><a href="#cb60-1428" aria-hidden="true" tabindex="-1"></a>$F(y ; \lambda, \delta) = 1 - e ^ { -\left(\frac{y}{\lambda}\right) ^ \delta}$</span>
<span id="cb60-1429"><a href="#cb60-1429" aria-hidden="true" tabindex="-1"></a>and the expected value is proportional to $\lambda$ ($\mbox{E}(y) =</span>
<span id="cb60-1430"><a href="#cb60-1430" aria-hidden="true" tabindex="-1"></a>\lambda \Gamma(1 + 1 / \delta)$). Setting $\lambda_n = e^ {\gamma ^ \top z_n}$,</span>
<span id="cb60-1431"><a href="#cb60-1431" aria-hidden="true" tabindex="-1"></a>we get:</span>
<span id="cb60-1432"><a href="#cb60-1432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1433"><a href="#cb60-1433" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-1434"><a href="#cb60-1434" aria-hidden="true" tabindex="-1"></a>e^{-\delta e^{(\ln \mu_n ^ l- \gamma^\top z_n)}} - e^{- \delta e^{(\ln \mu_n ^ u - \gamma^\top z_n)}}</span>
<span id="cb60-1435"><a href="#cb60-1435" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb60-1436"><a href="#cb60-1436" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{interval regession model|)}</span>
<span id="cb60-1437"><a href="#cb60-1437" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">(</span><span class="co">]</span>{kakadu}{micsr.data}</span>
<span id="cb60-1438"><a href="#cb60-1438" aria-hidden="true" tabindex="-1"></a>An interesting case of interval response occurs in ecological</span>
<span id="cb60-1439"><a href="#cb60-1439" aria-hidden="true" tabindex="-1"></a>economics, for which one of the methods used to estimate the value of</span>
<span id="cb60-1440"><a href="#cb60-1440" aria-hidden="true" tabindex="-1"></a>non-market resources is contingent valuation. Consider for example</span>
<span id="cb60-1441"><a href="#cb60-1441" aria-hidden="true" tabindex="-1"></a>the <span class="in">`kakadu`</span> data set, which was used by @CARS:WILK:IMBE:94\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Carson}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Wilks}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Imber} and</span>
<span id="cb60-1442"><a href="#cb60-1442" aria-hidden="true" tabindex="-1"></a>@WERN:99\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Werner}. The study concerns the Kakadu Conservation Zone, a part of the Kakadu National Park, and the survey aimed to measure the willingness to pay to preserve this zone from mining. The double-bounded,</span>
<span id="cb60-1443"><a href="#cb60-1443" aria-hidden="true" tabindex="-1"></a>discrete-choice elicitation method of @HANE:91\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Hanemann} is used; a respondent</span>
<span id="cb60-1444"><a href="#cb60-1444" aria-hidden="true" tabindex="-1"></a>is asked whether they are willing to pay a pre-chosen randomly assigned</span>
<span id="cb60-1445"><a href="#cb60-1445" aria-hidden="true" tabindex="-1"></a>amount to preserve the zone. If the answer is yes (no), they are asked</span>
<span id="cb60-1446"><a href="#cb60-1446" aria-hidden="true" tabindex="-1"></a>whether he is willing to pay a higher (lower) pre-chosen amount. Four</span>
<span id="cb60-1447"><a href="#cb60-1447" aria-hidden="true" tabindex="-1"></a>sets of dollar amounts were used ($<span class="co">[</span><span class="ot">A: 100, 250, 50</span><span class="co">]</span>, <span class="co">[</span><span class="ot">B: 50, 100, 20</span><span class="co">]</span>,</span>
<span id="cb60-1448"><a href="#cb60-1448" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">C: 20, 50, 5</span><span class="co">]</span>, \mbox{ and } <span class="co">[</span><span class="ot">D:5, 20, 2</span><span class="co">]</span>$). The response is therefore</span>
<span id="cb60-1449"><a href="#cb60-1449" aria-hidden="true" tabindex="-1"></a>a factor with four modalities: (no, yes), (yes, no), (no, no) and (yes,</span>
<span id="cb60-1450"><a href="#cb60-1450" aria-hidden="true" tabindex="-1"></a>yes). For the first two levels, the interval is closed as the willingness</span>
<span id="cb60-1451"><a href="#cb60-1451" aria-hidden="true" tabindex="-1"></a>to pay is in the interval formed by the two successive amounts. For</span>
<span id="cb60-1452"><a href="#cb60-1452" aria-hidden="true" tabindex="-1"></a>(no, no), the willing to pay is lower than the second amount and for</span>
<span id="cb60-1453"><a href="#cb60-1453" aria-hidden="true" tabindex="-1"></a>(yes, yes), it is greater than the second amount. In the <span class="in">`kakadu`</span> data set, the</span>
<span id="cb60-1454"><a href="#cb60-1454" aria-hidden="true" tabindex="-1"></a>lower and the upper bonds are respectively <span class="in">`lower`</span> and <span class="in">`upper`</span>, and</span>
<span id="cb60-1455"><a href="#cb60-1455" aria-hidden="true" tabindex="-1"></a><span class="in">`NA`</span>s indicate unbounded willingness to pay. The interval</span>
<span id="cb60-1456"><a href="#cb60-1456" aria-hidden="true" tabindex="-1"></a>regression model can be estimated using the <span class="in">`survival::survreg`</span></span>
<span id="cb60-1457"><a href="#cb60-1457" aria-hidden="true" tabindex="-1"></a>function. The response should be a <span class="in">`Surv`</span> object with the <span class="in">`time`</span> and <span class="in">`time2`</span> arguments set to the lower and to the upper bounds and the <span class="in">`type`</span> argument set to</span>
<span id="cb60-1458"><a href="#cb60-1458" aria-hidden="true" tabindex="-1"></a><span class="in">`"interval2"`</span>. The set of covariates is the one used by @WERN:99,</span>
<span id="cb60-1459"><a href="#cb60-1459" aria-hidden="true" tabindex="-1"></a>table 4, p. 484\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Werner}. The results are presented in table @tbl-intkakadu.</span>
<span id="cb60-1460"><a href="#cb60-1460" aria-hidden="true" tabindex="-1"></a>\idxfun{mutate}{dplyr}\idxfun{survreg}{survival}\idxfun{Surv}{survival}\idxfun{update}{stats}</span>
<span id="cb60-1461"><a href="#cb60-1461" aria-hidden="true" tabindex="-1"></a>\idxfun{msummary}{modelsummary}\idxfun{list}{base}</span>
<span id="cb60-1462"><a href="#cb60-1462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1463"><a href="#cb60-1463" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb60-1464"><a href="#cb60-1464" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-intkakadu</span></span>
<span id="cb60-1465"><a href="#cb60-1465" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Interval regression for the Kakadu data set"</span></span>
<span id="cb60-1466"><a href="#cb60-1466" aria-hidden="true" tabindex="-1"></a>kakadu <span class="ot">&lt;-</span> kakadu <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">upper =</span> <span class="fu">ifelse</span>(upper <span class="sc">==</span> <span class="dv">999</span>, <span class="cn">NA</span>, upper),</span>
<span id="cb60-1467"><a href="#cb60-1467" aria-hidden="true" tabindex="-1"></a>                           <span class="at">lower =</span> <span class="fu">ifelse</span>(lower <span class="sc">==</span> <span class="dv">0</span>, <span class="cn">NA</span>, lower))</span>
<span id="cb60-1468"><a href="#cb60-1468" aria-hidden="true" tabindex="-1"></a>kak_weil <span class="ot">&lt;-</span> <span class="fu">survreg</span>(<span class="fu">Surv</span>(<span class="at">time =</span> <span class="fu">log</span>(lower), <span class="at">time2 =</span> <span class="fu">log</span>(upper), </span>
<span id="cb60-1469"><a href="#cb60-1469" aria-hidden="true" tabindex="-1"></a>                         <span class="at">type =</span> <span class="st">"interval2"</span>) <span class="sc">~</span> jobs <span class="sc">+</span> lowrisk <span class="sc">+</span> </span>
<span id="cb60-1470"><a href="#cb60-1470" aria-hidden="true" tabindex="-1"></a>                      aboriginal <span class="sc">+</span> finben <span class="sc">+</span> mineparks <span class="sc">+</span> moreparks <span class="sc">+</span> </span>
<span id="cb60-1471"><a href="#cb60-1471" aria-hidden="true" tabindex="-1"></a>                      envcon <span class="sc">+</span> age <span class="sc">+</span> income <span class="sc">+</span> major, </span>
<span id="cb60-1472"><a href="#cb60-1472" aria-hidden="true" tabindex="-1"></a>                    kakadu, <span class="at">dist =</span> <span class="st">"weibull"</span>)</span>
<span id="cb60-1473"><a href="#cb60-1473" aria-hidden="true" tabindex="-1"></a>kak_ln <span class="ot">&lt;-</span> <span class="fu">update</span>(kak_weil, <span class="at">dist =</span> <span class="st">"lognormal"</span>)</span>
<span id="cb60-1474"><a href="#cb60-1474" aria-hidden="true" tabindex="-1"></a>modelsummary<span class="sc">::</span><span class="fu">msummary</span>(<span class="fu">list</span>(<span class="at">Weibull =</span> kak_weil, <span class="st">`</span><span class="at">Log-normal</span><span class="st">`</span> <span class="ot">=</span> kak_ln), </span>
<span id="cb60-1475"><a href="#cb60-1475" aria-hidden="true" tabindex="-1"></a>                       <span class="at">output =</span> <span class="st">"kableExtra"</span>)</span>
<span id="cb60-1476"><a href="#cb60-1476" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb60-1477"><a href="#cb60-1477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1478"><a href="#cb60-1478" aria-hidden="true" tabindex="-1"></a>In this example, the log-normal model fits slightly better the data</span>
<span id="cb60-1479"><a href="#cb60-1479" aria-hidden="true" tabindex="-1"></a>than the Weibull model. The <span class="in">`predict`</span> methods enables to obtain the</span>
<span id="cb60-1480"><a href="#cb60-1480" aria-hidden="true" tabindex="-1"></a>fitted values (or the predicted values if a new data frame is</span>
<span id="cb60-1481"><a href="#cb60-1481" aria-hidden="true" tabindex="-1"></a>provided). The argument <span class="in">`type`</span> can be set to its default value <span class="in">`"response"`</span> to get</span>
<span id="cb60-1482"><a href="#cb60-1482" aria-hidden="true" tabindex="-1"></a>fitted value of the response or to <span class="in">`"link"`</span> to obtain the linear</span>
<span id="cb60-1483"><a href="#cb60-1483" aria-hidden="true" tabindex="-1"></a>predictor. For example, the mean and the median values of the</span>
<span id="cb60-1484"><a href="#cb60-1484" aria-hidden="true" tabindex="-1"></a>willingness to pay are, for the two models:</span>
<span id="cb60-1485"><a href="#cb60-1485" aria-hidden="true" tabindex="-1"></a>\idxfun{median}{stats}\idxfun{predict}{stats}</span>
<span id="cb60-1486"><a href="#cb60-1486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1487"><a href="#cb60-1487" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb60-1488"><a href="#cb60-1488" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: true</span></span>
<span id="cb60-1489"><a href="#cb60-1489" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="fu">mean</span>(<span class="fu">predict</span>(kak_weil)), <span class="fu">median</span>(<span class="fu">predict</span>(kak_weil)))</span>
<span id="cb60-1490"><a href="#cb60-1490" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="fu">mean</span>(<span class="fu">predict</span>(kak_ln)), <span class="fu">median</span>(<span class="fu">predict</span>(kak_ln)))</span>
<span id="cb60-1491"><a href="#cb60-1491" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb60-1492"><a href="#cb60-1492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1493"><a href="#cb60-1493" aria-hidden="true" tabindex="-1"></a>\idxfun{tibble}{tibble}\idxfun{predict}{stats}\idxfun{pivot<span class="sc">\_</span>longer}{tidyr}</span>
<span id="cb60-1494"><a href="#cb60-1494" aria-hidden="true" tabindex="-1"></a>\idxfun{ggplot}{ggplot2}\idxfun{aes}{ggplot2}\idxfun{geom<span class="sc">\_</span>density}{ggplot2}\idxfun{coord<span class="sc">\_</span>cartesian}{ggplot2}</span>
<span id="cb60-1495"><a href="#cb60-1495" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb60-1496"><a href="#cb60-1496" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb60-1497"><a href="#cb60-1497" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb60-1498"><a href="#cb60-1498" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">weibul =</span> <span class="fu">predict</span>(kak_weil), <span class="at">lognorm =</span> <span class="fu">predict</span>(kak_ln)) <span class="sc">%&gt;%</span></span>
<span id="cb60-1499"><a href="#cb60-1499" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="at">names_to =</span> <span class="st">"distribution"</span>, <span class="at">values_to =</span> <span class="st">"y"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb60-1500"><a href="#cb60-1500" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(y)) <span class="sc">+</span> <span class="fu">geom_density</span>(<span class="fu">aes</span>(<span class="at">linetype =</span> distribution)) <span class="sc">+</span></span>
<span id="cb60-1501"><a href="#cb60-1501" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">5E03</span>))</span>
<span id="cb60-1502"><a href="#cb60-1502" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb60-1503"><a href="#cb60-1503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1504"><a href="#cb60-1504" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">)</span><span class="co">]</span>{kakadu}{micsr.data}</span>
<span id="cb60-1505"><a href="#cb60-1505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1506"><a href="#cb60-1506" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval = FALSE, echo = FALSE}</span></span>
<span id="cb60-1507"><a href="#cb60-1507" aria-hidden="true" tabindex="-1"></a>va <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">model.response</span>(<span class="fu">model.frame</span>(kak_weil))) <span class="sc">%&gt;%</span> <span class="fu">bind_cols</span>(kak_weil<span class="sc">$</span>linear.predictors) <span class="sc">%&gt;%</span> <span class="fu">set_names</span>(<span class="fu">c</span>(<span class="st">"time1"</span>, <span class="st">"time2"</span>, <span class="st">"status"</span>, <span class="st">"lp"</span>))</span>
<span id="cb60-1508"><a href="#cb60-1508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1509"><a href="#cb60-1509" aria-hidden="true" tabindex="-1"></a>mylp <span class="ot">&lt;-</span> <span class="fu">drop</span>(<span class="fu">model.matrix</span>(kak_weil) <span class="sc">%*%</span> <span class="fu">coef</span>(kak_weil))</span>
<span id="cb60-1510"><a href="#cb60-1510" aria-hidden="true" tabindex="-1"></a>k <span class="ot">&lt;-</span> <span class="fu">exp</span>(kak_weil<span class="sc">$</span>icoef[<span class="dv">2</span>])</span>
<span id="cb60-1511"><a href="#cb60-1511" aria-hidden="true" tabindex="-1"></a>k <span class="ot">&lt;-</span> kak_weil<span class="sc">$</span>scale</span>
<span id="cb60-1512"><a href="#cb60-1512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1513"><a href="#cb60-1513" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">exp</span>(mylp) <span class="sc">^</span> (<span class="sc">-</span> k) <span class="sc">*</span> <span class="fu">gamma</span>(<span class="dv">1</span> <span class="sc">+</span> k))</span>
<span id="cb60-1514"><a href="#cb60-1514" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">exp</span>(<span class="sc">-</span> mylp) <span class="sc">^</span> (<span class="sc">-</span> k) <span class="sc">*</span> <span class="fu">gamma</span>(<span class="dv">1</span> <span class="sc">+</span> k))</span>
<span id="cb60-1515"><a href="#cb60-1515" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">exp</span>(mylp)   <span class="sc">^</span> (<span class="sc">-</span> k) <span class="sc">*</span> (<span class="fu">log</span>(<span class="dv">2</span>)<span class="sc">/</span><span class="dv">2</span>) <span class="sc">^</span> k)</span>
<span id="cb60-1516"><a href="#cb60-1516" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">exp</span>(<span class="sc">-</span> mylp) <span class="sc">^</span> (<span class="sc">-</span> k) <span class="sc">*</span> (<span class="fu">log</span>(<span class="dv">2</span>)<span class="sc">/</span><span class="dv">2</span>) <span class="sc">^</span> k)</span>
<span id="cb60-1517"><a href="#cb60-1517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1518"><a href="#cb60-1518" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">exp</span>(mylp)   <span class="sc">^</span> (<span class="sc">-</span> <span class="dv">1</span> <span class="sc">/</span> k) <span class="sc">*</span> (<span class="fu">log</span>(<span class="dv">2</span><span class="sc">/</span><span class="dv">2</span>)) <span class="sc">^</span> (<span class="dv">1</span> <span class="sc">/</span> k))</span>
<span id="cb60-1519"><a href="#cb60-1519" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">exp</span>(<span class="sc">-</span> mylp) <span class="sc">^</span> (<span class="sc">-</span> <span class="dv">1</span> <span class="sc">/</span> k) <span class="sc">*</span> (<span class="fu">log</span>(<span class="dv">2</span>)<span class="sc">/</span><span class="dv">2</span>) <span class="sc">^</span> (<span class="dv">1</span> <span class="sc">/</span> k))</span>
<span id="cb60-1520"><a href="#cb60-1520" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">exp</span>(mylp) <span class="sc">^</span> (<span class="sc">-</span> k) <span class="sc">*</span> <span class="fu">gamma</span>(<span class="dv">1</span> <span class="sc">+</span> k))</span>
<span id="cb60-1521"><a href="#cb60-1521" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1522"><a href="#cb60-1522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1523"><a href="#cb60-1523" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1524"><a href="#cb60-1524" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">predict</span>(kak_weil))</span>
<span id="cb60-1525"><a href="#cb60-1525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1526"><a href="#cb60-1526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1527"><a href="#cb60-1527" aria-hidden="true" tabindex="-1"></a>kakadu <span class="sc">%&gt;%</span> <span class="fu">select</span>(lower, upper) <span class="sc">%&gt;%</span></span>
<span id="cb60-1528"><a href="#cb60-1528" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_column</span>(<span class="at">lp_ln =</span> kak_ln<span class="sc">$</span>linear.predictors,</span>
<span id="cb60-1529"><a href="#cb60-1529" aria-hidden="true" tabindex="-1"></a>               <span class="at">lp_we =</span> kak_weil<span class="sc">$</span>linear.predictors) <span class="sc">%&gt;%</span></span>
<span id="cb60-1530"><a href="#cb60-1530" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">dp_ln =</span> <span class="fu">exp</span>(lp_ln <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> kak_ln<span class="sc">$</span>scale <span class="sc">^</span> <span class="dv">2</span>),</span>
<span id="cb60-1531"><a href="#cb60-1531" aria-hidden="true" tabindex="-1"></a>           <span class="at">dp_we =</span> <span class="fu">exp</span>( lp_we <span class="sc">/</span> kak_weil<span class="sc">$</span>scale) <span class="sc">*</span> <span class="fu">gamma</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="dv">1</span> <span class="sc">/</span> kak_weil<span class="sc">$</span>scale),</span>
<span id="cb60-1532"><a href="#cb60-1532" aria-hidden="true" tabindex="-1"></a>           <span class="at">dpmed_we =</span> <span class="fu">exp</span>(lp_we) <span class="sc">*</span> <span class="fu">log</span>(<span class="dv">2</span>) <span class="sc">^</span> (<span class="dv">1</span> <span class="sc">/</span> kak_weil<span class="sc">$</span>scale)) <span class="sc">%&gt;%</span></span>
<span id="cb60-1533"><a href="#cb60-1533" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">mean_ln =</span> <span class="fu">mean</span>(dp_ln), <span class="at">med_ln =</span> <span class="fu">median</span>(dp_ln),</span>
<span id="cb60-1534"><a href="#cb60-1534" aria-hidden="true" tabindex="-1"></a>              <span class="at">mean_we =</span> <span class="fu">mean</span>(dp_we), <span class="at">med_we =</span> <span class="fu">median</span>(dp_we))</span>
<span id="cb60-1535"><a href="#cb60-1535" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1536"><a href="#cb60-1536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-1537"><a href="#cb60-1537" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



</body></html>