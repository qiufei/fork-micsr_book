<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.475">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Microeconometrics with R - 9&nbsp; Spatial econometrics</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../special_responses.html" rel="next">
<link href="../chapters/treateff.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script><script src="../site_libs/kePrint/kePrint.js"></script><link href="../site_libs/lightable/lightable.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }"><div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Spatial econometrics</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Microeconometrics with R</a> 
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">Preface</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../OLS.html" class="sidebar-item-text sidebar-link">Ordinary least squares estimator</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/simple_regression.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Simple linear regression model</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/simple_regression_properties.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Statistical properties of the simple linear estimator</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/multiple_regression.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Multiple regression model</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/coefficients.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Interpretation of the Coefficients</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../beyond_OLS.html" class="sidebar-item-text sidebar-link">Beyond the OLS estimator</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/maximum_likelihood.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Maximum likelihood estimator</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/non_spherical.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Non-spherical disturbances</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/endogeneity.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Endogeneity</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/treateff.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Treatment effect</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/spatial.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Spatial econometrics</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../special_responses.html" class="sidebar-item-text sidebar-link">Special responses</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/binomial.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Binomial models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/tobit.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Censored and truncated models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/count.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Count data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/duration.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Duration models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/rum.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Discrete choice models</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../references.html" class="sidebar-item-text sidebar-link">References</a>
  </div>
</li>
    </ul>
</div>
</nav><!-- margin-sidebar --><div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li>
<a href="#sec-simple_features" id="toc-sec-simple_features" class="nav-link active" data-scroll-target="#sec-simple_features"><span class="toc-section-number">9.1</span>  Simple features</a>
  <ul class="collapse">
<li><a href="#sec-struct_sf" id="toc-sec-struct_sf" class="nav-link" data-scroll-target="#sec-struct_sf">Structure of a simple feature</a></li>
  <li><a href="#sec-sf_computation" id="toc-sec-sf_computation" class="nav-link" data-scroll-target="#sec-sf_computation">Computation on sf objects</a></li>
  </ul>
</li>
  <li>
<a href="#two-examples" id="toc-two-examples" class="nav-link" data-scroll-target="#two-examples"><span class="toc-section-number">9.2</span>  Two examples</a>
  <ul class="collapse">
<li><a href="#agglomeration-economies-and-diseconomies" id="toc-agglomeration-economies-and-diseconomies" class="nav-link" data-scroll-target="#agglomeration-economies-and-diseconomies">Agglomeration economies and diseconomies</a></li>
  <li><a href="#sec-solow_model" id="toc-sec-solow_model" class="nav-link" data-scroll-target="#sec-solow_model">Solow model</a></li>
  </ul>
</li>
  <li>
<a href="#sec-spatial_correlation" id="toc-sec-spatial_correlation" class="nav-link" data-scroll-target="#sec-spatial_correlation"><span class="toc-section-number">9.3</span>  Spatial correlation</a>
  <ul class="collapse">
<li><a href="#contiguity-and-weights" id="toc-contiguity-and-weights" class="nav-link" data-scroll-target="#contiguity-and-weights">Contiguity and weights</a></li>
  <li><a href="#tests-for-spatial-correlation" id="toc-tests-for-spatial-correlation" class="nav-link" data-scroll-target="#tests-for-spatial-correlation">Tests for spatial correlation</a></li>
  <li><a href="#local-spatial-correlation" id="toc-local-spatial-correlation" class="nav-link" data-scroll-target="#local-spatial-correlation">Local spatial correlation</a></li>
  </ul>
</li>
  <li>
<a href="#sec-spatial_models" id="toc-sec-spatial_models" class="nav-link" data-scroll-target="#sec-spatial_models"><span class="toc-section-number">9.4</span>  Spatial econometrics</a>
  <ul class="collapse">
<li><a href="#spatial-models-and-tests" id="toc-spatial-models-and-tests" class="nav-link" data-scroll-target="#spatial-models-and-tests">Spatial models and tests</a></li>
  <li><a href="#application-to-the-growth-model" id="toc-application-to-the-growth-model" class="nav-link" data-scroll-target="#application-to-the-growth-model">Application to the growth model</a></li>
  </ul>
</li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span id="sec-spatial_econometrics" class="quarto-section-identifier d-none d-lg-block"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Spatial econometrics</span></span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header><div class="cell">

</div>
<p>Spatial econometrics is a very dynamic field in modern econometrics. Geolocated data are now frequently available, even when the data doesn’t concern geographic entities like countries, regions or towns, but households or firms. From their geographic coordinates, one is able to define for every observation a set of neighbors, and the interactions between neighbors can then be taken into account. There are two very different types of geographical data: vectors and rasters. A vector is a point or a set of points that define a line. A raster is a grid that contains the value of one variable (for example, a numeric indicating the elevation or a factor indicating land use). Relatively recently, two <strong>R</strong> packages have emerged that provide plenty of function that enables to deal easily with vectors and rasters. These are respectively <strong>sf</strong> (<strong>simple feature</strong>) and <strong>terra</strong>.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> In this chapter, we’ll consider only vectors.</p>
<p>The first two sections are devoted to simple features; <a href="#sec-simple_features"><span>Section&nbsp;9.1</span></a> presents the structure of simple features objects and <a href="#sec-sf_computation"><span>Section&nbsp;9.1.2</span></a>, using the example of a spatial RD design, illustrates how to deal with simple features in a statistical analysis. <a href="#sec-spatial_correlation"><span>Section&nbsp;9.3</span></a> deals with the detection and the measurement of spatial correlation. Finally, <a href="#sec-spatial_models"><span>Section&nbsp;9.4</span></a> presents some popular spatial models, namely the spatial error and the spatial autoregressive models.</p>
<section id="sec-simple_features" class="level2" data-number="9.1"><h2 data-number="9.1" class="anchored" data-anchor-id="sec-simple_features">
<span class="header-section-number">9.1</span> Simple features</h2>
<p>In a spatial statistical analysis, the first task is to get geographical information about the observations. This is usually done by importing external files in <strong>R</strong>, for example shapefiles. This task is performed by the <strong>sf</strong> library and the result is an <code>sf</code> object.</p>
<section id="sec-struct_sf" class="level3"><h3 class="anchored" data-anchor-id="sec-struct_sf">Structure of a simple feature</h3>
<p>To understand what a simple feature is, it is best to construct a small one “by hand”. The geographical representation of an observation is an <code>sfg</code> for simple feature geometry. It can be a point, a set of points that form a line or a polygon if the line ends where it started. We first load the <strong>sf</strong> package:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Linking to GEOS 3.10.2, GDAL 3.4.1, PROJ 8.2.1; sf_use_s2() is TRUE</code></pre>
</div>
</div>
<p>The message indicates that <strong>sf</strong> uses three important external libraries:</p>
<ul>
<li>
<strong>GEOS</strong> to compute topological operations,</li>
<li>
<strong>GDAL</strong> to read external files with a large variety of formats,</li>
<li>
<strong>PROJ</strong> to transform the coordinates in a specific <strong>CRS</strong> (coordinate reference system).</li>
</ul>
<p>We consider in this example the three main cities in France. For Paris, the latitude<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> is <span class="math inline">\(48.87\)</span> and the longitude<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> is <span class="math inline">\(2.33\)</span>. Most of <strong>sf</strong>’s functions start with <code>st_</code>. The <code>st_point</code> function can be used to construct a <code>sfg</code> (simple feature geometry) for Paris, the argument being a numeric vector containing the longitude and the latitude. </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">paris</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_point</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2.33</span>, <span class="fl">48.87</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We then perform the same operation for Lyon and Marseilles: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">lyon</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_point</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">4.85</span>, <span class="fl">45.76</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">marseilles</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html">st_point</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5.37</span>, <span class="fl">43.30</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We then construct a <code>sfc</code> (simple feature column) which is a set of <code>sfg</code>s, using the <code>st_sfc</code> function. The different elements are entered as unnamed arguments of the function and a <code>crs</code> argument can be used to specify the <strong>CRS</strong>. Three formats exist to describe the <strong>CRS</strong>: <strong>proj4string</strong> (a character string), <strong>EPSG</strong> (an integer), and <strong>WKT</strong>, for well known text (a list). We can use here either <code>"+proj=longlat +datum=WGS84 +no_defs"</code> or <code>4326</code>. The datum is the representation of the earth from which the latitudes and the longitudes are computed. </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">cities_coords</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/sfc.html">st_sfc</a></span><span class="op">(</span><span class="va">paris</span>, <span class="va">lyon</span>, <span class="va">marseilles</span>, crs <span class="op">=</span> <span class="fl">4326</span><span class="op">)</span></span>
<span><span class="va">cities_coords</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Geometry set for 3 features 
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 2.33 ymin: 43.3 xmax: 5.37 ymax: 48.87
Geodetic CRS:  WGS 84</code></pre>
</div>
</div>
<p>Printing the <code>sfc</code> gives interesting information, as the bounding box (the coordinates of the rectangle that contains the data) and the <strong>CRS</strong>. Finally, we can construct a <code>sf</code> object using <code>st_sf</code> by binding a data frame containing information about the cities and the <code>sfc</code>. </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">cities_data</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span>pop <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2.161</span>, <span class="fl">0.513</span>, <span class="fl">0.861</span><span class="op">)</span>,</span>
<span>                      area <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">105.4</span>, <span class="fl">47.87</span>, <span class="fl">240.6</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">cities</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/sf.html">st_sf</a></span><span class="op">(</span><span class="va">cities_data</span>, <span class="va">cities_coords</span><span class="op">)</span></span>
<span><span class="va">cities</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 3 features and 2 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 2.33 ymin: 43.3 xmax: 5.37 ymax: 48.87
Geodetic CRS:  WGS 84
    pop   area      cities_coords
1 2.161 105.40 POINT (2.33 48.87)
2 0.513  47.87 POINT (4.85 45.76)
3 0.861 240.60  POINT (5.37 43.3)</code></pre>
</div>
</div>
<p>A <code>sf</code> is just a data frame with a specific column that contains the coordinates of the observations. This column (called the geometry column) can be extracted using the <code>st_geometry</code> function: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">cities</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">st_geometry</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and is “sticky”, which means that if some columns are selected, the geometry column is always returned along with the selected columns, i.e.:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">cities</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">select</span><span class="op">(</span><span class="va">pop</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>returns <code>pop</code> <strong>and</strong> <code>cities_coords</code>, even if the latter colon was not selected. We can then plot our three cities, along with a map of France, which is obtained using the <code><a href="https://rdrr.io/pkg/geodata/man/gadm.html">geodata::gadm</a></code> function.<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">france</span> <span class="op">&lt;-</span> <span class="fu">geodata</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/geodata/man/gadm.html">gadm</a></span><span class="op">(</span><span class="st">"FR"</span>, <span class="fl">1</span>, <span class="st">"."</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>france</code> is not an object of class <code>sf</code>,<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a> so we first coerce it to a <code>sf</code> using the <code>st_as_sf</code> function, and then we extract the geometry and the series called <code>NAME_1</code> which contains the name of the regions: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">france</span> <span class="op">&lt;-</span> <span class="va">france</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">st_as_sf</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">select</span><span class="op">(</span>region <span class="op">=</span> <span class="va">NAME_1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Imported vector data are often large: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">france</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">object.size</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="st">"MB"</span><span class="op">)</span></span>
<span><span class="co">## [1] "3.6 Mb"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and they can be simplified using the <code><a href="https://rdrr.io/pkg/rmapshaper/man/ms_simplify.html">rmapshaper::ms_simplify</a></code> function, with a <code>keep</code> argument which indicates the degree of simplification (<span class="math inline">\(0.01\)</span> means that we seek to obtain a <code>sf</code> 100 times lighter than the initial one). </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">france</span> <span class="op">&lt;-</span> <span class="va">france</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">rmapshaper</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rmapshaper/man/ms_simplify.html">ms_simplify</a></span><span class="op">(</span>keep <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="va">france</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">object.size</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="st">"MB"</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">## [1] "0.07 Mb"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>sf</strong> provides a <code>plot</code> method to get quickly a map of the data. Note that a thematic map is plotted for all the series of the <code>sf</code>, and it is therefore recommended to select first a unique series. If one is only interested in the vectors, they can be extracted before plotting using <code>st_geometry</code>: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">france</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">st_geometry</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">plot</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For more advanced maps, several specialized packages are available, in particular <strong>tmap</strong> <span class="citation" data-cites="TENN:18">(<a href="#ref-TENN:18" role="doc-biblioref">Tennekes 2018</a>)</span> and <strong>mapsf</strong> <span class="citation" data-cites="GIRA:23">(<a href="#ref-GIRA:23" role="doc-biblioref">Giraud 2023</a>)</span>. In this chapter, we’ll only use <strong>ggplot</strong>, which provides a <code>geom_sf</code> function. This geom is very special compared to other geoms, as the kind of geom that is plotted depends on the geometry column of the <code>sf</code>: if <code>cities</code> is provided as the data argument, points will be plotted; but if <code>france</code> is provided, polygons will be drawn. In the following code, we start with <code>france</code> as the data argument of <code>ggplot</code> and then the call to <code>geom_sf</code> results in the drawing of the administrative borders of French regions. Then we use a second time <code>geom_sf</code> with this time <code>cities</code> as data argument, so that points are drawn for the three cities. We use here <code>aes(size = pop)</code> so that the size of the points is related to the population of the cities. The result is presented in <a href="#fig-map_france">Figure&nbsp;<span>9.1</span></a>. </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">france</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">geom_sf</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">cities</span>, <span class="fu">aes</span><span class="op">(</span>size <span class="op">=</span> <span class="va">pop</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-map_france" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="spatial_files/figure-html/fig-map_france-1.png" class="img-fluid figure-img" style="width:60.0%"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;9.1: Map of France with its three main cities</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p><strong>sf</strong> provides several functions to compute values of interest. For example, to get the distance from Paris to Lyon and Marseilles, we would use: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_measures.html">st_distance</a></span><span class="op">(</span><span class="va">cities</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span>, <span class="va">cities</span><span class="op">[</span><span class="fl">2</span><span class="op">:</span><span class="fl">3</span>, <span class="op">]</span><span class="op">)</span></span>
<span><span class="co">## Units: [m]</span></span>
<span><span class="co">##        [,1]   [,2]</span></span>
<span><span class="co">## [1,] 394508 662105</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>st_distance</code> always returns a matrix, the number of elements of the first (second) argument being the number of rows (columns) of the matrix. If only one argument is supplied, the result is a square matrix with 0 on the diagonal. Note that the numbers have a unit of measurement, which is here meters. To define a unit and to convert from one unit to another, the <strong>units</strong> package provides the <code>set_units</code> function. Consider the following example: we first provide a numeric (<span class="math inline">\(42.195\)</span>), we define its unit as kilometers, and then we convert it to miles: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-quantities.github.io/units/">units</a></span><span class="op">)</span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fl">42.195</span></span>
<span><span class="va">dkm</span> <span class="op">&lt;-</span> <span class="va">d</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://r-quantities.github.io/units/reference/units.html">set_units</a></span><span class="op">(</span><span class="va">km</span><span class="op">)</span></span>
<span><span class="va">dkm</span></span>
<span><span class="co">## 42.2 [km]</span></span>
<span><span class="va">dkm</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://r-quantities.github.io/units/reference/units.html">set_units</a></span><span class="op">(</span><span class="va">miles</span><span class="op">)</span></span>
<span><span class="co">## 26.22 [miles]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Even when the conversion is simple, it is advisable to use <code>set_units</code> instead of applying the conversion “by hand”: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">dm</span> <span class="op">&lt;-</span> <span class="va">dkm</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://r-quantities.github.io/units/reference/units.html">set_units</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span></span>
<span><span class="va">dm</span></span>
<span><span class="co">## 42195 [m]</span></span>
<span><span class="va">dkm</span> <span class="op">*</span> <span class="fl">1000</span></span>
<span><span class="co">## 42195 [km]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The numerical values are the same, but in the second case the unit hasn’t changed and is still kilometers. <code>st_area</code> computes the area of a polygon: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_measures.html">st_area</a></span><span class="op">(</span><span class="va">france</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">units</span><span class="fu">::</span><span class="fu"><a href="https://r-quantities.github.io/units/reference/units.html">set_units</a></span><span class="op">(</span><span class="va">km</span> <span class="op">^</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">## Units: [km^2]</span></span>
<span><span class="co">##  [1] 71023 47924 27507 39465  8705 57530 31917 12030 30044 84593</span></span>
<span><span class="co">## [11] 73135 32267 31837</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="sec-sf_computation" class="level3"><h3 class="anchored" data-anchor-id="sec-sf_computation">Computation on sf objects</h3>
<p> The regression discontinuity framework can be adapted to consider geographic discontinuities. Some entities are considered on both sides of a border and the forcing variable is then the distance to the border.<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a> The <code>us_counties</code> data set contains the borders of US counties:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">us_counties</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 3141 features and 4 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: -19940000 ymin: 2147000 xmax: 20010000 ymax: 11520000
Projected CRS: WGS 84 / Pseudo-Mercator
# A tibble: 3,141 × 5
  fips  gid       state   county                            geometry
* &lt;chr&gt; &lt;chr&gt;     &lt;chr&gt;   &lt;chr&gt;                   &lt;MULTIPOLYGON [m]&gt;
1 01001 USA.1.1_1 Alabama Autauga (((-9675520 3850831, -9652842 385…
2 01003 USA.1.2_1 Alabama Baldwin (((-9798375 3599675, -9797718 360…
3 01005 USA.1.3_1 Alabama Barbour (((-9508473 3713483, -9545463 371…
# ℹ 3,138 more rows</code></pre>
</div>
</div>
<p><span class="citation" data-cites="KUMA:18">Kumar (<a href="#ref-KUMA:18" role="doc-biblioref">2018</a>)</span> investigates the effect of a legal restriction on home equity extraction which is specific to Texas on mortgage defaults. Kumar measures mortgage default rates in Texas and in the bordering states and compares mortgage default rates for counties which are closed to the Texas border (on both sides). Let’s first plot the map of the counties, using <code>ggplot</code> and <code>geom_sf</code> (see <a href="#fig-counties">Figure&nbsp;<span>9.2</span></a>): </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">us_counties</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span> <span class="va">state</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Alaska"</span>, <span class="st">"Hawaii"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">geom_sf</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-counties" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="spatial_files/figure-html/fig-counties-1.png" class="img-fluid figure-img" style="width:60.0%"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;9.2: Map of American counties</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>The polygons can be merged using the <code>group_by</code> / <code>summarise</code> functions of <strong>dplyr</strong>. If the <code>sf</code> is grouped by states, the statistics computed by the <code>summarise</code> function is performed at the state level and the <code>geometry</code> now contains the coordinates of the states. With a void call to <code>summarise</code>, we get only this new <code>geometry</code>, and we can use it to plot a map of states (see <a href="#fig-states">Figure&nbsp;<span>9.3</span></a>): </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">states</span> <span class="op">&lt;-</span> <span class="va">us_counties</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span> <span class="va">state</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Alaska"</span>, <span class="st">"Hawaii"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">state</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">summarise</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">states</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">geom_sf</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-states" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="spatial_files/figure-html/fig-states-1.png" class="img-fluid figure-img" style="width:60.0%"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;9.3: Map of American states</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>To get the border states of Texas, we use spatial indexation, i.e., we use the <code>[</code> operator. The first argument is used to select rows; it is normally a vector of integers (the positions of the lines to extract), a vector of characters (the names of the lines to extract) or a logical vector. Here we can index an <code>sf</code> by another <code>sf</code>, and the result is (by default) a new <code>sf</code> containing the elements of the first one which has common points with the second one: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">border_states</span> <span class="op">&lt;-</span> <span class="va">states</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">states</span>, <span class="va">state</span> <span class="op">==</span> <span class="st">"Texas"</span><span class="op">)</span>, <span class="op">]</span></span>
<span><span class="va">border_states</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 5 features and 1 field
Geometry type: GEOMETRY
Dimension:     XY
Bounding box:  xmin: -12140000 ymin: 2979000 xmax: -9918000 ymax: 4439000
Projected CRS: WGS 84 / Pseudo-Mercator
# A tibble: 5 × 2
  state                                                     geometry
  &lt;chr&gt;                                               &lt;GEOMETRY [m]&gt;
1 Arkansas   POLYGON ((-10407328 3897869, -10410758 3897882, -10443…
2 Louisiana  MULTIPOLYGON (((-10253638 3470493, -10257225 3475979, …
3 New Mexico POLYGON ((-11868806 3763464, -11868752 3752373, -11870…
4 Oklahoma   POLYGON ((-10942378 4046699, -10950200 4049735, -10956…
5 Texas      MULTIPOLYGON (((-11360369 3475920, -11367496 3476824, …</code></pre>
</div>
</div>
<p>We then compute the Texas border. It is defined by the common points of the borders of Texas and its border states. This is obtained using the <code>st_intersection</code> function which returns four lines (one for each border state), and the border is then obtained by merging these four lines using the <code>st_union</code> function. The result is presented in <a href="#fig-border">Figure&nbsp;<span>9.4</span></a>. </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">texas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">border_states</span>, <span class="va">state</span> <span class="op">==</span> <span class="st">"Texas"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">st_geometry</span></span>
<span><span class="va">border</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">border_states</span>, <span class="va">state</span> <span class="op">!=</span> <span class="st">"Texas"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">st_geometry</span></span>
<span><span class="va">border</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html">st_intersection</a></span><span class="op">(</span><span class="va">texas</span>, <span class="va">border</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  <span class="va">st_union</span></span>
<span><span class="va">border_states</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_sf</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">border</span>, linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_sf_label</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>label <span class="op">=</span> <span class="va">state</span><span class="op">)</span><span class="op">)</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-border" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="spatial_files/figure-html/fig-border-1.png" class="img-fluid figure-img" style="width:60.0%"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;9.4: Border states and Texas borders</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Note the use of <code>geom_sf_label</code> function which, is a specialized version of <code>geom_label</code> that is suitable for writing labels on a map. We then select the counties that belong to any of these states and we compute the distance to the Texas border. It is defined as the distance between the centroid of the county and the closest point of the border. The centroids are obtained using the <code>st_centroid</code> function. We’ve already used <code>st_distance</code> to comp ute the distance between two points. It can also be used to compute the (shortest) distance between a point and a line: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">border_counties</span> <span class="op">&lt;-</span> <span class="va">us_counties</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">state</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu">pull</span><span class="op">(</span><span class="va">border_states</span>, <span class="va">state</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">centroids</span> <span class="op">&lt;-</span> <span class="va">border_counties</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">st_geometry</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">st_centroid</span></span>
<span><span class="va">dists</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_measures.html">st_distance</a></span><span class="op">(</span><span class="va">centroids</span>, <span class="va">border</span><span class="op">)</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://r-quantities.github.io/units/reference/units.html">set_units</a></span><span class="op">(</span><span class="va">miles</span><span class="op">)</span></span>
<span><span class="va">border_counties</span> <span class="op">&lt;-</span> <span class="va">border_counties</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">add_column</span><span class="op">(</span><span class="va">dists</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">dists</span><span class="op">)</span></span>
<span><span class="co">## Units: [miles]</span></span>
<span><span class="co">## [1] 194.7 157.4 259.2 212.0 241.6 130.3</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>st_distance</code> returns a matrix of distance, each column corresponding to a line of the second argument. As here there is only one line, we convert this matrix to a vector by taking its first column. The unit of the returned values is meters; we convert it to miles, like in the original article and we add this column to the sf. As in the original article, we fill with different colors in <a href="#fig-close_counties_dist">Figure&nbsp;<span>9.5</span></a> counties that are less than 25, 50, 75 and 100 miles from the border: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">border_counties</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>dist_class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cut.html">cut</a></span><span class="op">(</span><span class="va">dists</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">25</span>, <span class="fl">50</span>, <span class="fl">75</span>, <span class="fl">100</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">dist_class</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_grey</span><span class="op">(</span>na.translate <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">border</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-close_counties_dist" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="spatial_files/figure-html/fig-close_counties_dist-1.png" class="img-fluid figure-img" style="width:60.0%"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;9.5: Counties close to the Texan border</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Finally, we select the relevant series from the data set of the paper, called <code>mortgage_default</code>, and we merge it with <code>border_counties</code>: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mortdef_sf</span> <span class="op">&lt;-</span> <span class="va">border_counties</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">right_join</span><span class="op">(</span><span class="va">mortgage_defaults</span>, by <span class="op">=</span> <span class="st">"fips"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>dists <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">state</span> <span class="op">==</span> <span class="st">"Texas"</span>, <span class="va">dists</span>, <span class="op">-</span> <span class="va">dists</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note the use of the quite unusual <code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">dplyr::right_join</a></code> function. By using <code>right_join</code> with <code>border_counties</code> as the first argument and <code>mortgage_defaults</code> as the second argument, we get an object of the class of the first argument (therefore a <code>sf</code>) and we get all the lines of the <code>mortgage_defaults</code> tibble and only those of <code>us_counties</code> that match. We use the convention that the distance is positive for Texan counties and negative for neighboring states. Finally, we plot the discontinuity in <a href="#fig-disc_texas">Figure&nbsp;<span>9.6</span></a>. </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mortdef_sf</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">dists</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">50</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu">mutate</span><span class="op">(</span>state <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">state</span> <span class="op">==</span> <span class="st">"Texas"</span>, <span class="st">"Texas"</span>, <span class="st">"other"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span><span class="va">dists</span>, <span class="va">default</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">micsr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/micsr/man/binmeans.html">geom_binmeans</a></span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>size <span class="op">=</span> <span class="fu">after_stat</span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span>, shape <span class="op">=</span> <span class="fl">21</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_smooth</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>linetype <span class="op">=</span> <span class="va">state</span>, weight <span class="op">=</span> <span class="va">loans</span><span class="op">)</span>, </span>
<span>                method <span class="op">=</span> <span class="st">"lm"</span>, se <span class="op">=</span> <span class="cn">FALSE</span>, color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-disc_texas" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="spatial_files/figure-html/fig-disc_texas-1.png" class="img-fluid figure-img" style="width:60.0%"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;9.6: Discontinuity of the mortgage defaults data set</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>The intercept is a bit more than 7% outside the border and about 4.5% inside the border, so that the effect of the Texas specific regulation seems significant (a reduction of about 2.5% of the mortgage default rate). </p>
</section></section><section id="two-examples" class="level2" data-number="9.2"><h2 data-number="9.2" class="anchored" data-anchor-id="two-examples">
<span class="header-section-number">9.2</span> Two examples</h2>
<p>To illustrate the techniques presented in the subsequent sections, we’ll use two data sets. The first one, from <span class="citation" data-cites="WHEE:03">Wheeler (<a href="#ref-WHEE:03" role="doc-biblioref">2003</a>)</span>, is called <code>agglo_growth</code> and deals with the topic of economies and diseconomies of agglomeration. The second one, called <code>sp_growth</code> is from <span class="citation" data-cites="ERTU:KOCH:07">Ertur and Koch (<a href="#ref-ERTU:KOCH:07" role="doc-biblioref">2007</a>)</span> and is used to fit an extension of Solow’s growth model.</p>
<section id="agglomeration-economies-and-diseconomies" class="level3"><h3 class="anchored" data-anchor-id="agglomeration-economies-and-diseconomies">Agglomeration economies and diseconomies</h3>
<p>The <code>agglo_growth</code> contains data about US counties in 1990, identified by their fips code. </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">agglo_growth</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3,106 × 14
  fips  emp_gr pop_gr    emp    pop college manuf  unemp income
  &lt;chr&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
1 01001  0.203 0.0591 12591. 32259.  0.121  0.248 0.0900  5774.
2 01003  0.367 0.224  29807. 78556.  0.121  0.206 0.0686  5960.
3 01005  0.177 0.0264  8642. 24756.  0.0923 0.344 0.0874  4544.
4 01007  0.224 0.0528  5377. 15723.  0.0490 0.424 0.158   4859.
5 01009  0.248 0.0737 13713. 36459.  0.0529 0.287 0.0892  5213.
# ℹ 3,101 more rows
# ℹ 5 more variables: educ_sh &lt;dbl&gt;, hw_sh &lt;dbl&gt;, pol_sh &lt;dbl&gt;,
#   notwhite &lt;dbl&gt;, type &lt;fct&gt;</code></pre>
</div>
</div>
<p><code>emp_gr</code> and <code>pop_gr</code> are the employment and the population growth in each county between 1980 and 1990 and <code>emp</code> and <code>pop</code> the level of employment and of the population in 1980. <span class="citation" data-cites="WHEE:03">Wheeler (<a href="#ref-WHEE:03" role="doc-biblioref">2003</a>)</span> investigates the existence of:</p>
<ul>
<li>agglomeration economies, which implies that the growth of a given territory will be positively correlated with its size,</li>
<li>agglomeration diseconomies for large cities that experience congestion, crime, pollution, etc.</li>
</ul>
<p>The hypothesis is therefore that the relation between size and growth should be inverted U shaped, which means that, for small territories, the agglomeration economies effect is dominant; as for large territories, the agglomeration diseconomies becomes dominant. We’ll reproduce some of the results using the counties of Louisiana. We first join the tibble to the <code>sf</code> called <code>us_counties</code> which contains the geometries of the counties that we’ve already used in the previous section: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">louisiana</span> <span class="op">&lt;-</span> <span class="va">us_counties</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">right_join</span><span class="op">(</span><span class="va">agglo_growth</span>, by <span class="op">=</span> <span class="st">"fips"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">state</span> <span class="op">==</span> <span class="st">"Louisiana"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We first plot a thematic map (<a href="#fig-map_louisiana">Figure&nbsp;<span>9.7</span></a>), with colors for counties related to the growth of the population (<code>pop_gr</code>). It is recommended to create first a categorical variable using <code><a href="https://rdrr.io/r/base/cut.html">base::cut</a></code>, because it is easier to visualize a discrete palette of colors than a continuous one. We use <code>scale_fill_brewer</code> to use one of the palettes provided by the <strong>RColorBrewer</strong> package, which provides sequential, diverging and qualitative palettes. The first two are suitable to represent the values of numerical variables. Sequential palettes use a color, light for low values of the variable and dark for high values. Divergent palettes use two colors, with light colors for middle range values and dark colors for low and high values. All the available palettes can be displayed using <code><a href="https://rdrr.io/pkg/RColorBrewer/man/ColorBrewer.html">RColorBrewer::display.brewer.all()</a></code>. We use here the <code>Oranges</code> sequential palette. </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">louisiana</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>pop_gr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cut.html">cut</a></span><span class="op">(</span><span class="va">pop_gr</span>, <span class="op">(</span><span class="op">-</span><span class="fl">3</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span> <span class="op">/</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">geom_sf</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">pop_gr</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">scale_fill_brewer</span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Oranges"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-map_louisiana" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="spatial_files/figure-html/fig-map_louisiana-1.png" class="img-fluid figure-img" style="width:60.0%"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;9.7: Population growth and initial population in Louisiana</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>The inverted U shaped hypothesis between the log of the initial population and the growth rate can be tested by regressing the growth rate on the log population and its square. The later coefficient should then be negative. </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mod1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">pop_gr</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/poly.html">poly</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">pop</span><span class="op">)</span>, <span class="fl">2</span>, raw <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="va">louisiana</span><span class="op">)</span></span>
<span><span class="va">mod1</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">gaze</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                               Estimate Std. Error t value Pr(&gt;|t|)
poly(log(pop), 2, raw = TRUE)1  0.68298    0.19333    3.53  0.00079
poly(log(pop), 2, raw = TRUE)2 -0.02974    0.00883   -3.37  0.00132</code></pre>
</div>
</div>
<div class="cell" data-layout-align="center">

</div>
<p>The coefficient of the square term is negative and significant and we get a maximum growth for the fitted model for a value of <code>log(pop)</code> equal to <span class="math inline">\(-0.683 / (-0.0297 \times 2) = 11.4819\)</span>, i.e., a population of about 97 thousand inhabitants. This result is illustrated in <a href="#fig-iushaped_louisiana">Figure&nbsp;<span>9.8</span></a>, a scatterplot representing the relationship between the logarithm of the initial population and its growth rate and a fitting line with a second degree polynomial: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">louisiana</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span><span class="va">pop</span>, <span class="va">pop_gr</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_smooth</span><span class="op">(</span>method <span class="op">=</span> <span class="st">"lm"</span>, formula <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/poly.html">poly</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">2</span>, raw <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, </span>
<span>                se <span class="op">=</span> <span class="cn">FALSE</span>, color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">scale_x_continuous</span><span class="op">(</span>trans <span class="op">=</span> <span class="st">"log10"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-iushaped_louisiana" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="spatial_files/figure-html/fig-iushaped_louisiana-1.png" class="img-fluid figure-img" style="width:60.0%"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;9.8: Relation between initial population and population growth in Louisiana</figcaption><p></p>
</figure>
</div>
</div>
</div>
</section><section id="sec-solow_model" class="level3"><h3 class="anchored" data-anchor-id="sec-solow_model">Solow model</h3>
<p>The second example is from <span class="citation" data-cites="ERTU:KOCH:07">Ertur and Koch (<a href="#ref-ERTU:KOCH:07" role="doc-biblioref">2007</a>)</span> who estimated a growth model for the countries of the world taking spatial correlation into account. The <code>sp_solow</code> data set is provided by the <strong>necountries</strong> package: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"sp_solow"</span>, package <span class="op">=</span> <span class="st">"necountries"</span><span class="op">)</span></span>
<span><span class="va">sp_solow</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 91 × 6
  name      code   gdp60  gdp95 saving labgwth
  &lt;chr&gt;     &lt;chr&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;
1 Angola    AGO    5136.  2629. 0.0736 0.0233 
2 Argentina ARG   18733. 24738. 0.178  0.0165 
3 Australia AUS   26480. 45331. 0.247  0.0210 
4 Austria   AUT   15283. 45023. 0.261  0.00291
5 Burundi   BDI     889.  1339. 0.0521 0.0168 
# ℹ 86 more rows</code></pre>
</div>
</div>
<p>There are 91 countries in the <code>sp_solow</code> data set, the series being the gdp in 1960 and 1995, the saving rate (<code>saving</code>) and the growth of the labor force (<code>labgwth</code>). As in <a href="multiple_regression.html#sec-data_solow_mrw"><span>Section&nbsp;3.1.2</span></a>, we denote <code>i</code> as the saving rate and <code>v</code> as the sum of the growth rate of the labor force and 0.05.<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a> We also compute the annual growth rate (<code>growth</code>) as the difference of the logs of the GDP for 1995 and 1960 divided by 35. </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sp_solow</span> <span class="op">&lt;-</span> <span class="va">sp_solow</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">rename</span><span class="op">(</span>i <span class="op">=</span> <span class="va">saving</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>v <span class="op">=</span> <span class="va">labgwth</span> <span class="op">+</span> <span class="fl">0.05</span>,</span>
<span>         growth <span class="op">=</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">gdp95</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">gdp60</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fl">35</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We then need to join this data frame to a sf containing the administrative boundaries of the countries and the coordinate of their capital. Several packages enable to get an sf of the world. For example, the <strong>spData</strong> package has a <code>world</code> sf which is obtained from Natural Earth,<a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a> <strong>geodata</strong> has a <code>world</code> function that enables to download from the gadm website<a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a> an object of class <code>SpatVector</code> (than can be easily converted to a <code>sf</code>, as shown in <a href="#sec-struct_sf"><span>Section&nbsp;9.1.1</span></a>). We use here the convenient <strong>necountries</strong> package that also uses Natural Earth and provides a <code>countries</code> function with different arguments to select a subset of countries of the world. By default, <code>countries</code> returns 199 lines, the 193 United Nations’ recognized countries, the two observer countries (Palestine and Vatican) and four not or not fully recognized countries (Kosovo, Somaliland, Northern Cyprus and Taiwan). Each line includes the geometry of the “main” part of the countries. Some countries have “parts” or “dependencies” that can be included using <code>part = TRUE</code> and <code>dependency = TRUE</code>. A “part” is an area which has the same political status as the rest of the country, but is far from the main part of the country. Examples of parts include Alaska and Hawaii for the United States, Martinique and Guadeloupe for France and Canaries for Spain. A “dependency” is an area with a specific political status. Examples of dependencies are Greenland for Denmark, New Caledonia for France and Gibraltar for the United Kingdom.</p>
<p><code>sp_solow</code> has columns that contain the names and the iso-codes of the countries (respectively <code>name</code> and <code>code</code>). Any of them can be used to join <code>sp_solow</code> with the <code>countries</code>’ object, but it is much safer to use <code>code</code>, as it avoids the problem of small differences in countries’ names. A lot of countries of the world are not present in <code>sp_solow</code> (especially most of the communist countries). We check whether all the countries of <code>sp_solow</code> are present in the <code>countries</code> object, with the <code>check_join</code> function; the <code>by</code> argument indicates the series in <code>sp_solow</code> that identifies the country: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://www.R-project.org">necountries</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/necountries/man/countries.html">countries</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/necountries/man/dplyr.methods.html">check_join</a></span><span class="op">(</span><span class="va">sp_solow</span>, by <span class="op">=</span> <span class="st">"code"</span><span class="op">)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Countries in the external tibble not in the countries' sf:</span></span>
<span><span class="co">##  HKG, ZAR</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The two problems are that the D.R. of Congo (<code>iso3</code> code <code>COD</code>) used to be called Zaire (<code>iso3</code> code <code>ZAR</code>) and that Hong Kong, which is a part of China for the <strong>necountries</strong> package, was considered as a sovereign country in <span class="citation" data-cites="ERTU:KOCH:07">Ertur and Koch (<a href="#ref-ERTU:KOCH:07" role="doc-biblioref">2007</a>)</span> study. We then correct the code for the D.R. of Congo, we add Hong Kong using the <code>include</code> argument and we remove <code>Antarctica</code> with the exclude argument: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sp_solow</span> <span class="op">&lt;-</span> <span class="va">sp_solow</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>code <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">code</span> <span class="op">==</span> <span class="st">"ZAR"</span>, <span class="st">"COD"</span>, <span class="va">code</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/necountries/man/countries.html">countries</a></span><span class="op">(</span>include <span class="op">=</span> <span class="st">"Hong Kong"</span>, exclude <span class="op">=</span> <span class="st">"Antarctica"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">iso3</span>, <span class="va">country</span>, <span class="va">point</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">sp_solow</span>, by <span class="op">=</span> <span class="st">"code"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span> <span class="va">name</span><span class="op">)</span></span>
<span><span class="va">sps</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 200 features and 8 fields
Active geometry column: polygon
Geometry type: GEOMETRY
Dimension:     XY
Bounding box:  xmin: -180 ymin: -55.67 xmax: 180 ymax: 83.12
Geodetic CRS:  WGS 84
# A tibble: 200 × 10
  iso3  country           point                              polygon
  &lt;chr&gt; &lt;chr&gt;       &lt;POINT [°]&gt;                       &lt;GEOMETRY [°]&gt;
1 AFG   Afghani…  (69.18 34.52) POLYGON ((74.54 37.02, 74.37 37.15,…
2 ALB   Albania   (19.82 41.33) POLYGON ((20.57 41.87, 20.6 41.95, …
3 DZA   Algeria   (3.049 36.77) POLYGON ((-4.822 25, -4.166 24.57, …
4 AND   Andorra   (1.527 42.51) POLYGON ((1.707 42.5, 1.722 42.61, …
5 AGO   Angola   (13.23 -8.836) MULTIPOLYGON (((13.07 -4.635, 12.9 …
# ℹ 195 more rows
# ℹ 6 more variables: gdp60 &lt;dbl&gt;, gdp95 &lt;dbl&gt;, i &lt;dbl&gt;,
#   labgwth &lt;dbl&gt;, v &lt;dbl&gt;, growth &lt;dbl&gt;</code></pre>
</div>
</div>
<p>Note that the resulting <code>sf</code> has two geometry columns, polygons for the borders of the countries (<code>polygon</code>) and points for the capitals (<code>point</code>). Note also that the active geometry column is <code>polygon</code>. We then draw in <a href="#fig-growth_gdp">Figure&nbsp;<span>9.9</span></a> a world map with the color of the countries related to the annual growth during the 1960-95 period and a point with a size related to the initial (1960) GDP. <strong>necountries</strong> provides a <code>plot</code> method which draws a basic map using <strong>ggplot2</strong>. A basic thematic map can be drawn using the <code>fill</code> argument to fill the areas of the countries and the <code>centroid</code> or the <code>capital</code> arguments to draw a point at the position of the centroid or the capital of each country. Any <strong>ggplot2</strong> functions can be used to customize the graphic: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sps</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"growth"</span>, centroid <span class="op">=</span> <span class="st">"gdp60"</span>, palette <span class="op">=</span> <span class="st">"Blues"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_size_continuous</span><span class="op">(</span>range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">guides</span><span class="op">(</span>size <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>nrow <span class="op">=</span> <span class="fl">3</span>, reverse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>         fill <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>nrow <span class="op">=</span> <span class="fl">3</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">labs</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"Growth rate (1960-95)"</span>, size <span class="op">=</span> <span class="st">"GDP in 1960"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-growth_gdp" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="spatial_files/figure-html/fig-growth_gdp-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;9.9: Growth and initial GDP, 1960-1995</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>The basic Solow model, which was given in <a href="multiple_regression.html#eq-solow_equation">Equation&nbsp;<span>3.3</span></a>, is then estimated: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">gdp95</span><span class="op">)</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span>, <span class="va">sp_solow</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">gaze</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       Estimate Std. Error t value Pr(&gt;|t|)
log(i)    1.276      0.125   10.19   &lt;2e-16
log(v)   -2.709      0.642   -4.22    6e-05</code></pre>
</div>
</div>
<p>Remember that the structural model implies that <span class="math inline">\(\beta_s = - \beta_v = \kappa / (1 - \kappa)\)</span>. This hypothesis can be tested using a reparametrization of the model: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">gdp95</span><span class="op">)</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">i</span> <span class="op">/</span> <span class="va">v</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span>, <span class="va">sp_solow</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">gaze</span></span>
<span><span class="co">##          Estimate Std. Error t value Pr(&gt;|t|)</span></span>
<span><span class="co">## log(i/v)    1.276      0.125    10.2   &lt;2e-16</span></span>
<span><span class="co">## log(v)     -1.433      0.681    -2.1    0.038</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>for which the hypothesis is that the coefficient of <code>log(v)</code> equals 0. This hypothesis is rejected at the 5% level (but not at the 1% level). Imposing this hypothesis, we get: </p>
<div class="cell" data-layout-align="center">

</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">gdp95</span><span class="op">)</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">i</span> <span class="op">/</span> <span class="va">v</span><span class="op">)</span>, <span class="va">sp_solow</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">gaze</span></span>
<span><span class="co">##          Estimate Std. Error t value Pr(&gt;|t|)</span></span>
<span><span class="co">## log(i/v)    1.379      0.117    11.8   &lt;2e-16</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>which implies a value of <span class="math inline">\(\kappa\)</span> (the share of the capital in the GDP) equal to <span class="math inline">\(\hat{\beta}_i / (1 + \hat{\beta}_i) = 0.58\)</span> which is implausibly high. </p>
</section></section><section id="sec-spatial_correlation" class="level2" data-number="9.3"><h2 data-number="9.3" class="anchored" data-anchor-id="sec-spatial_correlation">
<span class="header-section-number">9.3</span> Spatial correlation</h2>
<p>Spatial correlation occurs when one can define a distance relationship between observations. The notion of distance is broad, but we’ll consider in this section only geographical distance. For each observation, one can in this case define a set of neighbors. If the geographical representation of an observation is a polygon (which is the relevant choice for countries or regions), two observations for example can be said to be neighbors if they have a common border. If the geographical representation of an observation is a point (for example for a city), two observations are neighbors if the distance between them is less than, say, 100 kilometers. Once the set of neighbors have been defined for every observations, weights can be computed. The weights can be equal or may depend on the distance between the observation and its neighbors. These two operations of defining the set of neighbors and their weights are performed by the <strong>spdep</strong> package <span class="citation" data-cites="PEBE:BIVA:23">(<a href="#ref-PEBE:BIVA:23" role="doc-biblioref">Pebesma and Bivand 2023</a>)</span>.</p>
<section id="contiguity-and-weights" class="level3"><h3 class="anchored" data-anchor-id="contiguity-and-weights">Contiguity and weights</h3>
<p> To get the matrix of contiguity for the counties of Louisiana, we use the <code><a href="https://r-spatial.github.io/spdep/reference/poly2nb.html">spdep::poly2nb</a></code> function: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-spatial/spdep/">spdep</a></span><span class="op">)</span></span>
<span><span class="va">nb_louis</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/poly2nb.html">poly2nb</a></span><span class="op">(</span><span class="va">louisiana</span><span class="op">)</span></span>
<span><span class="va">nb_louis</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Neighbour list object:
Number of regions: 64 
Number of nonzero links: 322 
Percentage nonzero weights: 7.861 
Average number of links: 5.031 </code></pre>
</div>
</div>
<div class="cell" data-layout-align="center">

</div>
<p>The print method indicates the number of contiguity links (322). Instead of storing these links in a full matrix (with 1 for contiguous counties and 0 otherwise) which would have <span class="math inline">\(64^2 = 4096\)</span> cells with only 322 of them with a value of 1 (about 7.9%), an <code>nb</code> object is returned. It is a list of 64 vectors which contains, for each observation, the positions of its neighbors. For example: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">nb_louis</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[1] 16 23 40 48 56

[[2]]
[1]  6 16 33 41 48

[[3]]
[1]  4 20 26 55 62 64</code></pre>
</div>
</div>
<p>The first two counties have five neighbors and the third one has six. A <code>summary</code> method provides more details. <code>poly2nb</code> has a <code>queen</code> argument which is <code>TRUE</code> by default. Queen contiguity means that two polygons which have only one common point are neighbors. Setting <code>queen</code> to <code>FALSE</code> implies that rook continuity is used. In this case, only counties that have a common border are neighbors. </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">nb_louis_rook</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/poly2nb.html">poly2nb</a></span><span class="op">(</span><span class="va">louisiana</span>, queen <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">

</div>
<p>Printing <code>nb_nc_rook</code>, one can check that the number of contiguity links (318) is slightly lower than previously (322). <code>nb</code> objects can’t be plotted as is with <strong>ggplot2</strong>. We provide a convenient <code>st_nb</code> function which performs this task, as it returns a <code>sf</code> object (see <a href="#fig-links">Figure&nbsp;<span>9.10</span></a>): </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">louisiana</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_sf</span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="fu">st_nb</span><span class="op">(</span><span class="va">louisiana</span><span class="op">)</span>, linetype <span class="op">=</span> <span class="st">"dotted"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="fu">st_nb</span><span class="op">(</span><span class="va">louisiana</span>, queen <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-links" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="spatial_files/figure-html/fig-links-1.png" class="img-fluid figure-img" style="width:60.0%"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;9.10: Queen and rook links for the counties of Louisiana</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>We first plot queen contiguity links with dotted lines and then rook contiguity with plain lines, so that the specific queen contiguity links appear as dotted segments. A matrix of weights is obtained by using the <code>nb2listw</code> function:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">W_louis</span> <span class="op">&lt;-</span> <span class="va">nb_louis</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">nb2listw</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A <code>listw</code> object is returned, which contains two lists: the first (<code>neighbours</code>) is the same as the one of the <code>nb</code> object. The second contains weights: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">W_louis</span><span class="op">$</span><span class="va">weights</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[1] 0.2 0.2 0.2 0.2 0.2

[[2]]
[1] 0.2 0.2 0.2 0.2 0.2

[[3]]
[1] 0.1667 0.1667 0.1667 0.1667 0.1667 0.1667</code></pre>
</div>
</div>
<p>We can see that weights of neighbors for a given observation are all equal (1/5 for the first two observations which have five neighbors and <span class="math inline">\(1/6\)</span> for the third one which has six neighbors) and sum to one. Therefore, premultiplying a vector <span class="math inline">\((y - \bar{y})\)</span> by <span class="math inline">\(W\)</span> results in a vector with typical value <span class="math inline">\(\sum_m w_{nm} y_m - \bar{y} = \tilde{y}_n - \bar{y}\)</span>. <code>nb</code> and a <code>listw</code> objects can be coerced to matrices using the <code>nb2mat</code> and <code>listw2mat</code> functions.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">W_louis</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">listw2mat</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Instead of defining the neighborhood as common borders, one can consider distance between points, for example the capitals or the centroids of the countries using the <code>sp_solow</code> data set. Remember that <code>sps</code> contains two <code>sf</code>, <code>polygon</code> and <code>point</code> and that the active geometry is <code>polygon</code>. We first specify <code>point</code> as being the active geometry, using the <code>st_set_geometry</code> function, and we remove all countries for which the data are not available: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sp_solow2</span> <span class="op">&lt;-</span> <span class="va">sps</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">na.omit</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_set_geometry</a></span><span class="op">(</span><span class="st">"point"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, we use the <code>dnearneigh</code> function to compute the set of neighbors for each country: the first argument is the <code>sf</code> and the next two arguments, called <code>d1</code> and <code>d2</code> are mandatory and should be set to the minimum and the maximum distances that should be used to define the neighbors. Note that this distance should be indicated in kilometers if the CRS is geographical, which is the case here. </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/dnearneigh.html">dnearneigh</a></span><span class="op">(</span><span class="va">sp_solow2</span>, <span class="fl">0</span>, <span class="fl">1000</span><span class="op">)</span></span>
<span><span class="va">d</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Neighbour list object:
Number of regions: 91 
Number of nonzero links: 238 
Percentage nonzero weights: 2.874 
Average number of links: 2.615 
18 regions with no links:
3 8 10 17 27 41 44 49 50 55 62 63 64 65 72 74 79 91
29 disjoint connected subgraphs</code></pre>
</div>
</div>
<div class="cell" data-layout-align="center">

</div>
<p>With a distance of 1000 km, there are 238 links and an average of 2.62 neighbors per country. Note that 18 countries have no neighbors. We then compute the weights, using <code>nb2listwdist</code>. The first two argument are a <code>nb</code> and a <code>sf</code> objects. The <code>type</code> argument indicates how the weights should be computed. Denoting <span class="math inline">\(d_{nm}\)</span> the distance between the two unit <span class="math inline">\(n\)</span> and <span class="math inline">\(m\)</span>, with <code>type = "idw"</code>, we get <span class="math inline">\(w_{nm} = d_{nm} ^ {- \alpha}\)</span>. With <code>type = "exp"</code>, the weights are <span class="math inline">\(w_{nm} = \mbox{exp}(- \alpha d_{nm})\)</span>. The <code>alpha</code> argument controls the value of <span class="math inline">\(\alpha\)</span> which is 1 by default. For example, if <code>type = "idw"</code> and <code>alpha = 2</code>, the weights are the inverse of the square of the distance. Once the weights have been computed, they can be normalized in different ways, using the <code>style</code> argument. If <code>type = "raw"</code> (the default), no normalization is performed. A usual choice is <code>"W"</code> where the weights of a unit are normalized so that they sum to 1: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">w</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/nb2listwdist.html">nb2listwdist</a></span><span class="op">(</span><span class="va">d</span>, <span class="va">sp_solow2</span>, type <span class="op">=</span> <span class="st">"idw"</span>, alpha <span class="op">=</span> <span class="fl">1</span>, </span>
<span>                  style <span class="op">=</span> <span class="st">"W"</span>, zero.policy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note the use of <code>zero.policy</code>: if <code>TRUE</code>, the matrix of weights is computed even if, as it is the case here, some countries have no neighbors.</p>
<p></p>
</section><section id="tests-for-spatial-correlation" class="level3"><h3 class="anchored" data-anchor-id="tests-for-spatial-correlation">Tests for spatial correlation</h3>
<p> The spatial correlation hypothesis can be tested either for a specific variable or using the residuals of a linear regression. Two main tests have been proposed. The first is Moran’s <span class="math inline">\(I\)</span> test: denoting <span class="math inline">\(W\)</span> as the weights matrix where the weights sum to one for a given line, the statistic is defined as:</p>
<p><span class="math display">\[
I = \frac{(y - \bar{y})^\top W (y - \bar{y})}{(y - \bar{y})^\top (y - \bar{y})} =
\frac{\sum_n (y_n  - \bar{y})(\tilde{y}_n - \bar{y})}{\sum_n (y_n  - \bar{y})^2}
\]</span></p>
<p>which is simply the ratio of the covariance between <span class="math inline">\(y\)</span> and <span class="math inline">\(\tilde{y}\)</span> and the variance of <span class="math inline">\(y\)</span>. It therefore can be obtained as the coefficient of <span class="math inline">\(y\)</span> in a linear regression of <span class="math inline">\(\tilde{y}\)</span> on <span class="math inline">\(y\)</span>. If the variance of <span class="math inline">\(\tilde{y}\)</span> and <span class="math inline">\(y\)</span> were equal, it would also be the coefficient of correlation between the value of <span class="math inline">\(y\)</span> for a unit and its neighbors. The Moran test is computed using the <code><a href="https://r-spatial.github.io/spdep/reference/moran.test.html">spdep::moran.test</a></code> function which takes as argument a series and a <code>listw</code> object: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/moran.test.html">moran.test</a></span><span class="op">(</span><span class="va">louisiana</span><span class="op">$</span><span class="va">pop_gr</span>, <span class="va">W_louis</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">gaze</span></span>
<span><span class="co">## Moran I = 0.306 (-0.016, 0.078), z = 4.147, pval = 0.000</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The value of the statistic is <span class="math inline">\(0.306\)</span>. Under the hypothesis of no correlation, the expected value of this statistic is <span class="math inline">\(- 1 / (N-1) = -0.016\)</span> and the standard deviation is <span class="math inline">\(0.078\)</span>.<a href="#fn10" class="footnote-ref" id="fnref10" role="doc-noteref"><sup>10</sup></a> The standardized statistic (<span class="math inline">\(4.147\)</span>) is asymptotically normal and the hypothesis of no spatial correlation is rejected. An alternative to Moran’s <span class="math inline">\(I\)</span> test is Geary’s <span class="math inline">\(C\)</span> test, which is defined as:</p>
<p><span class="math display">\[
C = \frac{N - 1}{2N}\frac{\sum_n \sum_m w_{nm} (y_n - y_m) ^ 2}{\sum_n
(y_n - \bar{y})^ 2}
\]</span></p>
<p>Introducing deviations from the mean in the previous expression and developing, we get:</p>
<p><span class="math display">\[
C = \frac{1}{2}\frac{N - 1}{N} \left(1 - 2 I + \frac{\sum_n (y_m-
\bar{y}) ^ 2 \sum_m w_{mn}}{\sum_n (y_n - \bar{y}) ^ 2}\right)
\]</span></p>
<p>If the weight matrix were symmetric, as <span class="math inline">\(\sum_n w_{nm} = 1\)</span>, we also would have <span class="math inline">\(\sum_m w_{mn} = 1\)</span>, so that the last term is one and <span class="math inline">\(C = \frac{N - 1}{N}(1 - I)\)</span>. Therefore, we can expect <span class="math inline">\(C\)</span> to be close to <span class="math inline">\((1 - I)\)</span>. Geary’s test is implemented in the <code><a href="https://r-spatial.github.io/spdep/reference/geary.test.html">spdep::geary.test</a></code> function </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/geary.test.html">geary.test</a></span><span class="op">(</span><span class="va">louisiana</span><span class="op">$</span><span class="va">pop_gr</span>, <span class="va">W_louis</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">gaze</span></span>
<span><span class="co">## Geary C = 0.681 (1.000, 0.083), z = 3.824, pval = 0.000</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p></p>
<p>These tests are unconditional tests of spatial correlation. The same tests can be performed on the residuals of linear models. </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">model_louisiana</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">pop_gr</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/stats/poly.html">poly</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">pop</span><span class="op">)</span>,<span class="fl">2</span>,raw <span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>, <span class="va">louisiana</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/lm.morantest.html">lm.morantest</a></span><span class="op">(</span><span class="va">model_louisiana</span>, <span class="va">W_louis</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">gaze</span></span>
<span><span class="co">## Moran I = 0.136 (-0.020, 0.077), z = 2.026, pval = 0.021</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The hypothesis of no spatial correlation is still rejected at the 5% level, but the p-value is much higher than the one associated with the unconditional test.</p>
<p><span class="citation" data-cites="ERTU:KOCH:07">Ertur and Koch (<a href="#ref-ERTU:KOCH:07" role="doc-biblioref">2007</a>)</span> computed the Moran test for the residuals of the OLS estimation of the standard Solow’s growth model. The set of neighbors is obtained with setting an infinite maximum distance, so that all countries are neighbors to each other. Two matrices of weights are computed: one with <span class="math inline">\(w_{nm} = d_{nm}^{-2}\)</span> (<code>W1</code>) and the other with <span class="math inline">\(w_{nm} = \mbox{exp}(-2 d_{nm})\)</span> (<code>W2</code>): </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">lm_solow</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">gdp95</span><span class="op">)</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span>, <span class="va">sp_solow2</span><span class="op">)</span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/dnearneigh.html">dnearneigh</a></span><span class="op">(</span><span class="va">sp_solow2</span>, <span class="fl">0</span>, <span class="cn">Inf</span><span class="op">)</span></span>
<span><span class="va">W1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/nb2listwdist.html">nb2listwdist</a></span><span class="op">(</span><span class="va">d</span>, <span class="va">sp_solow2</span>, type <span class="op">=</span> <span class="st">"idw"</span>, alpha <span class="op">=</span> <span class="fl">2</span>,</span>
<span>                   style <span class="op">=</span> <span class="st">"W"</span>, zero.policy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">W2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/nb2listwdist.html">nb2listwdist</a></span><span class="op">(</span><span class="va">d</span>, <span class="va">sp_solow2</span>, type <span class="op">=</span> <span class="st">"exp"</span>, alpha <span class="op">=</span> <span class="fl">2</span>,</span>
<span>                   style <span class="op">=</span> <span class="st">"W"</span>, zero.policy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/lm.morantest.html">lm.morantest</a></span><span class="op">(</span><span class="va">lm_solow</span>, <span class="va">W1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">gaze</span></span>
<span><span class="co">## Moran I = 0.431 (-0.020, 0.065), z = 6.927, pval = 0.000</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/lm.morantest.html">lm.morantest</a></span><span class="op">(</span><span class="va">lm_solow</span>, <span class="va">W2</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">gaze</span></span>
<span><span class="co">## Moran I = 0.560 (-0.022, 0.125), z = 4.675, pval = 0.000</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Whatever the weighting matrix, the hypothesis of no spatial correlation is rejected. </p>
<p></p>
</section><section id="local-spatial-correlation" class="level3"><h3 class="anchored" data-anchor-id="local-spatial-correlation">Local spatial correlation</h3>
<p>A first glance of local spatial correlation can be obtained using Moran’s plot (see <a href="#fig-moran_plot">Figure&nbsp;<span>9.11</span></a>), implemented in the <code><a href="https://r-spatial.github.io/spdep/reference/moran.plot.html">spdep::moran.plot</a></code> function, where <span class="math inline">\(y_n - \bar{y}\)</span> is on the <span class="math inline">\(x\)</span> axis and <span class="math inline">\(\tilde{y}_n - \bar{y}\)</span> on the <span class="math inline">\(y\)</span> axis. Therefore, both variables have zero mean and the intercept of the fitting line is therefore 0, the slope being Moran’s <span class="math inline">\(I\)</span> statistic: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/moran.plot.html">moran.plot</a></span><span class="op">(</span><span class="va">louisiana</span><span class="op">$</span><span class="va">pop_gr</span>, <span class="va">W_louis</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-moran_plot" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="spatial_files/figure-html/fig-moran_plot-1.png" class="img-fluid figure-img" style="width:60.0%"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;9.11: Moran plot</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Each observation is situated in one of the four quarters of the plane. Observations in the upper-right quarter are <em>“high-high”</em> observations, which means that the value of <span class="math inline">\(y\)</span> for observation <span class="math inline">\(n\)</span> and its neighbors are higher than the sample mean. Similarly, the lower-left quarter contains <em>“low-low”</em> observations, i.e., observations for which own values of <span class="math inline">\(y\)</span> and values of its neighbors are lower than the sample mean. The upper-left and the lower-right quarters contain respectively the <em>“low-high”</em> and the <em>“high-low”</em> observations. In case of no spatial correlation, the points should be randomly disposed around the origin and the slope of the regression line should be 0. On the contrary, in case of positive spatial correlation, a majority of points should be of the <em>“low-low”</em> or <em>“high-high”</em> category and the regression line should have a positive slope.</p>
<p> </p>
<p><span class="citation" data-cites="ANSE:95">Anselin (<a href="#ref-ANSE:95" role="doc-biblioref">1995</a>)</span> proposed local versions of Moran’s <span class="math inline">\(I\)</span> and Geary’s <span class="math inline">\(C\)</span> statistics. We then have for each observation <span class="math inline">\(I_n\)</span> and <span class="math inline">\(G_n\)</span> so that <span class="math inline">\(\sum_n I_n\)</span> and <span class="math inline">\(\sum_n G_n\)</span> are respectively proportional to the global Moran and Geary statistics. Local Moran’s statistics are defined as:</p>
<p><span class="math display">\[
I_n = (y_n - \bar{y}) \sum_m w_{nm} (y_m - \bar{y}) = (y_n - \bar{y})(\tilde{y}_n - \bar{y})
\]</span></p>
<p>and their sum is <span class="math inline">\((y_n - \bar{y})(\tilde{y}_n - \bar{y})\)</span>, which is the numerator of Moran’s <span class="math inline">\(I\)</span> statistic. Therefore, we have:</p>
<p><span class="math display">\[
I = \frac{\sum_n I_n}{\sum_n (y_n - \bar{y}) ^ 2}
\]</span></p>
<p>Local Moran’s statistics are obtained using the <code><a href="https://r-spatial.github.io/spdep/reference/localmoran.html">spdep::localmoran</a></code> function: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">locmor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/spdep/reference/localmoran.html">localmoran</a></span><span class="op">(</span><span class="va">louisiana</span><span class="op">$</span><span class="va">pop_gr</span>, <span class="va">W_louis</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>which returns a matrix, with a line for every observation and column containing the local Moran values, their expectation, variance, the standardized statistic and the p-value. It’s easier to coerce this matrix to a tibble in order to extract extreme values of the statistic:<a href="#fn11" class="footnote-ref" id="fnref11" role="doc-noteref"><sup>11</sup></a> </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">locmor</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">as_tibble</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">rename</span><span class="op">(</span>pval <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">pval</span> <span class="op">&lt;</span> <span class="fl">0.01</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 11 × 5
  Ii         E.Ii       Var.Ii     Z.Ii       pval      
  &lt;localmrn&gt; &lt;localmrn&gt; &lt;localmrn&gt; &lt;localmrn&gt; &lt;localmrn&gt;
1  1.17852   -1.603e-02 0.154640    3.038     0.002384  
2  0.93029   -7.606e-03 0.090380    3.120     0.001810  
3 -0.03674   -2.119e-05 0.000175   -2.776     0.005510  
4  2.31977   -6.666e-02 0.744962    2.765     0.005694  
5  3.00564   -8.712e-02 1.210852    2.811     0.004945  
# ℹ 6 more rows</code></pre>
</div>
</div>
<p>There are therefore 11 out of 64 (17%) observations for which the p-value is lower than 1%, which confirms the presence of spatial correlation. The local Moran statistic can also be represented in a map (<a href="#fig-map_local_moran">Figure&nbsp;<span>9.12</span></a>), in order to identify the “hot spots”:<a href="#fn12" class="footnote-ref" id="fnref12" role="doc-noteref"><sup>12</sup></a> </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">z_locmor</span> <span class="op">&lt;-</span> <span class="va">locmor</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">as_tibble</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">pull</span><span class="op">(</span><span class="va">Ii</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">as.numeric</span></span>
<span><span class="va">z_locmor</span> <span class="op">&lt;-</span> <span class="va">z_locmor</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cut.html">cut</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="op">-</span> <span class="fl">0.5</span>, <span class="fl">0</span>, <span class="fl">0.5</span>, <span class="fl">1</span>, <span class="fl">1.5</span>, <span class="fl">2</span>, <span class="fl">2.5</span>, <span class="cn">Inf</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">louisiana</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">add_column</span><span class="op">(</span>z <span class="op">=</span> <span class="va">z_locmor</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>z <span class="op">=</span> <span class="fu">fct_rev</span><span class="op">(</span><span class="va">z</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="va">ggplot</span> <span class="op">+</span> <span class="fu">geom_sf</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">z</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">scale_fill_grey</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-map_local_moran" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="spatial_files/figure-html/fig-map_local_moran-1.png" class="img-fluid figure-img" style="width:60.0%"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;9.12: Map of local Moran statistic</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Two hot spots are then identified, in the north-west and the south-west of the state.</p>
<p> </p>
</section></section><section id="sec-spatial_models" class="level2" data-number="9.4"><h2 data-number="9.4" class="anchored" data-anchor-id="sec-spatial_models">
<span class="header-section-number">9.4</span> Spatial econometrics</h2>
<section id="spatial-models-and-tests" class="level3"><h3 class="anchored" data-anchor-id="spatial-models-and-tests">Spatial models and tests</h3>
<p>We consider here linear gaussian models that are extended in order to integrate the spatial features of the sample, using the weighting matrix described in the previous section. Two main models can be considered. The first one is the <strong>spatial error model</strong> (<strong>SEM</strong>) which can be written in matrix form as: </p>
<p><span id="eq-sem"><span class="math display">\[
y = \alpha \iota + X \beta + \epsilon \; \mbox{with} \; \epsilon = \rho_\epsilon W \epsilon + \nu
\tag{9.1}\]</span></span></p>
<p>Therefore, the error for observation <span class="math inline">\(n\)</span> is linearly related to the errors of its neighbors <span class="math inline">\(\tilde{\epsilon}_n\)</span>. OLS estimation gives unbiased and consistent estimators but, as always with non-spherical errors, it is inefficient and the estimated covariance matrix of the coefficients based on the simple formula (<span class="math inline">\(\sigma ^ 2 (\tilde{X}^\top \tilde{X}) ^ {-1}\)</span>) is biased. </p>
<p> The second model is called the <strong>spatial autoregressive model</strong> (<strong>SAR</strong>).<a href="#fn13" class="footnote-ref" id="fnref13" role="doc-noteref"><sup>13</sup></a>. It extends the basic gaussian linear model by adding as a regressor the mean value of the response for the neighbor units. For one observation, the model writes <span class="math inline">\(y_n =\alpha + \beta ^ \top x_n + \rho_y \tilde{y}_n + \epsilon_n\)</span> or, in matrix form:</p>
<p><span class="math display">\[
y = \alpha j + X \beta + \rho_y W y + \epsilon = Z \gamma + \rho_y W y + \epsilon
\]</span> The reduced form of the model is:</p>
<p><span id="eq-sar"><span class="math display">\[
y = (I - \rho_y W) ^ {-1} Z \gamma + (I - \rho_y W) ^ {-1}\epsilon
\tag{9.2}\]</span></span></p>
<p>Therefore, the values of <span class="math inline">\(y\)</span> depend on all the values of <span class="math inline">\(\epsilon\)</span>, and <span class="math inline">\(\tilde{y}_{n}\)</span> is therefore correlated with <span class="math inline">\(\epsilon_n\)</span>. The OLS estimator is therefore biased and inconsistent. Moreover, in <a href="#eq-sar">Equation&nbsp;<span>9.2</span></a>, the spatial dependence in the parameter <span class="math inline">\(\rho_y\)</span> feeds back <span class="citation" data-cites="BIVA:MILL:PIRA:21">(<a href="#ref-BIVA:MILL:PIRA:21" role="doc-biblioref">R. Bivand, Millo, and Piras 2021, 6</a>)</span>, which is not the case for <a href="#eq-sem">Equation&nbsp;<span>9.1</span></a>. This means that for the SEM model, the marginal effect of a covariate is the corresponding coefficient, but this is not the case for the SAR model. Moreover, the matrix <span class="math inline">\((I - \rho_y W) ^ {-1}\)</span> can be written as an infinite series:</p>
<p><span class="math display">\[
(I - \rho_y W) ^ {-1} = I + \rho_y W + \rho_y^2 W^2 + \rho_y^3
W^3 + \ldots
\]</span> Consider the case of three observations, France (1), Italy (2) and Spain (3). The matrix of contiguity is:</p>
<p><span class="math display">\[
W = \left(\begin{array}{rcl} 0 &amp; 0.5 &amp; 0.5 \\ 1 &amp; 0 &amp; 0 \\ 1 &amp; 0 &amp; 0\end{array}\right)
\]</span> France has two neighbors (Italy and Spain) and Italy and Spain only one (France). The weights are such that they sum to 1 for each line. Consider a variation of the unique covariate in Spain (<span class="math inline">\(\Delta x_3\)</span>) and denote <span class="math inline">\(\beta\)</span> the corresponding coefficient. The direct effect on the response for the three countries is obviously <span class="math inline">\(\Delta y_0 ^ \top = (0, 0, \beta \Delta x_3)\)</span>. This increase of <span class="math inline">\(y\)</span> in Spain implies an increase of <span class="math inline">\(y\)</span> in the neighboring country, France. Therefore, <span class="math inline">\(\Delta y_1 ^ \top = (0.5 \rho_y \beta \Delta x_3, 0, 0)\)</span>. This increase of <span class="math inline">\(y\)</span> in France implies an increase of <span class="math inline">\(y\)</span> in the neighboring countries, Italy and Spain: <span class="math inline">\(\Delta y_2 ^ \top = (0, 0.5 \rho_y ^ 2 \beta \Delta x_3, 0.5 \rho_y ^ 2 \beta \Delta x_3)\)</span>. This increase of <span class="math inline">\(y\)</span> in Italy and Spain implies an increase of <span class="math inline">\(y\)</span> in the neighboring country of Italy and Spain, which is France: <span class="math inline">\(\Delta y_3 ^ \top = (0.5\rho_y ^ 3 \beta \Delta x_3, 0, 0)\)</span>, etc. To take a numerical example, consider <span class="math inline">\(\beta \Delta x_3 = 1\)</span> and <span class="math inline">\(\rho_y = 0.3\)</span>. Then, <span class="math inline">\(\Delta y_0 ^ \top = (0, 0, 1)\)</span>, <span class="math inline">\(\Delta y_1 ^ \top = (0.15, 0, 0)\)</span>, <span class="math inline">\(\Delta y_2 ^ \top = (0, 0.045, 0.045)\)</span> and <span class="math inline">\(\Delta y_3 ^ \top = (0.0135, 0, 0)\)</span>. In total, we have <span class="math inline">\(\sum_{i = 0} ^ 3 \Delta y_i ^ \top = (0.177, 0.045, 1.045)\)</span>. These four effects and their sum is computed below: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">W</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">0.5</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0.5</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">bdx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">rho</span> <span class="op">&lt;-</span> <span class="fl">0.3</span></span>
<span><span class="va">dy0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">bdx</span></span>
<span><span class="va">dy1</span> <span class="op">&lt;-</span> <span class="va">rho</span> <span class="op">*</span> <span class="va">W</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">bdx</span></span>
<span><span class="va">dy2</span> <span class="op">&lt;-</span> <span class="va">rho</span> <span class="op">^</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">W</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">W</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">bdx</span></span>
<span><span class="va">dy3</span> <span class="op">&lt;-</span> <span class="va">rho</span> <span class="op">^</span> <span class="fl">3</span> <span class="op">*</span> <span class="va">W</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">W</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">W</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">bdx</span></span>
<span><span class="va">dy_03</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">dy0</span>, <span class="va">dy1</span>, <span class="va">dy2</span>, <span class="va">dy3</span><span class="op">)</span></span>
<span><span class="va">dy_03</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     [,1] [,2]  [,3]   [,4]
[1,]    0 0.15 0.000 0.0135
[2,]    0 0.00 0.045 0.0000
[3,]    1 0.00 0.045 0.0000</code></pre>
</div>
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">dy_03</span>, <span class="fl">1</span>, <span class="va">sum</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.1635 0.0450 1.0450</code></pre>
</div>
</div>
<p>The total effect of <span class="math inline">\(\Delta x_3\)</span> is obtained using the formula: <span class="math inline">\(\Delta y = (I - \rho_y W) ^ {-1} \Delta x\)</span>: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb77"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/solve.html">solve</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span> <span class="op">-</span> <span class="va">rho</span> <span class="op">*</span> <span class="va">W</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">bdx</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        [,1]
[1,] 0.16484
[2,] 0.04945
[3,] 1.04945</code></pre>
</div>
</div>
<p>which is very close to the sum of the direct effect and the first three indirect effects computed previously. </p>
<p> Spatial models are usually estimated by maximum likelihood, by assuming a multivariate normal distribution for the iid errors. For the SEM model, the idiosyncratic errors can be written as a function of the response:</p>
<p><span id="eq-etasem"><span class="math display">\[
\nu = (I - \rho_\epsilon W) y - (I - \rho_\epsilon W) Z\gamma
\tag{9.3}\]</span></span></p>
<p>so that the Jacobian of the transformation is</p>
<p><span class="math display">\[\left| \frac{\partial \nu}{\partial y} \right| =
\left| I - \rho_\epsilon W \right|\]</span>.</p>
<p>the likelihood is similar to the one of the linear gaussian model except that an extra term, which is the log of the Jacobian, should be added:</p>
<p><span class="math display">\[
-N/2 (\ln 2\pi + \ln \sigma ^ 2) + \ln \left| I - \rho_\epsilon W \right|  -
\frac{1}{\sigma ^ 2} \nu^\top \nu
\]</span> where <span class="math inline">\(\nu\)</span> is given by <a href="#eq-etasem">Equation&nbsp;<span>9.3</span></a>. For the <strong>SAR</strong> model, <a href="#eq-sar">Equation&nbsp;<span>9.2</span></a> indicates that the Jacobian is the same, so that the log-likelihood is:</p>
<p><span class="math display">\[
-N/2 (\ln 2\pi + \ln \sigma ^ 2) + \ln \left| I - \rho_y W \right|  -
\frac{1}{\sigma ^ 2} \epsilon^\top \epsilon
^ 2
\]</span></p>
<p>with <span class="math inline">\(\epsilon = y - Z \gamma - \rho_y Wy\)</span>.</p>
<!-- The log likelihood function can be concentrated on $\beta$ and $\sigma -->
<!-- ^ 2$ so that it can be expressed as a function of one parameter -->
<!-- ($\lambda$ for the **SAR** model and $\rho$ for the **SEM** model). -->
<p> These two models can be augmented by spatial lags of the covariates, they are in this case called Durbin’s models. There is an inserting relationship between Durbin’s SAR model and the SEM model. The former can be written: </p>
<p><span class="math display">\[
y = \rho_y W y + Z\gamma +   W Z\theta + \epsilon
\]</span></p>
<p>with <span class="math inline">\(\epsilon\)</span> iid errors. The <strong>common factor</strong> hypothesis is that <span class="math inline">\(\theta = - \rho_y \gamma\)</span>. In this case, we have: </p>
<p><span class="math display">\[
(I - \rho_y W) y =  (I - \rho_y W) Z\gamma + \epsilon
\]</span> Or finally:</p>
<p><span class="math display">\[
y =  Z\gamma + (I - \rho_y W) ^{-1} \epsilon
\]</span> which is the SEM model, as denoting <span class="math inline">\(\eta = (I -\rho_y W) ^ {-1} \epsilon\)</span> the errors of this model, we have <span class="math inline">\(y = Z\gamma + \eta\)</span>, with <span class="math inline">\(\eta = \rho_y W \eta + \epsilon\)</span>.</p>
<p>Once it has been established that there is some spatial dependence, one has to choose the “right” specification. Several tests have been proposed, based on the three test principles. Lagrange multiplier tests proposed by <span class="citation" data-cites="ANSE:BERA:FLOR:YOON:96">Anselin et al. (<a href="#ref-ANSE:BERA:FLOR:YOON:96" role="doc-biblioref">1996</a>)</span> are popular, as they only require the OLS estimation. Different flavors of tests have been proposed, testing <span class="math inline">\(\rho_y = 0\)</span>, <span class="math inline">\(\rho_\epsilon = 0\)</span> or <span class="math inline">\(\rho_y = \rho_\epsilon = 0\)</span>. The basic version of, for example the first test (<span class="math inline">\(\mbox{H}_{0}: \rho_y = 0\)</span>) has, as a maintained hypothesis that <span class="math inline">\(\rho_\epsilon = 0\)</span>. A robust version of the test has been proposed which doesn’t impose this maintained hypothesis. The common factor hypothesis can easily be tested using a likelihood ratio test. The Wald statistic is less easy to compute, as a set of non-linear hypotheses <span class="math inline">\(\theta = - \rho_y \beta\)</span> should be tested.</p>
<p> </p>
</section><section id="application-to-the-growth-model" class="level3"><h3 class="anchored" data-anchor-id="application-to-the-growth-model">Application to the growth model</h3>
<p>To overcome the irrelevant empirical results of the standard Solow model, <span class="citation" data-cites="ERTU:KOCH:07">Ertur and Koch (<a href="#ref-ERTU:KOCH:07" role="doc-biblioref">2007</a>)</span> consider an endogenous growth model with spillovers. The production function is as usual a Cobb-Douglas:</p>
<p><span class="math display">\[
Y_n(t) = A_n(t) K_n ^ \kappa(t) L_n ^ {1 -\kappa}(t)
\]</span> <span class="math inline">\(\kappa\)</span> being the elasticity of the production with the capital and also the share of the profits in the national product. The level of technology is given by:</p>
<p><span class="math display">\[
A_n(t) = \Omega(0) e ^ {\mu t} k_n ^ \phi(t) \prod_{m \neq n} ^ N A_n^{\gamma w_{nm}}(t)
\]</span></p>
<p>where <span class="math inline">\(k_n(t) = K_n(t) / L_n(t)\)</span> is the physical capital per worker, <span class="math inline">\(\Omega(0)\)</span> is the initial level of the technology and <span class="math inline">\(\mu\)</span> is a constant rate of technological growth, as in the Solow model. The next term takes into account the spillover effect of domestic investment, following <span class="citation" data-cites="ROME:86">Romer (<a href="#ref-ROME:86" role="doc-biblioref">1986</a>)</span>, and the strength of this spillover effect is measured by <span class="math inline">\(\phi\)</span>. The last term is specific to the model of <span class="citation" data-cites="ERTU:KOCH:07">Ertur and Koch (<a href="#ref-ERTU:KOCH:07" role="doc-biblioref">2007</a>)</span>, for which the spillovers are not restricted to domestic investment, but concerns also the technology of neighboring countries. The effect of the technology of country <span class="math inline">\(m\)</span> on the technology of country <span class="math inline">\(n\)</span> is the product of a constant parameter <span class="math inline">\(\gamma\)</span> and a specific weight, <span class="math inline">\(w_{nm}\)</span>, which is a decreasing function of the distance between both countries. <span class="citation" data-cites="ERTU:KOCH:07">Ertur and Koch (<a href="#ref-ERTU:KOCH:07" role="doc-biblioref">2007</a>)</span> showed (equation 10, page 1038) that, at the steady state, the output per capita is:</p>
<p><span class="math display">\[
\begin{array}{rcl}
\ln y_n ^ * &amp;=&amp; \frac{1}{1 - \kappa - \phi} \ln \Omega +
\frac{\kappa + \phi}{1 - \kappa - \phi} \ln i_n -
\frac{\kappa + \phi}{1 - \kappa - \phi} \ln v_n \\
&amp;-&amp; \frac{\gamma\kappa}{1 - \kappa - \phi} \sum_{m\neq n}^ N w_{nm} \ln i_m + \frac{\gamma\kappa}{1 - \kappa - \phi} \sum_{m\neq n}^ N w_{nm} \ln v_n \\
&amp;+&amp; \frac{\gamma(1 - \kappa)}{1 - \kappa - \phi} \sum_{m\neq n}^ N w_{nm} \ln y_m ^ *
\end{array}
\]</span></p>
<p>In matrix form, denoting <span class="math inline">\(y = \ln y^*\)</span>, <span class="math inline">\(X = (\ln i \ln v)\)</span>, <span class="math inline">\(\beta = \left(\begin{array}{c} (\kappa + \phi) / (1 - \kappa - \phi)\\ - (\kappa + \phi) / (1 - \kappa - \phi)\end{array}\right)\)</span>, <span class="math inline">\(\theta = \left(\begin{array}{c} \gamma \kappa / (1 - \kappa - \phi)\\ - \gamma \kappa / (1 - \kappa - \phi)\end{array}\right)\)</span> and <span class="math inline">\(\rho_y = \gamma (1 - \kappa) / (1 - \kappa - \phi)\)</span>, the model can be written as:</p>
<p><span class="math display">\[
y = \alpha i + X \beta + WX \theta + \rho_y Wy + \epsilon
\]</span> if <span class="math inline">\(\gamma = 0\)</span>, the model reduces to the model of <span class="citation" data-cites="ROME:86">Romer (<a href="#ref-ROME:86" role="doc-biblioref">1986</a>)</span> and the last two terms disappear. Note that in this case <span class="math inline">\(\kappa\)</span> and <span class="math inline">\(\phi\)</span> are not identified, but only their sum. Moreover, if <span class="math inline">\(\phi\)</span> is also 0, we get the Solow model. Whether <span class="math inline">\(\phi\)</span> equals zero or not, the resulting model is a standard linear model already estimated in <a href="#sec-solow_model"><span>Section&nbsp;9.2.2</span></a>: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb79"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ols_solow</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">gdp95</span><span class="op">)</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span>, <span class="va">sp_solow2</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Moreover, imposing the theoretical constraint of the growth model, we must have the sum of the two coefficients of <code>log(i)</code> and <code>log(v)</code> equal to 0. Therefore, the constrained model can be estimated using the difference of the logarithms of the two covariates as the unique regressor. For convenience, we call the ratio of the two covariates <code>i</code> and we store it in a new data frame called <code>sp_solow3</code>. The constrained OLS model can then be estimated: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sp_solow3</span> <span class="op">&lt;-</span> <span class="va">sp_solow2</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">mutate</span><span class="op">(</span>i <span class="op">=</span> <span class="va">i</span> <span class="op">/</span> <span class="va">v</span><span class="op">)</span></span>
<span><span class="va">ols_solowc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">gdp95</span><span class="op">)</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span>, <span class="va">sp_solow3</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The hypothesis of <span class="math inline">\(\gamma = 0\)</span> can be tested using Lagrange multipliers tests, testing either the alternative that there is a spatial lag or correlated errors. <code><a href="https://r-spatial.github.io/spdep/reference/lm.RStests.html">spdep::lm.LMtests</a></code> provides different flavors of these tests. Its two main arguments are a <code>lm</code> model and a matrix of spatial weights. The <code>test</code> argument can be either <code>"LMerr"</code> and “<code>LMlag</code>” for the standard tests of uncorrelated errors and absence of spatial lag, <code>"RLMerr"</code> and <code>"RLMlag"</code> for the robust versions of these two tests and <code>"SARMA"</code>, suitable when the alternative hypothesis is the presence of both correlation of the errors and a spatial lag. <code>test = "all"</code> enables to perform the five tests: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb81"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/lm.RStests.html">lm.LMtests</a></span><span class="op">(</span><span class="va">ols_solow</span>, <span class="va">W1</span>, test <span class="op">=</span> <span class="st">"all"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">gaze</span></span>
<span><span class="co">## RSerr   : 39.874, df = 1, p-value =  0.000</span></span>
<span><span class="co">## RSlag   : 51.467, df = 1, p-value =  0.000</span></span>
<span><span class="co">## adjRSerr:  3.004, df = 1, p-value =  0.083</span></span>
<span><span class="co">## adjRSlag: 14.596, df = 1, p-value =  0.000</span></span>
<span><span class="co">## SARMA   : 54.471, df = 2, p-value =  0.000</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>All the tests reject the hypothesis of uncorrelated errors or/and spatial lag, except the robust test of uncorrelated errors. Therefore, these tests seem to indicate that the correct model is a spatial lag model. We then estimate the three spatial models using the <strong>spatialreg</strong> package <span class="citation" data-cites="PEBE:BIVA:23">(<a href="#ref-PEBE:BIVA:23" role="doc-biblioref">Pebesma and Bivand 2023</a>)</span> which provides three functions: <code>lagsarlm</code> for SAR models, <code>sacsarlm</code> for SEM model and <code>errorsarlm</code> for SAR-SEM models. The three first arguments are <code>formula</code>, <code>data</code> and <code>listw</code>, which should be a <code>listw</code> object containing the weights. The <code>Durbin</code> argument enables to estimate Durbin’s versions of the model; this can be done either by setting it to <code>TRUE</code> (a spatial lag is then added for all the covariates) or a formula indicating the subset of covariates for which spatial lags have to be added. We estimate also, as for the OLS estimator, the variant of the model that imposes the theoretical restrictions on the coefficients. The results are presented in <a href="#tbl-results_ertu_koch">Table&nbsp;<span>9.1</span></a>. </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-spatial/spatialreg/">spatialreg</a></span><span class="op">)</span></span>
<span><span class="va">m1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/spatialreg/reference/ML_models.html">lagsarlm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">gdp95</span><span class="op">)</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span>, </span>
<span>               <span class="va">sp_solow2</span>, <span class="va">W1</span>, Durbin <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">m2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/spatialreg/reference/ML_models.html">errorsarlm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">gdp95</span><span class="op">)</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span>, </span>
<span>                 <span class="va">sp_solow2</span>, <span class="va">W1</span>, Durbin <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">m3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/spatialreg/reference/ML_models.html">sacsarlm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">gdp95</span><span class="op">)</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span>, </span>
<span>               <span class="va">sp_solow2</span>, <span class="va">W1</span>, Durbin <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">m1c</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">m1</span>, <span class="va">.</span> <span class="op">~</span> <span class="va">.</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">sp_solow3</span><span class="op">)</span></span>
<span><span class="va">m2c</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">m2</span>, <span class="va">.</span> <span class="op">~</span> <span class="va">.</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">sp_solow3</span><span class="op">)</span></span>
<span><span class="va">m3c</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">m3</span>, <span class="va">.</span> <span class="op">~</span> <span class="va">.</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">sp_solow3</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can first test the theoretical restrictions using either a likelihood ratio or a Wald test: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">lmtest</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-forge.r-project.org/projects/car/">car</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/car/man/linearHypothesis.html">linearHypothesis</a></span><span class="op">(</span><span class="va">ols_solow</span>, <span class="st">"log(i) + log(v) = 0"</span>, </span>
<span>                 test <span class="op">=</span> <span class="st">"Chisq"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">gaze</span></span>
<span><span class="co">## Chisq = 4.427, df: 1, pval = 0.035</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/lmtest/man/lrtest.html">lrtest</a></span><span class="op">(</span><span class="va">ols_solow</span>, <span class="va">ols_solowc</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">gaze</span></span>
<span><span class="co">## Chisq = 4.467, df: 1, pval = 0.035</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/car/man/linearHypothesis.html">linearHypothesis</a></span><span class="op">(</span><span class="va">m1</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"log(i) + log(v) = 0"</span>, </span>
<span>                       <span class="st">"lag.log(i) + lag.log(v) = 0"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">gaze</span></span>
<span><span class="co">## Chisq = 2.382, df: 2, pval = 0.304</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/lmtest/man/lrtest.html">lrtest</a></span><span class="op">(</span><span class="va">m1</span>, <span class="va">m1c</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">gaze</span></span>
<span><span class="co">## Chisq = 2.377, df: 2, pval = 0.305</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As seen previously, the theoretical restrictions are rejected at the 5% level using a Wald test for the Solow model. This is not the case for the spatial lag model. Note also that the Wald and the likelihood ratio tests give very similar results. An interesting feature of the model of <span class="citation" data-cites="ERTU:KOCH:07">Ertur and Koch (<a href="#ref-ERTU:KOCH:07" role="doc-biblioref">2007</a>)</span> is that their specification enables the identification of all the structural parameters of the model, <span class="math inline">\(\kappa\)</span>, <span class="math inline">\(\phi\)</span> and <span class="math inline">\(\gamma\)</span>. If <span class="math inline">\(\phi = 0\)</span>, <span class="math inline">\(\theta = \gamma \beta\)</span> and <span class="math inline">\(\rho_y = \gamma\)</span>, so that: <span class="math inline">\(y = \alpha j+ (I - \gamma W)X\beta + \gamma y + \epsilon\)</span>, the reduced form of the model is, in matrix form:</p>
<p><span class="math display">\[
y = \alpha j + X \beta + (I - \gamma W) ^ {-1} \epsilon
\]</span> which is a SEM model without Durbin terms. Therefore, the hypothesis that <span class="math inline">\(\phi = 0\)</span> is in the context of this model the hypothesis of common factors and can easily be tested using a likelihood ratio test: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb84"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/lmtest/man/lrtest.html">lrtest</a></span><span class="op">(</span><span class="va">m1c</span>, <span class="va">m2c</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">gaze</span></span>
<span><span class="co">## Chisq = 7.033, df: 1, pval = 0.008</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The hypothesis of common factor is rejected at the 1% level. Our preferred specification is therefore a spatial lag model imposing the theoretical restrictions. The structural parameters of the model (<span class="math inline">\(s\)</span>) can be computed using the fitted reduced form parameters (<span class="math inline">\(r\)</span>). The relation between <span class="math inline">\(r\)</span> and <span class="math inline">\(s\)</span> is:</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="tbl-results_ertu_koch" class="anchored">

<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<caption>Table&nbsp;9.1:  Results of the growth models </caption>
 <thead><tr>
<th style="text-align:left;">   </th>
   <th style="text-align:center;"> OLS </th>
   <th style="text-align:center;"> SAR </th>
   <th style="text-align:center;"> SEM </th>
   <th style="text-align:center;"> SARMA </th>
   <th style="text-align:center;"> OLSc </th>
   <th style="text-align:center;"> SARc </th>
   <th style="text-align:center;"> SEMc </th>
  </tr></thead>
<tbody>
<tr>
<td style="text-align:left;"> $\ln i$ </td>
   <td style="text-align:center;"> 1.276 </td>
   <td style="text-align:center;"> 0.837 </td>
   <td style="text-align:center;"> 0.843 </td>
   <td style="text-align:center;"> 0.876 </td>
   <td style="text-align:center;"> 1.379 </td>
   <td style="text-align:center;"> 0.863 </td>
   <td style="text-align:center;"> 0.863 </td>
  </tr>
<tr>
<td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.125) </td>
   <td style="text-align:center;"> (0.099) </td>
   <td style="text-align:center;"> (0.099) </td>
   <td style="text-align:center;"> (0.102) </td>
   <td style="text-align:center;"> (0.117) </td>
   <td style="text-align:center;"> (0.099) </td>
   <td style="text-align:center;"> (0.099) </td>
  </tr>
<tr>
<td style="text-align:left;"> $\ln v$ </td>
   <td style="text-align:center;"> −2.709 </td>
   <td style="text-align:center;"> −1.636 </td>
   <td style="text-align:center;"> −1.848 </td>
   <td style="text-align:center;"> −1.737 </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;">  </td>
  </tr>
<tr>
<td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.642) </td>
   <td style="text-align:center;"> (0.555) </td>
   <td style="text-align:center;"> (0.550) </td>
   <td style="text-align:center;"> (0.562) </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;">  </td>
  </tr>
<tr>
<td style="text-align:left;"> $W \ln i$ </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> −0.338 </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> −0.325 </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> −0.278 </td>
   <td style="text-align:center;">  </td>
  </tr>
<tr>
<td style="text-align:left;">  </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> (0.182) </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> (0.392) </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> (0.179) </td>
   <td style="text-align:center;">  </td>
  </tr>
<tr>
<td style="text-align:left;"> $W\ln v$ </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> 0.566 </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> 0.076 </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;">  </td>
  </tr>
<tr>
<td style="text-align:left;">  </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> (0.851) </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> (1.398) </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;">  </td>
  </tr>
<tr>
<td style="text-align:left;"> $\rho_y$ </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> 0.746 </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> 0.633 </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> 0.740 </td>
   <td style="text-align:center;">  </td>
  </tr>
<tr>
<td style="text-align:left;">  </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> (0.070) </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> (0.338) </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> (0.070) </td>
   <td style="text-align:center;">  </td>
  </tr>
<tr>
<td style="text-align:left;"> $\rho_\epsilon$ </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> 0.823 </td>
   <td style="text-align:center;"> 0.317 </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> 0.835 </td>
  </tr>
<tr>
<td style="text-align:left;box-shadow: 0px 1.5px">  </td>
   <td style="text-align:center;box-shadow: 0px 1.5px">  </td>
   <td style="text-align:center;box-shadow: 0px 1.5px">  </td>
   <td style="text-align:center;box-shadow: 0px 1.5px"> (0.053) </td>
   <td style="text-align:center;box-shadow: 0px 1.5px"> (0.509) </td>
   <td style="text-align:center;box-shadow: 0px 1.5px">  </td>
   <td style="text-align:center;box-shadow: 0px 1.5px">  </td>
   <td style="text-align:center;box-shadow: 0px 1.5px"> (0.050) </td>
  </tr>
<tr>
<td style="text-align:left;"> Num.Obs. </td>
   <td style="text-align:center;"> 91 </td>
   <td style="text-align:center;"> 91 </td>
   <td style="text-align:center;"> 91 </td>
   <td style="text-align:center;"> 91 </td>
   <td style="text-align:center;"> 91 </td>
   <td style="text-align:center;"> 91 </td>
   <td style="text-align:center;"> 91 </td>
  </tr>
<tr>
<td style="text-align:left;"> Log.Lik. </td>
   <td style="text-align:center;"> −102.177 </td>
   <td style="text-align:center;"> −73.451 </td>
   <td style="text-align:center;"> −76.569 </td>
   <td style="text-align:center;"> −72.912 </td>
   <td style="text-align:center;"> −104.410 </td>
   <td style="text-align:center;"> −74.640 </td>
   <td style="text-align:center;"> −78.156 </td>
  </tr>
<tr>
<td style="text-align:left;"> F </td>
   <td style="text-align:center;"> 74.025 </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> 138.297 </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;">  </td>
  </tr>
</tbody>
</table>
</div>
</div>
</div>
<p><span class="math display">\[
r ^ \top = (\beta, \theta, \rho) =
\left(\frac{\kappa + \phi}{1 - \kappa - \phi}, - \gamma \frac{\kappa}{1 - \kappa - \phi}, \gamma \frac{1 - \kappa}{1 - \kappa - \phi}\right)
\]</span> Inversing this relation, we get the structural parameters <span class="math inline">\(s\)</span> as a function of the reduced form parameters:</p>
<p><span class="math display">\[
s ^ \top = (\kappa, \phi, \gamma) = \left(\frac{\theta}{\theta - \rho}, \frac{\beta}{1 + \beta} - \frac{\theta}{\theta - \rho}, \frac{\rho - \theta}{1 + \beta}\right)
\]</span></p>
<p>For our model, we get: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb85"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unname.html">unname</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">m1c</span><span class="op">)</span><span class="op">[</span><span class="st">"log(i)"</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">theta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unname.html">unname</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">m1c</span><span class="op">)</span><span class="op">[</span><span class="st">"lag.log(i)"</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">rho</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unname.html">unname</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">m1c</span><span class="op">)</span><span class="op">[</span><span class="st">"rho"</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">kappa</span> <span class="op">&lt;-</span> <span class="va">theta</span> <span class="op">/</span> <span class="op">(</span><span class="va">theta</span> <span class="op">-</span> <span class="va">rho</span><span class="op">)</span></span>
<span><span class="va">phi</span> <span class="op">&lt;-</span> <span class="va">beta</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">beta</span><span class="op">)</span> <span class="op">-</span> <span class="va">theta</span> <span class="op">/</span> <span class="op">(</span><span class="va">theta</span> <span class="op">-</span> <span class="va">rho</span><span class="op">)</span></span>
<span><span class="va">gamma</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">rho</span> <span class="op">-</span> <span class="va">theta</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">beta</span><span class="op">)</span></span>
<span><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>kappa <span class="op">=</span> <span class="va">kappa</span>, phi <span class="op">=</span> <span class="va">phi</span>, gamma <span class="op">=</span> <span class="va">gamma</span><span class="op">)</span></span>
<span><span class="va">s</span></span>
<span><span class="co">##  kappa    phi  gamma </span></span>
<span><span class="co">## 0.2729 0.1902 0.5463</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p> To apply the delta method, we compute the matrix of derivatives of <span class="math inline">\(s\)</span> with respect to <span class="math inline">\(r\)</span>:</p>
<p><span class="math display">\[
\Gamma(r) = \frac{\partial s}{\partial r ^ \top}(r)=
\left(
\begin{array}{rcl}
0                                       &amp; - \frac{\rho}{(\theta - \rho) ^ 2} &amp; \frac{\theta}{(\theta - \rho) ^ 2} \\
\frac{1}{(1 + \beta) ^ 2}               &amp; \frac{\rho}{(\theta - \rho) ^ 2}   &amp; - \frac{\theta}{(\theta - \rho) ^ 2} \\
- \frac{\theta - \rho}{(1 + \beta) ^ 2} &amp; - \frac{1}{1 + \beta}                 &amp; \frac{1}{1 + \beta}
\end{array}
\right)
\]</span> and the asymptotic variance of <span class="math inline">\(s\)</span> is then:</p>
<p><span class="math display">\[
\hat{V}(\hat{r}) = \Gamma(\hat{r}) \hat{V}(\hat{s})\Gamma(\hat{r}) ^ \top
\]</span> </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb86"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">Vr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/vcov.html">vcov</a></span><span class="op">(</span><span class="va">m1c</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"log(i)"</span>, <span class="st">"lag.log(i)"</span>, <span class="st">"rho"</span><span class="op">)</span>, </span>
<span>                <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"log(i)"</span>, <span class="st">"lag.log(i)"</span>, <span class="st">"rho"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">G</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, </span>
<span>       <span class="op">-</span> <span class="va">rho</span> <span class="op">/</span> <span class="op">(</span><span class="va">theta</span> <span class="op">-</span> <span class="va">rho</span><span class="op">)</span> <span class="op">^</span> <span class="fl">2</span>, <span class="va">theta</span> <span class="op">/</span> <span class="op">(</span><span class="va">theta</span> <span class="op">-</span> <span class="va">rho</span><span class="op">)</span> <span class="op">^</span> <span class="fl">2</span>,</span>
<span>       <span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">beta</span><span class="op">)</span> <span class="op">^</span> <span class="fl">2</span>, <span class="va">rho</span> <span class="op">/</span> <span class="op">(</span><span class="va">theta</span> <span class="op">-</span> <span class="va">rho</span><span class="op">)</span> <span class="op">^</span> <span class="fl">2</span>, </span>
<span>       <span class="op">-</span> <span class="va">theta</span> <span class="op">/</span> <span class="op">(</span><span class="va">theta</span> <span class="op">-</span> <span class="va">rho</span><span class="op">)</span> <span class="op">^</span> <span class="fl">2</span>,</span>
<span>       <span class="op">(</span><span class="va">theta</span> <span class="op">-</span> <span class="va">rho</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">beta</span><span class="op">)</span> <span class="op">^</span> <span class="fl">2</span>, </span>
<span>       <span class="op">-</span> <span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">beta</span><span class="op">)</span>, <span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">beta</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">G</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">G</span>, nrow <span class="op">=</span> <span class="fl">3</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">V</span> <span class="op">&lt;-</span> <span class="va">G</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">Vr</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">G</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We finally compute the table of the structural parameters: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb87"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">stdev</span> <span class="op">&lt;-</span> <span class="va">V</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">diag</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">sqrt</span></span>
<span><span class="va">z</span> <span class="op">&lt;-</span> <span class="va">s</span> <span class="op">/</span> <span class="va">stdev</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">pnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">z</span><span class="op">)</span>, lower.tail <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2</span></span>
<span><span class="va">struct_par</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span>Estimate <span class="op">=</span> <span class="va">s</span>, <span class="st">"Std. Error"</span> <span class="op">=</span> <span class="va">stdev</span>, </span>
<span>                    <span class="st">"z value"</span> <span class="op">=</span> <span class="va">z</span>, <span class="st">"Pr(&gt;|z|"</span> <span class="op">=</span> <span class="va">p</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">struct_par</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span></span>
<span><span class="va">struct_par</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      Estimate Std. Error z value   Pr(&gt;|z|
kappa   0.2729     0.1182   2.309 2.095e-02
phi     0.1902     0.1071   1.775 7.587e-02
gamma   0.5463     0.1159   4.712 2.453e-06</code></pre>
</div>
</div>
<p></p>
<p>The value of <span class="math inline">\(\kappa\)</span> is compatible with the observable share of the profits in the national product. <span class="math inline">\(\phi\)</span> is significant only at the 10% level. Finally, <span class="math inline">\(\gamma\)</span> is highly significant, which is a confirmation of the relevance of the model of <span class="citation" data-cites="ERTU:KOCH:07">Ertur and Koch (<a href="#ref-ERTU:KOCH:07" role="doc-biblioref">2007</a>)</span>.</p>


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography">
<div id="ref-ANSE:95" class="csl-entry" role="doc-biblioentry">
Anselin, Luc. 1995. <span>“Local Indicators of Spatial Association—LISA.”</span> <em>Geographical Analysis</em> 27 (2): 93–115. <a href="https://doi.org/10.1111/j.1538-4632.1995.tb00338.x">https://doi.org/10.1111/j.1538-4632.1995.tb00338.x</a>.
</div>
<div id="ref-ANSE:BERA:FLOR:YOON:96" class="csl-entry" role="doc-biblioentry">
Anselin, Luc, Anil K. Bera, Raymond Florax, and Mann J. Yoon. 1996. <span>“Simple Diagnostic Tests for Spatial Dependence.”</span> <em>Regional Science and Urban Economics</em> 26 (1): 77–104. <a href="https://doi.org/10.1016/0166-0462(95)02111-6">https://doi.org/10.1016/0166-0462(95)02111-6</a>.
</div>
<div id="ref-BIVA:WONG:18" class="csl-entry" role="doc-biblioentry">
Bivand, Roger S., and David W. S. Wong. 2018. <span>“Comparing Implementations of Global and Local Indicators of Spatial Association.”</span> <em>Test</em> 27: 716–48.
</div>
<div id="ref-BIVA:MILL:PIRA:21" class="csl-entry" role="doc-biblioentry">
Bivand, Roger, Giovanni Millo, and Gianfranco Piras. 2021. <span>“A Review of Software for Spatial Econometrics in r.”</span> <em>Mathematics</em> 9 (11). <a href="https://doi.org/10.3390/math9111276">https://doi.org/10.3390/math9111276</a>.
</div>
<div id="ref-ERTU:KOCH:07" class="csl-entry" role="doc-biblioentry">
Ertur, Cem, and Wilfried Koch. 2007. <span>“Growth, Technological Interdependence and Spatial Externalities: Theory and Evidence.”</span> <em>Journal of Applied Econometrics</em> 22 (6): 1033–62. <a href="http://www.jstor.org/stable/25146563">http://www.jstor.org/stable/25146563</a>.
</div>
<div id="ref-GIRA:23" class="csl-entry" role="doc-biblioentry">
Giraud, Timothée. 2023. <em>Mapsf: Thematic Cartography</em>. <a href="https://CRAN.R-project.org/package=mapsf">https://CRAN.R-project.org/package=mapsf</a>.
</div>
<div id="ref-HIJM:23" class="csl-entry" role="doc-biblioentry">
Hijmans, Robert J. 2023. <em>Terra: Spatial Data Analysis</em>. <a href="https://CRAN.R-project.org/package=terra">https://CRAN.R-project.org/package=terra</a>.
</div>
<div id="ref-KUMA:18" class="csl-entry" role="doc-biblioentry">
Kumar, Anil. 2018. <span>“Do Restrictions on Home Equity Extraction Contribute to Lower Mortgage Defaults? Evidence from a Policy Discontinuity at the Texas Border.”</span> <em>American Economic Journal: Economic Policy</em> 10 (1): 268–97. <a href="https://www.jstor.org/stable/26529015">https://www.jstor.org/stable/26529015</a>.
</div>
<div id="ref-PEBE:BIVA:23" class="csl-entry" role="doc-biblioentry">
Pebesma, Edzer, and Roger S. Bivand. 2023. <em>Spatial Data Science with Applications in <span>R</span></em>. Chapman &amp; Hall. <a href="https://r-spatial.org/book/">https://r-spatial.org/book/</a>.
</div>
<div id="ref-ROME:86" class="csl-entry" role="doc-biblioentry">
Romer, Paul M. 1986. <span>“Increasing Returns and Long-Run Growth.”</span> <em>Journal of Political Economy</em> 94 (5): 1002–37. <a href="http://www.jstor.org/stable/1833190">http://www.jstor.org/stable/1833190</a>.
</div>
<div id="ref-TENN:18" class="csl-entry" role="doc-biblioentry">
Tennekes, Martijn. 2018. <span>“<span class="nocase">tmap</span>: Thematic Maps in <span>R</span>.”</span> <em>Journal of Statistical Software</em> 84 (6): 1–39. <a href="https://doi.org/10.18637/jss.v084.i06">https://doi.org/10.18637/jss.v084.i06</a>.
</div>
<div id="ref-WHEE:03" class="csl-entry" role="doc-biblioentry">
Wheeler, Christopher H. 2003. <span>“Evidence on Agglomeration Economies, Diseconomies, and Growth.”</span> <em>Journal of Applied Econometrics</em> 18 (1): 79–104. <a href="http://www.jstor.org/stable/30035189">http://www.jstor.org/stable/30035189</a>.
</div>
</div>
</section></section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><hr>
<ol>
<li id="fn1"><p><strong>sf</strong> <span class="citation" data-cites="PEBE:BIVA:23">(<a href="#ref-PEBE:BIVA:23" role="doc-biblioref">Pebesma and Bivand 2023</a>)</span> and <strong>terra</strong> <span class="citation" data-cites="HIJM:23">(<a href="#ref-HIJM:23" role="doc-biblioref">Hijmans 2023</a>)</span> respectively supersede the <strong>sp</strong> and the <strong>raster</strong> packages.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>The latitude is a coordinate that specifies the north/south position of a point on earth. It is an angular value equal to 0 at the equator and to -/+ 90 at the pole. The value is positive in the northern hemisphere and negative in the southern hemisphere.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>The longitude is a coordinate that specifies the east/west position of a point on earth. Meridians are lines that connect the two poles, and the longitude is the angular value of the position of a point to the reference (Greenwich) meridian.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>This function is an interface to the <a href="http://www.gadm.org" class="uri">http://www.gadm.org</a> site which provides the boundaries of all countries in the world with different administrative level. The second argument set to 1 means that we want the boundaries of French regions, and the third argument set to <code>"."</code> means that the file is stored in the current directory.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>It is actually an object of class <code>SpatVector</code>, used by the <strong>terra</strong> package.<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6"><p>With the convention that the sign of the distance is different on both sides of the border.<a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn7"><p>0.05 being the sum of the rate of depreciation and the rate of technical progress, assumed to be the same for all countries.<a href="#fnref7" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn8"><p>&lt;<a href="https://www.naturalearthdata.com/" class="uri">https://www.naturalearthdata.com/</a>&gt;<a href="#fnref8" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn9"><p>&lt;<a href="https://gadm.org/" class="uri">https://gadm.org/</a>&gt;<a href="#fnref9" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn10"><p>The expression of the variance of the Moran statistic can be found in <span class="citation" data-cites="BIVA:WONG:18">R. S. Bivand and Wong (<a href="#ref-BIVA:WONG:18" role="doc-biblioref">2018</a>)</span>.<a href="#fnref10" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn11"><p>Note that we also rename for convenience the fifth column which has a non-standard name (<code>Pr(z != E(Ii))</code>) to <code>pval</code>.<a href="#fnref11" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn12"><p>Note that the orders of the levels are reversed using <code><a href="https://forcats.tidyverse.org/reference/fct_rev.html">forcats::fct_rev</a></code>, so that the high values are represented in dark gray.<a href="#fnref12" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn13"><p>This model is also known as the spatial lag model.<a href="#fnref13" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="../chapters/treateff.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Treatment effect</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../special_responses.html" class="pagination-link">
        <span class="nav-page-text">Special responses</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb89" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Spatial econometrics {#sec-spatial_econometrics}</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"../_commonR.R"</span>)</span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a>st_nb <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">queen =</span> <span class="cn">TRUE</span>){</span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true" tabindex="-1"></a>    .crs <span class="ot">&lt;-</span> <span class="fu">st_crs</span>(x)</span>
<span id="cb89-10"><a href="#cb89-10" aria-hidden="true" tabindex="-1"></a>    .nb <span class="ot">&lt;-</span> <span class="fu">poly2nb</span>(x, <span class="at">queen =</span> queen)</span>
<span id="cb89-11"><a href="#cb89-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as</span>(<span class="fu">nb2lines</span>(.nb, <span class="at">coords =</span> <span class="fu">st_centroid</span>(<span class="fu">st_geometry</span>(x))), <span class="st">"sf"</span>)</span>
<span id="cb89-12"><a href="#cb89-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb89-13"><a href="#cb89-13" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-14"><a href="#cb89-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-15"><a href="#cb89-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-16"><a href="#cb89-16" aria-hidden="true" tabindex="-1"></a>Spatial econometrics is a very dynamic field in modern econometrics. Geolocated data are now frequently available, even when the data doesn't concern geographic entities like countries, regions or towns, but households or firms. From their geographic coordinates, one is able to define for every observation a set of neighbors, and the interactions between neighbors can then be taken into account. There are two very different types of geographical data: vectors and rasters. A vector is a point or a set of points that define a line. A raster is a grid that contains the value of one variable (for example, a numeric indicating the elevation or a factor indicating land use). Relatively recently, two **R** packages have emerged that provide plenty of function that enables to deal easily with vectors and rasters. These are respectively **sf** (**simple feature**) and **terra**.^[**sf** [@PEBE:BIVA:23]\index[author]{Pebesma}\index[author]{Bivand} and **terra** [@HIJM:23] respectively supersede the **sp** and the **raster** packages.] In this chapter, we'll consider only vectors.</span>
<span id="cb89-17"><a href="#cb89-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-18"><a href="#cb89-18" aria-hidden="true" tabindex="-1"></a>The first two sections are devoted to simple features; @sec-simple_features presents the structure of simple features objects and @sec-sf_computation, using the example of a spatial RD design, illustrates how to deal with simple features in a statistical analysis. @sec-spatial_correlation deals with the detection and the measurement of spatial correlation. Finally, @sec-spatial_models presents some popular spatial models, namely the spatial error and the spatial autoregressive models.</span>
<span id="cb89-19"><a href="#cb89-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-20"><a href="#cb89-20" aria-hidden="true" tabindex="-1"></a><span class="fu">## Simple features {#sec-simple_features}</span></span>
<span id="cb89-21"><a href="#cb89-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-22"><a href="#cb89-22" aria-hidden="true" tabindex="-1"></a>In a spatial statistical analysis, the first task is to get geographical information about the</span>
<span id="cb89-23"><a href="#cb89-23" aria-hidden="true" tabindex="-1"></a>observations. This is usually done by importing external files in</span>
<span id="cb89-24"><a href="#cb89-24" aria-hidden="true" tabindex="-1"></a>**R**, for example shapefiles. This task is performed by the **sf**</span>
<span id="cb89-25"><a href="#cb89-25" aria-hidden="true" tabindex="-1"></a>library and the result is an <span class="in">`sf`</span> object. </span>
<span id="cb89-26"><a href="#cb89-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-27"><a href="#cb89-27" aria-hidden="true" tabindex="-1"></a><span class="fu">### Structure of a simple feature {#sec-struct_sf}</span></span>
<span id="cb89-28"><a href="#cb89-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-29"><a href="#cb89-29" aria-hidden="true" tabindex="-1"></a>To understand what a simple feature is, it is best to</span>
<span id="cb89-30"><a href="#cb89-30" aria-hidden="true" tabindex="-1"></a>construct a small one "by hand". The geographical representation of</span>
<span id="cb89-31"><a href="#cb89-31" aria-hidden="true" tabindex="-1"></a>an observation is an <span class="in">`sfg`</span> for simple feature geometry. It can be a</span>
<span id="cb89-32"><a href="#cb89-32" aria-hidden="true" tabindex="-1"></a>point, a set of points that form a line or a polygon if the line ends</span>
<span id="cb89-33"><a href="#cb89-33" aria-hidden="true" tabindex="-1"></a>where it started.</span>
<span id="cb89-34"><a href="#cb89-34" aria-hidden="true" tabindex="-1"></a>We first load the **sf** package:</span>
<span id="cb89-35"><a href="#cb89-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-36"><a href="#cb89-36" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb89-37"><a href="#cb89-37" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: true</span></span>
<span id="cb89-38"><a href="#cb89-38" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb89-39"><a href="#cb89-39" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-40"><a href="#cb89-40" aria-hidden="true" tabindex="-1"></a>The message indicates that **sf** uses three important external</span>
<span id="cb89-41"><a href="#cb89-41" aria-hidden="true" tabindex="-1"></a>libraries:</span>
<span id="cb89-42"><a href="#cb89-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-43"><a href="#cb89-43" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**GEOS** to compute topological operations,</span>
<span id="cb89-44"><a href="#cb89-44" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**GDAL** to read external files with a large variety of formats,</span>
<span id="cb89-45"><a href="#cb89-45" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**PROJ** to transform the coordinates in a specific **CRS**</span>
<span id="cb89-46"><a href="#cb89-46" aria-hidden="true" tabindex="-1"></a>  (coordinate reference system). </span>
<span id="cb89-47"><a href="#cb89-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-48"><a href="#cb89-48" aria-hidden="true" tabindex="-1"></a>We consider in this example the three main cities in</span>
<span id="cb89-49"><a href="#cb89-49" aria-hidden="true" tabindex="-1"></a>France. For Paris, the latitude^[The latitude is a coordinate that</span>
<span id="cb89-50"><a href="#cb89-50" aria-hidden="true" tabindex="-1"></a>specifies the north/south position of a point on earth. It is an angular value equal to 0 at</span>
<span id="cb89-51"><a href="#cb89-51" aria-hidden="true" tabindex="-1"></a>the equator and to -/+ 90 at the pole. The value is positive in the northern</span>
<span id="cb89-52"><a href="#cb89-52" aria-hidden="true" tabindex="-1"></a>hemisphere and negative in the southern hemisphere.] is $48.87$ and the longitude^[The longitude is a</span>
<span id="cb89-53"><a href="#cb89-53" aria-hidden="true" tabindex="-1"></a>coordinate that specifies the east/west position of a point on</span>
<span id="cb89-54"><a href="#cb89-54" aria-hidden="true" tabindex="-1"></a>earth. Meridians are lines that connect the two poles, and the</span>
<span id="cb89-55"><a href="#cb89-55" aria-hidden="true" tabindex="-1"></a>longitude is the angular value of the position of a point to the</span>
<span id="cb89-56"><a href="#cb89-56" aria-hidden="true" tabindex="-1"></a>reference (Greenwich) meridian.] is $2.33$.</span>
<span id="cb89-57"><a href="#cb89-57" aria-hidden="true" tabindex="-1"></a>Most of **sf**'s functions start with <span class="in">`st_`</span>. The <span class="in">`st_point`</span> function can be used to construct a <span class="in">`sfg`</span> (simple feature geometry) for Paris, the argument being a numeric vector containing the longitude and the latitude.</span>
<span id="cb89-58"><a href="#cb89-58" aria-hidden="true" tabindex="-1"></a>\idxfun{st<span class="sc">\_</span>point}{sf}</span>
<span id="cb89-59"><a href="#cb89-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-60"><a href="#cb89-60" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb89-61"><a href="#cb89-61" aria-hidden="true" tabindex="-1"></a><span class="co">#| results: true</span></span>
<span id="cb89-62"><a href="#cb89-62" aria-hidden="true" tabindex="-1"></a>paris <span class="ot">&lt;-</span> <span class="fu">st_point</span>(<span class="fu">c</span>(<span class="fl">2.33</span>, <span class="fl">48.87</span>))</span>
<span id="cb89-63"><a href="#cb89-63" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-64"><a href="#cb89-64" aria-hidden="true" tabindex="-1"></a>We then perform the same operation for Lyon and Marseilles:</span>
<span id="cb89-65"><a href="#cb89-65" aria-hidden="true" tabindex="-1"></a>\idxfun{st<span class="sc">\_</span>point}{sf}</span>
<span id="cb89-66"><a href="#cb89-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-67"><a href="#cb89-67" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb89-68"><a href="#cb89-68" aria-hidden="true" tabindex="-1"></a>lyon <span class="ot">&lt;-</span> <span class="fu">st_point</span>(<span class="fu">c</span>(<span class="fl">4.85</span>, <span class="fl">45.76</span>))</span>
<span id="cb89-69"><a href="#cb89-69" aria-hidden="true" tabindex="-1"></a>marseilles <span class="ot">&lt;-</span> <span class="fu">st_point</span>(<span class="fu">c</span>(<span class="fl">5.37</span>, <span class="fl">43.30</span>))</span>
<span id="cb89-70"><a href="#cb89-70" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-71"><a href="#cb89-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-72"><a href="#cb89-72" aria-hidden="true" tabindex="-1"></a>We then construct a <span class="in">`sfc`</span> (simple feature column) which is a set</span>
<span id="cb89-73"><a href="#cb89-73" aria-hidden="true" tabindex="-1"></a>of <span class="in">`sfg`</span>s, using the <span class="in">`st_sfc`</span> function. The different elements are entered as unnamed arguments of</span>
<span id="cb89-74"><a href="#cb89-74" aria-hidden="true" tabindex="-1"></a>the function and a <span class="in">`crs`</span> argument can be used to specify the</span>
<span id="cb89-75"><a href="#cb89-75" aria-hidden="true" tabindex="-1"></a>**CRS**. Three formats exist to describe the **CRS**: **proj4string** (a character string), **EPSG** (an integer), and **WKT**, for well known text (a list).</span>
<span id="cb89-76"><a href="#cb89-76" aria-hidden="true" tabindex="-1"></a>We can use here either <span class="in">`"+proj=longlat +datum=WGS84 +no_defs"`</span> or</span>
<span id="cb89-77"><a href="#cb89-77" aria-hidden="true" tabindex="-1"></a><span class="in">`4326`</span>. The datum is the representation of the earth from which the</span>
<span id="cb89-78"><a href="#cb89-78" aria-hidden="true" tabindex="-1"></a>latitudes and the longitudes are computed. </span>
<span id="cb89-79"><a href="#cb89-79" aria-hidden="true" tabindex="-1"></a>\idxfun{st<span class="sc">\_</span>sfc}{sf}</span>
<span id="cb89-80"><a href="#cb89-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-81"><a href="#cb89-81" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb89-82"><a href="#cb89-82" aria-hidden="true" tabindex="-1"></a>cities_coords <span class="ot">&lt;-</span> <span class="fu">st_sfc</span>(paris, lyon, marseilles, <span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb89-83"><a href="#cb89-83" aria-hidden="true" tabindex="-1"></a>cities_coords</span>
<span id="cb89-84"><a href="#cb89-84" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-85"><a href="#cb89-85" aria-hidden="true" tabindex="-1"></a>Printing the <span class="in">`sfc`</span> gives interesting information, as the bounding box</span>
<span id="cb89-86"><a href="#cb89-86" aria-hidden="true" tabindex="-1"></a>(the coordinates of the rectangle that contains the data) and the **CRS**.</span>
<span id="cb89-87"><a href="#cb89-87" aria-hidden="true" tabindex="-1"></a>Finally, we can construct a <span class="in">`sf`</span> object using <span class="in">`st_sf`</span> by binding a data frame containing information about the cities and the <span class="in">`sfc`</span>. </span>
<span id="cb89-88"><a href="#cb89-88" aria-hidden="true" tabindex="-1"></a>\idxfun{tibble}{tibble}\idxfun{st<span class="sc">\_</span>sf}{sf}</span>
<span id="cb89-89"><a href="#cb89-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-90"><a href="#cb89-90" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb89-91"><a href="#cb89-91" aria-hidden="true" tabindex="-1"></a>cities_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">pop =</span> <span class="fu">c</span>(<span class="fl">2.161</span>, <span class="fl">0.513</span>, <span class="fl">0.861</span>),</span>
<span id="cb89-92"><a href="#cb89-92" aria-hidden="true" tabindex="-1"></a>                      <span class="at">area =</span> <span class="fu">c</span>(<span class="fl">105.4</span>, <span class="fl">47.87</span>, <span class="fl">240.6</span>))</span>
<span id="cb89-93"><a href="#cb89-93" aria-hidden="true" tabindex="-1"></a>cities <span class="ot">&lt;-</span> <span class="fu">st_sf</span>(cities_data, cities_coords)</span>
<span id="cb89-94"><a href="#cb89-94" aria-hidden="true" tabindex="-1"></a>cities</span>
<span id="cb89-95"><a href="#cb89-95" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-96"><a href="#cb89-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-97"><a href="#cb89-97" aria-hidden="true" tabindex="-1"></a>A <span class="in">`sf`</span> is just a data frame with a specific column that contains the</span>
<span id="cb89-98"><a href="#cb89-98" aria-hidden="true" tabindex="-1"></a>coordinates of the observations. This column (called the geometry column) can be</span>
<span id="cb89-99"><a href="#cb89-99" aria-hidden="true" tabindex="-1"></a>extracted using the <span class="in">`st_geometry`</span> function:</span>
<span id="cb89-100"><a href="#cb89-100" aria-hidden="true" tabindex="-1"></a>\idxfun{st<span class="sc">\_</span>geometry}{sf}</span>
<span id="cb89-101"><a href="#cb89-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-102"><a href="#cb89-102" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb89-103"><a href="#cb89-103" aria-hidden="true" tabindex="-1"></a><span class="co">#| results: "hide"</span></span>
<span id="cb89-104"><a href="#cb89-104" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb89-105"><a href="#cb89-105" aria-hidden="true" tabindex="-1"></a>cities <span class="sc">%&gt;%</span> st_geometry</span>
<span id="cb89-106"><a href="#cb89-106" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-107"><a href="#cb89-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-108"><a href="#cb89-108" aria-hidden="true" tabindex="-1"></a>and is "sticky", which means that if some columns are selected, the geometry column is always returned along with the selected columns, i.e.:</span>
<span id="cb89-109"><a href="#cb89-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-110"><a href="#cb89-110" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb89-111"><a href="#cb89-111" aria-hidden="true" tabindex="-1"></a><span class="co">#| results: false</span></span>
<span id="cb89-112"><a href="#cb89-112" aria-hidden="true" tabindex="-1"></a>cities <span class="sc">%&gt;%</span> <span class="fu">select</span>(pop)</span>
<span id="cb89-113"><a href="#cb89-113" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-114"><a href="#cb89-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-115"><a href="#cb89-115" aria-hidden="true" tabindex="-1"></a>returns <span class="in">`pop`</span> **and** <span class="in">`cities_coords`</span>, even if the latter colon was not selected.</span>
<span id="cb89-116"><a href="#cb89-116" aria-hidden="true" tabindex="-1"></a>We can then plot our three cities, along with a map of France, which</span>
<span id="cb89-117"><a href="#cb89-117" aria-hidden="true" tabindex="-1"></a>is obtained using the <span class="in">`geodata::gadm`</span> function.^[This function is an</span>
<span id="cb89-118"><a href="#cb89-118" aria-hidden="true" tabindex="-1"></a>interface to the <span class="ot">&lt;http://www.gadm.org&gt;</span> site which provides the</span>
<span id="cb89-119"><a href="#cb89-119" aria-hidden="true" tabindex="-1"></a>boundaries of all countries in the world with different administrative</span>
<span id="cb89-120"><a href="#cb89-120" aria-hidden="true" tabindex="-1"></a>level. The second argument set to 1 means that we want the boundaries</span>
<span id="cb89-121"><a href="#cb89-121" aria-hidden="true" tabindex="-1"></a>of French regions, and the third argument set to <span class="in">`"."`</span> means that the</span>
<span id="cb89-122"><a href="#cb89-122" aria-hidden="true" tabindex="-1"></a>file is stored in the current directory.]</span>
<span id="cb89-123"><a href="#cb89-123" aria-hidden="true" tabindex="-1"></a>\idxfun{gadm}{geodata}</span>
<span id="cb89-124"><a href="#cb89-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-125"><a href="#cb89-125" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb89-126"><a href="#cb89-126" aria-hidden="true" tabindex="-1"></a>france <span class="ot">&lt;-</span> geodata<span class="sc">::</span><span class="fu">gadm</span>(<span class="st">"FR"</span>, <span class="dv">1</span>, <span class="st">"."</span>)</span>
<span id="cb89-127"><a href="#cb89-127" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-128"><a href="#cb89-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-129"><a href="#cb89-129" aria-hidden="true" tabindex="-1"></a><span class="in">`france`</span> is not an object of class <span class="in">`sf`</span>,^<span class="co">[</span><span class="ot">It is actually an object of class `SpatVector`, used by the **terra** package.</span><span class="co">]</span> so we first coerce it to a</span>
<span id="cb89-130"><a href="#cb89-130" aria-hidden="true" tabindex="-1"></a><span class="in">`sf`</span> using the <span class="in">`st_as_sf`</span> function, and then we extract the geometry and the series called <span class="in">`NAME_1`</span> which contains the name of the regions:</span>
<span id="cb89-131"><a href="#cb89-131" aria-hidden="true" tabindex="-1"></a>\idxfun{st<span class="sc">\_</span>as<span class="sc">\_</span>sf}{sf}\idxfun{select}{dplyr}</span>
<span id="cb89-132"><a href="#cb89-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-133"><a href="#cb89-133" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb89-134"><a href="#cb89-134" aria-hidden="true" tabindex="-1"></a>france <span class="ot">&lt;-</span> france <span class="sc">%&gt;%</span> st_as_sf <span class="sc">%&gt;%</span></span>
<span id="cb89-135"><a href="#cb89-135" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="at">region =</span> NAME_1)</span>
<span id="cb89-136"><a href="#cb89-136" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-137"><a href="#cb89-137" aria-hidden="true" tabindex="-1"></a>Imported vector data are often large:</span>
<span id="cb89-138"><a href="#cb89-138" aria-hidden="true" tabindex="-1"></a>\idxfun{object.size}{utils}\idxfun{format}{base}</span>
<span id="cb89-139"><a href="#cb89-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-140"><a href="#cb89-140" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb89-141"><a href="#cb89-141" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: true</span></span>
<span id="cb89-142"><a href="#cb89-142" aria-hidden="true" tabindex="-1"></a>france <span class="sc">%&gt;%</span> object.size <span class="sc">%&gt;%</span> <span class="fu">format</span>(<span class="st">"MB"</span>)</span>
<span id="cb89-143"><a href="#cb89-143" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-144"><a href="#cb89-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-145"><a href="#cb89-145" aria-hidden="true" tabindex="-1"></a>and they can be simplified using the <span class="in">`rmapshaper::ms_simplify`</span></span>
<span id="cb89-146"><a href="#cb89-146" aria-hidden="true" tabindex="-1"></a>function, with a <span class="in">`keep`</span> argument which indicates the degree of</span>
<span id="cb89-147"><a href="#cb89-147" aria-hidden="true" tabindex="-1"></a>simplification ($0.01$ means that we seek to obtain a <span class="in">`sf`</span> 100 times</span>
<span id="cb89-148"><a href="#cb89-148" aria-hidden="true" tabindex="-1"></a>lighter than the initial one).</span>
<span id="cb89-149"><a href="#cb89-149" aria-hidden="true" tabindex="-1"></a>\idxfun{ms<span class="sc">\_</span>simplify}{rmapshaper}\idxfun{object.size}{utils}\idxfun{format}{base}</span>
<span id="cb89-150"><a href="#cb89-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-151"><a href="#cb89-151" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb89-152"><a href="#cb89-152" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: true</span></span>
<span id="cb89-153"><a href="#cb89-153" aria-hidden="true" tabindex="-1"></a>france <span class="ot">&lt;-</span> france <span class="sc">%&gt;%</span></span>
<span id="cb89-154"><a href="#cb89-154" aria-hidden="true" tabindex="-1"></a>    rmapshaper<span class="sc">::</span><span class="fu">ms_simplify</span>(<span class="at">keep =</span> <span class="fl">0.01</span>)</span>
<span id="cb89-155"><a href="#cb89-155" aria-hidden="true" tabindex="-1"></a>france <span class="sc">%&gt;%</span> object.size <span class="sc">%&gt;%</span> <span class="fu">format</span>(<span class="st">"MB"</span>, <span class="at">digits =</span> <span class="dv">2</span>)</span>
<span id="cb89-156"><a href="#cb89-156" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-157"><a href="#cb89-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-158"><a href="#cb89-158" aria-hidden="true" tabindex="-1"></a>**sf** provides a <span class="in">`plot`</span> method to get quickly a map of the data. Note that a thematic map is plotted for all the series of the <span class="in">`sf`</span>, and it is therefore recommended to select first a unique series. If one is only interested in the vectors, they can be extracted before plotting using <span class="in">`st_geometry`</span>:</span>
<span id="cb89-159"><a href="#cb89-159" aria-hidden="true" tabindex="-1"></a>\idxfun{st<span class="sc">\_</span>geometry}{sf}</span>
<span id="cb89-160"><a href="#cb89-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-163"><a href="#cb89-163" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb89-164"><a href="#cb89-164" aria-hidden="true" tabindex="-1"></a><span class="co">#| results: hide</span></span>
<span id="cb89-165"><a href="#cb89-165" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb89-166"><a href="#cb89-166" aria-hidden="true" tabindex="-1"></a>france <span class="sc">%&gt;%</span> st_geometry <span class="sc">%&gt;%</span> plot</span>
<span id="cb89-167"><a href="#cb89-167" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-168"><a href="#cb89-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-169"><a href="#cb89-169" aria-hidden="true" tabindex="-1"></a>For more advanced maps, several specialized packages are available, in particular **tmap** [@TENN:18]\index[author]{Tennekes} and **mapsf** [@GIRA:23]\index[author]{Giraud}. In this chapter, we'll only use **ggplot**, which provides a <span class="in">`geom_sf`</span> function. This geom is very special compared to other geoms, as the kind of geom that is plotted depends on the geometry column of the <span class="in">`sf`</span>: if <span class="in">`cities`</span> is provided as the data argument, points will be plotted; but if <span class="in">`france`</span> is provided, polygons will be drawn. In the following code, we start with <span class="in">`france`</span> as the data argument of <span class="in">`ggplot`</span> and then the call to <span class="in">`geom_sf`</span> results in the drawing of the administrative borders of French regions. Then we use a second time <span class="in">`geom_sf`</span> with this time <span class="in">`cities`</span> as data argument, so that points are drawn for the three cities. We use here <span class="in">`aes(size = pop)`</span> so that the size of the points is related to the population of the cities. The result is presented in @fig-map_france.</span>
<span id="cb89-170"><a href="#cb89-170" aria-hidden="true" tabindex="-1"></a>\idxfun{ggplot}{ggplot2}\idxfun{aes}{ggplot2}\idxfun{geom<span class="sc">\_</span>sf}{ggplot2}</span>
<span id="cb89-171"><a href="#cb89-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-172"><a href="#cb89-172" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb89-173"><a href="#cb89-173" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Map of France with its three main cities"</span></span>
<span id="cb89-174"><a href="#cb89-174" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-map_france</span></span>
<span id="cb89-175"><a href="#cb89-175" aria-hidden="true" tabindex="-1"></a>france <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>() <span class="sc">+</span> <span class="fu">geom_sf</span>() <span class="sc">+</span></span>
<span id="cb89-176"><a href="#cb89-176" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> cities, <span class="fu">aes</span>(<span class="at">size =</span> pop))</span>
<span id="cb89-177"><a href="#cb89-177" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-178"><a href="#cb89-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-179"><a href="#cb89-179" aria-hidden="true" tabindex="-1"></a>**sf** provides several functions to compute values of interest. For example, to get the distance from</span>
<span id="cb89-180"><a href="#cb89-180" aria-hidden="true" tabindex="-1"></a>Paris to Lyon and Marseilles, we would use:</span>
<span id="cb89-181"><a href="#cb89-181" aria-hidden="true" tabindex="-1"></a>\idxfun{st<span class="sc">\_</span>distance}{sf}</span>
<span id="cb89-182"><a href="#cb89-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-183"><a href="#cb89-183" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb89-184"><a href="#cb89-184" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: true</span></span>
<span id="cb89-185"><a href="#cb89-185" aria-hidden="true" tabindex="-1"></a><span class="fu">st_distance</span>(cities[<span class="dv">1</span>, ], cities[<span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>, ])</span>
<span id="cb89-186"><a href="#cb89-186" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-187"><a href="#cb89-187" aria-hidden="true" tabindex="-1"></a><span class="in">`st_distance`</span> always returns a matrix, the number of elements of the</span>
<span id="cb89-188"><a href="#cb89-188" aria-hidden="true" tabindex="-1"></a>first (second) argument being the number of rows (columns) of the matrix. If only</span>
<span id="cb89-189"><a href="#cb89-189" aria-hidden="true" tabindex="-1"></a>one argument is supplied, the result is a square matrix with 0 on the</span>
<span id="cb89-190"><a href="#cb89-190" aria-hidden="true" tabindex="-1"></a>diagonal. Note that the numbers have a unit of measurement, which is here meters. To define a unit and to convert from one unit to another, the **units** package provides the <span class="in">`set_units`</span> function. Consider the following example: we first provide a numeric ($42.195$), we define its unit as kilometers, and then we convert it to miles:</span>
<span id="cb89-191"><a href="#cb89-191" aria-hidden="true" tabindex="-1"></a>\idxfun{set<span class="sc">\_</span>units}{units}</span>
<span id="cb89-192"><a href="#cb89-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-195"><a href="#cb89-195" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb89-196"><a href="#cb89-196" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: true</span></span>
<span id="cb89-197"><a href="#cb89-197" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(units)</span>
<span id="cb89-198"><a href="#cb89-198" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fl">42.195</span></span>
<span id="cb89-199"><a href="#cb89-199" aria-hidden="true" tabindex="-1"></a>dkm <span class="ot">&lt;-</span> d <span class="sc">%&gt;%</span> <span class="fu">set_units</span>(km)</span>
<span id="cb89-200"><a href="#cb89-200" aria-hidden="true" tabindex="-1"></a>dkm</span>
<span id="cb89-201"><a href="#cb89-201" aria-hidden="true" tabindex="-1"></a>dkm <span class="sc">%&gt;%</span> <span class="fu">set_units</span>(miles)</span>
<span id="cb89-202"><a href="#cb89-202" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-203"><a href="#cb89-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-204"><a href="#cb89-204" aria-hidden="true" tabindex="-1"></a>Even when the conversion is simple, it is advisable to use <span class="in">`set_units`</span> instead of applying the conversion "by hand":</span>
<span id="cb89-205"><a href="#cb89-205" aria-hidden="true" tabindex="-1"></a>\idxfun{set<span class="sc">\_</span>units}{units}</span>
<span id="cb89-206"><a href="#cb89-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-209"><a href="#cb89-209" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb89-210"><a href="#cb89-210" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: true</span></span>
<span id="cb89-211"><a href="#cb89-211" aria-hidden="true" tabindex="-1"></a>dm <span class="ot">&lt;-</span> dkm <span class="sc">%&gt;%</span> <span class="fu">set_units</span>(m)</span>
<span id="cb89-212"><a href="#cb89-212" aria-hidden="true" tabindex="-1"></a>dm</span>
<span id="cb89-213"><a href="#cb89-213" aria-hidden="true" tabindex="-1"></a>dkm <span class="sc">*</span> <span class="dv">1000</span></span>
<span id="cb89-214"><a href="#cb89-214" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-215"><a href="#cb89-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-216"><a href="#cb89-216" aria-hidden="true" tabindex="-1"></a>The numerical values are the same, but in the second case the unit hasn't changed and is still kilometers. <span class="in">`st_area`</span> computes the area of a polygon:</span>
<span id="cb89-217"><a href="#cb89-217" aria-hidden="true" tabindex="-1"></a>\idxfun{set<span class="sc">\_</span>units}{units}\idxfun{st<span class="sc">\_</span>area}{sf}</span>
<span id="cb89-218"><a href="#cb89-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-219"><a href="#cb89-219" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb89-220"><a href="#cb89-220" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: true</span></span>
<span id="cb89-221"><a href="#cb89-221" aria-hidden="true" tabindex="-1"></a><span class="fu">st_area</span>(france) <span class="sc">%&gt;%</span> units<span class="sc">::</span><span class="fu">set_units</span>(km <span class="sc">^</span> <span class="dv">2</span>)</span>
<span id="cb89-222"><a href="#cb89-222" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-223"><a href="#cb89-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-224"><a href="#cb89-224" aria-hidden="true" tabindex="-1"></a><span class="fu">### Computation on sf objects {#sec-sf_computation}</span></span>
<span id="cb89-225"><a href="#cb89-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-226"><a href="#cb89-226" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{regression discontinuity!spatial|(}</span>
<span id="cb89-227"><a href="#cb89-227" aria-hidden="true" tabindex="-1"></a>The regression discontinuity framework can be adapted to consider</span>
<span id="cb89-228"><a href="#cb89-228" aria-hidden="true" tabindex="-1"></a>geographic discontinuities. Some entities are considered on both sides</span>
<span id="cb89-229"><a href="#cb89-229" aria-hidden="true" tabindex="-1"></a>of a border and the forcing variable is then the distance to the</span>
<span id="cb89-230"><a href="#cb89-230" aria-hidden="true" tabindex="-1"></a>border.^[With the convention that the sign of the distance is</span>
<span id="cb89-231"><a href="#cb89-231" aria-hidden="true" tabindex="-1"></a>different on both sides of the border.]</span>
<span id="cb89-232"><a href="#cb89-232" aria-hidden="true" tabindex="-1"></a>The <span class="in">`us_counties`</span> data set contains the borders of US counties:</span>
<span id="cb89-233"><a href="#cb89-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-234"><a href="#cb89-234" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb89-235"><a href="#cb89-235" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb89-236"><a href="#cb89-236" aria-hidden="true" tabindex="-1"></a>us_counties <span class="sc">%&gt;%</span> <span class="fu">print</span>(<span class="at">n =</span> <span class="dv">3</span>)</span>
<span id="cb89-237"><a href="#cb89-237" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-238"><a href="#cb89-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-239"><a href="#cb89-239" aria-hidden="true" tabindex="-1"></a>@KUMA:18\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Kumar} investigates the effect of a legal restriction on home equity</span>
<span id="cb89-240"><a href="#cb89-240" aria-hidden="true" tabindex="-1"></a>extraction which is specific to Texas on mortgage defaults. Kumar</span>
<span id="cb89-241"><a href="#cb89-241" aria-hidden="true" tabindex="-1"></a>measures mortgage default rates in Texas and in the bordering states</span>
<span id="cb89-242"><a href="#cb89-242" aria-hidden="true" tabindex="-1"></a>and compares mortgage default rates for counties which are closed to</span>
<span id="cb89-243"><a href="#cb89-243" aria-hidden="true" tabindex="-1"></a>the Texas border (on both sides). Let's first plot the map of the</span>
<span id="cb89-244"><a href="#cb89-244" aria-hidden="true" tabindex="-1"></a>counties, using <span class="in">`ggplot`</span> and <span class="in">`geom_sf`</span> (see @fig-counties):</span>
<span id="cb89-245"><a href="#cb89-245" aria-hidden="true" tabindex="-1"></a>\idxfun{filter}{dplyr}\idxfun{ggplot}{ggplot2}\idxfun{geom<span class="sc">\_</span>sf}{ggplot2}</span>
<span id="cb89-246"><a href="#cb89-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-247"><a href="#cb89-247" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb89-248"><a href="#cb89-248" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-counties</span></span>
<span id="cb89-249"><a href="#cb89-249" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Map of American counties</span></span>
<span id="cb89-250"><a href="#cb89-250" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb89-251"><a href="#cb89-251" aria-hidden="true" tabindex="-1"></a>us_counties <span class="sc">%&gt;%</span></span>
<span id="cb89-252"><a href="#cb89-252" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span> state <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Alaska"</span>, <span class="st">"Hawaii"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb89-253"><a href="#cb89-253" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>() <span class="sc">+</span> <span class="fu">geom_sf</span>()</span>
<span id="cb89-254"><a href="#cb89-254" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-255"><a href="#cb89-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-256"><a href="#cb89-256" aria-hidden="true" tabindex="-1"></a>The polygons can be merged using the <span class="in">`group_by`</span> / <span class="in">`summarise`</span></span>
<span id="cb89-257"><a href="#cb89-257" aria-hidden="true" tabindex="-1"></a>functions of **dplyr**. If the <span class="in">`sf`</span> is grouped by states, the</span>
<span id="cb89-258"><a href="#cb89-258" aria-hidden="true" tabindex="-1"></a>statistics computed by the <span class="in">`summarise`</span> function is performed at the state level and</span>
<span id="cb89-259"><a href="#cb89-259" aria-hidden="true" tabindex="-1"></a>the <span class="in">`geometry`</span> now contains the coordinates of the states. With a void</span>
<span id="cb89-260"><a href="#cb89-260" aria-hidden="true" tabindex="-1"></a>call to <span class="in">`summarise`</span>, we get only this new <span class="in">`geometry`</span>, and we can use it to</span>
<span id="cb89-261"><a href="#cb89-261" aria-hidden="true" tabindex="-1"></a>plot a map of states (see @fig-states):</span>
<span id="cb89-262"><a href="#cb89-262" aria-hidden="true" tabindex="-1"></a>\idxfun{filter}{dplyr}\idxfun{group<span class="sc">\_</span>by}{dplyr}\idxfun{summarise}{dplyr}\idxfun{ggplot}{ggplot2}\idxfun{geom<span class="sc">\_</span>sf}{ggplot2}</span>
<span id="cb89-263"><a href="#cb89-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-264"><a href="#cb89-264" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb89-265"><a href="#cb89-265" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-states</span></span>
<span id="cb89-266"><a href="#cb89-266" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Map of American states</span></span>
<span id="cb89-267"><a href="#cb89-267" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb89-268"><a href="#cb89-268" aria-hidden="true" tabindex="-1"></a>states <span class="ot">&lt;-</span> us_counties <span class="sc">%&gt;%</span></span>
<span id="cb89-269"><a href="#cb89-269" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span> state <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Alaska"</span>, <span class="st">"Hawaii"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb89-270"><a href="#cb89-270" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(state) <span class="sc">%&gt;%</span></span>
<span id="cb89-271"><a href="#cb89-271" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>()</span>
<span id="cb89-272"><a href="#cb89-272" aria-hidden="true" tabindex="-1"></a>states <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>() <span class="sc">+</span> <span class="fu">geom_sf</span>()</span>
<span id="cb89-273"><a href="#cb89-273" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-274"><a href="#cb89-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-275"><a href="#cb89-275" aria-hidden="true" tabindex="-1"></a>To get the border states of Texas, we use spatial indexation, i.e., we use the <span class="in">`[`</span></span>
<span id="cb89-276"><a href="#cb89-276" aria-hidden="true" tabindex="-1"></a>operator. The first argument is used to select rows; it is normally a</span>
<span id="cb89-277"><a href="#cb89-277" aria-hidden="true" tabindex="-1"></a>vector of integers (the positions of the lines to extract), a vector</span>
<span id="cb89-278"><a href="#cb89-278" aria-hidden="true" tabindex="-1"></a>of characters (the names of the lines to extract) or a logical</span>
<span id="cb89-279"><a href="#cb89-279" aria-hidden="true" tabindex="-1"></a>vector. Here we can index an <span class="in">`sf`</span> by another <span class="in">`sf`</span>, and the result is (by</span>
<span id="cb89-280"><a href="#cb89-280" aria-hidden="true" tabindex="-1"></a>default) a new <span class="in">`sf`</span> containing the elements of the first one which has</span>
<span id="cb89-281"><a href="#cb89-281" aria-hidden="true" tabindex="-1"></a>common points with the second one:</span>
<span id="cb89-282"><a href="#cb89-282" aria-hidden="true" tabindex="-1"></a>\idxfun{filter}{dplyr}</span>
<span id="cb89-283"><a href="#cb89-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-284"><a href="#cb89-284" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb89-285"><a href="#cb89-285" aria-hidden="true" tabindex="-1"></a>border_states <span class="ot">&lt;-</span> states[<span class="fu">filter</span>(states, state <span class="sc">==</span> <span class="st">"Texas"</span>), ]</span>
<span id="cb89-286"><a href="#cb89-286" aria-hidden="true" tabindex="-1"></a>border_states</span>
<span id="cb89-287"><a href="#cb89-287" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-288"><a href="#cb89-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-289"><a href="#cb89-289" aria-hidden="true" tabindex="-1"></a>We then compute the Texas border. It is defined by the common points</span>
<span id="cb89-290"><a href="#cb89-290" aria-hidden="true" tabindex="-1"></a>of the borders of Texas and its border states. This is obtained using the</span>
<span id="cb89-291"><a href="#cb89-291" aria-hidden="true" tabindex="-1"></a><span class="in">`st_intersection`</span> function which returns four lines (one for each border</span>
<span id="cb89-292"><a href="#cb89-292" aria-hidden="true" tabindex="-1"></a>state), and the border is then obtained by merging these four lines using</span>
<span id="cb89-293"><a href="#cb89-293" aria-hidden="true" tabindex="-1"></a>the <span class="in">`st_union`</span> function. The result is presented in @fig-border.</span>
<span id="cb89-294"><a href="#cb89-294" aria-hidden="true" tabindex="-1"></a>\idxfun{filter}{dplyr}\idxfun{st<span class="sc">\_</span>geometry}{sf}\idxfun{st<span class="sc">\_</span>intersection}{sf}\idxfun{st<span class="sc">\_</span>union}{sf}</span>
<span id="cb89-295"><a href="#cb89-295" aria-hidden="true" tabindex="-1"></a>\idxfun{ggplot}{ggplot2}\idxfun{geom<span class="sc">\_</span>sf}{ggplot2}\idxfun{geom<span class="sc">\_</span>sf<span class="sc">\_</span>label}{ggplot2}\idxfun{aes}{ggplot2}</span>
<span id="cb89-296"><a href="#cb89-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-297"><a href="#cb89-297" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb89-298"><a href="#cb89-298" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Border states and Texas borders</span></span>
<span id="cb89-299"><a href="#cb89-299" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-border</span></span>
<span id="cb89-300"><a href="#cb89-300" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb89-301"><a href="#cb89-301" aria-hidden="true" tabindex="-1"></a>texas <span class="ot">&lt;-</span> <span class="fu">filter</span>(border_states, state <span class="sc">==</span> <span class="st">"Texas"</span>) <span class="sc">%&gt;%</span> st_geometry</span>
<span id="cb89-302"><a href="#cb89-302" aria-hidden="true" tabindex="-1"></a>border <span class="ot">&lt;-</span> <span class="fu">filter</span>(border_states, state <span class="sc">!=</span> <span class="st">"Texas"</span>) <span class="sc">%&gt;%</span> st_geometry</span>
<span id="cb89-303"><a href="#cb89-303" aria-hidden="true" tabindex="-1"></a>border <span class="ot">&lt;-</span> <span class="fu">st_intersection</span>(texas, border) <span class="sc">%&gt;%</span>  st_union</span>
<span id="cb89-304"><a href="#cb89-304" aria-hidden="true" tabindex="-1"></a>border_states <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb89-305"><a href="#cb89-305" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_sf</span>() <span class="sc">+</span></span>
<span id="cb89-306"><a href="#cb89-306" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> border, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb89-307"><a href="#cb89-307" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_sf_label</span>(<span class="fu">aes</span>(<span class="at">label =</span> state)) </span>
<span id="cb89-308"><a href="#cb89-308" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-309"><a href="#cb89-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-310"><a href="#cb89-310" aria-hidden="true" tabindex="-1"></a>Note the use of <span class="in">`geom_sf_label`</span> function which, is a specialized version of <span class="in">`geom_label`</span> that is suitable for writing labels on a map.</span>
<span id="cb89-311"><a href="#cb89-311" aria-hidden="true" tabindex="-1"></a>We then select the counties that belong to any of these states and</span>
<span id="cb89-312"><a href="#cb89-312" aria-hidden="true" tabindex="-1"></a>we compute the distance to the Texas border. It is defined as the</span>
<span id="cb89-313"><a href="#cb89-313" aria-hidden="true" tabindex="-1"></a>distance between the centroid of the county and the closest point of</span>
<span id="cb89-314"><a href="#cb89-314" aria-hidden="true" tabindex="-1"></a>the border. The centroids are obtained using the <span class="in">`st_centroid`</span></span>
<span id="cb89-315"><a href="#cb89-315" aria-hidden="true" tabindex="-1"></a>function. We've already used <span class="in">`st_distance`</span> to comp</span>
<span id="cb89-316"><a href="#cb89-316" aria-hidden="true" tabindex="-1"></a>ute the distance between two points. It can also be used to compute the (shortest) distance between a point and a line:</span>
<span id="cb89-317"><a href="#cb89-317" aria-hidden="true" tabindex="-1"></a>\idxfun{filter}{dplyr}\idxfun{pull}{dplyr}\idxfun{st<span class="sc">\_</span>geometry}{sf}\idxfun{st<span class="sc">\_</span>centroid}{sf}\idxfun{st<span class="sc">\_</span>distance}{sf}\idxfun{set<span class="sc">\_</span>units}{units}\idxfun{add<span class="sc">\_</span>column}{tibble}\idxfun{head}{utils}</span>
<span id="cb89-318"><a href="#cb89-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-319"><a href="#cb89-319" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb89-320"><a href="#cb89-320" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: true</span></span>
<span id="cb89-321"><a href="#cb89-321" aria-hidden="true" tabindex="-1"></a>border_counties <span class="ot">&lt;-</span> us_counties <span class="sc">%&gt;%</span></span>
<span id="cb89-322"><a href="#cb89-322" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(state <span class="sc">%in%</span> <span class="fu">pull</span>(border_states, state))</span>
<span id="cb89-323"><a href="#cb89-323" aria-hidden="true" tabindex="-1"></a>centroids <span class="ot">&lt;-</span> border_counties <span class="sc">%&gt;%</span> st_geometry <span class="sc">%&gt;%</span> st_centroid</span>
<span id="cb89-324"><a href="#cb89-324" aria-hidden="true" tabindex="-1"></a>dists <span class="ot">&lt;-</span> <span class="fu">st_distance</span>(centroids, border)[, <span class="dv">1</span>] <span class="sc">%&gt;%</span> <span class="fu">set_units</span>(miles)</span>
<span id="cb89-325"><a href="#cb89-325" aria-hidden="true" tabindex="-1"></a>border_counties <span class="ot">&lt;-</span> border_counties <span class="sc">%&gt;%</span> <span class="fu">add_column</span>(dists)</span>
<span id="cb89-326"><a href="#cb89-326" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dists)</span>
<span id="cb89-327"><a href="#cb89-327" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-328"><a href="#cb89-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-329"><a href="#cb89-329" aria-hidden="true" tabindex="-1"></a><span class="in">`st_distance`</span> returns a matrix of distance, each column corresponding</span>
<span id="cb89-330"><a href="#cb89-330" aria-hidden="true" tabindex="-1"></a>to a line of the second argument. As here there is only one line, we</span>
<span id="cb89-331"><a href="#cb89-331" aria-hidden="true" tabindex="-1"></a>convert this matrix to a vector by taking its first column. The unit of the returned values is meters; we convert it to miles, like in the original article and we add this column to the sf.</span>
<span id="cb89-332"><a href="#cb89-332" aria-hidden="true" tabindex="-1"></a>As in the original article, we fill with different colors in @fig-close_counties_dist counties</span>
<span id="cb89-333"><a href="#cb89-333" aria-hidden="true" tabindex="-1"></a>that are less than 25, 50, 75 and 100 miles from the border:</span>
<span id="cb89-334"><a href="#cb89-334" aria-hidden="true" tabindex="-1"></a>\idxfun{mutate}{dplyr}\idxfun{ggplot}{ggplot2}\idxfun{geom<span class="sc">\_</span>sf}{ggplot2}\idxfun{scale<span class="sc">\_</span>fill<span class="sc">\_</span>grey}{ggplot2}\idxfun{geom<span class="sc">\_</span>sf}{ggplot2}\idxfun{aes}{ggplot2}</span>
<span id="cb89-335"><a href="#cb89-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-336"><a href="#cb89-336" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb89-337"><a href="#cb89-337" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-close_counties_dist</span></span>
<span id="cb89-338"><a href="#cb89-338" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Counties close to the Texan border</span></span>
<span id="cb89-339"><a href="#cb89-339" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb89-340"><a href="#cb89-340" aria-hidden="true" tabindex="-1"></a>border_counties <span class="sc">%&gt;%</span></span>
<span id="cb89-341"><a href="#cb89-341" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">dist_class =</span> <span class="fu">cut</span>(dists, <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">25</span>, <span class="dv">50</span>, <span class="dv">75</span>, <span class="dv">100</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb89-342"><a href="#cb89-342" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb89-343"><a href="#cb89-343" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> dist_class)) <span class="sc">+</span></span>
<span id="cb89-344"><a href="#cb89-344" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_grey</span>(<span class="at">na.translate =</span> <span class="cn">FALSE</span>) <span class="sc">+</span> </span>
<span id="cb89-345"><a href="#cb89-345" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> border)</span>
<span id="cb89-346"><a href="#cb89-346" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-347"><a href="#cb89-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-348"><a href="#cb89-348" aria-hidden="true" tabindex="-1"></a>Finally, we select the relevant series from the data set of the</span>
<span id="cb89-349"><a href="#cb89-349" aria-hidden="true" tabindex="-1"></a>paper, called <span class="in">`mortgage_default`</span>, and we merge it with</span>
<span id="cb89-350"><a href="#cb89-350" aria-hidden="true" tabindex="-1"></a><span class="in">`border_counties`</span>:</span>
<span id="cb89-351"><a href="#cb89-351" aria-hidden="true" tabindex="-1"></a>\idxfun{full<span class="sc">\_</span>join}{dplyr}\idxfun{mutate}{dplyr}\idxfun{st<span class="sc">\_</span>sf}{sf}</span>
<span id="cb89-352"><a href="#cb89-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-355"><a href="#cb89-355" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb89-356"><a href="#cb89-356" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb89-357"><a href="#cb89-357" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb89-358"><a href="#cb89-358" aria-hidden="true" tabindex="-1"></a>mortdef_sf <span class="ot">&lt;-</span> mortgage_defaults <span class="sc">%&gt;%</span></span>
<span id="cb89-359"><a href="#cb89-359" aria-hidden="true" tabindex="-1"></a>    <span class="fu">full_join</span>(border_counties, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"fips"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb89-360"><a href="#cb89-360" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_sf</span>(<span class="at">agr =</span> <span class="st">"geometry"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb89-361"><a href="#cb89-361" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">dists =</span> <span class="fu">ifelse</span>(state <span class="sc">==</span> <span class="st">"Texas"</span>, dists, <span class="sc">-</span> dists))</span>
<span id="cb89-362"><a href="#cb89-362" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-363"><a href="#cb89-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-364"><a href="#cb89-364" aria-hidden="true" tabindex="-1"></a>\idxfun{right<span class="sc">\_</span>join}{dplyr}\idxfun{mutate}{dplyr}\idxfun{ifelse}{base}</span>
<span id="cb89-365"><a href="#cb89-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-366"><a href="#cb89-366" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb89-367"><a href="#cb89-367" aria-hidden="true" tabindex="-1"></a>mortdef_sf <span class="ot">&lt;-</span> border_counties <span class="sc">%&gt;%</span> </span>
<span id="cb89-368"><a href="#cb89-368" aria-hidden="true" tabindex="-1"></a>  <span class="fu">right_join</span>(mortgage_defaults, <span class="at">by =</span> <span class="st">"fips"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb89-369"><a href="#cb89-369" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">dists =</span> <span class="fu">ifelse</span>(state <span class="sc">==</span> <span class="st">"Texas"</span>, dists, <span class="sc">-</span> dists))</span>
<span id="cb89-370"><a href="#cb89-370" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-371"><a href="#cb89-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-372"><a href="#cb89-372" aria-hidden="true" tabindex="-1"></a>Note the use of the quite unusual <span class="in">`dplyr::right_join`</span> function. By using <span class="in">`right_join`</span> with <span class="in">`border_counties`</span> as the first argument and <span class="in">`mortgage_defaults`</span> as the second argument, we get an object of the class of the first argument (therefore a <span class="in">`sf`</span>) and we get all the lines of the <span class="in">`mortgage_defaults`</span> tibble and only those of <span class="in">`us_counties`</span> that match.</span>
<span id="cb89-373"><a href="#cb89-373" aria-hidden="true" tabindex="-1"></a>We use the convention that the distance is positive for Texan counties and negative for neighboring states.</span>
<span id="cb89-374"><a href="#cb89-374" aria-hidden="true" tabindex="-1"></a>Finally, we plot the discontinuity in @fig-disc_texas.</span>
<span id="cb89-375"><a href="#cb89-375" aria-hidden="true" tabindex="-1"></a>\idxfun{filter}{dplyr}\idxfun{mutate}{dplyr}\idxfun{ggplot}{ggplot2}\idxfun{geom<span class="sc">\_</span>binmeans}{micsr}</span>
<span id="cb89-376"><a href="#cb89-376" aria-hidden="true" tabindex="-1"></a>\idxfun{aes}{ggplot2}\idxfun{geom<span class="sc">\_</span>smooth}{ggplot2}</span>
<span id="cb89-377"><a href="#cb89-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-378"><a href="#cb89-378" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb89-379"><a href="#cb89-379" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb89-380"><a href="#cb89-380" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Discontinuity of the mortgage defaults data set"</span></span>
<span id="cb89-381"><a href="#cb89-381" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-disc_texas</span></span>
<span id="cb89-382"><a href="#cb89-382" aria-hidden="true" tabindex="-1"></a>mortdef_sf <span class="sc">%&gt;%</span></span>
<span id="cb89-383"><a href="#cb89-383" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="fu">abs</span>(dists) <span class="sc">&lt;</span> <span class="dv">50</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb89-384"><a href="#cb89-384" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">state =</span> <span class="fu">ifelse</span>(state <span class="sc">==</span> <span class="st">"Texas"</span>, <span class="st">"Texas"</span>, <span class="st">"other"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb89-385"><a href="#cb89-385" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(dists, default)) <span class="sc">+</span></span>
<span id="cb89-386"><a href="#cb89-386" aria-hidden="true" tabindex="-1"></a>    micsr<span class="sc">::</span><span class="fu">geom_binmeans</span>(<span class="fu">aes</span>(<span class="at">size =</span> <span class="fu">after_stat</span>(n)), <span class="at">shape =</span> <span class="dv">21</span>) <span class="sc">+</span></span>
<span id="cb89-387"><a href="#cb89-387" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="fu">aes</span>(<span class="at">linetype =</span> state, <span class="at">weight =</span> loans), </span>
<span id="cb89-388"><a href="#cb89-388" aria-hidden="true" tabindex="-1"></a>                <span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">"black"</span>)</span>
<span id="cb89-389"><a href="#cb89-389" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-390"><a href="#cb89-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-391"><a href="#cb89-391" aria-hidden="true" tabindex="-1"></a>The intercept is a bit more than 7% outside the border and about 4.5% inside the border, so that the effect of the Texas specific regulation seems significant (a reduction of about 2.5% of the mortgage default rate).</span>
<span id="cb89-392"><a href="#cb89-392" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{regression discontinuity!spatial|)}</span>
<span id="cb89-393"><a href="#cb89-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-394"><a href="#cb89-394" aria-hidden="true" tabindex="-1"></a><span class="fu">## Two examples</span></span>
<span id="cb89-395"><a href="#cb89-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-396"><a href="#cb89-396" aria-hidden="true" tabindex="-1"></a>To illustrate the techniques presented in the subsequent sections, we'll use two data sets. The first one, from @WHEE:03\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Wheeler}, is called <span class="in">`agglo_growth`</span> and deals with the topic of economies and diseconomies of agglomeration. The second one, called <span class="in">`sp_growth`</span> is from @ERTU:KOCH:07\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Ertur}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Koch} and is used to fit an extension of Solow's growth model.</span>
<span id="cb89-397"><a href="#cb89-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-398"><a href="#cb89-398" aria-hidden="true" tabindex="-1"></a><span class="fu">### Agglomeration economies and diseconomies</span></span>
<span id="cb89-399"><a href="#cb89-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-400"><a href="#cb89-400" aria-hidden="true" tabindex="-1"></a>The <span class="in">`agglo_growth`</span> contains data about US counties in 1990, identified by their fips code.</span>
<span id="cb89-401"><a href="#cb89-401" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">(</span><span class="co">]</span>{agglo<span class="sc">\_</span>growth}{micsr.data}</span>
<span id="cb89-402"><a href="#cb89-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-403"><a href="#cb89-403" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb89-404"><a href="#cb89-404" aria-hidden="true" tabindex="-1"></a>agglo_growth</span>
<span id="cb89-405"><a href="#cb89-405" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-406"><a href="#cb89-406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-407"><a href="#cb89-407" aria-hidden="true" tabindex="-1"></a><span class="in">`emp_gr`</span> and <span class="in">`pop_gr`</span> are the employment and the population growth in each county between 1980 and 1990 and <span class="in">`emp`</span> and <span class="in">`pop`</span> the level of employment and of the population in 1980. </span>
<span id="cb89-408"><a href="#cb89-408" aria-hidden="true" tabindex="-1"></a>@WHEE:03\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Wheeler} investigates the existence of:</span>
<span id="cb89-409"><a href="#cb89-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-410"><a href="#cb89-410" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>agglomeration economies, which implies that the growth of a given</span>
<span id="cb89-411"><a href="#cb89-411" aria-hidden="true" tabindex="-1"></a>  territory will be positively correlated with its size, </span>
<span id="cb89-412"><a href="#cb89-412" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>agglomeration diseconomies for large cities that experience</span>
<span id="cb89-413"><a href="#cb89-413" aria-hidden="true" tabindex="-1"></a>  congestion, crime, pollution, etc.</span>
<span id="cb89-414"><a href="#cb89-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-415"><a href="#cb89-415" aria-hidden="true" tabindex="-1"></a>The hypothesis is therefore that the relation between size and growth</span>
<span id="cb89-416"><a href="#cb89-416" aria-hidden="true" tabindex="-1"></a>should be inverted U shaped, which means that, for small territories, the</span>
<span id="cb89-417"><a href="#cb89-417" aria-hidden="true" tabindex="-1"></a>agglomeration economies effect is dominant; as for large territories,</span>
<span id="cb89-418"><a href="#cb89-418" aria-hidden="true" tabindex="-1"></a>the agglomeration diseconomies becomes dominant. We'll</span>
<span id="cb89-419"><a href="#cb89-419" aria-hidden="true" tabindex="-1"></a>reproduce some of the results using the counties of Louisiana. We first</span>
<span id="cb89-420"><a href="#cb89-420" aria-hidden="true" tabindex="-1"></a>join the tibble to the <span class="in">`sf`</span> called <span class="in">`us_counties`</span> which contains the</span>
<span id="cb89-421"><a href="#cb89-421" aria-hidden="true" tabindex="-1"></a>geometries of the counties that we've already used in the previous section:</span>
<span id="cb89-422"><a href="#cb89-422" aria-hidden="true" tabindex="-1"></a>\idxfun{right<span class="sc">\_</span>join}{dplyr}\idxfun{filter}{dplyr}</span>
<span id="cb89-423"><a href="#cb89-423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-424"><a href="#cb89-424" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb89-425"><a href="#cb89-425" aria-hidden="true" tabindex="-1"></a>louisiana <span class="ot">&lt;-</span> us_counties <span class="sc">%&gt;%</span></span>
<span id="cb89-426"><a href="#cb89-426" aria-hidden="true" tabindex="-1"></a>    <span class="fu">right_join</span>(agglo_growth, <span class="at">by =</span> <span class="st">"fips"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb89-427"><a href="#cb89-427" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(state <span class="sc">==</span> <span class="st">"Louisiana"</span>)</span>
<span id="cb89-428"><a href="#cb89-428" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-429"><a href="#cb89-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-430"><a href="#cb89-430" aria-hidden="true" tabindex="-1"></a>We first plot a thematic map (@fig-map_louisiana), with colors for counties related to the</span>
<span id="cb89-431"><a href="#cb89-431" aria-hidden="true" tabindex="-1"></a>growth of the population (<span class="in">`pop_gr`</span>). It is recommended to create first a</span>
<span id="cb89-432"><a href="#cb89-432" aria-hidden="true" tabindex="-1"></a>categorical variable using <span class="in">`base::cut`</span>, because it is easier to visualize a discrete palette of colors than a continuous one. We use <span class="in">`scale_fill_brewer`</span> to use one of the palettes provided by the **RColorBrewer** package, which provides sequential, diverging and qualitative palettes. The first two are suitable to represent the values of numerical variables. Sequential palettes use a color, light for low values of the variable and dark for high values. Divergent palettes use two colors, with light colors for middle range values and dark colors for low and high values. All the available palettes can be displayed using <span class="in">`RColorBrewer::display.brewer.all()`</span>. We use here the <span class="in">`Oranges`</span> sequential palette.</span>
<span id="cb89-433"><a href="#cb89-433" aria-hidden="true" tabindex="-1"></a>\idxfun{mutate}{dplyr}\idxfun{cut}{base}\idxfun{ggplot}{ggplot2}\idxfun{geom<span class="sc">\_</span>sf}{ggplot2}\idxfun{scale<span class="sc">\_</span>fill<span class="sc">\_</span>brewer}{ggplot2}</span>
<span id="cb89-434"><a href="#cb89-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-437"><a href="#cb89-437" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb89-438"><a href="#cb89-438" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb89-439"><a href="#cb89-439" aria-hidden="true" tabindex="-1"></a>louisiana <span class="sc">%&gt;%</span></span>
<span id="cb89-440"><a href="#cb89-440" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">pop_gr =</span> <span class="fu">cut</span>(pop_gr, (<span class="sc">-</span><span class="dv">3</span><span class="sc">:</span><span class="dv">3</span>) <span class="sc">/</span> <span class="dv">10</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb89-441"><a href="#cb89-441" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>() <span class="sc">+</span> <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> pop_gr)) <span class="sc">+</span></span>
<span id="cb89-442"><a href="#cb89-442" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Oranges"</span>)</span>
<span id="cb89-443"><a href="#cb89-443" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-444"><a href="#cb89-444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-445"><a href="#cb89-445" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb89-446"><a href="#cb89-446" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-map_louisiana</span></span>
<span id="cb89-447"><a href="#cb89-447" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Population growth and initial population in Louisiana"</span></span>
<span id="cb89-448"><a href="#cb89-448" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb89-449"><a href="#cb89-449" aria-hidden="true" tabindex="-1"></a>louisiana <span class="sc">%&gt;%</span></span>
<span id="cb89-450"><a href="#cb89-450" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">pop_gr =</span> <span class="fu">cut</span>(pop_gr, (<span class="sc">-</span><span class="dv">3</span><span class="sc">:</span><span class="dv">3</span>) <span class="sc">/</span> <span class="dv">10</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb89-451"><a href="#cb89-451" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>() <span class="sc">+</span> <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> pop_gr)) <span class="sc">+</span></span>
<span id="cb89-452"><a href="#cb89-452" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_grey</span>()</span>
<span id="cb89-453"><a href="#cb89-453" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-454"><a href="#cb89-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-455"><a href="#cb89-455" aria-hidden="true" tabindex="-1"></a>The inverted U shaped hypothesis between the log of the initial</span>
<span id="cb89-456"><a href="#cb89-456" aria-hidden="true" tabindex="-1"></a>population and the growth rate can be tested by regressing the growth</span>
<span id="cb89-457"><a href="#cb89-457" aria-hidden="true" tabindex="-1"></a>rate on the log population and its square. The later coefficient should then be negative.</span>
<span id="cb89-458"><a href="#cb89-458" aria-hidden="true" tabindex="-1"></a>\idxfun{lm}{stats}\idxfun{poly}{stats}\idxfun{gaze}{micsr}</span>
<span id="cb89-459"><a href="#cb89-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-460"><a href="#cb89-460" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb89-461"><a href="#cb89-461" aria-hidden="true" tabindex="-1"></a>mod1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(pop_gr <span class="sc">~</span> <span class="fu">poly</span>(<span class="fu">log</span>(pop), <span class="dv">2</span>, <span class="at">raw =</span> <span class="cn">TRUE</span>), louisiana)</span>
<span id="cb89-462"><a href="#cb89-462" aria-hidden="true" tabindex="-1"></a>mod1 <span class="sc">%&gt;%</span> gaze</span>
<span id="cb89-463"><a href="#cb89-463" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-464"><a href="#cb89-464" aria-hidden="true" tabindex="-1"></a>\idxfun{coef}{stats}</span>
<span id="cb89-465"><a href="#cb89-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-468"><a href="#cb89-468" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb89-469"><a href="#cb89-469" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb89-470"><a href="#cb89-470" aria-hidden="true" tabindex="-1"></a>b1 <span class="ot">&lt;-</span> <span class="fu">coef</span>(mod1)[<span class="dv">2</span>]</span>
<span id="cb89-471"><a href="#cb89-471" aria-hidden="true" tabindex="-1"></a>b2 <span class="ot">&lt;-</span> <span class="fu">coef</span>(mod1)[<span class="dv">3</span>]</span>
<span id="cb89-472"><a href="#cb89-472" aria-hidden="true" tabindex="-1"></a>lpops <span class="ot">&lt;-</span> <span class="sc">-</span> b1 <span class="sc">/</span> <span class="dv">2</span> <span class="sc">/</span> b2</span>
<span id="cb89-473"><a href="#cb89-473" aria-hidden="true" tabindex="-1"></a>pops <span class="ot">&lt;-</span> <span class="fu">exp</span>(lpops)</span>
<span id="cb89-474"><a href="#cb89-474" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-475"><a href="#cb89-475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-476"><a href="#cb89-476" aria-hidden="true" tabindex="-1"></a>The coefficient of the square term is negative and significant and we get a maximum</span>
<span id="cb89-477"><a href="#cb89-477" aria-hidden="true" tabindex="-1"></a>growth for the fitted model for a value of <span class="in">`log(pop)`</span> equal to $-<span class="in">`r round(b1, 4)`</span></span>
<span id="cb89-478"><a href="#cb89-478" aria-hidden="true" tabindex="-1"></a>/ (<span class="in">`r round(b2, 4)`</span> \times 2) = <span class="in">`r round(lpops, 4)`</span>$, i.e., a population of about <span class="in">`r round(pops / 1E03)`</span>  thousand</span>
<span id="cb89-479"><a href="#cb89-479" aria-hidden="true" tabindex="-1"></a>inhabitants. </span>
<span id="cb89-480"><a href="#cb89-480" aria-hidden="true" tabindex="-1"></a>This result is illustrated in @fig-iushaped_louisiana,  a scatterplot representing the relationship between the logarithm of the initial population and its growth rate and a fitting line with a second degree polynomial:</span>
<span id="cb89-481"><a href="#cb89-481" aria-hidden="true" tabindex="-1"></a>\idxfun{ggplot}{ggplot2}\idxfun{aes}{ggplot2}\idxfun{geom<span class="sc">\_</span>point}{ggplot2}\idxfun{geom<span class="sc">\_</span>smooth}{ggplot2}\idxfun{poly}{stats}\idxfun{scale<span class="sc">\_</span>x<span class="sc">\_</span>continuous}{ggplot2}</span>
<span id="cb89-482"><a href="#cb89-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-483"><a href="#cb89-483" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb89-484"><a href="#cb89-484" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-iushaped_louisiana</span></span>
<span id="cb89-485"><a href="#cb89-485" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Relation between initial population and population growth in Louisiana"</span></span>
<span id="cb89-486"><a href="#cb89-486" aria-hidden="true" tabindex="-1"></a>louisiana <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(pop, pop_gr)) <span class="sc">+</span></span>
<span id="cb89-487"><a href="#cb89-487" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb89-488"><a href="#cb89-488" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">formula =</span> y <span class="sc">~</span> <span class="fu">poly</span>(x, <span class="dv">2</span>, <span class="at">raw =</span> <span class="cn">TRUE</span>), </span>
<span id="cb89-489"><a href="#cb89-489" aria-hidden="true" tabindex="-1"></a>                <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span> </span>
<span id="cb89-490"><a href="#cb89-490" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">trans =</span> <span class="st">"log10"</span>)</span>
<span id="cb89-491"><a href="#cb89-491" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-492"><a href="#cb89-492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-493"><a href="#cb89-493" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">)</span><span class="co">]</span>{agglo<span class="sc">\_</span>growth}{micsr.data}</span>
<span id="cb89-494"><a href="#cb89-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-495"><a href="#cb89-495" aria-hidden="true" tabindex="-1"></a><span class="fu">### Solow model {#sec-solow_model}</span></span>
<span id="cb89-496"><a href="#cb89-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-497"><a href="#cb89-497" aria-hidden="true" tabindex="-1"></a>The second example is from @ERTU:KOCH:07\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Ertur}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Koch} who estimated a growth model for</span>
<span id="cb89-498"><a href="#cb89-498" aria-hidden="true" tabindex="-1"></a>the countries of the world taking spatial correlation into account. The <span class="in">`sp_solow`</span> data set is provided by the **necountries** package:</span>
<span id="cb89-499"><a href="#cb89-499" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">(</span><span class="co">]</span>{sp<span class="sc">\_</span>solow}{necountries}</span>
<span id="cb89-500"><a href="#cb89-500" aria-hidden="true" tabindex="-1"></a>\idxfun{data}{utils}</span>
<span id="cb89-501"><a href="#cb89-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-504"><a href="#cb89-504" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb89-505"><a href="#cb89-505" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"sp_solow"</span>, <span class="at">package =</span> <span class="st">"necountries"</span>)</span>
<span id="cb89-506"><a href="#cb89-506" aria-hidden="true" tabindex="-1"></a>sp_solow</span>
<span id="cb89-507"><a href="#cb89-507" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-508"><a href="#cb89-508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-509"><a href="#cb89-509" aria-hidden="true" tabindex="-1"></a>There are 91 countries in the <span class="in">`sp_solow`</span> data set, the series being the gdp in 1960 and 1995, the saving rate (<span class="in">`saving`</span>) and the growth of the labor force (<span class="in">`labgwth`</span>).</span>
<span id="cb89-510"><a href="#cb89-510" aria-hidden="true" tabindex="-1"></a>As in @sec-data_solow_mrw, we denote <span class="in">`i`</span> as the saving rate and <span class="in">`v`</span> as the sum of the growth rate of the labor force and 0.05.^<span class="co">[</span><span class="ot">0.05 being the sum of the rate of depreciation and the rate of technical progress, assumed to be the same for all countries.</span><span class="co">]</span> We also compute the annual growth rate (<span class="in">`growth`</span>) as the difference of the logs of the GDP for 1995 and 1960 divided by 35.</span>
<span id="cb89-511"><a href="#cb89-511" aria-hidden="true" tabindex="-1"></a>\idxfun{rename}{dplyr}\idxfun{mutate}{dplyr}</span>
<span id="cb89-512"><a href="#cb89-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-513"><a href="#cb89-513" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb89-514"><a href="#cb89-514" aria-hidden="true" tabindex="-1"></a>sp_solow <span class="ot">&lt;-</span> sp_solow <span class="sc">%&gt;%</span></span>
<span id="cb89-515"><a href="#cb89-515" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">i =</span> saving) <span class="sc">%&gt;%</span> </span>
<span id="cb89-516"><a href="#cb89-516" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">v =</span> labgwth <span class="sc">+</span> <span class="fl">0.05</span>,</span>
<span id="cb89-517"><a href="#cb89-517" aria-hidden="true" tabindex="-1"></a>         <span class="at">growth =</span> (<span class="fu">log</span>(gdp95) <span class="sc">-</span> <span class="fu">log</span>(gdp60)) <span class="sc">/</span> <span class="dv">35</span>)</span>
<span id="cb89-518"><a href="#cb89-518" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-519"><a href="#cb89-519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-520"><a href="#cb89-520" aria-hidden="true" tabindex="-1"></a>We then need to join this data frame to a sf containing the administrative boundaries of the countries and the coordinate of their capital. Several packages enable to get an sf of the world. For example, the **spData** package has a `world` sf which is obtained from Natural Earth,^[&lt;&lt;https://www.naturalearthdata.com/&gt;&gt;] **geodata** has a `world` function that enables to download from the gadm website^[&lt;&lt;https://gadm.org/&gt;&gt;] an object of class `SpatVector` (than can be easily converted to a `sf`, as shown in @sec-struct_sf). We use here the convenient **necountries** package that also uses Natural Earth and provides a <span class="in">`countries`</span> function with different arguments to select a subset of countries of the world. By default, <span class="in">`countries`</span> returns 199 lines, the 193 United Nations' recognized countries, the two observer countries (Palestine and Vatican) and four not or not fully recognized countries (Kosovo, Somaliland, Northern Cyprus and Taiwan). Each line includes the geometry of the "main" part of the countries. Some countries have "parts" or "dependencies" that can be included using <span class="in">`part = TRUE`</span> and <span class="in">`dependency = TRUE`</span>. A "part" is an area which has the same political status as the rest of the country, but is far from the main part of the country. Examples of parts include Alaska and Hawaii for the United States, Martinique and Guadeloupe for France and Canaries for Spain. A "dependency" is an area with a specific political status. Examples of dependencies are Greenland for Denmark, New Caledonia for France and Gibraltar for the United Kingdom.</span>
<span id="cb89-521"><a href="#cb89-521" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-522"><a href="#cb89-522" aria-hidden="true" tabindex="-1"></a><span class="in">`sp_solow`</span> has columns that contain the names and the iso-codes of the countries (respectively <span class="in">`name`</span> and <span class="in">`code`</span>). Any of them can be used to join <span class="in">`sp_solow`</span> with the <span class="in">`countries`</span>' object, but it is much safer to use <span class="in">`code`</span>, as it avoids the problem of small differences in countries' names. A lot of</span>
<span id="cb89-523"><a href="#cb89-523" aria-hidden="true" tabindex="-1"></a>countries of the world are not present in <span class="in">`sp_solow`</span> (especially most</span>
<span id="cb89-524"><a href="#cb89-524" aria-hidden="true" tabindex="-1"></a>of the communist countries). We check whether all the countries of <span class="in">`sp_solow`</span> are present in the <span class="in">`countries`</span> object, with the <span class="in">`check_join`</span> function; the <span class="in">`by`</span> argument indicates the series in <span class="in">`sp_solow`</span> that identifies the country:</span>
<span id="cb89-525"><a href="#cb89-525" aria-hidden="true" tabindex="-1"></a>\idxfun{check<span class="sc">\_</span>join}{necountries}\idxfun{countries}{necountries}</span>
<span id="cb89-526"><a href="#cb89-526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-527"><a href="#cb89-527" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb89-528"><a href="#cb89-528" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: true</span></span>
<span id="cb89-529"><a href="#cb89-529" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(necountries)</span>
<span id="cb89-530"><a href="#cb89-530" aria-hidden="true" tabindex="-1"></a><span class="fu">countries</span>() <span class="sc">%&gt;%</span> <span class="fu">check_join</span>(sp_solow, <span class="at">by =</span> <span class="st">"code"</span>)</span>
<span id="cb89-531"><a href="#cb89-531" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-532"><a href="#cb89-532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-533"><a href="#cb89-533" aria-hidden="true" tabindex="-1"></a>The two problems are that the D.R. of Congo (<span class="in">`iso3`</span> code <span class="in">`COD`</span>) used to be</span>
<span id="cb89-534"><a href="#cb89-534" aria-hidden="true" tabindex="-1"></a>called Zaire (<span class="in">`iso3`</span> code <span class="in">`ZAR`</span>) and that Hong Kong, which is a part</span>
<span id="cb89-535"><a href="#cb89-535" aria-hidden="true" tabindex="-1"></a>of China for the **necountries** package, was considered as a sovereign country in @ERTU:KOCH:07\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Ertur}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Koch} study. We then correct the code for the D.R. of Congo, we add Hong Kong using the <span class="in">`include`</span> argument and we remove <span class="in">`Antarctica`</span> with the exclude argument:</span>
<span id="cb89-536"><a href="#cb89-536" aria-hidden="true" tabindex="-1"></a>\idxfun{mutate}{dplyr}\idxfun{ifelse}{base}\idxfun{countries}{necountries}\idxfun{select}{dplyr}\idxfun{left<span class="sc">\_</span>join}{dplyr}</span>
<span id="cb89-537"><a href="#cb89-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-538"><a href="#cb89-538" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval = TRUE}</span></span>
<span id="cb89-539"><a href="#cb89-539" aria-hidden="true" tabindex="-1"></a>sp_solow <span class="ot">&lt;-</span> sp_solow <span class="sc">%&gt;%</span> </span>
<span id="cb89-540"><a href="#cb89-540" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">code =</span> <span class="fu">ifelse</span>(code <span class="sc">==</span> <span class="st">"ZAR"</span>, <span class="st">"COD"</span>, code))</span>
<span id="cb89-541"><a href="#cb89-541" aria-hidden="true" tabindex="-1"></a>sps <span class="ot">&lt;-</span> <span class="fu">countries</span>(<span class="at">include =</span> <span class="st">"Hong Kong"</span>, <span class="at">exclude =</span> <span class="st">"Antarctica"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb89-542"><a href="#cb89-542" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(iso3, country, point) <span class="sc">%&gt;%</span> </span>
<span id="cb89-543"><a href="#cb89-543" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(sp_solow, <span class="at">by =</span> <span class="st">"code"</span>) <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span> name)</span>
<span id="cb89-544"><a href="#cb89-544" aria-hidden="true" tabindex="-1"></a>sps</span>
<span id="cb89-545"><a href="#cb89-545" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-546"><a href="#cb89-546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-547"><a href="#cb89-547" aria-hidden="true" tabindex="-1"></a>Note that the resulting <span class="in">`sf`</span> has two geometry columns, polygons for the</span>
<span id="cb89-548"><a href="#cb89-548" aria-hidden="true" tabindex="-1"></a>borders of the countries (<span class="in">`polygon`</span>) and points for the capitals</span>
<span id="cb89-549"><a href="#cb89-549" aria-hidden="true" tabindex="-1"></a>(<span class="in">`point`</span>). Note also that the active geometry column is</span>
<span id="cb89-550"><a href="#cb89-550" aria-hidden="true" tabindex="-1"></a><span class="in">`polygon`</span>. </span>
<span id="cb89-551"><a href="#cb89-551" aria-hidden="true" tabindex="-1"></a>We then draw in @fig-growth_gdp a world map with the color of the countries related to</span>
<span id="cb89-552"><a href="#cb89-552" aria-hidden="true" tabindex="-1"></a>the annual growth during the 1960-95 period and a point with a size</span>
<span id="cb89-553"><a href="#cb89-553" aria-hidden="true" tabindex="-1"></a>related to the initial (1960) GDP. **necountries** provides a `plot` method which draws a basic map using **ggplot2**. A basic thematic map can be drawn using the `fill` argument to fill the areas of the countries and the `centroid` or the `capital` arguments to draw a point at the position of the centroid or the capital of each country. Any **ggplot2** functions can be used to customize the graphic:</span>
<span id="cb89-554"><a href="#cb89-554" aria-hidden="true" tabindex="-1"></a>\idxfun{scale<span class="sc">\_</span>size<span class="sc">\_</span>continuous}{ggplot2}\idxfun{theme}{ggplot2}\idxfun{guides}{ggplot2}\idxfun{labs}{ggplot2}\idxfun{guide<span class="sc">\_</span>legend}{ggplot2}</span>
<span id="cb89-555"><a href="#cb89-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-558"><a href="#cb89-558" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb89-559"><a href="#cb89-559" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb89-560"><a href="#cb89-560" aria-hidden="true" tabindex="-1"></a>sps <span class="sc">%&gt;%</span> <span class="fu">plot</span>(<span class="at">fill =</span> <span class="st">"growth"</span>, <span class="at">centroid =</span> <span class="st">"gdp60"</span>, <span class="at">palette =</span> <span class="st">"Blues"</span>) <span class="sc">+</span></span>
<span id="cb89-561"><a href="#cb89-561" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_size_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="dv">3</span>)) <span class="sc">+</span> </span>
<span id="cb89-562"><a href="#cb89-562" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>) <span class="sc">+</span> </span>
<span id="cb89-563"><a href="#cb89-563" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">size =</span> <span class="fu">guide_legend</span>(<span class="at">nrow =</span> <span class="dv">3</span>, <span class="at">reverse =</span> <span class="cn">TRUE</span>),</span>
<span id="cb89-564"><a href="#cb89-564" aria-hidden="true" tabindex="-1"></a>         <span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">nrow =</span> <span class="dv">3</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>)) <span class="sc">+</span> </span>
<span id="cb89-565"><a href="#cb89-565" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">"Growth rate (1960-95)"</span>, <span class="at">size =</span> <span class="st">"GDP in 1960"</span>)</span>
<span id="cb89-566"><a href="#cb89-566" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-567"><a href="#cb89-567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-568"><a href="#cb89-568" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-569"><a href="#cb89-569" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval = TRUE}</span></span>
<span id="cb89-570"><a href="#cb89-570" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-growth_gdp</span></span>
<span id="cb89-571"><a href="#cb89-571" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Growth and initial GDP, 1960-1995"</span></span>
<span id="cb89-572"><a href="#cb89-572" aria-hidden="true" tabindex="-1"></a><span class="co">#| out-width: "100%"</span></span>
<span id="cb89-573"><a href="#cb89-573" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 7</span></span>
<span id="cb89-574"><a href="#cb89-574" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb89-575"><a href="#cb89-575" aria-hidden="true" tabindex="-1"></a>sps <span class="sc">%&gt;%</span> <span class="fu">plot</span>(<span class="at">fill =</span> <span class="st">"growth"</span>, <span class="at">centroid =</span> <span class="st">"gdp60"</span>, <span class="at">bw =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb89-576"><a href="#cb89-576" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_size_continuous</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="dv">3</span>)) <span class="sc">+</span> </span>
<span id="cb89-577"><a href="#cb89-577" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>) <span class="sc">+</span> </span>
<span id="cb89-578"><a href="#cb89-578" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">size =</span> <span class="fu">guide_legend</span>(<span class="at">nrow =</span> <span class="dv">3</span>, <span class="at">reverse =</span> <span class="cn">TRUE</span>),</span>
<span id="cb89-579"><a href="#cb89-579" aria-hidden="true" tabindex="-1"></a>         <span class="at">fill =</span> <span class="fu">guide_legend</span>(<span class="at">nrow =</span> <span class="dv">3</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>)) <span class="sc">+</span> </span>
<span id="cb89-580"><a href="#cb89-580" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">"Growth rate (1960-95)"</span>, <span class="at">size =</span> <span class="st">"GDP in 1960"</span>)</span>
<span id="cb89-581"><a href="#cb89-581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-582"><a href="#cb89-582" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-583"><a href="#cb89-583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-584"><a href="#cb89-584" aria-hidden="true" tabindex="-1"></a>The basic Solow model, which was given in @eq-solow_equation, is then estimated:</span>
<span id="cb89-585"><a href="#cb89-585" aria-hidden="true" tabindex="-1"></a>\idxfun{lm}{stats}\idxfun{gaze}{micsr}</span>
<span id="cb89-586"><a href="#cb89-586" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-587"><a href="#cb89-587" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb89-588"><a href="#cb89-588" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(<span class="fu">log</span>(gdp95) <span class="sc">~</span> <span class="fu">log</span>(i) <span class="sc">+</span> <span class="fu">log</span>(v), sp_solow) <span class="sc">%&gt;%</span> gaze</span>
<span id="cb89-589"><a href="#cb89-589" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-590"><a href="#cb89-590" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-591"><a href="#cb89-591" aria-hidden="true" tabindex="-1"></a>Remember that the structural model implies that $\beta_s = - \beta_v = \kappa / (1 - \kappa)$. This hypothesis can be tested using a reparametrization of the model:\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{reparametrization!Solow model}</span>
<span id="cb89-592"><a href="#cb89-592" aria-hidden="true" tabindex="-1"></a>\idxfun{lm}{stats}\idxfun{gaze}{micsr}</span>
<span id="cb89-593"><a href="#cb89-593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-596"><a href="#cb89-596" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb89-597"><a href="#cb89-597" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: true</span></span>
<span id="cb89-598"><a href="#cb89-598" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(<span class="fu">log</span>(gdp95) <span class="sc">~</span> <span class="fu">log</span>(i <span class="sc">/</span> v) <span class="sc">+</span> <span class="fu">log</span>(v), sp_solow) <span class="sc">%&gt;%</span> gaze</span>
<span id="cb89-599"><a href="#cb89-599" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-600"><a href="#cb89-600" aria-hidden="true" tabindex="-1"></a>for which the hypothesis is that the coefficient of <span class="in">`log(v)`</span> equals 0. This hypothesis is rejected at the 5% level (but not at the 1% level). Imposing this hypothesis, we get:</span>
<span id="cb89-601"><a href="#cb89-601" aria-hidden="true" tabindex="-1"></a>\idxfun{lm}{stats}\idxfun{coef}{stats}\idxfun{unname}{base}</span>
<span id="cb89-602"><a href="#cb89-602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-605"><a href="#cb89-605" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb89-606"><a href="#cb89-606" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb89-607"><a href="#cb89-607" aria-hidden="true" tabindex="-1"></a>z <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">log</span>(gdp95) <span class="sc">~</span> <span class="fu">log</span>(i <span class="sc">/</span> v), sp_solow)</span>
<span id="cb89-608"><a href="#cb89-608" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">coef</span>(z)[<span class="dv">2</span>])</span>
<span id="cb89-609"><a href="#cb89-609" aria-hidden="true" tabindex="-1"></a>kappa <span class="ot">&lt;-</span> b <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> b)</span>
<span id="cb89-610"><a href="#cb89-610" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-611"><a href="#cb89-611" aria-hidden="true" tabindex="-1"></a>\idxfun{lm}{stats}\idxfun{gaze}{micsr}</span>
<span id="cb89-612"><a href="#cb89-612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-615"><a href="#cb89-615" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb89-616"><a href="#cb89-616" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: true</span></span>
<span id="cb89-617"><a href="#cb89-617" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(<span class="fu">log</span>(gdp95) <span class="sc">~</span> <span class="fu">log</span>(i <span class="sc">/</span> v), sp_solow) <span class="sc">%&gt;%</span> gaze</span>
<span id="cb89-618"><a href="#cb89-618" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-619"><a href="#cb89-619" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-620"><a href="#cb89-620" aria-hidden="true" tabindex="-1"></a>which implies a value of $\kappa$ (the share of the capital in the GDP) equal to $\hat{\beta}_i / (1 + \hat{\beta}_i) = <span class="in">`r round(kappa, 2)`</span>$ which is implausibly high.</span>
<span id="cb89-621"><a href="#cb89-621" aria-hidden="true" tabindex="-1"></a>\idxdata[]{sp<span class="sc">\_</span>solow}{necountries}</span>
<span id="cb89-622"><a href="#cb89-622" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-623"><a href="#cb89-623" aria-hidden="true" tabindex="-1"></a><span class="fu">## Spatial correlation {#sec-spatial_correlation}</span></span>
<span id="cb89-624"><a href="#cb89-624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-625"><a href="#cb89-625" aria-hidden="true" tabindex="-1"></a>Spatial correlation occurs when one can define a distance relationship</span>
<span id="cb89-626"><a href="#cb89-626" aria-hidden="true" tabindex="-1"></a>between observations. The notion of distance is broad, but we'll</span>
<span id="cb89-627"><a href="#cb89-627" aria-hidden="true" tabindex="-1"></a>consider in this section only geographical distance. For each</span>
<span id="cb89-628"><a href="#cb89-628" aria-hidden="true" tabindex="-1"></a>observation, one can in this case define a set of neighbors. If the</span>
<span id="cb89-629"><a href="#cb89-629" aria-hidden="true" tabindex="-1"></a>geographical representation of an observation is a polygon (which</span>
<span id="cb89-630"><a href="#cb89-630" aria-hidden="true" tabindex="-1"></a>is the relevant choice for countries or regions), two observations</span>
<span id="cb89-631"><a href="#cb89-631" aria-hidden="true" tabindex="-1"></a>for example can be said to be neighbors if they have a common border. If the</span>
<span id="cb89-632"><a href="#cb89-632" aria-hidden="true" tabindex="-1"></a>geographical representation of an observation is a point (for</span>
<span id="cb89-633"><a href="#cb89-633" aria-hidden="true" tabindex="-1"></a>example for a city), two observations are neighbors if the distance</span>
<span id="cb89-634"><a href="#cb89-634" aria-hidden="true" tabindex="-1"></a>between them is less than, say, 100 kilometers. Once the set of</span>
<span id="cb89-635"><a href="#cb89-635" aria-hidden="true" tabindex="-1"></a>neighbors have been defined for every observations, weights can be</span>
<span id="cb89-636"><a href="#cb89-636" aria-hidden="true" tabindex="-1"></a>computed. The weights can be equal or may depend on the distance</span>
<span id="cb89-637"><a href="#cb89-637" aria-hidden="true" tabindex="-1"></a>between the observation and its neighbors.</span>
<span id="cb89-638"><a href="#cb89-638" aria-hidden="true" tabindex="-1"></a>These two operations of defining the set of neighbors and their weights are performed by the **spdep** package <span class="co">[</span><span class="ot">@PEBE:BIVA:23</span><span class="co">]</span>\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Pebesma}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Bivand}.</span>
<span id="cb89-639"><a href="#cb89-639" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-640"><a href="#cb89-640" aria-hidden="true" tabindex="-1"></a><span class="fu">### Contiguity and weights</span></span>
<span id="cb89-641"><a href="#cb89-641" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-642"><a href="#cb89-642" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{contiguity matrix|(}</span>
<span id="cb89-643"><a href="#cb89-643" aria-hidden="true" tabindex="-1"></a>To get the matrix of contiguity for the counties of Louisiana, we use the <span class="in">`spdep::poly2nb`</span> function:</span>
<span id="cb89-644"><a href="#cb89-644" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">(</span><span class="co">]</span>{agglo<span class="sc">\_</span>growth}{micsr.data}</span>
<span id="cb89-645"><a href="#cb89-645" aria-hidden="true" tabindex="-1"></a>\idxfun{poly2nb}{spdep}</span>
<span id="cb89-646"><a href="#cb89-646" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-647"><a href="#cb89-647" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb89-648"><a href="#cb89-648" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb89-649"><a href="#cb89-649" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(spdep)</span>
<span id="cb89-650"><a href="#cb89-650" aria-hidden="true" tabindex="-1"></a>nb_louis <span class="ot">&lt;-</span> <span class="fu">poly2nb</span>(louisiana)</span>
<span id="cb89-651"><a href="#cb89-651" aria-hidden="true" tabindex="-1"></a>nb_louis</span>
<span id="cb89-652"><a href="#cb89-652" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-653"><a href="#cb89-653" aria-hidden="true" tabindex="-1"></a>\idxfun{sapply}{base}\idxfun{length}{base}</span>
<span id="cb89-654"><a href="#cb89-654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-657"><a href="#cb89-657" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb89-658"><a href="#cb89-658" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb89-659"><a href="#cb89-659" aria-hidden="true" tabindex="-1"></a>nlinks <span class="ot">&lt;-</span> <span class="fu">sapply</span>(nb_louis, length) <span class="sc">%&gt;%</span> sum</span>
<span id="cb89-660"><a href="#cb89-660" aria-hidden="true" tabindex="-1"></a>ncount <span class="ot">&lt;-</span> <span class="fu">length</span>(nb_louis)</span>
<span id="cb89-661"><a href="#cb89-661" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-662"><a href="#cb89-662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-663"><a href="#cb89-663" aria-hidden="true" tabindex="-1"></a>The print method indicates the number of contiguity links</span>
<span id="cb89-664"><a href="#cb89-664" aria-hidden="true" tabindex="-1"></a>(<span class="in">`r nlinks`</span>). Instead of storing these links in a full matrix (with 1 for</span>
<span id="cb89-665"><a href="#cb89-665" aria-hidden="true" tabindex="-1"></a>contiguous counties and 0 otherwise) which would have $<span class="in">`r ncount`</span>^2 = <span class="in">`r ncount^2`</span>$</span>
<span id="cb89-666"><a href="#cb89-666" aria-hidden="true" tabindex="-1"></a>cells with only <span class="in">`r nlinks`</span> of them with a value of 1 (about <span class="in">`r round(nlinks / ncount ^ 2 * 100, 1)`</span>%), an <span class="in">`nb`</span></span>
<span id="cb89-667"><a href="#cb89-667" aria-hidden="true" tabindex="-1"></a>object is returned. It is a list of <span class="in">`r ncount`</span> vectors which contains, for each</span>
<span id="cb89-668"><a href="#cb89-668" aria-hidden="true" tabindex="-1"></a>observation, the positions of its neighbors. For example:</span>
<span id="cb89-669"><a href="#cb89-669" aria-hidden="true" tabindex="-1"></a>\idxfun{head}{utils}</span>
<span id="cb89-670"><a href="#cb89-670" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-671"><a href="#cb89-671" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb89-672"><a href="#cb89-672" aria-hidden="true" tabindex="-1"></a>nb_louis <span class="sc">%&gt;%</span> <span class="fu">head</span>(<span class="dv">3</span>)</span>
<span id="cb89-673"><a href="#cb89-673" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-674"><a href="#cb89-674" aria-hidden="true" tabindex="-1"></a>The first two counties have five neighbors and the third one has six. A</span>
<span id="cb89-675"><a href="#cb89-675" aria-hidden="true" tabindex="-1"></a><span class="in">`summary`</span> method provides more details. <span class="in">`poly2nb`</span> has a <span class="in">`queen`</span></span>
<span id="cb89-676"><a href="#cb89-676" aria-hidden="true" tabindex="-1"></a>argument which is <span class="in">`TRUE`</span> by default. Queen contiguity means that two</span>
<span id="cb89-677"><a href="#cb89-677" aria-hidden="true" tabindex="-1"></a>polygons which have only one common point are neighbors. Setting <span class="in">`queen`</span></span>
<span id="cb89-678"><a href="#cb89-678" aria-hidden="true" tabindex="-1"></a>to <span class="in">`FALSE`</span> implies that rook continuity is used. In this case, only</span>
<span id="cb89-679"><a href="#cb89-679" aria-hidden="true" tabindex="-1"></a>counties that have a common border are neighbors. </span>
<span id="cb89-680"><a href="#cb89-680" aria-hidden="true" tabindex="-1"></a>\idxfun{poly2nb}{spdep}</span>
<span id="cb89-681"><a href="#cb89-681" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-682"><a href="#cb89-682" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb89-683"><a href="#cb89-683" aria-hidden="true" tabindex="-1"></a>nb_louis_rook <span class="ot">&lt;-</span> <span class="fu">poly2nb</span>(louisiana, <span class="at">queen =</span> <span class="cn">FALSE</span>)</span>
<span id="cb89-684"><a href="#cb89-684" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-685"><a href="#cb89-685" aria-hidden="true" tabindex="-1"></a>\idxfun{sapply}{base}</span>
<span id="cb89-686"><a href="#cb89-686" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-689"><a href="#cb89-689" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb89-690"><a href="#cb89-690" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb89-691"><a href="#cb89-691" aria-hidden="true" tabindex="-1"></a>nlinks_rook <span class="ot">&lt;-</span> <span class="fu">sapply</span>(nb_louis_rook, length) <span class="sc">%&gt;%</span> sum</span>
<span id="cb89-692"><a href="#cb89-692" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-693"><a href="#cb89-693" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-694"><a href="#cb89-694" aria-hidden="true" tabindex="-1"></a>Printing <span class="in">`nb_nc_rook`</span>, one can check that the number of contiguity</span>
<span id="cb89-695"><a href="#cb89-695" aria-hidden="true" tabindex="-1"></a>links (<span class="in">`r nlinks_rook`</span>) is slightly lower than previously (<span class="in">`r nlinks`</span>). <span class="in">`nb`</span> objects</span>
<span id="cb89-696"><a href="#cb89-696" aria-hidden="true" tabindex="-1"></a>can't be plotted as is with **ggplot2**. We provide a convenient <span class="in">`st_nb`</span></span>
<span id="cb89-697"><a href="#cb89-697" aria-hidden="true" tabindex="-1"></a>function which performs this task, as it returns a <span class="in">`sf`</span> object (see @fig-links):</span>
<span id="cb89-698"><a href="#cb89-698" aria-hidden="true" tabindex="-1"></a>\idxfun{ggplot}{ggplot2}\idxfun{st<span class="sc">\_</span>nb}{micsr}\idxfun{geom<span class="sc">\_</span>sf}{ggplot2}</span>
<span id="cb89-699"><a href="#cb89-699" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-700"><a href="#cb89-700" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb89-701"><a href="#cb89-701" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-links</span></span>
<span id="cb89-702"><a href="#cb89-702" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Queen and rook links for the counties of Louisiana"</span></span>
<span id="cb89-703"><a href="#cb89-703" aria-hidden="true" tabindex="-1"></a>louisiana <span class="sc">%&gt;%</span></span>
<span id="cb89-704"><a href="#cb89-704" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb89-705"><a href="#cb89-705" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">fill =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb89-706"><a href="#cb89-706" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> <span class="fu">st_nb</span>(louisiana), <span class="at">linetype =</span> <span class="st">"dotted"</span>) <span class="sc">+</span></span>
<span id="cb89-707"><a href="#cb89-707" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> <span class="fu">st_nb</span>(louisiana, <span class="at">queen =</span> <span class="cn">FALSE</span>))</span>
<span id="cb89-708"><a href="#cb89-708" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-709"><a href="#cb89-709" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-710"><a href="#cb89-710" aria-hidden="true" tabindex="-1"></a>We first plot queen contiguity links with dotted lines and then rook contiguity</span>
<span id="cb89-711"><a href="#cb89-711" aria-hidden="true" tabindex="-1"></a>with plain lines, so that the specific queen contiguity links appear as dotted segments.</span>
<span id="cb89-712"><a href="#cb89-712" aria-hidden="true" tabindex="-1"></a>A matrix of weights is obtained by using the <span class="in">`nb2listw`</span> function:</span>
<span id="cb89-713"><a href="#cb89-713" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-714"><a href="#cb89-714" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb89-715"><a href="#cb89-715" aria-hidden="true" tabindex="-1"></a>W_louis <span class="ot">&lt;-</span> nb_louis <span class="sc">%&gt;%</span> nb2listw</span>
<span id="cb89-716"><a href="#cb89-716" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-717"><a href="#cb89-717" aria-hidden="true" tabindex="-1"></a>A <span class="in">`listw`</span> object is returned, which contains two lists: the first</span>
<span id="cb89-718"><a href="#cb89-718" aria-hidden="true" tabindex="-1"></a>(<span class="in">`neighbours`</span>) is the same as the one of the <span class="in">`nb`</span> object. The second</span>
<span id="cb89-719"><a href="#cb89-719" aria-hidden="true" tabindex="-1"></a>contains weights:</span>
<span id="cb89-720"><a href="#cb89-720" aria-hidden="true" tabindex="-1"></a>\idxfun{head}{utils}</span>
<span id="cb89-721"><a href="#cb89-721" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-722"><a href="#cb89-722" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb89-723"><a href="#cb89-723" aria-hidden="true" tabindex="-1"></a>W_louis<span class="sc">$</span>weights <span class="sc">%&gt;%</span> <span class="fu">head</span>(<span class="dv">3</span>)</span>
<span id="cb89-724"><a href="#cb89-724" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-725"><a href="#cb89-725" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-726"><a href="#cb89-726" aria-hidden="true" tabindex="-1"></a>We can see that weights of neighbors for a given observation are all</span>
<span id="cb89-727"><a href="#cb89-727" aria-hidden="true" tabindex="-1"></a>equal (1/5 for the first two observations which have five neighbors and $1/6$ for the third one which has six neighbors) and sum to one. Therefore, premultiplying a vector $(y - \bar{y})$ by $W$</span>
<span id="cb89-728"><a href="#cb89-728" aria-hidden="true" tabindex="-1"></a>results in a vector with typical value $\sum_m w_{nm}</span>
<span id="cb89-729"><a href="#cb89-729" aria-hidden="true" tabindex="-1"></a>y_m - \bar{y} = \tilde{y}_n - \bar{y}$.</span>
<span id="cb89-730"><a href="#cb89-730" aria-hidden="true" tabindex="-1"></a><span class="in">`nb`</span> and a <span class="in">`listw`</span> objects can be coerced to matrices using the</span>
<span id="cb89-731"><a href="#cb89-731" aria-hidden="true" tabindex="-1"></a><span class="in">`nb2mat`</span> and <span class="in">`listw2mat`</span> functions.</span>
<span id="cb89-732"><a href="#cb89-732" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-735"><a href="#cb89-735" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb89-736"><a href="#cb89-736" aria-hidden="true" tabindex="-1"></a><span class="co">#| results: hide</span></span>
<span id="cb89-737"><a href="#cb89-737" aria-hidden="true" tabindex="-1"></a>W_louis <span class="sc">%&gt;%</span> listw2mat</span>
<span id="cb89-738"><a href="#cb89-738" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-739"><a href="#cb89-739" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-740"><a href="#cb89-740" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">)</span><span class="co">]</span>{agglo<span class="sc">\_</span>growth}{micsr.data}</span>
<span id="cb89-741"><a href="#cb89-741" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-742"><a href="#cb89-742" aria-hidden="true" tabindex="-1"></a>Instead of defining the neighborhood as common borders, one can consider distance between points, for example the capitals or the centroids of the countries using the <span class="in">`sp_solow`</span> data set. Remember that <span class="in">`sps`</span> contains two <span class="in">`sf`</span>, <span class="in">`polygon`</span> and <span class="in">`point`</span> and that the active geometry is <span class="in">`polygon`</span>. We first specify <span class="in">`point`</span> as being the active geometry, using the <span class="in">`st_set_geometry`</span> function, and we remove all countries for which the data are not available:</span>
<span id="cb89-743"><a href="#cb89-743" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">(</span><span class="co">]</span>{sp<span class="sc">\_</span>solow}{necountries}</span>
<span id="cb89-744"><a href="#cb89-744" aria-hidden="true" tabindex="-1"></a>\idxfun{na.omit}{stats}\idxfun{st<span class="sc">\_</span>set<span class="sc">\_</span>geometry}{sf}</span>
<span id="cb89-745"><a href="#cb89-745" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-746"><a href="#cb89-746" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb89-747"><a href="#cb89-747" aria-hidden="true" tabindex="-1"></a>sp_solow2 <span class="ot">&lt;-</span> sps <span class="sc">%&gt;%</span> na.omit <span class="sc">%&gt;%</span> <span class="fu">st_set_geometry</span>(<span class="st">"point"</span>)</span>
<span id="cb89-748"><a href="#cb89-748" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-749"><a href="#cb89-749" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-750"><a href="#cb89-750" aria-hidden="true" tabindex="-1"></a>Then, we use the <span class="in">`dnearneigh`</span> function to compute the set of neighbors for each country: the first argument is the <span class="in">`sf`</span> and the next two arguments, called <span class="in">`d1`</span> and <span class="in">`d2`</span> are mandatory and should be set to the minimum and the maximum distances that should be used to define the neighbors. Note that this distance should be indicated in kilometers if the CRS is geographical, which is the case here.</span>
<span id="cb89-751"><a href="#cb89-751" aria-hidden="true" tabindex="-1"></a>\idxfun{spdep}{dnearneigh}</span>
<span id="cb89-752"><a href="#cb89-752" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-755"><a href="#cb89-755" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb89-756"><a href="#cb89-756" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">dnearneigh</span>(sp_solow2, <span class="dv">0</span>, <span class="dv">1000</span>)</span>
<span id="cb89-757"><a href="#cb89-757" aria-hidden="true" tabindex="-1"></a>d</span>
<span id="cb89-758"><a href="#cb89-758" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-759"><a href="#cb89-759" aria-hidden="true" tabindex="-1"></a>\idxfun{sapply}{base}\idxfun{ifelse}{base}\idxfun{length}{base}</span>
<span id="cb89-760"><a href="#cb89-760" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-763"><a href="#cb89-763" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb89-764"><a href="#cb89-764" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb89-765"><a href="#cb89-765" aria-hidden="true" tabindex="-1"></a>nlinks <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">sapply</span>(d, <span class="cf">function</span>(x) <span class="fu">ifelse</span>(<span class="fu">length</span>(x) <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> x <span class="sc">==</span> <span class="dv">0</span>, <span class="dv">0</span>, <span class="fu">length</span>(x))))</span>
<span id="cb89-766"><a href="#cb89-766" aria-hidden="true" tabindex="-1"></a>ncount <span class="ot">&lt;-</span> <span class="fu">length</span>(d)</span>
<span id="cb89-767"><a href="#cb89-767" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-768"><a href="#cb89-768" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-769"><a href="#cb89-769" aria-hidden="true" tabindex="-1"></a>With a distance of 1000 km, there are <span class="in">`r nlinks`</span> links and an average of <span class="in">`r round(nlinks / ncount, 2)`</span> neighbors per country. Note that 18 countries have no neighbors. We then compute the weights, using <span class="in">`nb2listwdist`</span>. The first two argument are a <span class="in">`nb`</span> and a <span class="in">`sf`</span> objects. The <span class="in">`type`</span> argument indicates how the weights should be computed. Denoting $d_{nm}$ the distance between the two unit $n$ and $m$, with <span class="in">`type = "idw"`</span>, we get $w_{nm} = d_{nm} ^ {- \alpha}$. With <span class="in">`type = "exp"`</span>, the weights are $w_{nm} = \mbox{exp}(- \alpha d_{nm})$. The <span class="in">`alpha`</span> argument controls the value of $\alpha$ which is 1 by default. For example, if <span class="in">`type = "idw"`</span> and <span class="in">`alpha = 2`</span>, the weights are the inverse of the square of the distance. Once the weights have been computed, they can be normalized in different ways, using the <span class="in">`style`</span> argument. If <span class="in">`type = "raw"`</span> (the default), no normalization is performed. A usual choice is <span class="in">`"W"`</span> where the weights of a unit are normalized so that they sum to 1:</span>
<span id="cb89-770"><a href="#cb89-770" aria-hidden="true" tabindex="-1"></a>\idxfun{nb2listwdist}{spdep}</span>
<span id="cb89-771"><a href="#cb89-771" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-774"><a href="#cb89-774" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb89-775"><a href="#cb89-775" aria-hidden="true" tabindex="-1"></a>w <span class="ot">&lt;-</span> <span class="fu">nb2listwdist</span>(d, sp_solow2, <span class="at">type =</span> <span class="st">"idw"</span>, <span class="at">alpha =</span> <span class="dv">1</span>, </span>
<span id="cb89-776"><a href="#cb89-776" aria-hidden="true" tabindex="-1"></a>                  <span class="at">style =</span> <span class="st">"W"</span>, <span class="at">zero.policy =</span> <span class="cn">TRUE</span>)</span>
<span id="cb89-777"><a href="#cb89-777" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-778"><a href="#cb89-778" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-779"><a href="#cb89-779" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">)</span><span class="co">]</span>{sp<span class="sc">\_</span>solow}{necountries}</span>
<span id="cb89-780"><a href="#cb89-780" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-781"><a href="#cb89-781" aria-hidden="true" tabindex="-1"></a>Note the use of <span class="in">`zero.policy`</span>: if <span class="in">`TRUE`</span>, the matrix of weights is computed even if, as it is the case here, some countries have no neighbors.</span>
<span id="cb89-782"><a href="#cb89-782" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-783"><a href="#cb89-783" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{contiguity matrix|)}</span>
<span id="cb89-784"><a href="#cb89-784" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-785"><a href="#cb89-785" aria-hidden="true" tabindex="-1"></a><span class="fu">### Tests for spatial correlation</span></span>
<span id="cb89-786"><a href="#cb89-786" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-787"><a href="#cb89-787" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{spatial correlation!tests|(}</span>
<span id="cb89-788"><a href="#cb89-788" aria-hidden="true" tabindex="-1"></a>The spatial correlation hypothesis can be tested either for a specific</span>
<span id="cb89-789"><a href="#cb89-789" aria-hidden="true" tabindex="-1"></a>variable or using the residuals of a linear regression. Two</span>
<span id="cb89-790"><a href="#cb89-790" aria-hidden="true" tabindex="-1"></a>main tests have been proposed. The first is Moran's $I$ test: denoting $W$ as the weights matrix where the weights sum to one for a given line, the statistic is defined as:</span>
<span id="cb89-791"><a href="#cb89-791" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-792"><a href="#cb89-792" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb89-793"><a href="#cb89-793" aria-hidden="true" tabindex="-1"></a>I = \frac{(y - \bar{y})^\top W (y - \bar{y})}{(y - \bar{y})^\top (y - \bar{y})} =</span>
<span id="cb89-794"><a href="#cb89-794" aria-hidden="true" tabindex="-1"></a>\frac{\sum_n (y_n  - \bar{y})(\tilde{y}_n - \bar{y})}{\sum_n (y_n  - \bar{y})^2}</span>
<span id="cb89-795"><a href="#cb89-795" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb89-796"><a href="#cb89-796" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-797"><a href="#cb89-797" aria-hidden="true" tabindex="-1"></a>which is simply the ratio of the covariance between $y$ and</span>
<span id="cb89-798"><a href="#cb89-798" aria-hidden="true" tabindex="-1"></a>$\tilde{y}$ and the variance of $y$. It therefore can be obtained as</span>
<span id="cb89-799"><a href="#cb89-799" aria-hidden="true" tabindex="-1"></a>the coefficient of $y$ in a linear regression of $\tilde{y}$ on</span>
<span id="cb89-800"><a href="#cb89-800" aria-hidden="true" tabindex="-1"></a>$y$. If the variance of $\tilde{y}$ and $y$ were equal, it would also</span>
<span id="cb89-801"><a href="#cb89-801" aria-hidden="true" tabindex="-1"></a>be the coefficient of correlation between the value of $y$ for a unit and its neighbors.</span>
<span id="cb89-802"><a href="#cb89-802" aria-hidden="true" tabindex="-1"></a>The Moran test is computed using the <span class="in">`spdep::moran.test`</span> function</span>
<span id="cb89-803"><a href="#cb89-803" aria-hidden="true" tabindex="-1"></a>which takes as argument a series and a <span class="in">`listw`</span> object:</span>
<span id="cb89-804"><a href="#cb89-804" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">(</span><span class="co">]</span>{agglo<span class="sc">\_</span>growth}{micsr.data}</span>
<span id="cb89-805"><a href="#cb89-805" aria-hidden="true" tabindex="-1"></a>\idxfun{moran.test}{spdep}\idxfun{gaze}{micsr}</span>
<span id="cb89-806"><a href="#cb89-806" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{Moran test|(}</span>
<span id="cb89-807"><a href="#cb89-807" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-808"><a href="#cb89-808" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb89-809"><a href="#cb89-809" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: true</span></span>
<span id="cb89-810"><a href="#cb89-810" aria-hidden="true" tabindex="-1"></a><span class="fu">moran.test</span>(louisiana<span class="sc">$</span>pop_gr, W_louis) <span class="sc">%&gt;%</span> gaze</span>
<span id="cb89-811"><a href="#cb89-811" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-812"><a href="#cb89-812" aria-hidden="true" tabindex="-1"></a>\idxfun{moran.test}{spdep}\idxfun{unname}{base}</span>
<span id="cb89-813"><a href="#cb89-813" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-814"><a href="#cb89-814" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb89-815"><a href="#cb89-815" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb89-816"><a href="#cb89-816" aria-hidden="true" tabindex="-1"></a>mor <span class="ot">&lt;-</span> <span class="fu">moran.test</span>(louisiana<span class="sc">$</span>pop_gr, W_louis)</span>
<span id="cb89-817"><a href="#cb89-817" aria-hidden="true" tabindex="-1"></a>stat_mor <span class="ot">&lt;-</span> mor<span class="sc">$</span>estimate[<span class="dv">1</span>] <span class="sc">%&gt;%</span> unname</span>
<span id="cb89-818"><a href="#cb89-818" aria-hidden="true" tabindex="-1"></a>mu_mor <span class="ot">&lt;-</span> mor<span class="sc">$</span>estimate[<span class="dv">2</span>] <span class="sc">%&gt;%</span> unname</span>
<span id="cb89-819"><a href="#cb89-819" aria-hidden="true" tabindex="-1"></a>sd_mor <span class="ot">&lt;-</span> mor<span class="sc">$</span>estimate[<span class="dv">3</span>] <span class="sc">%&gt;%</span> unname <span class="sc">%&gt;%</span> sqrt</span>
<span id="cb89-820"><a href="#cb89-820" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-821"><a href="#cb89-821" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-822"><a href="#cb89-822" aria-hidden="true" tabindex="-1"></a><span class="in">```{r include = FALSE}</span></span>
<span id="cb89-823"><a href="#cb89-823" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> louisiana<span class="sc">$</span>pop_gr</span>
<span id="cb89-824"><a href="#cb89-824" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="fu">length</span>(Y)</span>
<span id="cb89-825"><a href="#cb89-825" aria-hidden="true" tabindex="-1"></a>Wmat <span class="ot">&lt;-</span> W_louis <span class="sc">%&gt;%</span> listw2mat</span>
<span id="cb89-826"><a href="#cb89-826" aria-hidden="true" tabindex="-1"></a>DX <span class="ot">&lt;-</span> <span class="fu">outer</span>(Y, Y, <span class="st">"-"</span>) <span class="sc">^</span> <span class="dv">2</span></span>
<span id="cb89-827"><a href="#cb89-827" aria-hidden="true" tabindex="-1"></a>(<span class="fu">sum</span>(Wmat <span class="sc">*</span> DX) <span class="sc">/</span> N) <span class="sc">/</span> (<span class="fu">sum</span>((Y <span class="sc">-</span> <span class="fu">mean</span>(Y)) <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">/</span> (N <span class="sc">-</span> <span class="dv">1</span>)) <span class="sc">/</span> <span class="dv">2</span> </span>
<span id="cb89-828"><a href="#cb89-828" aria-hidden="true" tabindex="-1"></a><span class="fu">geary.test</span>(louisiana<span class="sc">$</span>pop_gr, W_louis) <span class="sc">%&gt;%</span> .[[<span class="st">"estimate"</span>]] <span class="sc">%&gt;%</span> unname <span class="sc">%&gt;%</span> .[<span class="dv">1</span>]</span>
<span id="cb89-829"><a href="#cb89-829" aria-hidden="true" tabindex="-1"></a>mrn <span class="ot">&lt;-</span> <span class="fu">moran.test</span>(louisiana<span class="sc">$</span>pop_gr, W_louis) <span class="sc">%&gt;%</span> .[[<span class="st">"estimate"</span>]] <span class="sc">%&gt;%</span> unname <span class="sc">%&gt;%</span> .[<span class="dv">1</span>]</span>
<span id="cb89-830"><a href="#cb89-830" aria-hidden="true" tabindex="-1"></a>(N <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">/</span> N <span class="sc">/</span> <span class="dv">2</span> <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="dv">2</span> <span class="sc">*</span> mrn <span class="sc">+</span> <span class="fu">sum</span>( (Y <span class="sc">-</span> <span class="fu">mean</span>(Y)) <span class="sc">^</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">apply</span>(Wmat, <span class="dv">2</span>, sum)) <span class="sc">/</span> <span class="fu">sum</span>( (Y <span class="sc">-</span> <span class="fu">mean</span>(Y)) <span class="sc">^</span> <span class="dv">2</span>))</span>
<span id="cb89-831"><a href="#cb89-831" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-832"><a href="#cb89-832" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-833"><a href="#cb89-833" aria-hidden="true" tabindex="-1"></a>The value of the statistic is $<span class="in">`r round(stat_mor, 3)`</span>$. Under the</span>
<span id="cb89-834"><a href="#cb89-834" aria-hidden="true" tabindex="-1"></a>hypothesis of no correlation, the expected value of this statistic is</span>
<span id="cb89-835"><a href="#cb89-835" aria-hidden="true" tabindex="-1"></a>$- 1 / (N-1) = <span class="in">`r round(mu_mor, 3)`</span>$ and the standard deviation is $<span class="in">`r round(sd_mor, 3)`</span>$.^[The expression of the variance of the Moran statistic can be found in</span>
<span id="cb89-836"><a href="#cb89-836" aria-hidden="true" tabindex="-1"></a>@BIVA:WONG:18\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Bivand}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Wong}.] The standardized statistic ($<span class="in">`r round((stat_mor - mu_mor) / sd_mor, 3)`</span>$) is asymptotically normal and the hypothesis of no spatial correlation is rejected.</span>
<span id="cb89-837"><a href="#cb89-837" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{Moran test|)}\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{Geary test|(}</span>
<span id="cb89-838"><a href="#cb89-838" aria-hidden="true" tabindex="-1"></a>An alternative to Moran's $I$ test is Geary's $C$ test, which is</span>
<span id="cb89-839"><a href="#cb89-839" aria-hidden="true" tabindex="-1"></a>defined as:</span>
<span id="cb89-840"><a href="#cb89-840" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-841"><a href="#cb89-841" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb89-842"><a href="#cb89-842" aria-hidden="true" tabindex="-1"></a>C = \frac{N - 1}{2N}\frac{\sum_n \sum_m w_{nm} (y_n - y_m) ^ 2}{\sum_n</span>
<span id="cb89-843"><a href="#cb89-843" aria-hidden="true" tabindex="-1"></a>(y_n - \bar{y})^ 2}</span>
<span id="cb89-844"><a href="#cb89-844" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb89-845"><a href="#cb89-845" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-846"><a href="#cb89-846" aria-hidden="true" tabindex="-1"></a>Introducing deviations from the mean in the previous expression and developing, we get:</span>
<span id="cb89-847"><a href="#cb89-847" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-848"><a href="#cb89-848" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb89-849"><a href="#cb89-849" aria-hidden="true" tabindex="-1"></a>C = \frac{1}{2}\frac{N - 1}{N} \left(1 - 2 I + \frac{\sum_n (y_m-</span>
<span id="cb89-850"><a href="#cb89-850" aria-hidden="true" tabindex="-1"></a>\bar{y}) ^ 2 \sum_m w_{mn}}{\sum_n (y_n - \bar{y}) ^ 2}\right)</span>
<span id="cb89-851"><a href="#cb89-851" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb89-852"><a href="#cb89-852" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-853"><a href="#cb89-853" aria-hidden="true" tabindex="-1"></a>If the weight matrix were symmetric, as $\sum_n w_{nm} = 1$, we also</span>
<span id="cb89-854"><a href="#cb89-854" aria-hidden="true" tabindex="-1"></a>would have $\sum_m w_{mn} = 1$, so that the last term is one and $C =</span>
<span id="cb89-855"><a href="#cb89-855" aria-hidden="true" tabindex="-1"></a>\frac{N - 1}{N}(1 - I)$. Therefore, we can expect $C$ to be close to</span>
<span id="cb89-856"><a href="#cb89-856" aria-hidden="true" tabindex="-1"></a>$(1 - I)$. Geary's test is implemented in the <span class="in">`spdep::geary.test`</span> function</span>
<span id="cb89-857"><a href="#cb89-857" aria-hidden="true" tabindex="-1"></a>\idxfun{geary.test}{spdep}\idxfun{gaze}{micsr}</span>
<span id="cb89-858"><a href="#cb89-858" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-859"><a href="#cb89-859" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb89-860"><a href="#cb89-860" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: true</span></span>
<span id="cb89-861"><a href="#cb89-861" aria-hidden="true" tabindex="-1"></a><span class="fu">geary.test</span>(louisiana<span class="sc">$</span>pop_gr, W_louis) <span class="sc">%&gt;%</span> gaze</span>
<span id="cb89-862"><a href="#cb89-862" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-863"><a href="#cb89-863" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{Geary test|)}\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{Moran test|(}</span>
<span id="cb89-864"><a href="#cb89-864" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-865"><a href="#cb89-865" aria-hidden="true" tabindex="-1"></a>These tests are unconditional tests of spatial correlation. The same</span>
<span id="cb89-866"><a href="#cb89-866" aria-hidden="true" tabindex="-1"></a>tests can be performed on the residuals of linear models.</span>
<span id="cb89-867"><a href="#cb89-867" aria-hidden="true" tabindex="-1"></a>\idxfun{lm.morantest}{spdep}\idxfun{gaze}{micsr}\idxfun{lm}{stats}\idxfun{poly}{stats}</span>
<span id="cb89-868"><a href="#cb89-868" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-869"><a href="#cb89-869" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-870"><a href="#cb89-870" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb89-871"><a href="#cb89-871" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: true</span></span>
<span id="cb89-872"><a href="#cb89-872" aria-hidden="true" tabindex="-1"></a>model_louisiana <span class="ot">&lt;-</span> <span class="fu">lm</span>(pop_gr<span class="sc">~</span><span class="fu">poly</span>(<span class="fu">log</span>(pop),<span class="dv">2</span>,<span class="at">raw =</span><span class="cn">TRUE</span>), louisiana)</span>
<span id="cb89-873"><a href="#cb89-873" aria-hidden="true" tabindex="-1"></a><span class="fu">lm.morantest</span>(model_louisiana, W_louis) <span class="sc">%&gt;%</span> gaze</span>
<span id="cb89-874"><a href="#cb89-874" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-875"><a href="#cb89-875" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">)</span><span class="co">]</span>{agglo<span class="sc">\_</span>growth}{micsr.data}</span>
<span id="cb89-876"><a href="#cb89-876" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-877"><a href="#cb89-877" aria-hidden="true" tabindex="-1"></a>The hypothesis of no spatial correlation is still rejected at the 5%</span>
<span id="cb89-878"><a href="#cb89-878" aria-hidden="true" tabindex="-1"></a>level, but the p-value is much higher than the one associated with the</span>
<span id="cb89-879"><a href="#cb89-879" aria-hidden="true" tabindex="-1"></a>unconditional test. </span>
<span id="cb89-880"><a href="#cb89-880" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-881"><a href="#cb89-881" aria-hidden="true" tabindex="-1"></a>@ERTU:KOCH:07\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Ertur}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Koch} computed the Moran test for the residuals of the OLS estimation of the standard Solow's growth model. The set of neighbors is obtained with setting an infinite maximum distance, so that all countries are neighbors to each other. Two matrices of weights are computed: one with $w_{nm} = d_{nm}^{-2}$ (<span class="in">`W1`</span>) and the other with $w_{nm} = \mbox{exp}(-2 d_{nm})$ (<span class="in">`W2`</span>):</span>
<span id="cb89-882"><a href="#cb89-882" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">(</span><span class="co">]</span>{sp<span class="sc">\_</span>solow}{necountries}</span>
<span id="cb89-883"><a href="#cb89-883" aria-hidden="true" tabindex="-1"></a>\idxfun{lm}{stats}\idxfun{dnearneigh}{spdep}\idxfun{nb2listwdist}{spdep}\idxfun{lm.morantest}{spdep}\idxfun{gaze}{micsr}</span>
<span id="cb89-884"><a href="#cb89-884" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-887"><a href="#cb89-887" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb89-888"><a href="#cb89-888" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: true</span></span>
<span id="cb89-889"><a href="#cb89-889" aria-hidden="true" tabindex="-1"></a>lm_solow <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">log</span>(gdp95) <span class="sc">~</span> <span class="fu">log</span>(i) <span class="sc">+</span> <span class="fu">log</span>(v), sp_solow2)</span>
<span id="cb89-890"><a href="#cb89-890" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">dnearneigh</span>(sp_solow2, <span class="dv">0</span>, <span class="cn">Inf</span>)</span>
<span id="cb89-891"><a href="#cb89-891" aria-hidden="true" tabindex="-1"></a>W1 <span class="ot">&lt;-</span> <span class="fu">nb2listwdist</span>(d, sp_solow2, <span class="at">type =</span> <span class="st">"idw"</span>, <span class="at">alpha =</span> <span class="dv">2</span>,</span>
<span id="cb89-892"><a href="#cb89-892" aria-hidden="true" tabindex="-1"></a>                   <span class="at">style =</span> <span class="st">"W"</span>, <span class="at">zero.policy =</span> <span class="cn">TRUE</span>)</span>
<span id="cb89-893"><a href="#cb89-893" aria-hidden="true" tabindex="-1"></a>W2 <span class="ot">&lt;-</span> <span class="fu">nb2listwdist</span>(d, sp_solow2, <span class="at">type =</span> <span class="st">"exp"</span>, <span class="at">alpha =</span> <span class="dv">2</span>,</span>
<span id="cb89-894"><a href="#cb89-894" aria-hidden="true" tabindex="-1"></a>                   <span class="at">style =</span> <span class="st">"W"</span>, <span class="at">zero.policy =</span> <span class="cn">TRUE</span>)</span>
<span id="cb89-895"><a href="#cb89-895" aria-hidden="true" tabindex="-1"></a><span class="fu">lm.morantest</span>(lm_solow, W1) <span class="sc">%&gt;%</span> gaze</span>
<span id="cb89-896"><a href="#cb89-896" aria-hidden="true" tabindex="-1"></a><span class="fu">lm.morantest</span>(lm_solow, W2) <span class="sc">%&gt;%</span> gaze</span>
<span id="cb89-897"><a href="#cb89-897" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-898"><a href="#cb89-898" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-899"><a href="#cb89-899" aria-hidden="true" tabindex="-1"></a>Whatever the weighting matrix, the hypothesis of no spatial correlation is rejected.</span>
<span id="cb89-900"><a href="#cb89-900" aria-hidden="true" tabindex="-1"></a>\idxfun{localmoran}{spdep}\idxfun{resid}{stats}\idxfun{as<span class="sc">\_</span>tibble}{tibble}\idxfun{pull}{dplyr}\idxfun{as.numeric}{base}\idxfun{cut}{base}\idxfun{st<span class="sc">\_</span>set<span class="sc">\_</span>geometry}{sf}\idxfun{add<span class="sc">\_</span>column}{tibble}\idxfun{ggplot}{ggplot2}\idxfun{geom<span class="sc">\_</span>sf}{ggplot2}\idxfun{aes}{ggplot2}\idxfun{scale<span class="sc">\_</span>fill<span class="sc">\_</span>brewer}{ggplot2}</span>
<span id="cb89-901"><a href="#cb89-901" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-904"><a href="#cb89-904" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb89-905"><a href="#cb89-905" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb89-906"><a href="#cb89-906" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb89-907"><a href="#cb89-907" aria-hidden="true" tabindex="-1"></a>locmor <span class="ot">&lt;-</span> <span class="fu">localmoran</span>(<span class="fu">resid</span>(lm_solow), W1)</span>
<span id="cb89-908"><a href="#cb89-908" aria-hidden="true" tabindex="-1"></a>z_locmor <span class="ot">&lt;-</span> locmor <span class="sc">%&gt;%</span> as_tibble <span class="sc">%&gt;%</span> <span class="fu">pull</span>(Ii) <span class="sc">%&gt;%</span> as.numeric</span>
<span id="cb89-909"><a href="#cb89-909" aria-hidden="true" tabindex="-1"></a>z_locmor <span class="ot">&lt;-</span> z_locmor <span class="sc">%&gt;%</span> <span class="fu">cut</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="sc">-</span> <span class="fl">0.5</span>, <span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">1</span>, <span class="fl">1.5</span>, <span class="dv">2</span>, <span class="fl">2.5</span>, <span class="cn">Inf</span>))</span>
<span id="cb89-910"><a href="#cb89-910" aria-hidden="true" tabindex="-1"></a>sp_solow2 <span class="sc">%&gt;%</span> <span class="fu">st_set_geometry</span>(<span class="st">"polygon"</span>) <span class="sc">%&gt;%</span> <span class="fu">add_column</span>(<span class="at">z =</span> z_locmor) <span class="sc">%&gt;%</span> ggplot <span class="sc">+</span> <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> z)) <span class="sc">+</span> <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Blues"</span>)</span>
<span id="cb89-911"><a href="#cb89-911" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-912"><a href="#cb89-912" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">)</span><span class="co">]</span>{sp<span class="sc">\_</span>solow}{necountries}</span>
<span id="cb89-913"><a href="#cb89-913" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{Moran test|)}</span>
<span id="cb89-914"><a href="#cb89-914" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-915"><a href="#cb89-915" aria-hidden="true" tabindex="-1"></a><span class="fu">### Local spatial correlation</span></span>
<span id="cb89-916"><a href="#cb89-916" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-917"><a href="#cb89-917" aria-hidden="true" tabindex="-1"></a>A first glance of local spatial correlation can be obtained using</span>
<span id="cb89-918"><a href="#cb89-918" aria-hidden="true" tabindex="-1"></a>Moran's plot (see @fig-moran_plot), implemented in the <span class="in">`spdep::moran.plot`</span> function, where</span>
<span id="cb89-919"><a href="#cb89-919" aria-hidden="true" tabindex="-1"></a>$y_n - \bar{y}$ is on the $x$ axis and $\tilde{y}_n - \bar{y}$ on the</span>
<span id="cb89-920"><a href="#cb89-920" aria-hidden="true" tabindex="-1"></a>$y$ axis. Therefore, both variables have zero mean and the intercept</span>
<span id="cb89-921"><a href="#cb89-921" aria-hidden="true" tabindex="-1"></a>of the fitting line is therefore 0, the slope being Moran's $I$ statistic:</span>
<span id="cb89-922"><a href="#cb89-922" aria-hidden="true" tabindex="-1"></a>\idxfun{moran.plot}{spdep}</span>
<span id="cb89-923"><a href="#cb89-923" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-924"><a href="#cb89-924" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb89-925"><a href="#cb89-925" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Moran plot"</span></span>
<span id="cb89-926"><a href="#cb89-926" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-moran_plot</span></span>
<span id="cb89-927"><a href="#cb89-927" aria-hidden="true" tabindex="-1"></a><span class="fu">moran.plot</span>(louisiana<span class="sc">$</span>pop_gr, W_louis)</span>
<span id="cb89-928"><a href="#cb89-928" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-929"><a href="#cb89-929" aria-hidden="true" tabindex="-1"></a>Each observation is situated in one of the four quarters of the</span>
<span id="cb89-930"><a href="#cb89-930" aria-hidden="true" tabindex="-1"></a>plane. Observations in the upper-right quarter are *"high-high"* observations, which means</span>
<span id="cb89-931"><a href="#cb89-931" aria-hidden="true" tabindex="-1"></a>  that the value of $y$ for observation $n$ and its neighbors are</span>
<span id="cb89-932"><a href="#cb89-932" aria-hidden="true" tabindex="-1"></a>  higher than the sample mean. Similarly, the lower-left quarter contains *"low-low"* observations, i.e., observations for which own values of $y$ and values of its neighbors are  lower than the sample mean. The upper-left and the lower-right quarters contain respectively the *"low-high"* and the *"high-low"* observations.</span>
<span id="cb89-933"><a href="#cb89-933" aria-hidden="true" tabindex="-1"></a>In case of no spatial correlation, the points should be randomly</span>
<span id="cb89-934"><a href="#cb89-934" aria-hidden="true" tabindex="-1"></a>disposed around the origin and the slope of the regression line should</span>
<span id="cb89-935"><a href="#cb89-935" aria-hidden="true" tabindex="-1"></a>be 0. On the contrary, in case of positive spatial correlation, a</span>
<span id="cb89-936"><a href="#cb89-936" aria-hidden="true" tabindex="-1"></a>majority of points should be of the *"low-low"* or *"high-high"*</span>
<span id="cb89-937"><a href="#cb89-937" aria-hidden="true" tabindex="-1"></a>category and the regression line should have a positive slope. </span>
<span id="cb89-938"><a href="#cb89-938" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-939"><a href="#cb89-939" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{Moran test!local|(}</span>
<span id="cb89-940"><a href="#cb89-940" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{Geary test!local|(}</span>
<span id="cb89-941"><a href="#cb89-941" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-942"><a href="#cb89-942" aria-hidden="true" tabindex="-1"></a>@ANSE:95\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Anselin} proposed local versions of Moran's $I$ and Geary's $C$ statistics. We then</span>
<span id="cb89-943"><a href="#cb89-943" aria-hidden="true" tabindex="-1"></a>have for each observation $I_n$ and $G_n$ so that $\sum_n I_n$ and</span>
<span id="cb89-944"><a href="#cb89-944" aria-hidden="true" tabindex="-1"></a>$\sum_n G_n$ are respectively proportional to the global Moran and</span>
<span id="cb89-945"><a href="#cb89-945" aria-hidden="true" tabindex="-1"></a>Geary statistics. Local Moran's statistics are defined as:</span>
<span id="cb89-946"><a href="#cb89-946" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-947"><a href="#cb89-947" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb89-948"><a href="#cb89-948" aria-hidden="true" tabindex="-1"></a>I_n = (y_n - \bar{y}) \sum_m w_{nm} (y_m - \bar{y}) = (y_n - \bar{y})(\tilde{y}_n - \bar{y})</span>
<span id="cb89-949"><a href="#cb89-949" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb89-950"><a href="#cb89-950" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-951"><a href="#cb89-951" aria-hidden="true" tabindex="-1"></a>and their sum is $(y_n - \bar{y})(\tilde{y}_n - \bar{y})$, which is</span>
<span id="cb89-952"><a href="#cb89-952" aria-hidden="true" tabindex="-1"></a>the numerator of Moran's $I$ statistic. Therefore, we have:</span>
<span id="cb89-953"><a href="#cb89-953" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-954"><a href="#cb89-954" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb89-955"><a href="#cb89-955" aria-hidden="true" tabindex="-1"></a>I = \frac{\sum_n I_n}{\sum_n (y_n - \bar{y}) ^ 2}</span>
<span id="cb89-956"><a href="#cb89-956" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb89-957"><a href="#cb89-957" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-958"><a href="#cb89-958" aria-hidden="true" tabindex="-1"></a>Local Moran's statistics are obtained using the <span class="in">`spdep::localmoran`</span> function:</span>
<span id="cb89-959"><a href="#cb89-959" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">(</span><span class="co">]</span>{agglo<span class="sc">\_</span>growth}{micsr.data}</span>
<span id="cb89-960"><a href="#cb89-960" aria-hidden="true" tabindex="-1"></a>\idxfun{localmoran}{spdep}</span>
<span id="cb89-961"><a href="#cb89-961" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-962"><a href="#cb89-962" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb89-963"><a href="#cb89-963" aria-hidden="true" tabindex="-1"></a>locmor <span class="ot">&lt;-</span> <span class="fu">localmoran</span>(louisiana<span class="sc">$</span>pop_gr, W_louis)</span>
<span id="cb89-964"><a href="#cb89-964" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-965"><a href="#cb89-965" aria-hidden="true" tabindex="-1"></a>which returns a matrix, with a line for every observation and column</span>
<span id="cb89-966"><a href="#cb89-966" aria-hidden="true" tabindex="-1"></a>containing the local Moran values, their expectation, variance, the standardized</span>
<span id="cb89-967"><a href="#cb89-967" aria-hidden="true" tabindex="-1"></a>statistic and the p-value. It's easier to coerce this matrix to a</span>
<span id="cb89-968"><a href="#cb89-968" aria-hidden="true" tabindex="-1"></a>tibble in order to extract extreme values of the statistic:^<span class="co">[</span><span class="ot">Note that we also rename for convenience the fifth column which has a non-standard name (`Pr(z != E(Ii))`) to `pval`.</span><span class="co">]</span></span>
<span id="cb89-969"><a href="#cb89-969" aria-hidden="true" tabindex="-1"></a>\idxfun{as<span class="sc">\_</span>tibble}{tibble}\idxfun{rename}{dplyr}\idxfun{filter}{dplyr}</span>
<span id="cb89-970"><a href="#cb89-970" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-971"><a href="#cb89-971" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb89-972"><a href="#cb89-972" aria-hidden="true" tabindex="-1"></a>locmor <span class="sc">%&gt;%</span> as_tibble <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">pval =</span> <span class="dv">5</span>) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(pval <span class="sc">&lt;</span> <span class="fl">0.01</span>)</span>
<span id="cb89-973"><a href="#cb89-973" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-974"><a href="#cb89-974" aria-hidden="true" tabindex="-1"></a>There are therefore 11 out of 64 (17%) observations for which the p-value is lower</span>
<span id="cb89-975"><a href="#cb89-975" aria-hidden="true" tabindex="-1"></a>than 1%, which confirms the presence of spatial correlation. The local</span>
<span id="cb89-976"><a href="#cb89-976" aria-hidden="true" tabindex="-1"></a>Moran statistic can also be represented in a map (@fig-map_local_moran), in order to identify</span>
<span id="cb89-977"><a href="#cb89-977" aria-hidden="true" tabindex="-1"></a>the "hot spots":^<span class="co">[</span><span class="ot">Note that the orders of the levels are reversed using `forcats::fct_rev`, so that the high values are represented in dark gray.</span><span class="co">]</span></span>
<span id="cb89-978"><a href="#cb89-978" aria-hidden="true" tabindex="-1"></a>\idxfun{as<span class="sc">\_</span>tibble}{tibble}\idxfun{pull}{dplyr}\idxfun{as.numeric}{base}\idxfun{cut}{base}\idxfun{add<span class="sc">\_</span>column}{tibble}\idxfun{mutate}{dplyr}\idxfun{fct<span class="sc">\_</span>rev}{forcats}\idxfun{ggplot}{ggplot2}\idxfun{geom<span class="sc">\_</span>sf}{ggplot2}\idxfun{scale<span class="sc">\_</span>fill<span class="sc">\_</span>grey}{ggplot2}</span>
<span id="cb89-979"><a href="#cb89-979" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-980"><a href="#cb89-980" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb89-981"><a href="#cb89-981" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Map of local Moran statistic"</span></span>
<span id="cb89-982"><a href="#cb89-982" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-map_local_moran</span></span>
<span id="cb89-983"><a href="#cb89-983" aria-hidden="true" tabindex="-1"></a>z_locmor <span class="ot">&lt;-</span> locmor <span class="sc">%&gt;%</span> as_tibble <span class="sc">%&gt;%</span> <span class="fu">pull</span>(Ii) <span class="sc">%&gt;%</span> as.numeric</span>
<span id="cb89-984"><a href="#cb89-984" aria-hidden="true" tabindex="-1"></a>z_locmor <span class="ot">&lt;-</span> z_locmor <span class="sc">%&gt;%</span> </span>
<span id="cb89-985"><a href="#cb89-985" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cut</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="sc">-</span> <span class="fl">0.5</span>, <span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">1</span>, <span class="fl">1.5</span>, <span class="dv">2</span>, <span class="fl">2.5</span>, <span class="cn">Inf</span>))</span>
<span id="cb89-986"><a href="#cb89-986" aria-hidden="true" tabindex="-1"></a>louisiana <span class="sc">%&gt;%</span> <span class="fu">add_column</span>(<span class="at">z =</span> z_locmor) <span class="sc">%&gt;%</span> </span>
<span id="cb89-987"><a href="#cb89-987" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">z =</span> <span class="fu">fct_rev</span>(z)) <span class="sc">%&gt;%</span> </span>
<span id="cb89-988"><a href="#cb89-988" aria-hidden="true" tabindex="-1"></a>  ggplot <span class="sc">+</span> <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> z)) <span class="sc">+</span> </span>
<span id="cb89-989"><a href="#cb89-989" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_grey</span>()</span>
<span id="cb89-990"><a href="#cb89-990" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb89-991"><a href="#cb89-991" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-992"><a href="#cb89-992" aria-hidden="true" tabindex="-1"></a>Two hot spots are then identified, in the north-west and the</span>
<span id="cb89-993"><a href="#cb89-993" aria-hidden="true" tabindex="-1"></a>south-west of the state.</span>
<span id="cb89-994"><a href="#cb89-994" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-995"><a href="#cb89-995" aria-hidden="true" tabindex="-1"></a><span class="in">```{r include = FALSE, eval = FALSE}</span></span>
<span id="cb89-996"><a href="#cb89-996" aria-hidden="true" tabindex="-1"></a>crossproduct <span class="ot">&lt;-</span> <span class="cf">function</span>(x, y){</span>
<span id="cb89-997"><a href="#cb89-997" aria-hidden="true" tabindex="-1"></a>    J <span class="ot">&lt;-</span> <span class="fu">length</span>(x<span class="sc">$</span>weights)</span>
<span id="cb89-998"><a href="#cb89-998" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span>J, <span class="cf">function</span>(j) <span class="fu">sum</span>(y[x<span class="sc">$</span>neighbours[[j]]] <span class="sc">*</span> x<span class="sc">$</span>weights[[j]]))</span>
<span id="cb89-999"><a href="#cb89-999" aria-hidden="true" tabindex="-1"></a>y_yb <span class="ot">&lt;-</span> crime_nc<span class="sc">$</span>crime_rate <span class="sc">-</span> <span class="fu">mean</span>(crime_nc<span class="sc">$</span>crime_rate)</span>
<span id="cb89-1000"><a href="#cb89-1000" aria-hidden="true" tabindex="-1"></a><span class="fu">as.numeric</span>(<span class="fu">crossprod</span>(<span class="fu">crossproduct</span>(W, y_yb), y_yb)) <span class="sc">/</span> <span class="fu">sum</span>(y_yb <span class="sc">^</span> <span class="dv">2</span>)</span>
<span id="cb89-1001"><a href="#cb89-1001" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="fu">length</span>(y_yb)</span>
<span id="cb89-1002"><a href="#cb89-1002" aria-hidden="true" tabindex="-1"></a>S0 <span class="ot">&lt;-</span> N</span>
<span id="cb89-1003"><a href="#cb89-1003" aria-hidden="true" tabindex="-1"></a>Wm <span class="ot">&lt;-</span> W <span class="sc">%&gt;%</span> listw2mat</span>
<span id="cb89-1004"><a href="#cb89-1004" aria-hidden="true" tabindex="-1"></a>S1 <span class="ot">&lt;-</span> <span class="fu">sum</span>((Wm <span class="sc">+</span> (<span class="fu">t</span>(Wm))) <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb89-1005"><a href="#cb89-1005" aria-hidden="true" tabindex="-1"></a>S2 <span class="ot">&lt;-</span> <span class="fu">sum</span>( (<span class="fu">apply</span>(Wm, <span class="dv">1</span>, sum) <span class="sc">+</span> <span class="fu">apply</span>(Wm, <span class="dv">2</span>, sum)) <span class="sc">^</span> <span class="dv">2</span>)</span>
<span id="cb89-1006"><a href="#cb89-1006" aria-hidden="true" tabindex="-1"></a>S3 <span class="ot">&lt;-</span> (<span class="fu">sum</span>(y_yb <span class="sc">^</span> <span class="dv">4</span>) <span class="sc">/</span> N) <span class="sc">/</span> (<span class="fu">sum</span>(y_yb <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">/</span> N) <span class="sc">^</span> <span class="dv">2</span></span>
<span id="cb89-1007"><a href="#cb89-1007" aria-hidden="true" tabindex="-1"></a>S4 <span class="ot">&lt;-</span> (N <span class="sc">^</span> <span class="dv">2</span> <span class="sc">-</span> <span class="dv">3</span> <span class="sc">*</span> N <span class="sc">+</span> <span class="dv">3</span>) <span class="sc">*</span> S1 <span class="sc">-</span> N <span class="sc">*</span> S2 <span class="sc">+</span> <span class="dv">3</span> <span class="sc">*</span> S0 <span class="sc">^</span> <span class="dv">2</span></span>
<span id="cb89-1008"><a href="#cb89-1008" aria-hidden="true" tabindex="-1"></a>S5 <span class="ot">&lt;-</span> (N <span class="sc">^</span> <span class="dv">2</span> <span class="sc">-</span> N) <span class="sc">*</span> S1 <span class="sc">-</span> <span class="dv">2</span> <span class="sc">*</span> N <span class="sc">*</span> S2 <span class="sc">+</span> <span class="dv">6</span> <span class="sc">*</span> S0 <span class="sc">^</span> <span class="dv">2</span></span>
<span id="cb89-1009"><a href="#cb89-1009" aria-hidden="true" tabindex="-1"></a>V <span class="ot">&lt;-</span> (N <span class="sc">*</span> S4 <span class="sc">-</span> S3 <span class="sc">*</span> S5) <span class="sc">/</span> ( (N <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> (N <span class="sc">-</span> <span class="dv">2</span>) <span class="sc">*</span> (N <span class="sc">-</span> <span class="dv">3</span>) <span class="sc">*</span> S0 <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">-</span> <span class="dv">1</span> <span class="sc">/</span> (N <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">^</span> <span class="dv">2</span></span>
<span id="cb89-1010"><a href="#cb89-1010" aria-hidden="true" tabindex="-1"></a><span class="st">```</span></span>
<span id="cb89-1011"><a href="#cb89-1011" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1012"><a href="#cb89-1012" aria-hidden="true" tabindex="-1"></a><span class="at">\index[general]{Moran test!local|)}</span></span>
<span id="cb89-1013"><a href="#cb89-1013" aria-hidden="true" tabindex="-1"></a><span class="at">\index[general]{Geary test!local|)}</span></span>
<span id="cb89-1014"><a href="#cb89-1014" aria-hidden="true" tabindex="-1"></a><span class="at">\idxdata[)]{agglo\_growth}{micsr.data}</span></span>
<span id="cb89-1015"><a href="#cb89-1015" aria-hidden="true" tabindex="-1"></a><span class="at">\index[general]{spatial correlation!tests|)}</span></span>
<span id="cb89-1016"><a href="#cb89-1016" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1017"><a href="#cb89-1017" aria-hidden="true" tabindex="-1"></a><span class="at">## Spatial econometrics {#sec-spatial_models}</span></span>
<span id="cb89-1018"><a href="#cb89-1018" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1019"><a href="#cb89-1019" aria-hidden="true" tabindex="-1"></a><span class="at">### Spatial models and tests</span></span>
<span id="cb89-1020"><a href="#cb89-1020" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1021"><a href="#cb89-1021" aria-hidden="true" tabindex="-1"></a><span class="at">We consider here linear gaussian models that are extended in order to</span></span>
<span id="cb89-1022"><a href="#cb89-1022" aria-hidden="true" tabindex="-1"></a><span class="at">integrate the spatial features of the sample, using the weighting</span></span>
<span id="cb89-1023"><a href="#cb89-1023" aria-hidden="true" tabindex="-1"></a><span class="at">matrix described in the previous section. Two main models can be</span></span>
<span id="cb89-1024"><a href="#cb89-1024" aria-hidden="true" tabindex="-1"></a><span class="at">considered. The first one is the **spatial error model** (**SEM**) which</span></span>
<span id="cb89-1025"><a href="#cb89-1025" aria-hidden="true" tabindex="-1"></a><span class="at">can be written in matrix form as:</span></span>
<span id="cb89-1026"><a href="#cb89-1026" aria-hidden="true" tabindex="-1"></a><span class="at">\index[general]{spatial error model|(}</span></span>
<span id="cb89-1027"><a href="#cb89-1027" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1028"><a href="#cb89-1028" aria-hidden="true" tabindex="-1"></a><span class="at">$$</span></span>
<span id="cb89-1029"><a href="#cb89-1029" aria-hidden="true" tabindex="-1"></a><span class="at">y = </span><span class="sc">\a</span><span class="at">lpha \iota + X </span><span class="sc">\b</span><span class="at">eta + </span><span class="sc">\e</span><span class="at">psilon \; \mbox{with} \; </span><span class="sc">\e</span><span class="at">psilon = </span><span class="sc">\r</span><span class="at">ho_</span><span class="sc">\e</span><span class="at">psilon W </span><span class="sc">\e</span><span class="at">psilon + </span><span class="sc">\n</span><span class="at">u</span></span>
<span id="cb89-1030"><a href="#cb89-1030" aria-hidden="true" tabindex="-1"></a><span class="at">$$ {#eq-sem}</span></span>
<span id="cb89-1031"><a href="#cb89-1031" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1032"><a href="#cb89-1032" aria-hidden="true" tabindex="-1"></a><span class="at">Therefore, the error for observation $n$ is linearly related to the</span></span>
<span id="cb89-1033"><a href="#cb89-1033" aria-hidden="true" tabindex="-1"></a><span class="at">errors of its neighbors $</span><span class="sc">\t</span><span class="at">ilde{</span><span class="sc">\e</span><span class="at">psilon}_n$. OLS estimation</span></span>
<span id="cb89-1034"><a href="#cb89-1034" aria-hidden="true" tabindex="-1"></a><span class="at">gives unbiased and consistent estimators but, as always with</span></span>
<span id="cb89-1035"><a href="#cb89-1035" aria-hidden="true" tabindex="-1"></a><span class="at">non-spherical errors, it is inefficient and the estimated </span></span>
<span id="cb89-1036"><a href="#cb89-1036" aria-hidden="true" tabindex="-1"></a><span class="at">covariance matrix of the coefficients based on the simple formula ($\sigma ^ 2 (</span><span class="sc">\t</span><span class="at">ilde{X}^</span><span class="sc">\t</span><span class="at">op </span><span class="sc">\t</span><span class="at">ilde{X}) ^ {-1}$)</span></span>
<span id="cb89-1037"><a href="#cb89-1037" aria-hidden="true" tabindex="-1"></a><span class="at">is biased.</span></span>
<span id="cb89-1038"><a href="#cb89-1038" aria-hidden="true" tabindex="-1"></a><span class="at">\index[general]{spatial error model|)}</span></span>
<span id="cb89-1039"><a href="#cb89-1039" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1040"><a href="#cb89-1040" aria-hidden="true" tabindex="-1"></a><span class="at">\index[general]{spatial autoregressive model|(}</span></span>
<span id="cb89-1041"><a href="#cb89-1041" aria-hidden="true" tabindex="-1"></a><span class="at">The second model is called the **spatial autoregressive model** (**SAR**).^[This model is also known as the spatial lag model.]. It extends the basic gaussian</span></span>
<span id="cb89-1042"><a href="#cb89-1042" aria-hidden="true" tabindex="-1"></a><span class="at">linear model by adding as a regressor the mean value of the response</span></span>
<span id="cb89-1043"><a href="#cb89-1043" aria-hidden="true" tabindex="-1"></a><span class="at">for the neighbor units. For one observation, the model writes $y_n =</span><span class="sc">\a</span><span class="at">lpha + </span><span class="sc">\b</span><span class="at">eta ^ </span><span class="sc">\t</span><span class="at">op x_n + </span><span class="sc">\r</span><span class="at">ho_y </span><span class="sc">\t</span><span class="at">ilde{y}_n + </span><span class="sc">\e</span><span class="at">psilon_n$ or, in matrix</span></span>
<span id="cb89-1044"><a href="#cb89-1044" aria-hidden="true" tabindex="-1"></a><span class="at">form:</span></span>
<span id="cb89-1045"><a href="#cb89-1045" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1046"><a href="#cb89-1046" aria-hidden="true" tabindex="-1"></a><span class="at">$$</span></span>
<span id="cb89-1047"><a href="#cb89-1047" aria-hidden="true" tabindex="-1"></a><span class="at">y = </span><span class="sc">\a</span><span class="at">lpha j + X </span><span class="sc">\b</span><span class="at">eta + </span><span class="sc">\r</span><span class="at">ho_y W y + </span><span class="sc">\e</span><span class="at">psilon = Z \gamma + </span><span class="sc">\r</span><span class="at">ho_y W y + </span><span class="sc">\e</span><span class="at">psilon</span></span>
<span id="cb89-1048"><a href="#cb89-1048" aria-hidden="true" tabindex="-1"></a><span class="at">$$</span></span>
<span id="cb89-1049"><a href="#cb89-1049" aria-hidden="true" tabindex="-1"></a><span class="at">The reduced form of the model is:</span></span>
<span id="cb89-1050"><a href="#cb89-1050" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1051"><a href="#cb89-1051" aria-hidden="true" tabindex="-1"></a><span class="at">$$</span></span>
<span id="cb89-1052"><a href="#cb89-1052" aria-hidden="true" tabindex="-1"></a><span class="at">y = (I - </span><span class="sc">\r</span><span class="at">ho_y W) ^ {-1} Z \gamma + (I - </span><span class="sc">\r</span><span class="at">ho_y W) ^ {-1}</span><span class="sc">\e</span><span class="at">psilon</span></span>
<span id="cb89-1053"><a href="#cb89-1053" aria-hidden="true" tabindex="-1"></a><span class="at">$$  {#eq-sar}</span></span>
<span id="cb89-1054"><a href="#cb89-1054" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1055"><a href="#cb89-1055" aria-hidden="true" tabindex="-1"></a><span class="at">Therefore, the values of $y$ depend on all the values of $</span><span class="sc">\e</span><span class="at">psilon$,</span></span>
<span id="cb89-1056"><a href="#cb89-1056" aria-hidden="true" tabindex="-1"></a><span class="at">and $</span><span class="sc">\t</span><span class="at">ilde{y}_{n}$ is therefore correlated with $</span><span class="sc">\e</span><span class="at">psilon_n$. The</span></span>
<span id="cb89-1057"><a href="#cb89-1057" aria-hidden="true" tabindex="-1"></a><span class="at">OLS estimator is therefore biased and inconsistent. Moreover, in</span></span>
<span id="cb89-1058"><a href="#cb89-1058" aria-hidden="true" tabindex="-1"></a><span class="at">@eq-sar, the spatial dependence in the parameter $</span><span class="sc">\r</span><span class="at">ho_y$ feeds back</span></span>
<span id="cb89-1059"><a href="#cb89-1059" aria-hidden="true" tabindex="-1"></a><span class="at">[@BIVA:MILL:PIRA:21, page 6]\index[author]{Bivand}\index[author]{Millo}\index[author]{Piras}, which is not the case for @eq-sem. This means</span></span>
<span id="cb89-1060"><a href="#cb89-1060" aria-hidden="true" tabindex="-1"></a><span class="at">that for the SEM model, the marginal effect of a covariate is the</span></span>
<span id="cb89-1061"><a href="#cb89-1061" aria-hidden="true" tabindex="-1"></a><span class="at">corresponding coefficient, but this is not the case for the SAR model.</span></span>
<span id="cb89-1062"><a href="#cb89-1062" aria-hidden="true" tabindex="-1"></a><span class="at">Moreover, the matrix $(I - </span><span class="sc">\r</span><span class="at">ho_y W) ^ {-1}$ can be written as an</span></span>
<span id="cb89-1063"><a href="#cb89-1063" aria-hidden="true" tabindex="-1"></a><span class="at">infinite series:</span></span>
<span id="cb89-1064"><a href="#cb89-1064" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1065"><a href="#cb89-1065" aria-hidden="true" tabindex="-1"></a><span class="at">$$</span></span>
<span id="cb89-1066"><a href="#cb89-1066" aria-hidden="true" tabindex="-1"></a><span class="at">(I - </span><span class="sc">\r</span><span class="at">ho_y W) ^ {-1} = I + </span><span class="sc">\r</span><span class="at">ho_y W + </span><span class="sc">\r</span><span class="at">ho_y^2 W^2 + </span><span class="sc">\r</span><span class="at">ho_y^3</span></span>
<span id="cb89-1067"><a href="#cb89-1067" aria-hidden="true" tabindex="-1"></a><span class="at">W^3 + \ldots</span></span>
<span id="cb89-1068"><a href="#cb89-1068" aria-hidden="true" tabindex="-1"></a><span class="at">$$</span></span>
<span id="cb89-1069"><a href="#cb89-1069" aria-hidden="true" tabindex="-1"></a><span class="at">Consider the case of three observations, France (1), Italy (2) and Spain (3). The matrix of contiguity is:</span></span>
<span id="cb89-1070"><a href="#cb89-1070" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1071"><a href="#cb89-1071" aria-hidden="true" tabindex="-1"></a><span class="at">$$</span></span>
<span id="cb89-1072"><a href="#cb89-1072" aria-hidden="true" tabindex="-1"></a><span class="at">W = \left(</span><span class="sc">\b</span><span class="at">egin{array}{rcl} 0 &amp; 0.5 &amp; 0.5 </span><span class="sc">\\</span><span class="at"> 1 &amp; 0 &amp; 0 </span><span class="sc">\\</span><span class="at"> 1 &amp; 0 &amp; 0</span><span class="sc">\e</span><span class="at">nd{array}</span><span class="sc">\r</span><span class="at">ight)</span></span>
<span id="cb89-1073"><a href="#cb89-1073" aria-hidden="true" tabindex="-1"></a><span class="at">$$</span></span>
<span id="cb89-1074"><a href="#cb89-1074" aria-hidden="true" tabindex="-1"></a><span class="at">France has two neighbors (Italy and Spain) and Italy and Spain only one (France). The weights are such that they sum to 1 for each line. Consider a variation of the unique covariate in Spain ($\Delta x_3$) and denote $</span><span class="sc">\b</span><span class="at">eta$ the corresponding coefficient. The direct effect on the response for the three countries is obviously $\Delta y_0 ^ </span><span class="sc">\t</span><span class="at">op = (0, 0, </span><span class="sc">\b</span><span class="at">eta \Delta x_3)$. This increase of $y$ in Spain implies an increase of $y$ in the neighboring country, France. Therefore, $\Delta y_1 ^ </span><span class="sc">\t</span><span class="at">op = (0.5 </span><span class="sc">\r</span><span class="at">ho_y </span><span class="sc">\b</span><span class="at">eta \Delta x_3, 0, 0)$. This increase of $y$ in France implies an increase of $y$ in the neighboring countries, Italy and Spain: $\Delta y_2 ^ </span><span class="sc">\t</span><span class="at">op = (0, 0.5 </span><span class="sc">\r</span><span class="at">ho_y ^ 2 </span><span class="sc">\b</span><span class="at">eta \Delta x_3, 0.5 </span><span class="sc">\r</span><span class="at">ho_y ^ 2 </span><span class="sc">\b</span><span class="at">eta \Delta x_3)$. This increase of $y$ in Italy and Spain implies an increase of $y$ in the neighboring country of Italy and Spain, which is France: $\Delta y_3 ^ </span><span class="sc">\t</span><span class="at">op = (0.5</span><span class="sc">\r</span><span class="at">ho_y ^ 3 </span><span class="sc">\b</span><span class="at">eta \Delta x_3, 0, 0)$, etc. To take a numerical example, consider $</span><span class="sc">\b</span><span class="at">eta \Delta x_3 = 1$ and $</span><span class="sc">\r</span><span class="at">ho_y = 0.3$. Then, $\Delta y_0 ^ </span><span class="sc">\t</span><span class="at">op = (0, 0, 1)$, $\Delta y_1 ^ </span><span class="sc">\t</span><span class="at">op = (0.15, 0, 0)$, $\Delta y_2 ^ </span><span class="sc">\t</span><span class="at">op = (0, 0.045, 0.045)$ and $\Delta y_3 ^ </span><span class="sc">\t</span><span class="at">op = (0.0135, 0, 0)$. In total, we have $\sum_{i = 0} ^ 3 \Delta y_i ^ </span><span class="sc">\t</span><span class="at">op = (0.177, 0.045, 1.045)$. These four effects and their sum is computed below:</span></span>
<span id="cb89-1075"><a href="#cb89-1075" aria-hidden="true" tabindex="-1"></a><span class="at">\idxfun{matrix}{base}\idxfun{diag}{base}\idxfun{cbind}{base}\idxfun{apply}{base}</span></span>
<span id="cb89-1076"><a href="#cb89-1076" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1079"><a href="#cb89-1079" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb89-1080"><a href="#cb89-1080" aria-hidden="true" tabindex="-1"></a>W <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="fl">0.5</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">0</span>, <span class="dv">0</span>), <span class="at">nrow =</span> <span class="dv">3</span>)</span>
<span id="cb89-1081"><a href="#cb89-1081" aria-hidden="true" tabindex="-1"></a>bdx <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb89-1082"><a href="#cb89-1082" aria-hidden="true" tabindex="-1"></a>rho <span class="ot">&lt;-</span> <span class="fl">0.3</span></span>
<span id="cb89-1083"><a href="#cb89-1083" aria-hidden="true" tabindex="-1"></a>dy0 <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="dv">3</span>) <span class="sc">%*%</span> bdx</span>
<span id="cb89-1084"><a href="#cb89-1084" aria-hidden="true" tabindex="-1"></a>dy1 <span class="ot">&lt;-</span> rho <span class="sc">*</span> W <span class="sc">%*%</span> bdx</span>
<span id="cb89-1085"><a href="#cb89-1085" aria-hidden="true" tabindex="-1"></a>dy2 <span class="ot">&lt;-</span> rho <span class="sc">^</span> <span class="dv">2</span> <span class="sc">*</span> W <span class="sc">%*%</span> W <span class="sc">%*%</span> bdx</span>
<span id="cb89-1086"><a href="#cb89-1086" aria-hidden="true" tabindex="-1"></a>dy3 <span class="ot">&lt;-</span> rho <span class="sc">^</span> <span class="dv">3</span> <span class="sc">*</span> W <span class="sc">%*%</span> W <span class="sc">%*%</span> W <span class="sc">%*%</span> bdx</span>
<span id="cb89-1087"><a href="#cb89-1087" aria-hidden="true" tabindex="-1"></a>dy_03 <span class="ot">&lt;-</span> <span class="fu">cbind</span>(dy0, dy1, dy2, dy3)</span>
<span id="cb89-1088"><a href="#cb89-1088" aria-hidden="true" tabindex="-1"></a>dy_03</span>
<span id="cb89-1089"><a href="#cb89-1089" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(dy_03, <span class="dv">1</span>, sum)</span>
<span id="cb89-1090"><a href="#cb89-1090" aria-hidden="true" tabindex="-1"></a><span class="st">```</span></span>
<span id="cb89-1091"><a href="#cb89-1091" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1092"><a href="#cb89-1092" aria-hidden="true" tabindex="-1"></a><span class="at">The total effect of $\Delta x_3$ is obtained using the formula: $\Delta y = (I - </span><span class="sc">\r</span><span class="at">ho_y W) ^ {-1} \Delta x$:</span></span>
<span id="cb89-1093"><a href="#cb89-1093" aria-hidden="true" tabindex="-1"></a><span class="at">\idxfun{solve}{base}\idxfun{diag}{base}</span></span>
<span id="cb89-1094"><a href="#cb89-1094" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1097"><a href="#cb89-1097" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb89-1098"><a href="#cb89-1098" aria-hidden="true" tabindex="-1"></a><span class="fu">solve</span>(<span class="fu">diag</span>(<span class="dv">3</span>) <span class="sc">-</span> rho <span class="sc">*</span> W) <span class="sc">%*%</span> bdx</span>
<span id="cb89-1099"><a href="#cb89-1099" aria-hidden="true" tabindex="-1"></a><span class="st">```</span></span>
<span id="cb89-1100"><a href="#cb89-1100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1101"><a href="#cb89-1101" aria-hidden="true" tabindex="-1"></a><span class="at">which is very close to the sum of the direct effect and the first three indirect effects computed previously.</span></span>
<span id="cb89-1102"><a href="#cb89-1102" aria-hidden="true" tabindex="-1"></a><span class="at">\index[general]{spatial autoregressive model|)}</span></span>
<span id="cb89-1103"><a href="#cb89-1103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1104"><a href="#cb89-1104" aria-hidden="true" tabindex="-1"></a><span class="at">\index[general]{spatial error model|(}</span></span>
<span id="cb89-1105"><a href="#cb89-1105" aria-hidden="true" tabindex="-1"></a><span class="at">Spatial models are usually estimated by maximum likelihood, by</span></span>
<span id="cb89-1106"><a href="#cb89-1106" aria-hidden="true" tabindex="-1"></a><span class="at">assuming a multivariate normal distribution for the iid errors. For</span></span>
<span id="cb89-1107"><a href="#cb89-1107" aria-hidden="true" tabindex="-1"></a><span class="at">the SEM model, the idiosyncratic errors can be written as a</span></span>
<span id="cb89-1108"><a href="#cb89-1108" aria-hidden="true" tabindex="-1"></a><span class="at">function of the response:</span></span>
<span id="cb89-1109"><a href="#cb89-1109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1110"><a href="#cb89-1110" aria-hidden="true" tabindex="-1"></a><span class="at">$$</span></span>
<span id="cb89-1111"><a href="#cb89-1111" aria-hidden="true" tabindex="-1"></a><span class="sc">\n</span><span class="at">u = (I - </span><span class="sc">\r</span><span class="at">ho_</span><span class="sc">\e</span><span class="at">psilon W) y - (I - </span><span class="sc">\r</span><span class="at">ho_</span><span class="sc">\e</span><span class="at">psilon W) Z\gamma</span></span>
<span id="cb89-1112"><a href="#cb89-1112" aria-hidden="true" tabindex="-1"></a><span class="at">$$ {#eq-etasem}</span></span>
<span id="cb89-1113"><a href="#cb89-1113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1114"><a href="#cb89-1114" aria-hidden="true" tabindex="-1"></a><span class="at">so that the Jacobian of the transformation is </span></span>
<span id="cb89-1115"><a href="#cb89-1115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1116"><a href="#cb89-1116" aria-hidden="true" tabindex="-1"></a><span class="at">$$\left| </span><span class="sc">\f</span><span class="at">rac{\partial </span><span class="sc">\n</span><span class="at">u}{\partial y} </span><span class="sc">\r</span><span class="at">ight| = </span></span>
<span id="cb89-1117"><a href="#cb89-1117" aria-hidden="true" tabindex="-1"></a><span class="at">\left| I - </span><span class="sc">\r</span><span class="at">ho_</span><span class="sc">\e</span><span class="at">psilon W </span><span class="sc">\r</span><span class="at">ight|$$. </span></span>
<span id="cb89-1118"><a href="#cb89-1118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1119"><a href="#cb89-1119" aria-hidden="true" tabindex="-1"></a><span class="at">the likelihood is similar to the one of the linear</span></span>
<span id="cb89-1120"><a href="#cb89-1120" aria-hidden="true" tabindex="-1"></a><span class="at">gaussian model except that an extra term, which is the log of the</span></span>
<span id="cb89-1121"><a href="#cb89-1121" aria-hidden="true" tabindex="-1"></a><span class="at">Jacobian, should be added:</span></span>
<span id="cb89-1122"><a href="#cb89-1122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1123"><a href="#cb89-1123" aria-hidden="true" tabindex="-1"></a><span class="at">$$</span></span>
<span id="cb89-1124"><a href="#cb89-1124" aria-hidden="true" tabindex="-1"></a><span class="at">-N/2 (\ln 2\pi + \ln \sigma ^ 2) + \ln \left| I - </span><span class="sc">\r</span><span class="at">ho_</span><span class="sc">\e</span><span class="at">psilon W </span><span class="sc">\r</span><span class="at">ight|  -</span></span>
<span id="cb89-1125"><a href="#cb89-1125" aria-hidden="true" tabindex="-1"></a><span class="sc">\f</span><span class="at">rac{1}{\sigma ^ 2} </span><span class="sc">\n</span><span class="at">u^</span><span class="sc">\t</span><span class="at">op </span><span class="sc">\n</span><span class="at">u</span></span>
<span id="cb89-1126"><a href="#cb89-1126" aria-hidden="true" tabindex="-1"></a><span class="at">$$</span></span>
<span id="cb89-1127"><a href="#cb89-1127" aria-hidden="true" tabindex="-1"></a><span class="at">where $</span><span class="sc">\n</span><span class="at">u$ is given by @eq-etasem.</span></span>
<span id="cb89-1128"><a href="#cb89-1128" aria-hidden="true" tabindex="-1"></a><span class="at">\index[general]{spatial error model|)}</span></span>
<span id="cb89-1129"><a href="#cb89-1129" aria-hidden="true" tabindex="-1"></a><span class="at">\index[general]{spatial autoregressive model|(}</span></span>
<span id="cb89-1130"><a href="#cb89-1130" aria-hidden="true" tabindex="-1"></a><span class="at">For the **SAR** model, @eq-sar indicates that the Jacobian is the</span></span>
<span id="cb89-1131"><a href="#cb89-1131" aria-hidden="true" tabindex="-1"></a><span class="at">same, so that the log-likelihood is:</span></span>
<span id="cb89-1132"><a href="#cb89-1132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1133"><a href="#cb89-1133" aria-hidden="true" tabindex="-1"></a><span class="at">$$</span></span>
<span id="cb89-1134"><a href="#cb89-1134" aria-hidden="true" tabindex="-1"></a><span class="at">-N/2 (\ln 2\pi + \ln \sigma ^ 2) + \ln \left| I - </span><span class="sc">\r</span><span class="at">ho_y W </span><span class="sc">\r</span><span class="at">ight|  -</span></span>
<span id="cb89-1135"><a href="#cb89-1135" aria-hidden="true" tabindex="-1"></a><span class="sc">\f</span><span class="at">rac{1}{\sigma ^ 2} </span><span class="sc">\e</span><span class="at">psilon^</span><span class="sc">\t</span><span class="at">op </span><span class="sc">\e</span><span class="at">psilon</span></span>
<span id="cb89-1136"><a href="#cb89-1136" aria-hidden="true" tabindex="-1"></a><span class="at">^ 2</span></span>
<span id="cb89-1137"><a href="#cb89-1137" aria-hidden="true" tabindex="-1"></a><span class="at">$$</span></span>
<span id="cb89-1138"><a href="#cb89-1138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1139"><a href="#cb89-1139" aria-hidden="true" tabindex="-1"></a><span class="at">with $</span><span class="sc">\e</span><span class="at">psilon = y - Z \gamma - </span><span class="sc">\r</span><span class="at">ho_y Wy$. </span></span>
<span id="cb89-1140"><a href="#cb89-1140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1141"><a href="#cb89-1141" aria-hidden="true" tabindex="-1"></a><span class="at">&lt;!-- The log likelihood function can be concentrated on $</span><span class="sc">\b</span><span class="at">eta$ and $\sigma --&gt;</span></span>
<span id="cb89-1142"><a href="#cb89-1142" aria-hidden="true" tabindex="-1"></a><span class="at">&lt;!-- ^ 2$ so that it can be expressed as a function of one parameter --&gt;</span></span>
<span id="cb89-1143"><a href="#cb89-1143" aria-hidden="true" tabindex="-1"></a><span class="at">&lt;!-- ($\lambda$ for the **SAR** model and $</span><span class="sc">\r</span><span class="at">ho$ for the **SEM** model). --&gt;</span></span>
<span id="cb89-1144"><a href="#cb89-1144" aria-hidden="true" tabindex="-1"></a><span class="at">\index[general]{spatial autoregressive model|)}</span></span>
<span id="cb89-1145"><a href="#cb89-1145" aria-hidden="true" tabindex="-1"></a><span class="at">These two models can be augmented by spatial lags of the covariates, they are in this case called Durbin's models. There is an inserting relationship between Durbin's SAR model and the SEM model. The former can be written:</span></span>
<span id="cb89-1146"><a href="#cb89-1146" aria-hidden="true" tabindex="-1"></a><span class="at">\index[general]{Durbin's model|(}</span></span>
<span id="cb89-1147"><a href="#cb89-1147" aria-hidden="true" tabindex="-1"></a><span class="at">\index[general]{spatial autoregressive model!Durbin|(}</span></span>
<span id="cb89-1148"><a href="#cb89-1148" aria-hidden="true" tabindex="-1"></a><span class="at">\index[general]{spatial error model!Durbin|(}</span></span>
<span id="cb89-1149"><a href="#cb89-1149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1150"><a href="#cb89-1150" aria-hidden="true" tabindex="-1"></a><span class="at">$$</span></span>
<span id="cb89-1151"><a href="#cb89-1151" aria-hidden="true" tabindex="-1"></a><span class="at">y = </span><span class="sc">\r</span><span class="at">ho_y W y + Z\gamma +   W Z</span><span class="sc">\t</span><span class="at">heta + </span><span class="sc">\e</span><span class="at">psilon</span></span>
<span id="cb89-1152"><a href="#cb89-1152" aria-hidden="true" tabindex="-1"></a><span class="at">$$</span></span>
<span id="cb89-1153"><a href="#cb89-1153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1154"><a href="#cb89-1154" aria-hidden="true" tabindex="-1"></a><span class="at">with $</span><span class="sc">\e</span><span class="at">psilon$ iid errors. The **common factor** hypothesis is that $</span><span class="sc">\t</span><span class="at">heta = - </span><span class="sc">\r</span><span class="at">ho_y \gamma$. In this case, we have:</span></span>
<span id="cb89-1155"><a href="#cb89-1155" aria-hidden="true" tabindex="-1"></a><span class="at">\index[general]{common factor hypothesis}</span></span>
<span id="cb89-1156"><a href="#cb89-1156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1157"><a href="#cb89-1157" aria-hidden="true" tabindex="-1"></a><span class="at">$$</span></span>
<span id="cb89-1158"><a href="#cb89-1158" aria-hidden="true" tabindex="-1"></a><span class="at">(I - </span><span class="sc">\r</span><span class="at">ho_y W) y =  (I - </span><span class="sc">\r</span><span class="at">ho_y W) Z\gamma + </span><span class="sc">\e</span><span class="at">psilon</span></span>
<span id="cb89-1159"><a href="#cb89-1159" aria-hidden="true" tabindex="-1"></a><span class="at">$$</span></span>
<span id="cb89-1160"><a href="#cb89-1160" aria-hidden="true" tabindex="-1"></a><span class="at">Or finally:</span></span>
<span id="cb89-1161"><a href="#cb89-1161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1162"><a href="#cb89-1162" aria-hidden="true" tabindex="-1"></a><span class="at">$$</span></span>
<span id="cb89-1163"><a href="#cb89-1163" aria-hidden="true" tabindex="-1"></a><span class="at">y =  Z\gamma + (I - </span><span class="sc">\r</span><span class="at">ho_y W) ^{-1} </span><span class="sc">\e</span><span class="at">psilon</span></span>
<span id="cb89-1164"><a href="#cb89-1164" aria-hidden="true" tabindex="-1"></a><span class="at">$$</span></span>
<span id="cb89-1165"><a href="#cb89-1165" aria-hidden="true" tabindex="-1"></a><span class="at">which is the SEM model, as denoting $</span><span class="sc">\e</span><span class="at">ta = (I -</span><span class="sc">\r</span><span class="at">ho_y W) ^ {-1} </span><span class="sc">\e</span><span class="at">psilon$ the errors of this model, we have $y = Z\gamma + </span><span class="sc">\e</span><span class="at">ta$, with $</span><span class="sc">\e</span><span class="at">ta = </span><span class="sc">\r</span><span class="at">ho_y W </span><span class="sc">\e</span><span class="at">ta + </span><span class="sc">\e</span><span class="at">psilon$. </span></span>
<span id="cb89-1166"><a href="#cb89-1166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1167"><a href="#cb89-1167" aria-hidden="true" tabindex="-1"></a><span class="at">Once it has been established that there is some spatial dependence, one has to choose the "right" specification. Several tests have been proposed, based on the three test principles. Lagrange multiplier tests proposed by @ANSE:BERA:FLOR:YOON:96\index[author]{Anselin}\index[author]{Bera}\index[author]{Florax}\index[author]{Yoon} are popular, as they only require the OLS estimation. Different flavors of tests have been proposed, testing $</span><span class="sc">\r</span><span class="at">ho_y = 0$, $</span><span class="sc">\r</span><span class="at">ho_</span><span class="sc">\e</span><span class="at">psilon = 0$ or $</span><span class="sc">\r</span><span class="at">ho_y = </span><span class="sc">\r</span><span class="at">ho_</span><span class="sc">\e</span><span class="at">psilon = 0$. The basic version of, for example the first test ($\mbox{H}_{0}: </span><span class="sc">\r</span><span class="at">ho_y = 0$) has, as a maintained hypothesis that $</span><span class="sc">\r</span><span class="at">ho_</span><span class="sc">\e</span><span class="at">psilon = 0$. A robust version of the test has been proposed which doesn't impose this maintained hypothesis. The common factor hypothesis can easily be tested using a likelihood ratio test. The Wald statistic is less easy to compute, as a set of non-linear hypotheses $</span><span class="sc">\t</span><span class="at">heta = - </span><span class="sc">\r</span><span class="at">ho_y </span><span class="sc">\b</span><span class="at">eta$ should be tested.</span></span>
<span id="cb89-1168"><a href="#cb89-1168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1169"><a href="#cb89-1169" aria-hidden="true" tabindex="-1"></a><span class="at">\index[general]{Durbin's model|)}</span></span>
<span id="cb89-1170"><a href="#cb89-1170" aria-hidden="true" tabindex="-1"></a><span class="at">\index[general]{spatial autoregressive model!Durbin|)}</span></span>
<span id="cb89-1171"><a href="#cb89-1171" aria-hidden="true" tabindex="-1"></a><span class="at">\index[general]{spatial error model!Durbin|)}</span></span>
<span id="cb89-1172"><a href="#cb89-1172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1173"><a href="#cb89-1173" aria-hidden="true" tabindex="-1"></a><span class="at">### Application to the growth model</span></span>
<span id="cb89-1174"><a href="#cb89-1174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1175"><a href="#cb89-1175" aria-hidden="true" tabindex="-1"></a><span class="at">To overcome the irrelevant empirical results of the standard Solow model, @ERTU:KOCH:07\index[author]{Ertur}\index[author]{Koch} consider an endogenous growth model with spillovers. The production function is as usual a Cobb-Douglas:</span></span>
<span id="cb89-1176"><a href="#cb89-1176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1177"><a href="#cb89-1177" aria-hidden="true" tabindex="-1"></a><span class="at">$$</span></span>
<span id="cb89-1178"><a href="#cb89-1178" aria-hidden="true" tabindex="-1"></a><span class="at">Y_n(t) = A_n(t) K_n ^ \kappa(t) L_n ^ {1 -\kappa}(t)</span></span>
<span id="cb89-1179"><a href="#cb89-1179" aria-hidden="true" tabindex="-1"></a><span class="at">$$</span></span>
<span id="cb89-1180"><a href="#cb89-1180" aria-hidden="true" tabindex="-1"></a><span class="at">$\kappa$ being the elasticity of the production with the capital and also the share of the profits in the national product. The level of technology is given by:</span></span>
<span id="cb89-1181"><a href="#cb89-1181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1182"><a href="#cb89-1182" aria-hidden="true" tabindex="-1"></a><span class="at">$$</span></span>
<span id="cb89-1183"><a href="#cb89-1183" aria-hidden="true" tabindex="-1"></a><span class="at">A_n(t) = \Omega(0) e ^ {\mu t} k_n ^ \phi(t) \prod_{m </span><span class="sc">\n</span><span class="at">eq n} ^ N A_n^{\gamma w_{nm}}(t)</span></span>
<span id="cb89-1184"><a href="#cb89-1184" aria-hidden="true" tabindex="-1"></a><span class="at">$$</span></span>
<span id="cb89-1185"><a href="#cb89-1185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1186"><a href="#cb89-1186" aria-hidden="true" tabindex="-1"></a><span class="at">where $k_n(t) = K_n(t) / L_n(t)$ is the physical capital per worker, $\Omega(0)$ is the initial level of the technology and $\mu$ is a constant rate of technological growth, as in the Solow model. The next term takes into account the spillover effect of domestic investment, following @ROME:86\index[author]{Romer}, and the strength of this spillover effect is measured by $\phi$. The last term is specific to the model of @ERTU:KOCH:07\index[author]{Ertur}\index[author]{Koch}, for which the spillovers are not restricted to domestic investment, but concerns also the technology of neighboring countries. The effect of the technology of country $m$ on the technology of country $n$ is the product of a constant parameter $\gamma$ and a specific weight, $w_{nm}$, which is a decreasing function of the distance between both countries.</span></span>
<span id="cb89-1187"><a href="#cb89-1187" aria-hidden="true" tabindex="-1"></a><span class="at">@ERTU:KOCH:07\index[author]{Ertur}\index[author]{Koch} showed (equation 10, page 1038) that, at the steady state, the output per capita is:</span></span>
<span id="cb89-1188"><a href="#cb89-1188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1189"><a href="#cb89-1189" aria-hidden="true" tabindex="-1"></a><span class="at">$$</span></span>
<span id="cb89-1190"><a href="#cb89-1190" aria-hidden="true" tabindex="-1"></a><span class="sc">\b</span><span class="at">egin{array}{rcl}</span></span>
<span id="cb89-1191"><a href="#cb89-1191" aria-hidden="true" tabindex="-1"></a><span class="at">\ln y_n ^ * &amp;=&amp; </span><span class="sc">\f</span><span class="at">rac{1}{1 - \kappa - \phi} \ln \Omega + </span></span>
<span id="cb89-1192"><a href="#cb89-1192" aria-hidden="true" tabindex="-1"></a><span class="sc">\f</span><span class="at">rac{\kappa + \phi}{1 - \kappa - \phi} \ln i_n -</span></span>
<span id="cb89-1193"><a href="#cb89-1193" aria-hidden="true" tabindex="-1"></a><span class="sc">\f</span><span class="at">rac{\kappa + \phi}{1 - \kappa - \phi} \ln v_n </span><span class="sc">\\</span></span>
<span id="cb89-1194"><a href="#cb89-1194" aria-hidden="true" tabindex="-1"></a><span class="at">&amp;-&amp; </span><span class="sc">\f</span><span class="at">rac{\gamma\kappa}{1 - \kappa - \phi} \sum_{m</span><span class="sc">\n</span><span class="at">eq n}^ N w_{nm} \ln i_m + </span><span class="sc">\f</span><span class="at">rac{\gamma\kappa}{1 - \kappa - \phi} \sum_{m</span><span class="sc">\n</span><span class="at">eq n}^ N w_{nm} \ln v_n </span><span class="sc">\\</span></span>
<span id="cb89-1195"><a href="#cb89-1195" aria-hidden="true" tabindex="-1"></a><span class="at">&amp;+&amp; </span><span class="sc">\f</span><span class="at">rac{\gamma(1 - \kappa)}{1 - \kappa - \phi} \sum_{m</span><span class="sc">\n</span><span class="at">eq n}^ N w_{nm} \ln y_m ^ *</span></span>
<span id="cb89-1196"><a href="#cb89-1196" aria-hidden="true" tabindex="-1"></a><span class="sc">\e</span><span class="at">nd{array}</span></span>
<span id="cb89-1197"><a href="#cb89-1197" aria-hidden="true" tabindex="-1"></a><span class="at">$$</span></span>
<span id="cb89-1198"><a href="#cb89-1198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1199"><a href="#cb89-1199" aria-hidden="true" tabindex="-1"></a><span class="at">In matrix form, denoting $y = \ln y^*$, $X = (\ln i \ln v)$, $</span><span class="sc">\b</span><span class="at">eta = \left(</span><span class="sc">\b</span><span class="at">egin{array}{c} (\kappa + \phi) / (1 - \kappa - \phi)</span><span class="sc">\\</span><span class="at"> - (\kappa + \phi) / (1 - \kappa - \phi)</span><span class="sc">\e</span><span class="at">nd{array}</span><span class="sc">\r</span><span class="at">ight)$, $</span><span class="sc">\t</span><span class="at">heta = \left(</span><span class="sc">\b</span><span class="at">egin{array}{c} \gamma \kappa / (1 - \kappa - \phi)</span><span class="sc">\\</span><span class="at"> - \gamma  \kappa  / (1 - \kappa - \phi)</span><span class="sc">\e</span><span class="at">nd{array}</span><span class="sc">\r</span><span class="at">ight)$ and $</span><span class="sc">\r</span><span class="at">ho_y = \gamma (1 - \kappa) / (1 - \kappa - \phi)$, the model can be written as:</span></span>
<span id="cb89-1200"><a href="#cb89-1200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1201"><a href="#cb89-1201" aria-hidden="true" tabindex="-1"></a><span class="at">$$</span></span>
<span id="cb89-1202"><a href="#cb89-1202" aria-hidden="true" tabindex="-1"></a><span class="at">y = </span><span class="sc">\a</span><span class="at">lpha i + X </span><span class="sc">\b</span><span class="at">eta + WX </span><span class="sc">\t</span><span class="at">heta + </span><span class="sc">\r</span><span class="at">ho_y Wy + </span><span class="sc">\e</span><span class="at">psilon</span></span>
<span id="cb89-1203"><a href="#cb89-1203" aria-hidden="true" tabindex="-1"></a><span class="at">$$</span></span>
<span id="cb89-1204"><a href="#cb89-1204" aria-hidden="true" tabindex="-1"></a><span class="at">\idxdata[(]{sp\_solow}{necountries}</span></span>
<span id="cb89-1205"><a href="#cb89-1205" aria-hidden="true" tabindex="-1"></a><span class="at">if $\gamma = 0$, the model reduces to the model of @ROME:86\index[author]{Romer} and the last two terms disappear. Note that in this case $\kappa$ and $\phi$ are not identified, but only their sum. Moreover, if $\phi$ is also 0, we get the Solow model. Whether $\phi$ equals zero or not, the resulting model is a standard linear model already estimated in @sec-solow_model:</span></span>
<span id="cb89-1206"><a href="#cb89-1206" aria-hidden="true" tabindex="-1"></a><span class="at">\idxfun{lm}{stats}</span></span>
<span id="cb89-1207"><a href="#cb89-1207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1210"><a href="#cb89-1210" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb89-1211"><a href="#cb89-1211" aria-hidden="true" tabindex="-1"></a>ols_solow <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">log</span>(gdp95) <span class="sc">~</span> <span class="fu">log</span>(i) <span class="sc">+</span> <span class="fu">log</span>(v), sp_solow2)</span>
<span id="cb89-1212"><a href="#cb89-1212" aria-hidden="true" tabindex="-1"></a><span class="st">```</span></span>
<span id="cb89-1213"><a href="#cb89-1213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1214"><a href="#cb89-1214" aria-hidden="true" tabindex="-1"></a><span class="at">Moreover, imposing the theoretical constraint of the growth model, we must have the sum of the two coefficients of </span><span class="st">`</span><span class="fu">log</span>(i)<span class="st">`</span><span class="at"> and </span><span class="st">`</span><span class="fu">log</span>(v)<span class="st">`</span><span class="at"> equal to 0. Therefore, the constrained model can be estimated using the difference of the logarithms of the two covariates as the unique regressor. For convenience, we call the ratio of the two covariates </span><span class="st">`</span>i<span class="st">`</span><span class="at"> and we store it in a new data frame called </span><span class="st">`</span>sp_solow3<span class="st">`</span><span class="at">. The constrained OLS model can then be estimated:</span></span>
<span id="cb89-1215"><a href="#cb89-1215" aria-hidden="true" tabindex="-1"></a><span class="at">\idxfun{mutate}{dplyr}\idxfun{lm}{stats}</span></span>
<span id="cb89-1216"><a href="#cb89-1216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1219"><a href="#cb89-1219" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb89-1220"><a href="#cb89-1220" aria-hidden="true" tabindex="-1"></a>sp_solow3 <span class="ot">&lt;-</span> sp_solow2 <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">i =</span> i <span class="sc">/</span> v)</span>
<span id="cb89-1221"><a href="#cb89-1221" aria-hidden="true" tabindex="-1"></a>ols_solowc <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">log</span>(gdp95) <span class="sc">~</span> <span class="fu">log</span>(i), sp_solow3)</span>
<span id="cb89-1222"><a href="#cb89-1222" aria-hidden="true" tabindex="-1"></a><span class="st">```</span></span>
<span id="cb89-1223"><a href="#cb89-1223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1224"><a href="#cb89-1224" aria-hidden="true" tabindex="-1"></a><span class="at">The hypothesis of $\gamma = 0$ can be tested using Lagrange multipliers tests, testing either the alternative that there is a spatial lag or correlated errors. </span><span class="st">`</span>spdep<span class="sc">::</span>lm.LMtests<span class="st">`</span><span class="at"> provides different flavors of these tests. Its two main arguments are a </span><span class="st">`</span>lm<span class="st">`</span><span class="at"> model and a matrix of spatial weights. The </span><span class="st">`</span>test<span class="st">`</span><span class="at"> argument can be either </span><span class="st">`"LMerr"`</span><span class="at"> and "</span><span class="st">`</span>LMlag<span class="st">`</span><span class="at">" for the standard tests of uncorrelated errors and absence of spatial lag, </span><span class="st">`"RLMerr"`</span><span class="at"> and </span><span class="st">`"RLMlag"`</span><span class="at"> for the robust versions of these two tests and </span><span class="st">`"SARMA"`</span><span class="at">, suitable when the alternative hypothesis is the presence of both correlation of the errors and a spatial lag. </span><span class="st">`</span>test <span class="ot">=</span> <span class="st">"all"`</span><span class="at"> enables to perform the five tests:</span></span>
<span id="cb89-1225"><a href="#cb89-1225" aria-hidden="true" tabindex="-1"></a><span class="at">\idxfun{lm.LMtests}{spdep}\idxfun{gaze}{micsr}</span></span>
<span id="cb89-1226"><a href="#cb89-1226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1229"><a href="#cb89-1229" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb89-1230"><a href="#cb89-1230" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: true</span></span>
<span id="cb89-1231"><a href="#cb89-1231" aria-hidden="true" tabindex="-1"></a><span class="fu">lm.LMtests</span>(ols_solow, W1, <span class="at">test =</span> <span class="st">"all"</span>) <span class="sc">%&gt;%</span> gaze</span>
<span id="cb89-1232"><a href="#cb89-1232" aria-hidden="true" tabindex="-1"></a><span class="st">```</span></span>
<span id="cb89-1233"><a href="#cb89-1233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1234"><a href="#cb89-1234" aria-hidden="true" tabindex="-1"></a><span class="at">All the tests reject the hypothesis of uncorrelated errors or/and spatial lag, except the robust test of uncorrelated errors. Therefore, these tests seem to indicate that the correct model is a spatial lag model. We then estimate the three spatial models using the **spatialreg** package [@PEBE:BIVA:23]\index[author]{Pebesma}\index[author]{Bivand} which provides three functions: </span><span class="st">`</span>lagsarlm<span class="st">`</span><span class="at"> for SAR models, </span><span class="st">`</span>sacsarlm<span class="st">`</span><span class="at"> for SEM model and </span><span class="st">`</span>errorsarlm<span class="st">`</span><span class="at"> for SAR-SEM models. The three first arguments are </span><span class="st">`</span>formula<span class="st">`</span><span class="at">, </span><span class="st">`</span>data<span class="st">`</span><span class="at"> and </span><span class="st">`</span>listw<span class="st">`</span><span class="at">, which should be a </span><span class="st">`</span>listw<span class="st">`</span><span class="at"> object containing the weights. The </span><span class="st">`</span>Durbin<span class="st">`</span><span class="at"> argument enables to estimate Durbin's versions of the model; this can be done either by setting it to </span><span class="st">`</span>TRUE<span class="st">`</span><span class="at"> (a spatial lag is then added for all the covariates) or a formula indicating the subset of covariates for which spatial lags have to be added. We estimate also, as for the OLS estimator, the variant of the model that imposes the theoretical restrictions on the coefficients. The results are presented in @tbl-results_ertu_koch.</span></span>
<span id="cb89-1235"><a href="#cb89-1235" aria-hidden="true" tabindex="-1"></a><span class="at">\idxfun{lagsarlm}{spatialreg}\idxfun{errorsarlm}{spatialreg}\idxfun{sacsarlm}{spatialreg}\idxfun{update}{stats}</span></span>
<span id="cb89-1236"><a href="#cb89-1236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1239"><a href="#cb89-1239" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb89-1240"><a href="#cb89-1240" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(spatialreg)</span>
<span id="cb89-1241"><a href="#cb89-1241" aria-hidden="true" tabindex="-1"></a>m1 <span class="ot">&lt;-</span> <span class="fu">lagsarlm</span>(<span class="fu">log</span>(gdp95) <span class="sc">~</span> <span class="fu">log</span>(i) <span class="sc">+</span> <span class="fu">log</span>(v), </span>
<span id="cb89-1242"><a href="#cb89-1242" aria-hidden="true" tabindex="-1"></a>               sp_solow2, W1, <span class="at">Durbin =</span> <span class="cn">TRUE</span>)</span>
<span id="cb89-1243"><a href="#cb89-1243" aria-hidden="true" tabindex="-1"></a>m2 <span class="ot">&lt;-</span> <span class="fu">errorsarlm</span>(<span class="fu">log</span>(gdp95) <span class="sc">~</span> <span class="fu">log</span>(i) <span class="sc">+</span> <span class="fu">log</span>(v), </span>
<span id="cb89-1244"><a href="#cb89-1244" aria-hidden="true" tabindex="-1"></a>                 sp_solow2, W1, <span class="at">Durbin =</span> <span class="cn">FALSE</span>)</span>
<span id="cb89-1245"><a href="#cb89-1245" aria-hidden="true" tabindex="-1"></a>m3 <span class="ot">&lt;-</span> <span class="fu">sacsarlm</span>(<span class="fu">log</span>(gdp95) <span class="sc">~</span> <span class="fu">log</span>(i) <span class="sc">+</span> <span class="fu">log</span>(v), </span>
<span id="cb89-1246"><a href="#cb89-1246" aria-hidden="true" tabindex="-1"></a>               sp_solow2, W1, <span class="at">Durbin =</span> <span class="cn">TRUE</span>)</span>
<span id="cb89-1247"><a href="#cb89-1247" aria-hidden="true" tabindex="-1"></a>m1c <span class="ot">&lt;-</span> <span class="fu">update</span>(m1, . <span class="sc">~</span> . <span class="sc">-</span> <span class="fu">log</span>(v), <span class="at">data =</span> sp_solow3)</span>
<span id="cb89-1248"><a href="#cb89-1248" aria-hidden="true" tabindex="-1"></a>m2c <span class="ot">&lt;-</span> <span class="fu">update</span>(m2, . <span class="sc">~</span> . <span class="sc">-</span> <span class="fu">log</span>(v), <span class="at">data =</span> sp_solow3)</span>
<span id="cb89-1249"><a href="#cb89-1249" aria-hidden="true" tabindex="-1"></a>m3c <span class="ot">&lt;-</span> <span class="fu">update</span>(m3, . <span class="sc">~</span> . <span class="sc">-</span> <span class="fu">log</span>(v), <span class="at">data =</span> sp_solow3)</span>
<span id="cb89-1250"><a href="#cb89-1250" aria-hidden="true" tabindex="-1"></a><span class="st">```</span></span>
<span id="cb89-1251"><a href="#cb89-1251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1252"><a href="#cb89-1252" aria-hidden="true" tabindex="-1"></a><span class="at">We can first test the theoretical restrictions using either a likelihood ratio or a Wald test:</span></span>
<span id="cb89-1253"><a href="#cb89-1253" aria-hidden="true" tabindex="-1"></a><span class="at">\idxfun{linearHypothesis}{car}\idxfun{lrtest}{lmtest}\idxfun{gaze}{micsr}</span></span>
<span id="cb89-1254"><a href="#cb89-1254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1257"><a href="#cb89-1257" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb89-1258"><a href="#cb89-1258" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: true</span></span>
<span id="cb89-1259"><a href="#cb89-1259" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lmtest)</span>
<span id="cb89-1260"><a href="#cb89-1260" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(car)</span>
<span id="cb89-1261"><a href="#cb89-1261" aria-hidden="true" tabindex="-1"></a><span class="fu">linearHypothesis</span>(ols_solow, <span class="st">"log(i) + log(v) = 0"</span>, </span>
<span id="cb89-1262"><a href="#cb89-1262" aria-hidden="true" tabindex="-1"></a>                 <span class="at">test =</span> <span class="st">"Chisq"</span>) <span class="sc">%&gt;%</span> gaze</span>
<span id="cb89-1263"><a href="#cb89-1263" aria-hidden="true" tabindex="-1"></a><span class="fu">lrtest</span>(ols_solow, ols_solowc) <span class="sc">%&gt;%</span> gaze</span>
<span id="cb89-1264"><a href="#cb89-1264" aria-hidden="true" tabindex="-1"></a><span class="fu">linearHypothesis</span>(m1, <span class="fu">c</span>(<span class="st">"log(i) + log(v) = 0"</span>, </span>
<span id="cb89-1265"><a href="#cb89-1265" aria-hidden="true" tabindex="-1"></a>                       <span class="st">"lag.log(i) + lag.log(v) = 0"</span>)) <span class="sc">%&gt;%</span> gaze</span>
<span id="cb89-1266"><a href="#cb89-1266" aria-hidden="true" tabindex="-1"></a><span class="fu">lrtest</span>(m1, m1c) <span class="sc">%&gt;%</span> gaze</span>
<span id="cb89-1267"><a href="#cb89-1267" aria-hidden="true" tabindex="-1"></a><span class="st">```</span></span>
<span id="cb89-1268"><a href="#cb89-1268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1269"><a href="#cb89-1269" aria-hidden="true" tabindex="-1"></a><span class="at">As seen previously, the theoretical restrictions are rejected at the 5% level using a Wald test for the Solow model. This is not the case for the spatial lag model. Note also that the Wald and the likelihood ratio tests give very similar results.</span></span>
<span id="cb89-1270"><a href="#cb89-1270" aria-hidden="true" tabindex="-1"></a><span class="at">An interesting feature of the model of @ERTU:KOCH:07\index[author]{Ertur}\index[author]{Koch} is that their specification enables the identification of all the structural parameters of the model, $\kappa$, $\phi$ and $\gamma$. If $\phi = 0$, $</span><span class="sc">\t</span><span class="at">heta = \gamma </span><span class="sc">\b</span><span class="at">eta$ and $</span><span class="sc">\r</span><span class="at">ho_y = \gamma$, so that: $y = </span><span class="sc">\a</span><span class="at">lpha j+ (I - \gamma W)X</span><span class="sc">\b</span><span class="at">eta + \gamma y + </span><span class="sc">\e</span><span class="at">psilon$, the reduced form of the model is, in matrix form:</span></span>
<span id="cb89-1271"><a href="#cb89-1271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1272"><a href="#cb89-1272" aria-hidden="true" tabindex="-1"></a><span class="at">$$</span></span>
<span id="cb89-1273"><a href="#cb89-1273" aria-hidden="true" tabindex="-1"></a><span class="at">y = </span><span class="sc">\a</span><span class="at">lpha j + X </span><span class="sc">\b</span><span class="at">eta + (I - \gamma W) ^ {-1} </span><span class="sc">\e</span><span class="at">psilon</span></span>
<span id="cb89-1274"><a href="#cb89-1274" aria-hidden="true" tabindex="-1"></a><span class="at">$$</span></span>
<span id="cb89-1275"><a href="#cb89-1275" aria-hidden="true" tabindex="-1"></a><span class="at">which is a SEM model without Durbin terms. Therefore, the hypothesis that $\phi = 0$ is in the context of this model the hypothesis of common factors and can easily be tested using a likelihood ratio test:</span></span>
<span id="cb89-1276"><a href="#cb89-1276" aria-hidden="true" tabindex="-1"></a><span class="at">\idxfun{lrtest}{lmtest}\idxfun{gaze}{micsr}</span></span>
<span id="cb89-1277"><a href="#cb89-1277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1280"><a href="#cb89-1280" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb89-1281"><a href="#cb89-1281" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: true</span></span>
<span id="cb89-1282"><a href="#cb89-1282" aria-hidden="true" tabindex="-1"></a><span class="fu">lrtest</span>(m1c, m2c) <span class="sc">%&gt;%</span> gaze</span>
<span id="cb89-1283"><a href="#cb89-1283" aria-hidden="true" tabindex="-1"></a><span class="st">```</span></span>
<span id="cb89-1284"><a href="#cb89-1284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1285"><a href="#cb89-1285" aria-hidden="true" tabindex="-1"></a><span class="at">The hypothesis of common factor is rejected at the 1% level.</span></span>
<span id="cb89-1286"><a href="#cb89-1286" aria-hidden="true" tabindex="-1"></a><span class="at">Our preferred specification is therefore a spatial lag model imposing the theoretical restrictions. </span></span>
<span id="cb89-1287"><a href="#cb89-1287" aria-hidden="true" tabindex="-1"></a><span class="at">The structural parameters of the model ($s$) can be computed using the fitted reduced form parameters ($r$). The relation between $r$ and $s$ is:</span></span>
<span id="cb89-1288"><a href="#cb89-1288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1291"><a href="#cb89-1291" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb89-1292"><a href="#cb89-1292" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb89-1293"><a href="#cb89-1293" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-results_ertu_koch</span></span>
<span id="cb89-1294"><a href="#cb89-1294" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Results of the growth models"</span></span>
<span id="cb89-1295"><a href="#cb89-1295" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(modelsummary)</span>
<span id="cb89-1296"><a href="#cb89-1296" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">modelsummary_get =</span> <span class="st">"broom"</span>)</span>
<span id="cb89-1297"><a href="#cb89-1297" aria-hidden="true" tabindex="-1"></a><span class="fu">modelsummary</span>(<span class="fu">list</span>(<span class="at">OLS =</span> ols_solow, <span class="at">SAR =</span> m1, <span class="at">SEM =</span> m2, <span class="at">SARMA =</span> m3, <span class="at">OLSc =</span> ols_solowc, <span class="at">SARc =</span> m1c, <span class="at">SEMc =</span> m2c),</span>
<span id="cb89-1298"><a href="#cb89-1298" aria-hidden="true" tabindex="-1"></a>             <span class="at">coef_omit =</span> <span class="st">"Intercept"</span>,</span>
<span id="cb89-1299"><a href="#cb89-1299" aria-hidden="true" tabindex="-1"></a>             <span class="at">coef_map =</span> <span class="fu">c</span>(<span class="st">"log(i)"</span> <span class="ot">=</span> <span class="st">"$</span><span class="sc">\\</span><span class="st">ln i$"</span>, </span>
<span id="cb89-1300"><a href="#cb89-1300" aria-hidden="true" tabindex="-1"></a>                          <span class="st">"log(v)"</span> <span class="ot">=</span> <span class="st">"$</span><span class="sc">\\</span><span class="st">ln v$"</span>, </span>
<span id="cb89-1301"><a href="#cb89-1301" aria-hidden="true" tabindex="-1"></a>                          <span class="st">"lag.log(i)"</span> <span class="ot">=</span> <span class="st">"$W </span><span class="sc">\\</span><span class="st">ln i$"</span>, </span>
<span id="cb89-1302"><a href="#cb89-1302" aria-hidden="true" tabindex="-1"></a>                          <span class="st">"lag.log(v)"</span> <span class="ot">=</span> <span class="st">"$W</span><span class="sc">\\</span><span class="st">ln v$"</span>, </span>
<span id="cb89-1303"><a href="#cb89-1303" aria-hidden="true" tabindex="-1"></a>                          <span class="at">rho =</span> <span class="st">"$</span><span class="sc">\\</span><span class="st">rho_y$"</span>, </span>
<span id="cb89-1304"><a href="#cb89-1304" aria-hidden="true" tabindex="-1"></a>                          <span class="at">lambda =</span> <span class="st">"$</span><span class="sc">\\</span><span class="st">rho_</span><span class="sc">\\</span><span class="st">epsilon$"</span>),</span>
<span id="cb89-1305"><a href="#cb89-1305" aria-hidden="true" tabindex="-1"></a>             <span class="at">gof_omit =</span> <span class="st">"R2|AIC|BIC"</span>,</span>
<span id="cb89-1306"><a href="#cb89-1306" aria-hidden="true" tabindex="-1"></a>             <span class="at">escape =</span> <span class="cn">FALSE</span>,</span>
<span id="cb89-1307"><a href="#cb89-1307" aria-hidden="true" tabindex="-1"></a>             <span class="at">output =</span> <span class="st">"kableExtra"</span>)</span>
<span id="cb89-1308"><a href="#cb89-1308" aria-hidden="true" tabindex="-1"></a><span class="st">```</span></span>
<span id="cb89-1309"><a href="#cb89-1309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1310"><a href="#cb89-1310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1311"><a href="#cb89-1311" aria-hidden="true" tabindex="-1"></a><span class="at">$$</span></span>
<span id="cb89-1312"><a href="#cb89-1312" aria-hidden="true" tabindex="-1"></a><span class="at">r ^ </span><span class="sc">\t</span><span class="at">op = (</span><span class="sc">\b</span><span class="at">eta, </span><span class="sc">\t</span><span class="at">heta, </span><span class="sc">\r</span><span class="at">ho) =</span></span>
<span id="cb89-1313"><a href="#cb89-1313" aria-hidden="true" tabindex="-1"></a><span class="at">\left(</span><span class="sc">\f</span><span class="at">rac{\kappa + \phi}{1 - \kappa - \phi}, - \gamma </span><span class="sc">\f</span><span class="at">rac{\kappa}{1 - \kappa - \phi}, \gamma </span><span class="sc">\f</span><span class="at">rac{1 - \kappa}{1 - \kappa - \phi}</span><span class="sc">\r</span><span class="at">ight)</span></span>
<span id="cb89-1314"><a href="#cb89-1314" aria-hidden="true" tabindex="-1"></a><span class="at">$$</span></span>
<span id="cb89-1315"><a href="#cb89-1315" aria-hidden="true" tabindex="-1"></a><span class="at">Inversing this relation, we get the structural parameters $s$ as a function of the reduced form parameters:</span></span>
<span id="cb89-1316"><a href="#cb89-1316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1317"><a href="#cb89-1317" aria-hidden="true" tabindex="-1"></a><span class="at">$$</span></span>
<span id="cb89-1318"><a href="#cb89-1318" aria-hidden="true" tabindex="-1"></a><span class="at">s ^ </span><span class="sc">\t</span><span class="at">op = (\kappa, \phi, \gamma) = \left(</span><span class="sc">\f</span><span class="at">rac{</span><span class="sc">\t</span><span class="at">heta}{</span><span class="sc">\t</span><span class="at">heta - </span><span class="sc">\r</span><span class="at">ho}, </span><span class="sc">\f</span><span class="at">rac{</span><span class="sc">\b</span><span class="at">eta}{1 + </span><span class="sc">\b</span><span class="at">eta} - </span><span class="sc">\f</span><span class="at">rac{</span><span class="sc">\t</span><span class="at">heta}{</span><span class="sc">\t</span><span class="at">heta - </span><span class="sc">\r</span><span class="at">ho}, </span><span class="sc">\f</span><span class="at">rac{</span><span class="sc">\r</span><span class="at">ho - </span><span class="sc">\t</span><span class="at">heta}{1 + </span><span class="sc">\b</span><span class="at">eta}</span><span class="sc">\r</span><span class="at">ight)</span></span>
<span id="cb89-1319"><a href="#cb89-1319" aria-hidden="true" tabindex="-1"></a><span class="at">$$</span></span>
<span id="cb89-1320"><a href="#cb89-1320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1321"><a href="#cb89-1321" aria-hidden="true" tabindex="-1"></a><span class="at">For our model, we get:</span></span>
<span id="cb89-1322"><a href="#cb89-1322" aria-hidden="true" tabindex="-1"></a><span class="at">\idxfun{unname}{base}\idxfun{coef}{stats}</span></span>
<span id="cb89-1323"><a href="#cb89-1323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1326"><a href="#cb89-1326" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb89-1327"><a href="#cb89-1327" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: true</span></span>
<span id="cb89-1328"><a href="#cb89-1328" aria-hidden="true" tabindex="-1"></a>beta <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">coef</span>(m1c)[<span class="st">"log(i)"</span>])</span>
<span id="cb89-1329"><a href="#cb89-1329" aria-hidden="true" tabindex="-1"></a>theta <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">coef</span>(m1c)[<span class="st">"lag.log(i)"</span>])</span>
<span id="cb89-1330"><a href="#cb89-1330" aria-hidden="true" tabindex="-1"></a>rho <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">coef</span>(m1c)[<span class="st">"rho"</span>])</span>
<span id="cb89-1331"><a href="#cb89-1331" aria-hidden="true" tabindex="-1"></a>kappa <span class="ot">&lt;-</span> theta <span class="sc">/</span> (theta <span class="sc">-</span> rho)</span>
<span id="cb89-1332"><a href="#cb89-1332" aria-hidden="true" tabindex="-1"></a>phi <span class="ot">&lt;-</span> beta <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> beta) <span class="sc">-</span> theta <span class="sc">/</span> (theta <span class="sc">-</span> rho)</span>
<span id="cb89-1333"><a href="#cb89-1333" aria-hidden="true" tabindex="-1"></a>gamma <span class="ot">&lt;-</span> (rho <span class="sc">-</span> theta) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> beta)</span>
<span id="cb89-1334"><a href="#cb89-1334" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">kappa =</span> kappa, <span class="at">phi =</span> phi, <span class="at">gamma =</span> gamma)</span>
<span id="cb89-1335"><a href="#cb89-1335" aria-hidden="true" tabindex="-1"></a>s</span>
<span id="cb89-1336"><a href="#cb89-1336" aria-hidden="true" tabindex="-1"></a><span class="st">```</span></span>
<span id="cb89-1337"><a href="#cb89-1337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1338"><a href="#cb89-1338" aria-hidden="true" tabindex="-1"></a><span class="at">\index[general]{delta method|(}</span></span>
<span id="cb89-1339"><a href="#cb89-1339" aria-hidden="true" tabindex="-1"></a><span class="at">To apply the delta method, we compute the matrix of derivatives of $s$ with respect to $r$:</span></span>
<span id="cb89-1340"><a href="#cb89-1340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1341"><a href="#cb89-1341" aria-hidden="true" tabindex="-1"></a><span class="at">$$</span></span>
<span id="cb89-1342"><a href="#cb89-1342" aria-hidden="true" tabindex="-1"></a><span class="at">\Gamma(r) = </span><span class="sc">\f</span><span class="at">rac{\partial s}{\partial r ^ </span><span class="sc">\t</span><span class="at">op}(r)=</span></span>
<span id="cb89-1343"><a href="#cb89-1343" aria-hidden="true" tabindex="-1"></a><span class="at">\left(</span></span>
<span id="cb89-1344"><a href="#cb89-1344" aria-hidden="true" tabindex="-1"></a><span class="sc">\b</span><span class="at">egin{array}{rcl}</span></span>
<span id="cb89-1345"><a href="#cb89-1345" aria-hidden="true" tabindex="-1"></a><span class="at">0                                       &amp; - </span><span class="sc">\f</span><span class="at">rac{</span><span class="sc">\r</span><span class="at">ho}{(</span><span class="sc">\t</span><span class="at">heta - </span><span class="sc">\r</span><span class="at">ho) ^ 2} &amp; </span><span class="sc">\f</span><span class="at">rac{</span><span class="sc">\t</span><span class="at">heta}{(</span><span class="sc">\t</span><span class="at">heta - </span><span class="sc">\r</span><span class="at">ho) ^ 2} </span><span class="sc">\\</span></span>
<span id="cb89-1346"><a href="#cb89-1346" aria-hidden="true" tabindex="-1"></a><span class="sc">\f</span><span class="at">rac{1}{(1 + </span><span class="sc">\b</span><span class="at">eta) ^ 2}               &amp; </span><span class="sc">\f</span><span class="at">rac{</span><span class="sc">\r</span><span class="at">ho}{(</span><span class="sc">\t</span><span class="at">heta - </span><span class="sc">\r</span><span class="at">ho) ^ 2}   &amp; - </span><span class="sc">\f</span><span class="at">rac{</span><span class="sc">\t</span><span class="at">heta}{(</span><span class="sc">\t</span><span class="at">heta - </span><span class="sc">\r</span><span class="at">ho) ^ 2} </span><span class="sc">\\</span></span>
<span id="cb89-1347"><a href="#cb89-1347" aria-hidden="true" tabindex="-1"></a><span class="at">- </span><span class="sc">\f</span><span class="at">rac{</span><span class="sc">\t</span><span class="at">heta - </span><span class="sc">\r</span><span class="at">ho}{(1 + </span><span class="sc">\b</span><span class="at">eta) ^ 2} &amp; - </span><span class="sc">\f</span><span class="at">rac{1}{1 + </span><span class="sc">\b</span><span class="at">eta}                 &amp; </span><span class="sc">\f</span><span class="at">rac{1}{1 + </span><span class="sc">\b</span><span class="at">eta}</span></span>
<span id="cb89-1348"><a href="#cb89-1348" aria-hidden="true" tabindex="-1"></a><span class="sc">\e</span><span class="at">nd{array}</span></span>
<span id="cb89-1349"><a href="#cb89-1349" aria-hidden="true" tabindex="-1"></a><span class="sc">\r</span><span class="at">ight)</span></span>
<span id="cb89-1350"><a href="#cb89-1350" aria-hidden="true" tabindex="-1"></a><span class="at">$$</span></span>
<span id="cb89-1351"><a href="#cb89-1351" aria-hidden="true" tabindex="-1"></a><span class="at">and the asymptotic variance of $s$ is then:</span></span>
<span id="cb89-1352"><a href="#cb89-1352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1353"><a href="#cb89-1353" aria-hidden="true" tabindex="-1"></a><span class="at">$$</span></span>
<span id="cb89-1354"><a href="#cb89-1354" aria-hidden="true" tabindex="-1"></a><span class="at">\hat{V}(\hat{r}) = \Gamma(\hat{r}) \hat{V}(\hat{s})\Gamma(\hat{r}) ^ </span><span class="sc">\t</span><span class="at">op</span></span>
<span id="cb89-1355"><a href="#cb89-1355" aria-hidden="true" tabindex="-1"></a><span class="at">$$</span></span>
<span id="cb89-1356"><a href="#cb89-1356" aria-hidden="true" tabindex="-1"></a><span class="at">\idxfun{vcov}{stats}\idxfun{matrix}{base}</span></span>
<span id="cb89-1359"><a href="#cb89-1359" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb89-1360"><a href="#cb89-1360" aria-hidden="true" tabindex="-1"></a>Vr <span class="ot">&lt;-</span> <span class="fu">vcov</span>(m1c)[<span class="fu">c</span>(<span class="st">"log(i)"</span>, <span class="st">"lag.log(i)"</span>, <span class="st">"rho"</span>), </span>
<span id="cb89-1361"><a href="#cb89-1361" aria-hidden="true" tabindex="-1"></a>                <span class="fu">c</span>(<span class="st">"log(i)"</span>, <span class="st">"lag.log(i)"</span>, <span class="st">"rho"</span>)]</span>
<span id="cb89-1362"><a href="#cb89-1362" aria-hidden="true" tabindex="-1"></a>G <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, </span>
<span id="cb89-1363"><a href="#cb89-1363" aria-hidden="true" tabindex="-1"></a>       <span class="sc">-</span> rho <span class="sc">/</span> (theta <span class="sc">-</span> rho) <span class="sc">^</span> <span class="dv">2</span>, theta <span class="sc">/</span> (theta <span class="sc">-</span> rho) <span class="sc">^</span> <span class="dv">2</span>,</span>
<span id="cb89-1364"><a href="#cb89-1364" aria-hidden="true" tabindex="-1"></a>       <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> beta) <span class="sc">^</span> <span class="dv">2</span>, rho <span class="sc">/</span> (theta <span class="sc">-</span> rho) <span class="sc">^</span> <span class="dv">2</span>, </span>
<span id="cb89-1365"><a href="#cb89-1365" aria-hidden="true" tabindex="-1"></a>       <span class="sc">-</span> theta <span class="sc">/</span> (theta <span class="sc">-</span> rho) <span class="sc">^</span> <span class="dv">2</span>,</span>
<span id="cb89-1366"><a href="#cb89-1366" aria-hidden="true" tabindex="-1"></a>       (theta <span class="sc">-</span> rho) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> beta) <span class="sc">^</span> <span class="dv">2</span>, </span>
<span id="cb89-1367"><a href="#cb89-1367" aria-hidden="true" tabindex="-1"></a>       <span class="sc">-</span> <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> beta), <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> beta))</span>
<span id="cb89-1368"><a href="#cb89-1368" aria-hidden="true" tabindex="-1"></a>G <span class="ot">&lt;-</span> <span class="fu">matrix</span>(G, <span class="at">nrow =</span> <span class="dv">3</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb89-1369"><a href="#cb89-1369" aria-hidden="true" tabindex="-1"></a>V <span class="ot">&lt;-</span> G <span class="sc">%*%</span> Vr <span class="sc">%*%</span> <span class="fu">t</span>(G)</span>
<span id="cb89-1370"><a href="#cb89-1370" aria-hidden="true" tabindex="-1"></a><span class="st">```</span></span>
<span id="cb89-1371"><a href="#cb89-1371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1372"><a href="#cb89-1372" aria-hidden="true" tabindex="-1"></a><span class="at">We finally compute the table of the structural parameters:</span></span>
<span id="cb89-1373"><a href="#cb89-1373" aria-hidden="true" tabindex="-1"></a><span class="at">\idxfun{diag}{base}\idxfun{pnorm}{stats}\idxfun{cbind}{base}</span></span>
<span id="cb89-1374"><a href="#cb89-1374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1377"><a href="#cb89-1377" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb89-1378"><a href="#cb89-1378" aria-hidden="true" tabindex="-1"></a>stdev <span class="ot">&lt;-</span> V <span class="sc">%&gt;%</span> diag <span class="sc">%&gt;%</span> sqrt</span>
<span id="cb89-1379"><a href="#cb89-1379" aria-hidden="true" tabindex="-1"></a>z <span class="ot">&lt;-</span> s <span class="sc">/</span> stdev</span>
<span id="cb89-1380"><a href="#cb89-1380" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">pnorm</span>(<span class="fu">abs</span>(z), <span class="at">lower.tail =</span> <span class="cn">FALSE</span>) <span class="sc">*</span> <span class="dv">2</span></span>
<span id="cb89-1381"><a href="#cb89-1381" aria-hidden="true" tabindex="-1"></a>struct_par <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="at">Estimate =</span> s, <span class="st">"Std. Error"</span> <span class="ot">=</span> stdev, </span>
<span id="cb89-1382"><a href="#cb89-1382" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"z value"</span> <span class="ot">=</span> z, <span class="st">"Pr(&gt;|z|"</span> <span class="ot">=</span> p)</span>
<span id="cb89-1383"><a href="#cb89-1383" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(struct_par) <span class="ot">&lt;-</span> <span class="fu">names</span>(s)</span>
<span id="cb89-1384"><a href="#cb89-1384" aria-hidden="true" tabindex="-1"></a>struct_par</span>
<span id="cb89-1385"><a href="#cb89-1385" aria-hidden="true" tabindex="-1"></a><span class="st">```</span></span>
<span id="cb89-1386"><a href="#cb89-1386" aria-hidden="true" tabindex="-1"></a><span class="at">\idxdata[)]{sp\_solow}{necountries}</span></span>
<span id="cb89-1387"><a href="#cb89-1387" aria-hidden="true" tabindex="-1"></a><span class="at">\index[general]{delta method|)}</span></span>
<span id="cb89-1388"><a href="#cb89-1388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1389"><a href="#cb89-1389" aria-hidden="true" tabindex="-1"></a><span class="at">The value of $\kappa$ is compatible with the observable share of the profits in the national product. $\phi$ is significant only at the 10% level. Finally, $\gamma$ is highly significant, which is a confirmation of the relevance of the model of @ERTU:KOCH:07\index[author]{Ertur}\index[author]{Koch}.</span></span>
<span id="cb89-1390"><a href="#cb89-1390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1391"><a href="#cb89-1391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-1392"><a href="#cb89-1392" aria-hidden="true" tabindex="-1"></a></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



</body></html>