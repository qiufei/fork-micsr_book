<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.475">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Microeconometrics with R - 8&nbsp; Treatment effect</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../chapters/spatial.html" rel="next">
<link href="../chapters/endogeneity.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script><script src="../site_libs/kePrint/kePrint.js"></script><link href="../site_libs/lightable/lightable.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }"><div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Treatment effect</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Microeconometrics with R</a> 
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">Preface</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../OLS.html" class="sidebar-item-text sidebar-link">Ordinary least squares estimator</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/simple_regression.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Simple linear regression model</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/simple_regression_properties.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Statistical properties of the simple linear estimator</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/multiple_regression.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Multiple regression model</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/coefficients.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Interpretation of the Coefficients</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../beyond_OLS.html" class="sidebar-item-text sidebar-link">Beyond the OLS estimator</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/maximum_likelihood.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Maximum likelihood estimator</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/non_spherical.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Non-spherical disturbances</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/endogeneity.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Endogeneity</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/treateff.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Treatment effect</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/spatial.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Spatial econometrics</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../special_responses.html" class="sidebar-item-text sidebar-link">Special responses</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/binomial.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Binomial models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/tobit.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Censored and truncated models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/count.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Count data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/duration.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Duration models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/rum.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Discrete choice models</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../references.html" class="sidebar-item-text sidebar-link">References</a>
  </div>
</li>
    </ul>
</div>
</nav><!-- margin-sidebar --><div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#sec-randomized_experiment" id="toc-sec-randomized_experiment" class="nav-link active" data-scroll-target="#sec-randomized_experiment"><span class="toc-section-number">8.1</span>  Randomized experiment</a></li>
  <li><a href="#sec-iv_te" id="toc-sec-iv_te" class="nav-link" data-scroll-target="#sec-iv_te"><span class="toc-section-number">8.2</span>  Instrumental variable estimator</a></li>
  <li>
<a href="#sec-reg_discont" id="toc-sec-reg_discont" class="nav-link" data-scroll-target="#sec-reg_discont"><span class="toc-section-number">8.3</span>  Regression discontinuity</a>
  <ul class="collapse">
<li><a href="#sharp-and-fuzzy" id="toc-sharp-and-fuzzy" class="nav-link" data-scroll-target="#sharp-and-fuzzy">Sharp and Fuzzy</a></li>
  <li><a href="#plotting-the-discontinuity" id="toc-plotting-the-discontinuity" class="nav-link" data-scroll-target="#plotting-the-discontinuity">Plotting the discontinuity</a></li>
  <li><a href="#computing-the-effect-of-the-treatment" id="toc-computing-the-effect-of-the-treatment" class="nav-link" data-scroll-target="#computing-the-effect-of-the-treatment">Computing the effect of the treatment</a></li>
  <li><a href="#manipulation-test" id="toc-manipulation-test" class="nav-link" data-scroll-target="#manipulation-test">Manipulation test</a></li>
  </ul>
</li>
  <li><a href="#sec-diff_diff" id="toc-sec-diff_diff" class="nav-link" data-scroll-target="#sec-diff_diff"><span class="toc-section-number">8.4</span>  Difference-in-differences</a></li>
  <li><a href="#sec-matching" id="toc-sec-matching" class="nav-link" data-scroll-target="#sec-matching"><span class="toc-section-number">8.5</span>  Matching</a></li>
  <li><a href="#sec-synth_control" id="toc-sec-synth_control" class="nav-link" data-scroll-target="#sec-synth_control"><span class="toc-section-number">8.6</span>  Synthetic control</a></li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span id="sec-treatment_effect" class="quarto-section-identifier d-none d-lg-block"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Treatment effect</span></span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header><div class="cell">

</div>
<p>In treatment evaluation analysis, one is interested in the effect of a treatment on a relevant outcome. Popular examples are the effect of microcredit access on the economic outcomes of households in developing countries, effects of a reduction of class size on the academic outcomes of pupils, effects of a youth job training program on employment status. In the simplest case, the outcome <span class="math inline">\(y\)</span> is a continuous variable and the treatment variable <span class="math inline">\(D\)</span> is binomial (1 for treatment, 0 otherwise). The causal impact of <span class="math inline">\(D\)</span> on <span class="math inline">\(y\)</span> is measured by the difference between the value of <span class="math inline">\(y\)</span> if <span class="math inline">\(D=0\)</span>, denoted by <span class="math inline">\(y_0\)</span> and if <span class="math inline">\(D=1\)</span>, denoted by <span class="math inline">\(y_1\)</span>. To an individual for which <span class="math inline">\(D=0\)</span>, <span class="math inline">\(y_0\)</span> is the observed or factual situation. The value of <span class="math inline">\(y\)</span> if the individual had received the treatment is <span class="math inline">\(y_1\)</span> and is called the <strong>counterfactual</strong>. The fundamental problem is that the counterfactual is unobserved. This framework leads to the <strong>potential outcome</strong> model, which became increasingly popular in econometrics. On a sample of size <span class="math inline">\(N\)</span>, denoting <span class="math inline">\(y_{0n}\)</span> and <span class="math inline">\(y_{1n}\)</span> the two values of the outcome, the natural estimator of the effect of the treatment would be:</p>
<p><span id="eq-ideal_te_estimator"><span class="math display">\[
\frac{\sum_{n= 1} ^ N (y_{1n} - y_{0n})}{N}
\tag{8.1}\]</span></span></p>
<p>but is unfeasible for a missing data problem: either <span class="math inline">\(y_{0n}\)</span> or <span class="math inline">\(y_{1n}\)</span> is observed, but not both, as an individual cannot be at the same time treated and untreated. In real settings, we have a sample that contains:</p>
<ul>
<li>a subsample of individuals who received the treatment (<span class="math inline">\(D=1\)</span>) called the <strong>treatment group</strong> (denoted by <span class="math inline">\(T\)</span>),</li>
<li>a subsample of individuals who didn’t receive the treatment (<span class="math inline">\(D=0\)</span>) called the <strong>control group</strong> (denoted by <span class="math inline">\(C\)</span>).</li>
</ul>
<p>and an alternative estimator is obtained using the difference between the mean values of the outcome in the treatment and in the control group:</p>
<p><span id="eq-diff_means_est"><span class="math display">\[
\frac{\sum_{n \in T} y_n}{N_{T}} - \frac{\sum_{n \in C} y_n}{N_{C}}
\tag{8.2}\]</span></span> </p>
<p>Moreover the data can be either <strong>experimental</strong> or <strong>observational</strong>, the difference between the two being that in the first case, the treatment is randomly assigned to some individuals. With experimental data, <a href="#eq-diff_means_est">Equation&nbsp;<span>8.2</span></a> should be a reliable estimator of the effect of the treatment. On the contrary, in case of observational data, the observed and unobserved characteristics of the individuals in the two groups may be different and therefore, the estimator given in <a href="#eq-diff_means_est">Equation&nbsp;<span>8.2</span></a> may include partly these differences and therefore may be biased. To overcome these difficulties, different estimators have been suggested for observational data, which rely on different assumptions that are detailed, for example, in <span class="citation" data-cites="CAME:TRIV:05">Cameron and Trivedi (<a href="#ref-CAME:TRIV:05" role="doc-biblioref">2005</a>)</span>, pp.&nbsp;862-865.</p>
<p><a href="#sec-randomized_experiment"><span>Section&nbsp;8.1</span></a> presents the estimation of the treatment effect with experimental data. <a href="#sec-iv_te"><span>Section&nbsp;8.2</span></a> explains how the instrumental variable estimator can be used to estimate the effect of a treatment. <a href="#sec-reg_discont"><span>Section&nbsp;8.3</span></a> presents the regression discontinuity estimator, <a href="#sec-diff_diff"><span>Section&nbsp;8.4</span></a> the difference in difference estimator and <a href="#sec-matching"><span>Section&nbsp;8.5</span></a> the matching estimator. Finally, <a href="#sec-synth_control"><span>Section&nbsp;8.6</span></a> is devoted to the synthetic control estimator.</p>
<section id="sec-randomized_experiment" class="level2" data-number="8.1"><h2 data-number="8.1" class="anchored" data-anchor-id="sec-randomized_experiment">
<span class="header-section-number">8.1</span> Randomized experiment</h2>
<p></p>
<p>Randomized experiences are the ideal setting to analyze treatment effects. The treatment and the control groups are composed of individuals who are randomly drawn from the same population, and therefore the average observable and unobserved characteristics in both groups should be similar.</p>
<p>To illustrate the use of randomized experiments, we consider the study of <span class="citation" data-cites="BURD:LIND:13">Burde and Linden (<a href="#ref-BURD:LIND:13" role="doc-biblioref">2013</a>)</span> who study the effect of village-based schools on children’s academic performance. The sample comprises villages from the Ghor province in northwestern Afghanistan. More specifically, 31 villages were selected and formed 11 village groups. Five of them received a village-based school in summer 2007. In fall 2007, a survey was conducted in the 31 villages. The two outcomes of interest are the enrollment status of children between the ages of 6 and 11 and the score obtained to a short test covering math and language skills.</p>
<p>The first step of the analysis consists of checking that the observable characteristics are similar in the treatment and in the control group. For numerical variables, this can be performed using a t test of equal means. Assume that <span class="math inline">\(x\)</span> is drawn from a normal distribution, with potentially a different mean for the treatment and for the control group, but the same variance <span class="math inline">\(\sigma_x ^ 2\)</span>. Then, <span class="math inline">\(\bar{x}_T = \sum_{n\in T} x_n / N_T\)</span> and <span class="math inline">\(\bar{x}_C = \sum_{n\in C} x_n / N_C\)</span> are normal variables with means equal to <span class="math inline">\(\mu_T\)</span> and <span class="math inline">\(\mu_C\)</span> and a variance equal respectively to <span class="math inline">\(\sigma_x ^ 2 / N_T\)</span> and <span class="math inline">\(\sigma_x ^ 2 / N_C\)</span>. Moreover, the difference of the means is also a normal variable with mean <span class="math inline">\(\mu_T - \mu_C\)</span> and a variance equal to the sum of the two variances, the covariance being null for a random sample. Therefore:</p>
<p><span id="eq-two_smpl_normal"><span class="math display">\[
\frac{(\bar{x}_T - \bar{x}_C) - (\mu_T - \mu_C)}{\sigma_x\sqrt{1 / N_T + 1 / N_C}} \sim \mathcal{N}(0, 1)
\tag{8.3}\]</span></span> Replacing the unknown <span class="math inline">\(\sigma_x ^ 2\)</span> by the unbiased estimate:</p>
<p><span class="math display">\[
\hat{\sigma}_x ^ 2 = \frac{\sum_{n\in T} (x_n - \bar{x}_T) ^ 2 + \sum_{n\in C} (x_n - \bar{x}_C) ^ 2}{N_T + N_C - 2}
\]</span> and, with the hypothesis of equal mean (<span class="math inline">\(H_0: \mu_T = \mu_C\)</span>), <span class="math inline">\(\frac{\bar{x}_T - \bar{x}_C}{\hat{\sigma}_x \sqrt{1/N_T + 1/N_C}}\)</span> is a Student t with <span class="math inline">\(N_T + N_C - 2\)</span> degrees of freedom. The Student t-test assumes that the variance of <span class="math inline">\(x\)</span> is the same in both groups. Welch’s t-test, or the unequal variance t-test, extends the simple t-test to the case where the variance of <span class="math inline">\(x\)</span> is different in the two groups. </p>
<p><code><a href="https://rdrr.io/r/stats/t.test.html">stats::t.test</a></code> computes the two flavors of the test. It uses a formula-data interface and has a supplementary argument called <code>var.equal</code> which is <code>FALSE</code> by default. Therefore, Welch’s version of the test is computed by default and the simple t-test is obtained by setting <code>var.equal</code> to <code>TRUE</code>. We apply the two flavors of the test to the <code>distance</code> variable, which is the distance to the nearest formal school, using the <code>group</code> variable which is a factor with levels <code>"control"</code> and <code>"treatment"</code>: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/t.test.html">t.test</a></span><span class="op">(</span><span class="va">distance</span> <span class="op">~</span> <span class="va">group</span>, <span class="va">afghan_girls</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">gaze</span></span>
<span><span class="co">## diff = 0.253 (0.058), t = 4.393, df: 1483, pval = 0.000</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and the hypothesis of equal mean is highly rejected. Computing the simple version of the t-test: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/t.test.html">t.test</a></span><span class="op">(</span><span class="va">distance</span> <span class="op">~</span> <span class="va">group</span>, <span class="va">afghan_girls</span>, var.equal <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">gaze</span></span>
<span><span class="co">## diff = 0.253 (0.058), t = 4.384, df: 1488, pval = 0.000</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>we get almost the same result. This last version of the test is equivalent to the result of a regression of the outcome variable on the group dummy: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">distance</span> <span class="op">~</span> <span class="va">group</span>, <span class="va">afghan_girls</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">gaze</span></span>
<span><span class="co">##                Estimate Std. Error t value Pr(&gt;|t|)</span></span>
<span><span class="co">## grouptreatment  -0.2529     0.0577   -4.38  1.2e-05</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The coefficient of the intercept is the mean for the control group and the coefficient of <code>grouptreatment</code> is the difference of the means for the two groups. The t-value is exactly the one obtained using <code>t.test</code> with <code>var.equal = TRUE</code>. </p>
<p>Balance between groups of factors can be tested using Pearson’s <span class="math inline">\(\chi^2\)</span> test. It is based on the comparison of the observed joint distribution of the two variables and the one obtained using the independence hypotheses (obtained by multiplying the marginal frequencies of the two variables). Denote <span class="math inline">\(o\)</span> and <span class="math inline">\(e\)</span> the observed and the hypothesized frequencies, <span class="math inline">\(i\)</span> the index of the cell and <span class="math inline">\(N\)</span> the size of the sample:</p>
<p><span id="eq-pearson_chi2"><span class="math display">\[
\sum_i \frac{(o_i - e_i) ^ 2}{e_i}
\tag{8.4}\]</span></span></p>
<p>the statistic is, under the hypothesis of independence, a <span class="math inline">\(\chi ^ 2\)</span> with a number of degrees of freedom equal to <span class="math inline">\((J_1 -1) \times (J_2 - 1)\)</span> where <span class="math inline">\(J_1\)</span> and <span class="math inline">\(J_2\)</span> are the number of modalities for the two factors.</p>
<p>In the <code>afghan_girls</code> data set, <code>ethny</code> is a factor with levels <code>"other"</code>, <code>"farsi"</code> and <code>"tajik"</code>. We first compute the frequency table using the <code>table</code> function, which is similar to <code><a href="https://dplyr.tidyverse.org/reference/count.html">dplyr::count</a></code>, but the input is a series and not a data frame and the result is an object of class <code>table</code>, which is much alike an object of class <code>matrix</code>, and not a data frame. We then compute the relative frequencies using the <code>prop.table</code> function. Note that <code>prop.table</code> has a <code>margin</code> argument that we don’t use here.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">obs_freq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proportions.html">prop.table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">afghan_girls</span><span class="op">$</span><span class="va">group</span>, <span class="va">afghan_girls</span><span class="op">$</span><span class="va">ethny</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In case of independence, the frequencies are obtained using the outer product of the marginal frequencies: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">freq_group</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proportions.html">prop.table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">afghan_girls</span><span class="op">$</span><span class="va">group</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">freq_ethny</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/proportions.html">prop.table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">afghan_girls</span><span class="op">$</span><span class="va">ethny</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ind_freq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/outer.html">outer</a></span><span class="op">(</span><span class="va">freq_group</span>, <span class="va">freq_ethny</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Applying <a href="#eq-pearson_chi2">Equation&nbsp;<span>8.4</span></a>, we obtain: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">obs_freq</span> <span class="op">-</span> <span class="va">ind_freq</span><span class="op">)</span> <span class="op">^</span> <span class="fl">2</span> <span class="op">/</span> <span class="va">ind_freq</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">afghan_girls</span><span class="op">)</span></span>
<span><span class="co">## [1] 2.846</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This test can be conveniently computed using the <code>stats:chisq.test</code> function: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/chisq.test.html">chisq.test</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">afghan_girls</span><span class="op">$</span><span class="va">group</span>, <span class="va">afghan_girls</span><span class="op">$</span><span class="va">ethny</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">gaze</span></span>
<span><span class="co">## X-squared = 2.846, df: 2, pval = 0.241</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and the hypothesis of independence is not rejected. The whole table of balance is often called “Table 1”, as it is the first table that appears in most articles in medical reviews. It can be computed using the <code><a href="https://www.danieldsjoberg.com/gtsummary/reference/tbl_summary.html">gtsummary::tbl_summary</a></code> function, which has a <code>by</code> argument that indicates the grouping variable. <code>tbl_summary</code> has a lot of arguments, and auxiliary functions that enables to customize the results.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> The balance table for the <code>afghan_girls</code> data set is presented in <a href="#tbl-balance_afghan">Table&nbsp;<span>8.1</span></a>.<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> </p>
<div class="cell" data-layout-align="center" data-hash="treateff_cache/html/tbl-balance_afghan_639bb48af136afd4b7e922ca970c3ced">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/ddsjoberg/gtsummary">"gtsummary"</a></span><span class="op">)</span> ; <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="http://haozhu233.github.io/kableExtra/">"kableExtra"</a></span><span class="op">)</span></span>
<span><span class="va">afghan_girls</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">group</span>, <span class="va">head_child</span><span class="op">:</span><span class="va">ethny</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://www.danieldsjoberg.com/gtsummary/reference/tbl_summary.html">tbl_summary</a></span><span class="op">(</span>by <span class="op">=</span> <span class="va">group</span>,</span>
<span>                missing <span class="op">=</span> <span class="st">"no"</span>,</span>
<span>                statistic <span class="op">=</span> <span class="fu"><a href="https://www.danieldsjoberg.com/gtsummary/reference/select_helpers.html">all_continuous</a></span><span class="op">(</span><span class="op">)</span> <span class="op">~</span> <span class="st">"{mean} ({sd})"</span>,</span>
<span>                type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">age</span> <span class="op">~</span> <span class="st">"continuous"</span><span class="op">)</span>,</span>
<span>                digits <span class="op">=</span> <span class="fu"><a href="https://www.danieldsjoberg.com/gtsummary/reference/select_helpers.html">all_continuous</a></span><span class="op">(</span><span class="op">)</span> <span class="op">~</span> <span class="fl">2</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://www.danieldsjoberg.com/gtsummary/reference/add_p.html">add_p</a></span><span class="op">(</span><span class="fu"><a href="https://www.danieldsjoberg.com/gtsummary/reference/select_helpers.html">all_continuous</a></span><span class="op">(</span><span class="op">)</span> <span class="op">~</span> <span class="st">"t.test"</span>,</span>
<span>          pvalue_fun <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://www.danieldsjoberg.com/gtsummary/reference/style_pvalue.html">style_pvalue</a></span><span class="op">(</span><span class="va">.</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://www.danieldsjoberg.com/gtsummary/reference/as_kable_extra.html">as_kable_extra</a></span><span class="op">(</span>booktabs <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/kable_styling.html">kable_styling</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/column_spec.html">column_spec</a></span><span class="op">(</span><span class="fl">1</span>, width <span class="op">=</span> <span class="st">"15em"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="tbl-balance_afghan" class="anchored">

<table style="NAborder-bottom: 0; margin-left: auto; margin-right: auto;" class="table">
<caption>Table&nbsp;8.1:  Balance table for the Afghan girls data set </caption>
 <thead><tr>
<th style="text-align:left;"> Characteristic </th>
   <th style="text-align:center;"> control  <br>N = 708 </th>
   <th style="text-align:center;"> treatment  <br>N = 782 </th>
   <th style="text-align:center;"> p-value </th>
  </tr></thead>
<tbody>
<tr>
<td style="text-align:left;width: 15em; "> head_child </td>
   <td style="text-align:center;"> 645 (91%) </td>
   <td style="text-align:center;"> 731 (93%) </td>
   <td style="text-align:center;"> 0.085 </td>
  </tr>
<tr>
<td style="text-align:left;width: 15em; "> sex </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> 0.45 </td>
  </tr>
<tr>
<td style="text-align:left;padding-left: 2em;width: 15em; " indentlevel="1"> boy </td>
   <td style="text-align:center;"> 386 (55%) </td>
   <td style="text-align:center;"> 411 (53%) </td>
   <td style="text-align:center;">  </td>
  </tr>
<tr>
<td style="text-align:left;padding-left: 2em;width: 15em; " indentlevel="1"> girl </td>
   <td style="text-align:center;"> 322 (45%) </td>
   <td style="text-align:center;"> 371 (47%) </td>
   <td style="text-align:center;">  </td>
  </tr>
<tr>
<td style="text-align:left;width: 15em; "> Child's age, fall 2007 </td>
   <td style="text-align:center;"> 8.31 (1.64) </td>
   <td style="text-align:center;"> 8.32 (1.66) </td>
   <td style="text-align:center;"> 0.92 </td>
  </tr>
<tr>
<td style="text-align:left;width: 15em; "> Length of time family has lived in the village, fall 2007 </td>
   <td style="text-align:center;"> 27.59 (15.66) </td>
   <td style="text-align:center;"> 30.30 (15.51) </td>
   <td style="text-align:center;"> &lt;0.001 </td>
  </tr>
<tr>
<td style="text-align:left;width: 15em; "> occup </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> 0.67 </td>
  </tr>
<tr>
<td style="text-align:left;padding-left: 2em;width: 15em; " indentlevel="1"> farmer </td>
   <td style="text-align:center;"> 515 (73%) </td>
   <td style="text-align:center;"> 561 (72%) </td>
   <td style="text-align:center;">  </td>
  </tr>
<tr>
<td style="text-align:left;padding-left: 2em;width: 15em; " indentlevel="1"> other </td>
   <td style="text-align:center;"> 193 (27%) </td>
   <td style="text-align:center;"> 221 (28%) </td>
   <td style="text-align:center;">  </td>
  </tr>
<tr>
<td style="text-align:left;width: 15em; "> Age of head of the household, fall 2007 </td>
   <td style="text-align:center;"> 39.97 (11.40) </td>
   <td style="text-align:center;"> 40.14 (11.19) </td>
   <td style="text-align:center;"> 0.77 </td>
  </tr>
<tr>
<td style="text-align:left;width: 15em; "> Years of education of the head of the household, fall 2007 </td>
   <td style="text-align:center;"> 3.08 (3.51) </td>
   <td style="text-align:center;"> 3.31 (3.54) </td>
   <td style="text-align:center;"> 0.19 </td>
  </tr>
<tr>
<td style="text-align:left;width: 15em; "> Number of people in the household, fall 2007 </td>
   <td style="text-align:center;"> 7.82 (2.56) </td>
   <td style="text-align:center;"> 8.40 (2.92) </td>
   <td style="text-align:center;"> &lt;0.001 </td>
  </tr>
<tr>
<td style="text-align:left;width: 15em; "> Number of jeribs of land owned by household, fall 2007 </td>
   <td style="text-align:center;"> 1.27 (1.63) </td>
   <td style="text-align:center;"> 1.34 (1.56) </td>
   <td style="text-align:center;"> 0.39 </td>
  </tr>
<tr>
<td style="text-align:left;width: 15em; "> Number of sheeps and goats owned by the household, fall 2007 </td>
   <td style="text-align:center;"> 5.63 (6.99) </td>
   <td style="text-align:center;"> 7.55 (8.09) </td>
   <td style="text-align:center;"> &lt;0.001 </td>
  </tr>
<tr>
<td style="text-align:left;width: 15em; "> Distance (miles) to the nearest non-community based school, fall 2007 </td>
   <td style="text-align:center;"> 3.16 (1.09) </td>
   <td style="text-align:center;"> 2.91 (1.13) </td>
   <td style="text-align:center;"> &lt;0.001 </td>
  </tr>
<tr>
<td style="text-align:left;width: 15em; "> ethny </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> 0.24 </td>
  </tr>
<tr>
<td style="text-align:left;padding-left: 2em;width: 15em; " indentlevel="1"> other </td>
   <td style="text-align:center;"> 413 (58%) </td>
   <td style="text-align:center;"> 429 (55%) </td>
   <td style="text-align:center;">  </td>
  </tr>
<tr>
<td style="text-align:left;padding-left: 2em;width: 15em; " indentlevel="1"> farsi </td>
   <td style="text-align:center;"> 148 (21%) </td>
   <td style="text-align:center;"> 163 (21%) </td>
   <td style="text-align:center;">  </td>
  </tr>
<tr>
<td style="text-align:left;padding-left: 2em;width: 15em; " indentlevel="1"> tajik </td>
   <td style="text-align:center;"> 147 (21%) </td>
   <td style="text-align:center;"> 190 (24%) </td>
   <td style="text-align:center;">  </td>
  </tr>
</tbody>
<tfoot>
<tr><td style="padding: 0; " colspan="100%">
<sup>1</sup> n (%); Mean (SD)</td></tr>
<tr><td style="padding: 0; " colspan="100%">
<sup>2</sup> Pearson's Chi-squared test; Welch Two Sample t-test</td></tr>
</tfoot>
</table>
</div>
</div>
</div>
<p>The set of tests doesn’t detect any significant differences between the two groups for the covariates <code>head_child</code>, <code>sex</code>, <code>age</code>, <code>occup</code>, <code>age_head</code>, <code>jeribs</code>, <code>distance</code> and <code>ethny</code>. On the contrary, for the <code>duration</code>, <code>hsize</code>, <code>sheeps</code> and <code>distance</code> covariates, the equal mean hypothesis is strongly rejected. The next step is to apply the same tests to the outcomes which are, in this study, <code>enrollment</code> and <code>test</code>. For the <code>test</code> variable, a boxplot is presented in <a href="#fig-bxp_test">Figure&nbsp;<span>8.1</span></a>, with a separate plot for boys and girls. </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">afghan_girls</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span><span class="va">group</span>, <span class="va">test</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_boxplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span> <span class="va">sex</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-bxp_test" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="treateff_files/figure-html/fig-bxp_test-1.png" class="img-fluid figure-img" style="width:60.0%"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;8.1: Boxplot for the test variable between the control and the treatment group</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>There seems to be a large positive effect of the treatment on the results of the test. Moreover, the scores for boys are much higher than for girls. For girls, we get: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/t.test.html">t.test</a></span><span class="op">(</span><span class="va">test</span> <span class="op">~</span> <span class="va">group</span>, <span class="va">afghan_girls</span>, subset <span class="op">=</span> <span class="va">sex</span> <span class="op">==</span> <span class="st">"girl"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">gaze</span></span>
<span><span class="co">## diff = -0.746 (0.068), t = -10.910, df: 653, pval = 0.000</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The effect is strong (about 0.75, which means three-quarters of a standard deviation of the score, as this variable is standardized) and highly significant. As some covariates are unbalanced, this estimator may be biased. Therefore, it is recommended to measure the effect as the coefficient of <code>group</code> in a multiple regression with all the available controlling variables. Moreover, adding relevant variables will increase the precision of the estimation. </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">test</span> <span class="op">~</span> <span class="va">group</span> <span class="op">+</span> <span class="va">chagcharan</span> <span class="op">+</span> <span class="va">head_child</span> <span class="op">+</span> <span class="va">age</span> <span class="op">+</span> <span class="va">duration</span> <span class="op">+</span> <span class="va">occup</span> <span class="op">+</span></span>
<span>       <span class="va">age_head</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> <span class="va">hsize</span> <span class="op">+</span> <span class="va">jeribs</span> <span class="op">+</span> <span class="va">sheeps</span> <span class="op">+</span> <span class="va">distance</span> <span class="op">+</span> <span class="va">ethny</span>,</span>
<span>   <span class="va">afghan_girls</span>, subset <span class="op">=</span> <span class="va">sex</span> <span class="op">==</span> <span class="st">"girl"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">gaze</span><span class="op">(</span>coef <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">##                Estimate Std. Error t value Pr(&gt;|t|)</span></span>
<span><span class="co">## grouptreatment   0.6542     0.0637    10.3   &lt;2e-16</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The coefficient is slightly lower but still very significant. </p>
</section><section id="sec-iv_te" class="level2" data-number="8.2"><h2 data-number="8.2" class="anchored" data-anchor-id="sec-iv_te">
<span class="header-section-number">8.2</span> Instrumental variable estimator</h2>
<p></p>
<p><span class="citation" data-cites="IMBE:ANGR:94">Imbens and Angrist (<a href="#ref-IMBE:ANGR:94" role="doc-biblioref">1994</a>)</span> and <span class="citation" data-cites="ANGR:IMBE:RUBI:96">Angrist, Imbens, and Rubin (<a href="#ref-ANGR:IMBE:RUBI:96" role="doc-biblioref">1996</a>)</span> consider the use of instrumental variables in the context of the potential outcome model. We consider the simple case where the treatment <span class="math inline">\(d\)</span> is binary and the instrument <span class="math inline">\(w\)</span> is also binary.<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> The value of the outcome for individual <span class="math inline">\(n\)</span> for a given combination of <span class="math inline">\(d\)</span> and <span class="math inline">\(w\)</span> is denoted by: <span class="math inline">\(y_n(w_n, d_n)\)</span>; <span class="math inline">\(w\)</span> can be used as an instrumental variable if <span class="math inline">\(w\)</span> is related to <span class="math inline">\(y\)</span> only because of its influence on <span class="math inline">\(d\)</span>. Stated differently, for a given value of <span class="math inline">\(d\)</span>, <span class="math inline">\(y\)</span> is the same whatever the value of <span class="math inline">\(w\)</span>: <span class="math inline">\(y_n(0, d_n) = y_n(1, d_n)\)</span>. This is the <strong>exclusion restriction</strong>, standard in the instrumental variable literature. Therefore, potential outcome can be defined as a function of the treatment variable only: <span class="math inline">\(y_n(w_n, d_n) = y_n(d_n)\)</span> and <span class="math inline">\(d_n\)</span> can be expressed as a function of <span class="math inline">\(d_n\)</span>: <span class="math inline">\(d_n(w_n)\)</span>. The next assumption is that on average, <span class="math inline">\(w\)</span> has a causal effect on <span class="math inline">\(d\)</span>: <span class="math inline">\(\mbox{E}\left(d(1) - d(0)\right) \neq 0\)</span>. The last assumption is <strong>monotonicity</strong> <span class="citation" data-cites="IMBE:ANGR:94">(<a href="#ref-IMBE:ANGR:94" role="doc-biblioref">Imbens and Angrist 1994</a>)</span> which states that <span class="math inline">\(d_n(1) \geq d_n(0) \; \forall n\)</span>. With these assumptions in hand, the causal effect of <span class="math inline">\(w\)</span> on <span class="math inline">\(y\)</span> is:</p>
<p><span id="eq-fourcats"><span class="math display">\[\begin{array}{rcl}
y_n(1, d_n(1)) - y_n(0, d_n(0)) &amp;=&amp; y_n(d_n(1)) - y_n(d_n(0)) \\
&amp;=&amp; \left[y_n(1) d_n(1) + y_n(0) (1 - d_n(1))\right] \\
&amp;-&amp; \left[y_n(1) d_n(0) - y_n(0) (1 - d_n(0))\right] \\
&amp;=&amp; (y_n(1) - y_n(0)) (d_n(1) - d_n(0))
\end{array}
\tag{8.5}\]</span></span></p>
<p>Therefore, the causal effect of <span class="math inline">\(w\)</span> on <span class="math inline">\(y\)</span> is the product of the causal effects of <span class="math inline">\(d\)</span> on <span class="math inline">\(y\)</span> and of <span class="math inline">\(w\)</span> on <span class="math inline">\(d\)</span>. Consider now the relation between <span class="math inline">\(w\)</span> and <span class="math inline">\(d\)</span> at the individual level. Four categories can be considered (represented on <a href="#fig-ivset">Figure&nbsp;<span>8.2</span></a>):</p>
<ul>
<li>compliers: <span class="math inline">\(d_n(1) = 1\)</span> and <span class="math inline">\(d_n(0) = 0\)</span>,</li>
<li>always takers: <span class="math inline">\(d_n(1) = d_n(0) = 1\)</span>,</li>
<li>never takers: <span class="math inline">\(d_n(1) = d_n(0) = 0\)</span>,</li>
<li>deniers: <span class="math inline">\(d_n(1) = 0\)</span> and <span class="math inline">\(d_n(0) = 1\)</span>. </li>
</ul>
<div id="fig-ivset" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><embed src="./tikz/iv_set.pdf" class="img-fluid"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;8.2: The four categories of individuals</figcaption><p></p>
</figure>
</div>
<p> There are four observable categories of individuals, represented by the four squares and named by the two digits (the observed values of <span class="math inline">\(w\)</span> and <span class="math inline">\(d\)</span>) indicated in a gray square. The counterfactuals are represented by two circles inside the square. For example, the square called <span class="math inline">\(00\)</span> contains the individuals for which <span class="math inline">\(w=0\)</span> and <span class="math inline">\(d=0\)</span>. For those individuals the unobserved counterfactual is <span class="math inline">\(w=1\)</span> and <span class="math inline">\(d\)</span> either equal to 0 or 1. If the counterfactual is <span class="math inline">\(w = 1, d = 0\)</span>, the individual is a never-taker, <span class="math inline">\(d= 0\)</span> whatever the value of <span class="math inline">\(w\)</span>. If the counterfactual is <span class="math inline">\(w=1, d=1\)</span>, the individual is a complier: with <span class="math inline">\(w=0\)</span>, <span class="math inline">\(d=0\)</span>, but a change of <span class="math inline">\(w\)</span> from 0 to 1 results in a change of <span class="math inline">\(d\)</span> from 0 to 1. With the always takers and the never takers, the causal effect of <span class="math inline">\(w\)</span> on <span class="math inline">\(y\)</span> in <a href="#eq-fourcats">Equation&nbsp;<span>8.5</span></a> is zero because the causal effect of <span class="math inline">\(w\)</span> on <span class="math inline">\(d\)</span> is zero. The monotonicity assumption rules out the existence of deniers. Therefore, the causal effect of <span class="math inline">\(w\)</span> on <span class="math inline">\(d\)</span> reduces to the treatment effect for the compliers.</p>
<p>Consider now the instrumental variable estimator. It estimates, in the general case, the following population estimand: <span class="math inline">\(\frac{\mbox{cov}(y, w)}{\mbox{cov}(d, w)}\)</span>, which, for the case where both <span class="math inline">\(d\)</span> and <span class="math inline">\(w\)</span> are binary, reduces to:</p>
<p><span id="eq-late"><span class="math display">\[
\frac{\mbox{E}\left(y(1, d(1)) - y(0, d(0))\right)}
{\mbox{E}\left(d(1) - d(0)\right)}
\tag{8.6}\]</span></span></p>
<p>The numerator is the average causal effect of <span class="math inline">\(w\)</span> on <span class="math inline">\(y\)</span> for the compliers and the denominator is the share of compliers in the population. <span class="citation" data-cites="ANGR:IMBE:RUBI:96">Angrist, Imbens, and Rubin (<a href="#ref-ANGR:IMBE:RUBI:96" role="doc-biblioref">1996</a>)</span> call <a href="#eq-late">Equation&nbsp;<span>8.6</span></a> the <strong>local average treatment effect</strong> (<strong>LATE</strong>) to stress the fact that what is estimated using the instrumental variable estimator is an average treatment effect for only a subset of the population called the compliers, ie those for which a change in the value of <span class="math inline">\(w\)</span> results in a change in the value of <span class="math inline">\(d\)</span>. The numerator is also called the <strong>reduced form</strong> equation, as it measures the effect of the instrument on the outcome. The denominator is called the <strong>intention to treat</strong> equation, it measures the effect of the instrument on the treatment dummy. </p>
<p>As an example, we use the data set of <span class="citation" data-cites="ANGR:BETT:BLOO:KING:KREM:02">Angrist et al. (<a href="#ref-ANGR:BETT:BLOO:KING:KREM:02" role="doc-biblioref">2002</a>)</span> called <code>paces</code>. The authors investigate the effect of a large school voucher program in Columbia called PACES. This voucher covers more than half of the cost of private secondary school and may induce parents to enroll their children in private schools, which are known to provide much better service than public schools. In this case, <span class="math inline">\(w\)</span> is a dummy for children who receive the voucher and <span class="math inline">\(d\)</span> is a dummy for enrollment in private school.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">paces</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,577 × 18
     id privsch educyrs voucher pilot housvisit city   phone   age
  &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt; &lt;fct&gt;  &lt;dbl&gt; &lt;dbl&gt;
1     3       1       8       1     0         0 bogota     1    14
2     4       1       8       0     0         0 bogota     1    14
# ℹ 1,575 more rows
# ℹ 9 more variables: sex &lt;fct&gt;, strata &lt;fct&gt;, smpl &lt;fct&gt;,
#   month &lt;fct&gt;, married &lt;dbl&gt;, finish8 &lt;dbl&gt;, repetitions &lt;dbl&gt;,
#   in_school &lt;dbl&gt;, year &lt;fct&gt;</code></pre>
</div>
</div>
<p>The treatment variable is <code>privsch</code> and the instrument is <code>voucher</code>. Several outcomes are considered by the authors; we’ll consider only the number of years of finished education <code>educyrs</code>. The OLS estimate of the treatment is just the difference between the mean of the outcome for the two subsamples defined by the treatment variable: </p>
<div class="cell" data-layout-align="center">

</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">educyrs</span> <span class="op">~</span> <span class="va">privsch</span>, <span class="va">paces</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">gaze</span></span>
<span><span class="co">##         Estimate Std. Error t value Pr(&gt;|t|)</span></span>
<span><span class="co">## privsch   0.2916     0.0557    5.23  1.9e-07</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Therefore, the number of years of education is higher by about 0.29 of a year for pupils enrolled in private schools, and the effect is highly significant. We then compute the effect of the instrument on the treatment (intention to treat) and on the outcome (reduced form): </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">privsch</span> <span class="op">~</span> <span class="va">voucher</span>, <span class="va">paces</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">gaze</span><span class="op">(</span>coef <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">##         Estimate Std. Error t value Pr(&gt;|t|)</span></span>
<span><span class="co">## voucher   0.6421     0.0188    34.1   &lt;2e-16</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">educyrs</span> <span class="op">~</span> <span class="va">voucher</span>, <span class="va">paces</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">gaze</span><span class="op">(</span>coef <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">##         Estimate Std. Error t value Pr(&gt;|t|)</span></span>
<span><span class="co">## voucher   0.1079     0.0553    1.95    0.051</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The voucher has a large effect on enrolling in private school, the intention to treat effect being: 0.642. The effect of the instrument on the outcome is 0.108. The IV estimator is the ratio of these two effects, which is: <span class="math inline">\(0.168\)</span>. Therefore, in this example, we get an IV estimator of the treatment effect much smaller than the OLS estimator, which may be the symptom that unobserved determinants of the outcome are positively correlated with the enrollment in private school. Covariates can easily be added to the analysis. In their study, <span class="citation" data-cites="ANGR:BETT:BLOO:KING:KREM:02">Angrist et al. (<a href="#ref-ANGR:BETT:BLOO:KING:KREM:02" role="doc-biblioref">2002</a>)</span> use two covariates that indicate the type of survey (<code>pilot</code> is one if the individual was surveyed during the “pilot” survey, and <code>housvisit</code> is one if the survey was conducted in person and not by phone), <code>smpl</code> is a factor indicating the three subsamples (Bogota in 1995, Bogota in 1997 and Djamunid in 1993), <code>phone</code> is a dummy for owning a phone, <code>age</code> and <code>sex</code> are the age and the sex of the pupil and <code>strata</code> is a strata of residence. We then compute the OLS and IV estimators: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">educyrs</span> <span class="op">~</span> <span class="va">privsch</span> <span class="op">+</span> <span class="va">pilot</span> <span class="op">+</span> <span class="va">housvisit</span> <span class="op">+</span> <span class="va">smpl</span> <span class="op">+</span></span>
<span>               <span class="va">phone</span> <span class="op">+</span> <span class="va">age</span> <span class="op">+</span> <span class="va">sex</span> <span class="op">+</span> <span class="va">strata</span> <span class="op">+</span> <span class="va">month</span>, data <span class="op">=</span> <span class="va">paces</span><span class="op">)</span></span>
<span><span class="va">iv</span> <span class="op">&lt;-</span> <span class="fu">ivreg</span><span class="fu">::</span><span class="fu"><a href="https://zeileis.github.io/ivreg/reference/ivreg.html">ivreg</a></span><span class="op">(</span><span class="va">educyrs</span> <span class="op">~</span> <span class="va">privsch</span> <span class="op">+</span> <span class="va">pilot</span> <span class="op">+</span> <span class="va">housvisit</span> <span class="op">+</span> <span class="va">smpl</span> <span class="op">+</span></span>
<span>                      <span class="va">phone</span> <span class="op">+</span> <span class="va">age</span> <span class="op">+</span> <span class="va">sex</span> <span class="op">+</span> <span class="va">strata</span> <span class="op">+</span> <span class="va">month</span> <span class="op">|</span> <span class="va">.</span> <span class="op">-</span> <span class="va">privsch</span> <span class="op">+</span></span>
<span>                      <span class="va">voucher</span>, data <span class="op">=</span> <span class="va">paces</span><span class="op">)</span></span>
<span><span class="va">ols</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">gaze</span><span class="op">(</span>coef <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">##         Estimate Std. Error t value Pr(&gt;|t|)</span></span>
<span><span class="co">## privsch   0.1408     0.0424    3.32  0.00092</span></span>
<span><span class="va">iv</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">gaze</span><span class="op">(</span>coef <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">##         Estimate Std. Error t value Pr(&gt;|t|)</span></span>
<span><span class="co">## privsch   0.1342     0.0651    2.06    0.039</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The two estimators are now almost identical: introducing the covariates reduces by almost one half the value of the OLS estimator and has a small effect on the IV estimator without covariates. </p>
</section><section id="sec-reg_discont" class="level2" data-number="8.3"><h2 data-number="8.3" class="anchored" data-anchor-id="sec-reg_discont">
<span class="header-section-number">8.3</span> Regression discontinuity</h2>
<p> Eligibility to a program is sometimes based on the value of an observable variable (called the <strong>forcing variable</strong>), and more precisely, on the fact that the value of this variable, for an individual is below or over a given threshold. Individuals just below and just over the threshold therefore constitute two groups of individuals who are very similar, except that the first group receives the treatment and the second group doesn’t. This is called a <strong>regression discontinuity</strong> (<strong>RD</strong>) design.</p>
<section id="sharp-and-fuzzy" class="level3"><h3 class="anchored" data-anchor-id="sharp-and-fuzzy">Sharp and Fuzzy</h3>
<p> </p>
<p>Two variants of regression discontinuity designs can be considered:</p>
<ul>
<li>
<strong>sharp discontinuity</strong>, there is a one-to-one correspondence between eligibility and treatment,</li>
<li>
<strong>fuzzy discontinuity</strong>, the probability of being treated is very different just below and just over the threshold.</li>
</ul>
<p>We’ll consider, in this chapter, two data sets. The first, called <code>probation</code>, is from <span class="citation" data-cites="LIND:SAND:OREO:10">Lindo, Sanders, and Oreopoulos (<a href="#ref-LIND:SAND:OREO:10" role="doc-biblioref">2010</a>)</span> who studied the effects of academic probation on academic performance in Canadian universities. If a student’s grade point average (GPA) is below a certain threshold, he is placed on academic probation. GPA is between 0 and 4.5, and there are three campuses in the sample, denoted by <code>"1"</code>, <code>"2"</code> and <code>"3"</code>; for the first two, the threshold is 1.5 and for the third one it is 1.6. We first compute the distance to the threshold using the <code>gpa</code> and the <code>campus</code> variables: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">probation</span> <span class="op">&lt;-</span> <span class="va">probation</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>distcut <span class="op">=</span> <span class="va">gpa</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">campus</span> <span class="op">==</span> <span class="st">"3"</span>, <span class="fl">1.6</span>, <span class="fl">1.5</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We then compute the joint frequency table for the two variables of eligibility and probation. </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">probation</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>eligible <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">distcut</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">count</span><span class="op">(</span><span class="va">eligible</span>, <span class="va">probation</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">eligible</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">n</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">pivot_wider</span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">eligible</span>, values_from <span class="op">=</span> <span class="va">n</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 3
  probation       `0`     `1`
  &lt;fct&gt;         &lt;dbl&gt;   &lt;dbl&gt;
1 no        1.00      0.00671
2 yes       0.0000806 0.993  </code></pre>
</div>
</div>
<p>Although the discontinuity is sharp, the probability of being on probation is not exactly equal to 1 for eligible students and equal to 0 for ineligible students because of administrative errors in data reporting.<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a> We remove these misleading observations:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">probation</span> <span class="op">&lt;-</span> <span class="va">probation</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span> <span class="op">(</span><span class="va">probation</span> <span class="op">==</span> <span class="st">"yes"</span> <span class="op">&amp;</span> <span class="va">distcut</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">|</span></span>
<span>            <span class="op">(</span><span class="va">probation</span> <span class="op">==</span> <span class="st">"no"</span> <span class="op">&amp;</span> <span class="va">distcut</span> <span class="op">&gt;=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- The -->
<!-- program started in 2003 and, in 2009, the index changed, so that some -->
<!-- former eligible households lost the grant and some previously ineligible households received it.  -->
<p><span class="citation" data-cites="BUSE:15">Buser (<a href="#ref-BUSE:15" role="doc-biblioref">2015</a>)</span> analyzed the effect of income on religiousness. He considered the BDH (Bono Desarollo Humano) program in Ecuador which consists of a cash transfer for the poorest families. The eligibility is based on a wealth index called Selben, households in the four first deciles being eligible. The data were collected in 2011 and are available as <code>bdh</code>. The key variables are the <code>selben</code> index (the threshold has been removed so that eligible households are those for which <code>selben</code> is negative), <code>treated</code>, which is a dummy for households which receive the grant and <code>attendmonth</code>, which is the monthly frequency of visits to the church. First, we investigate whether the discontinuity is sharp or fuzzy, by computing the percentage of recipients for households under and over the threshold:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bdh</span> <span class="op">&lt;-</span> <span class="va">bdh</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>eligible <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">selben</span> <span class="op">&lt;</span> <span class="fl">0</span>, <span class="st">"yes"</span>, <span class="st">"no"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">bdh</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">count</span><span class="op">(</span><span class="va">eligible</span>, <span class="va">treated</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">eligible</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">n</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">pivot_wider</span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">eligible</span>, values_from <span class="op">=</span> <span class="va">n</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 3
  treated     no   yes
    &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
1       0 0.971  0.144
2       1 0.0292 0.856</code></pre>
</div>
</div>
<p>The discontinuity is therefore fuzzy, as about 3% of the eligible households don’t receive the grant and, on the contrary, about 14% of the recipients are not eligible. </p>
</section><section id="plotting-the-discontinuity" class="level3"><h3 class="anchored" data-anchor-id="plotting-the-discontinuity">Plotting the discontinuity</h3>
<p>The plot is obtained by defining bins for the forcing variable, computing the mean of the outcome for each bin, plotting the points and adding a smoothing line. The <strong>micsr</strong> package provides the convenient <code>geom_binmeans</code> function to compute and plot the mean of the response for bins of <span class="math inline">\(x\)</span> (see <a href="#fig-binmeans">Figure&nbsp;<span>8.3</span></a>). </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">probation</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">distcut</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span><span class="va">distcut</span>, <span class="va">gpa2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_binmeans</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>size <span class="op">=</span> <span class="fu">after_stat</span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span>, shape <span class="op">=</span> <span class="fl">21</span>,</span>
<span>                  center <span class="op">=</span> <span class="fl">0</span>, width <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_smooth</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>linetype <span class="op">=</span> <span class="va">probation</span><span class="op">)</span>,</span>
<span>                method <span class="op">=</span> <span class="st">"lm"</span>, se <span class="op">=</span> <span class="cn">FALSE</span>, color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-binmeans" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="treateff_files/figure-html/fig-binmeans-1.png" class="img-fluid figure-img" style="width:60.0%"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;8.3: Discontinuity for probation</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Two arguments of <code>geom_binmeans</code> are used: <code>center</code> to indicate the cutoff and <code>width</code> the width of the bins. The internal variable <code>n</code> is used to visualize the number of observations in every bin. Note the use of <code>after_stat</code>: <code>geom_binmeans</code> uses as stat <code>bins</code>, ie, it creates bins and counts the number of observations in each bin. This count (called <code>n</code>) is used in <code>geom_smooth</code> after the stat has been computed. For <code>geom_smooth</code> we use <code>probation</code> for the <code>linetype</code> aesthetic, so that two different smoothing lines are plotted on both sides of the cutoff. The effect of the treatment is then the difference of intercepts for the two regression lines. It is about 0.25 points of gpa in our example.</p>
<!-- In the context of a fuzzy discontinuity, the same plot can be used -->
<!-- with the treatment variable, to see the strength of the forcing variable -->
<!-- on the treatment (see @fig-fuzzy). -->
<!-- A placebo test consists on applying the same visual techniques to -->
<!-- variables that shouldn't be impacted by the discontinuity. For the -->
<!-- probation data set, we use high school grade percentile, age, gender -->
<!-- and first language; the last two variables being factors, we first -->
<!-- coerce them to binary variables (see @fig-placebo). -->
<!-- ```{r } -->
<!-- #| warning: false -->
<!-- #| label: fig-placebo -->
<!-- #| fig-cap: Placebo tests for the probation data set -->
<!-- probation %>% -->
<!--     filter(abs(distcut) < 1.5) %>%  -->
<!--     select(hsgrade, gender, flang, age, distcut, probation) %>% -->
<!--     mutate(gender = ifelse(gender == "female", 1, 0), -->
<!--            flang = ifelse(flang == "english", 1, 0)) %>% -->
<!--     pivot_longer(- c(distcut,  probation)) %>%  -->
<!--     ggplot(aes(distcut, value)) + -->
<!--     geom_binmeans(aes(size = after_stat(n)), shape = 21, -->
<!--                   center = 0, width = 0.2) + -->
<!--     geom_smooth(aes(linetype = factor(probation)), -->
<!--                 method = "lm", se = FALSE, fullrange = FALSE) + -->
<!--     facet_wrap(~ name, scales = "free") + -->
<!--     scale_size_continuous(range = c(1, 3)) -->
<!-- ``` -->
<p>The <code><a href="https://rdrr.io/pkg/rdrobust/man/rdplot.html">rdrobust::rdplot</a></code> function performs the same task (see <a href="#fig-rdplot">Figure&nbsp;<span>8.4</span></a>). There are numerous options available to customize the graphic, described in details in <span class="citation" data-cites="CALI:CATT:TITI:15">Calonico, Cattaneo, and Titiunik (<a href="#ref-CALI:CATT:TITI:15" role="doc-biblioref">2015</a>)</span>. </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">rdrobust</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">probation</span>, <span class="fu"><a href="https://rdrr.io/pkg/rdrobust/man/rdplot.html">rdplot</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">gpa2</span>, x <span class="op">=</span> <span class="va">distcut</span>, nbins <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-rdplot" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="treateff_files/figure-html/fig-rdplot-1.png" class="img-fluid figure-img" style="width:60.0%"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;8.4: Discontinuity for probation using <code>rdplot</code></figcaption><p></p>
</figure>
</div>
</div>
</div>
<p> Placebo tests consist of applying the same visual techniques to variables that shouldn’t be impacted by the discontinuity. In <a href="#fig-disc_hsg">Figure&nbsp;<span>8.5</span></a>, we plot the high school grade percentile and we can see that there is no clear discontinuity for this variable around the threshold. </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">probation</span>, <span class="fu"><a href="https://rdrr.io/pkg/rdrobust/man/rdplot.html">rdplot</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">hsgrade</span>, x <span class="op">=</span> <span class="va">distcut</span>, nbins <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-disc_hsg" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="treateff_files/figure-html/fig-disc_hsg-1.png" class="img-fluid figure-img" style="width:60.0%"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;8.5: Placebo test for probation</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p><strong>rdrobust</strong>’s functions don’t have a data argument. Therefore, series should be provided, and we could have written the previous expression as: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/rdrobust/man/rdplot.html">rdplot</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">probation</span><span class="op">$</span><span class="va">hsgrade</span>, x <span class="op">=</span> <span class="va">probation</span><span class="op">$</span><span class="va">distcut</span>, nbins <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Using <code>with(data, expression)</code>, series of <code>data</code> can be called directly in <code>expression</code> without prefixing them by <code>probation$</code>.</p>
</section><section id="computing-the-effect-of-the-treatment" class="level3"><h3 class="anchored" data-anchor-id="computing-the-effect-of-the-treatment">Computing the effect of the treatment</h3>
<p>As seen previously, the effect of the eligibility (and the effect of the treatment if the discontinuity is sharp) is the difference between the intercepts of two smoothing lines, which can be obtained using OLS or some more complicated fitting tools like local polynomials. In the simplest case, it is given by the estimation of <span class="math inline">\(\beta_t\)</span> in the following regression, <span class="math inline">\(t_n\)</span> being the treatment variable and <span class="math inline">\(x_n\)</span> the forcing variable:</p>
<p><span class="math display">\[
y_n = \beta_0 + \beta_t t_n + \beta_x x_n + \beta_{xt} x_n t_n + \epsilon_n
\]</span></p>
<p>Note that the presence of <span class="math inline">\(\beta_{xt}\)</span> allows to have different slopes on both sides of the cutoff. Two crucial choices have to be made while estimating the effect of the treatment: the <strong>bandwidth</strong>, i.e., the range of values of the forcing variable used in the estimation and the degree of smoothness of the fitting line. A larger bandwidth leads to a more efficient estimator (as the number of observations is higher), but the estimation may be biased as the sample contains observations not close enough to the cutoff. We first regress the outcome on the forcing variable interacted with the treatment variable (note the use of the <code>*</code> operator in the formula), with a bandwidth of <span class="math inline">\(1.5\)</span>: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">gpa2</span> <span class="op">~</span> <span class="va">distcut</span> <span class="op">*</span> <span class="va">probation</span>, <span class="va">probation</span>,</span>
<span>   subset <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">distcut</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">gaze</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                     Estimate Std. Error t value Pr(&gt;|t|)
distcut                0.7036     0.0119   59.05   &lt;2e-16
probationyes           0.2554     0.0199   12.86   &lt;2e-16
distcut:probationyes   0.0997     0.0306    3.25   0.0011</code></pre>
</div>
</div>
<p>The coefficient of <code>probationyes</code> is highly significant; students just under the cutoff and who therefore benefit from probation have a subsequent GPA higher by one-quarter of a point. The interaction term is also positive, indicating that the slope of the regression line is higher on the right of the cutoff than on the left. To check the robustness of this result, we change the bandwidth and add a quadratic term in the forcing variable. </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">gpa2</span> <span class="op">~</span> <span class="va">distcut</span> <span class="op">*</span> <span class="va">probation</span>, <span class="va">probation</span>,</span>
<span>   subset <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">distcut</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  <span class="fu">gaze</span><span class="op">(</span>coef <span class="op">=</span> <span class="st">"probationyes"</span><span class="op">)</span></span>
<span><span class="co">##              Estimate Std. Error t value Pr(&gt;|t|)</span></span>
<span><span class="co">## probationyes   0.2266     0.0342    6.62  3.7e-11</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">gpa2</span> <span class="op">~</span> <span class="op">(</span><span class="va">distcut</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="va">distcut</span> <span class="op">^</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="va">probation</span>, <span class="va">probation</span>,</span>
<span>   subset <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">distcut</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  <span class="fu">gaze</span><span class="op">(</span>coef <span class="op">=</span> <span class="st">"probationyes"</span><span class="op">)</span></span>
<span><span class="co">##              Estimate Std. Error t value Pr(&gt;|t|)</span></span>
<span><span class="co">## probationyes   0.1941     0.0289    6.71    2e-11</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">gpa2</span> <span class="op">~</span> <span class="op">(</span><span class="va">distcut</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="va">distcut</span> <span class="op">^</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="va">probation</span>, <span class="va">probation</span>,</span>
<span>   subset <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">distcut</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>  <span class="fu">gaze</span><span class="op">(</span>coef <span class="op">=</span> <span class="st">"probationyes"</span><span class="op">)</span></span>
<span><span class="co">##              Estimate Std. Error t value Pr(&gt;|t|)</span></span>
<span><span class="co">## probationyes   0.2197     0.0512    4.29  1.8e-05</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Depending on the specification, the coefficient varies from 0.19 to 0.26. The <strong>rdrobust</strong> package provides the <code>rdrobust</code> function which computes the treatment effect using local polynomials. The degree of the polynomial is controlled with the <code>p</code> argument (the default is 1) and the bandwidth with the <code>h</code> argument. If the bandwidth is not indicated, it is automatically computed internally using the <code>rdbwselect</code> function. </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">probation</span>, <span class="fu"><a href="https://rdrr.io/pkg/rdrobust/man/rdrobust.html">rdrobust</a></span><span class="op">(</span><span class="va">gpa2</span>, <span class="va">distcut</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">gaze</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Bandwidth (N used)     : 0.457 (8592)
coefficient (se)       : -0.222 (0.039)
Conv. stat (p-value)   : -5.707 (0.000)
Robust. stat (p-value) : -4.595 (0.000)</code></pre>
</div>
</div>
<p>The bandwidth is 0.457 (as the initial range of the forcing variable is <span class="math inline">\([-1.6, 2.8]\)</span>) and 8592 observations are used out of 44311 in the <code>probation</code> data set. Besides the standard t statistic, <code>rdrobust</code> computes a robust statistic, which is slightly lower than the conventional statistic. When the discontinuity is fuzzy, the effect of the treatment is computed using two stage least squares, the eligibility status being an instrument for treatment. </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bdh</span> <span class="op">&lt;-</span> <span class="va">bdh</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>eligible <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">selben</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">ivreg</span><span class="fu">::</span><span class="fu"><a href="https://zeileis.github.io/ivreg/reference/ivreg.html">ivreg</a></span><span class="op">(</span><span class="va">attendmonth</span> <span class="op">~</span> <span class="va">selben</span> <span class="op">*</span> <span class="va">treated</span> <span class="op">|</span> <span class="va">selben</span> <span class="op">*</span> <span class="va">eligible</span>, </span>
<span>             data <span class="op">=</span> <span class="va">bdh</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">gaze</span><span class="op">(</span>coef <span class="op">=</span> <span class="st">"treated"</span><span class="op">)</span></span>
<span><span class="co">##         Estimate Std. Error t value Pr(&gt;|t|)</span></span>
<span><span class="co">## treated    1.722      0.598    2.88    0.004</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The effect of receiving the grant increases monthly church attendance by 1.72, and the effect is significant. The <code>rdrobust</code> function can be used in a fuzzy discontinuity context using the <code>fuzzy</code> argument to indicate the treatment variable. A matrix of supplementary covariates can be added using the <code>covs</code> argument. </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">bdh</span>, <span class="fu"><a href="https://rdrr.io/pkg/rdrobust/man/rdrobust.html">rdrobust</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">attendmonth</span>, x <span class="op">=</span> <span class="va">selben</span>, fuzzy <span class="op">=</span> <span class="va">treated</span>,</span>
<span>                   covs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">age</span>, <span class="va">hsize</span>, <span class="va">schooling</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">gaze</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Bandwidth (N used)     : 1.851 (1114)
coefficient (se)       : 2.072 (0.918)
Conv. stat (p-value)   : 2.257 (0.024)
Robust. stat (p-value) : 2.124 (0.034)</code></pre>
</div>
</div>
<p>As the <code>h</code> argument is not specified, the bandwidth is automatically computed and is 1.851, and the number of observation used is 1114 out of 2645 in the original data set. The coefficient of <code>treatment</code> is 2.07 (slightly higher than the one obtained previously), and the conventional and the robust tests indicate that the coefficient is significant at the 5% level. </p>
</section><section id="manipulation-test" class="level3"><h3 class="anchored" data-anchor-id="manipulation-test">Manipulation test</h3>
<p> A critical hypothesis of regression discontinuity designs is that individuals are set randomly on both sides of the cutoff. On the contrary, individuals being aware of the existence of the treatment and of the value of the cutoff may manipulate their value of the forcing variable in order to be on one specific side of the cutoff. In this case, the distribution of the forcing variable should also exhibit a discontinuity at the cutoff. The first manipulation test was proposed by <span class="citation" data-cites="MCCR:08">McCrary (<a href="#ref-MCCR:08" role="doc-biblioref">2008</a>)</span>. The <code>rddensity:rddensity</code> function performs an extension of this test. </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">rddensity</span><span class="op">)</span></span>
<span><span class="va">dens_test</span> <span class="op">&lt;-</span> <span class="va">probation</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">pull</span><span class="op">(</span><span class="va">distcut</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">rddensity</span></span>
<span><span class="va">dens_test</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">gaze</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Bandwith (left-right)     : 0.609-0.827
Observations (left-right) : 4448-12049
Statistic (p-value)       : 0.764 (0.445)</code></pre>
</div>
</div>
<p>The p-value being equal to <span class="math inline">\(0.45\)</span>, the absence of manipulation is not rejected. The <code>rddensity:rdplotdensity</code> function plots the density on the left and on the right of the cutoff, with a confidence interval; if the two confidence intervals overlaps, the hypothesis of no manipulation is not rejected. This is the case with the <code>probation</code> data set, as shown in <a href="#fig-maniptest">Figure&nbsp;<span>8.6</span></a>. </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ra</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rddensity/man/rdplotdensity.html">rdplotdensity</a></span><span class="op">(</span><span class="va">dens_test</span>, <span class="va">probation</span><span class="op">$</span><span class="va">distcut</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-maniptest" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="treateff_files/figure-html/fig-maniptest-1.png" class="img-fluid figure-img" style="width:60.0%"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;8.6: Density estimation on both sides of the cutoff for the <code>probation</code> data set</figcaption><p></p>
</figure>
</div>
</div>
</div>
<div style="page-break-after: always;"></div>
</section></section><section id="sec-diff_diff" class="level2" data-number="8.4"><h2 data-number="8.4" class="anchored" data-anchor-id="sec-diff_diff">
<span class="header-section-number">8.4</span> Difference-in-differences</h2>
<p> Sometimes, the outcome is observed for two periods. In the first period, the treatment hasn’t been implemented. For the second period, some individuals have been treated (the treatment group), as some individuals haven’t (the control group). The effect of the treatment can then be estimated by:</p>
<p><span id="eq-diff_diff"><span class="math display">\[
\frac{\sum_{n \in T} (y_{n2} - y_{n1})}{N_T} - \frac{\sum_{n \in C} (y_{n2} - y_{n1})}{N_C}
\tag{8.7}\]</span></span></p>
<p>Each term is the mean difference of the outcome between the two periods for the two groups, and the estimator is the difference of these differences. Consider as an example that the treatment is a job-training program implemented in 2021 and that the outcome is wage observed in 2022. If the first term of <a href="#eq-diff_diff">Equation&nbsp;<span>8.7</span></a> is $1000, this means that the average annual wage in the treatment group increased by $1000 in 2022 compared to 2021. This would be a relevant estimator of the effect of the program if nothing had changed on the labor market in 2022 compared to 2021. But if the economic situation improved, then the average wages will increase even for those who haven’t been treated. This is measured by the second term in <a href="#eq-diff_diff">Equation&nbsp;<span>8.7</span></a> (say $600). Therefore, the effect of the treatment is the difference between the two terms, which is $400.</p>
<p>As an example, <span class="citation" data-cites="DITE:SCHA:04">Di Tella and Schargrodsky (<a href="#ref-DITE:SCHA:04" role="doc-biblioref">2004</a>)</span> sought to estimate the causal effect of police on crime. This task is difficult using non-experimental data, as there may be a reverse causality relationship between police and crime: more police reduces crime (negative causal relationship), but an increase in crime may lead authorities to increase police (positive reverse causal relationship). In July 18, 1994, a terrorist attack destroyed the main Jewish-owned center in Buenos Aires, Argentina, killing 85 people, and the federal government decided to provide 24 hour police protection to Jewish-owned institutions. <span class="citation" data-cites="DITE:SCHA:04">Di Tella and Schargrodsky (<a href="#ref-DITE:SCHA:04" role="doc-biblioref">2004</a>)</span> collected data on three “barrios” in Buenos Aires at the block level on a monthly basis. The outcome of interest is the number of car thefts. Denoting <span class="math inline">\(x\)</span> as a dummy equal to 1 if the block contains or is close to a Jewish institution and <span class="math inline">\(p\)</span> a dummy equal to 1 after the attack, the treatment effect is, in a regression context, the estimate of <span class="math inline">\(\theta\)</span> on the following equation:</p>
<p><span class="math display">\[
y_{nt} = \beta_0 + \beta_x x_{n} + \beta_p p_{nt} + \theta x_{n} p_{nt} + \epsilon_{nt}
\]</span></p>
<p>with <span class="math inline">\(t=1, 2\)</span>, (the periods before and after the attack). The <code>car_thefts</code> data set contains repeated observations of car thefts (<code>thefts</code>) for 876 blocks. Each block is observed 10 times on a monthly basis, and the month of the attack (July) is split into two half-month observations.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">car_thefts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 8,760 × 8
  block date       barrio calle   distance thefts period  days
  &lt;dbl&gt; &lt;date&gt;     &lt;chr&gt;  &lt;chr&gt;   &lt;fct&gt;     &lt;dbl&gt; &lt;fct&gt;  &lt;dbl&gt;
1   870 1994-04-01 Once   Cordoba one           0 before    30
2   851 1994-04-01 Once   Tucuman two           0 before    30
3   843 1994-04-01 Once   Lavalle same          0 before    30
# ℹ 8,757 more rows</code></pre>
</div>
</div>
<p>We first compute the total number of thefts (<code>thefts</code>) before and after the attack for all the blocks. As the two periods are of unequal length (3.5 and 4.5 months), we divide the number of thefts for the two periods by the corresponding number of days and we multiply by 30.5 to get a monthly value. </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">two_obs</span> <span class="op">&lt;-</span> <span class="va">car_thefts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">block</span>, <span class="va">period</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">summarise</span><span class="op">(</span>thefts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">thefts</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">days</span><span class="op">)</span> <span class="op">*</span> <span class="fl">30.5</span>, </span>
<span>              .groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">two_obs</span><span class="op">$</span><span class="va">thefts</span><span class="op">)</span></span>
<span><span class="co">## [1] 0.09328</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The number of monthly theft per block is about 0.09. <code>distance</code> is a factor indicating the distance from the block to the nearest Jewish-owned institution: its levels are <code>"same"</code> (same block), <code>"one"</code>, <code>"two"</code> and <code>"&gt;2"</code> (one block, two blocks or more than two blocks). We add this variable to <code>two_obs</code> by selecting <code>distance</code> and <code>block</code> in the original data frame, selecting only the distinct rows (one per block) and joining it to <code>two_obs</code>: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">two_obs</span> <span class="op">&lt;-</span> <span class="va">two_obs</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="fu">distinct</span><span class="op">(</span><span class="va">car_thefts</span>, <span class="va">block</span>, <span class="va">distance</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We then compute the regression by coercing the <code>distance</code> to a dummy for the same block: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">two_obs</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>distance <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">distance</span> <span class="op">==</span> <span class="st">"same"</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span>formula <span class="op">=</span> <span class="va">thefts</span> <span class="op">~</span> <span class="va">period</span> <span class="op">*</span> <span class="va">distance</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">gaze</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                     Estimate Std. Error t value Pr(&gt;|t|)
periodafter           0.01055    0.00645    1.64    0.102
distance              0.00898    0.02218    0.40    0.686
periodafter:distance -0.07232    0.03137   -2.31    0.021</code></pre>
</div>
</div>
<p>The effect of police on thefts is <span class="math inline">\(-0.07\)</span>, which is very high as the average number of monthly theft per block is 0.09 and it is significant. The same difference-in-differences estimator can be obtained by computing a t-test of equality of the two means. We first reshape the data set in order to have one line per block, and we compute the after-before difference: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">diffs</span> <span class="op">&lt;-</span> <span class="va">two_obs</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>distance <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">distance</span> <span class="op">==</span> <span class="st">"same"</span>, <span class="st">"yes"</span>, <span class="st">"no"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">pivot_wider</span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">period</span>, values_from <span class="op">=</span> <span class="va">thefts</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>dt <span class="op">=</span> <span class="va">after</span> <span class="op">-</span> <span class="va">before</span><span class="op">)</span></span>
<span><span class="va">diffs</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 876 × 5
  block distance before  after     dt
  &lt;dbl&gt; &lt;chr&gt;     &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
1     1 no        0     0       0    
2     2 no        0     0.224   0.224
3     3 no        0.290 0.0449 -0.246
# ℹ 873 more rows</code></pre>
</div>
</div>
<p> and we then use the <code>t.test</code> function: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/t.test.html">t.test</a></span><span class="op">(</span><span class="va">dt</span> <span class="op">~</span> <span class="va">distance</span>, <span class="va">diffs</span>, var.equal <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">gaze</span></span>
<span><span class="co">## diff = 0.072 (0.026), t = 2.739, df: 874, pval = 0.006</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The difference-in-differences can be extended to the case where the observation units before and after the implementation of the treatment are not the same. This is the case in <span class="citation" data-cites="HONG:13">Hong (<a href="#ref-HONG:13" role="doc-biblioref">2013</a>)</span>’, which studied the impact of the introduction of Napster on music expenditure. The study is based on the Consumer Expenditure Survey, which is performed on a quarterly basis, and the data set is called <code>napster</code>. Napster was introduced in June 1999 and became the dominant file-sharing service. Households with (without) internet access constitute the treatment (control) group. From the <code>date</code> series, we construct a <code>period</code> variable using June 1999 as the cutoff: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">napster</span> <span class="op">&lt;-</span> <span class="va">napster</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">date</span>, <span class="va">expmusic</span>, <span class="va">internet</span>, <span class="va">weight</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>period <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">date</span> <span class="op">&lt;</span> <span class="fu">ymd</span><span class="op">(</span><span class="st">"1999-06-01"</span><span class="op">)</span>, <span class="st">"before"</span>, <span class="st">"after"</span><span class="op">)</span>,</span>
<span>           period <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">period</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"before"</span>, <span class="st">"after"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">napster</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 107,650 × 5
  date       expmusic internet weight period
  &lt;date&gt;        &lt;dbl&gt; &lt;fct&gt;     &lt;dbl&gt; &lt;fct&gt; 
1 1997-05-01        0 no       27471. before
2 1997-06-01        0 yes      23567. before
3 1997-06-01        0 no       26211. before
# ℹ 107,647 more rows</code></pre>
</div>
</div>
<p>we then proceed to the estimation, with <code>expmusic</code>, the expenditures on recorded music as a response: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">expmusic</span> <span class="op">~</span> <span class="va">period</span> <span class="op">*</span> <span class="va">internet</span>, <span class="va">napster</span>, weight <span class="op">=</span> <span class="va">weight</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">gaze</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                        Estimate Std. Error t value Pr(&gt;|t|)
periodafter               -1.749      0.253   -6.91    5e-12
internetyes               14.781      0.432   34.23   &lt;2e-16
periodafter:internetyes   -4.589      0.552   -8.32   &lt;2e-16</code></pre>
</div>
</div>
<p><code>internetyes</code> has a strong positive effect on expenditure. The interaction term between <code>period</code> and <code>internet</code> indicates that, the deployment of Napster led to a significant reduction of the expense for the “treated” individuals (those who have internet access) of $4.6. </p>
</section><section id="sec-matching" class="level2" data-number="8.5"><h2 data-number="8.5" class="anchored" data-anchor-id="sec-matching">
<span class="header-section-number">8.5</span> Matching</h2>
<p></p>
<p>The fundamental problem of estimating the treatment effect on observational data is that the treatment and the control sample are not drawn from the same population, so that average (observable or non-observable) characteristics are not the same. The idea of matching is to select, for each treated observation, an observation in the control group as similar as possible, based on observed characteristics. If it is possible to do it for all the observations in the treatment group, the resulting sample would be similar to experimental data, i.e., a sample with treated and control observations drawn from the same population. When there are few covariates which take a small number of different values, it is possible to find in the control group an observation which has exactly the same observed characteristics than a treated observation (for example, a man aged 25 with 12 years of education). On the contrary, with numerous and/or continuous covariates, it is impossible to match a treated observation with an exactly similar observation in the control group.</p>
<p>In this case, the dimension of the problem is reduced to one using a <strong>propensity score</strong> estimator. The propensity score is the conditional probability (given <em>x</em>) of being treated. It can be fitted using for example a logit or a probit, the response being a dummy for treated individuals. Then, each treated individual is matched with the observation in the control group which has the closest propensity score. Finally, the estimation of the treatment effect is performed on the subset of the sample composed by all the observations of the treatment group and those of the control group that match these observations.</p>
<p>The matching estimator was first proposed by <span class="citation" data-cites="ROSE:RUBI:83">Rosenbaum and Rubin (<a href="#ref-ROSE:RUBI:83" role="doc-biblioref">1983</a>)</span> and the interest in matching methods in econometrics really started with the articles of Dehejia and Wahba <span class="citation" data-cites="DEHE:WAHB:99 DEHE:WAHB:02">(<a href="#ref-DEHE:WAHB:99" role="doc-biblioref">1999</a>, <a href="#ref-DEHE:WAHB:02" role="doc-biblioref">2002</a>)</span>. These two articles revisited the results of <span class="citation" data-cites="LALO:86">LaLonde (<a href="#ref-LALO:86" role="doc-biblioref">1986</a>)</span> who showed that the estimation of treatment effect with observational data can be seriously biased. Using Lalonde’s data, they showed that matching methods can be used to estimate consistently treatment effects on observational data. They also proposed an algorithm, implemented in <strong>Stata</strong> by <span class="citation" data-cites="BECK:ICHI:02">Ichino (<a href="#ref-BECK:ICHI:02" role="doc-biblioref">2002</a>)</span>: </p>
<ul>
<li>first compute the propensity scores using a probit or a logit model with a rich set of covariates, eventually with squares and interactions between covariates,</li>
<li>start with a small number of strata, for example 5 (0-0.2, 0.2-0.4, …, 0.8-1), and test for each strata the hypothesis that the means of the scores are equal in the two groups,</li>
<li>if the test fails for one strata, split it in two (for example, the 0.2-0.4 strata is decomposed in two stratas 0.2-0.3 and 0.3-0.4) until the equal mean hypothesis is not rejected for every strata,</li>
<li>then compute the same test for each covariate,</li>
<li>if the test fails for some covariates, estimate a more flexible propensity score model, adding squares and interactions between covariates.</li>
</ul>
<p>Once the stratas are computed, a natural estimator of the treatment effect is: <span class="math inline">\(\sum_k (\bar{y}_k^t - \bar{y}_k ^ c) f_k\)</span>, where <span class="math inline">\(\bar{y}_k ^ t\)</span> and <span class="math inline">\(\bar{y}_k ^ c\)</span> are the mean values of the outcome in the treatment and in the control group and <span class="math inline">\(f_k = t_k / N_T\)</span> is the frequency of strata <span class="math inline">\(k\)</span> for the treatment group (with <span class="math inline">\(t_k\)</span> the number of treated individuals in strata <span class="math inline">\(k\)</span> and <span class="math inline">\(N_T\)</span> the total number of treated individuals). The variance of the estimated treatment effect can be computed with or without the hypothesis of equal variance between stratas, between groups or both.</p>
<p>As an example, we replicate the results of <span class="citation" data-cites="ICHI:MEAL:NANN:08">Ichino, Mealli, and Nannicini (<a href="#ref-ICHI:MEAL:NANN:08" role="doc-biblioref">2008</a>)</span> who studied the effect of temporary work agency (TWA) jobs on the probability of finding a stable job. The data set, called <code>twa</code>, contains <span class="math inline">\(2030\)</span> observations (<span class="math inline">\(511\)</span> treated and <span class="math inline">\(1519\)</span> untreated) for two regions, Tuscany and Sicily. We restrict the sample to Tuscany: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tuscany</span> <span class="op">&lt;-</span> <span class="va">twa</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">region</span> <span class="op">==</span> <span class="st">"Tuscany"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There are <span class="math inline">\(281\)</span> observations in the treatment group and <span class="math inline">\(628\)</span> in the control group. The group variable <code>group</code> is a factor with levels <code>"control"</code> and <code>"treatment"</code>, and the outcome is also a factor indicating the employment status one year after the program. Its levels are <code>none</code> (no job), <code>other</code>, <code>fterm</code> for fixed-term contract and <code>perm</code> for a permanent contract. Following the authors, we define the outcome of interest as a dummy for a permanent contract: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tuscany</span> <span class="op">&lt;-</span> <span class="va">tuscany</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>perm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">outcome</span> <span class="op">==</span> <span class="st">"perm"</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To get a first idea of the treatment effect, we compute the mean of <code>perm</code> for the two groups: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tuscany</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">group_by</span><span class="op">(</span><span class="va">group</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">summarise</span><span class="op">(</span>n <span class="op">=</span> <span class="fu">n</span><span class="op">(</span><span class="op">)</span>, outcome <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">perm</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 3
  group       n outcome
  &lt;fct&gt;   &lt;int&gt;   &lt;dbl&gt;
1 control   628   0.166
2 treated   281   0.313</code></pre>
</div>
</div>
<p>The proportion of individuals who have a permanent job is 31.3% for the treated group and 16.6% for the control group and the apparent treatment effect is therefore 14.7%. The <code><a href="https://rdrr.io/pkg/micsr/man/pscore.html">micsr::pscore</a></code> function implements the algorithm previously described. The first two arguments are <code>formula</code> and <code>data</code>. The formula should have two variables on the left-hand side, the first indicating the outcome and the second the group. The group variable can be either a dummy or a factor with two levels, the second indicating the treated individuals. To estimate the propensity score, we use the same formula as <span class="citation" data-cites="ICHI:MEAL:NANN:08">Ichino, Mealli, and Nannicini (<a href="#ref-ICHI:MEAL:NANN:08" role="doc-biblioref">2008</a>)</span>, and in particular, we use a square term for the distance to the next agency and an interaction between self-employed status and the city of Livorno: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tuscany</span> <span class="op">&lt;-</span> <span class="va">tuscany</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>dist2 <span class="op">=</span> <span class="va">dist</span> <span class="op">^</span> <span class="fl">2</span>,</span>
<span>           livselfemp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="op">(</span><span class="va">city</span> <span class="op">==</span> <span class="st">"livorno"</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">occup</span> <span class="op">==</span> <span class="st">"selfemp"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>           perm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">outcome</span> <span class="op">==</span> <span class="st">"perm"</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ftusc</span> <span class="op">&lt;-</span> <span class="va">perm</span> <span class="op">+</span> <span class="va">group</span> <span class="op">~</span> <span class="va">city</span> <span class="op">+</span> <span class="va">sex</span> <span class="op">+</span> <span class="va">marital</span> <span class="op">+</span> <span class="va">age</span> <span class="op">+</span></span>
<span>    <span class="va">loc</span> <span class="op">+</span> <span class="va">children</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> <span class="va">pvoto</span> <span class="op">+</span> <span class="va">training</span> <span class="op">+</span></span>
<span>    <span class="va">empstat</span> <span class="op">+</span> <span class="va">occup</span> <span class="op">+</span> <span class="va">sector</span> <span class="op">+</span> <span class="va">wage</span> <span class="op">+</span> <span class="va">hour</span> <span class="op">+</span> <span class="va">feduc</span> <span class="op">+</span> <span class="va">femp</span> <span class="op">+</span> <span class="va">fbluecol</span> <span class="op">+</span></span>
<span>    <span class="va">dist</span> <span class="op">+</span> <span class="va">dist2</span> <span class="op">+</span> <span class="va">livselfemp</span></span>
<span><span class="va">ps</span> <span class="op">&lt;-</span> <span class="fu">pscore</span><span class="op">(</span><span class="va">ftusc</span>, <span class="va">tuscany</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Three supplementary arguments of <code>pscore</code> can be used: the maximum number of iterations (default 4), the tolerance level for the t-tests (default 0.005) and the link for the binomial model (default to logit). For the tolerance level, <span class="citation" data-cites="BECK:ICHI:02">Ichino (<a href="#ref-BECK:ICHI:02" role="doc-biblioref">2002</a>)</span> advised to use a low level with the following argument: with for example 20 covariates, using a 5% level, if the tests are mutually independent, the probability that one of the tests rejects the balancing property, although it holds, is 37%. <code>pscore</code> returns a <code>pscore</code> object which contains three tibbles.</p>
<ul>
<li>
<code>strata</code> contains information about the stratas (the frequencies, the average propensity scores and the probability value of the hypothesis of no difference of the propensity scores in the two groups),</li>
<li>
<code>cov_balance</code> has a line for every covariate and contains the strata for which the probability value is the smallest,</li>
<li>
<code>model</code> contains the original data sets with some supplementary columns:
<ul>
<li>
<code>pscore</code> contains the propensity score for every observation,</li>
<li>
<code>.gp</code> is a factor with levels <code>"control"</code> and <code>"treated"</code>,</li>
<li>
<code>.cs</code> is a boolean indicating whether the propensity score for an observation lies in the interval of scores for the treated,</li>
<li>
<code>.resp</code> contains the response,</li>
<li>
<code>.cls</code> indicates the strata for the observation.</li>
</ul>
</li>
</ul>
<p>A <code>summary</code> method is provided and the <code>print</code> method for <code>summary.pscore</code> objects has a <code>step</code> argument that allows to print the result of each step of the estimator. To get the information about the stratas, we use:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ps</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">summary</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span>step <span class="op">=</span> <span class="st">"strata"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>

=========  =========  =========  ==========  ==========  =======
strata     n_treated  n_control  ps_treated  ps_control  p.value
=========  =========  =========  ==========  ==========  =======
[0,0.1)           11        217       0.065       0.053    0.122
[0.1,0.2)         24        138       0.153       0.151    0.843
[0.2,0.4)         60        118       0.291       0.294    0.783
[0.4,0.6)         60         81       0.497       0.501    0.632
[0.6,0.7)         35         21       0.668       0.646    0.006
[0.7,0.8)         56         14       0.754       0.745    0.292
[0.8,1)           35          3       0.837       0.850    0.375
=========  =========  =========  ==========  ==========  =======</code></pre>
</div>
</div>
<p>Two of the initial stratas were cut in halves (0-0.2 and 0.6-0.8). The control subsample is restricted to the range of the values of the propensity score for the treated; therefore, only 592 observations of the control group out of 628 are used. With <code>step = "covariates"</code>, we get a (long) table indicating, for each covariate, the results of the balance test between the treatment and the control group:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ps</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">summary</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span>step <span class="op">=</span> <span class="st">"covariates"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, <code>step = "atet"</code> gives the values of the estimated ATET (average treatment effect of the treated) and different estimates of its standard deviation:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ps</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">summary</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span>step <span class="op">=</span> <span class="st">"atet"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>ATET                        : 0.1769 
sd: equal variance
  - within groups           : 0.04603 
  - within strata           : 0.04879 
  - within groups and strata: 0.04713 
  - no                      : 0.03543 </code></pre>
</div>
</div>
<p>The estimated treatment effect is <span class="math inline">\(0.177\)</span>, which is slightly higher than the treatment effect computed with the whole sample which was 14.7%. It is highly significant with the different flavors of the standard deviations ranging from <span class="math inline">\(0.035\)</span> to <span class="math inline">\(0.049\)</span>.</p>
<p>An alternative to using strata and computing the ATET as a weighted average of the difference of the mean of the outcome between treated and control observations in each stratum is to match each treated observation to one or several observations in the control group. The simplest algorithm consists of selecting, for every treated observation, the control observation which has the closest value of propensity score. Using the <code>model</code> tibble returned by <code>pscore</code>, we begin with constructing two tibbles, one for the treatment group and one for the control group, containing only the index of the observation and the value of the propensity score: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tusc_tr</span> <span class="op">&lt;-</span> <span class="va">ps</span><span class="op">$</span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">group</span> <span class="op">==</span> <span class="st">"treated"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>id_tr <span class="op">=</span> <span class="va">id</span>, ps_tr <span class="op">=</span> <span class="va">pscore</span><span class="op">)</span></span>
<span><span class="va">tusc_ctl</span> <span class="op">&lt;-</span> <span class="va">ps</span><span class="op">$</span><span class="va">model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">group</span> <span class="op">==</span> <span class="st">"control"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>id_ctl <span class="op">=</span> <span class="va">id</span>, ps_ctl <span class="op">=</span> <span class="va">pscore</span><span class="op">)</span></span>
<span><span class="va">tusc_tr</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 281 × 2</span></span>
<span><span class="co">##   id_tr ps_tr</span></span>
<span><span class="co">##   &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">## 1   214 0.148</span></span>
<span><span class="co">## 2   310 0.134</span></span>
<span><span class="co">## # ℹ 279 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We then need to join the two tables, and <strong>dplyr</strong> provides functions that perform mutating joins. Among them, the <code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">dplyr::left_join</a></code> function is appropriate, as it returns all the rows of the “left” table (the treatment group <code>tusc_tr</code>) and only those of the “right” table that match. Standard use of mutating joins are based on equality of one or several joining variables, but <strong>dplyr</strong> (since its version 1.1.0) performs also <strong>inequality</strong> and <strong>rolling</strong> joins. With inequality joins, one can for example match a treated observation with all the observations in the control group with higher propensity scores. We do it below only for the first two treated observations: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tusc_tr</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">slice</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">left_join</span><span class="op">(</span><span class="va">tusc_ctl</span>, <span class="fu">join_by</span><span class="op">(</span><span class="va">ps_tr</span> <span class="op">&lt;=</span> <span class="va">ps_ctl</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">count</span><span class="op">(</span><span class="va">id_tr</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 2
  id_tr     n
  &lt;dbl&gt; &lt;int&gt;
1   214   309
2   310   331</code></pre>
</div>
</div>
<p>and they are matched to respectively 309 and 331 observations in the control group. With <strong>rolling</strong> joins, one can select only one observation, the closest one, using the <code>closest</code> function: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">match_sup</span> <span class="op">&lt;-</span> <span class="va">tusc_tr</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">left_join</span><span class="op">(</span><span class="va">tusc_ctl</span>, <span class="fu">join_by</span><span class="op">(</span><span class="fu">closest</span><span class="op">(</span><span class="va">ps_tr</span> <span class="op">&lt;=</span> <span class="va">ps_ctl</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">rename</span><span class="op">(</span>ps_sup <span class="op">=</span> <span class="va">ps_ctl</span>, id_sup <span class="op">=</span> <span class="va">id_ctl</span><span class="op">)</span></span>
<span><span class="va">match_sup</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 281 × 4
  id_tr  ps_tr id_sup ps_sup
  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
1   214 0.148    4098 0.149 
2   310 0.134    4594 0.135 
3   332 0.0789   4765 0.0789
# ℹ 278 more rows</code></pre>
</div>
</div>
<p>this time one row is returned for every treated observation, and the same control observation can be matched with several treated observations. Next, we match with the closest lower propensity score control: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">match_inf</span> <span class="op">&lt;-</span> <span class="va">tusc_tr</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">left_join</span><span class="op">(</span><span class="va">tusc_ctl</span>, <span class="fu">join_by</span><span class="op">(</span><span class="fu">closest</span><span class="op">(</span><span class="va">ps_tr</span> <span class="op">&gt;=</span> <span class="va">ps_ctl</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">rename</span><span class="op">(</span>ps_inf <span class="op">=</span> <span class="va">ps_ctl</span>, id_inf <span class="op">=</span> <span class="va">id_ctl</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We then join the two tables (by the index for treated observations <code>id_tr</code>) and select the control observation which is the closest: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">match_nearest</span> <span class="op">&lt;-</span> <span class="va">match_sup</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span> <span class="va">ps_tr</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">left_join</span><span class="op">(</span><span class="va">match_inf</span>, by <span class="op">=</span> <span class="st">"id_tr"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>ps_sup <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">ps_sup</span><span class="op">)</span>, <span class="fl">2</span>, <span class="va">ps_sup</span><span class="op">)</span>,</span>
<span>           id_ctl <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span> <span class="op">(</span><span class="va">ps_tr</span> <span class="op">-</span> <span class="va">ps_inf</span><span class="op">)</span> <span class="op">&lt;</span> <span class="op">(</span><span class="va">ps_sup</span> <span class="op">-</span> <span class="va">ps_tr</span><span class="op">)</span>,</span>
<span>                           <span class="va">id_inf</span>, <span class="va">id_sup</span><span class="op">)</span>,</span>
<span>           ps_ctl <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">id_ctl</span> <span class="op">==</span> <span class="va">id_inf</span>, <span class="va">ps_inf</span>, <span class="va">ps_sup</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">id_tr</span>, <span class="va">id_ctl</span>, <span class="va">ps_tr</span>, <span class="va">ps_ctl</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For a couple of treated observations, the propensity score is greater than the highest propensity score in the control group. Therefore, <code>ps_sup</code> is <code>NA</code>, and we set it to an arbitrary high value so that the <code>id_inf</code> observation is selected. We can then compute the number of observations in the control group that are used: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">match_nearest</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">pull</span><span class="op">(</span><span class="va">id_ctl</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">unique</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">length</span></span>
<span><span class="co">## [1] 146</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and select control observations which are the most often used to match treated observations: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">match_nearest</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">count</span><span class="op">(</span><span class="va">id_ctl</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">top_n</span><span class="op">(</span><span class="fl">2</span>, <span class="va">n</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 2
  id_ctl     n
   &lt;dbl&gt; &lt;int&gt;
1   4211    13
2   4935    16</code></pre>
</div>
</div>
<p>For example, observation 4935 in the control group matches 16 observations in the treatment group. For some observations, the algorithm may result in a poor match for some treated observations if the difference between the probability scores of this observation and the matched control observation is high. </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">match_nearest</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>diff <span class="op">=</span> <span class="va">ps_tr</span> <span class="op">-</span> <span class="va">ps_ctl</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">top_n</span><span class="op">(</span><span class="fl">3</span>, <span class="va">diff</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 5
  id_tr id_ctl ps_tr ps_ctl   diff
  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
1   375   4935 0.809  0.786 0.0225
2    89   4038 0.907  0.881 0.0258
3   412   4935 0.809  0.786 0.0225</code></pre>
</div>
</div>
<p>In our sample, the highest difference is about <span class="math inline">\(2.6\)</span>%. The sample can be reduced to observations for which the difference is lower than a given value. This is called <strong>caliper matching</strong>. For example, to restrict the sample to treated observations for which the propensity score difference with its matched control observation is lower than 1%, we would use: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mathc_nearest</span> <span class="op">&lt;-</span> <span class="va">match_nearest</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">ps_tr</span> <span class="op">-</span> <span class="va">ps_ctl</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">0.01</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We then lose 25 treated observations. To compute the treatment effect, we pivot the tibble in “long” format (one line for each observation) and we join it to <code>tuscany</code> to get the response (<code>perm</code>) for each observation: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">match_smpl</span> <span class="op">&lt;-</span> <span class="va">match_nearest</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span> <span class="va">ps_tr</span>, <span class="op">-</span> <span class="va">ps_ctl</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">pivot_longer</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">separate</span><span class="op">(</span><span class="va">name</span>, into <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">".id"</span>, <span class="st">"group"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>id <span class="op">=</span> <span class="va">value</span>, gp <span class="op">=</span> <span class="va">group</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">tuscany</span>, <span class="va">id</span>, <span class="va">perm</span><span class="op">)</span>, by <span class="op">=</span> <span class="st">"id"</span><span class="op">)</span></span>
<span><span class="va">match_smpl</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 562 × 3
     id gp     perm
  &lt;dbl&gt; &lt;chr&gt; &lt;dbl&gt;
1   214 tr        0
2  4098 ctl       0
# ℹ 560 more rows</code></pre>
</div>
</div>
<p>The treatment effect is then: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">means</span> <span class="op">&lt;-</span> <span class="va">match_smpl</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">group_by</span><span class="op">(</span><span class="va">gp</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">summarise</span><span class="op">(</span>perm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">perm</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">atet</span> <span class="op">&lt;-</span> <span class="va">means</span><span class="op">$</span><span class="va">perm</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="va">means</span><span class="op">$</span><span class="va">perm</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>treatment <span class="op">=</span> <span class="va">means</span><span class="op">$</span><span class="va">perm</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, control <span class="op">=</span> <span class="va">means</span><span class="op">$</span><span class="va">perm</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, atet <span class="op">=</span> <span class="va">atet</span><span class="op">)</span></span>
<span><span class="co">## treatment   control      atet </span></span>
<span><span class="co">##    0.3132    0.1246    0.1886</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p> The ATET (0.1886) is close to the one obtained previously using the algorithm based on stratas (0.1769).</p>
<p>Several packages have implemented the matching techniques previously described and some more advanced methods. We’ll describe here the <strong>MatchIt</strong> package. The <code><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html">MatchIt::matchit</a></code> function performs the matching, with a formula-data interface. It has numerous extra arguments, we set here the <code>replace</code> argument to <code>TRUE</code>, so that one observation in the control group can match several observations in the treatment group. </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb77"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://kosukeimai.github.io/MatchIt/">MatchIt</a></span><span class="op">)</span></span>
<span><span class="va">ftusc2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">ftusc</span>, <span class="va">group</span> <span class="op">~</span> <span class="va">.</span><span class="op">)</span></span>
<span><span class="va">mtch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html">matchit</a></span><span class="op">(</span><span class="va">ftusc2</span>, <span class="va">tuscany</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>"nearest"</code> method is used (the default) and the number of matched observations is 427 (as previously), the 281 treated observations and 146 observations of the control group. A <code>match.data</code> function is provided in order to extract the data frame restricted to the treated observations and the subset of observations of the control group that match.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mtch</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">match.data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 427 × 31
     id   age sex    marital children feduc fbluecol  femp  educ
  &lt;dbl&gt; &lt;dbl&gt; &lt;fct&gt;  &lt;fct&gt;      &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1  4862    32 female married        0     5        0     1    18
2  3756    33 female single         0     5        0     0    13
# ℹ 425 more rows
# ℹ 22 more variables: pvoto &lt;dbl&gt;, training &lt;dbl&gt;, dist &lt;dbl&gt;,
#   nyu &lt;dbl&gt;, hour &lt;dbl&gt;, wage &lt;dbl&gt;, hwage &lt;dbl&gt;, contact &lt;dbl&gt;,
#   region &lt;fct&gt;, city &lt;fct&gt;, group &lt;fct&gt;, sector &lt;fct&gt;,
#   occup &lt;fct&gt;, empstat &lt;fct&gt;, contract &lt;fct&gt;, loc &lt;fct&gt;,
#   outcome &lt;fct&gt;, perm &lt;dbl&gt;, dist2 &lt;dbl&gt;, livselfemp &lt;I&lt;int&gt;&gt;,
#   distance &lt;dbl&gt;, weights &lt;dbl&gt;</code></pre>
</div>
</div>
<p>A <code>weight</code> column is added to the data frame that contains weights to be used in subsequent treatment. There are 427 observations, the 281 treated observations and 146 observations of the control group. The weight for the treated observations is 1. For an observation of the control group that matches only one treated observation, the weight is <span class="math inline">\(146 / 281 = 0.52\)</span> and, for example, for an observation of the control group that matches four treated observations, the weight is :<span class="math inline">\(146 / 281 \times 4 = 2.08\)</span>. Caliper matching is performed using the <code>caliper</code> argument. The value indicated is by default a share of the standard deviation of the propensity score, but a value can be indicated in the scale of the propensity score if <code>std.capiler</code> is set to <code>FALSE</code>. Using the same value of 1% as previously, we would use: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mtch_cap</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html">matchit</a></span><span class="op">(</span><span class="va">ftusc2</span>, <span class="va">tuscany</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                    caliper <span class="op">=</span> <span class="fl">0.01</span>, std.caliper <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>MatchIt</strong> proposes more enhanced matching method; we won’t describe them here. Once the matching has been performed, the quality of the balancing process can be assessed. The <code>summary</code> method prints, for each covariates, the mean in both groups and several statistics, especially the standardized mean differences, which should be close to 0. The <code>plot</code> method draws a Love plot (see <a href="#fig-love">Figure&nbsp;<span>8.7</span></a>); for every covariate, two standardized mean differences are plotted, one for the raw data set and one for the balanced one.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb81"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mtch</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">summary</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">plot</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-love" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="treateff_files/figure-html/fig-love-1.png" class="img-fluid figure-img" style="width:60.0%"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;8.7: Love plot for the <code>twa</code> data set</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>We can see the effectiveness of matching, as the mean difference after matching (the black dots) are considerably lower than before matching (the white dots). </p>
</section><section id="sec-synth_control" class="level2" data-number="8.6"><h2 data-number="8.6" class="anchored" data-anchor-id="sec-synth_control">
<span class="header-section-number">8.6</span> Synthetic control</h2>
<p> Consider the case where units are aggregate units, as regions or countries and the treatment is an historical event or a policy intervention that affects one of them. Comparative case studies can then be used to estimate the causal effect of the treatment, comparing the situation of the treated unit after the treatment to the situation of one or several comparable units which haven’t been treated. Synthetic control methods, introduced by <span class="citation" data-cites="ABAD:GARD:03">Abadie and Gardeazabal (<a href="#ref-ABAD:GARD:03" role="doc-biblioref">2003</a>)</span>, are refinement of comparative case studies, where the comparison untreated unit is a weighted average of some units taken from a set of units called the <strong>donor pool</strong>. The example used by <span class="citation" data-cites="ABAD:GARD:03">Abadie and Gardeazabal (<a href="#ref-ABAD:GARD:03" role="doc-biblioref">2003</a>)</span> is the effect of terrorism in the Basque Country: the donor pool is the 17 Spanish regions, and the <strong>synthetic control</strong> of the Basque Country is a weighted average of two regions, Catalonia (85%) and Madrid (15%). The construction of the synthetic control is data-driven; it doesn’t rely on any subjective thought of the researcher of which Spanish regions look much like the Basque Country before the beginning of terrorism. Examples of the application of synthetic control methods are the analysis of the effect of:</p>
<ul>
<li>state fragmentation <span class="citation" data-cites="REYN:VANS:22">(<a href="#ref-REYN:VANS:22" role="doc-biblioref">Reynaerts and Vanschoonbeek 2022</a>)</span>,</li>
<li>the Brexit <span class="citation" data-cites="DOUC:EDWA:22">(<a href="#ref-DOUC:EDWA:22" role="doc-biblioref">Douch and Edwards 2022</a>)</span>,</li>
<li>a tobacco control program in California, <span class="citation" data-cites="ABAD:DIAM:HAIN:10">(<a href="#ref-ABAD:DIAM:HAIN:10" role="doc-biblioref">Abadie, Diamond, and Hainmueller 2010</a>)</span>,</li>
<li>the reunification of Germany <span class="citation" data-cites="ABAD:DIAM:HAIN:15">(<a href="#ref-ABAD:DIAM:HAIN:15" role="doc-biblioref">Abadie, Diamond, and Hainmueller 2015</a>)</span>,</li>
<li>mafia in southern Italy <span class="citation" data-cites="PINO:15 BECK:KLOS:17">(<a href="#ref-PINO:15" role="doc-biblioref">Pinotti 2015</a>; <a href="#ref-BECK:KLOS:17" role="doc-biblioref">Becker and Klosner 2017</a>)</span> ,</li>
<li>the Legal Arizona Workers Act <span class="citation" data-cites="BOHN:LOFS:RAPH:14">(<a href="#ref-BOHN:LOFS:RAPH:14" role="doc-biblioref">Bohn, Lofstrom, and Raphael 2014</a>)</span>.</li>
</ul>
<p>Consider a set of <span class="math inline">\(N+1\)</span> units, the first being the treated unit. Variables for these units are observed for <span class="math inline">\(T\)</span> periods and the treatment that affects unit 1 happened at the end of period <span class="math inline">\(T_0\)</span>. Therefore, <span class="math inline">\(t = 1, \ldots, T_0\)</span> are pre-treatment periods, and <span class="math inline">\(t = T_0+1, \ldots T\)</span> are post-treatment periods. <span class="math inline">\(y\)</span> is the outcome and <span class="math inline">\(x\)</span> is a set of covariates (that are supposed to explain the variations of <span class="math inline">\(y\)</span>). <span class="math inline">\(y_{nt} ^ T\)</span> is the value of the outcome for unit <span class="math inline">\(n\)</span> at period <span class="math inline">\(t\)</span> if the unit were treated at this period and <span class="math inline">\(y_{nt} ^ C\)</span> is the value without treatment. Of course, as usual in treatment effect analysis, for any <span class="math inline">\(n\)</span> and <span class="math inline">\(t\)</span>, <span class="math inline">\(y_{nt} ^ T\)</span> and <span class="math inline">\(y_{nt} ^ C\)</span> are never both observed. More precisely, <span class="math inline">\(y_{nt} ^ T\)</span> is only observed for <span class="math inline">\(n = 1\)</span> and <span class="math inline">\(t &gt; T_0\)</span>. The effect of the treatment that we seek to estimate is:</p>
<p><span class="math display">\[
y_{1t} ^ T - y_{1t} ^ C \; \forall \; t &gt; T_0
\]</span></p>
<p>The unknown <span class="math inline">\(y_{1t} ^ C\)</span> is replaced by:</p>
<p><span class="math display">\[
\hat{y}_{1t} ^ C = \sum_{n = 2} ^ {N+1} w_n y_{nt}
\]</span> </p>
<p>where <span class="math inline">\(w_n\)</span> are unknown weights such that <span class="math inline">\(w_n \geq 0\)</span> and <span class="math inline">\(\sum_{n=2} ^ {N+1} w_n= 1\)</span>. These weights define the <strong>synthetic control</strong> for unit 1. The weights have to be chosen so that synthetic control of unit 1 is as similar as possible to unit 1 in the pre-treatment period. This similarity is evaluated using a set of covariates that are assumed to have a causal effect on the outcome. The time dimension is not taken into account, so that the value of the covariate for a unit is typically the mean or the median of this covariate for the whole pre-treatment period or its value for a given period. Note that the outcome in the pre-treatment period can be included in the set of covariates. For each covariate and for a given set of weights, the difference between the actual value of <span class="math inline">\(x_{1k}\)</span> and the one of its synthetic control is:</p>
<p><span class="math display">\[
x_{1k} - \sum_{n=2} ^ {N+1} w_{n} x_{nk}
\]</span></p>
<p>and the synthetic control is defined by the set of weights <span class="math inline">\(w_n\)</span> that minimize:</p>
<p><span id="eq-seminorm"><span class="math display">\[
\sum_{k = 1} ^ K v_k \left(x_{1k} - \sum_{n = 2} ^ {N+1} w_n
x_{nk}\right) ^ 2
\tag{8.8}\]</span></span></p>
<p>where <span class="math inline">\(v\)</span> is a second set of weights for the covariates. The simplest choice for <span class="math inline">\(v_k\)</span> is <span class="math inline">\(1 / \hat{\sigma}_k ^ 2\)</span>, with <span class="math inline">\(\hat{\sigma}_k^2\)</span> the empirical variance of covariate <span class="math inline">\(k\)</span> in the sample, so that <a href="#eq-seminorm">Equation&nbsp;<span>8.8</span></a> becomes:</p>
<p><span class="math display">\[
\sum_{k = 1} ^ K \left(x_{1k} / \hat{\sigma}_k - \sum_{n = 2} ^ {N+1} w_n
x_{nk}/ \hat{\sigma}_k\right) ^ 2
\]</span> which is the sum of squares of the differences of the standardized covariates values for the treated observation and its synthetic control. More generally, for a given value of <span class="math inline">\(v\)</span>, we can define <span class="math inline">\(w(v)\)</span> as the solution of the minimization of the function given by <a href="#eq-seminorm">Equation&nbsp;<span>8.8</span></a>:</p>
<p><span id="eq-mspe"><span class="math display">\[
\sum_{t = 1} ^ {T_0} \left(y_{1t} - \sum_{n = 2} ^ {N + 1} w_n(v)
y_{nt}\right) ^ 2
\tag{8.9}\]</span></span></p>
<p><span class="citation" data-cites="ABAD:21">Abadie (<a href="#ref-ABAD:21" role="doc-biblioref">2021</a>)</span> discusses in length different choices for covariates’ weights <span class="math inline">\(v\)</span>. The synthetic control method is implemented in <strong>R</strong> in two packages: <strong>Synth</strong> <span class="citation" data-cites="ABAD:DIAM:HAIN:11">(<a href="#ref-ABAD:DIAM:HAIN:11" role="doc-biblioref">Abadie, Diamond, and Hainmueller 2011</a>)</span> and <strong>tidysynth</strong> <span class="citation" data-cites="DUNF:21">(<a href="#ref-DUNF:21" role="doc-biblioref">Dunford 2021</a>)</span>. We’ll describe the use of the latter as it is written in the tidyverse style.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">tidysynth</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The data set used is called <code>basque_country</code>. It is just the <code>basque</code> data set shipped with the <strong>Synth</strong> package, with a few modifications.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">basque_country</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 731 × 16
     id region  year gdpcap agriculture energy industry construction
  &lt;dbl&gt; &lt;chr&gt;  &lt;dbl&gt;  &lt;dbl&gt;       &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;        &lt;dbl&gt;
1     2 Andal…  1955   1.69          NA     NA       NA           NA
2     2 Andal…  1956   1.76          NA     NA       NA           NA
# ℹ 729 more rows
# ℹ 8 more variables: services &lt;dbl&gt;, administration &lt;dbl&gt;,
#   illit_educ &lt;dbl&gt;, prim_educ &lt;dbl&gt;, medium_educ &lt;dbl&gt;,
#   high_educ &lt;dbl&gt;, popdens &lt;dbl&gt;, invest &lt;dbl&gt;</code></pre>
</div>
</div>
<p>It is a panel for 17 Spanish regions for 43 years (from 1955 to 1993). The first function to use is <code>synthetic_control</code> which defines the outcome, the unit and the time variables, the treated unit and the treatment period. In this study, the authors investigate the effect of terrorism in the Basque Country, which started in 1969, on GDP per capita: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb85"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bc</span> <span class="op">&lt;-</span> <span class="va">basque_country</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/tidysynth/man/synthetic_control.html">synthetic_control</a></span><span class="op">(</span>outcome <span class="op">=</span> <span class="va">gdpcap</span>,</span>
<span>                      unit <span class="op">=</span> <span class="va">region</span>,</span>
<span>                      time <span class="op">=</span> <span class="va">year</span>,</span>
<span>                      i_unit <span class="op">=</span> <span class="st">"Basque"</span>,</span>
<span>                      i_time <span class="op">=</span> <span class="fl">1969</span>,</span>
<span>                      generate_placebo <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">bc</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 34 × 6
  .id       .placebo .type    .outcome .original_data      .meta   
  &lt;chr&gt;        &lt;dbl&gt; &lt;chr&gt;    &lt;list&gt;   &lt;list&gt;              &lt;list&gt;  
1 Basque           0 treated  &lt;tibble&gt; &lt;tibble [43 × 16]&gt;  &lt;tibble&gt;
2 Basque           0 controls &lt;tibble&gt; &lt;tibble [688 × 16]&gt; &lt;tibble&gt;
3 Andalucia        1 treated  &lt;tibble&gt; &lt;tibble [43 × 16]&gt;  &lt;tibble&gt;
4 Andalucia        1 controls &lt;tibble&gt; &lt;tibble [688 × 16]&gt; &lt;tibble&gt;
5 Aragon           1 treated  &lt;tibble&gt; &lt;tibble [43 × 16]&gt;  &lt;tibble&gt;
# ℹ 29 more rows</code></pre>
</div>
</div>
<p>We explicitly set the value <code>generate_placebo</code> to <code>TRUE</code>, even if it is the default value. If <code>generate_placebo</code> is set to <code>FALSE</code>, the result is a tibble which contains two lines for the treated unit (Basque Country): the first contains the information for the treated unit, the second contains the information for the donor set, i.e., all the Spanish regions except the Basque Country. The <code>.outcome</code> column contains the pre-period (15 years) values of the outcome for the treated (first line) and the donor set (second line). With <code>generate_placebo = TRUE</code>, there are <span class="math inline">\(2 \times 16 = 32\)</span> more lines, i.e., a couple of lines for every untreated unit. All the analysis is in this case performed not only for the treated unit, but also for all the units of the donor pool. As we’ll see later, this placebo analysis enables to perform some inference about the efficiency of the treatment for the treated unit. Next, we define the covariates, using the <code>generate_predictor</code> function. Its syntax is similar to <code>mutate</code> or <code>summarise</code>, but the second argument of the function is <code>time_window</code> which indicates on which subperiod the computation has to be made. We compute the mean of the shares of education and investment for the 1964-1969 period, the population density in 1969, the GDP per capita for the 1960-1969 period and the sector shares for the 1961-1969 period. </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb87"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bc</span> <span class="op">&lt;-</span> <span class="va">bc</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/tidysynth/man/generate_predictor.html">generate_predictor</a></span><span class="op">(</span>time_window <span class="op">=</span> <span class="fl">1964</span><span class="op">:</span><span class="fl">1969</span>,</span>
<span>                       illit_educ <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">illit_educ</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>                       prim_educ <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">prim_educ</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>                       medium_educ <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">medium_educ</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>                       high_educ <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">high_educ</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>                       invest <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">invest</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/tidysynth/man/generate_predictor.html">generate_predictor</a></span><span class="op">(</span>time_window <span class="op">=</span> <span class="fl">1969</span>,</span>
<span>                       popdens <span class="op">=</span> <span class="va">popdens</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/tidysynth/man/generate_predictor.html">generate_predictor</a></span><span class="op">(</span>time_window <span class="op">=</span> <span class="fl">1960</span><span class="op">:</span><span class="fl">1969</span>,</span>
<span>                       gdpcap <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">gdpcap</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/tidysynth/man/generate_predictor.html">generate_predictor</a></span><span class="op">(</span>time_window <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1961</span>, <span class="fl">1969</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>                       agriculture <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">agriculture</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>                       energy <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">energy</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>                       industry <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">industry</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>                       construction <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">construction</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>                       services <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">services</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>                       administration <span class="op">=</span> </span>
<span>                         <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">administration</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A <code>.predictors</code> column is then added to the tibble. For the first line, the value is a tibble with 13 lines (the number of covariates) and two columns (the name of the variable and the value for the Basque Country). For the second line, there are 17 columns (the name of the variable and the values for the 16 regions of the donor set). Then the weights are computed using the <code>generate_weights</code> function. The second argument of this function is <code>optimization_window</code> which indicates the subset of the pre-treatment period which is used to compute the weights: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb88"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bc</span> <span class="op">&lt;-</span> <span class="va">bc</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/tidysynth/man/generate_weights.html">generate_weights</a></span><span class="op">(</span>optimization_window <span class="op">=</span> <span class="fl">1960</span><span class="op">:</span><span class="fl">1969</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>.unit_weights</code>, <code>.predictor_weights</code> and <code>.loss</code> columns are added. The first two contain respectively the values of <span class="math inline">\(w\)</span> and <span class="math inline">\(v\)</span>; the last one contains two mean square prediction errors, one for the variable and one for the unit. Finally, the synthetic control is computed using the <code>generate_control</code> function: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb89"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bc</span> <span class="op">&lt;-</span> <span class="va">bc</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">generate_control</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>All the results can conveniently be extracted and plotted using a set of functions called <code>grab_###</code> and <code>plot_###</code>. <code>grab_balance_table</code> computes a balance table for the treated unit, its synthetic control and the whole sample for the covariates. </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb90"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/tidysynth/man/grab_balance_table.html">grab_balance_table</a></span><span class="op">(</span><span class="va">bc</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span>n <span class="op">=</span> <span class="cn">Inf</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 13 × 4
   variable       Basque synthetic_Basque donor_sample
   &lt;chr&gt;           &lt;dbl&gt;            &lt;dbl&gt;        &lt;dbl&gt;
 1 high_educ        3.26             3.10         2.68
 2 illit_educ       3.32             7.65        11.0 
 3 invest          24.6             21.6         21.4 
 4 medium_educ      7.46             6.92         5.41
 5 prim_educ       86.0             82.3         80.9 
 6 popdens        247.             196.          99.4 
 7 gdpcap           5.29             5.27         3.58
 8 administration   4.07             5.37         7.11
 9 agriculture      6.84             6.18        21.4 
10 construction     6.15             6.95         7.28
11 energy           4.11             2.76         5.31
12 industry        45.1             37.6         22.4 
13 services        33.8             41.1         36.5 </code></pre>
</div>
</div>
<p>The value of the covariate for the Basque Country may be very different from the mean of the values for the donor pool, but it should be close to the one of its synthetic control. It is particularly the case here for <code>agriculture</code> and <code>popdens</code>. To get the unit weights and only select those which are not almost zero, we can use: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb92"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/tidysynth/man/grab_unit_weights.html">grab_unit_weights</a></span><span class="op">(</span><span class="va">bc</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">weight</span> <span class="op">&gt;</span> <span class="fl">1E-05</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 2
  unit     weight
  &lt;chr&gt;     &lt;dbl&gt;
1 Cataluna  0.851
2 Madrid    0.149</code></pre>
</div>
</div>
<p>As stated previously, the synthetic control of the Basque Country consists of 85% of Cataluna and 15% of Madrid. It is a common feature of this method that a small number of units in the donor pool are really used. To get the covariates weights: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb94"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/tidysynth/man/grab_predictor_weights.html">grab_predictor_weights</a></span><span class="op">(</span><span class="va">bc</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu">arrange</span><span class="op">(</span><span class="fu">desc</span><span class="op">(</span><span class="va">weight</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 13 × 2
  variable       weight
  &lt;chr&gt;           &lt;dbl&gt;
1 popdens        0.339 
2 gdpcap         0.199 
3 industry       0.133 
4 administration 0.107 
5 agriculture    0.0937
# ℹ 8 more rows</code></pre>
</div>
</div>
<p>Population density and pre-treatment average of the GDP par capita are the two covariates with the largest weights. <a href="#fig-weights">Figure&nbsp;<span>8.8</span></a>’s plots represent these weights using the <code>plot_weights</code> function. </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb96"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/tidysynth/man/plot_weights.html">plot_weights</a></span><span class="op">(</span><span class="va">bc</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-weights" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="treateff_files/figure-html/fig-weights-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;8.8: Weights for the units and the predictors</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>The real series of GDP per capita for the Basque Country and its synthetic control are obtained using the <code>grab_synthetic_control</code> function. <a href="#fig-trends">Figure&nbsp;<span>8.9</span></a> presents the two series and is obtained using the <code>plot_trends</code> function.<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a> </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb97"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/tidysynth/man/plot_trends.html">plot_trends</a></span><span class="op">(</span><span class="va">bc</span><span class="op">)</span> <span class="op">+</span> <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="cn">NULL</span>, y <span class="op">=</span> <span class="st">"GDP per capita"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 43 × 3
  time_unit real_y synth_y
      &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;
1      1955   3.85    3.70
2      1956   3.95    3.85
3      1957   4.03    4.00
4      1958   4.02    4.03
5      1959   4.01    4.06
# ℹ 38 more rows</code></pre>
</div>
<div class="cell-output-display">
<div id="fig-trends" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="treateff_files/figure-html/fig-trends-1.png" class="img-fluid figure-img" style="width:60.0%"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;8.9: GDP per capita for the Basque Country and its synthetic control</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Instead of plotting the GDP per capita for the real and the synthetic Basque Country, one can also plot the difference between both series (see <a href="#fig-diff">Figure&nbsp;<span>8.10</span></a>). The difference should be small and erratic before the treatment, and large and negative after the treatment. </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb99"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/tidysynth/man/plot_differences.html">plot_differences</a></span><span class="op">(</span><span class="va">bc</span><span class="op">)</span> <span class="op">+</span> <span class="fu">theme_get</span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-diff" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="treateff_files/figure-html/fig-diff-1.png" class="img-fluid figure-img" style="width:60.0%"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;8.10: Difference of GDP per capita for the Basque Country and its synthetic control</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>The quality of the fit can be evaluated using <code>grab_loss</code>: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb100"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bc</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">grab_loss</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 17 × 4
  .id       .placebo variable_mspe control_unit_mspe
  &lt;chr&gt;        &lt;dbl&gt;         &lt;dbl&gt;             &lt;dbl&gt;
1 Basque           0       0.00886            0.249 
2 Andalucia        1       0.00850            0.0254
3 Aragon           1       0.00372            0.0313
4 Baleares         1       1.09               0.300 
5 Canarias         1       0.0594             0.121 
# ℹ 12 more rows</code></pre>
</div>
</div>
<p>The column <code>variable_mspe</code> indicates the value of <a href="#eq-seminorm">Equation&nbsp;<span>8.8</span></a> and <code>control_unit_mspe</code> the value of <a href="#eq-mspe">Equation&nbsp;<span>8.9</span></a>. The efficiency of the treatment and the ability of the method to estimate it can be assessed by computing the mean square prediction error for the outcome before and after the treatment:</p>
<p><span class="math display">\[
m_n^{\mbox{pre}} = \frac{\sum_{t = 1} ^ {T_0} (y_{nt} - \hat{y}_{nt}) ^
2}{T_0} \mbox{ and }
m_n^{\mbox{post}} = \frac{\sum_{t = T_0 + 1} ^ T (y_{nt} - \hat{y}_{nt}) ^ 2}{T - T_0}
\]</span></p>
<p>The synthetic control should be very close to the treated unit before the treatment, so that <span class="math inline">\(m_n^{\mbox{\tiny{pre}}}\)</span> should be low. On the contrary, if the treatment is efficient, the treated unit and its synthetic control should be very different after the treatment, so that <span class="math inline">\(m_n^{\mbox{\tiny{post}}}\)</span> should be high. Therefore, the ratio <span class="math inline">\(r_n = m_n^{\mbox{\tiny{post}}} / m_n^{\mbox{\tiny{pre}}}\)</span> should be high if the treatment is efficient and if the synthetic control method is relevant. Moreover, it should be much higher than the ones obtained for untreated units. The significance of the treatment can be established using the distribution of <span class="math inline">\(r\)</span> for all the units (the treated one and the untreated ones). Denoting <span class="math inline">\(\bar{r}\)</span> and <span class="math inline">\(\hat{\sigma}_r\)</span>, as the mean and the standard deviation of <span class="math inline">\(r\)</span>, we can define <span class="math inline">\(z_n = (r_n - \bar{r}) / \hat{\sigma}_r\)</span> which is asymptotically distributed as a standard normal deviate. These indicators can be retrieved using the <code>grab_significance</code> function: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb102"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">bc</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="va">grab_significance</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 17 × 8
  unit_name              type    pre_mspe post_mspe mspe_ratio  rank
  &lt;chr&gt;                  &lt;chr&gt;      &lt;dbl&gt;     &lt;dbl&gt;      &lt;dbl&gt; &lt;int&gt;
1 Basque                 Treated  0.00821     0.493       60.1     1
2 Principado De Asturias Donor    0.0157      0.650       41.3     2
3 Andalucia              Donor    0.00741     0.205       27.7     3
4 Castilla-La Mancha     Donor    0.0162      0.206       12.7     4
5 Navarra                Donor    0.0224      0.224       10.0     5
# ℹ 12 more rows
# ℹ 2 more variables: fishers_exact_pvalue &lt;dbl&gt;, z_score &lt;dbl&gt;</code></pre>
</div>
</div>
<div class="cell" data-layout-align="center">

</div>
<p>The highest ratio is actually the one for the treated unit, i.e., the Basque Country. The mean and the standard deviations of this ratio are respectively 11.95 and 16.23. The <span class="math inline">\(z\)</span> value for the Basque Country is 2.97, much higher than the critical value for a normal at the 1% level. The second highest value is for Asturias, with a <span class="math inline">\(z\)</span> value of 1.81 lower than the critical value at the 5% level. The MSPE ratios are represented in <a href="#fig-msperatio">Figure&nbsp;<span>8.11</span></a>, using the <code>plot_mspe_ratio</code> function: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb104"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/tidysynth/man/plot_mspe_ratio.html">plot_mspe_ratio</a></span><span class="op">(</span><span class="va">bc</span><span class="op">)</span> <span class="op">+</span> <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-msperatio" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="treateff_files/figure-html/fig-msperatio-1.png" class="img-fluid figure-img" style="width:60.0%"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;8.11: Plot of the MSPE ratio</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Finally, a popular graphic in synthetic control analysis consists of plotting the difference between the real series of any unit and its synthetic control. The difference should be sharp for the post-treatment period for the treated unit and small for the other units which are not treated. This so-called placebos plot is obtained using the <code>plot_placebos</code> function and is presented in <a href="#fig-placebos">Figure&nbsp;<span>8.12</span></a> </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb105"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/tidysynth/man/plot_placebos.html">plot_placebos</a></span><span class="op">(</span><span class="va">bc</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-placebos" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="treateff_files/figure-html/fig-placebos-1.png" class="img-fluid figure-img" style="width:60.0%"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;8.12: Placebos plot</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p></p>


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography">
<div id="ref-ABAD:21" class="csl-entry" role="doc-biblioentry">
Abadie, Alberto. 2021. <span>“Using Synthetic Controls: Feasibility, Data Requirements, and Methodological Aspects.”</span> <em>Journal of Economic Literature</em> 59 (2): 391–425. <a href="https://doi.org/10.1257/jel.20191450">https://doi.org/10.1257/jel.20191450</a>.
</div>
<div id="ref-ABAD:DIAM:HAIN:10" class="csl-entry" role="doc-biblioentry">
Abadie, Alberto, Alexis Diamond, and Jens Hainmueller. 2010. <span>“<span class="nocase">Synthetic Control Methods for Comparative Case Studies: Estimating the Effect of California’s Tobacco Control Program</span>.”</span> <em>Journal of the American Statistical Association</em> 105 (490): 493–505. <a href="https://ideas.repec.org/a/bes/jnlasa/v105i490y2010p493-505.html">https://ideas.repec.org/a/bes/jnlasa/v105i490y2010p493-505.html</a>.
</div>
<div id="ref-ABAD:DIAM:HAIN:11" class="csl-entry" role="doc-biblioentry">
———. 2011. <span>“<span class="nocase">Synth: An R Package for Synthetic Control Methods in Comparative Case Studies</span>.”</span> <em>Journal of Statistical Software</em> 42 (i13). https://doi.org/<a href="http://hdl.handle.net/10.">http://hdl.handle.net/10.</a>
</div>
<div id="ref-ABAD:DIAM:HAIN:15" class="csl-entry" role="doc-biblioentry">
———. 2015. <span>“<span class="nocase">Comparative Politics and the Synthetic Control Method</span>.”</span> <em>American Journal of Political Science</em> 59 (2): 495–510. <a href="https://doi.org/10.1111/ajps.12116">https://doi.org/10.1111/ajps.12116</a>.
</div>
<div id="ref-ABAD:GARD:03" class="csl-entry" role="doc-biblioentry">
Abadie, Alberto, and Javier Gardeazabal. 2003. <span>“<span class="nocase">The Economic Costs of Conflict: A Case Study of the Basque Country</span>.”</span> <em>American Economic Review</em> 93 (1): 113–32. <a href="https://ideas.repec.org/a/aea/aecrev/v93y2003i1p113-132.html">https://ideas.repec.org/a/aea/aecrev/v93y2003i1p113-132.html</a>.
</div>
<div id="ref-ANGR:BETT:BLOO:KING:KREM:02" class="csl-entry" role="doc-biblioentry">
Angrist, Joshua D., Eric Bettinger, Erik Bloom, Elizabeth King, and Michael Kremer. 2002. <span>“Vouchers for Private Schooling in Colombia: Evidence from a Randomized Natural Experiment.”</span> <em>American Economic Review</em> 92 (5): 1535–58. <a href="https://doi.org/10.1257/000282802762024629">https://doi.org/10.1257/000282802762024629</a>.
</div>
<div id="ref-ANGR:IMBE:RUBI:96" class="csl-entry" role="doc-biblioentry">
Angrist, Joshua D., Guido W. Imbens, and Donald B. Rubin. 1996. <span>“Identification of Causal Effects Using Instrumental Variables.”</span> <em>Journal of the American Statistical Association</em> 91 (434): 444–55. <a href="http://www.jstor.org/stable/2291629">http://www.jstor.org/stable/2291629</a>.
</div>
<div id="ref-BECK:KLOS:17" class="csl-entry" role="doc-biblioentry">
Becker, Martin, and Stefan Klosner. 2017. <span>“Estimating the Economic Costs of Organized Crime by Synthetic Control Methods.”</span> <em>Journal of Applied Econometrics</em> 32 (7): 1367–69. <a href="https://EconPapers.repec.org/RePEc:wly:japmet:v:32:y:2017:i:7:p:1367-1369">https://EconPapers.repec.org/RePEc:wly:japmet:v:32:y:2017:i:7:p:1367-1369</a>.
</div>
<div id="ref-BOHN:LOFS:RAPH:14" class="csl-entry" role="doc-biblioentry">
Bohn, Sarah, Magnus Lofstrom, and Steven Raphael. 2014. <span>“<span class="nocase">Did the 2007 Legal Arizona Workers Act Reduce the State’s Unauthorized Immigrant Population?</span>”</span> <em>The Review of Economics and Statistics</em> 96 (2): 258–69. <a href="https://ideas.repec.org/a/tpr/restat/v96y2014i2p258-269.html">https://ideas.repec.org/a/tpr/restat/v96y2014i2p258-269.html</a>.
</div>
<div id="ref-BURD:LIND:13" class="csl-entry" role="doc-biblioentry">
Burde, Dana, and Leigh L. Linden. 2013. <span>“Bringing Education to Afghan Girls: A Randomized Controlled Trial of Village-Based Schools.”</span> <em>American Economic Journal: Applied Economics</em> 5 (3): 27–40. <a href="http://www.jstor.org/stable/43189440">http://www.jstor.org/stable/43189440</a>.
</div>
<div id="ref-BUSE:15" class="csl-entry" role="doc-biblioentry">
Buser, Thomas. 2015. <span>“The Effect of Income on Religiousness.”</span> <em>American Economic Journal: Applied Economics</em> 7 (3): 178–95. <a href="https://doi.org/10.1257/app.20140162">https://doi.org/10.1257/app.20140162</a>.
</div>
<div id="ref-CALI:CATT:TITI:15" class="csl-entry" role="doc-biblioentry">
Calonico, Sebastian, Matias D. Cattaneo, and Rocío Titiunik. 2015. <span>“<span class="nocase">rdrobust: An R Package for Robust Nonparametric Inference in Regression-Discontinuity Designs</span>.”</span> <em><span>The R Journal</span></em> 7 (1): 38–51. <a href="https://doi.org/10.32614/RJ-2015-004">https://doi.org/10.32614/RJ-2015-004</a>.
</div>
<div id="ref-CAME:TRIV:05" class="csl-entry" role="doc-biblioentry">
Cameron, A. Colin, and Pravin K. Trivedi. 2005. <em>Microeconometrics</em>. Cambridge University Press. <a href="https://EconPapers.repec.org/RePEc:cup:cbooks:9780521848053">https://EconPapers.repec.org/RePEc:cup:cbooks:9780521848053</a>.
</div>
<div id="ref-DEHE:WAHB:99" class="csl-entry" role="doc-biblioentry">
Dehejia, Rajeev H., and Sadek Wahba. 1999. <span>“Causal Effects in Nonexperimental Studies: Reevaluating the Evaluation of Training Programs.”</span> <em>Journal of the American Statistical Association</em> 94 (448): 1053–62. <a href="http://www.jstor.org/stable/2669919">http://www.jstor.org/stable/2669919</a>.
</div>
<div id="ref-DEHE:WAHB:02" class="csl-entry" role="doc-biblioentry">
———. 2002. <span>“<span class="nocase">Propensity Score-Matching Methods for Nonexperimental Causal Studies</span>.”</span> <em>The Review of Economics and Statistics</em> 84 (1): 151–61. <a href="https://doi.org/10.1162/003465302317331982">https://doi.org/10.1162/003465302317331982</a>.
</div>
<div id="ref-DITE:SCHA:04" class="csl-entry" role="doc-biblioentry">
Di Tella, Rafael, and Ernesto Schargrodsky. 2004. <span>“Do Police Reduce Crime? Estimates Using the Allocation of Police Forces After a Terrorist Attack.”</span> <em>The American Economic Review</em> 94 (1): 115–33. <a href="http://www.jstor.org/stable/3592772">http://www.jstor.org/stable/3592772</a>.
</div>
<div id="ref-DOUC:EDWA:22" class="csl-entry" role="doc-biblioentry">
Douch, Mustapha, and Terence Huw Edwards. 2022. <span>“<span class="nocase">The bilateral trade effects of announcement shocks: Brexit as a natural field experiment</span>.”</span> <em>Journal of Applied Econometrics</em> 37 (2): 305–29. <a href="https://doi.org/10.1002/jae.2878">https://doi.org/10.1002/jae.2878</a>.
</div>
<div id="ref-DUNF:21" class="csl-entry" role="doc-biblioentry">
Dunford, Eric. 2021. <em>Tidysynth: A Tidy Implementation of the Synthetic Control Method</em>. <a href="https://CRAN.R-project.org/package=tidysynth">https://CRAN.R-project.org/package=tidysynth</a>.
</div>
<div id="ref-HONG:13" class="csl-entry" role="doc-biblioentry">
Hong, Seung-Hyun. 2013. <span>“Measuring the Effect of Napster on Recorded Music Sales: Difference-in-Differences Estimates Under Compositional Changes.”</span> <em>Journal of Applied Econometrics</em> 28 (2): 297–324. <a href="http://www.jstor.org/stable/23355919">http://www.jstor.org/stable/23355919</a>.
</div>
<div id="ref-BECK:ICHI:02" class="csl-entry" role="doc-biblioentry">
Ichino, Andrea. 2002. <span>“Estimation of Average Treatment Effects Based on Propensity Scores.”</span> <em>Stata Journal</em> 2 (4): 358–377(20). <a href="https://www.stata-journal.com/article.html?article=st0026">https://www.stata-journal.com/article.html?article=st0026</a>.
</div>
<div id="ref-ICHI:MEAL:NANN:08" class="csl-entry" role="doc-biblioentry">
Ichino, Andrea, Fabrizia Mealli, and Tommaso Nannicini. 2008. <span>“From Temporary Help Jobs to Permanent Employment: What Can We Learn from Matching Estimators and Their Sensitivity?”</span> <em>Journal of Applied Econometrics</em> 23 (3): 305–27. <a href="http://www.jstor.org/stable/25144550">http://www.jstor.org/stable/25144550</a>.
</div>
<div id="ref-IMBE:ANGR:94" class="csl-entry" role="doc-biblioentry">
Imbens, Guido W., and Joshua D. Angrist. 1994. <span>“Identification and Estimation of Local Average Treatment Effects.”</span> <em>Econometrica</em> 62 (2): 467–75. <a href="http://www.jstor.org/stable/2951620">http://www.jstor.org/stable/2951620</a>.
</div>
<div id="ref-LALO:86" class="csl-entry" role="doc-biblioentry">
LaLonde, Robert. 1986. <span>“Evaluating the Econometric Evaluations of Training Programs with Experimental Data.”</span> <em>American Economic Review</em> 76 (4): 604–20. <a href="https://EconPapers.repec.org/RePEc:aea:aecrev:v:76:y:1986:i:4:p:604-20">https://EconPapers.repec.org/RePEc:aea:aecrev:v:76:y:1986:i:4:p:604-20</a>.
</div>
<div id="ref-LIND:SAND:OREO:10" class="csl-entry" role="doc-biblioentry">
Lindo, Jason M., Nicholas J. Sanders, and Philip Oreopoulos. 2010. <span>“Ability, Gender, and Performance Standards: Evidence from Academic Probation.”</span> <em>American Economic Journal: Applied Economics</em> 2 (2): 95–117. <a href="http://www.jstor.org/stable/25760207">http://www.jstor.org/stable/25760207</a>.
</div>
<div id="ref-MCCR:08" class="csl-entry" role="doc-biblioentry">
McCrary, Justin. 2008. <span>“Manipulation of the Running Variable in the Regression Discontinuity Design: A Density Test.”</span> <em>Journal of Econometrics</em> 142 (2): 698–714. <a href="https://doi.org/10.1016/j.jeconom.2007.05.005">https://doi.org/10.1016/j.jeconom.2007.05.005</a>.
</div>
<div id="ref-PINO:15" class="csl-entry" role="doc-biblioentry">
Pinotti, Paolo. 2015. <span>“The Economic Costs of Organised Crime: Evidence from Southern Italy.”</span> <em>The Economic Journal</em> 125 (586): F203–32. <a href="https://doi.org/10.1111/ecoj.12235">https://doi.org/10.1111/ecoj.12235</a>.
</div>
<div id="ref-REYN:VANS:22" class="csl-entry" role="doc-biblioentry">
Reynaerts, Jo, and Jakob Vanschoonbeek. 2022. <span>“<span class="nocase">The economics of state fragmentation: Assessing the economic impact of secession</span>.”</span> <em>Journal of Applied Econometrics</em> 37 (1): 82–115. <a href="https://doi.org/10.1002/jae.2857">https://doi.org/10.1002/jae.2857</a>.
</div>
<div id="ref-ROSE:RUBI:83" class="csl-entry" role="doc-biblioentry">
Rosenbaum, Paul R., and Donald B. Rubin. 1983. <span>“The Central Role of the Propensity Score in Observational Studies for Causal Effects.”</span> <em>Biometrika</em> 70 (1): 41–55. <a href="http://www.jstor.org/stable/2335942">http://www.jstor.org/stable/2335942</a>.
</div>
<div id="ref-SJOB:21" class="csl-entry" role="doc-biblioentry">
Sjoberg, Daniel D., Karissa Whiting, Michael Curry, Jessica A. Lavery, and Joseph Larmarange. 2021. <span>“Reproducible Summary Tables with the Gtsummary Package.”</span> <em><span>The R Journal</span></em> 13: 570–80. <a href="https://doi.org/10.32614/RJ-2021-053">https://doi.org/10.32614/RJ-2021-053</a>.
</div>
</div>
</section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><hr>
<ol>
<li id="fn1"><p>If <code>margin = 1</code>, the frequencies sum to one for each line, and if <code>margin = 2</code>, they sum to one for each column.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>Detailed documentation of the package can be found on the website of the package <a href="https://www.danieldsjoberg.com/gtsummary/" class="uri">https://www.danieldsjoberg.com/gtsummary/</a> and on <span class="citation" data-cites="SJOB:21">Sjoberg et al. (<a href="#ref-SJOB:21" role="doc-biblioref">2021</a>)</span>.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>Note that we also used some functions of the <strong>kableExtra</strong> package for fine-tuning the table.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>This is the setting of the Wald estimator that was presented in <a href="endogeneity.html#sec-wald_estimator"><span>Section&nbsp;7.2.4</span></a>.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>see <span class="citation" data-cites="LIND:SAND:OREO:10">Lindo, Sanders, and Oreopoulos (<a href="#ref-LIND:SAND:OREO:10" role="doc-biblioref">2010</a>)</span>, footnote 20, page 104.<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6"><p>Note the use of <code>labs</code>; <strong>tidysynth</strong> uses <strong>ggplot</strong> so that the plots can be customized with any function of the <strong>ggplot2</strong> package.<a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="../chapters/endogeneity.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Endogeneity</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../chapters/spatial.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Spatial econometrics</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb106" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Treatment effect {#sec-treatment_effect}</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"../_commonR.R"</span>)</span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-10"><a href="#cb106-10" aria-hidden="true" tabindex="-1"></a>In treatment evaluation analysis, one is interested in the effect of a</span>
<span id="cb106-11"><a href="#cb106-11" aria-hidden="true" tabindex="-1"></a>treatment on a relevant outcome. Popular examples are the effect of</span>
<span id="cb106-12"><a href="#cb106-12" aria-hidden="true" tabindex="-1"></a>microcredit access on the economic outcomes of households in</span>
<span id="cb106-13"><a href="#cb106-13" aria-hidden="true" tabindex="-1"></a>developing countries, effects of a reduction of class size on the</span>
<span id="cb106-14"><a href="#cb106-14" aria-hidden="true" tabindex="-1"></a>academic outcomes of pupils, effects of a youth job training program on employment status. In the simplest case, the outcome $y$ is a continuous variable and the treatment variable $D$ is</span>
<span id="cb106-15"><a href="#cb106-15" aria-hidden="true" tabindex="-1"></a>binomial (1 for treatment, 0 otherwise). The causal impact of $D$ on $y$ is measured by the difference between the value of $y$ if $D=0$, denoted by $y_0$ and if $D=1$, denoted by $y_1$. To an individual for which $D=0$, $y_0$ is the observed or factual situation. The value of $y$ if the individual had received the treatment is $y_1$ and is called the **counterfactual**. The fundamental problem is that the counterfactual is unobserved. This framework leads to the **potential outcome** model, which became increasingly popular in econometrics.\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{counterfactual}\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{potential outcome}</span>
<span id="cb106-16"><a href="#cb106-16" aria-hidden="true" tabindex="-1"></a>On a sample of size $N$, denoting $y_{0n}$ and $y_{1n}$ the two values of the outcome, the natural estimator of the effect of the treatment would be:</span>
<span id="cb106-17"><a href="#cb106-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-18"><a href="#cb106-18" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-19"><a href="#cb106-19" aria-hidden="true" tabindex="-1"></a>\frac{\sum_{n= 1} ^ N (y_{1n} - y_{0n})}{N}</span>
<span id="cb106-20"><a href="#cb106-20" aria-hidden="true" tabindex="-1"></a>$$ {#eq-ideal_te_estimator}</span>
<span id="cb106-21"><a href="#cb106-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-22"><a href="#cb106-22" aria-hidden="true" tabindex="-1"></a>but is unfeasible for a missing data problem: either $y_{0n}$ or $y_{1n}$ is observed, but not both, as an individual cannot be at the same time treated and untreated. </span>
<span id="cb106-23"><a href="#cb106-23" aria-hidden="true" tabindex="-1"></a>In real settings, we have a sample that contains:</span>
<span id="cb106-24"><a href="#cb106-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-25"><a href="#cb106-25" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>a subsample of individuals who received the treatment ($D=1$) called the **treatment group** (denoted by $T$),</span>
<span id="cb106-26"><a href="#cb106-26" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>a subsample of individuals who didn't receive the treatment ($D=0$) called the **control group** (denoted by $C$).</span>
<span id="cb106-27"><a href="#cb106-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-28"><a href="#cb106-28" aria-hidden="true" tabindex="-1"></a>and an alternative estimator is obtained using the difference between the mean values of the outcome in the treatment and in the control group:</span>
<span id="cb106-29"><a href="#cb106-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-30"><a href="#cb106-30" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-31"><a href="#cb106-31" aria-hidden="true" tabindex="-1"></a>\frac{\sum_{n \in T} y_n}{N_{T}} - \frac{\sum_{n \in C} y_n}{N_{C}}</span>
<span id="cb106-32"><a href="#cb106-32" aria-hidden="true" tabindex="-1"></a>$$ {#eq-diff_means_est}</span>
<span id="cb106-33"><a href="#cb106-33" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{experimental data}\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{observational data}</span>
<span id="cb106-34"><a href="#cb106-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-35"><a href="#cb106-35" aria-hidden="true" tabindex="-1"></a>Moreover the data can be either **experimental** or **observational**, the difference between the two being that in the first case, the treatment is randomly assigned to some individuals. With experimental data, @eq-diff_means_est should be a reliable estimator of the effect of the treatment. On the contrary, in case of observational data, the observed and unobserved characteristics of the individuals in the two groups may be different and therefore, the estimator given in @eq-diff_means_est may include partly these differences and therefore may be biased. </span>
<span id="cb106-36"><a href="#cb106-36" aria-hidden="true" tabindex="-1"></a>To overcome these difficulties, different estimators have been suggested for observational data, which rely on different assumptions that are detailed, for example, in @CAME:TRIV:05\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Cameron}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Trivedi}, pp. 862-865.</span>
<span id="cb106-37"><a href="#cb106-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-38"><a href="#cb106-38" aria-hidden="true" tabindex="-1"></a>@sec-randomized_experiment presents the estimation of the treatment effect with experimental data. @sec-iv_te explains how the instrumental variable estimator can be used to estimate the effect of a treatment. @sec-reg_discont presents the regression discontinuity estimator, @sec-diff_diff the difference in difference estimator and @sec-matching the matching estimator. Finally, @sec-synth_control is devoted to the synthetic control estimator.</span>
<span id="cb106-39"><a href="#cb106-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-40"><a href="#cb106-40" aria-hidden="true" tabindex="-1"></a><span class="fu">## Randomized experiment {#sec-randomized_experiment}</span></span>
<span id="cb106-41"><a href="#cb106-41" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{randomized experiment|(}</span>
<span id="cb106-42"><a href="#cb106-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-43"><a href="#cb106-43" aria-hidden="true" tabindex="-1"></a>Randomized experiences are the ideal setting to analyze treatment</span>
<span id="cb106-44"><a href="#cb106-44" aria-hidden="true" tabindex="-1"></a>effects. The treatment and the control groups are composed of</span>
<span id="cb106-45"><a href="#cb106-45" aria-hidden="true" tabindex="-1"></a>individuals who are randomly drawn from the same population, and therefore the average observable and unobserved characteristics in</span>
<span id="cb106-46"><a href="#cb106-46" aria-hidden="true" tabindex="-1"></a>both groups should be similar.</span>
<span id="cb106-47"><a href="#cb106-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-48"><a href="#cb106-48" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">(</span><span class="co">]</span>{afghan<span class="sc">\_</span>girls}{micsr.data}</span>
<span id="cb106-49"><a href="#cb106-49" aria-hidden="true" tabindex="-1"></a>To illustrate the use of randomized experiments, we consider the study</span>
<span id="cb106-50"><a href="#cb106-50" aria-hidden="true" tabindex="-1"></a>of @BURD:LIND:13\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Linden}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Linden} who study the effect of village-based schools on</span>
<span id="cb106-51"><a href="#cb106-51" aria-hidden="true" tabindex="-1"></a>children's academic performance. The sample comprises villages from</span>
<span id="cb106-52"><a href="#cb106-52" aria-hidden="true" tabindex="-1"></a>the Ghor province in northwestern Afghanistan. More specifically, 31</span>
<span id="cb106-53"><a href="#cb106-53" aria-hidden="true" tabindex="-1"></a>villages were selected and formed 11 village groups. Five of them</span>
<span id="cb106-54"><a href="#cb106-54" aria-hidden="true" tabindex="-1"></a>received a village-based school in summer 2007. In fall 2007, a</span>
<span id="cb106-55"><a href="#cb106-55" aria-hidden="true" tabindex="-1"></a>survey was conducted in the 31 villages. The two outcomes of interest</span>
<span id="cb106-56"><a href="#cb106-56" aria-hidden="true" tabindex="-1"></a>are the enrollment status of children between the ages of 6 and 11 and the score obtained to a short test covering math and language skills.</span>
<span id="cb106-57"><a href="#cb106-57" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb106-58"><a href="#cb106-58" aria-hidden="true" tabindex="-1"></a>The first step of the analysis consists of checking that the</span>
<span id="cb106-59"><a href="#cb106-59" aria-hidden="true" tabindex="-1"></a>observable characteristics are similar in the treatment and in the</span>
<span id="cb106-60"><a href="#cb106-60" aria-hidden="true" tabindex="-1"></a>control group. For numerical variables, this can be performed using a t</span>
<span id="cb106-61"><a href="#cb106-61" aria-hidden="true" tabindex="-1"></a>test of equal means. Assume that $x$ is drawn from a normal distribution, with potentially a different mean for the treatment and for the control group, but the same variance $\sigma_x ^ 2$. Then, $\bar{x}_T = \sum_{n\in T} x_n / N_T$ and $\bar{x}_C = \sum_{n\in C} x_n / N_C$ are normal variables with means equal to $\mu_T$ and $\mu_C$ and a variance equal respectively to $\sigma_x ^ 2 / N_T$ and $\sigma_x ^ 2 / N_C$. Moreover, the difference of the means is also a normal variable with mean $\mu_T - \mu_C$ and a variance equal to the sum of the two variances, the covariance being null for a random sample. Therefore:</span>
<span id="cb106-62"><a href="#cb106-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-63"><a href="#cb106-63" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-64"><a href="#cb106-64" aria-hidden="true" tabindex="-1"></a>\frac{(\bar{x}_T - \bar{x}_C) - (\mu_T - \mu_C)}{\sigma_x\sqrt{1 / N_T + 1 / N_C}} \sim \mathcal{N}(0, 1)</span>
<span id="cb106-65"><a href="#cb106-65" aria-hidden="true" tabindex="-1"></a>$$ {#eq-two_smpl_normal}</span>
<span id="cb106-66"><a href="#cb106-66" aria-hidden="true" tabindex="-1"></a>Replacing the unknown $\sigma_x ^ 2$ by the unbiased estimate: </span>
<span id="cb106-67"><a href="#cb106-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-68"><a href="#cb106-68" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-69"><a href="#cb106-69" aria-hidden="true" tabindex="-1"></a>\hat{\sigma}_x ^ 2 = \frac{\sum_{n\in T} (x_n - \bar{x}_T) ^ 2 + \sum_{n\in C} (x_n - \bar{x}_C) ^ 2}{N_T + N_C - 2}</span>
<span id="cb106-70"><a href="#cb106-70" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-71"><a href="#cb106-71" aria-hidden="true" tabindex="-1"></a>and, with the hypothesis of equal mean ($H_0: \mu_T = \mu_C$), $\frac{\bar{x}_T - \bar{x}_C}{\hat{\sigma}_x \sqrt{1/N_T + 1/N_C}}$  is a Student t with $N_T + N_C - 2$ degrees of freedom. The Student t-test assumes that the variance of $x$ is the same in both groups. Welch's t-test, or the unequal variance t-test, extends the simple t-test to the case where the variance of $x$ is different in the two groups.</span>
<span id="cb106-72"><a href="#cb106-72" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{t-test|(}\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{Welch's t-test}\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{t-test!Welch}</span>
<span id="cb106-73"><a href="#cb106-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-74"><a href="#cb106-74" aria-hidden="true" tabindex="-1"></a><span class="in">`stats::t.test`</span> computes the two flavors</span>
<span id="cb106-75"><a href="#cb106-75" aria-hidden="true" tabindex="-1"></a>of the test. It uses a formula-data interface and has a supplementary argument called <span class="in">`var.equal`</span> which is <span class="in">`FALSE`</span> by default. Therefore, Welch's version of the test is computed by default and the simple t-test is obtained by setting <span class="in">`var.equal`</span> to <span class="in">`TRUE`</span>. We apply the two flavors of the test to the <span class="in">`distance`</span> variable, which is the distance to the nearest formal school, using the <span class="in">`group`</span> variable which is a factor with levels <span class="in">`"control"`</span> and <span class="in">`"treatment"`</span>:</span>
<span id="cb106-76"><a href="#cb106-76" aria-hidden="true" tabindex="-1"></a>\idxfun{t.test}{stats}\idxfun{gaze}{micsr}</span>
<span id="cb106-77"><a href="#cb106-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-78"><a href="#cb106-78" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-79"><a href="#cb106-79" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: welch_afghan_girls</span></span>
<span id="cb106-80"><a href="#cb106-80" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: true</span></span>
<span id="cb106-81"><a href="#cb106-81" aria-hidden="true" tabindex="-1"></a><span class="fu">t.test</span>(distance <span class="sc">~</span> group, afghan_girls) <span class="sc">%&gt;%</span> gaze</span>
<span id="cb106-82"><a href="#cb106-82" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-83"><a href="#cb106-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-84"><a href="#cb106-84" aria-hidden="true" tabindex="-1"></a>and the hypothesis of equal mean is highly rejected. Computing the simple version of the t-test:</span>
<span id="cb106-85"><a href="#cb106-85" aria-hidden="true" tabindex="-1"></a>\idxfun{t.test}{stats}\idxfun{gaze}{micsr}</span>
<span id="cb106-86"><a href="#cb106-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-87"><a href="#cb106-87" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-88"><a href="#cb106-88" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: true</span></span>
<span id="cb106-89"><a href="#cb106-89" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: ttest_afghan_girls</span></span>
<span id="cb106-90"><a href="#cb106-90" aria-hidden="true" tabindex="-1"></a><span class="fu">t.test</span>(distance <span class="sc">~</span> group, afghan_girls, <span class="at">var.equal =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> gaze</span>
<span id="cb106-91"><a href="#cb106-91" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-92"><a href="#cb106-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-93"><a href="#cb106-93" aria-hidden="true" tabindex="-1"></a>we get almost the same result. This last version of the test is equivalent to the result of a</span>
<span id="cb106-94"><a href="#cb106-94" aria-hidden="true" tabindex="-1"></a>regression of the outcome variable on the group dummy:</span>
<span id="cb106-95"><a href="#cb106-95" aria-hidden="true" tabindex="-1"></a>\idxfun{lm}{stats}\idxfun{gaze}{micsr}</span>
<span id="cb106-96"><a href="#cb106-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-97"><a href="#cb106-97" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-98"><a href="#cb106-98" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: lm_afghan_girls</span></span>
<span id="cb106-99"><a href="#cb106-99" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: true</span></span>
<span id="cb106-100"><a href="#cb106-100" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(distance <span class="sc">~</span> group, afghan_girls) <span class="sc">%&gt;%</span> gaze</span>
<span id="cb106-101"><a href="#cb106-101" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-102"><a href="#cb106-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-103"><a href="#cb106-103" aria-hidden="true" tabindex="-1"></a>The coefficient of the intercept is the mean for the control group and the coefficient of <span class="in">`grouptreatment`</span> is the difference of the means for the two groups. The t-value is exactly the one obtained using <span class="in">`t.test`</span> with <span class="in">`var.equal = TRUE`</span>.</span>
<span id="cb106-104"><a href="#cb106-104" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{t-test|)}</span>
<span id="cb106-105"><a href="#cb106-105" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{Pearson's chi-square test|(}\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{chi-square test|(}</span>
<span id="cb106-106"><a href="#cb106-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-107"><a href="#cb106-107" aria-hidden="true" tabindex="-1"></a>Balance between groups of factors can be tested using Pearson's</span>
<span id="cb106-108"><a href="#cb106-108" aria-hidden="true" tabindex="-1"></a>$\chi^2$ test. It is based on the comparison of the observed joint</span>
<span id="cb106-109"><a href="#cb106-109" aria-hidden="true" tabindex="-1"></a>distribution of the two variables and the one obtained using the</span>
<span id="cb106-110"><a href="#cb106-110" aria-hidden="true" tabindex="-1"></a>independence hypotheses (obtained by multiplying the marginal</span>
<span id="cb106-111"><a href="#cb106-111" aria-hidden="true" tabindex="-1"></a>frequencies of the two variables). </span>
<span id="cb106-112"><a href="#cb106-112" aria-hidden="true" tabindex="-1"></a>Denote $o$ and $e$ the observed and the hypothesized frequencies, $i$ the index of the cell and $N$ the size of the</span>
<span id="cb106-113"><a href="#cb106-113" aria-hidden="true" tabindex="-1"></a>sample:</span>
<span id="cb106-114"><a href="#cb106-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-115"><a href="#cb106-115" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-116"><a href="#cb106-116" aria-hidden="true" tabindex="-1"></a>\sum_i \frac{(o_i - e_i) ^ 2}{e_i}</span>
<span id="cb106-117"><a href="#cb106-117" aria-hidden="true" tabindex="-1"></a>$$ {#eq-pearson_chi2}</span>
<span id="cb106-118"><a href="#cb106-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-119"><a href="#cb106-119" aria-hidden="true" tabindex="-1"></a>the statistic is, under the hypothesis of independence, a $\chi</span>
<span id="cb106-120"><a href="#cb106-120" aria-hidden="true" tabindex="-1"></a>^ 2$ with a number of degrees of freedom equal to $(J_1 -1) \times</span>
<span id="cb106-121"><a href="#cb106-121" aria-hidden="true" tabindex="-1"></a>(J_2 - 1)$ where $J_1$ and $J_2$ are the number of modalities for the</span>
<span id="cb106-122"><a href="#cb106-122" aria-hidden="true" tabindex="-1"></a>two factors.</span>
<span id="cb106-123"><a href="#cb106-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-124"><a href="#cb106-124" aria-hidden="true" tabindex="-1"></a>In the <span class="in">`afghan_girls`</span> data set, <span class="in">`ethny`</span> is a factor with levels <span class="in">`"other"`</span>, <span class="in">`"farsi"`</span> and <span class="in">`"tajik"`</span>. We first compute the frequency table using the <span class="in">`table`</span> function, which is similar to <span class="in">`dplyr::count`</span>, but the input is a series and not a data frame and the result is an object of class <span class="in">`table`</span>, which is much alike an object of class <span class="in">`matrix`</span>, and not a data frame. We then compute the relative frequencies using the <span class="in">`prop.table`</span> function. Note that <span class="in">`prop.table`</span> has a <span class="in">`margin`</span> argument that we don't use here.^<span class="co">[</span><span class="ot">If `margin = 1`, the frequencies sum to one for each line, and if `margin = 2`, they sum to one for each column.</span><span class="co">]</span></span>
<span id="cb106-125"><a href="#cb106-125" aria-hidden="true" tabindex="-1"></a>\idxfun{table}{base}\idxfun{prop.table}{base}</span>
<span id="cb106-126"><a href="#cb106-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-127"><a href="#cb106-127" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-128"><a href="#cb106-128" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: obs_freq</span></span>
<span id="cb106-129"><a href="#cb106-129" aria-hidden="true" tabindex="-1"></a>obs_freq <span class="ot">&lt;-</span> <span class="fu">prop.table</span>(<span class="fu">table</span>(afghan_girls<span class="sc">$</span>group, afghan_girls<span class="sc">$</span>ethny))</span>
<span id="cb106-130"><a href="#cb106-130" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-131"><a href="#cb106-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-132"><a href="#cb106-132" aria-hidden="true" tabindex="-1"></a>In case of independence, the frequencies are obtained using the outer product of the marginal frequencies:</span>
<span id="cb106-133"><a href="#cb106-133" aria-hidden="true" tabindex="-1"></a>\idxfun{table}{base}\idxfun{prop.table}{base}\idxfun{outer}{base}</span>
<span id="cb106-134"><a href="#cb106-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-135"><a href="#cb106-135" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-136"><a href="#cb106-136" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: indep_freq</span></span>
<span id="cb106-137"><a href="#cb106-137" aria-hidden="true" tabindex="-1"></a>freq_group <span class="ot">&lt;-</span> <span class="fu">prop.table</span>(<span class="fu">table</span>(afghan_girls<span class="sc">$</span>group))</span>
<span id="cb106-138"><a href="#cb106-138" aria-hidden="true" tabindex="-1"></a>freq_ethny <span class="ot">&lt;-</span> <span class="fu">prop.table</span>(<span class="fu">table</span>(afghan_girls<span class="sc">$</span>ethny))</span>
<span id="cb106-139"><a href="#cb106-139" aria-hidden="true" tabindex="-1"></a>ind_freq <span class="ot">&lt;-</span> <span class="fu">outer</span>(freq_group, freq_ethny)</span>
<span id="cb106-140"><a href="#cb106-140" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-141"><a href="#cb106-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-142"><a href="#cb106-142" aria-hidden="true" tabindex="-1"></a>Applying @eq-pearson_chi2, we obtain:</span>
<span id="cb106-143"><a href="#cb106-143" aria-hidden="true" tabindex="-1"></a>\idxfun{nrow}{base}</span>
<span id="cb106-144"><a href="#cb106-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-145"><a href="#cb106-145" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-146"><a href="#cb106-146" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: pearson_by_hand</span></span>
<span id="cb106-147"><a href="#cb106-147" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: true</span></span>
<span id="cb106-148"><a href="#cb106-148" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>((obs_freq <span class="sc">-</span> ind_freq) <span class="sc">^</span> <span class="dv">2</span> <span class="sc">/</span> ind_freq) <span class="sc">*</span> <span class="fu">nrow</span>(afghan_girls)</span>
<span id="cb106-149"><a href="#cb106-149" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-150"><a href="#cb106-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-151"><a href="#cb106-151" aria-hidden="true" tabindex="-1"></a>This test can be conveniently computed using the <span class="in">`stats:chisq.test`</span> function:</span>
<span id="cb106-152"><a href="#cb106-152" aria-hidden="true" tabindex="-1"></a>\idxfun{chisq.test}{stats}\idxfun{gaze}{micsr}</span>
<span id="cb106-153"><a href="#cb106-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-154"><a href="#cb106-154" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-155"><a href="#cb106-155" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: pearson_chisq_test</span></span>
<span id="cb106-156"><a href="#cb106-156" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: true</span></span>
<span id="cb106-157"><a href="#cb106-157" aria-hidden="true" tabindex="-1"></a><span class="fu">chisq.test</span>(<span class="fu">table</span>(afghan_girls<span class="sc">$</span>group, afghan_girls<span class="sc">$</span>ethny)) <span class="sc">%&gt;%</span> gaze</span>
<span id="cb106-158"><a href="#cb106-158" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-159"><a href="#cb106-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-160"><a href="#cb106-160" aria-hidden="true" tabindex="-1"></a>and the hypothesis of independence is not rejected. </span>
<span id="cb106-161"><a href="#cb106-161" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{Pearson's chi-square test|)}\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{chi-square test|)}</span>
<span id="cb106-162"><a href="#cb106-162" aria-hidden="true" tabindex="-1"></a>The whole table of balance is often called "Table 1", as it is the first table that appears in most articles in medical reviews. It </span>
<span id="cb106-163"><a href="#cb106-163" aria-hidden="true" tabindex="-1"></a>can be computed using the <span class="in">`gtsummary::tbl_summary`</span> function, which has a <span class="in">`by`</span> argument that indicates the grouping variable.  <span class="in">`tbl_summary`</span> has a lot of arguments, and auxiliary functions that enables to customize the results.^<span class="co">[</span><span class="ot">Detailed documentation of the package can be found on the website of the package &lt;https://www.danieldsjoberg.com/gtsummary/&gt; and on @SJOB:21.\index[author]{Sjoberg}\index[author]{Whiting}\index[author]{Curry}\index[author]{Lavery}\index[author]{Larmarange}</span><span class="co">]</span> The balance table for the <span class="in">`afghan_girls`</span> data set is</span>
<span id="cb106-164"><a href="#cb106-164" aria-hidden="true" tabindex="-1"></a>presented in @tbl-balance_afghan.^<span class="co">[</span><span class="ot">Note that we also used some functions of the **kableExtra** package for fine-tuning the table.</span><span class="co">]</span></span>
<span id="cb106-165"><a href="#cb106-165" aria-hidden="true" tabindex="-1"></a>\idxfun{select}{dplyr}\idxfun{tbl<span class="sc">\_</span>summary}{gtsummary}</span>
<span id="cb106-166"><a href="#cb106-166" aria-hidden="true" tabindex="-1"></a>\idxfun{style<span class="sc">\_</span>pvalue}{gtsummary}\idxfun{all<span class="sc">\_</span>continuous}{gtsummary}\idxfun{add<span class="sc">\_</span>p}{gtsummary}\idxfun{as<span class="sc">\_</span>kable<span class="sc">\_</span>extra}{kableExtra}\idxfun{kable<span class="sc">\_</span>styling}{kableExtra}\idxfun{column<span class="sc">\_</span>spec}{kableExtra}</span>
<span id="cb106-167"><a href="#cb106-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-168"><a href="#cb106-168" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-169"><a href="#cb106-169" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Balance table for the Afghan girls data set"</span></span>
<span id="cb106-170"><a href="#cb106-170" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-balance_afghan</span></span>
<span id="cb106-171"><a href="#cb106-171" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb106-172"><a href="#cb106-172" aria-hidden="true" tabindex="-1"></a><span class="co">#| cache: true</span></span>
<span id="cb106-173"><a href="#cb106-173" aria-hidden="true" tabindex="-1"></a><span class="co">#| results: asis</span></span>
<span id="cb106-174"><a href="#cb106-174" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"gtsummary"</span>) ; <span class="fu">library</span>(<span class="st">"kableExtra"</span>)</span>
<span id="cb106-175"><a href="#cb106-175" aria-hidden="true" tabindex="-1"></a>afghan_girls <span class="sc">%&gt;%</span></span>
<span id="cb106-176"><a href="#cb106-176" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(group, head_child<span class="sc">:</span>ethny) <span class="sc">%&gt;%</span> </span>
<span id="cb106-177"><a href="#cb106-177" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tbl_summary</span>(<span class="at">by =</span> group,</span>
<span id="cb106-178"><a href="#cb106-178" aria-hidden="true" tabindex="-1"></a>                <span class="at">missing =</span> <span class="st">"no"</span>,</span>
<span id="cb106-179"><a href="#cb106-179" aria-hidden="true" tabindex="-1"></a>                <span class="at">statistic =</span> <span class="fu">all_continuous</span>() <span class="sc">~</span> <span class="st">"{mean} ({sd})"</span>,</span>
<span id="cb106-180"><a href="#cb106-180" aria-hidden="true" tabindex="-1"></a>                <span class="at">type =</span> <span class="fu">list</span>(age <span class="sc">~</span> <span class="st">"continuous"</span>),</span>
<span id="cb106-181"><a href="#cb106-181" aria-hidden="true" tabindex="-1"></a>                <span class="at">digits =</span> <span class="fu">all_continuous</span>() <span class="sc">~</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb106-182"><a href="#cb106-182" aria-hidden="true" tabindex="-1"></a>    <span class="fu">add_p</span>(<span class="fu">all_continuous</span>() <span class="sc">~</span> <span class="st">"t.test"</span>,</span>
<span id="cb106-183"><a href="#cb106-183" aria-hidden="true" tabindex="-1"></a>          <span class="at">pvalue_fun =</span> <span class="sc">~</span> <span class="fu">style_pvalue</span>(., <span class="at">digits =</span> <span class="dv">2</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb106-184"><a href="#cb106-184" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_kable_extra</span>(<span class="at">booktabs =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> <span class="fu">kable_styling</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb106-185"><a href="#cb106-185" aria-hidden="true" tabindex="-1"></a>    <span class="fu">column_spec</span>(<span class="dv">1</span>, <span class="at">width =</span> <span class="st">"15em"</span>)</span>
<span id="cb106-186"><a href="#cb106-186" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-187"><a href="#cb106-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-188"><a href="#cb106-188" aria-hidden="true" tabindex="-1"></a>The set of tests doesn't detect any significant differences between the</span>
<span id="cb106-189"><a href="#cb106-189" aria-hidden="true" tabindex="-1"></a>two groups for the covariates <span class="in">`head_child`</span>, <span class="in">`sex`</span>, <span class="in">`age`</span>, <span class="in">`occup`</span>,</span>
<span id="cb106-190"><a href="#cb106-190" aria-hidden="true" tabindex="-1"></a><span class="in">`age_head`</span>, <span class="in">`jeribs`</span>, <span class="in">`distance`</span> and <span class="in">`ethny`</span>. On the contrary, for the</span>
<span id="cb106-191"><a href="#cb106-191" aria-hidden="true" tabindex="-1"></a><span class="in">`duration`</span>, <span class="in">`hsize`</span>, <span class="in">`sheeps`</span> and <span class="in">`distance`</span> covariates, the equal mean</span>
<span id="cb106-192"><a href="#cb106-192" aria-hidden="true" tabindex="-1"></a>hypothesis is strongly rejected.</span>
<span id="cb106-193"><a href="#cb106-193" aria-hidden="true" tabindex="-1"></a>The next step is to apply the same tests to the outcomes which are, in</span>
<span id="cb106-194"><a href="#cb106-194" aria-hidden="true" tabindex="-1"></a>this study, <span class="in">`enrollment`</span> and <span class="in">`test`</span>. For the <span class="in">`test`</span> variable, a boxplot is presented in @fig-bxp_test, with a separate plot for boys and</span>
<span id="cb106-195"><a href="#cb106-195" aria-hidden="true" tabindex="-1"></a>girls.</span>
<span id="cb106-196"><a href="#cb106-196" aria-hidden="true" tabindex="-1"></a>\idxfun{ggplot}{ggplot2}\idxfun{aes}{ggplot2}\idxfun{geom<span class="sc">\_</span>boxplot}{ggplot2}\idxfun{facet<span class="sc">\_</span>wrap}{ggplot2}</span>
<span id="cb106-197"><a href="#cb106-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-198"><a href="#cb106-198" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-199"><a href="#cb106-199" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-bxp_test</span></span>
<span id="cb106-200"><a href="#cb106-200" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb106-201"><a href="#cb106-201" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Boxplot for the test variable between the control and the treatment group"</span></span>
<span id="cb106-202"><a href="#cb106-202" aria-hidden="true" tabindex="-1"></a>afghan_girls <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(group, test)) <span class="sc">+</span> </span>
<span id="cb106-203"><a href="#cb106-203" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>() <span class="sc">+</span> <span class="fu">facet_wrap</span>(<span class="sc">~</span> sex)</span>
<span id="cb106-204"><a href="#cb106-204" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-205"><a href="#cb106-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-206"><a href="#cb106-206" aria-hidden="true" tabindex="-1"></a>There seems to be a large positive effect of the treatment on the</span>
<span id="cb106-207"><a href="#cb106-207" aria-hidden="true" tabindex="-1"></a>results of the test. Moreover, the scores for boys are much higher than</span>
<span id="cb106-208"><a href="#cb106-208" aria-hidden="true" tabindex="-1"></a>for girls. For girls, we get:</span>
<span id="cb106-209"><a href="#cb106-209" aria-hidden="true" tabindex="-1"></a>\idxfun{t.test}{stats}\idxfun{gaze}{micsr}</span>
<span id="cb106-210"><a href="#cb106-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-211"><a href="#cb106-211" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-212"><a href="#cb106-212" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: true</span></span>
<span id="cb106-213"><a href="#cb106-213" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tttest_afghan_outcome</span></span>
<span id="cb106-214"><a href="#cb106-214" aria-hidden="true" tabindex="-1"></a><span class="fu">t.test</span>(test <span class="sc">~</span> group, afghan_girls, <span class="at">subset =</span> sex <span class="sc">==</span> <span class="st">"girl"</span>) <span class="sc">%&gt;%</span> gaze</span>
<span id="cb106-215"><a href="#cb106-215" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-216"><a href="#cb106-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-217"><a href="#cb106-217" aria-hidden="true" tabindex="-1"></a>The effect is strong (about 0.75, which means three-quarters of a</span>
<span id="cb106-218"><a href="#cb106-218" aria-hidden="true" tabindex="-1"></a>standard deviation of the score, as this variable is standardized) and</span>
<span id="cb106-219"><a href="#cb106-219" aria-hidden="true" tabindex="-1"></a>highly significant. As some covariates are unbalanced, this estimator</span>
<span id="cb106-220"><a href="#cb106-220" aria-hidden="true" tabindex="-1"></a>may be biased. Therefore, it is recommended to measure the effect as</span>
<span id="cb106-221"><a href="#cb106-221" aria-hidden="true" tabindex="-1"></a>the coefficient of <span class="in">`group`</span> in a multiple regression with all the</span>
<span id="cb106-222"><a href="#cb106-222" aria-hidden="true" tabindex="-1"></a>available controlling variables. Moreover, adding relevant variables</span>
<span id="cb106-223"><a href="#cb106-223" aria-hidden="true" tabindex="-1"></a>will increase the precision of the estimation. </span>
<span id="cb106-224"><a href="#cb106-224" aria-hidden="true" tabindex="-1"></a>\idxfun{lm}{stats}\idxfun{gaze}{micsr}</span>
<span id="cb106-225"><a href="#cb106-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-226"><a href="#cb106-226" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-227"><a href="#cb106-227" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: lm_afghan_outcome</span></span>
<span id="cb106-228"><a href="#cb106-228" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: true</span></span>
<span id="cb106-229"><a href="#cb106-229" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(test <span class="sc">~</span> group <span class="sc">+</span> chagcharan <span class="sc">+</span> head_child <span class="sc">+</span> age <span class="sc">+</span> duration <span class="sc">+</span> occup <span class="sc">+</span></span>
<span id="cb106-230"><a href="#cb106-230" aria-hidden="true" tabindex="-1"></a>       age_head <span class="sc">+</span> educ <span class="sc">+</span> hsize <span class="sc">+</span> jeribs <span class="sc">+</span> sheeps <span class="sc">+</span> distance <span class="sc">+</span> ethny,</span>
<span id="cb106-231"><a href="#cb106-231" aria-hidden="true" tabindex="-1"></a>   afghan_girls, <span class="at">subset =</span> sex <span class="sc">==</span> <span class="st">"girl"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb106-232"><a href="#cb106-232" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gaze</span>(<span class="at">coef =</span> <span class="dv">2</span>)</span>
<span id="cb106-233"><a href="#cb106-233" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-234"><a href="#cb106-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-235"><a href="#cb106-235" aria-hidden="true" tabindex="-1"></a>The coefficient is slightly lower but still very significant.</span>
<span id="cb106-236"><a href="#cb106-236" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">)</span><span class="co">]</span>{afghan<span class="sc">\_</span>girls}{micsr.data}</span>
<span id="cb106-237"><a href="#cb106-237" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{randomized experiment|)}</span>
<span id="cb106-238"><a href="#cb106-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-239"><a href="#cb106-239" aria-hidden="true" tabindex="-1"></a><span class="fu">## Instrumental variable estimator {#sec-iv_te}</span></span>
<span id="cb106-240"><a href="#cb106-240" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{instrumental variable estimator!treatment effect|(}</span>
<span id="cb106-241"><a href="#cb106-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-242"><a href="#cb106-242" aria-hidden="true" tabindex="-1"></a>@IMBE:ANGR:94\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Imbens}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Angrist} and @ANGR:IMBE:RUBI:96\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Imbens}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Angrist}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Rubin} consider the use of instrumental</span>
<span id="cb106-243"><a href="#cb106-243" aria-hidden="true" tabindex="-1"></a>variables in the context of the potential outcome</span>
<span id="cb106-244"><a href="#cb106-244" aria-hidden="true" tabindex="-1"></a>model. We consider the simple case where the treatment $d$ is</span>
<span id="cb106-245"><a href="#cb106-245" aria-hidden="true" tabindex="-1"></a>binary and the instrument $w$ is also binary.^<span class="co">[</span><span class="ot">This is the setting of the Wald estimator that was presented in @sec-wald_estimator.</span><span class="co">]</span> </span>
<span id="cb106-246"><a href="#cb106-246" aria-hidden="true" tabindex="-1"></a>The value of the outcome for individual $n$ for a given combination of</span>
<span id="cb106-247"><a href="#cb106-247" aria-hidden="true" tabindex="-1"></a>$d$ and $w$ is denoted by: $y_n(w_n, d_n)$; $w$ can be used as an</span>
<span id="cb106-248"><a href="#cb106-248" aria-hidden="true" tabindex="-1"></a>instrumental variable if $w$ is related to $y$ only because of its</span>
<span id="cb106-249"><a href="#cb106-249" aria-hidden="true" tabindex="-1"></a>influence on $d$. Stated differently, for a given value of $d$, $y$ is</span>
<span id="cb106-250"><a href="#cb106-250" aria-hidden="true" tabindex="-1"></a>the same whatever the value of $w$: $y_n(0, d_n) = y_n(1, d_n)$. This</span>
<span id="cb106-251"><a href="#cb106-251" aria-hidden="true" tabindex="-1"></a>is the **exclusion restriction**, standard in the instrumental</span>
<span id="cb106-252"><a href="#cb106-252" aria-hidden="true" tabindex="-1"></a>variable literature. Therefore, potential outcome can be defined as a</span>
<span id="cb106-253"><a href="#cb106-253" aria-hidden="true" tabindex="-1"></a>function of the treatment variable only: $y_n(w_n, d_n) = y_n(d_n)$</span>
<span id="cb106-254"><a href="#cb106-254" aria-hidden="true" tabindex="-1"></a>and $d_n$ can be expressed as a function of $d_n$: $d_n(w_n)$.</span>
<span id="cb106-255"><a href="#cb106-255" aria-hidden="true" tabindex="-1"></a>The next assumption is that on average, $w$ has a causal effect on</span>
<span id="cb106-256"><a href="#cb106-256" aria-hidden="true" tabindex="-1"></a>$d$: $\mbox{E}\left(d(1)  - d(0)\right) \neq 0$.</span>
<span id="cb106-257"><a href="#cb106-257" aria-hidden="true" tabindex="-1"></a>The last assumption is **monotonicity** <span class="co">[</span><span class="ot">@IMBE:ANGR:94</span><span class="co">]</span>\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Imbens}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Angrist} which states</span>
<span id="cb106-258"><a href="#cb106-258" aria-hidden="true" tabindex="-1"></a>that $d_n(1) \geq d_n(0) \; \forall n$. \index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{monotonicity hypothesis}</span>
<span id="cb106-259"><a href="#cb106-259" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{exclusion restriction}</span>
<span id="cb106-260"><a href="#cb106-260" aria-hidden="true" tabindex="-1"></a>With these assumptions in hand, the causal effect of $w$ on $y$ is:</span>
<span id="cb106-261"><a href="#cb106-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-262"><a href="#cb106-262" aria-hidden="true" tabindex="-1"></a>$$\begin{array}{rcl}</span>
<span id="cb106-263"><a href="#cb106-263" aria-hidden="true" tabindex="-1"></a>y_n(1, d_n(1)) - y_n(0, d_n(0)) &amp;=&amp; y_n(d_n(1)) - y_n(d_n(0)) <span class="sc">\\</span></span>
<span id="cb106-264"><a href="#cb106-264" aria-hidden="true" tabindex="-1"></a>&amp;=&amp; \left<span class="co">[</span><span class="ot">y_n(1) d_n(1) + y_n(0) (1 - d_n(1))\right</span><span class="co">]</span> <span class="sc">\\</span></span>
<span id="cb106-265"><a href="#cb106-265" aria-hidden="true" tabindex="-1"></a>&amp;-&amp; \left<span class="co">[</span><span class="ot">y_n(1) d_n(0) - y_n(0) (1 - d_n(0))\right</span><span class="co">]</span> <span class="sc">\\</span></span>
<span id="cb106-266"><a href="#cb106-266" aria-hidden="true" tabindex="-1"></a>&amp;=&amp; (y_n(1) - y_n(0)) (d_n(1) - d_n(0))</span>
<span id="cb106-267"><a href="#cb106-267" aria-hidden="true" tabindex="-1"></a>\end{array}</span>
<span id="cb106-268"><a href="#cb106-268" aria-hidden="true" tabindex="-1"></a>$$ {#eq-fourcats}</span>
<span id="cb106-269"><a href="#cb106-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-270"><a href="#cb106-270" aria-hidden="true" tabindex="-1"></a>Therefore, the causal effect of $w$ on $y$ is the product of the</span>
<span id="cb106-271"><a href="#cb106-271" aria-hidden="true" tabindex="-1"></a>causal effects of $d$ on $y$ and of $w$ on $d$.</span>
<span id="cb106-272"><a href="#cb106-272" aria-hidden="true" tabindex="-1"></a>Consider now the relation between $w$ and $d$ at the individual</span>
<span id="cb106-273"><a href="#cb106-273" aria-hidden="true" tabindex="-1"></a>level. Four categories can be considered (represented on @fig-ivset):</span>
<span id="cb106-274"><a href="#cb106-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-275"><a href="#cb106-275" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>compliers: $d_n(1) = 1$ and $d_n(0) = 0$,</span>
<span id="cb106-276"><a href="#cb106-276" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>always takers: $d_n(1) = d_n(0) = 1$,</span>
<span id="cb106-277"><a href="#cb106-277" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>never takers: $d_n(1) = d_n(0) = 0$,</span>
<span id="cb106-278"><a href="#cb106-278" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>deniers: $d_n(1) = 0$ and $d_n(0) = 1$.</span>
<span id="cb106-279"><a href="#cb106-279" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{compliers}</span>
<span id="cb106-280"><a href="#cb106-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-281"><a href="#cb106-281" aria-hidden="true" tabindex="-1"></a><span class="al">![The four categories of individuals](./tikz/iv_set.pdf)</span>{#fig-ivset}</span>
<span id="cb106-282"><a href="#cb106-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-283"><a href="#cb106-283" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{counterfactual}</span>
<span id="cb106-284"><a href="#cb106-284" aria-hidden="true" tabindex="-1"></a>There are four observable categories of individuals, represented by the</span>
<span id="cb106-285"><a href="#cb106-285" aria-hidden="true" tabindex="-1"></a>four squares and named by the two digits (the observed values of $w$ and $d$) indicated in a gray square. The counterfactuals are represented by two circles inside the square.</span>
<span id="cb106-286"><a href="#cb106-286" aria-hidden="true" tabindex="-1"></a>For example, the square called $00$ contains the individuals</span>
<span id="cb106-287"><a href="#cb106-287" aria-hidden="true" tabindex="-1"></a>for which $w=0$ and $d=0$. For those individuals the unobserved</span>
<span id="cb106-288"><a href="#cb106-288" aria-hidden="true" tabindex="-1"></a>counterfactual is $w=1$ and $d$ either equal to 0 or 1. If the counterfactual is $w = 1, d = 0$, the individual is a never-taker, $d= 0$ whatever the value of $w$. If the counterfactual is $w=1, d=1$, the individual is a complier: with $w=0$, $d=0$, but a change of $w$ from 0 to 1 results in a change of $d$ from 0 to 1.</span>
<span id="cb106-289"><a href="#cb106-289" aria-hidden="true" tabindex="-1"></a>With the always takers and the never takers, the causal effect of $w$</span>
<span id="cb106-290"><a href="#cb106-290" aria-hidden="true" tabindex="-1"></a>on $y$ in @eq-fourcats is zero because the causal effect of $w$ on $d$ is zero. The monotonicity assumption</span>
<span id="cb106-291"><a href="#cb106-291" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{monotonicity hypothesis} rules out</span>
<span id="cb106-292"><a href="#cb106-292" aria-hidden="true" tabindex="-1"></a>the existence of deniers. Therefore, the causal effect of $w$ on $d$</span>
<span id="cb106-293"><a href="#cb106-293" aria-hidden="true" tabindex="-1"></a>reduces to the treatment effect for the compliers. </span>
<span id="cb106-294"><a href="#cb106-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-295"><a href="#cb106-295" aria-hidden="true" tabindex="-1"></a>Consider now the instrumental variable estimator. It estimates, in the</span>
<span id="cb106-296"><a href="#cb106-296" aria-hidden="true" tabindex="-1"></a>general case, the following population estimand: $\frac{\mbox{cov}(y, w)}{\mbox{cov}(d, w)}$, </span>
<span id="cb106-297"><a href="#cb106-297" aria-hidden="true" tabindex="-1"></a>which, for the case where both $d$ and $w$ are binary, reduces to:</span>
<span id="cb106-298"><a href="#cb106-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-299"><a href="#cb106-299" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-300"><a href="#cb106-300" aria-hidden="true" tabindex="-1"></a>\frac{\mbox{E}\left(y(1, d(1)) - y(0, d(0))\right)}</span>
<span id="cb106-301"><a href="#cb106-301" aria-hidden="true" tabindex="-1"></a>{\mbox{E}\left(d(1) - d(0)\right)}</span>
<span id="cb106-302"><a href="#cb106-302" aria-hidden="true" tabindex="-1"></a>$$ {#eq-late}</span>
<span id="cb106-303"><a href="#cb106-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-304"><a href="#cb106-304" aria-hidden="true" tabindex="-1"></a>The numerator is the average causal effect of $w$ on $y$ for the</span>
<span id="cb106-305"><a href="#cb106-305" aria-hidden="true" tabindex="-1"></a>compliers and the denominator is the share of compliers in the</span>
<span id="cb106-306"><a href="#cb106-306" aria-hidden="true" tabindex="-1"></a>population. @ANGR:IMBE:RUBI:96\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Imbens}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Angrist}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Rubin} call @eq-late the **local average treatment effect** (**LATE**)\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{local average treatment effect}\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{treatment effect!local average treatment effect} to stress the fact that what is estimated</span>
<span id="cb106-307"><a href="#cb106-307" aria-hidden="true" tabindex="-1"></a>using the instrumental variable estimator is an average treatment</span>
<span id="cb106-308"><a href="#cb106-308" aria-hidden="true" tabindex="-1"></a>effect for only a subset of the population called the compliers, ie</span>
<span id="cb106-309"><a href="#cb106-309" aria-hidden="true" tabindex="-1"></a>those for which a change in the value of $w$ results in a change in the</span>
<span id="cb106-310"><a href="#cb106-310" aria-hidden="true" tabindex="-1"></a>value of $d$.</span>
<span id="cb106-311"><a href="#cb106-311" aria-hidden="true" tabindex="-1"></a>The numerator is also called the **reduced form** equation, as it measures the effect of the instrument on the outcome. The denominator is called the **intention to treat** equation, it measures the effect of the instrument on the treatment dummy.</span>
<span id="cb106-312"><a href="#cb106-312" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{intention to treat}</span>
<span id="cb106-313"><a href="#cb106-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-314"><a href="#cb106-314" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">(</span><span class="co">]</span>{paces}{micsr.data}</span>
<span id="cb106-315"><a href="#cb106-315" aria-hidden="true" tabindex="-1"></a>As an example, we use the data set of </span>
<span id="cb106-316"><a href="#cb106-316" aria-hidden="true" tabindex="-1"></a>@ANGR:BETT:BLOO:KING:KREM:02</span>
<span id="cb106-317"><a href="#cb106-317" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Angrist}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Bettinger}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{King}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Kremer}called <span class="in">`paces`</span>. The authors investigate the effect of a large</span>
<span id="cb106-318"><a href="#cb106-318" aria-hidden="true" tabindex="-1"></a>school voucher program in Columbia called PACES. This voucher</span>
<span id="cb106-319"><a href="#cb106-319" aria-hidden="true" tabindex="-1"></a>covers more than half of the cost of private secondary school and may</span>
<span id="cb106-320"><a href="#cb106-320" aria-hidden="true" tabindex="-1"></a>induce parents to enroll their children in private schools, which are</span>
<span id="cb106-321"><a href="#cb106-321" aria-hidden="true" tabindex="-1"></a>known to provide much better service than public schools. In this case,</span>
<span id="cb106-322"><a href="#cb106-322" aria-hidden="true" tabindex="-1"></a>$w$ is a dummy for children who receive the voucher and $d$ is</span>
<span id="cb106-323"><a href="#cb106-323" aria-hidden="true" tabindex="-1"></a>a dummy for enrollment in private school. </span>
<span id="cb106-324"><a href="#cb106-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-325"><a href="#cb106-325" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-326"><a href="#cb106-326" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: print_paces</span></span>
<span id="cb106-327"><a href="#cb106-327" aria-hidden="true" tabindex="-1"></a>paces <span class="sc">%&gt;%</span> <span class="fu">print</span>(<span class="at">n =</span> <span class="dv">2</span>)</span>
<span id="cb106-328"><a href="#cb106-328" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-329"><a href="#cb106-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-330"><a href="#cb106-330" aria-hidden="true" tabindex="-1"></a>The treatment variable is <span class="in">`privsch`</span> and the instrument is</span>
<span id="cb106-331"><a href="#cb106-331" aria-hidden="true" tabindex="-1"></a><span class="in">`voucher`</span>. Several outcomes are considered by the authors; we'll consider</span>
<span id="cb106-332"><a href="#cb106-332" aria-hidden="true" tabindex="-1"></a>only the number of years of finished education <span class="in">`educyrs`</span>. The OLS</span>
<span id="cb106-333"><a href="#cb106-333" aria-hidden="true" tabindex="-1"></a>estimate of the treatment is just the difference between the mean of</span>
<span id="cb106-334"><a href="#cb106-334" aria-hidden="true" tabindex="-1"></a>the outcome for the two subsamples defined by the treatment variable:</span>
<span id="cb106-335"><a href="#cb106-335" aria-hidden="true" tabindex="-1"></a>\idxfun{unname}{base}\idxfun{coef}{stats}\idxfun{lm}{stats}</span>
<span id="cb106-336"><a href="#cb106-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-339"><a href="#cb106-339" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-340"><a href="#cb106-340" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: est_paces_hidden</span></span>
<span id="cb106-341"><a href="#cb106-341" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: true</span></span>
<span id="cb106-342"><a href="#cb106-342" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb106-343"><a href="#cb106-343" aria-hidden="true" tabindex="-1"></a>ols_paces <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">coef</span>(<span class="fu">lm</span>(educyrs <span class="sc">~</span> privsch, paces))[<span class="dv">2</span>])</span>
<span id="cb106-344"><a href="#cb106-344" aria-hidden="true" tabindex="-1"></a>inttreat_paces <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">coef</span>(<span class="fu">lm</span>(privsch <span class="sc">~</span> voucher, paces))[<span class="dv">2</span>])</span>
<span id="cb106-345"><a href="#cb106-345" aria-hidden="true" tabindex="-1"></a>reduced_paces <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">coef</span>(<span class="fu">lm</span>(educyrs <span class="sc">~</span> voucher, paces))[<span class="dv">2</span>])</span>
<span id="cb106-346"><a href="#cb106-346" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-347"><a href="#cb106-347" aria-hidden="true" tabindex="-1"></a>\idxfun{lm}{stats}\idxfun{gaze}{micsr}</span>
<span id="cb106-348"><a href="#cb106-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-351"><a href="#cb106-351" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-352"><a href="#cb106-352" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: ols_paces</span></span>
<span id="cb106-353"><a href="#cb106-353" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: true</span></span>
<span id="cb106-354"><a href="#cb106-354" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(educyrs <span class="sc">~</span> privsch, paces) <span class="sc">%&gt;%</span> gaze</span>
<span id="cb106-355"><a href="#cb106-355" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-356"><a href="#cb106-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-357"><a href="#cb106-357" aria-hidden="true" tabindex="-1"></a>Therefore, the number of years of education is higher by about 0.29 of a year for pupils enrolled in private schools, and the effect is highly significant.</span>
<span id="cb106-358"><a href="#cb106-358" aria-hidden="true" tabindex="-1"></a>We then compute the effect of the instrument on the treatment (intention to treat)  and on the outcome (reduced form):</span>
<span id="cb106-359"><a href="#cb106-359" aria-hidden="true" tabindex="-1"></a>\idxfun{lm}{stats}\idxfun{gaze}{micsr}</span>
<span id="cb106-360"><a href="#cb106-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-363"><a href="#cb106-363" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-364"><a href="#cb106-364" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: reduced_inttreat</span></span>
<span id="cb106-365"><a href="#cb106-365" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: true</span></span>
<span id="cb106-366"><a href="#cb106-366" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(privsch <span class="sc">~</span> voucher, paces) <span class="sc">%&gt;%</span> <span class="fu">gaze</span>(<span class="at">coef =</span> <span class="dv">2</span>)</span>
<span id="cb106-367"><a href="#cb106-367" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(educyrs <span class="sc">~</span> voucher, paces) <span class="sc">%&gt;%</span> <span class="fu">gaze</span>(<span class="at">coef =</span> <span class="dv">2</span>)</span>
<span id="cb106-368"><a href="#cb106-368" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-369"><a href="#cb106-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-370"><a href="#cb106-370" aria-hidden="true" tabindex="-1"></a>The voucher has a large effect on enrolling in private school, the</span>
<span id="cb106-371"><a href="#cb106-371" aria-hidden="true" tabindex="-1"></a>intention to treat effect being: <span class="in">`r round(inttreat_paces, 3)`</span>.</span>
<span id="cb106-372"><a href="#cb106-372" aria-hidden="true" tabindex="-1"></a>The effect of the instrument on the outcome is <span class="in">`r round(reduced_paces, 3)`</span>.</span>
<span id="cb106-373"><a href="#cb106-373" aria-hidden="true" tabindex="-1"></a>The IV estimator is the ratio of these two effects, which is: </span>
<span id="cb106-374"><a href="#cb106-374" aria-hidden="true" tabindex="-1"></a>$<span class="in">`r round(reduced_paces / inttreat_paces, 3)`</span>$.</span>
<span id="cb106-375"><a href="#cb106-375" aria-hidden="true" tabindex="-1"></a>Therefore, in this example, we get an IV estimator of the treatment</span>
<span id="cb106-376"><a href="#cb106-376" aria-hidden="true" tabindex="-1"></a>effect much smaller than the OLS estimator, which may be the symptom</span>
<span id="cb106-377"><a href="#cb106-377" aria-hidden="true" tabindex="-1"></a>that unobserved determinants of the outcome are positively correlated</span>
<span id="cb106-378"><a href="#cb106-378" aria-hidden="true" tabindex="-1"></a>with the enrollment in private school.</span>
<span id="cb106-379"><a href="#cb106-379" aria-hidden="true" tabindex="-1"></a>Covariates can easily be added to the analysis. In their study,</span>
<span id="cb106-380"><a href="#cb106-380" aria-hidden="true" tabindex="-1"></a>@ANGR:BETT:BLOO:KING:KREM:02\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Angrist}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Bettinger}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{King}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Kremer} use two covariates that indicate the</span>
<span id="cb106-381"><a href="#cb106-381" aria-hidden="true" tabindex="-1"></a>type of survey (<span class="in">`pilot`</span> is one if the individual was surveyed during</span>
<span id="cb106-382"><a href="#cb106-382" aria-hidden="true" tabindex="-1"></a>the "pilot" survey, and <span class="in">`housvisit`</span> is one if the survey was conducted</span>
<span id="cb106-383"><a href="#cb106-383" aria-hidden="true" tabindex="-1"></a>in person and not by phone), <span class="in">`smpl`</span> is a factor indicating the three</span>
<span id="cb106-384"><a href="#cb106-384" aria-hidden="true" tabindex="-1"></a>subsamples (Bogota in 1995, Bogota in 1997 and Djamunid in 1993),</span>
<span id="cb106-385"><a href="#cb106-385" aria-hidden="true" tabindex="-1"></a><span class="in">`phone`</span> is a dummy for owning a phone, <span class="in">`age`</span> and <span class="in">`sex`</span> are the age and the sex of the</span>
<span id="cb106-386"><a href="#cb106-386" aria-hidden="true" tabindex="-1"></a>pupil and <span class="in">`strata`</span> is a strata of residence. We</span>
<span id="cb106-387"><a href="#cb106-387" aria-hidden="true" tabindex="-1"></a>then compute the OLS and IV estimators:</span>
<span id="cb106-388"><a href="#cb106-388" aria-hidden="true" tabindex="-1"></a>\idxfun{lm}{stats}\idxfun{ivreg}{ivreg}\idxfun{gaze}{micsr}</span>
<span id="cb106-389"><a href="#cb106-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-390"><a href="#cb106-390" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-391"><a href="#cb106-391" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: paces_covariates</span></span>
<span id="cb106-392"><a href="#cb106-392" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: true</span></span>
<span id="cb106-393"><a href="#cb106-393" aria-hidden="true" tabindex="-1"></a>ols <span class="ot">&lt;-</span> <span class="fu">lm</span>(educyrs <span class="sc">~</span> privsch <span class="sc">+</span> pilot <span class="sc">+</span> housvisit <span class="sc">+</span> smpl <span class="sc">+</span></span>
<span id="cb106-394"><a href="#cb106-394" aria-hidden="true" tabindex="-1"></a>               phone <span class="sc">+</span> age <span class="sc">+</span> sex <span class="sc">+</span> strata <span class="sc">+</span> month, <span class="at">data =</span> paces)</span>
<span id="cb106-395"><a href="#cb106-395" aria-hidden="true" tabindex="-1"></a>iv <span class="ot">&lt;-</span> ivreg<span class="sc">::</span><span class="fu">ivreg</span>(educyrs <span class="sc">~</span> privsch <span class="sc">+</span> pilot <span class="sc">+</span> housvisit <span class="sc">+</span> smpl <span class="sc">+</span></span>
<span id="cb106-396"><a href="#cb106-396" aria-hidden="true" tabindex="-1"></a>                      phone <span class="sc">+</span> age <span class="sc">+</span> sex <span class="sc">+</span> strata <span class="sc">+</span> month <span class="sc">|</span> . <span class="sc">-</span> privsch <span class="sc">+</span></span>
<span id="cb106-397"><a href="#cb106-397" aria-hidden="true" tabindex="-1"></a>                      voucher, <span class="at">data =</span> paces)</span>
<span id="cb106-398"><a href="#cb106-398" aria-hidden="true" tabindex="-1"></a>ols <span class="sc">%&gt;%</span> <span class="fu">gaze</span>(<span class="at">coef =</span> <span class="dv">2</span>)</span>
<span id="cb106-399"><a href="#cb106-399" aria-hidden="true" tabindex="-1"></a>iv <span class="sc">%&gt;%</span> <span class="fu">gaze</span>(<span class="at">coef =</span> <span class="dv">2</span>)</span>
<span id="cb106-400"><a href="#cb106-400" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-401"><a href="#cb106-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-402"><a href="#cb106-402" aria-hidden="true" tabindex="-1"></a>The two estimators are now almost identical: introducing the</span>
<span id="cb106-403"><a href="#cb106-403" aria-hidden="true" tabindex="-1"></a>covariates reduces by almost one half the value of the OLS estimator and has</span>
<span id="cb106-404"><a href="#cb106-404" aria-hidden="true" tabindex="-1"></a>a small effect on the IV estimator without covariates.</span>
<span id="cb106-405"><a href="#cb106-405" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">(</span><span class="co">]</span>{paces}{micsr.data}</span>
<span id="cb106-406"><a href="#cb106-406" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{instrumental variable estimator!treatment effect|)}</span>
<span id="cb106-407"><a href="#cb106-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-408"><a href="#cb106-408" aria-hidden="true" tabindex="-1"></a><span class="fu">## Regression discontinuity {#sec-reg_discont}</span></span>
<span id="cb106-409"><a href="#cb106-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-410"><a href="#cb106-410" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{regression discontinuity|(}</span>
<span id="cb106-411"><a href="#cb106-411" aria-hidden="true" tabindex="-1"></a>Eligibility to a program is sometimes based on the value of an</span>
<span id="cb106-412"><a href="#cb106-412" aria-hidden="true" tabindex="-1"></a>observable variable (called the **forcing variable**)\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{forcing variable}, </span>
<span id="cb106-413"><a href="#cb106-413" aria-hidden="true" tabindex="-1"></a>and more precisely, on the fact that the value of</span>
<span id="cb106-414"><a href="#cb106-414" aria-hidden="true" tabindex="-1"></a>this variable, for an individual is below or over a given</span>
<span id="cb106-415"><a href="#cb106-415" aria-hidden="true" tabindex="-1"></a>threshold. Individuals just below and just over the threshold</span>
<span id="cb106-416"><a href="#cb106-416" aria-hidden="true" tabindex="-1"></a>therefore constitute two groups of individuals who are very similar,</span>
<span id="cb106-417"><a href="#cb106-417" aria-hidden="true" tabindex="-1"></a>except that the first group receives the treatment and the second group doesn't. This is called a **regression discontinuity** (**RD**) design.</span>
<span id="cb106-418"><a href="#cb106-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-419"><a href="#cb106-419" aria-hidden="true" tabindex="-1"></a><span class="fu">### Sharp and Fuzzy </span></span>
<span id="cb106-420"><a href="#cb106-420" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{regression discontinuity!fuzzy}</span>
<span id="cb106-421"><a href="#cb106-421" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{regression discontinuity!sharp}</span>
<span id="cb106-422"><a href="#cb106-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-423"><a href="#cb106-423" aria-hidden="true" tabindex="-1"></a>Two variants of regression discontinuity designs can be considered:</span>
<span id="cb106-424"><a href="#cb106-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-425"><a href="#cb106-425" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**sharp discontinuity**, there is a one-to-one correspondence between eligibility and treatment,</span>
<span id="cb106-426"><a href="#cb106-426" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**fuzzy discontinuity**, the probability of being treated</span>
<span id="cb106-427"><a href="#cb106-427" aria-hidden="true" tabindex="-1"></a>  is very different just below and just over the</span>
<span id="cb106-428"><a href="#cb106-428" aria-hidden="true" tabindex="-1"></a>  threshold.</span>
<span id="cb106-429"><a href="#cb106-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-430"><a href="#cb106-430" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">(</span><span class="co">]</span>{probation}{micsr.data}\idxdata<span class="co">[</span><span class="ot">(</span><span class="co">]</span>{bdh}{micsr.data}</span>
<span id="cb106-431"><a href="#cb106-431" aria-hidden="true" tabindex="-1"></a>We'll consider, in this chapter, two data sets. </span>
<span id="cb106-432"><a href="#cb106-432" aria-hidden="true" tabindex="-1"></a>The first, called <span class="in">`probation`</span>, is from @LIND:SAND:OREO:10\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Lindo}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Sanders}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Oreopoulos} who studied the effects of academic probation on academic performance in Canadian universities. If a student's grade point average</span>
<span id="cb106-433"><a href="#cb106-433" aria-hidden="true" tabindex="-1"></a>(GPA) is below a certain threshold, he is placed on academic</span>
<span id="cb106-434"><a href="#cb106-434" aria-hidden="true" tabindex="-1"></a>probation. GPA is between 0 and 4.5, and there are three campuses in the</span>
<span id="cb106-435"><a href="#cb106-435" aria-hidden="true" tabindex="-1"></a>sample, denoted by <span class="in">`"1"`</span>, <span class="in">`"2"`</span> and <span class="in">`"3"`</span>; for the first two, the</span>
<span id="cb106-436"><a href="#cb106-436" aria-hidden="true" tabindex="-1"></a>threshold is 1.5 and for the third one it is 1.6. We first compute the distance to the threshold</span>
<span id="cb106-437"><a href="#cb106-437" aria-hidden="true" tabindex="-1"></a>using the <span class="in">`gpa`</span> and the <span class="in">`campus`</span> variables:</span>
<span id="cb106-438"><a href="#cb106-438" aria-hidden="true" tabindex="-1"></a>\idxfun{mutate}{dplyr}\idxfun{ifelse}{base}</span>
<span id="cb106-439"><a href="#cb106-439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-440"><a href="#cb106-440" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-441"><a href="#cb106-441" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: probation_forcing</span></span>
<span id="cb106-442"><a href="#cb106-442" aria-hidden="true" tabindex="-1"></a>probation <span class="ot">&lt;-</span> probation <span class="sc">%&gt;%</span></span>
<span id="cb106-443"><a href="#cb106-443" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">distcut =</span> gpa <span class="sc">-</span> <span class="fu">ifelse</span>(campus <span class="sc">==</span> <span class="st">"3"</span>, <span class="fl">1.6</span>, <span class="fl">1.5</span>))</span>
<span id="cb106-444"><a href="#cb106-444" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-445"><a href="#cb106-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-446"><a href="#cb106-446" aria-hidden="true" tabindex="-1"></a>We then compute the joint frequency table for the two variables of eligibility and probation.</span>
<span id="cb106-447"><a href="#cb106-447" aria-hidden="true" tabindex="-1"></a>\idxfun{mutate}{dplyr}\idxfun{as.numeric}{base}\idxfun{count}{dplyr}\idxfun{group<span class="sc">\_</span>by}{dplyr}\idxfun{mutate}{dplyr}\idxfun{pivot<span class="sc">\_</span>wider}{tidyr}</span>
<span id="cb106-448"><a href="#cb106-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-449"><a href="#cb106-449" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-450"><a href="#cb106-450" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: probation_elig_treatment</span></span>
<span id="cb106-451"><a href="#cb106-451" aria-hidden="true" tabindex="-1"></a>probation <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">eligible =</span> <span class="fu">as.numeric</span>(distcut <span class="sc">&lt;</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb106-452"><a href="#cb106-452" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(eligible, probation) <span class="sc">%&gt;%</span></span>
<span id="cb106-453"><a href="#cb106-453" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(eligible) <span class="sc">%&gt;%</span></span>
<span id="cb106-454"><a href="#cb106-454" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">n =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n)) <span class="sc">%&gt;%</span> </span>
<span id="cb106-455"><a href="#cb106-455" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> eligible, <span class="at">values_from =</span> n)</span>
<span id="cb106-456"><a href="#cb106-456" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-457"><a href="#cb106-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-458"><a href="#cb106-458" aria-hidden="true" tabindex="-1"></a>Although the discontinuity is sharp, the probability of being on</span>
<span id="cb106-459"><a href="#cb106-459" aria-hidden="true" tabindex="-1"></a>probation is not exactly equal to 1 for eligible students and equal</span>
<span id="cb106-460"><a href="#cb106-460" aria-hidden="true" tabindex="-1"></a>to 0 for ineligible students because of administrative errors in data</span>
<span id="cb106-461"><a href="#cb106-461" aria-hidden="true" tabindex="-1"></a>reporting.^<span class="co">[</span><span class="ot">see @LIND:SAND:OREO:10\index[author]{Lindo}\index[author]{Sanders}\index[author]{Oreopoulos}, footnote 20, page 104.</span><span class="co">]</span> We remove these misleading observations:</span>
<span id="cb106-462"><a href="#cb106-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-463"><a href="#cb106-463" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-464"><a href="#cb106-464" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: probation_rm_errors</span></span>
<span id="cb106-465"><a href="#cb106-465" aria-hidden="true" tabindex="-1"></a>probation <span class="ot">&lt;-</span> probation <span class="sc">%&gt;%</span></span>
<span id="cb106-466"><a href="#cb106-466" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>( (probation <span class="sc">==</span> <span class="st">"yes"</span> <span class="sc">&amp;</span> distcut <span class="sc">&lt;</span> <span class="dv">0</span>) <span class="sc">|</span></span>
<span id="cb106-467"><a href="#cb106-467" aria-hidden="true" tabindex="-1"></a>            (probation <span class="sc">==</span> <span class="st">"no"</span> <span class="sc">&amp;</span> distcut <span class="sc">&gt;=</span> <span class="dv">0</span>))</span>
<span id="cb106-468"><a href="#cb106-468" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-469"><a href="#cb106-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-470"><a href="#cb106-470" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">)</span><span class="co">]</span>{probation}{micsr.data}</span>
<span id="cb106-471"><a href="#cb106-471" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- The --&gt;</span></span>
<span id="cb106-472"><a href="#cb106-472" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- program started in 2003 and, in 2009, the index changed, so that some --&gt;</span></span>
<span id="cb106-473"><a href="#cb106-473" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- former eligible households lost the grant and some previously ineligible households received it.  --&gt;</span></span>
<span id="cb106-474"><a href="#cb106-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-475"><a href="#cb106-475" aria-hidden="true" tabindex="-1"></a>@BUSE:15\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Buser} analyzed the effect of income on religiousness. He considered </span>
<span id="cb106-476"><a href="#cb106-476" aria-hidden="true" tabindex="-1"></a>the BDH (Bono Desarollo Humano) program in Ecuador which consists of a </span>
<span id="cb106-477"><a href="#cb106-477" aria-hidden="true" tabindex="-1"></a>cash transfer for the poorest families. The eligibility is based on a</span>
<span id="cb106-478"><a href="#cb106-478" aria-hidden="true" tabindex="-1"></a>wealth index called Selben, households in the four first deciles being eligible. The data</span>
<span id="cb106-479"><a href="#cb106-479" aria-hidden="true" tabindex="-1"></a>were collected in 2011 and are available as <span class="in">`bdh`</span>. The</span>
<span id="cb106-480"><a href="#cb106-480" aria-hidden="true" tabindex="-1"></a>key variables are the <span class="in">`selben`</span> index (the threshold has been removed so</span>
<span id="cb106-481"><a href="#cb106-481" aria-hidden="true" tabindex="-1"></a>that eligible households are those for which <span class="in">`selben`</span> is negative),</span>
<span id="cb106-482"><a href="#cb106-482" aria-hidden="true" tabindex="-1"></a><span class="in">`treated`</span>, which is a dummy for households which receive the grant and <span class="in">`attendmonth`</span>, which is the monthly frequency of visits to the church.</span>
<span id="cb106-483"><a href="#cb106-483" aria-hidden="true" tabindex="-1"></a>First, we investigate whether the discontinuity is sharp or fuzzy, by</span>
<span id="cb106-484"><a href="#cb106-484" aria-hidden="true" tabindex="-1"></a>computing the percentage of recipients for households under and over</span>
<span id="cb106-485"><a href="#cb106-485" aria-hidden="true" tabindex="-1"></a>the threshold:</span>
<span id="cb106-486"><a href="#cb106-486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-487"><a href="#cb106-487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-488"><a href="#cb106-488" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-489"><a href="#cb106-489" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: bdh_is_fuzzy</span></span>
<span id="cb106-490"><a href="#cb106-490" aria-hidden="true" tabindex="-1"></a>bdh <span class="ot">&lt;-</span> bdh <span class="sc">%&gt;%</span></span>
<span id="cb106-491"><a href="#cb106-491" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">eligible =</span> <span class="fu">ifelse</span>(selben <span class="sc">&lt;</span> <span class="dv">0</span>, <span class="st">"yes"</span>, <span class="st">"no"</span>))</span>
<span id="cb106-492"><a href="#cb106-492" aria-hidden="true" tabindex="-1"></a>bdh <span class="sc">%&gt;%</span> <span class="fu">count</span>(eligible, treated) <span class="sc">%&gt;%</span></span>
<span id="cb106-493"><a href="#cb106-493" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(eligible) <span class="sc">%&gt;%</span> </span>
<span id="cb106-494"><a href="#cb106-494" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">n =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n)) <span class="sc">%&gt;%</span> </span>
<span id="cb106-495"><a href="#cb106-495" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> eligible, <span class="at">values_from =</span> n)</span>
<span id="cb106-496"><a href="#cb106-496" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-497"><a href="#cb106-497" aria-hidden="true" tabindex="-1"></a>The discontinuity is therefore fuzzy, as about 3% of the</span>
<span id="cb106-498"><a href="#cb106-498" aria-hidden="true" tabindex="-1"></a>eligible households don't receive the grant and, on the contrary,</span>
<span id="cb106-499"><a href="#cb106-499" aria-hidden="true" tabindex="-1"></a>about 14% of the recipients are not eligible.</span>
<span id="cb106-500"><a href="#cb106-500" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">)</span><span class="co">]</span>{bdh}{micsr.data}</span>
<span id="cb106-501"><a href="#cb106-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-502"><a href="#cb106-502" aria-hidden="true" tabindex="-1"></a><span class="fu">### Plotting the discontinuity</span></span>
<span id="cb106-503"><a href="#cb106-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-504"><a href="#cb106-504" aria-hidden="true" tabindex="-1"></a>The plot is obtained by defining bins for the forcing</span>
<span id="cb106-505"><a href="#cb106-505" aria-hidden="true" tabindex="-1"></a>variable, computing the mean of the outcome for each bin, plotting the points and adding a smoothing</span>
<span id="cb106-506"><a href="#cb106-506" aria-hidden="true" tabindex="-1"></a>line. </span>
<span id="cb106-507"><a href="#cb106-507" aria-hidden="true" tabindex="-1"></a>The **micsr** package provides</span>
<span id="cb106-508"><a href="#cb106-508" aria-hidden="true" tabindex="-1"></a>the convenient <span class="in">`geom_binmeans`</span> function to compute and plot the mean</span>
<span id="cb106-509"><a href="#cb106-509" aria-hidden="true" tabindex="-1"></a>of the response for bins of $x$ (see @fig-binmeans).</span>
<span id="cb106-510"><a href="#cb106-510" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">(</span><span class="co">]</span>{probation}{micsr.data}</span>
<span id="cb106-511"><a href="#cb106-511" aria-hidden="true" tabindex="-1"></a>\idxfun{filter}{dplyr}\idxfun{ggplot}{ggplot2}\idxfun{aes}{ggplot2}\idxfun{geom<span class="sc">\_</span>binmeans}{micsr}\idxfun{geom<span class="sc">\_</span>smooth}{ggplot2}\idxfun{after<span class="sc">\_</span>stat}{ggplot2}</span>
<span id="cb106-512"><a href="#cb106-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-513"><a href="#cb106-513" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-514"><a href="#cb106-514" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-binmeans</span></span>
<span id="cb106-515"><a href="#cb106-515" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Discontinuity for probation</span></span>
<span id="cb106-516"><a href="#cb106-516" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb106-517"><a href="#cb106-517" aria-hidden="true" tabindex="-1"></a>probation <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="fu">abs</span>(distcut) <span class="sc">&lt;</span> <span class="fl">1.5</span>) <span class="sc">%&gt;%</span></span>
<span id="cb106-518"><a href="#cb106-518" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(distcut, gpa2)) <span class="sc">+</span></span>
<span id="cb106-519"><a href="#cb106-519" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_binmeans</span>(<span class="fu">aes</span>(<span class="at">size =</span> <span class="fu">after_stat</span>(n)), <span class="at">shape =</span> <span class="dv">21</span>,</span>
<span id="cb106-520"><a href="#cb106-520" aria-hidden="true" tabindex="-1"></a>                  <span class="at">center =</span> <span class="dv">0</span>, <span class="at">width =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb106-521"><a href="#cb106-521" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="fu">aes</span>(<span class="at">linetype =</span> probation),</span>
<span id="cb106-522"><a href="#cb106-522" aria-hidden="true" tabindex="-1"></a>                <span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">"black"</span>)</span>
<span id="cb106-523"><a href="#cb106-523" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-524"><a href="#cb106-524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-525"><a href="#cb106-525" aria-hidden="true" tabindex="-1"></a>Two arguments of <span class="in">`geom_binmeans`</span> are used: <span class="in">`center`</span> to</span>
<span id="cb106-526"><a href="#cb106-526" aria-hidden="true" tabindex="-1"></a>indicate the cutoff and <span class="in">`width`</span> the width of the bins. The internal variable <span class="in">`n`</span> is used</span>
<span id="cb106-527"><a href="#cb106-527" aria-hidden="true" tabindex="-1"></a>to visualize the number of observations in every bin. Note the use of <span class="in">`after_stat`</span>: <span class="in">`geom_binmeans`</span> uses as stat <span class="in">`bins`</span>, ie, it creates bins and counts the number of observations in each bin. This count (called <span class="in">`n`</span>) is used in <span class="in">`geom_smooth`</span> after the stat has been computed. </span>
<span id="cb106-528"><a href="#cb106-528" aria-hidden="true" tabindex="-1"></a>For <span class="in">`geom_smooth`</span> we use <span class="in">`probation`</span> for the <span class="in">`linetype`</span> aesthetic, so that</span>
<span id="cb106-529"><a href="#cb106-529" aria-hidden="true" tabindex="-1"></a>two different smoothing lines are plotted on both sides of the</span>
<span id="cb106-530"><a href="#cb106-530" aria-hidden="true" tabindex="-1"></a>cutoff. </span>
<span id="cb106-531"><a href="#cb106-531" aria-hidden="true" tabindex="-1"></a>The effect of the treatment is then the difference of intercepts for</span>
<span id="cb106-532"><a href="#cb106-532" aria-hidden="true" tabindex="-1"></a>the two regression lines. It is about 0.25 points of gpa in our example.</span>
<span id="cb106-533"><a href="#cb106-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-534"><a href="#cb106-534" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- In the context of a fuzzy discontinuity, the same plot can be used --&gt;</span></span>
<span id="cb106-535"><a href="#cb106-535" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- with the treatment variable, to see the strength of the forcing variable --&gt;</span></span>
<span id="cb106-536"><a href="#cb106-536" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- on the treatment (see @fig-fuzzy). --&gt;</span></span>
<span id="cb106-537"><a href="#cb106-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-538"><a href="#cb106-538" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- A placebo test consists on applying the same visual techniques to --&gt;</span></span>
<span id="cb106-539"><a href="#cb106-539" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- variables that shouldn't be impacted by the discontinuity. For the --&gt;</span></span>
<span id="cb106-540"><a href="#cb106-540" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- probation data set, we use high school grade percentile, age, gender --&gt;</span></span>
<span id="cb106-541"><a href="#cb106-541" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- and first language; the last two variables being factors, we first --&gt;</span></span>
<span id="cb106-542"><a href="#cb106-542" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- coerce them to binary variables (see @fig-placebo). --&gt;</span></span>
<span id="cb106-543"><a href="#cb106-543" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-544"><a href="#cb106-544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-545"><a href="#cb106-545" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ```{r } --&gt;</span></span>
<span id="cb106-546"><a href="#cb106-546" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #| warning: false --&gt;</span></span>
<span id="cb106-547"><a href="#cb106-547" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #| label: fig-placebo --&gt;</span></span>
<span id="cb106-548"><a href="#cb106-548" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #| fig-cap: Placebo tests for the probation data set --&gt;</span></span>
<span id="cb106-549"><a href="#cb106-549" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- probation %&gt;% --&gt;</span></span>
<span id="cb106-550"><a href="#cb106-550" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     filter(abs(distcut) &lt; 1.5) %&gt;%  --&gt;</span></span>
<span id="cb106-551"><a href="#cb106-551" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     select(hsgrade, gender, flang, age, distcut, probation) %&gt;% --&gt;</span></span>
<span id="cb106-552"><a href="#cb106-552" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     mutate(gender = ifelse(gender == "female", 1, 0), --&gt;</span></span>
<span id="cb106-553"><a href="#cb106-553" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--            flang = ifelse(flang == "english", 1, 0)) %&gt;% --&gt;</span></span>
<span id="cb106-554"><a href="#cb106-554" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     pivot_longer(- c(distcut,  probation)) %&gt;%  --&gt;</span></span>
<span id="cb106-555"><a href="#cb106-555" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     ggplot(aes(distcut, value)) + --&gt;</span></span>
<span id="cb106-556"><a href="#cb106-556" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     geom_binmeans(aes(size = after_stat(n)), shape = 21, --&gt;</span></span>
<span id="cb106-557"><a href="#cb106-557" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--                   center = 0, width = 0.2) + --&gt;</span></span>
<span id="cb106-558"><a href="#cb106-558" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     geom_smooth(aes(linetype = factor(probation)), --&gt;</span></span>
<span id="cb106-559"><a href="#cb106-559" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--                 method = "lm", se = FALSE, fullrange = FALSE) + --&gt;</span></span>
<span id="cb106-560"><a href="#cb106-560" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     facet_wrap(~ name, scales = "free") + --&gt;</span></span>
<span id="cb106-561"><a href="#cb106-561" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     scale_size_continuous(range = c(1, 3)) --&gt;</span></span>
<span id="cb106-562"><a href="#cb106-562" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ``` --&gt;</span></span>
<span id="cb106-563"><a href="#cb106-563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-564"><a href="#cb106-564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-565"><a href="#cb106-565" aria-hidden="true" tabindex="-1"></a>The <span class="in">`rdrobust::rdplot`</span> function performs the same task (see @fig-rdplot). There are numerous options available to customize the graphic, described in details in @CALI:CATT:TITI:15.</span>
<span id="cb106-566"><a href="#cb106-566" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Calonico}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Cattaneo}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Titiunik}</span>
<span id="cb106-567"><a href="#cb106-567" aria-hidden="true" tabindex="-1"></a>\idxfun{rdplot}{rdrobust}\idxfun{with}{base}</span>
<span id="cb106-568"><a href="#cb106-568" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-571"><a href="#cb106-571" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-572"><a href="#cb106-572" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb106-573"><a href="#cb106-573" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rdrobust)</span>
<span id="cb106-574"><a href="#cb106-574" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(probation, <span class="fu">rdplot</span>(<span class="at">y =</span> gpa2, <span class="at">x =</span> distcut, <span class="at">nbins =</span> <span class="dv">10</span>))</span>
<span id="cb106-575"><a href="#cb106-575" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-576"><a href="#cb106-576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-577"><a href="#cb106-577" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-578"><a href="#cb106-578" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-rdplot</span></span>
<span id="cb106-579"><a href="#cb106-579" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb106-580"><a href="#cb106-580" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb106-581"><a href="#cb106-581" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb106-582"><a href="#cb106-582" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: Discontinuity for probation using `rdplot`</span></span>
<span id="cb106-583"><a href="#cb106-583" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rdrobust)</span>
<span id="cb106-584"><a href="#cb106-584" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(probation, <span class="fu">rdplot</span>(<span class="at">y =</span> gpa2, <span class="at">x =</span> distcut, <span class="at">nbins =</span> <span class="dv">10</span>, <span class="at">masspoints =</span> <span class="st">"off"</span>,</span>
<span id="cb106-585"><a href="#cb106-585" aria-hidden="true" tabindex="-1"></a>                       <span class="at">col.dots =</span> <span class="st">"black"</span>, <span class="at">col.lines =</span> <span class="st">"black"</span>))</span>
<span id="cb106-586"><a href="#cb106-586" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-587"><a href="#cb106-587" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-588"><a href="#cb106-588" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{placebo tests}</span>
<span id="cb106-589"><a href="#cb106-589" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{regression discontinuity!placebo tests}</span>
<span id="cb106-590"><a href="#cb106-590" aria-hidden="true" tabindex="-1"></a>Placebo tests consist of applying the same visual techniques to variables that shouldn't be impacted by the discontinuity. In @fig-disc_hsg, we plot the high school grade percentile and we can see that there is no clear discontinuity for this variable around the threshold.</span>
<span id="cb106-591"><a href="#cb106-591" aria-hidden="true" tabindex="-1"></a>\idxfun{rdplot}{rdrobust}\idxfun{with}{base}</span>
<span id="cb106-592"><a href="#cb106-592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-595"><a href="#cb106-595" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-596"><a href="#cb106-596" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb106-597"><a href="#cb106-597" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(probation, <span class="fu">rdplot</span>(<span class="at">y =</span> hsgrade, <span class="at">x =</span> distcut, <span class="at">nbins =</span> <span class="dv">10</span>))</span>
<span id="cb106-598"><a href="#cb106-598" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-599"><a href="#cb106-599" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-602"><a href="#cb106-602" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-603"><a href="#cb106-603" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-disc_hsg</span></span>
<span id="cb106-604"><a href="#cb106-604" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb106-605"><a href="#cb106-605" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb106-606"><a href="#cb106-606" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb106-607"><a href="#cb106-607" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Placebo test for probation"</span></span>
<span id="cb106-608"><a href="#cb106-608" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(probation, <span class="fu">rdplot</span>(<span class="at">y =</span> hsgrade, <span class="at">x =</span> distcut, <span class="at">nbins =</span> <span class="dv">10</span>, <span class="at">masspoints =</span> <span class="st">"off"</span>,</span>
<span id="cb106-609"><a href="#cb106-609" aria-hidden="true" tabindex="-1"></a>                       <span class="at">col.dots =</span> <span class="st">"black"</span>, <span class="at">col.lines =</span> <span class="st">"black"</span>))</span>
<span id="cb106-610"><a href="#cb106-610" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-611"><a href="#cb106-611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-612"><a href="#cb106-612" aria-hidden="true" tabindex="-1"></a>**rdrobust**'s functions don't have a data argument. Therefore, series should be provided, and we could have written the previous expression as:</span>
<span id="cb106-613"><a href="#cb106-613" aria-hidden="true" tabindex="-1"></a>\idxfun{rdplot}{rdrobust}</span>
<span id="cb106-614"><a href="#cb106-614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-617"><a href="#cb106-617" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-618"><a href="#cb106-618" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb106-619"><a href="#cb106-619" aria-hidden="true" tabindex="-1"></a><span class="fu">rdplot</span>(<span class="at">y =</span> probation<span class="sc">$</span>hsgrade, <span class="at">x =</span> probation<span class="sc">$</span>distcut, <span class="at">nbins =</span> <span class="dv">10</span>)</span>
<span id="cb106-620"><a href="#cb106-620" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-621"><a href="#cb106-621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-622"><a href="#cb106-622" aria-hidden="true" tabindex="-1"></a>Using <span class="in">`with(data, expression)`</span>, series of <span class="in">`data`</span> can be called directly in <span class="in">`expression`</span> without prefixing them by <span class="in">`probation$`</span>.</span>
<span id="cb106-623"><a href="#cb106-623" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-624"><a href="#cb106-624" aria-hidden="true" tabindex="-1"></a><span class="fu">### Computing the effect of the treatment</span></span>
<span id="cb106-625"><a href="#cb106-625" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-626"><a href="#cb106-626" aria-hidden="true" tabindex="-1"></a>As seen previously, the effect of the eligibility (and the effect of</span>
<span id="cb106-627"><a href="#cb106-627" aria-hidden="true" tabindex="-1"></a>the treatment if the discontinuity is sharp) is the difference between</span>
<span id="cb106-628"><a href="#cb106-628" aria-hidden="true" tabindex="-1"></a>the intercepts of two smoothing lines, which can be obtained using OLS</span>
<span id="cb106-629"><a href="#cb106-629" aria-hidden="true" tabindex="-1"></a>or some more complicated fitting tools like local polynomials. In the simplest</span>
<span id="cb106-630"><a href="#cb106-630" aria-hidden="true" tabindex="-1"></a>case, it is given by the estimation of $\beta_t$ in the following</span>
<span id="cb106-631"><a href="#cb106-631" aria-hidden="true" tabindex="-1"></a>regression, $t_n$ being the treatment variable and $x_n$ the forcing variable:</span>
<span id="cb106-632"><a href="#cb106-632" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-633"><a href="#cb106-633" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-634"><a href="#cb106-634" aria-hidden="true" tabindex="-1"></a>y_n = \beta_0 + \beta_t t_n + \beta_x x_n + \beta_{xt} x_n t_n + \epsilon_n</span>
<span id="cb106-635"><a href="#cb106-635" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-636"><a href="#cb106-636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-637"><a href="#cb106-637" aria-hidden="true" tabindex="-1"></a>Note that the presence of $\beta_{xt}$ allows to have different</span>
<span id="cb106-638"><a href="#cb106-638" aria-hidden="true" tabindex="-1"></a>slopes on both sides of the cutoff. Two crucial choices have to be</span>
<span id="cb106-639"><a href="#cb106-639" aria-hidden="true" tabindex="-1"></a>made while estimating the effect of the treatment: the **bandwidth**, \index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{bandwidth|(}</span>
<span id="cb106-640"><a href="#cb106-640" aria-hidden="true" tabindex="-1"></a>i.e., the range of values of the forcing variable used in the estimation and the  degree of smoothness of the fitting line.</span>
<span id="cb106-641"><a href="#cb106-641" aria-hidden="true" tabindex="-1"></a>A larger bandwidth leads to a more efficient estimator (as the number of</span>
<span id="cb106-642"><a href="#cb106-642" aria-hidden="true" tabindex="-1"></a>observations is higher), but the estimation may be biased as the sample</span>
<span id="cb106-643"><a href="#cb106-643" aria-hidden="true" tabindex="-1"></a>contains observations not close enough to the cutoff. </span>
<span id="cb106-644"><a href="#cb106-644" aria-hidden="true" tabindex="-1"></a>We first regress the outcome on the forcing variable interacted with</span>
<span id="cb106-645"><a href="#cb106-645" aria-hidden="true" tabindex="-1"></a>the treatment variable (note the use of the <span class="in">`*`</span> operator in the</span>
<span id="cb106-646"><a href="#cb106-646" aria-hidden="true" tabindex="-1"></a>formula), with a bandwidth of $1.5$:</span>
<span id="cb106-647"><a href="#cb106-647" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">(</span><span class="co">]</span>{probation}{micsr.data}</span>
<span id="cb106-648"><a href="#cb106-648" aria-hidden="true" tabindex="-1"></a>\idxfun{lm}{stats}\idxfun{gaze}{micsr}</span>
<span id="cb106-649"><a href="#cb106-649" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-650"><a href="#cb106-650" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-651"><a href="#cb106-651" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: probation_te</span></span>
<span id="cb106-652"><a href="#cb106-652" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(gpa2 <span class="sc">~</span> distcut <span class="sc">*</span> probation, probation,</span>
<span id="cb106-653"><a href="#cb106-653" aria-hidden="true" tabindex="-1"></a>   <span class="at">subset =</span> <span class="fu">abs</span>(distcut) <span class="sc">&lt;</span> <span class="fl">1.5</span>) <span class="sc">%&gt;%</span> gaze</span>
<span id="cb106-654"><a href="#cb106-654" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-655"><a href="#cb106-655" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-656"><a href="#cb106-656" aria-hidden="true" tabindex="-1"></a>The coefficient of <span class="in">`probationyes`</span> is highly significant; students just</span>
<span id="cb106-657"><a href="#cb106-657" aria-hidden="true" tabindex="-1"></a>under the cutoff and who therefore benefit from probation have a</span>
<span id="cb106-658"><a href="#cb106-658" aria-hidden="true" tabindex="-1"></a>subsequent GPA higher by one-quarter of a point. The interaction term is</span>
<span id="cb106-659"><a href="#cb106-659" aria-hidden="true" tabindex="-1"></a>also positive, indicating that the slope of the regression line is</span>
<span id="cb106-660"><a href="#cb106-660" aria-hidden="true" tabindex="-1"></a>higher on the right of the cutoff than on the left.</span>
<span id="cb106-661"><a href="#cb106-661" aria-hidden="true" tabindex="-1"></a>To check the robustness of this result, we change the bandwidth and add</span>
<span id="cb106-662"><a href="#cb106-662" aria-hidden="true" tabindex="-1"></a>a quadratic term in the forcing variable.</span>
<span id="cb106-663"><a href="#cb106-663" aria-hidden="true" tabindex="-1"></a>\idxfun{lm}{stats}\idxfun{gaze}{micsr}\idxfun{I}{base}</span>
<span id="cb106-664"><a href="#cb106-664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-665"><a href="#cb106-665" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-666"><a href="#cb106-666" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: probation_te_variants</span></span>
<span id="cb106-667"><a href="#cb106-667" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: true</span></span>
<span id="cb106-668"><a href="#cb106-668" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(gpa2 <span class="sc">~</span> distcut <span class="sc">*</span> probation, probation,</span>
<span id="cb106-669"><a href="#cb106-669" aria-hidden="true" tabindex="-1"></a>   <span class="at">subset =</span> <span class="fu">abs</span>(distcut) <span class="sc">&lt;</span> <span class="fl">0.5</span>) <span class="sc">%&gt;%</span>  <span class="fu">gaze</span>(<span class="at">coef =</span> <span class="st">"probationyes"</span>)</span>
<span id="cb106-670"><a href="#cb106-670" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(gpa2 <span class="sc">~</span> (distcut <span class="sc">+</span> <span class="fu">I</span>(distcut <span class="sc">^</span> <span class="dv">2</span>)) <span class="sc">*</span> probation, probation,</span>
<span id="cb106-671"><a href="#cb106-671" aria-hidden="true" tabindex="-1"></a>   <span class="at">subset =</span> <span class="fu">abs</span>(distcut) <span class="sc">&lt;</span> <span class="fl">1.5</span>) <span class="sc">%&gt;%</span>  <span class="fu">gaze</span>(<span class="at">coef =</span> <span class="st">"probationyes"</span>)</span>
<span id="cb106-672"><a href="#cb106-672" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(gpa2 <span class="sc">~</span> (distcut <span class="sc">+</span> <span class="fu">I</span>(distcut <span class="sc">^</span> <span class="dv">2</span>)) <span class="sc">*</span> probation, probation,</span>
<span id="cb106-673"><a href="#cb106-673" aria-hidden="true" tabindex="-1"></a>   <span class="at">subset =</span> <span class="fu">abs</span>(distcut) <span class="sc">&lt;</span> <span class="fl">0.5</span>) <span class="sc">%&gt;%</span>  <span class="fu">gaze</span>(<span class="at">coef =</span> <span class="st">"probationyes"</span>)</span>
<span id="cb106-674"><a href="#cb106-674" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-675"><a href="#cb106-675" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-676"><a href="#cb106-676" aria-hidden="true" tabindex="-1"></a>Depending on the specification, the coefficient varies from 0.19 to 0.26.</span>
<span id="cb106-677"><a href="#cb106-677" aria-hidden="true" tabindex="-1"></a>The **rdrobust** package provides the <span class="in">`rdrobust`</span> function which</span>
<span id="cb106-678"><a href="#cb106-678" aria-hidden="true" tabindex="-1"></a>computes the treatment effect using local polynomials. The degree of the polynomial is controlled</span>
<span id="cb106-679"><a href="#cb106-679" aria-hidden="true" tabindex="-1"></a>with the <span class="in">`p`</span> argument (the default is 1) and the bandwidth with the</span>
<span id="cb106-680"><a href="#cb106-680" aria-hidden="true" tabindex="-1"></a><span class="in">`h`</span> argument. If the bandwidth is not indicated, it is automatically</span>
<span id="cb106-681"><a href="#cb106-681" aria-hidden="true" tabindex="-1"></a>computed internally using the <span class="in">`rdbwselect`</span> function.</span>
<span id="cb106-682"><a href="#cb106-682" aria-hidden="true" tabindex="-1"></a>\idxfun{rdrobust}{rdrobust}\idxfun{gaze}{micsr}</span>
<span id="cb106-683"><a href="#cb106-683" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-684"><a href="#cb106-684" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-685"><a href="#cb106-685" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: probation_rdrobust_te</span></span>
<span id="cb106-686"><a href="#cb106-686" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb106-687"><a href="#cb106-687" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(probation, <span class="fu">rdrobust</span>(gpa2, distcut)) <span class="sc">%&gt;%</span> gaze</span>
<span id="cb106-688"><a href="#cb106-688" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-689"><a href="#cb106-689" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-690"><a href="#cb106-690" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">(</span><span class="co">]</span>{probation}{micsr.data}</span>
<span id="cb106-691"><a href="#cb106-691" aria-hidden="true" tabindex="-1"></a>The bandwidth is 0.457 (as the initial range of the forcing variable is $<span class="co">[</span><span class="ot">-1.6, 2.8</span><span class="co">]</span>$) and 8592 observations are used out of <span class="in">`r nrow(probation)`</span> in the <span class="in">`probation`</span> data set. Besides the standard t statistic, <span class="in">`rdrobust`</span> computes a robust statistic, which is slightly lower than the conventional statistic.</span>
<span id="cb106-692"><a href="#cb106-692" aria-hidden="true" tabindex="-1"></a> \index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{bandwidth|)}</span>
<span id="cb106-693"><a href="#cb106-693" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{regression discontinuity!fuzzy}</span>
<span id="cb106-694"><a href="#cb106-694" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{instrumental variable estimator!regression discontinuity}</span>
<span id="cb106-695"><a href="#cb106-695" aria-hidden="true" tabindex="-1"></a>When the discontinuity is fuzzy, the effect of the treatment is</span>
<span id="cb106-696"><a href="#cb106-696" aria-hidden="true" tabindex="-1"></a>computed using two stage least squares, the eligibility status being</span>
<span id="cb106-697"><a href="#cb106-697" aria-hidden="true" tabindex="-1"></a>an instrument for treatment.</span>
<span id="cb106-698"><a href="#cb106-698" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">(</span><span class="co">]</span>{bdh}{micsr.data}</span>
<span id="cb106-699"><a href="#cb106-699" aria-hidden="true" tabindex="-1"></a>\idxfun{mutate}{dplyr}\idxfun{as.numeric}{base}\idxfun{ivreg}{ivreg}\idxfun{gaze}{micsr}</span>
<span id="cb106-700"><a href="#cb106-700" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-701"><a href="#cb106-701" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-702"><a href="#cb106-702" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: bdh_iv_te</span></span>
<span id="cb106-703"><a href="#cb106-703" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: true</span></span>
<span id="cb106-704"><a href="#cb106-704" aria-hidden="true" tabindex="-1"></a>bdh <span class="ot">&lt;-</span> bdh <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">eligible =</span> <span class="fu">as.numeric</span>(selben <span class="sc">&lt;</span> <span class="dv">0</span>))</span>
<span id="cb106-705"><a href="#cb106-705" aria-hidden="true" tabindex="-1"></a>ivreg<span class="sc">::</span><span class="fu">ivreg</span>(attendmonth <span class="sc">~</span> selben <span class="sc">*</span> treated <span class="sc">|</span> selben <span class="sc">*</span> eligible, </span>
<span id="cb106-706"><a href="#cb106-706" aria-hidden="true" tabindex="-1"></a>             <span class="at">data =</span> bdh) <span class="sc">%&gt;%</span> <span class="fu">gaze</span>(<span class="at">coef =</span> <span class="st">"treated"</span>)</span>
<span id="cb106-707"><a href="#cb106-707" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-708"><a href="#cb106-708" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-709"><a href="#cb106-709" aria-hidden="true" tabindex="-1"></a>The effect of receiving the grant increases monthly church attendance by 1.72, and the effect is significant. The <span class="in">`rdrobust`</span> function can be used in a fuzzy discontinuity context using the <span class="in">`fuzzy`</span> argument to indicate the treatment variable. A matrix of </span>
<span id="cb106-710"><a href="#cb106-710" aria-hidden="true" tabindex="-1"></a>supplementary covariates can be added using the <span class="in">`covs`</span> argument.</span>
<span id="cb106-711"><a href="#cb106-711" aria-hidden="true" tabindex="-1"></a>\idxfun{rdrobust}{rdrobust}\idxfun{with}{base}\idxfun{gaze}{micsr}</span>
<span id="cb106-712"><a href="#cb106-712" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-713"><a href="#cb106-713" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-714"><a href="#cb106-714" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: bdh_rdrobust_te</span></span>
<span id="cb106-715"><a href="#cb106-715" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(bdh, <span class="fu">rdrobust</span>(<span class="at">y =</span> attendmonth, <span class="at">x =</span> selben, <span class="at">fuzzy =</span> treated,</span>
<span id="cb106-716"><a href="#cb106-716" aria-hidden="true" tabindex="-1"></a>                   <span class="at">covs =</span> <span class="fu">cbind</span>(age, hsize, schooling))) <span class="sc">%&gt;%</span> gaze</span>
<span id="cb106-717"><a href="#cb106-717" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-718"><a href="#cb106-718" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-719"><a href="#cb106-719" aria-hidden="true" tabindex="-1"></a>As the <span class="in">`h`</span> argument is not specified, the bandwidth is automatically computed and is 1.851, and the number of observation used is 1114 out of 2645 in the original data set. The coefficient of <span class="in">`treatment`</span> is 2.07 (slightly higher than the one obtained previously), and the conventional and the robust tests indicate that the coefficient is significant at the 5% level.</span>
<span id="cb106-720"><a href="#cb106-720" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">(</span><span class="co">]</span>{bdh}{micsr.data}</span>
<span id="cb106-721"><a href="#cb106-721" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-722"><a href="#cb106-722" aria-hidden="true" tabindex="-1"></a><span class="fu">### Manipulation test</span></span>
<span id="cb106-723"><a href="#cb106-723" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-724"><a href="#cb106-724" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{manipulation test}\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{regression discontinuity!manipulation test}</span>
<span id="cb106-725"><a href="#cb106-725" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">(</span><span class="co">]</span>{probation}{micsr.data}</span>
<span id="cb106-726"><a href="#cb106-726" aria-hidden="true" tabindex="-1"></a>A critical hypothesis of regression discontinuity designs is that</span>
<span id="cb106-727"><a href="#cb106-727" aria-hidden="true" tabindex="-1"></a>individuals are set randomly on both sides of the cutoff. On the</span>
<span id="cb106-728"><a href="#cb106-728" aria-hidden="true" tabindex="-1"></a>contrary, individuals being aware of the existence of the treatment</span>
<span id="cb106-729"><a href="#cb106-729" aria-hidden="true" tabindex="-1"></a>and of the value of the cutoff may manipulate their value of the</span>
<span id="cb106-730"><a href="#cb106-730" aria-hidden="true" tabindex="-1"></a>forcing variable in order to be on one specific side of the cutoff. In</span>
<span id="cb106-731"><a href="#cb106-731" aria-hidden="true" tabindex="-1"></a>this case, the distribution of the forcing variable should also\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{forcing variable}</span>
<span id="cb106-732"><a href="#cb106-732" aria-hidden="true" tabindex="-1"></a>exhibit a discontinuity at the cutoff. The first manipulation test was proposed by</span>
<span id="cb106-733"><a href="#cb106-733" aria-hidden="true" tabindex="-1"></a>@MCCR:08\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{McCrary}. The <span class="in">`rddensity:rddensity`</span> function performs an extension of this test. </span>
<span id="cb106-734"><a href="#cb106-734" aria-hidden="true" tabindex="-1"></a>\idxfun{rddensity}{rddensity}\idxfun{pull}{dplyr}\idxfun{gaze}{micsr}</span>
<span id="cb106-735"><a href="#cb106-735" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-736"><a href="#cb106-736" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-737"><a href="#cb106-737" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb106-738"><a href="#cb106-738" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb106-739"><a href="#cb106-739" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: probation_manip</span></span>
<span id="cb106-740"><a href="#cb106-740" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rddensity)</span>
<span id="cb106-741"><a href="#cb106-741" aria-hidden="true" tabindex="-1"></a>dens_test <span class="ot">&lt;-</span> probation <span class="sc">%&gt;%</span> <span class="fu">pull</span>(distcut) <span class="sc">%&gt;%</span> rddensity</span>
<span id="cb106-742"><a href="#cb106-742" aria-hidden="true" tabindex="-1"></a>dens_test <span class="sc">%&gt;%</span> gaze</span>
<span id="cb106-743"><a href="#cb106-743" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-744"><a href="#cb106-744" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-745"><a href="#cb106-745" aria-hidden="true" tabindex="-1"></a>The p-value being equal to $0.45$, the absence of manipulation is not</span>
<span id="cb106-746"><a href="#cb106-746" aria-hidden="true" tabindex="-1"></a>rejected. The <span class="in">`rddensity:rdplotdensity`</span> function plots the</span>
<span id="cb106-747"><a href="#cb106-747" aria-hidden="true" tabindex="-1"></a>density on the left and on the right of the cutoff, with a confidence</span>
<span id="cb106-748"><a href="#cb106-748" aria-hidden="true" tabindex="-1"></a>interval; if the two confidence intervals overlaps, the hypothesis of no</span>
<span id="cb106-749"><a href="#cb106-749" aria-hidden="true" tabindex="-1"></a>manipulation is not rejected. This is the case with the <span class="in">`probation`</span></span>
<span id="cb106-750"><a href="#cb106-750" aria-hidden="true" tabindex="-1"></a>data set, as shown in @fig-maniptest.</span>
<span id="cb106-751"><a href="#cb106-751" aria-hidden="true" tabindex="-1"></a>\idxfun{rdplotdensity}{rddensity}</span>
<span id="cb106-752"><a href="#cb106-752" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-755"><a href="#cb106-755" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-756"><a href="#cb106-756" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb106-757"><a href="#cb106-757" aria-hidden="true" tabindex="-1"></a>ra <span class="ot">&lt;-</span> <span class="fu">rdplotdensity</span>(dens_test, probation<span class="sc">$</span>distcut)</span>
<span id="cb106-758"><a href="#cb106-758" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-759"><a href="#cb106-759" aria-hidden="true" tabindex="-1"></a>\idxfun{rdplotdensity}{rddensity}</span>
<span id="cb106-760"><a href="#cb106-760" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-761"><a href="#cb106-761" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-762"><a href="#cb106-762" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-maniptest</span></span>
<span id="cb106-763"><a href="#cb106-763" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Density estimation on both sides of the cutoff for the `probation` data set"</span></span>
<span id="cb106-764"><a href="#cb106-764" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb106-765"><a href="#cb106-765" aria-hidden="true" tabindex="-1"></a>ra <span class="ot">&lt;-</span> <span class="fu">rdplotdensity</span>(dens_test, probation<span class="sc">$</span>distcut, <span class="at">CIcol =</span> <span class="st">"black"</span>,</span>
<span id="cb106-766"><a href="#cb106-766" aria-hidden="true" tabindex="-1"></a>                    <span class="at">histLineCol =</span> <span class="st">"black"</span>,</span>
<span id="cb106-767"><a href="#cb106-767" aria-hidden="true" tabindex="-1"></a>                    <span class="at">histFillCol =</span> <span class="st">"black"</span>, <span class="at">lcol =</span> <span class="st">"black"</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb106-768"><a href="#cb106-768" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-769"><a href="#cb106-769" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">)</span><span class="co">]</span>{probation}{micsr.data}</span>
<span id="cb106-770"><a href="#cb106-770" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-771"><a href="#cb106-771" aria-hidden="true" tabindex="-1"></a>\newpage</span>
<span id="cb106-772"><a href="#cb106-772" aria-hidden="true" tabindex="-1"></a><span class="fu">## Difference-in-differences {#sec-diff_diff}</span></span>
<span id="cb106-773"><a href="#cb106-773" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-774"><a href="#cb106-774" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{difference in differences|(}</span>
<span id="cb106-775"><a href="#cb106-775" aria-hidden="true" tabindex="-1"></a>Sometimes, the outcome is observed for two periods. In the first period, the treatment hasn't been implemented. For the second period, some individuals have been treated (the treatment group), as some individuals haven't (the control group). The effect of the treatment can then be estimated by:</span>
<span id="cb106-776"><a href="#cb106-776" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-777"><a href="#cb106-777" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-778"><a href="#cb106-778" aria-hidden="true" tabindex="-1"></a>\frac{\sum_{n \in T} (y_{n2} - y_{n1})}{N_T} - \frac{\sum_{n \in C} (y_{n2} - y_{n1})}{N_C}</span>
<span id="cb106-779"><a href="#cb106-779" aria-hidden="true" tabindex="-1"></a>$$ {#eq-diff_diff}</span>
<span id="cb106-780"><a href="#cb106-780" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-781"><a href="#cb106-781" aria-hidden="true" tabindex="-1"></a>Each term is the mean difference of the outcome between the two periods for the two groups, and the estimator is the difference of these differences. Consider as an example that the treatment is a job-training program implemented in 2021 and that the outcome is wage observed in 2022. If the first term of @eq-diff_diff is $1000, this means that the average annual wage in the treatment group increased by $1000 in 2022 compared to 2021. This would be a relevant estimator of the effect of the program if nothing had changed on the labor market in 2022 compared to 2021. But if the economic situation improved, then the average wages will increase even for those who haven't been treated. This is measured by the second term in @eq-diff_diff (say $600). Therefore, the effect of the treatment is the difference between the two terms, which is $400.</span>
<span id="cb106-782"><a href="#cb106-782" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-783"><a href="#cb106-783" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">(</span><span class="co">]</span>{car<span class="sc">\_</span>thefts}{micsr.data}</span>
<span id="cb106-784"><a href="#cb106-784" aria-hidden="true" tabindex="-1"></a>As an example, @DITE:SCHA:04\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Di Tella}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Schargrodsky} sought to estimate the causal effect of police on crime. This task is difficult using non-experimental data, as there may be a reverse causality relationship between police and crime: more police reduces crime (negative causal relationship), but an increase in crime may lead authorities to increase police (positive reverse causal relationship).</span>
<span id="cb106-785"><a href="#cb106-785" aria-hidden="true" tabindex="-1"></a>In July 18, 1994, a terrorist attack destroyed the main Jewish-owned center</span>
<span id="cb106-786"><a href="#cb106-786" aria-hidden="true" tabindex="-1"></a>in Buenos Aires, Argentina, killing 85 people, and the federal government decided to</span>
<span id="cb106-787"><a href="#cb106-787" aria-hidden="true" tabindex="-1"></a>provide 24 hour police protection to Jewish-owned institutions. @DITE:SCHA:04\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Di Tella}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Schargrodsky} collected data on three "barrios" in</span>
<span id="cb106-788"><a href="#cb106-788" aria-hidden="true" tabindex="-1"></a>Buenos Aires at the block level on a monthly basis. The outcome of</span>
<span id="cb106-789"><a href="#cb106-789" aria-hidden="true" tabindex="-1"></a>interest is the number of car thefts. Denoting $x$ as a dummy</span>
<span id="cb106-790"><a href="#cb106-790" aria-hidden="true" tabindex="-1"></a>equal to 1 if the block contains or is close to a Jewish institution</span>
<span id="cb106-791"><a href="#cb106-791" aria-hidden="true" tabindex="-1"></a>and $p$ a dummy equal to 1 after the attack, the treatment effect is,</span>
<span id="cb106-792"><a href="#cb106-792" aria-hidden="true" tabindex="-1"></a>in a regression context, the estimate of $\theta$ on the following</span>
<span id="cb106-793"><a href="#cb106-793" aria-hidden="true" tabindex="-1"></a>equation:</span>
<span id="cb106-794"><a href="#cb106-794" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-795"><a href="#cb106-795" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-796"><a href="#cb106-796" aria-hidden="true" tabindex="-1"></a>y_{nt} = \beta_0 + \beta_x x_{n} + \beta_p p_{nt} + \theta x_{n} p_{nt} + \epsilon_{nt}</span>
<span id="cb106-797"><a href="#cb106-797" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-798"><a href="#cb106-798" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-799"><a href="#cb106-799" aria-hidden="true" tabindex="-1"></a>with $t=1, 2$, (the periods before and after the attack). </span>
<span id="cb106-800"><a href="#cb106-800" aria-hidden="true" tabindex="-1"></a>The <span class="in">`car_thefts`</span> data set contains repeated observations of car</span>
<span id="cb106-801"><a href="#cb106-801" aria-hidden="true" tabindex="-1"></a>thefts (<span class="in">`thefts`</span>) for 876 blocks. Each block is observed 10 times on a</span>
<span id="cb106-802"><a href="#cb106-802" aria-hidden="true" tabindex="-1"></a>monthly basis, and the month of the attack (July) is split into two</span>
<span id="cb106-803"><a href="#cb106-803" aria-hidden="true" tabindex="-1"></a>half-month observations.</span>
<span id="cb106-804"><a href="#cb106-804" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-805"><a href="#cb106-805" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-806"><a href="#cb106-806" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: car_thefts</span></span>
<span id="cb106-807"><a href="#cb106-807" aria-hidden="true" tabindex="-1"></a>car_thefts <span class="sc">%&gt;%</span> <span class="fu">print</span>(<span class="at">n =</span> <span class="dv">3</span>)</span>
<span id="cb106-808"><a href="#cb106-808" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-809"><a href="#cb106-809" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-810"><a href="#cb106-810" aria-hidden="true" tabindex="-1"></a>We first compute the total number of thefts (<span class="in">`thefts`</span>) before and after the</span>
<span id="cb106-811"><a href="#cb106-811" aria-hidden="true" tabindex="-1"></a>attack for all the blocks. As the two periods are of unequal length (3.5 and 4.5 months), we divide the number of thefts for the two periods by the corresponding number of days and we multiply by 30.5 to get a monthly value.</span>
<span id="cb106-812"><a href="#cb106-812" aria-hidden="true" tabindex="-1"></a>\idxfun{group<span class="sc">\_</span>by}{dplyr}\idxfun{summarise}{dplyr}</span>
<span id="cb106-813"><a href="#cb106-813" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-814"><a href="#cb106-814" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-815"><a href="#cb106-815" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: true</span></span>
<span id="cb106-816"><a href="#cb106-816" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: car_two_obs</span></span>
<span id="cb106-817"><a href="#cb106-817" aria-hidden="true" tabindex="-1"></a>two_obs <span class="ot">&lt;-</span> car_thefts <span class="sc">%&gt;%</span></span>
<span id="cb106-818"><a href="#cb106-818" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(block, period) <span class="sc">%&gt;%</span></span>
<span id="cb106-819"><a href="#cb106-819" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">thefts =</span> <span class="fu">sum</span>(thefts) <span class="sc">/</span> <span class="fu">sum</span>(days) <span class="sc">*</span> <span class="fl">30.5</span>, </span>
<span id="cb106-820"><a href="#cb106-820" aria-hidden="true" tabindex="-1"></a>              <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb106-821"><a href="#cb106-821" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(two_obs<span class="sc">$</span>thefts)</span>
<span id="cb106-822"><a href="#cb106-822" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-823"><a href="#cb106-823" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-824"><a href="#cb106-824" aria-hidden="true" tabindex="-1"></a>The number of monthly theft per block is about 0.09.</span>
<span id="cb106-825"><a href="#cb106-825" aria-hidden="true" tabindex="-1"></a><span class="in">`distance`</span> is a factor indicating the distance from the block to the nearest Jewish-owned institution: its levels are <span class="in">`"same"`</span> (same block), <span class="in">`"one"`</span>, <span class="in">`"two"`</span> and <span class="in">`"&gt;2"`</span> (one block, two blocks or more than two blocks). We add this variable to <span class="in">`two_obs`</span> by selecting <span class="in">`distance`</span> and <span class="in">`block`</span> in the original data frame, selecting only the distinct rows (one per block) and joining it to <span class="in">`two_obs`</span>:</span>
<span id="cb106-826"><a href="#cb106-826" aria-hidden="true" tabindex="-1"></a>\idxfun{left<span class="sc">\_</span>join}{dplyr}\idxfun{distinct}{dplyr}</span>
<span id="cb106-827"><a href="#cb106-827" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-830"><a href="#cb106-830" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-831"><a href="#cb106-831" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: car_add_distance</span></span>
<span id="cb106-832"><a href="#cb106-832" aria-hidden="true" tabindex="-1"></a>two_obs <span class="ot">&lt;-</span> two_obs <span class="sc">%&gt;%</span> </span>
<span id="cb106-833"><a href="#cb106-833" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(<span class="fu">distinct</span>(car_thefts, block, distance))</span>
<span id="cb106-834"><a href="#cb106-834" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-835"><a href="#cb106-835" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-836"><a href="#cb106-836" aria-hidden="true" tabindex="-1"></a>We then compute the regression by coercing the <span class="in">`distance`</span> to a dummy</span>
<span id="cb106-837"><a href="#cb106-837" aria-hidden="true" tabindex="-1"></a>for the same block:</span>
<span id="cb106-838"><a href="#cb106-838" aria-hidden="true" tabindex="-1"></a>\idxfun{mutate}{dplyr}\idxfun{ifelse}{base}\idxfun{lm}{stats}\idxfun{gaze}{micsr}</span>
<span id="cb106-839"><a href="#cb106-839" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-840"><a href="#cb106-840" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-841"><a href="#cb106-841" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: car_dist_dummy</span></span>
<span id="cb106-842"><a href="#cb106-842" aria-hidden="true" tabindex="-1"></a>two_obs <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">distance =</span> <span class="fu">ifelse</span>(distance <span class="sc">==</span> <span class="st">"same"</span>, <span class="dv">1</span>, <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb106-843"><a href="#cb106-843" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lm</span>(<span class="at">formula =</span> thefts <span class="sc">~</span> period <span class="sc">*</span> distance) <span class="sc">%&gt;%</span> gaze</span>
<span id="cb106-844"><a href="#cb106-844" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-845"><a href="#cb106-845" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-846"><a href="#cb106-846" aria-hidden="true" tabindex="-1"></a>The effect of police on thefts is $-0.07$, which is very high as the average number of monthly theft per block is 0.09 and it is significant.</span>
<span id="cb106-847"><a href="#cb106-847" aria-hidden="true" tabindex="-1"></a>The same difference-in-differences estimator can be obtained by</span>
<span id="cb106-848"><a href="#cb106-848" aria-hidden="true" tabindex="-1"></a>computing a t-test of equality of the two means. We first</span>
<span id="cb106-849"><a href="#cb106-849" aria-hidden="true" tabindex="-1"></a>reshape the data set in order to have one line per block, and we</span>
<span id="cb106-850"><a href="#cb106-850" aria-hidden="true" tabindex="-1"></a>compute the after-before difference:</span>
<span id="cb106-851"><a href="#cb106-851" aria-hidden="true" tabindex="-1"></a>\idxfun{mutate}{dplyr}\idxfun{pivot<span class="sc">\_</span>wider}{tidyr}\idxfun{mutate}{dplyr}\idxfun{ifelse}{base}</span>
<span id="cb106-852"><a href="#cb106-852" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-853"><a href="#cb106-853" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-854"><a href="#cb106-854" aria-hidden="true" tabindex="-1"></a>diffs <span class="ot">&lt;-</span> two_obs <span class="sc">%&gt;%</span></span>
<span id="cb106-855"><a href="#cb106-855" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">distance =</span> <span class="fu">ifelse</span>(distance <span class="sc">==</span> <span class="st">"same"</span>, <span class="st">"yes"</span>, <span class="st">"no"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb106-856"><a href="#cb106-856" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> period, <span class="at">values_from =</span> thefts) <span class="sc">%&gt;%</span></span>
<span id="cb106-857"><a href="#cb106-857" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">dt =</span> after <span class="sc">-</span> before)</span>
<span id="cb106-858"><a href="#cb106-858" aria-hidden="true" tabindex="-1"></a>diffs <span class="sc">%&gt;%</span> <span class="fu">print</span>(<span class="at">n =</span> <span class="dv">3</span>)</span>
<span id="cb106-859"><a href="#cb106-859" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-860"><a href="#cb106-860" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-861"><a href="#cb106-861" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{t-test}</span>
<span id="cb106-862"><a href="#cb106-862" aria-hidden="true" tabindex="-1"></a>and we then use the <span class="in">`t.test`</span> function:</span>
<span id="cb106-863"><a href="#cb106-863" aria-hidden="true" tabindex="-1"></a>\idxfun{t.test}{stats}\idxfun{gaze}{micsr}</span>
<span id="cb106-864"><a href="#cb106-864" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-865"><a href="#cb106-865" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-866"><a href="#cb106-866" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: car_ttest</span></span>
<span id="cb106-867"><a href="#cb106-867" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: true</span></span>
<span id="cb106-868"><a href="#cb106-868" aria-hidden="true" tabindex="-1"></a><span class="fu">t.test</span>(dt <span class="sc">~</span> distance, diffs, <span class="at">var.equal =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> gaze</span>
<span id="cb106-869"><a href="#cb106-869" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-870"><a href="#cb106-870" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">(</span><span class="co">]</span>{car<span class="sc">\_</span>thefts}{micsr.data}</span>
<span id="cb106-871"><a href="#cb106-871" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-872"><a href="#cb106-872" aria-hidden="true" tabindex="-1"></a>The difference-in-differences can be extended to the case where the</span>
<span id="cb106-873"><a href="#cb106-873" aria-hidden="true" tabindex="-1"></a>observation units before and after the implementation of the treatment</span>
<span id="cb106-874"><a href="#cb106-874" aria-hidden="true" tabindex="-1"></a>are not the same. This is the case in @HONG:13'\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Hong}, which</span>
<span id="cb106-875"><a href="#cb106-875" aria-hidden="true" tabindex="-1"></a>studied the impact of the introduction of Napster on music</span>
<span id="cb106-876"><a href="#cb106-876" aria-hidden="true" tabindex="-1"></a>expenditure. The study is based on the Consumer Expenditure Survey,</span>
<span id="cb106-877"><a href="#cb106-877" aria-hidden="true" tabindex="-1"></a>which is performed on a quarterly basis, and the data set is called <span class="in">`napster`</span>. Napster was introduced in June</span>
<span id="cb106-878"><a href="#cb106-878" aria-hidden="true" tabindex="-1"></a>1999 and became the dominant file-sharing service. Households</span>
<span id="cb106-879"><a href="#cb106-879" aria-hidden="true" tabindex="-1"></a>with (without) internet access constitute the treatment (control)</span>
<span id="cb106-880"><a href="#cb106-880" aria-hidden="true" tabindex="-1"></a>group. From the <span class="in">`date`</span> series, we construct a <span class="in">`period`</span> variable using June 1999 as the cutoff:</span>
<span id="cb106-881"><a href="#cb106-881" aria-hidden="true" tabindex="-1"></a>\idxfun{select}{dplyr}\idxfun{mutate}{dplyr}\idxfun{ifelse}{base}\idxfun{factor}{base}</span>
<span id="cb106-882"><a href="#cb106-882" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">(</span><span class="co">]</span>{napster}{micsr.data}</span>
<span id="cb106-883"><a href="#cb106-883" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-884"><a href="#cb106-884" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-885"><a href="#cb106-885" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: napster</span></span>
<span id="cb106-886"><a href="#cb106-886" aria-hidden="true" tabindex="-1"></a>napster <span class="ot">&lt;-</span> napster <span class="sc">%&gt;%</span></span>
<span id="cb106-887"><a href="#cb106-887" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(date, expmusic, internet, weight) <span class="sc">%&gt;%</span></span>
<span id="cb106-888"><a href="#cb106-888" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">period =</span> <span class="fu">ifelse</span>(date <span class="sc">&lt;</span> <span class="fu">ymd</span>(<span class="st">"1999-06-01"</span>), <span class="st">"before"</span>, <span class="st">"after"</span>),</span>
<span id="cb106-889"><a href="#cb106-889" aria-hidden="true" tabindex="-1"></a>           <span class="at">period =</span> <span class="fu">factor</span>(period, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"before"</span>, <span class="st">"after"</span>)))</span>
<span id="cb106-890"><a href="#cb106-890" aria-hidden="true" tabindex="-1"></a>napster <span class="sc">%&gt;%</span> <span class="fu">print</span>(<span class="at">n =</span> <span class="dv">3</span>)</span>
<span id="cb106-891"><a href="#cb106-891" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-892"><a href="#cb106-892" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-893"><a href="#cb106-893" aria-hidden="true" tabindex="-1"></a>we then proceed to the estimation, with <span class="in">`expmusic`</span>, the expenditures on recorded music as a response:</span>
<span id="cb106-894"><a href="#cb106-894" aria-hidden="true" tabindex="-1"></a>\idxfun{lm}{stats}\idxfun{gaze}{micsr}</span>
<span id="cb106-895"><a href="#cb106-895" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-896"><a href="#cb106-896" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-897"><a href="#cb106-897" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: napster_lm</span></span>
<span id="cb106-898"><a href="#cb106-898" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(expmusic <span class="sc">~</span> period <span class="sc">*</span> internet, napster, <span class="at">weight =</span> weight) <span class="sc">%&gt;%</span> gaze</span>
<span id="cb106-899"><a href="#cb106-899" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-900"><a href="#cb106-900" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-901"><a href="#cb106-901" aria-hidden="true" tabindex="-1"></a><span class="in">`internetyes`</span> has a strong positive effect on expenditure. The interaction term between <span class="in">`period`</span> and <span class="in">`internet`</span> indicates that, the deployment of Napster led to a significant reduction of the expense for the "treated" individuals (those who have internet access) of $4.6.</span>
<span id="cb106-902"><a href="#cb106-902" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">)</span><span class="co">]</span>{napster}{micsr.data}</span>
<span id="cb106-903"><a href="#cb106-903" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{difference in differences|)}</span>
<span id="cb106-904"><a href="#cb106-904" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-905"><a href="#cb106-905" aria-hidden="true" tabindex="-1"></a><span class="fu">## Matching {#sec-matching}</span></span>
<span id="cb106-906"><a href="#cb106-906" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{matching|(}</span>
<span id="cb106-907"><a href="#cb106-907" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-908"><a href="#cb106-908" aria-hidden="true" tabindex="-1"></a>The fundamental problem of estimating the treatment effect on</span>
<span id="cb106-909"><a href="#cb106-909" aria-hidden="true" tabindex="-1"></a>observational data is that the treatment and the control sample are not</span>
<span id="cb106-910"><a href="#cb106-910" aria-hidden="true" tabindex="-1"></a>drawn from the same population, so that average (observable or</span>
<span id="cb106-911"><a href="#cb106-911" aria-hidden="true" tabindex="-1"></a>non-observable) characteristics are not the same. The idea of matching</span>
<span id="cb106-912"><a href="#cb106-912" aria-hidden="true" tabindex="-1"></a>is to select, for each treated observation, an observation in the control group as</span>
<span id="cb106-913"><a href="#cb106-913" aria-hidden="true" tabindex="-1"></a> similar as possible, based on observed characteristics. If it is</span>
<span id="cb106-914"><a href="#cb106-914" aria-hidden="true" tabindex="-1"></a>possible to do it for all the observations in the treatment group, the resulting</span>
<span id="cb106-915"><a href="#cb106-915" aria-hidden="true" tabindex="-1"></a>sample would be similar to experimental data, i.e., a</span>
<span id="cb106-916"><a href="#cb106-916" aria-hidden="true" tabindex="-1"></a>sample with treated and control observations drawn from the same</span>
<span id="cb106-917"><a href="#cb106-917" aria-hidden="true" tabindex="-1"></a>population. When there are few covariates which take a small number of</span>
<span id="cb106-918"><a href="#cb106-918" aria-hidden="true" tabindex="-1"></a>different values, it is possible to find in the control group an</span>
<span id="cb106-919"><a href="#cb106-919" aria-hidden="true" tabindex="-1"></a>observation which has exactly the same observed characteristics than a</span>
<span id="cb106-920"><a href="#cb106-920" aria-hidden="true" tabindex="-1"></a>treated observation (for example, a man aged 25 with 12 years of</span>
<span id="cb106-921"><a href="#cb106-921" aria-hidden="true" tabindex="-1"></a>education). On the contrary, with numerous and/or continuous</span>
<span id="cb106-922"><a href="#cb106-922" aria-hidden="true" tabindex="-1"></a>covariates, it is impossible to match a treated observation with an exactly</span>
<span id="cb106-923"><a href="#cb106-923" aria-hidden="true" tabindex="-1"></a>similar observation in the control group. </span>
<span id="cb106-924"><a href="#cb106-924" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-925"><a href="#cb106-925" aria-hidden="true" tabindex="-1"></a>In this case, the dimension of the problem</span>
<span id="cb106-926"><a href="#cb106-926" aria-hidden="true" tabindex="-1"></a>is reduced to one using a **propensity score** estimator.\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{propensity score}</span>
<span id="cb106-927"><a href="#cb106-927" aria-hidden="true" tabindex="-1"></a>The propensity score is the conditional probability (given *x*) of being</span>
<span id="cb106-928"><a href="#cb106-928" aria-hidden="true" tabindex="-1"></a>treated. It can be fitted using for example a logit or a probit, the</span>
<span id="cb106-929"><a href="#cb106-929" aria-hidden="true" tabindex="-1"></a>response being a dummy for treated individuals. Then, each treated</span>
<span id="cb106-930"><a href="#cb106-930" aria-hidden="true" tabindex="-1"></a>individual is matched with the observation in the control group which</span>
<span id="cb106-931"><a href="#cb106-931" aria-hidden="true" tabindex="-1"></a>has the closest propensity score. Finally, the estimation of the treatment effect is performed on the subset of the sample composed by all the observations of the treatment group and those of the control group that match these observations.</span>
<span id="cb106-932"><a href="#cb106-932" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-933"><a href="#cb106-933" aria-hidden="true" tabindex="-1"></a>The matching estimator was first proposed by @ROSE:RUBI:83\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Rosenbaum}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Rubin} and the interest in matching methods in econometrics really started with the articles of Dehejia and Wahba <span class="co">[</span><span class="ot">-@DEHE:WAHB:99; -@DEHE:WAHB:02</span><span class="co">]</span>\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Dehejia Wahba}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Wahba}. These two articles revisited the results of @LALO:86\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Lalonde} who showed that the estimation of treatment effect with observational data can be </span>
<span id="cb106-934"><a href="#cb106-934" aria-hidden="true" tabindex="-1"></a>seriously biased. Using</span>
<span id="cb106-935"><a href="#cb106-935" aria-hidden="true" tabindex="-1"></a>Lalonde's data, they showed that matching methods can be used to</span>
<span id="cb106-936"><a href="#cb106-936" aria-hidden="true" tabindex="-1"></a>estimate consistently treatment effects on observational data. They</span>
<span id="cb106-937"><a href="#cb106-937" aria-hidden="true" tabindex="-1"></a>also proposed an algorithm, implemented in **Stata** by @BECK:ICHI:02\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Becker}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Ichino}:</span>
<span id="cb106-938"><a href="#cb106-938" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{propensity score}</span>
<span id="cb106-939"><a href="#cb106-939" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-940"><a href="#cb106-940" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>first compute the propensity scores using a probit or a logit model</span>
<span id="cb106-941"><a href="#cb106-941" aria-hidden="true" tabindex="-1"></a>  with a rich set of covariates, eventually with squares and</span>
<span id="cb106-942"><a href="#cb106-942" aria-hidden="true" tabindex="-1"></a>  interactions between covariates,</span>
<span id="cb106-943"><a href="#cb106-943" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>start with a small number of strata, for example 5 (0-0.2, 0.2-0.4,</span>
<span id="cb106-944"><a href="#cb106-944" aria-hidden="true" tabindex="-1"></a>  ..., 0.8-1), and test for each strata the hypothesis that the means of</span>
<span id="cb106-945"><a href="#cb106-945" aria-hidden="true" tabindex="-1"></a>  the scores are equal in the two groups,</span>
<span id="cb106-946"><a href="#cb106-946" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>if the test fails for one strata, split it in two (for example, the</span>
<span id="cb106-947"><a href="#cb106-947" aria-hidden="true" tabindex="-1"></a>  0.2-0.4 strata is decomposed in two stratas 0.2-0.3 and 0.3-0.4)</span>
<span id="cb106-948"><a href="#cb106-948" aria-hidden="true" tabindex="-1"></a>  until the equal mean hypothesis is not rejected for every strata,</span>
<span id="cb106-949"><a href="#cb106-949" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>then compute the same test for each covariate,</span>
<span id="cb106-950"><a href="#cb106-950" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>if the test fails for some covariates, estimate a more flexible</span>
<span id="cb106-951"><a href="#cb106-951" aria-hidden="true" tabindex="-1"></a>  propensity score model, adding squares and interactions between</span>
<span id="cb106-952"><a href="#cb106-952" aria-hidden="true" tabindex="-1"></a>  covariates.</span>
<span id="cb106-953"><a href="#cb106-953" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-954"><a href="#cb106-954" aria-hidden="true" tabindex="-1"></a>Once the stratas are computed, a natural estimator of the treatment</span>
<span id="cb106-955"><a href="#cb106-955" aria-hidden="true" tabindex="-1"></a>effect is:</span>
<span id="cb106-956"><a href="#cb106-956" aria-hidden="true" tabindex="-1"></a>$\sum_k (\bar{y}_k^t - \bar{y}_k ^ c) f_k$,</span>
<span id="cb106-957"><a href="#cb106-957" aria-hidden="true" tabindex="-1"></a>where $\bar{y}_k ^ t$ and $\bar{y}_k ^ c$ are the mean values of the outcome in the treatment and in the control group  and $f_k = t_k / N_T$ is the frequency of strata $k$ for the treatment group (with $t_k$ the number of treated individuals in strata $k$ and $N_T$ the total number of treated individuals). The</span>
<span id="cb106-958"><a href="#cb106-958" aria-hidden="true" tabindex="-1"></a>variance of the estimated treatment effect can be computed with or without the</span>
<span id="cb106-959"><a href="#cb106-959" aria-hidden="true" tabindex="-1"></a>hypothesis of equal variance between stratas, between groups or</span>
<span id="cb106-960"><a href="#cb106-960" aria-hidden="true" tabindex="-1"></a>both. </span>
<span id="cb106-961"><a href="#cb106-961" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb106-962"><a href="#cb106-962" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">(</span><span class="co">]</span>{twa}{micsr.data}</span>
<span id="cb106-963"><a href="#cb106-963" aria-hidden="true" tabindex="-1"></a>As an example, we replicate the results of @ICHI:MEAL:NANN:08\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Ichino}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Mealli}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Nannicini} who studied</span>
<span id="cb106-964"><a href="#cb106-964" aria-hidden="true" tabindex="-1"></a>the effect of temporary work agency (TWA) jobs on the probability of</span>
<span id="cb106-965"><a href="#cb106-965" aria-hidden="true" tabindex="-1"></a>finding a stable job. The data set, called <span class="in">`twa`</span>, contains $2030$ observations ($511$</span>
<span id="cb106-966"><a href="#cb106-966" aria-hidden="true" tabindex="-1"></a>treated and $1519$ untreated) for two regions, Tuscany and</span>
<span id="cb106-967"><a href="#cb106-967" aria-hidden="true" tabindex="-1"></a>Sicily. We restrict the sample to Tuscany:</span>
<span id="cb106-968"><a href="#cb106-968" aria-hidden="true" tabindex="-1"></a>\idxfun{filter}{dplyr}</span>
<span id="cb106-969"><a href="#cb106-969" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-970"><a href="#cb106-970" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-971"><a href="#cb106-971" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tuscany</span></span>
<span id="cb106-972"><a href="#cb106-972" aria-hidden="true" tabindex="-1"></a>tuscany <span class="ot">&lt;-</span> twa <span class="sc">%&gt;%</span> <span class="fu">filter</span>(region <span class="sc">==</span> <span class="st">"Tuscany"</span>)</span>
<span id="cb106-973"><a href="#cb106-973" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-974"><a href="#cb106-974" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-975"><a href="#cb106-975" aria-hidden="true" tabindex="-1"></a>There are $281$ observations in the treatment group and $628$ in the control group. The group variable <span class="in">`group`</span> is a factor with levels <span class="in">`"control"`</span> and <span class="in">`"treatment"`</span>, and the outcome is also a factor indicating the employment status one year after the</span>
<span id="cb106-976"><a href="#cb106-976" aria-hidden="true" tabindex="-1"></a>program. Its levels are <span class="in">`none`</span> (no job), <span class="in">`other`</span>, <span class="in">`fterm`</span> for fixed-term</span>
<span id="cb106-977"><a href="#cb106-977" aria-hidden="true" tabindex="-1"></a>contract and <span class="in">`perm`</span> for a permanent contract. Following the authors,</span>
<span id="cb106-978"><a href="#cb106-978" aria-hidden="true" tabindex="-1"></a>we define the outcome of interest as a dummy for a permanent contract:</span>
<span id="cb106-979"><a href="#cb106-979" aria-hidden="true" tabindex="-1"></a>\idxfun{mutate}{dplyr}\idxfun{ifelse}{base}</span>
<span id="cb106-980"><a href="#cb106-980" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-981"><a href="#cb106-981" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-982"><a href="#cb106-982" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tuscany_perm</span></span>
<span id="cb106-983"><a href="#cb106-983" aria-hidden="true" tabindex="-1"></a>tuscany <span class="ot">&lt;-</span> tuscany <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">perm =</span> <span class="fu">ifelse</span>(outcome <span class="sc">==</span> <span class="st">"perm"</span>, <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb106-984"><a href="#cb106-984" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-985"><a href="#cb106-985" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-986"><a href="#cb106-986" aria-hidden="true" tabindex="-1"></a>To get a first idea of the treatment effect, we compute the mean of</span>
<span id="cb106-987"><a href="#cb106-987" aria-hidden="true" tabindex="-1"></a><span class="in">`perm`</span> for the two groups:</span>
<span id="cb106-988"><a href="#cb106-988" aria-hidden="true" tabindex="-1"></a>\idxfun{group<span class="sc">\_</span>by}{dplyr}\idxfun{summarise}{dplyr}</span>
<span id="cb106-989"><a href="#cb106-989" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-990"><a href="#cb106-990" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-991"><a href="#cb106-991" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tuscany_apparent_te</span></span>
<span id="cb106-992"><a href="#cb106-992" aria-hidden="true" tabindex="-1"></a>tuscany <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(group) <span class="sc">%&gt;%</span></span>
<span id="cb106-993"><a href="#cb106-993" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>(), <span class="at">outcome =</span> <span class="fu">mean</span>(perm))</span>
<span id="cb106-994"><a href="#cb106-994" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-995"><a href="#cb106-995" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-996"><a href="#cb106-996" aria-hidden="true" tabindex="-1"></a>The proportion of individuals who have a permanent job is 31.3% for</span>
<span id="cb106-997"><a href="#cb106-997" aria-hidden="true" tabindex="-1"></a>the treated group and 16.6% for the control group and the apparent</span>
<span id="cb106-998"><a href="#cb106-998" aria-hidden="true" tabindex="-1"></a>treatment effect is therefore 14.7%.</span>
<span id="cb106-999"><a href="#cb106-999" aria-hidden="true" tabindex="-1"></a>The <span class="in">`micsr::pscore`</span> function implements the algorithm</span>
<span id="cb106-1000"><a href="#cb106-1000" aria-hidden="true" tabindex="-1"></a>previously described. The first two arguments are <span class="in">`formula`</span> and</span>
<span id="cb106-1001"><a href="#cb106-1001" aria-hidden="true" tabindex="-1"></a><span class="in">`data`</span>. The formula should have two variables on the left-hand side,</span>
<span id="cb106-1002"><a href="#cb106-1002" aria-hidden="true" tabindex="-1"></a>the first indicating the outcome and the second </span>
<span id="cb106-1003"><a href="#cb106-1003" aria-hidden="true" tabindex="-1"></a>the group. The group variable can be either a dummy or a factor with</span>
<span id="cb106-1004"><a href="#cb106-1004" aria-hidden="true" tabindex="-1"></a>two levels, the second indicating the treated individuals. </span>
<span id="cb106-1005"><a href="#cb106-1005" aria-hidden="true" tabindex="-1"></a>To estimate the propensity score, we use the same formula as</span>
<span id="cb106-1006"><a href="#cb106-1006" aria-hidden="true" tabindex="-1"></a>@ICHI:MEAL:NANN:08,\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Ichino}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Mealli}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Nannicini} and in particular, we use a square term for the</span>
<span id="cb106-1007"><a href="#cb106-1007" aria-hidden="true" tabindex="-1"></a>distance to the next agency and an interaction between self-employed</span>
<span id="cb106-1008"><a href="#cb106-1008" aria-hidden="true" tabindex="-1"></a>status and the city of Livorno:</span>
<span id="cb106-1009"><a href="#cb106-1009" aria-hidden="true" tabindex="-1"></a>\idxfun{mutate}{dplyr}\idxfun{ifelse}{base}\idxfun{pscore}{micsr}</span>
<span id="cb106-1010"><a href="#cb106-1010" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1011"><a href="#cb106-1011" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-1012"><a href="#cb106-1012" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tuscany_pscore</span></span>
<span id="cb106-1013"><a href="#cb106-1013" aria-hidden="true" tabindex="-1"></a>tuscany <span class="ot">&lt;-</span> tuscany <span class="sc">%&gt;%</span></span>
<span id="cb106-1014"><a href="#cb106-1014" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">dist2 =</span> dist <span class="sc">^</span> <span class="dv">2</span>,</span>
<span id="cb106-1015"><a href="#cb106-1015" aria-hidden="true" tabindex="-1"></a>           <span class="at">livselfemp =</span> <span class="fu">I</span>((city <span class="sc">==</span> <span class="st">"livorno"</span>) <span class="sc">*</span> (occup <span class="sc">==</span> <span class="st">"selfemp"</span>)),</span>
<span id="cb106-1016"><a href="#cb106-1016" aria-hidden="true" tabindex="-1"></a>           <span class="at">perm =</span> <span class="fu">ifelse</span>(outcome <span class="sc">==</span> <span class="st">"perm"</span>, <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb106-1017"><a href="#cb106-1017" aria-hidden="true" tabindex="-1"></a>ftusc <span class="ot">&lt;-</span> perm <span class="sc">+</span> group <span class="sc">~</span> city <span class="sc">+</span> sex <span class="sc">+</span> marital <span class="sc">+</span> age <span class="sc">+</span></span>
<span id="cb106-1018"><a href="#cb106-1018" aria-hidden="true" tabindex="-1"></a>    loc <span class="sc">+</span> children <span class="sc">+</span> educ <span class="sc">+</span> pvoto <span class="sc">+</span> training <span class="sc">+</span></span>
<span id="cb106-1019"><a href="#cb106-1019" aria-hidden="true" tabindex="-1"></a>    empstat <span class="sc">+</span> occup <span class="sc">+</span> sector <span class="sc">+</span> wage <span class="sc">+</span> hour <span class="sc">+</span> feduc <span class="sc">+</span> femp <span class="sc">+</span> fbluecol <span class="sc">+</span></span>
<span id="cb106-1020"><a href="#cb106-1020" aria-hidden="true" tabindex="-1"></a>    dist <span class="sc">+</span> dist2 <span class="sc">+</span> livselfemp</span>
<span id="cb106-1021"><a href="#cb106-1021" aria-hidden="true" tabindex="-1"></a>ps <span class="ot">&lt;-</span> <span class="fu">pscore</span>(ftusc, tuscany)</span>
<span id="cb106-1022"><a href="#cb106-1022" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1023"><a href="#cb106-1023" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1024"><a href="#cb106-1024" aria-hidden="true" tabindex="-1"></a>Three supplementary arguments of <span class="in">`pscore`</span> can be used: the maximum number of iterations</span>
<span id="cb106-1025"><a href="#cb106-1025" aria-hidden="true" tabindex="-1"></a>(default 4), the tolerance level for the t-tests (default 0.005) and</span>
<span id="cb106-1026"><a href="#cb106-1026" aria-hidden="true" tabindex="-1"></a>the link for the binomial model (default to logit). For the tolerance</span>
<span id="cb106-1027"><a href="#cb106-1027" aria-hidden="true" tabindex="-1"></a>level, @BECK:ICHI:02\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Becker}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Ichino} advised to use a low level with the following</span>
<span id="cb106-1028"><a href="#cb106-1028" aria-hidden="true" tabindex="-1"></a>argument: with for example 20 covariates, using a 5% level, if the</span>
<span id="cb106-1029"><a href="#cb106-1029" aria-hidden="true" tabindex="-1"></a>tests are mutually independent, the probability that one of the tests</span>
<span id="cb106-1030"><a href="#cb106-1030" aria-hidden="true" tabindex="-1"></a>rejects the balancing property, although it holds, is 37%.</span>
<span id="cb106-1031"><a href="#cb106-1031" aria-hidden="true" tabindex="-1"></a><span class="in">`pscore`</span> returns a <span class="in">`pscore`</span> object which contains three tibbles. </span>
<span id="cb106-1032"><a href="#cb106-1032" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1033"><a href="#cb106-1033" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`strata`</span> contains information about the stratas (the frequencies, the</span>
<span id="cb106-1034"><a href="#cb106-1034" aria-hidden="true" tabindex="-1"></a>average propensity scores and the probability value of the hypothesis</span>
<span id="cb106-1035"><a href="#cb106-1035" aria-hidden="true" tabindex="-1"></a>of no difference of the propensity scores in the two groups),</span>
<span id="cb106-1036"><a href="#cb106-1036" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`cov_balance`</span> has a line for every covariate and contains the strata</span>
<span id="cb106-1037"><a href="#cb106-1037" aria-hidden="true" tabindex="-1"></a>for which the probability value is the smallest,</span>
<span id="cb106-1038"><a href="#cb106-1038" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`model`</span> contains the original data sets with some supplementary</span>
<span id="cb106-1039"><a href="#cb106-1039" aria-hidden="true" tabindex="-1"></a>  columns:</span>
<span id="cb106-1040"><a href="#cb106-1040" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span><span class="in">`pscore`</span> contains the propensity score for every observation,</span>
<span id="cb106-1041"><a href="#cb106-1041" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span><span class="in">`.gp`</span> is a factor with levels <span class="in">`"control"`</span> and <span class="in">`"treated"`</span>,</span>
<span id="cb106-1042"><a href="#cb106-1042" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span><span class="in">`.cs`</span> is a boolean indicating whether the propensity score for an</span>
<span id="cb106-1043"><a href="#cb106-1043" aria-hidden="true" tabindex="-1"></a>    observation lies in the interval of scores for the treated,</span>
<span id="cb106-1044"><a href="#cb106-1044" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span><span class="in">`.resp`</span> contains the response,</span>
<span id="cb106-1045"><a href="#cb106-1045" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span><span class="in">`.cls`</span> indicates the strata for the observation.</span>
<span id="cb106-1046"><a href="#cb106-1046" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1047"><a href="#cb106-1047" aria-hidden="true" tabindex="-1"></a>A <span class="in">`summary`</span> method is provided and the <span class="in">`print`</span> method for <span class="in">`summary.pscore`</span> objects has a <span class="in">`step`</span> argument that allows to print the result of each step of the estimator. To get the information about the stratas, we use:</span>
<span id="cb106-1048"><a href="#cb106-1048" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1049"><a href="#cb106-1049" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-1050"><a href="#cb106-1050" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tuscanny_strata</span></span>
<span id="cb106-1051"><a href="#cb106-1051" aria-hidden="true" tabindex="-1"></a>ps <span class="sc">%&gt;%</span> summary <span class="sc">%&gt;%</span> <span class="fu">print</span>(<span class="at">step =</span> <span class="st">"strata"</span>)</span>
<span id="cb106-1052"><a href="#cb106-1052" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1053"><a href="#cb106-1053" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1054"><a href="#cb106-1054" aria-hidden="true" tabindex="-1"></a>Two of the initial stratas were cut in halves (0-0.2 and 0.6-0.8). The</span>
<span id="cb106-1055"><a href="#cb106-1055" aria-hidden="true" tabindex="-1"></a>control subsample is restricted to the range of the values of the</span>
<span id="cb106-1056"><a href="#cb106-1056" aria-hidden="true" tabindex="-1"></a>propensity score for the treated; therefore, only 592 observations of</span>
<span id="cb106-1057"><a href="#cb106-1057" aria-hidden="true" tabindex="-1"></a>the control group out of 628 are used. With <span class="in">`step = "covariates"`</span>, we get a (long) table indicating, for each covariate, the results of the balance test between the treatment and the control group:</span>
<span id="cb106-1058"><a href="#cb106-1058" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1061"><a href="#cb106-1061" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-1062"><a href="#cb106-1062" aria-hidden="true" tabindex="-1"></a><span class="co">#| results: false</span></span>
<span id="cb106-1063"><a href="#cb106-1063" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tuscanny_covariates</span></span>
<span id="cb106-1064"><a href="#cb106-1064" aria-hidden="true" tabindex="-1"></a>ps <span class="sc">%&gt;%</span> summary <span class="sc">%&gt;%</span> <span class="fu">print</span>(<span class="at">step =</span> <span class="st">"covariates"</span>)</span>
<span id="cb106-1065"><a href="#cb106-1065" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1066"><a href="#cb106-1066" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1067"><a href="#cb106-1067" aria-hidden="true" tabindex="-1"></a>Finally, <span class="in">`step = "atet"`</span> gives the values of the estimated ATET (average treatment effect of the treated) and different estimates of its standard deviation:</span>
<span id="cb106-1068"><a href="#cb106-1068" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1071"><a href="#cb106-1071" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-1072"><a href="#cb106-1072" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tuscanny_atet</span></span>
<span id="cb106-1073"><a href="#cb106-1073" aria-hidden="true" tabindex="-1"></a>ps <span class="sc">%&gt;%</span> summary <span class="sc">%&gt;%</span> <span class="fu">print</span>(<span class="at">step =</span> <span class="st">"atet"</span>)</span>
<span id="cb106-1074"><a href="#cb106-1074" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1075"><a href="#cb106-1075" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1076"><a href="#cb106-1076" aria-hidden="true" tabindex="-1"></a>The estimated treatment effect is $0.177$, which is slightly higher than</span>
<span id="cb106-1077"><a href="#cb106-1077" aria-hidden="true" tabindex="-1"></a>the treatment effect computed with the whole sample which was</span>
<span id="cb106-1078"><a href="#cb106-1078" aria-hidden="true" tabindex="-1"></a>14.7%. It is highly significant with the different flavors of the standard</span>
<span id="cb106-1079"><a href="#cb106-1079" aria-hidden="true" tabindex="-1"></a>deviations ranging from $0.035$ to $0.049$.</span>
<span id="cb106-1080"><a href="#cb106-1080" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1081"><a href="#cb106-1081" aria-hidden="true" tabindex="-1"></a>An alternative to using strata and computing the ATET as a weighted average of the difference of the mean of the outcome between treated and control observations in each stratum is to match each treated observation to one or several observations in the control group. The simplest algorithm consists of selecting, for every treated observation, the control observation which has the</span>
<span id="cb106-1082"><a href="#cb106-1082" aria-hidden="true" tabindex="-1"></a>closest value of propensity score. Using the <span class="in">`model`</span> tibble returned by <span class="in">`pscore`</span>, we begin with constructing two tibbles, one for the treatment group and one for the control group, containing only the index of the observation and the value of the propensity score:</span>
<span id="cb106-1083"><a href="#cb106-1083" aria-hidden="true" tabindex="-1"></a>\idxfun{filter}{dplyr}\idxfun{select}{dplyr}</span>
<span id="cb106-1084"><a href="#cb106-1084" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1087"><a href="#cb106-1087" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-1088"><a href="#cb106-1088" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tuscanny_treatment_control</span></span>
<span id="cb106-1089"><a href="#cb106-1089" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: true</span></span>
<span id="cb106-1090"><a href="#cb106-1090" aria-hidden="true" tabindex="-1"></a>tusc_tr <span class="ot">&lt;-</span> ps<span class="sc">$</span>model <span class="sc">%&gt;%</span> <span class="fu">filter</span>(group <span class="sc">==</span> <span class="st">"treated"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb106-1091"><a href="#cb106-1091" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="at">id_tr =</span> id, <span class="at">ps_tr =</span> pscore)</span>
<span id="cb106-1092"><a href="#cb106-1092" aria-hidden="true" tabindex="-1"></a>tusc_ctl <span class="ot">&lt;-</span> ps<span class="sc">$</span>model <span class="sc">%&gt;%</span> <span class="fu">filter</span>(group <span class="sc">==</span> <span class="st">"control"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb106-1093"><a href="#cb106-1093" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="at">id_ctl =</span> id, <span class="at">ps_ctl =</span> pscore)</span>
<span id="cb106-1094"><a href="#cb106-1094" aria-hidden="true" tabindex="-1"></a>tusc_tr <span class="sc">%&gt;%</span> <span class="fu">print</span>(<span class="at">n =</span> <span class="dv">2</span>)</span>
<span id="cb106-1095"><a href="#cb106-1095" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1096"><a href="#cb106-1096" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1097"><a href="#cb106-1097" aria-hidden="true" tabindex="-1"></a>We then need to join the two tables, and **dplyr** provides functions that perform mutating joins. Among them, the `dplyr::left_join` function is appropriate, as it returns all the rows of the "left" table (the treatment group `tusc_tr`) and only those of the "right" table that match. Standard use of mutating joins are based on equality of one or several joining variables, but **dplyr** (since its version 1.1.0) performs also **inequality** and **rolling** joins. With inequality joins, one can for example match a treated observation with all the observations in</span>
<span id="cb106-1098"><a href="#cb106-1098" aria-hidden="true" tabindex="-1"></a>the control group with higher propensity scores. We do it below only for the first two treated observations:</span>
<span id="cb106-1099"><a href="#cb106-1099" aria-hidden="true" tabindex="-1"></a>\idxfun{slice}{dplyr}\idxfun{left<span class="sc">\_</span>join}{dplyr}\idxfun{count}{dplyr}</span>
<span id="cb106-1100"><a href="#cb106-1100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1101"><a href="#cb106-1101" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-1102"><a href="#cb106-1102" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: inequality_join</span></span>
<span id="cb106-1103"><a href="#cb106-1103" aria-hidden="true" tabindex="-1"></a>tusc_tr <span class="sc">%&gt;%</span> <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb106-1104"><a href="#cb106-1104" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(tusc_ctl, <span class="fu">join_by</span>(ps_tr <span class="sc">&lt;=</span> ps_ctl)) <span class="sc">%&gt;%</span></span>
<span id="cb106-1105"><a href="#cb106-1105" aria-hidden="true" tabindex="-1"></a>    <span class="fu">count</span>(id_tr)</span>
<span id="cb106-1106"><a href="#cb106-1106" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1107"><a href="#cb106-1107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1108"><a href="#cb106-1108" aria-hidden="true" tabindex="-1"></a>and they are matched to respectively 309 and 331 observations in the control group. With **rolling** joins, one can</span>
<span id="cb106-1109"><a href="#cb106-1109" aria-hidden="true" tabindex="-1"></a>select only one observation, the closest one, using the <span class="in">`closest`</span> function:</span>
<span id="cb106-1110"><a href="#cb106-1110" aria-hidden="true" tabindex="-1"></a>\idxfun{left<span class="sc">\_</span>join}{dplyr}\idxfun{closest}{dplyr}\idxfun{rename}{dplyr}</span>
<span id="cb106-1111"><a href="#cb106-1111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1112"><a href="#cb106-1112" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-1113"><a href="#cb106-1113" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: rolling_join</span></span>
<span id="cb106-1114"><a href="#cb106-1114" aria-hidden="true" tabindex="-1"></a>match_sup <span class="ot">&lt;-</span> tusc_tr <span class="sc">%&gt;%</span></span>
<span id="cb106-1115"><a href="#cb106-1115" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(tusc_ctl, <span class="fu">join_by</span>(<span class="fu">closest</span>(ps_tr <span class="sc">&lt;=</span> ps_ctl))) <span class="sc">%&gt;%</span></span>
<span id="cb106-1116"><a href="#cb106-1116" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">ps_sup =</span> ps_ctl, <span class="at">id_sup =</span> id_ctl)</span>
<span id="cb106-1117"><a href="#cb106-1117" aria-hidden="true" tabindex="-1"></a>match_sup <span class="sc">%&gt;%</span> <span class="fu">print</span>(<span class="at">n =</span> <span class="dv">3</span>)</span>
<span id="cb106-1118"><a href="#cb106-1118" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1119"><a href="#cb106-1119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1120"><a href="#cb106-1120" aria-hidden="true" tabindex="-1"></a>this time one row is returned for every treated observation, and the</span>
<span id="cb106-1121"><a href="#cb106-1121" aria-hidden="true" tabindex="-1"></a>same control observation can be matched with several treated</span>
<span id="cb106-1122"><a href="#cb106-1122" aria-hidden="true" tabindex="-1"></a>observations. Next, we match with the closest lower propensity score control: </span>
<span id="cb106-1123"><a href="#cb106-1123" aria-hidden="true" tabindex="-1"></a>\idxfun{left<span class="sc">\_</span>join}{dplyr}\idxfun{closest}{dplyr}\idxfun{rename}{dplyr}</span>
<span id="cb106-1124"><a href="#cb106-1124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1125"><a href="#cb106-1125" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-1126"><a href="#cb106-1126" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: rolling_inf</span></span>
<span id="cb106-1127"><a href="#cb106-1127" aria-hidden="true" tabindex="-1"></a>match_inf <span class="ot">&lt;-</span> tusc_tr <span class="sc">%&gt;%</span></span>
<span id="cb106-1128"><a href="#cb106-1128" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(tusc_ctl, <span class="fu">join_by</span>(<span class="fu">closest</span>(ps_tr <span class="sc">&gt;=</span> ps_ctl))) <span class="sc">%&gt;%</span></span>
<span id="cb106-1129"><a href="#cb106-1129" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">ps_inf =</span> ps_ctl, <span class="at">id_inf =</span> id_ctl)</span>
<span id="cb106-1130"><a href="#cb106-1130" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1131"><a href="#cb106-1131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1132"><a href="#cb106-1132" aria-hidden="true" tabindex="-1"></a>We then join the two tables (by the index for treated observations <span class="in">`id_tr`</span>) and select the control observation which is the closest:</span>
<span id="cb106-1133"><a href="#cb106-1133" aria-hidden="true" tabindex="-1"></a>\idxfun{left<span class="sc">\_</span>join}{dplyr}\idxfun{select}{dplyr}\idxfun{mutate}{dplyr}\idxfun{ifelse}{base}</span>
<span id="cb106-1134"><a href="#cb106-1134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1135"><a href="#cb106-1135" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-1136"><a href="#cb106-1136" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: rolling_closest</span></span>
<span id="cb106-1137"><a href="#cb106-1137" aria-hidden="true" tabindex="-1"></a>match_nearest <span class="ot">&lt;-</span> match_sup <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span> ps_tr) <span class="sc">%&gt;%</span></span>
<span id="cb106-1138"><a href="#cb106-1138" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(match_inf, <span class="at">by =</span> <span class="st">"id_tr"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb106-1139"><a href="#cb106-1139" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">ps_sup =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(ps_sup), <span class="dv">2</span>, ps_sup),</span>
<span id="cb106-1140"><a href="#cb106-1140" aria-hidden="true" tabindex="-1"></a>           <span class="at">id_ctl =</span> <span class="fu">ifelse</span>( (ps_tr <span class="sc">-</span> ps_inf) <span class="sc">&lt;</span> (ps_sup <span class="sc">-</span> ps_tr),</span>
<span id="cb106-1141"><a href="#cb106-1141" aria-hidden="true" tabindex="-1"></a>                           id_inf, id_sup),</span>
<span id="cb106-1142"><a href="#cb106-1142" aria-hidden="true" tabindex="-1"></a>           <span class="at">ps_ctl =</span> <span class="fu">ifelse</span>(id_ctl <span class="sc">==</span> id_inf, ps_inf, ps_sup)) <span class="sc">%&gt;%</span> </span>
<span id="cb106-1143"><a href="#cb106-1143" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(id_tr, id_ctl, ps_tr, ps_ctl)</span>
<span id="cb106-1144"><a href="#cb106-1144" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1145"><a href="#cb106-1145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1146"><a href="#cb106-1146" aria-hidden="true" tabindex="-1"></a>For a couple of treated observations, the propensity score</span>
<span id="cb106-1147"><a href="#cb106-1147" aria-hidden="true" tabindex="-1"></a>is greater than the highest propensity score in the control</span>
<span id="cb106-1148"><a href="#cb106-1148" aria-hidden="true" tabindex="-1"></a>group. Therefore, <span class="in">`ps_sup`</span> is <span class="in">`NA`</span>, and we set it to an arbitrary high</span>
<span id="cb106-1149"><a href="#cb106-1149" aria-hidden="true" tabindex="-1"></a>value so that the <span class="in">`id_inf`</span> observation is selected. We can then</span>
<span id="cb106-1150"><a href="#cb106-1150" aria-hidden="true" tabindex="-1"></a>compute the number of observations in the control group that are used:</span>
<span id="cb106-1151"><a href="#cb106-1151" aria-hidden="true" tabindex="-1"></a>\idxfun{pull}{dplyr}\idxfun{unique}{base}\idxfun{length}{base}</span>
<span id="cb106-1152"><a href="#cb106-1152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1153"><a href="#cb106-1153" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-1154"><a href="#cb106-1154" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: true</span></span>
<span id="cb106-1155"><a href="#cb106-1155" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: number_control_obs</span></span>
<span id="cb106-1156"><a href="#cb106-1156" aria-hidden="true" tabindex="-1"></a>match_nearest <span class="sc">%&gt;%</span> <span class="fu">pull</span>(id_ctl) <span class="sc">%&gt;%</span> unique <span class="sc">%&gt;%</span> length</span>
<span id="cb106-1157"><a href="#cb106-1157" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1158"><a href="#cb106-1158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1159"><a href="#cb106-1159" aria-hidden="true" tabindex="-1"></a>and select control observations which are the most often used to match</span>
<span id="cb106-1160"><a href="#cb106-1160" aria-hidden="true" tabindex="-1"></a>treated observations:</span>
<span id="cb106-1161"><a href="#cb106-1161" aria-hidden="true" tabindex="-1"></a>\idxfun{count}{dplyr}\idxfun{top<span class="sc">\_</span>n}{dplyr}</span>
<span id="cb106-1162"><a href="#cb106-1162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1163"><a href="#cb106-1163" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-1164"><a href="#cb106-1164" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: most_used_control</span></span>
<span id="cb106-1165"><a href="#cb106-1165" aria-hidden="true" tabindex="-1"></a>match_nearest <span class="sc">%&gt;%</span> <span class="fu">count</span>(id_ctl) <span class="sc">%&gt;%</span> <span class="fu">top_n</span>(<span class="dv">2</span>, n)</span>
<span id="cb106-1166"><a href="#cb106-1166" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1167"><a href="#cb106-1167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1168"><a href="#cb106-1168" aria-hidden="true" tabindex="-1"></a>For example, observation 4935 in the control group matches 16 observations in the treatment group.</span>
<span id="cb106-1169"><a href="#cb106-1169" aria-hidden="true" tabindex="-1"></a>For some observations, the algorithm may result in a poor</span>
<span id="cb106-1170"><a href="#cb106-1170" aria-hidden="true" tabindex="-1"></a>match for some treated observations if the difference between the</span>
<span id="cb106-1171"><a href="#cb106-1171" aria-hidden="true" tabindex="-1"></a>probability scores of this observation and the matched control</span>
<span id="cb106-1172"><a href="#cb106-1172" aria-hidden="true" tabindex="-1"></a>observation is high.</span>
<span id="cb106-1173"><a href="#cb106-1173" aria-hidden="true" tabindex="-1"></a>\idxfun{mutate}{dplyr}\idxfun{top<span class="sc">\_</span>n}{dplyr}</span>
<span id="cb106-1174"><a href="#cb106-1174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1175"><a href="#cb106-1175" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-1176"><a href="#cb106-1176" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: highest_diff</span></span>
<span id="cb106-1177"><a href="#cb106-1177" aria-hidden="true" tabindex="-1"></a>match_nearest <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">diff =</span> ps_tr <span class="sc">-</span> ps_ctl) <span class="sc">%&gt;%</span> <span class="fu">top_n</span>(<span class="dv">3</span>, diff)</span>
<span id="cb106-1178"><a href="#cb106-1178" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1179"><a href="#cb106-1179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1180"><a href="#cb106-1180" aria-hidden="true" tabindex="-1"></a>In our sample, the highest difference is about $2.6$%.</span>
<span id="cb106-1181"><a href="#cb106-1181" aria-hidden="true" tabindex="-1"></a>The sample can be reduced to observations for which the difference is</span>
<span id="cb106-1182"><a href="#cb106-1182" aria-hidden="true" tabindex="-1"></a>lower than a given value. This is called **caliper matching**. </span>
<span id="cb106-1183"><a href="#cb106-1183" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{caliper matching}\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{matching!caliper}</span>
<span id="cb106-1184"><a href="#cb106-1184" aria-hidden="true" tabindex="-1"></a>For example, to restrict the sample to treated observations for which the</span>
<span id="cb106-1185"><a href="#cb106-1185" aria-hidden="true" tabindex="-1"></a>propensity score difference with its matched control observation is</span>
<span id="cb106-1186"><a href="#cb106-1186" aria-hidden="true" tabindex="-1"></a>lower than 1%, we would use:</span>
<span id="cb106-1187"><a href="#cb106-1187" aria-hidden="true" tabindex="-1"></a>\idxfun{filter}{dplyr}</span>
<span id="cb106-1188"><a href="#cb106-1188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1189"><a href="#cb106-1189" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-1190"><a href="#cb106-1190" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: capiler</span></span>
<span id="cb106-1191"><a href="#cb106-1191" aria-hidden="true" tabindex="-1"></a>mathc_nearest <span class="ot">&lt;-</span> match_nearest <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="fu">abs</span>(ps_tr <span class="sc">-</span> ps_ctl) <span class="sc">&lt;</span> <span class="fl">0.01</span>)</span>
<span id="cb106-1192"><a href="#cb106-1192" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1193"><a href="#cb106-1193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1194"><a href="#cb106-1194" aria-hidden="true" tabindex="-1"></a>We then lose 25 treated observations. To compute the treatment effect, we pivot the tibble in "long" format (one line for each observation) and we join it to <span class="in">`tuscany`</span> to get the response (<span class="in">`perm`</span>) for each observation:</span>
<span id="cb106-1195"><a href="#cb106-1195" aria-hidden="true" tabindex="-1"></a>\idxfun{select}{dplyr}\idxfun{pivot<span class="sc">\_</span>longer}{tidyr}\idxfun{separate}{tidyr}\idxfun{left<span class="sc">\_</span>join}{dplyr}</span>
<span id="cb106-1196"><a href="#cb106-1196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1199"><a href="#cb106-1199" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-1200"><a href="#cb106-1200" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: matched_sample_manual</span></span>
<span id="cb106-1201"><a href="#cb106-1201" aria-hidden="true" tabindex="-1"></a>match_smpl <span class="ot">&lt;-</span> match_nearest <span class="sc">%&gt;%</span> </span>
<span id="cb106-1202"><a href="#cb106-1202" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span> ps_tr, <span class="sc">-</span> ps_ctl) <span class="sc">%&gt;%</span> </span>
<span id="cb106-1203"><a href="#cb106-1203" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb106-1204"><a href="#cb106-1204" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(name, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">".id"</span>, <span class="st">"group"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb106-1205"><a href="#cb106-1205" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="at">id =</span> value, <span class="at">gp =</span> group) <span class="sc">%&gt;%</span> </span>
<span id="cb106-1206"><a href="#cb106-1206" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(<span class="fu">select</span>(tuscany, id, perm), <span class="at">by =</span> <span class="st">"id"</span>)</span>
<span id="cb106-1207"><a href="#cb106-1207" aria-hidden="true" tabindex="-1"></a>match_smpl <span class="sc">%&gt;%</span> <span class="fu">print</span>(<span class="at">n =</span> <span class="dv">2</span>)  </span>
<span id="cb106-1208"><a href="#cb106-1208" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1209"><a href="#cb106-1209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1210"><a href="#cb106-1210" aria-hidden="true" tabindex="-1"></a>The treatment effect is then:</span>
<span id="cb106-1211"><a href="#cb106-1211" aria-hidden="true" tabindex="-1"></a>\idxfun{group<span class="sc">\_</span>by}{dplyr}\idxfun{summarise}{dplyr}</span>
<span id="cb106-1212"><a href="#cb106-1212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1215"><a href="#cb106-1215" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-1216"><a href="#cb106-1216" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: true</span></span>
<span id="cb106-1217"><a href="#cb106-1217" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: atet_matched_sample</span></span>
<span id="cb106-1218"><a href="#cb106-1218" aria-hidden="true" tabindex="-1"></a>means <span class="ot">&lt;-</span> match_smpl <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(gp) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">perm =</span> <span class="fu">mean</span>(perm))</span>
<span id="cb106-1219"><a href="#cb106-1219" aria-hidden="true" tabindex="-1"></a>atet <span class="ot">&lt;-</span> means<span class="sc">$</span>perm[<span class="dv">2</span>] <span class="sc">-</span> means<span class="sc">$</span>perm[<span class="dv">1</span>]</span>
<span id="cb106-1220"><a href="#cb106-1220" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="at">treatment =</span> means<span class="sc">$</span>perm[<span class="dv">2</span>], <span class="at">control =</span> means<span class="sc">$</span>perm[<span class="dv">1</span>], <span class="at">atet =</span> atet)</span>
<span id="cb106-1221"><a href="#cb106-1221" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1222"><a href="#cb106-1222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1223"><a href="#cb106-1223" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{average treatment effect of the treated}</span>
<span id="cb106-1224"><a href="#cb106-1224" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{treatment effect!average treatment effect of the treated}</span>
<span id="cb106-1225"><a href="#cb106-1225" aria-hidden="true" tabindex="-1"></a>The ATET (<span class="in">`r round(atet, 4)`</span>) is close to the one obtained previously using the algorithm based on stratas (<span class="in">`r round(unname(summary(ps)$atet[1]), 4)`</span>).</span>
<span id="cb106-1226"><a href="#cb106-1226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1227"><a href="#cb106-1227" aria-hidden="true" tabindex="-1"></a>Several packages have implemented the matching techniques previously</span>
<span id="cb106-1228"><a href="#cb106-1228" aria-hidden="true" tabindex="-1"></a>described and some more advanced methods. We'll describe here the</span>
<span id="cb106-1229"><a href="#cb106-1229" aria-hidden="true" tabindex="-1"></a>**MatchIt** package. The <span class="in">`MatchIt::matchit`</span> function performs the matching, with a formula-data interface. It has numerous extra arguments, we set here the <span class="in">`replace`</span> argument to <span class="in">`TRUE`</span>, so that one observation in the control group can match several observations in the treatment group.</span>
<span id="cb106-1230"><a href="#cb106-1230" aria-hidden="true" tabindex="-1"></a>\idxfun{update}{stats}\idxfun{matchit}{MatchIt}</span>
<span id="cb106-1231"><a href="#cb106-1231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1232"><a href="#cb106-1232" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-1233"><a href="#cb106-1233" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: matcthit</span></span>
<span id="cb106-1234"><a href="#cb106-1234" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MatchIt)</span>
<span id="cb106-1235"><a href="#cb106-1235" aria-hidden="true" tabindex="-1"></a>ftusc2 <span class="ot">&lt;-</span> <span class="fu">update</span>(ftusc, group <span class="sc">~</span> .)</span>
<span id="cb106-1236"><a href="#cb106-1236" aria-hidden="true" tabindex="-1"></a>mtch <span class="ot">&lt;-</span> <span class="fu">matchit</span>(ftusc2, tuscany, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb106-1237"><a href="#cb106-1237" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1238"><a href="#cb106-1238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1239"><a href="#cb106-1239" aria-hidden="true" tabindex="-1"></a>The <span class="in">`"nearest"`</span> method is used (the default) and the number of matched observations is 427 (as previously),</span>
<span id="cb106-1240"><a href="#cb106-1240" aria-hidden="true" tabindex="-1"></a>the 281 treated observations and 146 observations of the control group. </span>
<span id="cb106-1241"><a href="#cb106-1241" aria-hidden="true" tabindex="-1"></a>A <span class="in">`match.data`</span> function is provided in order to extract the data frame</span>
<span id="cb106-1242"><a href="#cb106-1242" aria-hidden="true" tabindex="-1"></a>restricted to the treated observations and the subset of observations</span>
<span id="cb106-1243"><a href="#cb106-1243" aria-hidden="true" tabindex="-1"></a>of the control group that match. </span>
<span id="cb106-1244"><a href="#cb106-1244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1245"><a href="#cb106-1245" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-1246"><a href="#cb106-1246" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: match_data</span></span>
<span id="cb106-1247"><a href="#cb106-1247" aria-hidden="true" tabindex="-1"></a>mtch <span class="sc">%&gt;%</span> match.data <span class="sc">%&gt;%</span> <span class="fu">print</span>(<span class="at">n =</span> <span class="dv">2</span>)</span>
<span id="cb106-1248"><a href="#cb106-1248" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1249"><a href="#cb106-1249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1250"><a href="#cb106-1250" aria-hidden="true" tabindex="-1"></a>A <span class="in">`weight`</span> column is added to the data frame that contains weights to</span>
<span id="cb106-1251"><a href="#cb106-1251" aria-hidden="true" tabindex="-1"></a>be used in subsequent treatment. There are 427 observations, the 281</span>
<span id="cb106-1252"><a href="#cb106-1252" aria-hidden="true" tabindex="-1"></a>treated observations and 146 observations of the control group. The</span>
<span id="cb106-1253"><a href="#cb106-1253" aria-hidden="true" tabindex="-1"></a>weight for the treated observations is 1. For an observation of the</span>
<span id="cb106-1254"><a href="#cb106-1254" aria-hidden="true" tabindex="-1"></a>control group that matches only one treated observation, the weight is</span>
<span id="cb106-1255"><a href="#cb106-1255" aria-hidden="true" tabindex="-1"></a>$146 / 281 = 0.52$ and, for example, for an observation of the control</span>
<span id="cb106-1256"><a href="#cb106-1256" aria-hidden="true" tabindex="-1"></a>group that matches four treated observations, the weight is :$146 / 281 \times</span>
<span id="cb106-1257"><a href="#cb106-1257" aria-hidden="true" tabindex="-1"></a>4 = 2.08$.</span>
<span id="cb106-1258"><a href="#cb106-1258" aria-hidden="true" tabindex="-1"></a>Caliper matching is performed using the <span class="in">`caliper`</span> argument. The value</span>
<span id="cb106-1259"><a href="#cb106-1259" aria-hidden="true" tabindex="-1"></a>indicated is by default a share of the standard deviation of the</span>
<span id="cb106-1260"><a href="#cb106-1260" aria-hidden="true" tabindex="-1"></a>propensity score, but a value can be indicated in the scale of the</span>
<span id="cb106-1261"><a href="#cb106-1261" aria-hidden="true" tabindex="-1"></a>propensity score if <span class="in">`std.capiler`</span> is set to <span class="in">`FALSE`</span>. Using the same</span>
<span id="cb106-1262"><a href="#cb106-1262" aria-hidden="true" tabindex="-1"></a>value of 1% as previously, we would use:</span>
<span id="cb106-1263"><a href="#cb106-1263" aria-hidden="true" tabindex="-1"></a>\idxfun{matchit}{MatchIt}</span>
<span id="cb106-1264"><a href="#cb106-1264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1265"><a href="#cb106-1265" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-1266"><a href="#cb106-1266" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: matchit_capiler</span></span>
<span id="cb106-1267"><a href="#cb106-1267" aria-hidden="true" tabindex="-1"></a>mtch_cap <span class="ot">&lt;-</span> <span class="fu">matchit</span>(ftusc2, tuscany, <span class="at">replace =</span> <span class="cn">TRUE</span>,</span>
<span id="cb106-1268"><a href="#cb106-1268" aria-hidden="true" tabindex="-1"></a>                    <span class="at">caliper =</span> <span class="fl">0.01</span>, <span class="at">std.caliper =</span> <span class="cn">FALSE</span>)</span>
<span id="cb106-1269"><a href="#cb106-1269" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1270"><a href="#cb106-1270" aria-hidden="true" tabindex="-1"></a>\idxfun{select}{dplyr}\idxfun{pivot<span class="sc">\_</span>longer}{tidyr}\idxfun{left<span class="sc">\_</span>join}{dplyr}</span>
<span id="cb106-1271"><a href="#cb106-1271" aria-hidden="true" tabindex="-1"></a>\idxfun{match.data}{MatchIt}\idxfun{mutate}{dplyr}\idxfun{ifelse}{base}\idxfun{lm}{stats}</span>
<span id="cb106-1272"><a href="#cb106-1272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1273"><a href="#cb106-1273" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-1274"><a href="#cb106-1274" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb106-1275"><a href="#cb106-1275" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb106-1276"><a href="#cb106-1276" aria-hidden="true" tabindex="-1"></a>ids <span class="ot">&lt;-</span> match_nearest <span class="sc">%&gt;%</span> <span class="fu">select</span>(id_tr, id_ctl) <span class="sc">%&gt;%</span> <span class="fu">pivot_longer</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="at">values_to =</span> <span class="st">"id"</span>) <span class="sc">%&gt;%</span> <span class="fu">select</span>(id)</span>
<span id="cb106-1277"><a href="#cb106-1277" aria-hidden="true" tabindex="-1"></a>za <span class="ot">&lt;-</span> ids <span class="sc">%&gt;%</span> <span class="fu">left_join</span>(tuscany, <span class="at">by =</span> <span class="st">"id"</span>)</span>
<span id="cb106-1278"><a href="#cb106-1278" aria-hidden="true" tabindex="-1"></a>mtch.data <span class="ot">&lt;-</span> <span class="fu">match.data</span>(mtch) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">w2 =</span> <span class="fu">ifelse</span>(group <span class="sc">==</span> <span class="st">"treated"</span>, <span class="dv">1</span>, weights <span class="sc">*</span> <span class="dv">281</span> <span class="sc">/</span> <span class="dv">146</span>))</span>
<span id="cb106-1279"><a href="#cb106-1279" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(perm <span class="sc">~</span> age <span class="sc">+</span> sex <span class="sc">+</span> group, za) <span class="sc">%&gt;%</span> summary</span>
<span id="cb106-1280"><a href="#cb106-1280" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(perm <span class="sc">~</span> age <span class="sc">+</span> sex <span class="sc">+</span> group, mtch.data, <span class="at">weights =</span> w2) <span class="sc">%&gt;%</span> summary</span>
<span id="cb106-1281"><a href="#cb106-1281" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1282"><a href="#cb106-1282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1283"><a href="#cb106-1283" aria-hidden="true" tabindex="-1"></a>**MatchIt** proposes more enhanced matching method; we won't describe</span>
<span id="cb106-1284"><a href="#cb106-1284" aria-hidden="true" tabindex="-1"></a>them here. </span>
<span id="cb106-1285"><a href="#cb106-1285" aria-hidden="true" tabindex="-1"></a>Once the matching has been performed, the quality of the balancing</span>
<span id="cb106-1286"><a href="#cb106-1286" aria-hidden="true" tabindex="-1"></a>process can be assessed. The <span class="in">`summary`</span> method prints, for each</span>
<span id="cb106-1287"><a href="#cb106-1287" aria-hidden="true" tabindex="-1"></a>covariates, the mean in both groups and several statistics, especially</span>
<span id="cb106-1288"><a href="#cb106-1288" aria-hidden="true" tabindex="-1"></a>the standardized mean differences, which should be close to 0. The</span>
<span id="cb106-1289"><a href="#cb106-1289" aria-hidden="true" tabindex="-1"></a><span class="in">`plot`</span> method draws a Love plot (see @fig-love); for every covariate, two</span>
<span id="cb106-1290"><a href="#cb106-1290" aria-hidden="true" tabindex="-1"></a>standardized mean differences are plotted, one for the raw data set and</span>
<span id="cb106-1291"><a href="#cb106-1291" aria-hidden="true" tabindex="-1"></a>one for the balanced one.</span>
<span id="cb106-1292"><a href="#cb106-1292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1293"><a href="#cb106-1293" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-1294"><a href="#cb106-1294" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-love</span></span>
<span id="cb106-1295"><a href="#cb106-1295" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Love plot for the `twa` data set"</span></span>
<span id="cb106-1296"><a href="#cb106-1296" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 10</span></span>
<span id="cb106-1297"><a href="#cb106-1297" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 8</span></span>
<span id="cb106-1298"><a href="#cb106-1298" aria-hidden="true" tabindex="-1"></a>mtch <span class="sc">%&gt;%</span> summary <span class="sc">%&gt;%</span> plot</span>
<span id="cb106-1299"><a href="#cb106-1299" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1300"><a href="#cb106-1300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1301"><a href="#cb106-1301" aria-hidden="true" tabindex="-1"></a>We can see the effectiveness of matching, as the mean difference after matching (the black dots) are considerably lower than before matching (the white dots).</span>
<span id="cb106-1302"><a href="#cb106-1302" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">)</span><span class="co">]</span>{twa}{micsr.data}</span>
<span id="cb106-1303"><a href="#cb106-1303" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{matching|(}</span>
<span id="cb106-1304"><a href="#cb106-1304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1305"><a href="#cb106-1305" aria-hidden="true" tabindex="-1"></a><span class="fu">## Synthetic control {#sec-synth_control}</span></span>
<span id="cb106-1306"><a href="#cb106-1306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1307"><a href="#cb106-1307" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{synthetic control|(}</span>
<span id="cb106-1308"><a href="#cb106-1308" aria-hidden="true" tabindex="-1"></a>Consider the case where units are aggregate units, as regions or</span>
<span id="cb106-1309"><a href="#cb106-1309" aria-hidden="true" tabindex="-1"></a>countries and the treatment is an historical event or a policy</span>
<span id="cb106-1310"><a href="#cb106-1310" aria-hidden="true" tabindex="-1"></a>intervention that affects one of them. Comparative case</span>
<span id="cb106-1311"><a href="#cb106-1311" aria-hidden="true" tabindex="-1"></a>studies can then be used to estimate the causal effect of the</span>
<span id="cb106-1312"><a href="#cb106-1312" aria-hidden="true" tabindex="-1"></a>treatment, comparing the situation of the treated unit after the</span>
<span id="cb106-1313"><a href="#cb106-1313" aria-hidden="true" tabindex="-1"></a>treatment to the situation of one or several comparable units which haven't</span>
<span id="cb106-1314"><a href="#cb106-1314" aria-hidden="true" tabindex="-1"></a>been treated. Synthetic control methods, introduced by</span>
<span id="cb106-1315"><a href="#cb106-1315" aria-hidden="true" tabindex="-1"></a>@ABAD:GARD:03\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Abadie}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Gardeazabal}, are refinement of comparative case studies, where</span>
<span id="cb106-1316"><a href="#cb106-1316" aria-hidden="true" tabindex="-1"></a>the comparison untreated unit is a weighted average of some units</span>
<span id="cb106-1317"><a href="#cb106-1317" aria-hidden="true" tabindex="-1"></a>taken from a set of units called the **donor pool**. The example used</span>
<span id="cb106-1318"><a href="#cb106-1318" aria-hidden="true" tabindex="-1"></a>by @ABAD:GARD:03\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Abadie}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Gardeazabal} is the effect of terrorism in the Basque Country: the</span>
<span id="cb106-1319"><a href="#cb106-1319" aria-hidden="true" tabindex="-1"></a>donor pool is the 17 Spanish regions, and the **synthetic control** of</span>
<span id="cb106-1320"><a href="#cb106-1320" aria-hidden="true" tabindex="-1"></a>the Basque Country is a weighted average of two regions, Catalonia (85%)</span>
<span id="cb106-1321"><a href="#cb106-1321" aria-hidden="true" tabindex="-1"></a>and Madrid (15%). The construction of the synthetic control is data-driven; it doesn't rely on any subjective thought of the researcher of</span>
<span id="cb106-1322"><a href="#cb106-1322" aria-hidden="true" tabindex="-1"></a>which Spanish regions look much like the Basque Country before the</span>
<span id="cb106-1323"><a href="#cb106-1323" aria-hidden="true" tabindex="-1"></a>beginning of terrorism. Examples of the application of synthetic</span>
<span id="cb106-1324"><a href="#cb106-1324" aria-hidden="true" tabindex="-1"></a>control methods are the analysis of the effect of:</span>
<span id="cb106-1325"><a href="#cb106-1325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1326"><a href="#cb106-1326" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>state fragmentation <span class="co">[</span><span class="ot">@REYN:VANS:22</span><span class="co">]</span>\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Reynaerts}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Vanschoonbeek},</span>
<span id="cb106-1327"><a href="#cb106-1327" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>the Brexit <span class="co">[</span><span class="ot">@DOUC:EDWA:22</span><span class="co">]</span>\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Douch}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Edwards},</span>
<span id="cb106-1328"><a href="#cb106-1328" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>a tobacco control program in California,</span>
<span id="cb106-1329"><a href="#cb106-1329" aria-hidden="true" tabindex="-1"></a>  <span class="co">[</span><span class="ot">@ABAD:DIAM:HAIN:10</span><span class="co">]</span>\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Abadie}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Diamond}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Hainmueller},</span>
<span id="cb106-1330"><a href="#cb106-1330" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>the reunification of Germany <span class="co">[</span><span class="ot">@ABAD:DIAM:HAIN:15</span><span class="co">]</span>\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Abadie}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Diamond}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Hainmueller},</span>
<span id="cb106-1331"><a href="#cb106-1331" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>mafia in southern Italy <span class="co">[</span><span class="ot">@PINO:15; @BECK:KLOS:17</span><span class="co">]</span></span>
<span id="cb106-1332"><a href="#cb106-1332" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Becker}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Klosner}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Pinotti},</span>
<span id="cb106-1333"><a href="#cb106-1333" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>the Legal Arizona Workers Act <span class="co">[</span><span class="ot">@BOHN:LOFS:RAPH:14</span><span class="co">]</span>\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Bohn}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Lofstrom}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Raphael}.</span>
<span id="cb106-1334"><a href="#cb106-1334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1335"><a href="#cb106-1335" aria-hidden="true" tabindex="-1"></a>Consider a set of $N+1$ units, the first being the treated</span>
<span id="cb106-1336"><a href="#cb106-1336" aria-hidden="true" tabindex="-1"></a>unit. Variables for these units are observed for $T$ periods and the</span>
<span id="cb106-1337"><a href="#cb106-1337" aria-hidden="true" tabindex="-1"></a>treatment that affects unit 1 happened at the end of period</span>
<span id="cb106-1338"><a href="#cb106-1338" aria-hidden="true" tabindex="-1"></a>$T_0$. Therefore, $t = 1, \ldots, T_0$ are pre-treatment periods, and $t =</span>
<span id="cb106-1339"><a href="#cb106-1339" aria-hidden="true" tabindex="-1"></a>T_0+1, \ldots T$ are post-treatment periods. $y$ is the outcome and $x$ is a set of</span>
<span id="cb106-1340"><a href="#cb106-1340" aria-hidden="true" tabindex="-1"></a>covariates (that are supposed to explain the variations of $y$).</span>
<span id="cb106-1341"><a href="#cb106-1341" aria-hidden="true" tabindex="-1"></a>$y_{nt} ^ T$ is the value of the outcome for unit $n$ at period $t$ if</span>
<span id="cb106-1342"><a href="#cb106-1342" aria-hidden="true" tabindex="-1"></a>the unit were treated at this period and $y_{nt} ^ C$ is the value</span>
<span id="cb106-1343"><a href="#cb106-1343" aria-hidden="true" tabindex="-1"></a>without treatment. Of course, as usual in treatment effect analysis,</span>
<span id="cb106-1344"><a href="#cb106-1344" aria-hidden="true" tabindex="-1"></a>for any $n$ and $t$, $y_{nt} ^ T$ and $y_{nt} ^ C$ are never both</span>
<span id="cb106-1345"><a href="#cb106-1345" aria-hidden="true" tabindex="-1"></a>observed. More precisely, $y_{nt} ^ T$ is only observed for $n = 1$</span>
<span id="cb106-1346"><a href="#cb106-1346" aria-hidden="true" tabindex="-1"></a>and $t &gt; T_0$. The effect of the treatment that we seek to estimate is:</span>
<span id="cb106-1347"><a href="#cb106-1347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1348"><a href="#cb106-1348" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-1349"><a href="#cb106-1349" aria-hidden="true" tabindex="-1"></a>y_{1t} ^ T - y_{1t} ^ C \; \forall \; t &gt; T_0</span>
<span id="cb106-1350"><a href="#cb106-1350" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-1351"><a href="#cb106-1351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1352"><a href="#cb106-1352" aria-hidden="true" tabindex="-1"></a>The unknown $y_{1t} ^ C$ is replaced by:</span>
<span id="cb106-1353"><a href="#cb106-1353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1354"><a href="#cb106-1354" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-1355"><a href="#cb106-1355" aria-hidden="true" tabindex="-1"></a>\hat{y}_{1t} ^ C = \sum_{n = 2} ^ {N+1} w_n y_{nt}</span>
<span id="cb106-1356"><a href="#cb106-1356" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-1357"><a href="#cb106-1357" aria-hidden="true" tabindex="-1"></a>\newpage</span>
<span id="cb106-1358"><a href="#cb106-1358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1359"><a href="#cb106-1359" aria-hidden="true" tabindex="-1"></a>where $w_n$ are unknown weights such that $w_n \geq 0$ and $\sum_{n=2} ^ {N+1} w_n= 1$. These weights define the **synthetic</span>
<span id="cb106-1360"><a href="#cb106-1360" aria-hidden="true" tabindex="-1"></a>control** for unit 1. </span>
<span id="cb106-1361"><a href="#cb106-1361" aria-hidden="true" tabindex="-1"></a>The weights have to be chosen so that synthetic control of unit 1 is</span>
<span id="cb106-1362"><a href="#cb106-1362" aria-hidden="true" tabindex="-1"></a>as similar as possible to unit 1 in the pre-treatment period. This</span>
<span id="cb106-1363"><a href="#cb106-1363" aria-hidden="true" tabindex="-1"></a>similarity is evaluated using a set of covariates that are assumed to</span>
<span id="cb106-1364"><a href="#cb106-1364" aria-hidden="true" tabindex="-1"></a>have a causal effect on the outcome. The time dimension is not taken</span>
<span id="cb106-1365"><a href="#cb106-1365" aria-hidden="true" tabindex="-1"></a>into account, so that the value of the covariate for a unit is</span>
<span id="cb106-1366"><a href="#cb106-1366" aria-hidden="true" tabindex="-1"></a>typically the mean or the median of this covariate for the whole</span>
<span id="cb106-1367"><a href="#cb106-1367" aria-hidden="true" tabindex="-1"></a>pre-treatment period or its value for a given period. Note that the</span>
<span id="cb106-1368"><a href="#cb106-1368" aria-hidden="true" tabindex="-1"></a>outcome in the pre-treatment period can be included in the set of</span>
<span id="cb106-1369"><a href="#cb106-1369" aria-hidden="true" tabindex="-1"></a>covariates.</span>
<span id="cb106-1370"><a href="#cb106-1370" aria-hidden="true" tabindex="-1"></a>For each covariate and for a given set of weights, the difference</span>
<span id="cb106-1371"><a href="#cb106-1371" aria-hidden="true" tabindex="-1"></a>between the actual value of $x_{1k}$ and the one of its synthetic</span>
<span id="cb106-1372"><a href="#cb106-1372" aria-hidden="true" tabindex="-1"></a>control is:</span>
<span id="cb106-1373"><a href="#cb106-1373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1374"><a href="#cb106-1374" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-1375"><a href="#cb106-1375" aria-hidden="true" tabindex="-1"></a>x_{1k} - \sum_{n=2} ^ {N+1} w_{n} x_{nk}</span>
<span id="cb106-1376"><a href="#cb106-1376" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-1377"><a href="#cb106-1377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1378"><a href="#cb106-1378" aria-hidden="true" tabindex="-1"></a>and the synthetic control is defined by the set of weights $w_n$ that minimize:</span>
<span id="cb106-1379"><a href="#cb106-1379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1380"><a href="#cb106-1380" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-1381"><a href="#cb106-1381" aria-hidden="true" tabindex="-1"></a>\sum_{k = 1} ^ K v_k \left(x_{1k} - \sum_{n = 2} ^ {N+1} w_n</span>
<span id="cb106-1382"><a href="#cb106-1382" aria-hidden="true" tabindex="-1"></a>x_{nk}\right) ^ 2</span>
<span id="cb106-1383"><a href="#cb106-1383" aria-hidden="true" tabindex="-1"></a>$$ {#eq-seminorm}</span>
<span id="cb106-1384"><a href="#cb106-1384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1385"><a href="#cb106-1385" aria-hidden="true" tabindex="-1"></a>where $v$ is a second set of weights for the covariates. The simplest choice for $v_k$ is $1 / \hat{\sigma}_k ^ 2$, with $\hat{\sigma}_k^2$ the empirical variance of covariate $k$ in the sample, so that @eq-seminorm becomes:</span>
<span id="cb106-1386"><a href="#cb106-1386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1387"><a href="#cb106-1387" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-1388"><a href="#cb106-1388" aria-hidden="true" tabindex="-1"></a>\sum_{k = 1} ^ K \left(x_{1k} / \hat{\sigma}_k - \sum_{n = 2} ^ {N+1} w_n</span>
<span id="cb106-1389"><a href="#cb106-1389" aria-hidden="true" tabindex="-1"></a>x_{nk}/ \hat{\sigma}_k\right) ^ 2</span>
<span id="cb106-1390"><a href="#cb106-1390" aria-hidden="true" tabindex="-1"></a>$$ </span>
<span id="cb106-1391"><a href="#cb106-1391" aria-hidden="true" tabindex="-1"></a>which is the sum of squares of the differences of the standardized covariates values for the treated observation and its synthetic control.</span>
<span id="cb106-1392"><a href="#cb106-1392" aria-hidden="true" tabindex="-1"></a>More generally, for a given value of $v$, we can define $w(v)$ as the</span>
<span id="cb106-1393"><a href="#cb106-1393" aria-hidden="true" tabindex="-1"></a>solution of the minimization of the function given by @eq-seminorm:</span>
<span id="cb106-1394"><a href="#cb106-1394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1395"><a href="#cb106-1395" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-1396"><a href="#cb106-1396" aria-hidden="true" tabindex="-1"></a>\sum_{t = 1} ^ {T_0} \left(y_{1t} - \sum_{n = 2} ^ {N + 1} w_n(v)</span>
<span id="cb106-1397"><a href="#cb106-1397" aria-hidden="true" tabindex="-1"></a>y_{nt}\right) ^ 2</span>
<span id="cb106-1398"><a href="#cb106-1398" aria-hidden="true" tabindex="-1"></a>$$ {#eq-mspe}</span>
<span id="cb106-1399"><a href="#cb106-1399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1400"><a href="#cb106-1400" aria-hidden="true" tabindex="-1"></a>@ABAD:21\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Abadie} discusses in length different choices for covariates' weights $v$.</span>
<span id="cb106-1401"><a href="#cb106-1401" aria-hidden="true" tabindex="-1"></a>The synthetic control method is implemented in **R** in two</span>
<span id="cb106-1402"><a href="#cb106-1402" aria-hidden="true" tabindex="-1"></a>packages: **Synth** [@ABAD:DIAM:HAIN:11]\index[author]{Abadie}\index[author]{Diamond}\index[author]{Hainmueller} and **tidysynth**</span>
<span id="cb106-1403"><a href="#cb106-1403" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">@DUNF:21</span><span class="co">]</span>\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Dunford}. We'll describe the use of the latter as it is written in the tidyverse style. </span>
<span id="cb106-1404"><a href="#cb106-1404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1405"><a href="#cb106-1405" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-1406"><a href="#cb106-1406" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tidysynth</span></span>
<span id="cb106-1407"><a href="#cb106-1407" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidysynth)</span>
<span id="cb106-1408"><a href="#cb106-1408" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1409"><a href="#cb106-1409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1410"><a href="#cb106-1410" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">(</span><span class="co">]</span>{basque<span class="sc">\_</span>country}{micsr.data}</span>
<span id="cb106-1411"><a href="#cb106-1411" aria-hidden="true" tabindex="-1"></a>The data set used is called <span class="in">`basque_country`</span>. It is just the <span class="in">`basque`</span></span>
<span id="cb106-1412"><a href="#cb106-1412" aria-hidden="true" tabindex="-1"></a>data set shipped with the **Synth** package, with a few modifications.</span>
<span id="cb106-1413"><a href="#cb106-1413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1414"><a href="#cb106-1414" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-1415"><a href="#cb106-1415" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: basque_country</span></span>
<span id="cb106-1416"><a href="#cb106-1416" aria-hidden="true" tabindex="-1"></a>basque_country <span class="sc">%&gt;%</span> <span class="fu">print</span>(<span class="at">n =</span> <span class="dv">2</span>)</span>
<span id="cb106-1417"><a href="#cb106-1417" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1418"><a href="#cb106-1418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1419"><a href="#cb106-1419" aria-hidden="true" tabindex="-1"></a>It is a panel for 17 Spanish regions for 43 years (from 1955 to</span>
<span id="cb106-1420"><a href="#cb106-1420" aria-hidden="true" tabindex="-1"></a>1993). The first function to use is <span class="in">`synthetic_control`</span> which defines</span>
<span id="cb106-1421"><a href="#cb106-1421" aria-hidden="true" tabindex="-1"></a>the outcome, the unit and the time variables, the treated unit and the</span>
<span id="cb106-1422"><a href="#cb106-1422" aria-hidden="true" tabindex="-1"></a>treatment period. In this study, the authors investigate the effect of</span>
<span id="cb106-1423"><a href="#cb106-1423" aria-hidden="true" tabindex="-1"></a>terrorism in the Basque Country, which started in 1969, on GDP per</span>
<span id="cb106-1424"><a href="#cb106-1424" aria-hidden="true" tabindex="-1"></a>capita:</span>
<span id="cb106-1425"><a href="#cb106-1425" aria-hidden="true" tabindex="-1"></a>\idxfun{synthetic<span class="sc">\_</span>control}{tidysynth}</span>
<span id="cb106-1426"><a href="#cb106-1426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1427"><a href="#cb106-1427" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-1428"><a href="#cb106-1428" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: synthetic_control</span></span>
<span id="cb106-1429"><a href="#cb106-1429" aria-hidden="true" tabindex="-1"></a>bc <span class="ot">&lt;-</span> basque_country <span class="sc">%&gt;%</span></span>
<span id="cb106-1430"><a href="#cb106-1430" aria-hidden="true" tabindex="-1"></a>    <span class="fu">synthetic_control</span>(<span class="at">outcome =</span> gdpcap,</span>
<span id="cb106-1431"><a href="#cb106-1431" aria-hidden="true" tabindex="-1"></a>                      <span class="at">unit =</span> region,</span>
<span id="cb106-1432"><a href="#cb106-1432" aria-hidden="true" tabindex="-1"></a>                      <span class="at">time =</span> year,</span>
<span id="cb106-1433"><a href="#cb106-1433" aria-hidden="true" tabindex="-1"></a>                      <span class="at">i_unit =</span> <span class="st">"Basque"</span>,</span>
<span id="cb106-1434"><a href="#cb106-1434" aria-hidden="true" tabindex="-1"></a>                      <span class="at">i_time =</span> <span class="dv">1969</span>,</span>
<span id="cb106-1435"><a href="#cb106-1435" aria-hidden="true" tabindex="-1"></a>                      <span class="at">generate_placebo =</span> <span class="cn">TRUE</span>)</span>
<span id="cb106-1436"><a href="#cb106-1436" aria-hidden="true" tabindex="-1"></a>bc</span>
<span id="cb106-1437"><a href="#cb106-1437" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1438"><a href="#cb106-1438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1439"><a href="#cb106-1439" aria-hidden="true" tabindex="-1"></a>We explicitly set the value <span class="in">`generate_placebo`</span> to <span class="in">`TRUE`</span>, even if it is the default value.</span>
<span id="cb106-1440"><a href="#cb106-1440" aria-hidden="true" tabindex="-1"></a>If <span class="in">`generate_placebo`</span> is set to <span class="in">`FALSE`</span>, the result is a tibble which contains</span>
<span id="cb106-1441"><a href="#cb106-1441" aria-hidden="true" tabindex="-1"></a>two lines for the treated unit (Basque Country): the first contains the information for the treated unit, the second contains the information for the donor set, i.e., all the Spanish regions except the Basque Country. </span>
<span id="cb106-1442"><a href="#cb106-1442" aria-hidden="true" tabindex="-1"></a>The <span class="in">`.outcome`</span> column contains the pre-period (15 years) values of the</span>
<span id="cb106-1443"><a href="#cb106-1443" aria-hidden="true" tabindex="-1"></a>outcome for the treated (first line) and the donor set (second line). </span>
<span id="cb106-1444"><a href="#cb106-1444" aria-hidden="true" tabindex="-1"></a>With <span class="in">`generate_placebo = TRUE`</span>, there are $2 \times 16 = 32$ more</span>
<span id="cb106-1445"><a href="#cb106-1445" aria-hidden="true" tabindex="-1"></a>lines, i.e., a couple of lines for every untreated unit. All the</span>
<span id="cb106-1446"><a href="#cb106-1446" aria-hidden="true" tabindex="-1"></a>analysis is in this case performed not only for the treated unit, but</span>
<span id="cb106-1447"><a href="#cb106-1447" aria-hidden="true" tabindex="-1"></a>also for all the units of the donor pool. As we'll see later, this</span>
<span id="cb106-1448"><a href="#cb106-1448" aria-hidden="true" tabindex="-1"></a>placebo analysis enables to perform some inference about the</span>
<span id="cb106-1449"><a href="#cb106-1449" aria-hidden="true" tabindex="-1"></a>efficiency of the treatment for the treated unit.</span>
<span id="cb106-1450"><a href="#cb106-1450" aria-hidden="true" tabindex="-1"></a>Next, we define the covariates, using the <span class="in">`generate_predictor`</span></span>
<span id="cb106-1451"><a href="#cb106-1451" aria-hidden="true" tabindex="-1"></a>function. Its syntax is similar to <span class="in">`mutate`</span> or <span class="in">`summarise`</span>, but the</span>
<span id="cb106-1452"><a href="#cb106-1452" aria-hidden="true" tabindex="-1"></a>second argument of the function is <span class="in">`time_window`</span> which indicates on</span>
<span id="cb106-1453"><a href="#cb106-1453" aria-hidden="true" tabindex="-1"></a>which subperiod the computation has to be made. We compute the mean</span>
<span id="cb106-1454"><a href="#cb106-1454" aria-hidden="true" tabindex="-1"></a>of the shares of education and investment for the 1964-1969 period,</span>
<span id="cb106-1455"><a href="#cb106-1455" aria-hidden="true" tabindex="-1"></a>the population density in 1969, the GDP per capita for the 1960-1969</span>
<span id="cb106-1456"><a href="#cb106-1456" aria-hidden="true" tabindex="-1"></a>period and the sector shares for the 1961-1969 period.</span>
<span id="cb106-1457"><a href="#cb106-1457" aria-hidden="true" tabindex="-1"></a>\idxfun{generate<span class="sc">\_</span>predictor}{tidysynth}</span>
<span id="cb106-1458"><a href="#cb106-1458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1459"><a href="#cb106-1459" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-1460"><a href="#cb106-1460" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: generate_predictor</span></span>
<span id="cb106-1461"><a href="#cb106-1461" aria-hidden="true" tabindex="-1"></a>bc <span class="ot">&lt;-</span> bc <span class="sc">%&gt;%</span></span>
<span id="cb106-1462"><a href="#cb106-1462" aria-hidden="true" tabindex="-1"></a>    <span class="fu">generate_predictor</span>(<span class="at">time_window =</span> <span class="dv">1964</span><span class="sc">:</span><span class="dv">1969</span>,</span>
<span id="cb106-1463"><a href="#cb106-1463" aria-hidden="true" tabindex="-1"></a>                       <span class="at">illit_educ =</span> <span class="fu">mean</span>(illit_educ, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb106-1464"><a href="#cb106-1464" aria-hidden="true" tabindex="-1"></a>                       <span class="at">prim_educ =</span> <span class="fu">mean</span>(prim_educ, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb106-1465"><a href="#cb106-1465" aria-hidden="true" tabindex="-1"></a>                       <span class="at">medium_educ =</span> <span class="fu">mean</span>(medium_educ, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb106-1466"><a href="#cb106-1466" aria-hidden="true" tabindex="-1"></a>                       <span class="at">high_educ =</span> <span class="fu">mean</span>(high_educ, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb106-1467"><a href="#cb106-1467" aria-hidden="true" tabindex="-1"></a>                       <span class="at">invest =</span> <span class="fu">mean</span>(invest, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb106-1468"><a href="#cb106-1468" aria-hidden="true" tabindex="-1"></a>    <span class="fu">generate_predictor</span>(<span class="at">time_window =</span> <span class="dv">1969</span>,</span>
<span id="cb106-1469"><a href="#cb106-1469" aria-hidden="true" tabindex="-1"></a>                       <span class="at">popdens =</span> popdens) <span class="sc">%&gt;%</span></span>
<span id="cb106-1470"><a href="#cb106-1470" aria-hidden="true" tabindex="-1"></a>    <span class="fu">generate_predictor</span>(<span class="at">time_window =</span> <span class="dv">1960</span><span class="sc">:</span><span class="dv">1969</span>,</span>
<span id="cb106-1471"><a href="#cb106-1471" aria-hidden="true" tabindex="-1"></a>                       <span class="at">gdpcap =</span> <span class="fu">mean</span>(gdpcap, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb106-1472"><a href="#cb106-1472" aria-hidden="true" tabindex="-1"></a>    <span class="fu">generate_predictor</span>(<span class="at">time_window =</span> <span class="fu">seq</span>(<span class="dv">1961</span>, <span class="dv">1969</span>, <span class="dv">2</span>),</span>
<span id="cb106-1473"><a href="#cb106-1473" aria-hidden="true" tabindex="-1"></a>                       <span class="at">agriculture =</span> <span class="fu">mean</span>(agriculture, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb106-1474"><a href="#cb106-1474" aria-hidden="true" tabindex="-1"></a>                       <span class="at">energy =</span> <span class="fu">mean</span>(energy, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb106-1475"><a href="#cb106-1475" aria-hidden="true" tabindex="-1"></a>                       <span class="at">industry =</span> <span class="fu">mean</span>(industry, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb106-1476"><a href="#cb106-1476" aria-hidden="true" tabindex="-1"></a>                       <span class="at">construction =</span> <span class="fu">mean</span>(construction, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb106-1477"><a href="#cb106-1477" aria-hidden="true" tabindex="-1"></a>                       <span class="at">services =</span> <span class="fu">mean</span>(services, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb106-1478"><a href="#cb106-1478" aria-hidden="true" tabindex="-1"></a>                       <span class="at">administration =</span> </span>
<span id="cb106-1479"><a href="#cb106-1479" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">mean</span>(administration, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb106-1480"><a href="#cb106-1480" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1481"><a href="#cb106-1481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1482"><a href="#cb106-1482" aria-hidden="true" tabindex="-1"></a>A <span class="in">`.predictors`</span> column is then added to the tibble. For the first</span>
<span id="cb106-1483"><a href="#cb106-1483" aria-hidden="true" tabindex="-1"></a>line, the value is a tibble with 13 lines (the number of covariates)</span>
<span id="cb106-1484"><a href="#cb106-1484" aria-hidden="true" tabindex="-1"></a>and two columns (the name of the variable and the value for the Basque</span>
<span id="cb106-1485"><a href="#cb106-1485" aria-hidden="true" tabindex="-1"></a>Country). For the second line, there are 17 columns (the name of the</span>
<span id="cb106-1486"><a href="#cb106-1486" aria-hidden="true" tabindex="-1"></a>variable and the values for the 16 regions of the donor set).</span>
<span id="cb106-1487"><a href="#cb106-1487" aria-hidden="true" tabindex="-1"></a>Then the weights are computed using the <span class="in">`generate_weights`</span></span>
<span id="cb106-1488"><a href="#cb106-1488" aria-hidden="true" tabindex="-1"></a>function. The second argument of this function is</span>
<span id="cb106-1489"><a href="#cb106-1489" aria-hidden="true" tabindex="-1"></a><span class="in">`optimization_window`</span> which indicates the subset of the pre-treatment</span>
<span id="cb106-1490"><a href="#cb106-1490" aria-hidden="true" tabindex="-1"></a>period which is used to compute the weights:</span>
<span id="cb106-1491"><a href="#cb106-1491" aria-hidden="true" tabindex="-1"></a>\idxfun{generate<span class="sc">\_</span>weights}{tidysynth}</span>
<span id="cb106-1492"><a href="#cb106-1492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1493"><a href="#cb106-1493" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-1494"><a href="#cb106-1494" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: generate_weights</span></span>
<span id="cb106-1495"><a href="#cb106-1495" aria-hidden="true" tabindex="-1"></a>bc <span class="ot">&lt;-</span> bc <span class="sc">%&gt;%</span> <span class="fu">generate_weights</span>(<span class="at">optimization_window =</span> <span class="dv">1960</span><span class="sc">:</span><span class="dv">1969</span>)</span>
<span id="cb106-1496"><a href="#cb106-1496" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1497"><a href="#cb106-1497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1498"><a href="#cb106-1498" aria-hidden="true" tabindex="-1"></a><span class="in">`.unit_weights`</span>, <span class="in">`.predictor_weights`</span> and <span class="in">`.loss`</span> columns are</span>
<span id="cb106-1499"><a href="#cb106-1499" aria-hidden="true" tabindex="-1"></a>added. The first two contain respectively the values of $w$ and $v$;</span>
<span id="cb106-1500"><a href="#cb106-1500" aria-hidden="true" tabindex="-1"></a>the last one contains two mean square prediction errors, one for the</span>
<span id="cb106-1501"><a href="#cb106-1501" aria-hidden="true" tabindex="-1"></a>variable and one for the unit.</span>
<span id="cb106-1502"><a href="#cb106-1502" aria-hidden="true" tabindex="-1"></a>Finally, the synthetic control is computed using the</span>
<span id="cb106-1503"><a href="#cb106-1503" aria-hidden="true" tabindex="-1"></a><span class="in">`generate_control`</span> function:</span>
<span id="cb106-1504"><a href="#cb106-1504" aria-hidden="true" tabindex="-1"></a>\idxfun{generate<span class="sc">\_</span>control}{tidysynth}</span>
<span id="cb106-1505"><a href="#cb106-1505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1506"><a href="#cb106-1506" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-1507"><a href="#cb106-1507" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: generate_control</span></span>
<span id="cb106-1508"><a href="#cb106-1508" aria-hidden="true" tabindex="-1"></a>bc <span class="ot">&lt;-</span> bc <span class="sc">%&gt;%</span> generate_control</span>
<span id="cb106-1509"><a href="#cb106-1509" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1510"><a href="#cb106-1510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1511"><a href="#cb106-1511" aria-hidden="true" tabindex="-1"></a>All the results can conveniently be extracted and plotted using a set of</span>
<span id="cb106-1512"><a href="#cb106-1512" aria-hidden="true" tabindex="-1"></a>functions called <span class="in">`grab_###`</span> and <span class="in">`plot_###`</span>.</span>
<span id="cb106-1513"><a href="#cb106-1513" aria-hidden="true" tabindex="-1"></a><span class="in">`grab_balance_table`</span> computes a balance table for the treated unit,</span>
<span id="cb106-1514"><a href="#cb106-1514" aria-hidden="true" tabindex="-1"></a>its synthetic control and the whole sample for the covariates.</span>
<span id="cb106-1515"><a href="#cb106-1515" aria-hidden="true" tabindex="-1"></a>\idxfun{grab<span class="sc">\_</span>balance<span class="sc">\_</span>table}{tidysynth}</span>
<span id="cb106-1516"><a href="#cb106-1516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1517"><a href="#cb106-1517" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-1518"><a href="#cb106-1518" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: balance_table</span></span>
<span id="cb106-1519"><a href="#cb106-1519" aria-hidden="true" tabindex="-1"></a><span class="fu">grab_balance_table</span>(bc) <span class="sc">%&gt;%</span> <span class="fu">print</span>(<span class="at">n =</span> <span class="cn">Inf</span>)</span>
<span id="cb106-1520"><a href="#cb106-1520" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1521"><a href="#cb106-1521" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1522"><a href="#cb106-1522" aria-hidden="true" tabindex="-1"></a>The value of the covariate for the Basque Country may be very</span>
<span id="cb106-1523"><a href="#cb106-1523" aria-hidden="true" tabindex="-1"></a>different from the mean of the values for the donor pool, but it should</span>
<span id="cb106-1524"><a href="#cb106-1524" aria-hidden="true" tabindex="-1"></a>be close to the one of its synthetic control. It is particularly the</span>
<span id="cb106-1525"><a href="#cb106-1525" aria-hidden="true" tabindex="-1"></a>case here for <span class="in">`agriculture`</span> and <span class="in">`popdens`</span>.</span>
<span id="cb106-1526"><a href="#cb106-1526" aria-hidden="true" tabindex="-1"></a>To get the unit weights and only select those which are not almost</span>
<span id="cb106-1527"><a href="#cb106-1527" aria-hidden="true" tabindex="-1"></a>zero, we can use:</span>
<span id="cb106-1528"><a href="#cb106-1528" aria-hidden="true" tabindex="-1"></a>\idxfun{grab<span class="sc">\_</span>unit<span class="sc">\_</span>weights}{tidysynth}\idxfun{filter}{dplyr}</span>
<span id="cb106-1529"><a href="#cb106-1529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1530"><a href="#cb106-1530" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-1531"><a href="#cb106-1531" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: unit_weights</span></span>
<span id="cb106-1532"><a href="#cb106-1532" aria-hidden="true" tabindex="-1"></a><span class="fu">grab_unit_weights</span>(bc) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(weight <span class="sc">&gt;</span> <span class="fl">1E-05</span>)</span>
<span id="cb106-1533"><a href="#cb106-1533" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1534"><a href="#cb106-1534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1535"><a href="#cb106-1535" aria-hidden="true" tabindex="-1"></a>As stated previously, the synthetic control of the Basque Country</span>
<span id="cb106-1536"><a href="#cb106-1536" aria-hidden="true" tabindex="-1"></a>consists of 85% of Cataluna and 15% of Madrid. It is a common feature</span>
<span id="cb106-1537"><a href="#cb106-1537" aria-hidden="true" tabindex="-1"></a>of this method that a small number of units in the donor pool are</span>
<span id="cb106-1538"><a href="#cb106-1538" aria-hidden="true" tabindex="-1"></a>really used.</span>
<span id="cb106-1539"><a href="#cb106-1539" aria-hidden="true" tabindex="-1"></a>To get the covariates weights:</span>
<span id="cb106-1540"><a href="#cb106-1540" aria-hidden="true" tabindex="-1"></a>\idxfun{grab<span class="sc">\_</span>predictor<span class="sc">\_</span>weights}{tidysynth}\idxfun{arrange}{dplyr}\idxfun{desc}{dplyr}</span>
<span id="cb106-1541"><a href="#cb106-1541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1542"><a href="#cb106-1542" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-1543"><a href="#cb106-1543" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: predictor_weights</span></span>
<span id="cb106-1544"><a href="#cb106-1544" aria-hidden="true" tabindex="-1"></a><span class="fu">grab_predictor_weights</span>(bc) <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(<span class="fu">desc</span>(weight))</span>
<span id="cb106-1545"><a href="#cb106-1545" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1546"><a href="#cb106-1546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1547"><a href="#cb106-1547" aria-hidden="true" tabindex="-1"></a>Population density and pre-treatment average of the GDP par capita are</span>
<span id="cb106-1548"><a href="#cb106-1548" aria-hidden="true" tabindex="-1"></a>the two covariates with the largest weights.</span>
<span id="cb106-1549"><a href="#cb106-1549" aria-hidden="true" tabindex="-1"></a>@fig-weights's plots represent these weights using the <span class="in">`plot_weights`</span></span>
<span id="cb106-1550"><a href="#cb106-1550" aria-hidden="true" tabindex="-1"></a>function.</span>
<span id="cb106-1551"><a href="#cb106-1551" aria-hidden="true" tabindex="-1"></a>\idxfun{plot<span class="sc">\_</span>weights}{tidysynth}</span>
<span id="cb106-1552"><a href="#cb106-1552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1555"><a href="#cb106-1555" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-1556"><a href="#cb106-1556" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb106-1557"><a href="#cb106-1557" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_weights</span>(bc)</span>
<span id="cb106-1558"><a href="#cb106-1558" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1559"><a href="#cb106-1559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1560"><a href="#cb106-1560" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-1561"><a href="#cb106-1561" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-weights</span></span>
<span id="cb106-1562"><a href="#cb106-1562" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Weights for the units and the predictors"</span></span>
<span id="cb106-1563"><a href="#cb106-1563" aria-hidden="true" tabindex="-1"></a><span class="co">#| out-width: 100%</span></span>
<span id="cb106-1564"><a href="#cb106-1564" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 14</span></span>
<span id="cb106-1565"><a href="#cb106-1565" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb106-1566"><a href="#cb106-1566" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_weights</span>(bc) <span class="sc">+</span> <span class="fu">theme_get</span>() <span class="sc">+</span> </span>
<span id="cb106-1567"><a href="#cb106-1567" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">rep</span>(<span class="st">"lightgrey"</span>, <span class="dv">2</span>)) <span class="sc">+</span> </span>
<span id="cb106-1568"><a href="#cb106-1568" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">rep</span>(<span class="st">"black"</span>, <span class="dv">2</span>))</span>
<span id="cb106-1569"><a href="#cb106-1569" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1570"><a href="#cb106-1570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1571"><a href="#cb106-1571" aria-hidden="true" tabindex="-1"></a>The real series of GDP per capita for the Basque Country and its</span>
<span id="cb106-1572"><a href="#cb106-1572" aria-hidden="true" tabindex="-1"></a>synthetic control are obtained using the <span class="in">`grab_synthetic_control`</span></span>
<span id="cb106-1573"><a href="#cb106-1573" aria-hidden="true" tabindex="-1"></a>function. @fig-trends presents the two series and is obtained using</span>
<span id="cb106-1574"><a href="#cb106-1574" aria-hidden="true" tabindex="-1"></a>the <span class="in">`plot_trends`</span> function.^[Note the use of <span class="in">`labs`</span>; **tidysynth** uses</span>
<span id="cb106-1575"><a href="#cb106-1575" aria-hidden="true" tabindex="-1"></a>**ggplot** so that the plots can be customized with any function of</span>
<span id="cb106-1576"><a href="#cb106-1576" aria-hidden="true" tabindex="-1"></a>the **ggplot2** package.]</span>
<span id="cb106-1577"><a href="#cb106-1577" aria-hidden="true" tabindex="-1"></a>\idxfun{plot<span class="sc">\_</span>trends}{tidysynth}\idxfun{labs}{ggplot2}</span>
<span id="cb106-1578"><a href="#cb106-1578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1581"><a href="#cb106-1581" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-1582"><a href="#cb106-1582" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb106-1583"><a href="#cb106-1583" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_trends</span>(bc) <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">title =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">"GDP per capita"</span>)</span>
<span id="cb106-1584"><a href="#cb106-1584" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1585"><a href="#cb106-1585" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1586"><a href="#cb106-1586" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1587"><a href="#cb106-1587" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-1588"><a href="#cb106-1588" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-trends</span></span>
<span id="cb106-1589"><a href="#cb106-1589" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "GDP per capita for the Basque Country and its synthetic control"</span></span>
<span id="cb106-1590"><a href="#cb106-1590" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb106-1591"><a href="#cb106-1591" aria-hidden="true" tabindex="-1"></a><span class="fu">grab_synthetic_control</span>(bc)</span>
<span id="cb106-1592"><a href="#cb106-1592" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_trends</span>(bc) <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">title =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">"GDP per capita"</span>) <span class="sc">+</span>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"black"</span>, <span class="st">"grey"</span>)) <span class="sc">+</span>  </span>
<span id="cb106-1593"><a href="#cb106-1593" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">4</span>)) <span class="sc">+</span> <span class="fu">theme_get</span>()</span>
<span id="cb106-1594"><a href="#cb106-1594" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1595"><a href="#cb106-1595" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1596"><a href="#cb106-1596" aria-hidden="true" tabindex="-1"></a>Instead of plotting the GDP per capita for the real and the synthetic</span>
<span id="cb106-1597"><a href="#cb106-1597" aria-hidden="true" tabindex="-1"></a>Basque Country, one can also plot the difference between both</span>
<span id="cb106-1598"><a href="#cb106-1598" aria-hidden="true" tabindex="-1"></a>series (see @fig-diff). The difference should be small and erratic before the treatment, and large and negative after the treatment. </span>
<span id="cb106-1599"><a href="#cb106-1599" aria-hidden="true" tabindex="-1"></a>\idxfun{plot<span class="sc">\_</span>differences}{tidysynth}</span>
<span id="cb106-1600"><a href="#cb106-1600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1603"><a href="#cb106-1603" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-1604"><a href="#cb106-1604" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb106-1605"><a href="#cb106-1605" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_differences</span>(bc) <span class="sc">+</span> <span class="fu">theme_get</span>()</span>
<span id="cb106-1606"><a href="#cb106-1606" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1607"><a href="#cb106-1607" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1608"><a href="#cb106-1608" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-1609"><a href="#cb106-1609" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-diff</span></span>
<span id="cb106-1610"><a href="#cb106-1610" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Difference of GDP per capita for the Basque Country and its synthetic control"</span></span>
<span id="cb106-1611"><a href="#cb106-1611" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb106-1612"><a href="#cb106-1612" aria-hidden="true" tabindex="-1"></a>bc <span class="sc">%&gt;%</span> <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb106-1613"><a href="#cb106-1613" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(.synthetic_control) <span class="sc">%&gt;%</span> </span>
<span id="cb106-1614"><a href="#cb106-1614" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(<span class="at">cols =</span> .synthetic_control) <span class="sc">%&gt;%</span> </span>
<span id="cb106-1615"><a href="#cb106-1615" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">diff =</span> real_y <span class="sc">-</span> synth_y) <span class="sc">%&gt;%</span> </span>
<span id="cb106-1616"><a href="#cb106-1616" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(time_unit, diff)) <span class="sc">+</span> </span>
<span id="cb106-1617"><a href="#cb106-1617" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb106-1618"><a href="#cb106-1618" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span> </span>
<span id="cb106-1619"><a href="#cb106-1619" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"gdpcap"</span>, <span class="at">x =</span> <span class="st">"year"</span>)</span>
<span id="cb106-1620"><a href="#cb106-1620" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1621"><a href="#cb106-1621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1622"><a href="#cb106-1622" aria-hidden="true" tabindex="-1"></a>The quality of the fit can be evaluated using <span class="in">`grab_loss`</span>:</span>
<span id="cb106-1623"><a href="#cb106-1623" aria-hidden="true" tabindex="-1"></a>\idxfun{grab<span class="sc">\_</span>loss}{tidysynth}</span>
<span id="cb106-1624"><a href="#cb106-1624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1625"><a href="#cb106-1625" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-1626"><a href="#cb106-1626" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: grab_loss</span></span>
<span id="cb106-1627"><a href="#cb106-1627" aria-hidden="true" tabindex="-1"></a>bc <span class="sc">%&gt;%</span> grab_loss</span>
<span id="cb106-1628"><a href="#cb106-1628" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1629"><a href="#cb106-1629" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1630"><a href="#cb106-1630" aria-hidden="true" tabindex="-1"></a>The column <span class="in">`variable_mspe`</span> indicates the value of @eq-seminorm and</span>
<span id="cb106-1631"><a href="#cb106-1631" aria-hidden="true" tabindex="-1"></a><span class="in">`control_unit_mspe`</span> the value of @eq-mspe.</span>
<span id="cb106-1632"><a href="#cb106-1632" aria-hidden="true" tabindex="-1"></a>The efficiency of the treatment and the ability of the method to</span>
<span id="cb106-1633"><a href="#cb106-1633" aria-hidden="true" tabindex="-1"></a>estimate it can be assessed by computing the mean square prediction</span>
<span id="cb106-1634"><a href="#cb106-1634" aria-hidden="true" tabindex="-1"></a>error for the outcome before and after the treatment:</span>
<span id="cb106-1635"><a href="#cb106-1635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1636"><a href="#cb106-1636" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-1637"><a href="#cb106-1637" aria-hidden="true" tabindex="-1"></a>m_n^{\mbox{pre}} = \frac{\sum_{t = 1} ^ {T_0} (y_{nt} - \hat{y}_{nt}) ^</span>
<span id="cb106-1638"><a href="#cb106-1638" aria-hidden="true" tabindex="-1"></a>2}{T_0} \mbox{ and }</span>
<span id="cb106-1639"><a href="#cb106-1639" aria-hidden="true" tabindex="-1"></a>m_n^{\mbox{post}} = \frac{\sum_{t = T_0 + 1} ^ T (y_{nt} - \hat{y}_{nt}) ^ 2}{T - T_0}</span>
<span id="cb106-1640"><a href="#cb106-1640" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb106-1641"><a href="#cb106-1641" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1642"><a href="#cb106-1642" aria-hidden="true" tabindex="-1"></a>The synthetic control should be very close to the treated unit before</span>
<span id="cb106-1643"><a href="#cb106-1643" aria-hidden="true" tabindex="-1"></a>the treatment, so that $m_n^{\mbox{\tiny{pre}}}$ should be low. On the</span>
<span id="cb106-1644"><a href="#cb106-1644" aria-hidden="true" tabindex="-1"></a>contrary, if the treatment is efficient, the treated unit and its</span>
<span id="cb106-1645"><a href="#cb106-1645" aria-hidden="true" tabindex="-1"></a>synthetic control should be very different after the treatment, so</span>
<span id="cb106-1646"><a href="#cb106-1646" aria-hidden="true" tabindex="-1"></a>that $m_n^{\mbox{\tiny{post}}}$ should be high. Therefore, the ratio $r_n =</span>
<span id="cb106-1647"><a href="#cb106-1647" aria-hidden="true" tabindex="-1"></a>m_n^{\mbox{\tiny{post}}} / m_n^{\mbox{\tiny{pre}}}$ should be high if the treatment</span>
<span id="cb106-1648"><a href="#cb106-1648" aria-hidden="true" tabindex="-1"></a>is efficient and if the synthetic control method is relevant. Moreover, it</span>
<span id="cb106-1649"><a href="#cb106-1649" aria-hidden="true" tabindex="-1"></a>should be much higher than the ones obtained for untreated units. The</span>
<span id="cb106-1650"><a href="#cb106-1650" aria-hidden="true" tabindex="-1"></a>significance of the treatment can be established using the</span>
<span id="cb106-1651"><a href="#cb106-1651" aria-hidden="true" tabindex="-1"></a>distribution of $r$ for all the units (the treated one and the</span>
<span id="cb106-1652"><a href="#cb106-1652" aria-hidden="true" tabindex="-1"></a>untreated ones). Denoting $\bar{r}$ and $\hat{\sigma}_r$, as the mean and</span>
<span id="cb106-1653"><a href="#cb106-1653" aria-hidden="true" tabindex="-1"></a>the standard deviation of $r$, we can define $z_n = (r_n - \bar{r}) /</span>
<span id="cb106-1654"><a href="#cb106-1654" aria-hidden="true" tabindex="-1"></a>\hat{\sigma}_r$ which is asymptotically distributed as a standard</span>
<span id="cb106-1655"><a href="#cb106-1655" aria-hidden="true" tabindex="-1"></a>normal deviate.</span>
<span id="cb106-1656"><a href="#cb106-1656" aria-hidden="true" tabindex="-1"></a>These indicators can be retrieved using the <span class="in">`grab_significance`</span></span>
<span id="cb106-1657"><a href="#cb106-1657" aria-hidden="true" tabindex="-1"></a>function:</span>
<span id="cb106-1658"><a href="#cb106-1658" aria-hidden="true" tabindex="-1"></a>\idxfun{grab<span class="sc">\_</span>significance}{tidysynth}</span>
<span id="cb106-1659"><a href="#cb106-1659" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1660"><a href="#cb106-1660" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-1661"><a href="#cb106-1661" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: grab_significance</span></span>
<span id="cb106-1662"><a href="#cb106-1662" aria-hidden="true" tabindex="-1"></a>bc <span class="sc">%&gt;%</span> grab_significance</span>
<span id="cb106-1663"><a href="#cb106-1663" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1664"><a href="#cb106-1664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1665"><a href="#cb106-1665" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-1666"><a href="#cb106-1666" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb106-1667"><a href="#cb106-1667" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: significance_hiden</span></span>
<span id="cb106-1668"><a href="#cb106-1668" aria-hidden="true" tabindex="-1"></a>v <span class="ot">&lt;-</span> <span class="fu">grab_significance</span>(bc)</span>
<span id="cb106-1669"><a href="#cb106-1669" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">mean</span>(v<span class="sc">$</span>mspe_ratio)</span>
<span id="cb106-1670"><a href="#cb106-1670" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">sd</span>(v<span class="sc">$</span>mspe_ratio)</span>
<span id="cb106-1671"><a href="#cb106-1671" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1672"><a href="#cb106-1672" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1673"><a href="#cb106-1673" aria-hidden="true" tabindex="-1"></a>The highest ratio is actually the one for the treated unit, i.e., the Basque</span>
<span id="cb106-1674"><a href="#cb106-1674" aria-hidden="true" tabindex="-1"></a>Country. The mean and the standard deviations of this ratio are</span>
<span id="cb106-1675"><a href="#cb106-1675" aria-hidden="true" tabindex="-1"></a>respectively <span class="in">`r round(m, 2)`</span> and <span class="in">`r round(s, 2)`</span>. The $z$ value for</span>
<span id="cb106-1676"><a href="#cb106-1676" aria-hidden="true" tabindex="-1"></a>the Basque Country is 2.97, much higher than the critical value for a</span>
<span id="cb106-1677"><a href="#cb106-1677" aria-hidden="true" tabindex="-1"></a>normal at the 1% level. The second highest value is for Asturias, with</span>
<span id="cb106-1678"><a href="#cb106-1678" aria-hidden="true" tabindex="-1"></a>a $z$ value of 1.81 lower than the critical value at the 5% level.</span>
<span id="cb106-1679"><a href="#cb106-1679" aria-hidden="true" tabindex="-1"></a>The MSPE ratios are represented in @fig-msperatio, using the</span>
<span id="cb106-1680"><a href="#cb106-1680" aria-hidden="true" tabindex="-1"></a><span class="in">`plot_mspe_ratio`</span> function:</span>
<span id="cb106-1681"><a href="#cb106-1681" aria-hidden="true" tabindex="-1"></a>\idxfun{plot<span class="sc">\_</span>mspe<span class="sc">\_</span>ratio}{tidysynth}\idxfun{labs}{ggplot2}</span>
<span id="cb106-1682"><a href="#cb106-1682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1685"><a href="#cb106-1685" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-1686"><a href="#cb106-1686" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb106-1687"><a href="#cb106-1687" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_mspe_ratio</span>(bc) <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">title =</span> <span class="cn">NULL</span>)</span>
<span id="cb106-1688"><a href="#cb106-1688" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1689"><a href="#cb106-1689" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1690"><a href="#cb106-1690" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1691"><a href="#cb106-1691" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-1692"><a href="#cb106-1692" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-msperatio</span></span>
<span id="cb106-1693"><a href="#cb106-1693" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Plot of the MSPE ratio"</span></span>
<span id="cb106-1694"><a href="#cb106-1694" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb106-1695"><a href="#cb106-1695" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_mspe_ratio</span>(bc) <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">title =</span> <span class="cn">NULL</span>) <span class="sc">+</span> <span class="fu">theme_get</span>() <span class="sc">+</span> </span>
<span id="cb106-1696"><a href="#cb106-1696" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"grey"</span>, <span class="st">"black"</span>))</span>
<span id="cb106-1697"><a href="#cb106-1697" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1698"><a href="#cb106-1698" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1699"><a href="#cb106-1699" aria-hidden="true" tabindex="-1"></a>Finally, a popular graphic in synthetic control analysis consists of</span>
<span id="cb106-1700"><a href="#cb106-1700" aria-hidden="true" tabindex="-1"></a>plotting the difference between the real series of any unit and its</span>
<span id="cb106-1701"><a href="#cb106-1701" aria-hidden="true" tabindex="-1"></a>synthetic control. The difference should be sharp for the post-treatment period for the treated unit and small for the other units which are not treated. This so-called placebos plot is obtained using</span>
<span id="cb106-1702"><a href="#cb106-1702" aria-hidden="true" tabindex="-1"></a>the <span class="in">`plot_placebos`</span> function and is presented in @fig-placebos</span>
<span id="cb106-1703"><a href="#cb106-1703" aria-hidden="true" tabindex="-1"></a>\idxfun{plot<span class="sc">\_</span>placebos}{tidysynth}</span>
<span id="cb106-1704"><a href="#cb106-1704" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1707"><a href="#cb106-1707" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb106-1708"><a href="#cb106-1708" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb106-1709"><a href="#cb106-1709" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_placebos</span>(bc)</span>
<span id="cb106-1710"><a href="#cb106-1710" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1711"><a href="#cb106-1711" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1712"><a href="#cb106-1712" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-1713"><a href="#cb106-1713" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-placebos</span></span>
<span id="cb106-1714"><a href="#cb106-1714" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Placebos plot"</span></span>
<span id="cb106-1715"><a href="#cb106-1715" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb106-1716"><a href="#cb106-1716" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_placebos</span>(bc) <span class="sc">+</span> <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"black"</span>, <span class="st">"grey"</span>)) <span class="sc">+</span> </span>
<span id="cb106-1717"><a href="#cb106-1717" aria-hidden="true" tabindex="-1"></a>   <span class="fu">theme_get</span>()</span>
<span id="cb106-1718"><a href="#cb106-1718" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1719"><a href="#cb106-1719" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1720"><a href="#cb106-1720" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb106-1721"><a href="#cb106-1721" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tidysynth_hidden</span></span>
<span id="cb106-1722"><a href="#cb106-1722" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb106-1723"><a href="#cb106-1723" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb106-1724"><a href="#cb106-1724" aria-hidden="true" tabindex="-1"></a>w <span class="ot">&lt;-</span> <span class="fu">grab_unit_weights</span>(bc) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(<span class="dv">2</span>)</span>
<span id="cb106-1725"><a href="#cb106-1725" aria-hidden="true" tabindex="-1"></a>v <span class="ot">&lt;-</span> <span class="fu">grab_predictor_weights</span>(bc)<span class="er">)</span> <span class="sc">%&gt;%</span> <span class="fu">pull</span>(<span class="dv">2</span>)</span>
<span id="cb106-1726"><a href="#cb106-1726" aria-hidden="true" tabindex="-1"></a>x1 <span class="ot">&lt;-</span> bc[<span class="dv">1</span>, ][[<span class="st">".predictors"</span>]][[<span class="dv">1</span>]] <span class="sc">%&gt;%</span> <span class="fu">pull</span>(<span class="dv">2</span>)</span>
<span id="cb106-1727"><a href="#cb106-1727" aria-hidden="true" tabindex="-1"></a>x0 <span class="ot">&lt;-</span> bc[<span class="dv">2</span>, ][[<span class="st">".predictors"</span>]][[<span class="dv">1</span>]] <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span><span class="dv">1</span>) <span class="sc">%&gt;%</span> as.matrix</span>
<span id="cb106-1728"><a href="#cb106-1728" aria-hidden="true" tabindex="-1"></a>divisor <span class="ot">&lt;-</span> <span class="fu">apply</span>(<span class="fu">cbind</span>(x1, x0), <span class="dv">1</span>, sd)</span>
<span id="cb106-1729"><a href="#cb106-1729" aria-hidden="true" tabindex="-1"></a><span class="co">#x1 &lt;- x1 / divisor</span></span>
<span id="cb106-1730"><a href="#cb106-1730" aria-hidden="true" tabindex="-1"></a><span class="co">#x0 &lt;- x0 / divisor</span></span>
<span id="cb106-1731"><a href="#cb106-1731" aria-hidden="true" tabindex="-1"></a>x1p <span class="ot">&lt;-</span> <span class="fu">drop</span>(x0 <span class="sc">%*%</span> w)</span>
<span id="cb106-1732"><a href="#cb106-1732" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(v <span class="sc">*</span> ((x1 <span class="sc">-</span> x1p) <span class="sc">/</span> divisor) <span class="sc">^</span> <span class="dv">2</span>)</span>
<span id="cb106-1733"><a href="#cb106-1733" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1734"><a href="#cb106-1734" aria-hidden="true" tabindex="-1"></a>y1 <span class="ot">&lt;-</span> bc[<span class="dv">1</span>, ][[<span class="st">".outcome"</span>]][[<span class="dv">1</span>]] <span class="sc">%&gt;%</span> <span class="fu">pull</span>(<span class="dv">2</span>)</span>
<span id="cb106-1735"><a href="#cb106-1735" aria-hidden="true" tabindex="-1"></a>y0 <span class="ot">&lt;-</span> bc[<span class="dv">2</span>, ][[<span class="st">".outcome"</span>]][[<span class="dv">1</span>]] <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> as.matrix</span>
<span id="cb106-1736"><a href="#cb106-1736" aria-hidden="true" tabindex="-1"></a>y1 <span class="ot">&lt;-</span> y1[<span class="dv">6</span><span class="sc">:</span><span class="dv">15</span>]</span>
<span id="cb106-1737"><a href="#cb106-1737" aria-hidden="true" tabindex="-1"></a>y0 <span class="ot">&lt;-</span> y0[<span class="dv">6</span><span class="sc">:</span><span class="dv">15</span>, ]</span>
<span id="cb106-1738"><a href="#cb106-1738" aria-hidden="true" tabindex="-1"></a>y1p <span class="ot">&lt;-</span> <span class="fu">drop</span>(y0 <span class="sc">%*%</span> w)</span>
<span id="cb106-1739"><a href="#cb106-1739" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>( (y1 <span class="sc">-</span> y1p) <span class="sc">^</span> <span class="dv">2</span>)</span>
<span id="cb106-1740"><a href="#cb106-1740" aria-hidden="true" tabindex="-1"></a><span class="co">#tibble(year = 1955:1969, y1, y1p) %&gt;% pivot_longer(- year) %&gt;% ggplot(aes(year, value)) + geom_line(aes(linetype = name))</span></span>
<span id="cb106-1741"><a href="#cb106-1741" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb106-1742"><a href="#cb106-1742" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-1743"><a href="#cb106-1743" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{synthetic control|)}</span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



</body></html>