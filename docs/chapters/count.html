<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.475">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Microeconometrics with R - 12&nbsp; Count data</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../chapters/duration.html" rel="next">
<link href="../chapters/tobit.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script><script src="../site_libs/kePrint/kePrint.js"></script><link href="../site_libs/lightable/lightable.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }"><div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Count data</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Microeconometrics with R</a> 
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">Preface</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../OLS.html" class="sidebar-item-text sidebar-link">Ordinary least squares estimator</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/simple_regression.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Simple linear regression model</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/simple_regression_properties.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Statistical properties of the simple linear estimator</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/multiple_regression.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Multiple regression model</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/coefficients.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Interpretation of the Coefficients</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../beyond_OLS.html" class="sidebar-item-text sidebar-link">Beyond the OLS estimator</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/maximum_likelihood.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Maximum likelihood estimator</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/non_spherical.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Non-spherical disturbances</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/endogeneity.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Endogeneity</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/treateff.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Treatment effect</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/spatial.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Spatial econometrics</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../special_responses.html" class="sidebar-item-text sidebar-link">Special responses</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/binomial.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Binomial models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/tobit.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Censored and truncated models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/count.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Count data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/duration.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Duration models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/rum.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Discrete choice models</span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../references.html" class="sidebar-item-text sidebar-link">References</a>
  </div>
</li>
    </ul>
</div>
</nav><!-- margin-sidebar --><div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li>
<a href="#sec-features_count" id="toc-sec-features_count" class="nav-link active" data-scroll-target="#sec-features_count"><span class="toc-section-number">12.1</span>  Features of count data</a>
  <ul class="collapse">
<li><a href="#an-empirical-survey" id="toc-an-empirical-survey" class="nav-link" data-scroll-target="#an-empirical-survey">An empirical survey</a></li>
  <li><a href="#analyzing-the-number-of-trips" id="toc-analyzing-the-number-of-trips" class="nav-link" data-scroll-target="#analyzing-the-number-of-trips">Analyzing the number of trips</a></li>
  </ul>
</li>
  <li>
<a href="#sec-poisson_model" id="toc-sec-poisson_model" class="nav-link" data-scroll-target="#sec-poisson_model"><span class="toc-section-number">12.2</span>  Poisson model</a>
  <ul class="collapse">
<li><a href="#derivation-of-the-poisson-model" id="toc-derivation-of-the-poisson-model" class="nav-link" data-scroll-target="#derivation-of-the-poisson-model">Derivation of the Poisson model</a></li>
  <li><a href="#interpretation-of-the-coefficients" id="toc-interpretation-of-the-coefficients" class="nav-link" data-scroll-target="#interpretation-of-the-coefficients">Interpretation of the coefficients</a></li>
  <li><a href="#computation-of-the-variance-of-the-estimator" id="toc-computation-of-the-variance-of-the-estimator" class="nav-link" data-scroll-target="#computation-of-the-variance-of-the-estimator">Computation of the variance of the estimator</a></li>
  <li><a href="#overdispersion" id="toc-overdispersion" class="nav-link" data-scroll-target="#overdispersion">Overdispersion</a></li>
  </ul>
</li>
  <li>
<a href="#sec-overdisp_zero" id="toc-sec-overdisp_zero" class="nav-link" data-scroll-target="#sec-overdisp_zero"><span class="toc-section-number">12.3</span>  Overdispersion and excess of zero</a>
  <ul class="collapse">
<li><a href="#mixing-model" id="toc-mixing-model" class="nav-link" data-scroll-target="#mixing-model">Mixing model</a></li>
  <li><a href="#hurdle-and-zip-models" id="toc-hurdle-and-zip-models" class="nav-link" data-scroll-target="#hurdle-and-zip-models">Hurdle and ZIP models</a></li>
  </ul>
</li>
  <li>
<a href="#sec-endog_count" id="toc-sec-endog_count" class="nav-link" data-scroll-target="#sec-endog_count"><span class="toc-section-number">12.4</span>  Endogeneity and selection</a>
  <ul class="collapse">
<li><a href="#instrumental-variable-estimators-for-count-data" id="toc-instrumental-variable-estimators-for-count-data" class="nav-link" data-scroll-target="#instrumental-variable-estimators-for-count-data">Instrumental variable estimators for count data</a></li>
  <li><a href="#sample-selection-and-endogenous-switching-for-count-data" id="toc-sample-selection-and-endogenous-switching-for-count-data" class="nav-link" data-scroll-target="#sample-selection-and-endogenous-switching-for-count-data">Sample selection and endogenous switching for count data</a></li>
  </ul>
</li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span id="sec-count" class="quarto-section-identifier d-none d-lg-block"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Count data</span></span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header><p>It is often the case in economics that the response is a count, i.e., a non-negative integer. In this case, fitting a linear model has a number of drawbacks:</p>
<ul>
<li>the integer nature of the response is not taken into account,</li>
<li>the fitted model can predict negative values for some values of the covariates,</li>
<li>if the distribution of the response is asymmetric, the logarithm transformation can’t be used in the common case where the response is 0 for a subset of observations.</li>
</ul>
<p>There is therefore the need for specific models that will be presented in this chapter. In <a href="#sec-features_count"><span>Section&nbsp;12.1</span></a>, we’ll illustrate the features of count data, using a survey of empirical studies. <a href="#sec-poisson_model"><span>Section&nbsp;12.2</span></a> is devoted to the benchmark count model, the Poisson model. <a href="#sec-overdisp_zero"><span>Section&nbsp;12.3</span></a> discusses two common features of count data: overdispersion and excess of zero. Finally <a href="#sec-endog_count"><span>Section&nbsp;12.4</span></a> deals with the endogeneity problem with a count response.</p>
<section id="sec-features_count" class="level2" data-number="12.1"><h2 data-number="12.1" class="anchored" data-anchor-id="sec-features_count">
<span class="header-section-number">12.1</span> Features of count data</h2>
<section id="an-empirical-survey" class="level3"><h3 class="anchored" data-anchor-id="an-empirical-survey">An empirical survey</h3>
<p>We start with the presentation of some data sets for which the response is a count. All these data are available in the <strong>micsr.count</strong> package and are summarized in <span class="quarto-unresolved-ref">?tbl-empsurvey</span>.</p>
<div class="cell" data-layout-align="center" data-hash="count_cache/html/tbl-empsurvey_2660270946c66fc8be801814f5e122ce">
<div class="cell-output-display">

</div>
</div>
<p>About half of these data sets concern demand for health care. <code>doctor_aus</code> <span class="citation" data-cites="CAME:TRIV:86">(<a href="#ref-CAME:TRIV:86" role="doc-biblioref">Cameron and Trivedi 1986</a>)</span>, <code>doctor_cal</code> <span class="citation" data-cites="GURM:97">(<a href="#ref-GURM:97" role="doc-biblioref">Gurmu 1997</a>)</span>, <code>doctor_ger</code> <span class="citation" data-cites="SANT:WIND:01">(<a href="#ref-SANT:WIND:01" role="doc-biblioref">Santos Silva and Windmeijer 2001</a>)</span> and <code>doctor_us</code> <span class="citation" data-cites="MULL:98">(<a href="#ref-MULL:98" role="doc-biblioref">Mullahy 1998</a>)</span> concern annual doctor visits, respectively in Australia, California, Germany and the United States. <code>health_ins</code> <span class="citation" data-cites="DEB:TRIV:02">(<a href="#ref-DEB:TRIV:02" role="doc-biblioref">Deb and Trivedi 2002</a>)</span> focuses on the link between health insurance and doctor visits using a randomized experiment in the United States, as <code>health_reform</code> <span class="citation" data-cites="WINK:04">(<a href="#ref-WINK:04" role="doc-biblioref">Winkelmann 2004</a>)</span> analyzes the effect of a health insurance reform in Germany. <code>elderly</code> <span class="citation" data-cites="DEB:TRIV:97">(<a href="#ref-DEB:TRIV:97" role="doc-biblioref">Deb and Trivedi 1997</a>)</span> focus on the demand for health care by elderly in the US and <code>hospitalization</code> <span class="citation" data-cites="GEIL:MILL:ROTT:ZIMM:97">(<a href="#ref-GEIL:MILL:ROTT:ZIMM:97" role="doc-biblioref">Geil et al. 1997</a>)</span> uses as the response the number of stays in the hospital.</p>
<p>The response of <code>amc12</code> <span class="citation" data-cites="ELLI:SWAN:16">(<a href="#ref-ELLI:SWAN:16" role="doc-biblioref">Ellison and Swanson 2016</a>)</span> is the number of students per school who got a very high score at the AMC12 test (a test in mathematics). <code>asymptotic</code> <span class="citation" data-cites="KOEN:ZEIL:09">(<a href="#ref-KOEN:ZEIL:09" role="doc-biblioref">Koenker and Zeileis 2009</a>)</span> is a meta-analysis of wage equations reported in 156 papers and the analysis stresses on the hypothesis used to get the consistency of an estimator, i.e., that the number of regressors is fixed as the number of observations increases. <code>bids</code> <span class="citation" data-cites="CAME:JOHA:97">(<a href="#ref-CAME:JOHA:97" role="doc-biblioref">Cameron and Johansson 1997</a>)</span> analyzes the number of bids received by 126 firms that were targets of tender offers. <code>cartels</code> <span class="citation" data-cites="MILL:09">(<a href="#ref-MILL:09" role="doc-biblioref">Miller 2009</a>)</span> is a time series of bi-annual observations, the response being the number of cartels discoveries and the main covariate the pre- and post-period when a new leniency program was introduced. <code>cigmales</code> <span class="citation" data-cites="MULL:97">(<a href="#ref-MULL:97" role="doc-biblioref">Mullahy 1997</a>)</span> measures the number of cigarettes smoked daily by males in the United States. <code>majordrg</code> <span class="citation" data-cites="GREE:01">(<a href="#ref-GREE:01" role="doc-biblioref">Greene 2001</a>)</span> contain data about the number of major derogatory reports by cardholders. <code>publications</code> <span class="citation" data-cites="LONG:97">(<a href="#ref-LONG:97" role="doc-biblioref">Long 1997</a>)</span> analyzes the scientific production (measured by the number of publications) of individuals who got a PhD in biochemistry. <code>somerville</code> <span class="citation" data-cites="SELL:STOL:CHAV:85">(<a href="#ref-SELL:STOL:CHAV:85" role="doc-biblioref">Seller, Stoll, and Chavas 1985</a>)</span> reports the number of recreational visits to a lake in Texas. <code>strikes</code> <span class="citation" data-cites="KENN:85">(<a href="#ref-KENN:85" role="doc-biblioref">Kennan 1985</a>)</span> is a time series that reports the number of strikes (and also their length) in the United States. <code>trips</code> <span class="citation" data-cites="TERZ:98">(<a href="#ref-TERZ:98" role="doc-biblioref">Terza 1998</a>)</span> contains the number of trips taken by members of households the day prior the survey interview. </p>
<p>As we have seen in <a href="maximum_likelihood.html#sec-poisson_ml"><span>Section&nbsp;5.1.1</span></a>, count data can be considered as a random variable that follows a Poisson distribution, which has a unique parameter, this parameter being the mean and the variance of the series. The ML estimator of this parameter is the sample mean, which is indicated in the first column (<span class="math inline">\(\mu\)</span>) of <span class="quarto-unresolved-ref">?tbl-empsurvey</span>. The empirical variance (<span class="math inline">\(\omega\)</span>) is reported in the second column. Count data often take small values, and this is the case for almost all our data sets. We report in <span class="quarto-unresolved-ref">?tbl-empsurvey</span> the 9th decile, which is less than 10 for a majority of the data sets. Noticeable exceptions are <code>asymptotic</code> (the number of covariates in an econometric equation) and <code>cigmales</code> (the number of cigarettes smoked daily).</p>
<p>While comparing real count data to Poisson distribution, one often faces two problems: </p>
<ul>
<li>
<strong>overdispersion</strong>, which means that the variance is much greater than the mean,</li>
<li>
<strong>excess of zero</strong>, which means that the mean probability of a zero value computed using the Poisson distribution is often much less than the observed share of zero in the sample.</li>
</ul>
<div style="page-break-after: always;"></div>
<p>The third column of <span class="quarto-unresolved-ref">?tbl-empsurvey</span> contains the mean variance ratio and shows that overdispersion seems to be the rule. The ratio is in general much larger than 1, noticeable exceptions being <code>bids</code>, <code>cartels</code> and <code>majordrg</code>. This overdispersion is important because we consider that the Poisson parameter is the same for every observation. Adding covariates will give specific values of the Poisson parameter for every observations and will therefore reduce the (conditional) variance. Anyway, we’ll see in subsequent sections that the overdispersion problem is often still present even after introducing covariates, because of unobserved heterogeneity.</p>
<p>The excess of zero problem is difficult to distinguish from overdispersion, as zero is an extreme value of the distribution and therefore, an excess of zero leads to overdispersion. The excess of zero can in part be explained by the fact that 0 is a special value that may not be correctly explained by the same process that explains strictly positive values. An example is <code>cigmales</code>, where 0 means no smoking, and smoking vs.&nbsp;non-smoking is quite different in nature than smoking a few or a lot of cigarettes. The eighth column of <span class="quarto-unresolved-ref">?tbl-empsurvey</span> returns the ratio between the empirical share of zero and the Poisson probability of 0 and, unsurprisingly, this ratio is huge for <code>cigmales</code>.</p>
</section><section id="analyzing-the-number-of-trips" class="level3"><h3 class="anchored" data-anchor-id="analyzing-the-number-of-trips">Analyzing the number of trips</h3>
<p>Throughout this chapter, we’ll use the <code>trips</code> data set. It was used by <span class="citation" data-cites="TERZ:98">Terza (<a href="#ref-TERZ:98" role="doc-biblioref">1998</a>)</span> and the response is the number of trips taken the day before the interview. We first consider the unconditional distribution of the number of <code>trips</code>, computing the first two moments and the share of 0: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">trips</span> <span class="op">%&gt;%</span> <span class="fu">summarise</span><span class="op">(</span>m <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">trips</span><span class="op">)</span>, v <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">var</a></span><span class="op">(</span><span class="va">trips</span><span class="op">)</span>, </span>
<span>                    s0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">trips</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 1 × 3</span></span>
<span><span class="co">##       m     v    s0</span></span>
<span><span class="co">##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">## 1  4.55  24.4 0.185</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This series exhibits important overdispersion, as the variance is about 5 times larger than the mean. The ML estimator is the sample mean, and therefore, the predicted probability of 0 for the Poisson model is: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html">dpois</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">4.551</span><span class="op">)</span></span>
<span><span class="co">## [1] 0.01056</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>which is much lower than the actual percentage of 0 which is 18.5%. There is therefore a large excess of 0, which also can be associated with overdispersion as 0 is a value far from the mean of 4.551. The <strong>topmodels</strong> package<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> provides an interesting plotting function called <code>rootogram</code> to compare the actual and the fitted distribution of a count. The first is represented by bars and the second by a curve. The most simple representation is obtained by setting the <code>style</code> and the <code>scale</code> parameters respectively to <code>"standing"</code> and <code>"raw"</code> (see <a href="#fig-tripsuncond">Figure&nbsp;<span>12.1</span></a>). With the first, the bottom of all the bars is on the horizontal axes; with the second one, the absolute frequencies are displayed on the vertical axes. For example, for <span class="math inline">\(Y=0\)</span>, the absolute frequency is 107 and, as seen previously, the fitted probability is <span class="math inline">\(0.01056\)</span> which implies, as the number of observations is 577, a fitted frequency of <span class="math inline">\(577 \times 0.01056 = 6.1\)</span>. The frequencies are clearly over-estimated for values of the response close to the mean (3, 4, 5, 6) and under-estimated for extreme values. This is particularly the case for 0, which indicates that a specific problem of excess of zero may be present.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">uncond_trips</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span><span class="va">trips</span> <span class="op">~</span> <span class="fl">1</span>, data <span class="op">=</span> <span class="va">trips</span>, family <span class="op">=</span> <span class="st">"poisson"</span><span class="op">)</span></span>
<span><span class="fu">topmodels</span><span class="fu">::</span><span class="fu"><a href="https://topmodels.R-Forge.R-project.org/reference/rootogram.html">rootogram</a></span><span class="op">(</span><span class="va">uncond_trips</span>, plot <span class="op">=</span> <span class="cn">FALSE</span>, breaks <span class="op">=</span> <span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">16</span><span class="op">)</span> <span class="op">-</span> <span class="fl">0.5</span>,</span>
<span>                    style <span class="op">=</span> <span class="st">"standing"</span>, scale <span class="op">=</span> <span class="st">"raw"</span>, confint <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="va">autoplot</span> <span class="op">+</span> <span class="fu">coord_cartesian</span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">15</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-tripsuncond" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="count_files/figure-html/fig-tripsuncond-1.png" class="img-fluid figure-img" style="width:60.0%"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;12.1: Unconditional distribution of trips</figcaption><p></p>
</figure>
</div>
</div>
</div>
</section></section><section id="sec-poisson_model" class="level2" data-number="12.2"><h2 data-number="12.2" class="anchored" data-anchor-id="sec-poisson_model">
<span class="header-section-number">12.2</span> Poisson model</h2>
<p></p>
<section id="derivation-of-the-poisson-model" class="level3"><h3 class="anchored" data-anchor-id="derivation-of-the-poisson-model">Derivation of the Poisson model</h3>
<p>The basic count data model is the Poisson model. It relies on the hypothesis that the response is a Poisson variable and therefore that the probability of a given value <span class="math inline">\(y\)</span> is:</p>
<p><span class="math display">\[
\mbox{P}(Y = y, \mu) = \frac{e^{-\mu}{\mu} ^ y}{y !}
\]</span></p>
<p>The Poisson distribution is defined by a unique parameter <span class="math inline">\(\mu\)</span>, which is the mean and the variance of the distribution. This is a striking feature of the Poisson distribution which differs for example from the normal distribution which has two separate position and dispersion parameters (respectively the mean and the standard deviation). The Poisson probability can also be written as:</p>
<p><span class="math display">\[
\mbox{P}(Y = y, \mu) = e^{y \ln \mu-\mu- \ln y !}
\]</span> and therefore, the Poisson model belongs to the generalized linear model family (see <a href="binomial.html#sec-glm"><span>Section&nbsp;10.3</span></a>), with <span class="math inline">\(\theta = \ln \mu\)</span>, <span class="math inline">\(b(\theta) = \mu = e^ \theta\)</span>, <span class="math inline">\(\phi = 1\)</span> and <span class="math inline">\(c(y, \phi) = - \ln y !\)</span>. The mean is <span class="math inline">\(b'(\theta) = e ^ \theta = \mu\)</span> and the variance <span class="math inline">\(\phi b''(\theta) = e ^ \theta = \mu\)</span>. The link defines the relation between the linear predictor <span class="math inline">\(\eta\)</span> and the parameter of the distribution <span class="math inline">\(\mu\)</span>: <span class="math inline">\(\eta = g(\mu)\)</span>. The canonical link is such that <span class="math inline">\(\theta = \eta\)</span> and it is therefore, for the Poisson model, the log link: <span class="math inline">\(\eta = \ln \mu\)</span>. For a given set of covariates, the Poisson parameter for observation <span class="math inline">\(n\)</span> is <span class="math inline">\(\mu_n = g ^ {-1}(\eta_n)\)</span>, with <span class="math inline">\(\eta_n = \alpha + \beta ^ \top x_n = \gamma ^ \top z_n\)</span> the linear predictor. Therefore:</p>
<p><span id="eq-condexp_poisson"><span class="math display">\[
\mu_n = \mbox{E}(y \mid x_n) = e^{\alpha + \beta^\top x_n} = e^{\gamma ^ \top z_n}
\tag{12.1}\]</span></span></p>
<p>and the log-likelihood function is:</p>
<p><span class="math display">\[
\ln L (\gamma, y, Z) = \sum_{n=1} ^ N \ln \frac{e^{-e^{\gamma^\top z_n}}
e ^{y_n\gamma ^ \top z_n}}{y_n !} = \sum_{n=1} ^ N -e^{\gamma^\top z_n} +
y_n \gamma^\top z_n - \ln y_n !
\]</span></p>
<p>The first-order conditions for a maximum are:</p>
<p><span id="eq-foc_poisson"><span class="math display">\[
\frac{\partial \ln L}{\partial \gamma} = \sum_{n = 1} ^ N \left(y_n -
e^{\gamma^\top z_n}\right)z_n = 0
\tag{12.2}\]</span></span></p>
<p>which states, as in the OLS model, that the difference between the actual value of the response <span class="math inline">\(y\)</span> and the prediction of the model (which can be called the residual) should be orthogonal to every covariate. It is a very important property, as it implies that the Poisson model is consistent if the conditional expectation function is correctly specified, whether or not the hypothesis of the Poisson distribution is correct. Moreover, as the first element of <span class="math inline">\(z_n\)</span> is 1, the first element of <a href="#eq-foc_poisson">Equation&nbsp;<span>12.2</span></a> implies that:</p>
<p><span id="eq-mean_me_poisson"><span class="math display">\[
\bar{y} = \frac{1}{N} \sum_{n=1} ^N e ^ {\hat{\gamma}^\top z_n}
\tag{12.3}\]</span></span></p>
<p>which means that the mean of the predictions equals the mean value of <span class="math inline">\(y\)</span> in the sample.</p>
<p>For the <code>trips</code> data set, the covariates are the share of trips for work or school (<code>workschl</code>), the number of individuals in the household (<code>size</code>), the distance to the central business district (<code>dist</code>), a dummy (<code>smsa</code>) for large urban area, the number of full-time workers in a household (<code>fulltime</code>), the distance from home to the nearest transit node (<code>distnode</code>), household income divided by the median income of the census tract (<code>realinc</code>), a dummy if the survey period is Saturday or Sunday (<code>weekend</code>) and a dummy for owning at least one car (<code>car</code>). The Poisson model is fitted using the <code>glm</code> function and setting the <code>family</code> argument to <code>poisson</code>. As for the binomial model, the <code>family</code> argument can be a character, a function without argument (in this case, the default link is chosen) or a function with a link argument.<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> For the sake of comparison, we also estimate a linear model using <code>lm</code>: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ftrips</span> <span class="op">&lt;-</span> <span class="va">trips</span> <span class="op">~</span> <span class="va">workschl</span> <span class="op">+</span> <span class="va">size</span> <span class="op">+</span> <span class="va">dist</span> <span class="op">+</span> <span class="va">smsa</span> <span class="op">+</span> <span class="va">fulltime</span> <span class="op">+</span> <span class="va">distnod</span> <span class="op">+</span> </span>
<span>  <span class="va">realinc</span> <span class="op">+</span> <span class="va">weekend</span> <span class="op">+</span> <span class="va">car</span></span>
<span><span class="va">pois_trips</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span><span class="va">ftrips</span>, family <span class="op">=</span> <span class="va">poisson</span>, <span class="va">trips</span><span class="op">)</span></span>
<span><span class="va">lm_trips</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">ftrips</span>, <span class="va">trips</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="interpretation-of-the-coefficients" class="level3"><h3 class="anchored" data-anchor-id="interpretation-of-the-coefficients">Interpretation of the coefficients</h3>
<p>As for any non-linear models, the marginal effects are not equal to the coefficients. Taking the derivative of the conditional expectation function (<a href="#eq-condexp_poisson">Equation&nbsp;<span>12.1</span></a>) with the k<sup>th</sup> covariate, we get the following marginal effect for observation <span class="math inline">\(n\)</span>:</p>
<p><span class="math display">\[
\frac{\partial \mbox{E}(y\mid x_n)}{\partial x_{nk}} = \beta_k e^{\gamma^\top z_n}
\]</span></p>
<p>which can be consistently estimated by <span class="math inline">\(\hat{\beta}_k e^{\hat{\gamma}^\top z_n}\)</span>. Note that the ratio of the marginal effects of two covariates <span class="math inline">\(k\)</span> and <span class="math inline">\(l\)</span> is <span class="math inline">\(\beta_k / \beta_l\)</span> and therefore doesn’t depend on the values of the covariates for a specific observation. The average marginal effect (AME) for the <span class="math inline">\(N\)</span> observations is:</p>
<p><span class="math display">\[
\hat{\beta}_k \frac{\sum_{n=1}^N e^{\hat{\gamma}^\top z_n}}{N}
\]</span></p>
<p>But, if the regression contains an intercept, the sample mean of the predictions is the sample mean of the response (see <a href="#eq-mean_me_poisson">Equation&nbsp;<span>12.3</span></a>). Therefore, the average marginal effect is <span class="math inline">\(\hat{\beta}_k \bar{y}\)</span>. Therefore, we can for example compare the estimate slopes in a linear model (which are directly the marginal effects) to the Poisson estimators multiplied by the mean of the response.</p>
<p>We now print the coefficients obtained for the Poisson and for the linear model:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span>lm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">lm_trips</span><span class="op">)</span>, poisson <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">pois_trips</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        (Intercept) workschl   size      dist     smsa fulltime
lm          -0.8799  -2.1504 0.8285 -0.012944 -0.04841   1.3331
poisson     -0.5703  -0.4556 0.1667 -0.002199 -0.03093   0.2482
         distnod realinc  weekend   car
lm      0.028952 0.13339 -0.47650 2.219
poisson 0.004879 0.01882 -0.07382 1.413</code></pre>
</div>
</div>
<p>An increase of 1 of <code>realinc</code> means that household’s income increases by an amount equal to the local median income. The linear models indicates that the number of trips then increases by <span class="math inline">\(0.133\)</span> trips (the sample mean for trips being 4.55). The Poisson model indicates that the relative increase of trips <span class="math inline">\(dy /y\)</span> is equal to <span class="math inline">\(0.019\)</span>, i.e., 2%. At the sample mean, it corresponds to an increase of <span class="math inline">\(0.019 \times 4.55 = 0.086\)</span> trips.</p>
<p>If the interview concerns a weekend day, the OLS coefficient is <span class="math inline">\(-0.48\)</span>, which indicates that the number of trips taken during the weekend are about one-half less, compared to a weekday. For such a dummy variable, denoting <span class="math inline">\(\beta_w\)</span> and <span class="math inline">\(z_0\)</span> a given vector of covariates such that <span class="math inline">\(x_w = 0\)</span>, <span class="math inline">\(\gamma^\top z_0\)</span> is the linear predictor for a weekday and <span class="math inline">\(\gamma^\top z_0 + \beta_w\)</span> the linear predictor for a week-end day. Therefore, the relative difference <span class="math inline">\(\tau\)</span> of the number of trips between a weekend day and a weekday is:</p>
<p><span class="math display">\[
\tau = \frac{e^{\gamma^\top z_0 + \beta_w}- e^{\gamma^\top
z_0}}{e^{\gamma^\top z_0}} = e^{\beta_w} - 1 = e^{-0.0738} - 1 = - 0.071
= 7.1\%
\]</span></p>
<p>The previous expression indicates also that <span class="math inline">\(\beta_w = \ln (1 + \tau) \approx \tau\)</span>. For small values of <span class="math inline">\(\beta_w\)</span>, the coefficient can be interpreted as the relative difference of the response. In terms of absolute value, at the sample mean, the absolute difference is <span class="math inline">\(- 0.071 \times 4.55 = -0.323\)</span>, which is close to the OLS coefficient. Of course the approximation is only relevant for small values of the coefficient. If we consider the coefficient of <code>cars</code>, the value for the Poisson model is <span class="math inline">\(1.413\)</span> which implies an increase of <span class="math inline">\(e^{1.413} - 1 = 3.1 = 310\)</span>% much larger that the value of the coefficient.</p>
</section><section id="computation-of-the-variance-of-the-estimator" class="level3"><h3 class="anchored" data-anchor-id="computation-of-the-variance-of-the-estimator">Computation of the variance of the estimator</h3>
<p>The matrix of the second derivatives is:</p>
<p><span class="math display">\[
\frac{\partial \ln L}{\partial \gamma\partial \gamma ^
\top}=-\sum_{n=1}^N e^{\gamma^\top z_n}z_n z_n^\top
\]</span></p>
<p>The information matrix is the opposite of the hessian (as it doesn’t depend on <span class="math inline">\(y\)</span>, it is equal to its expected value) and the variance of the gradient. The latter is:</p>
<p><span class="math display">\[
\sum_{n=1} ^ N \mbox{E}\left( (y_n - e^{\gamma^\top z_n})^2 z_n
z_n^\top\right) = \sum_{n=1} ^ N e^{\gamma^\top z_n} z_n
z_n^\top
\]</span></p>
<p>as <span class="math inline">\(\mbox{E}\left( (y_n - e^{\gamma^\top z_n}) ^2 \right)\)</span> is the conditional variance which equals the conditional expectation for a Poisson distribution. The estimated variance of the estimator is therefore:</p>
<p><span class="math display">\[
\hat{\mbox{V}}(\hat{\beta}) = \left(\sum_{n=1} ^ N e^{\hat{\gamma}^\top z_n} z_n
z_n^\top\right) ^ {-1} = \left(\sum_{n=1} ^ N \hat{\mu}_n z_n
z_n^\top\right) ^ {-1}
\]</span> This estimator is consistent only if the distribution of the response is Poisson, and therefore if the conditional variance equals the conditional mean. A more general estimator is based on the sandwich formula: </p>
<p><span id="eq-sandpois"><span class="math display">\[
\left(\sum_{n=1} ^ N \hat{\mu}_n z_n
z_n^\top\right) ^ {-1}
\left(\sum_{n=1} ^ N (y_n - \hat{\mu}_n)^2 z_n
z_n^\top\right)
\left(\sum_{n=1} ^ N \hat{\mu}_n z_n
z_n^\top\right) ^ {-1}
\tag{12.4}\]</span></span></p>
<p>One alternative is to assume that the variance is proportional to the mean: <span class="math inline">\(\mbox{V}(y|x) = \phi \mbox{E}(y|x)\)</span>. <span class="math inline">\(\phi\)</span> can then be consistently estimated by:</p>
<p><span id="eq-qpoisvar"><span class="math display">\[
\hat{\phi} = \frac{1}{N}\sum_{n=1} ^ N \frac{(y_n - \hat{\mu}_n) ^ 2}{\mu_n}
\tag{12.5}\]</span></span></p>
<p>which leads to the third estimator of the covariance matrix:</p>
<p><span id="eq-quasi-poisson"><span class="math display">\[
\hat{\mbox{V}}(\hat{\gamma}) = \hat{\phi}\left(\sum_{n=1} ^ N \hat{\mu}_n z_n z_n^\top\right) ^ {-1}
\tag{12.6}\]</span></span></p>
<p> The “quasi-Poisson” model is obtained by using the log link and <a href="#eq-quasi-poisson">Equation&nbsp;<span>12.6</span></a> for the variance. It leads to the same estimator as the Poisson model and a variance that is greater (respectively lower) than the one of the Poisson model if there is overdispersion (respectively underdispersion). It can be fitted using <code>glm</code> by setting the <code>family</code> argument to <code>quasipoisson</code>: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">qpois_trips</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">pois_trips</span>, family <span class="op">=</span> <span class="va">quasipoisson</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Compared to the Poisson model, the standard deviations of the quasi-Poisson model are inflated by a factor which is the square root of the estimate of the variance-mean ratio. This factor can be estimated using <a href="#eq-qpoisvar">Equation&nbsp;<span>12.5</span></a>, which makes use of the residuals of the Poisson regression. </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">pois_trips</span> <span class="op">%&gt;%</span> <span class="va">model.frame</span> <span class="op">%&gt;%</span> <span class="va">model.response</span></span>
<span><span class="va">mu</span> <span class="op">&lt;-</span> <span class="va">pois_trips</span> <span class="op">%&gt;%</span> <span class="va">fitted</span></span>
<span><span class="va">e_resp</span> <span class="op">&lt;-</span> <span class="va">pois_trips</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">resid</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span></span>
<span><span class="va">e_pears</span> <span class="op">&lt;-</span> <span class="va">pois_trips</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">resid</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"pearson"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p> The response residual is <span class="math inline">\(y_n - \hat{\mu}_n\)</span>, and we get the Pearson residual by dividing the response residual by the standard deviation, which is <span class="math inline">\(\sqrt{\hat{\mu}_n}\)</span>. Therefore, the estimation of the variance-mean ratio is simply the sum of square of the Pearson residuals divided by the sample size (the number of degrees of freedom can be used instead). </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">phi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">e_pears</span> <span class="op">^</span> <span class="fl">2</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/df.residual.html">df.residual</a></span><span class="op">(</span><span class="va">pois_trips</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">phi</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">phi</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## [1] 3.366 1.835</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The estimated variance-mean ratio is more than 3, so that the standard deviations of the quasi-Poisson model are almost 2 times larger than those of the Poisson model (1.835). The sandwich estimator can be constructed by extracting from the fitted Poisson model the model matrix (<span class="math inline">\(Z\)</span>), the fitted values (<span class="math inline">\(\hat{\mu}_n\)</span>) and the response residuals (<span class="math inline">\(y_n - \hat{\mu}_n\)</span>): </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">mu</span> <span class="op">&lt;-</span> <span class="va">pois_trips</span> <span class="op">%&gt;%</span> <span class="va">fitted</span></span>
<span><span class="va">e</span> <span class="op">&lt;-</span> <span class="va">pois_trips</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">resid</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span></span>
<span><span class="va">Z</span> <span class="op">&lt;-</span> <span class="va">pois_trips</span> <span class="op">%&gt;%</span> <span class="va">model.matrix</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can then compute the “bread” (<code>B</code>) and the “meat” (<code>M</code>): </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">B</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/crossprod.html">crossprod</a></span><span class="op">(</span><span class="va">mu</span> <span class="op">*</span> <span class="va">Z</span>, <span class="va">Z</span><span class="op">)</span></span>
<span><span class="va">M</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/crossprod.html">crossprod</a></span><span class="op">(</span><span class="va">e</span> <span class="op">^</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">Z</span>, <span class="va">Z</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Applying <a href="#eq-sandpois">Equation&nbsp;<span>12.4</span></a>, and taking the square root of the diagonal elements, we get: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sand_vcov</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/solve.html">solve</a></span><span class="op">(</span><span class="va">B</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="va">M</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/solve.html">solve</a></span><span class="op">(</span><span class="va">B</span><span class="op">)</span></span>
<span><span class="va">sand_vcov</span> <span class="op">%&gt;%</span> <span class="va">stder</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span></span>
<span><span class="co">## (Intercept)    workschl        size        dist </span></span>
<span><span class="co">##    0.185364    0.117199    0.025192    0.001696</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>sandwich</code> package provides the <code>vcovHC</code> function which computes different flavors of the sandwich estimator of the variance. The one that corresponds to <a href="#eq-sandpois">Equation&nbsp;<span>12.4</span></a> is obtained by setting <code>type</code> to <code>HC</code>. </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">sandwich</span><span class="fu">::</span><span class="fu"><a href="https://sandwich.R-Forge.R-project.org/reference/vcovHC.html">vcovHC</a></span><span class="op">(</span><span class="va">pois_trips</span>, type <span class="op">=</span> <span class="st">"HC"</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">stder</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span></span>
<span><span class="co">## (Intercept)    workschl        size        dist </span></span>
<span><span class="co">##    0.185363    0.117199    0.025191    0.001696</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The sandwich standard errors can also be extracted from the Poisson model using <code>stder</code> with the <code>vcov</code> and <code>type</code> arguments (respectively equal to <code><a href="https://sandwich.R-Forge.R-project.org/reference/vcovHC.html">sandwich::vcovHC</a></code> and <code>"HC"</code>): </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">stder</span><span class="op">(</span><span class="va">pois_trips</span>, vcov <span class="op">=</span> <span class="fu">sandwich</span><span class="fu">::</span><span class="va"><a href="https://sandwich.R-Forge.R-project.org/reference/vcovHC.html">vcovHC</a></span>, type <span class="op">=</span> <span class="st">"HC"</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span></span>
<span><span class="co">## (Intercept)    workschl        size        dist </span></span>
<span><span class="co">##    0.185363    0.117199    0.025191    0.001696</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Taking the ratio of the simple standard deviations of the coefficients and the sandwich estimator, we get: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">stder</span><span class="op">(</span><span class="va">sand_vcov</span><span class="op">)</span> <span class="op">/</span> <span class="fu">stder</span><span class="op">(</span><span class="va">pois_trips</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(Intercept)    workschl        size        dist        smsa 
      1.481       1.677       2.059       1.139       1.996 
   fulltime     distnod     realinc     weekend         car 
      1.695       1.931       2.888       2.023       1.415 </code></pre>
</div>
</div>
<p>As previously, the robust standard deviations are about twice the basic ones on average, but the ratio now depends on the coefficient. </p>
<p> </p>
<p></p>
</section><section id="overdispersion" class="level3"><h3 class="anchored" data-anchor-id="overdispersion">Overdispersion</h3>
<p> A more general expression for the variance is the following Negbin specification:</p>
<p><span class="math display">\[
\sigma_n ^ 2 = \mu_n + \alpha \mu_n ^ p
\]</span></p>
<p>with two special cases:</p>
<ul>
<li>
<span class="math inline">\(p = 1\)</span> (<strong>NB1</strong>) which implies that the variance is proportional to the expectation, <span class="math inline">\(\sigma_n ^ 2 = (1 + \alpha) \mu_n\)</span>,</li>
<li>
<span class="math inline">\(p = 2\)</span> (<strong>NB2</strong>) which implies that the variance is quadratic in the expectation, <span class="math inline">\(\sigma_n ^ 2 = \mu_n + \alpha \mu_n ^ 2\)</span>. </li>
</ul>
<p>Tests for overdispersion can easily be implemented using one of the three test principles: Wald, likelihood ratio and score tests. The first two require the estimation of a more general model that doesn’t impose the equality between the conditional mean and the conditional variance. The score test requires only the estimation of the constrained (Poisson) model. It can take different forms; we’ll just present here the test advocated by <span class="citation" data-cites="CAME:TRIV:86">Cameron and Trivedi (<a href="#ref-CAME:TRIV:86" role="doc-biblioref">1986</a>)</span> who use an auxiliary regression.<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> The null hypothesis is:</p>
<p><span class="math display">\[
\mbox{E}\left( (y_n - \mu_n) ^ 2 - y_n\right) = \sigma_n ^ 2 - \mu_n = 0
\]</span></p>
<p>With the NB1 specification, the alternative is:</p>
<p><span class="math display">\[
\mbox{E}\left( (y_n - \mu_n) ^ 2 - y_n\right) = (1 + \alpha)\mu_n -
\mu_n = \alpha \mu_n
\]</span></p>
<p>or:</p>
<p><span id="eq-aregnb1"><span class="math display">\[
\frac{\mbox{E}\left( (y_n - \mu_n) ^ 2 - y_n\right)}{\mu_n} = \alpha
\tag{12.7}\]</span></span></p>
<p>The hypothesis of equidispersion (i.e., <span class="math inline">\(\alpha = 0\)</span>) can be tested by regressing <span class="math inline">\(\frac{ (y_n - \hat{\mu}_n) ^ 2 - y_n}{\hat{\mu}_n}\)</span> on a constant and comparing the Student statistic to the relevant critical value. With the NB2 specification, the alternative is:</p>
<p><span class="math display">\[
\mbox{E}\left( (y_n - \mu_n) ^ 2 - y_n\right) = \mu_n + \alpha\mu_n ^
2 - \mu_n = \alpha \mu_n ^2
\]</span></p>
<p>or:</p>
<p><span id="eq-aregnb2"><span class="math display">\[
\frac{\mbox{E}\left( (y_n - \mu_n) ^ 2 - y_n\right)}{\mu_n} = \alpha \mu_n
\tag{12.8}\]</span></span></p>
<p> The hypothesis of equidispersion (i.e., <span class="math inline">\(\alpha = 0\)</span>) can then be tested by regressing <span class="math inline">\(\frac{ (y_n - \hat{\mu}_n) ^ 2 - y_n}{\hat{\mu}_n}\)</span> on <span class="math inline">\(\hat{\mu}_n\)</span> without an intercept and comparing the Student statistic to the relevant critical value. Note that the response in this auxiliary regression can be written as: <span class="math inline">\((y_n - \hat{\mu}_n) ^ 2 / \hat{\mu} - y_n/\hat{\mu}_n\)</span>, which is the difference between the square of the Pearson residual and the ratio of the actual and the fitted value of the response: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">hmu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/fitted.values.html">fitted</a></span><span class="op">(</span><span class="va">pois_trips</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.extract.html">model.response</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/model.frame.html">model.frame</a></span><span class="op">(</span><span class="va">pois_trips</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">e_pears</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">resid</a></span><span class="op">(</span><span class="va">pois_trips</span>, type <span class="op">=</span> <span class="st">"pearson"</span><span class="op">)</span></span>
<span><span class="va">resp_areg</span> <span class="op">&lt;-</span> <span class="va">e_pears</span> <span class="op">^</span> <span class="fl">2</span> <span class="op">-</span> <span class="va">y</span> <span class="op">/</span> <span class="va">hmu</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">resp_areg</span> <span class="op">~</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">gaze</span><span class="op">(</span>coef <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">##             Estimate Std. Error t value Pr(&gt;|t|)</span></span>
<span><span class="co">## (Intercept)    2.314      0.406     5.7  1.9e-08</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">resp_areg</span> <span class="op">~</span> <span class="va">hmu</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">gaze</span></span>
<span><span class="co">##     Estimate Std. Error t value Pr(&gt;|t|)</span></span>
<span><span class="co">## hmu   0.4671     0.0765    6.11  1.9e-09</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In both regressions, the t statistic is much higher than 1.96, the p-value is very close to zero so that the equidispersion hypothesis is strongly rejected.</p>
<p>To see to what extent the introduction of covariates has reduced the overdispersion problem, we can produce once again a rootogram, this time using the fitted Poisson model. We use the default style which is <code>"hanging"</code>, which means that the bars are vertically aligned on the points that display the fitted frequencies and the default scale which is <code>"sqrt"</code>; the vertical axis indicates the square root of the frequencies, to increase the readability of small frequencies. Rootograms for the Poisson model are presented on <a href="#fig-rootograms">Figure&nbsp;<span>12.2</span></a> along with the previous rootogram for the unconditional distribution of <code>trips</code>. The two figures are first created without being plotted by setting the <code>plot</code> argument to <code>FALSE</code>, and are then assembled in one figure using <code><a href="https://rpkgs.datanovia.com/ggpubr/reference/ggarrange.html">ggpubr::ggarrange</a></code>. The limits on the vertical axis are set to the same values for the two plots so that the frequencies for the two figures can be easily compared. </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">uncond_trips</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span><span class="va">trips</span> <span class="op">~</span> <span class="fl">1</span>, data <span class="op">=</span> <span class="va">trips</span>, family <span class="op">=</span> <span class="st">"poisson"</span><span class="op">)</span></span>
<span><span class="va">fig_raw</span> <span class="op">&lt;-</span> <span class="fu">topmodels</span><span class="fu">::</span><span class="fu"><a href="https://topmodels.R-Forge.R-project.org/reference/rootogram.html">rootogram</a></span><span class="op">(</span><span class="va">uncond_trips</span>, </span>
<span>                                 plot <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="va">autoplot</span> <span class="op">+</span> <span class="fu">coord_cartesian</span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">15</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3</span>, <span class="fl">12</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">fig_covar</span> <span class="op">&lt;-</span> <span class="fu">topmodels</span><span class="fu">::</span><span class="fu"><a href="https://topmodels.R-Forge.R-project.org/reference/rootogram.html">rootogram</a></span><span class="op">(</span><span class="va">pois_trips</span>, plot <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="va">autoplot</span> <span class="op">+</span> <span class="fu">coord_cartesian</span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">15</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">3</span>, <span class="fl">12</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">figure</span> <span class="op">&lt;-</span> <span class="fu">ggpubr</span><span class="fu">::</span><span class="fu"><a href="https://rpkgs.datanovia.com/ggpubr/reference/ggarrange.html">ggarrange</a></span><span class="op">(</span><span class="va">fig_raw</span>, <span class="va">fig_covar</span>,</span>
<span>                           labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"No covariates"</span>, <span class="st">"Covariates"</span><span class="op">)</span>,</span>
<span>                           ncol <span class="op">=</span> <span class="fl">2</span>, nrow <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">figure</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-rootograms" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="count_files/figure-html/fig-rootograms-1.png" class="img-fluid figure-img" style="width:60.0%"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;12.2: Rootograms for Poisson models with and without covariates</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>One can see that the bottom of the bars is closer to the horizontal axis for the right figure (Poisson model with covariates), which indicates that the inclusion of covariates reduces slightly the overdispersion problem, which anyway still remains. Moreover, the excess of zero largely remains, which suggests that a model that takes the specificity of zero values should be used. The overdispersion phenomenon can also be represented by plotting the square of the residuals against the fitted values, the straight line (NB1 hypothesis) and the parabola (NB2 hypothesis) that fit the data. The result is presented in <a href="#fig-overpts">Figure&nbsp;<span>12.3</span></a>. </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tb</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span>e2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">resid</a></span><span class="op">(</span><span class="va">pois_trips</span>, type <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span> <span class="op">^</span> <span class="fl">2</span>,</span>
<span>             mu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/fitted.values.html">fitted</a></span><span class="op">(</span><span class="va">pois_trips</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">tb</span> <span class="op">%&gt;%</span> <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span><span class="va">mu</span>, <span class="va">e2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">coord_cartesian</span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">15</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">150</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_smooth</span><span class="op">(</span>method <span class="op">=</span> <span class="va">lm</span>, se <span class="op">=</span> <span class="cn">FALSE</span>, formula <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="va">x</span> <span class="op">-</span> <span class="fl">1</span>, </span>
<span>                color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_smooth</span><span class="op">(</span>method <span class="op">=</span> <span class="va">lm</span>, se <span class="op">=</span> <span class="cn">FALSE</span>, formula <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="va">x</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="va">x</span> <span class="op">^</span> <span class="fl">2</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-overpts" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="count_files/figure-html/fig-overpts-1.png" class="img-fluid figure-img" style="width:60.0%"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;12.3: Squared residuals and fitted values</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p></p>
</section></section><section id="sec-overdisp_zero" class="level2" data-number="12.3"><h2 data-number="12.3" class="anchored" data-anchor-id="sec-overdisp_zero">
<span class="header-section-number">12.3</span> Overdispersion and excess of zero</h2>
<p>We describe in this section models that have been proposed to overcome the limits of the Poisson model, namely the fact that it doesn’t deal correctly with overdispersion and the excess of zero.</p>
<section id="mixing-model" class="level3"><h3 class="anchored" data-anchor-id="mixing-model">Mixing model</h3>
<p></p>
<p>For the Poisson model with the log-link, the parameter of the Poisson distribution for individual <span class="math inline">\(n\)</span> is <span class="math inline">\(\mu_n = e^ {\gamma ^ \top z_n}\)</span>. The problem of overdispersion occurs when the variance of <span class="math inline">\(y\)</span> is greater than its expectation, although the hypothesis underlying the use of the Poisson model is that they are equal. One solution is to define the Poisson parameter for individual <span class="math inline">\(n\)</span> as : <span class="math inline">\(\lambda_n = \nu_n \mu_n = \nu_n e^ {\gamma ^ \top z_n}\)</span>. <span class="math inline">\(\nu_n\)</span> is an unobserved positive term that inflates the variance of <span class="math inline">\(y\)</span>. Actually, for the same set of covariates <span class="math inline">\(z\)</span>, two individuals <span class="math inline">\(n\)</span> and <span class="math inline">\(m\)</span> will be characterized by two different values of their Poisson parameters if <span class="math inline">\(\nu_n \neq \nu_m\)</span>. For a given value of <span class="math inline">\(\nu\)</span>, the probability of <span class="math inline">\(y\)</span> is still Poisson:</p>
<p><span class="math display">\[
P(y_n \mid x_n, \nu_n ; \gamma) = \frac{e^{- \nu_n e^{\gamma ^ \top z_n}} \left(\nu_ne^{\gamma ^ \top z_n}\right) ^ {y_n}}{y_n !}
\]</span> but, as <span class="math inline">\(\nu_n\)</span> is unobserved, this probability can’t be used to estimate the parameters of the model. To get the distribution of <span class="math inline">\(y\)</span> conditional on <span class="math inline">\(x\)</span> only, we need to integrate out <span class="math inline">\(\nu_n\)</span>, assuming a specific distribution for <span class="math inline">\(\nu\)</span>, called the <strong>mixing distribution</strong>. Two popular choices are the gamma and the log-normal distributions. The gamma density is: </p>
<p><span class="math display">\[
g(\nu; \delta, \gamma) = \nu ^ {\delta - 1} e ^ {- \gamma \nu} \gamma ^ \delta / \Gamma(\delta)
\]</span></p>
<p>where <span class="math inline">\(\delta\)</span> and <span class="math inline">\(\gamma\)</span> are respectively called the shape and the intensity parameters and <span class="math inline">\(\Gamma(z) = \int_0 ^ {+\infty}t ^ {z-1}e^{-t} dt\)</span> is the Gamma function. The expected value and the variance are respectively <span class="math inline">\(\delta / \gamma\)</span> and <span class="math inline">\(\delta / \gamma ^ 2\)</span>. As <span class="math inline">\(\gamma\)</span> contains an intercept <span class="math inline">\(\alpha\)</span>, <span class="math inline">\(\alpha\)</span> and the expected value of <span class="math inline">\(\nu\)</span> can’t be identified and a simple choice of normalization is to set <span class="math inline">\(\delta = \gamma\)</span>, so that the expected value of <span class="math inline">\(\nu\)</span> is set to 1 and the variance is then <span class="math inline">\(1 / \gamma\)</span>. The density of <span class="math inline">\(\nu\)</span> is then:</p>
<p><span class="math display">\[
g(\nu; \delta) = \nu ^ {\delta - 1} e ^ {- \delta \nu} \delta ^ \delta / \Gamma(\delta)
\]</span> The distribution of <span class="math inline">\(y\)</span> conditional on <span class="math inline">\(x_n\)</span> only, called the <strong>negative binomial</strong> distribution, is then:</p>
<p><span class="math display">\[
\begin{array}{rcl}
P(y_n \mid x_n ; \gamma, \delta) &amp;=&amp; \displaystyle \int_0 ^ {+\infty} P(y_n \mid
x_n, v ; \gamma) g(\nu; \delta) d\nu \\
&amp;=&amp; \displaystyle \int_0 ^ {+\infty}
\frac{e^{- \mu_n \nu} (\mu_n\nu) ^{y_n}}{y_n !}
\nu ^ {\delta - 1} e ^ {- \delta \nu} \delta ^ \delta / \Gamma(\delta)
d\nu
\end{array}
\]</span> Rearranging terms, we get:</p>
<p><span class="math display">\[
P(y_n \mid x_n ; \gamma, \delta) =
\frac{\mu_n ^ {y_n} \delta ^ \delta}{y_n !\Gamma(\delta)}
\int_0 ^ {+\infty}
e^{- (\mu_n + \delta) \nu} \nu ^ {y_n + \delta - 1}
d\nu
\]</span> with the change of variable <span class="math inline">\(t = (\mu_n + \delta)\nu\)</span>, we finally get:</p>
<p><span class="math display">\[
P(y_n \mid x_n ; \gamma, \delta) =
\frac{\mu ^ {y_n} \delta ^ \delta}{y_n !\Gamma(\delta)}
\frac{\Gamma(y_n + \delta)}{(\mu + \delta) ^{y_n + \delta}}
\]</span></p>
<p>and finally, as, for integer values of <span class="math inline">\(x\)</span>: <span class="math inline">\(\Gamma(x + 1) = x!\)</span>:</p>
<p><span class="math display">\[
P(y_n \mid x_n ; \gamma, \delta) =
\frac{\Gamma(y_n + \delta)}{\Gamma(y_n + 1)\Gamma(\delta)}
\left(\frac{\mu_n}{\mu_n + \delta}\right) ^ {y_n} \left(\frac{\delta}{\mu_n +
\delta}\right) ^ \delta
\]</span></p>
<p>Conditional on <span class="math inline">\(x_n\)</span> and <span class="math inline">\(\nu_n\)</span>, <span class="math inline">\(\mbox{E}(y_n \mid x_n, \nu_n) = \mbox{V}(y_n \mid x_n, \nu_n) = \nu_n \mu_n\)</span>. Conditional on <span class="math inline">\(x_n\)</span> only, <span class="math inline">\(\mbox{E}(y_n | x_n)= \mbox{E}_\nu(\nu \lambda_n) = \mu_n\)</span> (as <span class="math inline">\(\mbox{E}(\nu) = 1\)</span>). To get the variance, we use the formula of variance decomposition:</p>
<p><span class="math display">\[
\begin{array}{rcl}
\mbox{V}(y_n |x_n) &amp;=&amp; \mbox{E}_\nu\left(\mbox{V}(y_n |x_n,
\nu_n)\right) + \mbox{V}_\nu\left(\mbox{E}(y_n |x_n,
\nu_n)\right) =
\mbox{E}_\nu(\lambda_n) +
\mbox{V}_\nu(\lambda_n)\\
&amp;=&amp;
\mu_n + \mu_n ^ 2 \mbox{V}(\nu_n) =
\mu_n(1 + \mu_n/ \delta)
\end{array}
\]</span> Different parametrizations result in different flavors of the <strong>Negbin model</strong>. Replacing <span class="math inline">\(\delta\)</span> by <span class="math inline">\(\sigma = 1 / \delta\)</span> we get the NB2 model, with a quadratic conditional variance function: </p>
<p><span id="eq-var_negbin2"><span class="math display">\[
\mbox{V}(y_n|x_n) = \mu_n + \sigma \mu_n ^ 2 = (1 + \sigma \mu_n)\mu_n
\tag{12.9}\]</span></span></p>
<p>Replacing <span class="math inline">\(\delta\)</span> by <span class="math inline">\(\mu_n / \sigma\)</span>, we get the NB1 model, with a linear conditional variance function: </p>
<p><span id="eq-var_negbin1"><span class="math display">\[
\mbox{V}(y_n\mid x_n) = (1 + \sigma) \mu_n
\tag{12.10}\]</span></span></p>
<p>Note that, as <span class="math inline">\(\delta\)</span> is positive, so is <span class="math inline">\(\sigma\)</span> in the versions of the Negbin model so that the Negbin model exhibits necessarily overdispersion, with the special case of equidispersion if <span class="math inline">\(\sigma = 0\)</span>. Actually, in this case, <span class="math inline">\(\delta \rightarrow \infty\)</span>, so that the variance of <span class="math inline">\(\nu\)</span> tends to 0 and the Poisson model is therefore obtained as a limiting case. </p>
<p>Another choice for the mixing distribution is the log-normal distribution, with <span class="math inline">\(\ln \nu \sim \mathcal{N} (0, \sigma)\)</span>. The first parameter of the distribution is set to 0. For a log-normal distribution, the exponential of this parameter is the median of the log-normal. Therefore, the choice of normalization for the log-normal distribution is to set the median (and not the mean as in the gamma distribution) to 0. The log-normal density is <span class="math inline">\(\frac{1}{\sigma\nu}\phi(\ln \nu / \sigma)\)</span> where <span class="math inline">\(\phi()\)</span> is the standard normal density. The probabilities are then given by:</p>
<p><span class="math display">\[
P(y_n \mid x_n ; \gamma, \delta) =
\int_0 ^ {+\infty}
\frac{e^{- e ^ {\gamma ^ \top z_n} \nu_n} (e ^ {\gamma ^ \top z_n}\nu_n) ^ y}{y !}
\frac{1}{\sqrt{2\pi}\sigma\nu} e ^ {-\frac{1}{2}\left(\frac{\ln \nu}{\sigma}\right) ^ 2} d\nu
\]</span> using the change of variable <span class="math inline">\(t = \ln \nu / (\sqrt{2}\sigma)\)</span>, we get:</p>
<p><span class="math display">\[
P(y_n \mid x_n ; \gamma, \delta) =\frac{1}{\sqrt{\pi} y_n !}
\int_{- \infty} ^ {+\infty}
e^{- e ^ {\gamma ^ \top z_n + \sqrt{2}\sigma t}} e ^ {y(\gamma ^ \top z_n + \sqrt{2}\sigma t)}
e ^ {-t^2} dt
\]</span></p>
<p>There is no closed form for this integral, but it can be approximated using Gauss-Hermite quadrature: </p>
<p><span class="math display">\[
\int_{-\infty} ^ {+\infty}f(t) e ^ {-t ^ 2}dt \approx \sum_{r = 1} ^ R \omega_r f(t_r)
\]</span> where <span class="math inline">\(R\)</span> is the number of points for which the function is evaluated, <span class="math inline">\(t_r\)</span> are called the nodes and <span class="math inline">\(\omega_r\)</span> the weights. For a log-normal variable, <span class="math inline">\(\mbox{E}(x) = e ^ {\mu + 0.5 \sigma ^ 2}\)</span> and <span class="math inline">\(\mbox{V}(x) = e ^ {2\mu + \sigma ^ 2}(e ^ {\sigma ^ 2} - 1)\)</span>. As, we set <span class="math inline">\(\mu\)</span> to 0, <span class="math inline">\(\mbox{E}(y_n\mid x_n) = \mbox{E}_\nu\left(\mbox{E}(y_n\mid, x_n, \nu)\right) = e^{\frac{1}{2}\sigma ^ 2}\mu_n\)</span>. Moreover, <span class="math inline">\(\mbox{E}_\nu\left(\mbox{V}(y_n\mid, x_n, \nu)\right) = e^{\frac{1}{2}\sigma ^ 2}\mu_n\)</span> and <span class="math inline">\(\mbox{V}_\nu(\mbox{E}(y_n\mid, x_n, \nu)) = \mu_n ^ 2 e ^ {\sigma ^ 2}(e ^ {\sigma ^ 2} - 1)\)</span> so that:</p>
<p><span id="eq-var_lognorm"><span class="math display">\[
\mbox{V}(y_n \mid x_n) = e^{\frac{1}{2}\sigma ^ 2}\mu_n + e ^ {\sigma ^ 2}(e ^ {\sigma ^ 2} - 1) \mu_n ^ 2 =
\left(1 + (e ^ {\sigma ^ 2} - 1)\mbox{E}(y \mid  x_n)\right) \mbox{E}(y_n \mid  x_n)
\tag{12.11}\]</span></span> </p>
<p>We then estimate the Poisson model and the three mixed models we’ve just described. The <code><a href="https://rdrr.io/pkg/micsr/man/poisreg.html">micsr::poisreg</a></code> function enables the estimation of this mixed models. It has a <code>mixing</code> argument. If <code>mixing = "none"</code> (the default), the basic Poisson model is estimated. Setting <code>mixing</code> to <code>"gamma"</code> and <code>"lognorm"</code> result respectively in the Negbin and the Log-normal-Poisson models. For the Negbin model, the two different flavors are obtained by setting <code>vlink</code> either to <code>"nb1"</code> (the default) or to <code>"nb2"</code> to get respectively the Negbin1 and the Negbin2 models.<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a> The results are presented in <a href="#tbl-mixed_models">Table&nbsp;<span>12.1</span></a>. </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pois</span> <span class="op">&lt;-</span> <span class="fu">poisreg</span><span class="op">(</span><span class="va">trips</span> <span class="op">~</span> <span class="va">workschl</span> <span class="op">+</span> <span class="va">size</span> <span class="op">+</span> <span class="va">dist</span> <span class="op">+</span> <span class="va">smsa</span> <span class="op">+</span> <span class="va">fulltime</span> <span class="op">+</span> </span>
<span>                  <span class="va">distnod</span> <span class="op">+</span> <span class="va">realinc</span> <span class="op">+</span> <span class="va">weekend</span> <span class="op">+</span> <span class="va">car</span>, <span class="va">trips</span><span class="op">)</span></span>
<span><span class="va">nb1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">pois</span>, mixing <span class="op">=</span> <span class="st">"gamma"</span>, vlink <span class="op">=</span> <span class="st">"nb1"</span><span class="op">)</span></span>
<span><span class="va">nb2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">pois</span>, mixing <span class="op">=</span> <span class="st">"gamma"</span>, vlink <span class="op">=</span> <span class="st">"nb2"</span><span class="op">)</span></span>
<span><span class="va">ln</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">pois</span>, mixing <span class="op">=</span> <span class="st">"lognorm"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The most striking result is the improvement of the fit. The coefficient of <span class="math inline">\(\sigma\)</span> in the three specifications is highly significant, and the AIC or the BIC conclude that the mixed models are much better than the Poisson model. Using these indicators, it is difficult to discriminate between these three models because the AIC and the BIC are almost the same. The standard errors are much higher for the mixed models compared to the Poisson model, but remember that, when overdispersion is present, the standard errors of the Poisson model are downward biased. Using respectively <a href="#eq-var_negbin1">Equation&nbsp;<span>12.10</span></a>, <a href="#eq-var_negbin2">Equation&nbsp;<span>12.9</span></a> and <a href="#eq-var_lognorm">Equation&nbsp;<span>12.11</span></a>, we compute the ratio of the variance and the expectation at the sample mean for the three models, i.e., using <span class="math inline">\(\bar{y}\)</span> instead of <span class="math inline">\(\mbox{E}(y \mid x_n)\)</span> in the three formulas:</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="tbl-mixed_models" class="anchored">

<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<caption>Table&nbsp;12.1:  Mixed models for the demand for trips </caption>
 <thead><tr>
<th style="text-align:left;">   </th>
   <th style="text-align:center;"> poisson </th>
   <th style="text-align:center;"> Negbin1 </th>
   <th style="text-align:center;"> &nbsp;Negbin2 </th>
   <th style="text-align:center;"> Log-normal </th>
  </tr></thead>
<tbody>
<tr>
<td style="text-align:left;"> (Intercept) </td>
   <td style="text-align:center;"> −0.570 </td>
   <td style="text-align:center;"> −0.402 </td>
   <td style="text-align:center;"> −0.628 </td>
   <td style="text-align:center;"> −0.908 </td>
  </tr>
<tr>
<td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.125) </td>
   <td style="text-align:center;"> (0.180) </td>
   <td style="text-align:center;"> (0.161) </td>
   <td style="text-align:center;"> (0.168) </td>
  </tr>
<tr>
<td style="text-align:left;"> workschl </td>
   <td style="text-align:center;"> −0.456 </td>
   <td style="text-align:center;"> −0.205 </td>
   <td style="text-align:center;"> −0.365 </td>
   <td style="text-align:center;"> −0.296 </td>
  </tr>
<tr>
<td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.070) </td>
   <td style="text-align:center;"> (0.107) </td>
   <td style="text-align:center;"> (0.136) </td>
   <td style="text-align:center;"> (0.132) </td>
  </tr>
<tr>
<td style="text-align:left;"> size </td>
   <td style="text-align:center;"> 0.167 </td>
   <td style="text-align:center;"> 0.151 </td>
   <td style="text-align:center;"> 0.176 </td>
   <td style="text-align:center;"> 0.179 </td>
  </tr>
<tr>
<td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.012) </td>
   <td style="text-align:center;"> (0.021) </td>
   <td style="text-align:center;"> (0.024) </td>
   <td style="text-align:center;"> (0.026) </td>
  </tr>
<tr>
<td style="text-align:left;"> dist </td>
   <td style="text-align:center;"> −0.002 </td>
   <td style="text-align:center;"> −0.001 </td>
   <td style="text-align:center;"> −0.002 </td>
   <td style="text-align:center;"> −0.001 </td>
  </tr>
<tr>
<td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.001) </td>
   <td style="text-align:center;"> (0.002) </td>
   <td style="text-align:center;"> (0.002) </td>
   <td style="text-align:center;"> (0.002) </td>
  </tr>
<tr>
<td style="text-align:left;"> smsa </td>
   <td style="text-align:center;"> −0.031 </td>
   <td style="text-align:center;"> 0.049 </td>
   <td style="text-align:center;"> −0.030 </td>
   <td style="text-align:center;"> 0.017 </td>
  </tr>
<tr>
<td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.044) </td>
   <td style="text-align:center;"> (0.075) </td>
   <td style="text-align:center;"> (0.081) </td>
   <td style="text-align:center;"> (0.085) </td>
  </tr>
<tr>
<td style="text-align:left;"> fulltime </td>
   <td style="text-align:center;"> 0.248 </td>
   <td style="text-align:center;"> 0.251 </td>
   <td style="text-align:center;"> 0.318 </td>
   <td style="text-align:center;"> 0.327 </td>
  </tr>
<tr>
<td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.026) </td>
   <td style="text-align:center;"> (0.044) </td>
   <td style="text-align:center;"> (0.056) </td>
   <td style="text-align:center;"> (0.055) </td>
  </tr>
<tr>
<td style="text-align:left;"> distnod </td>
   <td style="text-align:center;"> 0.005 </td>
   <td style="text-align:center;"> 0.006 </td>
   <td style="text-align:center;"> 0.005 </td>
   <td style="text-align:center;"> 0.006 </td>
  </tr>
<tr>
<td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.001) </td>
   <td style="text-align:center;"> (0.002) </td>
   <td style="text-align:center;"> (0.002) </td>
   <td style="text-align:center;"> (0.003) </td>
  </tr>
<tr>
<td style="text-align:left;"> realinc </td>
   <td style="text-align:center;"> 0.019 </td>
   <td style="text-align:center;"> 0.015 </td>
   <td style="text-align:center;"> 0.020 </td>
   <td style="text-align:center;"> 0.015 </td>
  </tr>
<tr>
<td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.006) </td>
   <td style="text-align:center;"> (0.011) </td>
   <td style="text-align:center;"> (0.013) </td>
   <td style="text-align:center;"> (0.017) </td>
  </tr>
<tr>
<td style="text-align:left;"> weekend </td>
   <td style="text-align:center;"> −0.074 </td>
   <td style="text-align:center;"> −0.119 </td>
   <td style="text-align:center;"> −0.018 </td>
   <td style="text-align:center;"> −0.070 </td>
  </tr>
<tr>
<td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.049) </td>
   <td style="text-align:center;"> (0.084) </td>
   <td style="text-align:center;"> (0.090) </td>
   <td style="text-align:center;"> (0.092) </td>
  </tr>
<tr>
<td style="text-align:left;"> car </td>
   <td style="text-align:center;"> 1.413 </td>
   <td style="text-align:center;"> 1.195 </td>
   <td style="text-align:center;"> 1.304 </td>
   <td style="text-align:center;"> 1.314 </td>
  </tr>
<tr>
<td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.123) </td>
   <td style="text-align:center;"> (0.174) </td>
   <td style="text-align:center;"> (0.155) </td>
   <td style="text-align:center;"> (0.159) </td>
  </tr>
<tr>
<td style="text-align:left;"> sigma </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> 2.394 </td>
   <td style="text-align:center;"> 0.485 </td>
   <td style="text-align:center;"> 0.683 </td>
  </tr>
<tr>
<td style="text-align:left;box-shadow: 0px 1.5px">  </td>
   <td style="text-align:center;box-shadow: 0px 1.5px">  </td>
   <td style="text-align:center;box-shadow: 0px 1.5px"> (0.239) </td>
   <td style="text-align:center;box-shadow: 0px 1.5px"> (0.047) </td>
   <td style="text-align:center;box-shadow: 0px 1.5px"> (0.041) </td>
  </tr>
<tr>
<td style="text-align:left;"> Num.Obs. </td>
   <td style="text-align:center;"> 577 </td>
   <td style="text-align:center;"> 577 </td>
   <td style="text-align:center;"> 577 </td>
   <td style="text-align:center;"> 577 </td>
  </tr>
<tr>
<td style="text-align:left;"> AIC </td>
   <td style="text-align:center;"> 3340.9 </td>
   <td style="text-align:center;"> 2780.9 </td>
   <td style="text-align:center;"> 2779.6 </td>
   <td style="text-align:center;"> 2780.1 </td>
  </tr>
<tr>
<td style="text-align:left;"> BIC </td>
   <td style="text-align:center;"> 3384.5 </td>
   <td style="text-align:center;"> 2828.9 </td>
   <td style="text-align:center;"> 2827.6 </td>
   <td style="text-align:center;"> 2828.1 </td>
  </tr>
<tr>
<td style="text-align:left;"> Log.Lik. </td>
   <td style="text-align:center;"> −1660.440 </td>
   <td style="text-align:center;"> −1379.459 </td>
   <td style="text-align:center;"> −1378.811 </td>
   <td style="text-align:center;"> −1379.061 </td>
  </tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">sig_nb1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">nb1</span><span class="op">)</span><span class="op">[</span><span class="st">"sigma"</span><span class="op">]</span></span>
<span><span class="va">sig_nb2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">nb2</span><span class="op">)</span><span class="op">[</span><span class="st">"sigma"</span><span class="op">]</span></span>
<span><span class="va">sig_ln</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">ln</span><span class="op">)</span><span class="op">[</span><span class="st">"sigma"</span><span class="op">]</span></span>
<span><span class="va">yb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">trips</span><span class="op">$</span><span class="va">trips</span><span class="op">)</span></span>
<span><span class="fl">1</span> <span class="op">+</span> <span class="va">sig_nb1</span></span>
<span><span class="co">## sigma </span></span>
<span><span class="co">## 3.394</span></span>
<span><span class="fl">1</span> <span class="op">+</span> <span class="va">sig_nb2</span> <span class="op">*</span> <span class="va">yb</span></span>
<span><span class="co">## sigma </span></span>
<span><span class="co">## 3.207</span></span>
<span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">sig_ln</span> <span class="op">^</span> <span class="fl">2</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="va">yb</span><span class="op">)</span></span>
<span><span class="co">## sigma </span></span>
<span><span class="co">## 3.707</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Therefore, the three mixing models predict the same level of overdispersion, the conditional variance being about 3.5 times larger than the conditional expectation. This value should be compared to the ratio of the sample variance (24.4) and the sample mean (4.6), which is (5.4). <a href="#fig-rootograms_mixed">Figure&nbsp;<span>12.4</span></a> presents the rootogram for the Poisson and the Negbin model. We can see that taking into account the overdispersion using a mixing model resolves most of the overdispersion problem. </p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-rootograms_mixed" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="count_files/figure-html/fig-rootograms_mixed-1.png" class="img-fluid figure-img" style="width:60.0%"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;12.4: Rootograms for the Poisson and the Negbin model</figcaption><p></p>
</figure>
</div>
</div>
</div>
</section><section id="hurdle-and-zip-models" class="level3"><h3 class="anchored" data-anchor-id="hurdle-and-zip-models">Hurdle and ZIP models</h3>
<p>As we have seen previously for the <code>trips</code> data set, it seems that the Poisson model is unable to model correctly the probability of <span class="math inline">\(y = 0\)</span>. Different phenomena can explain zero values:</p>
<ul>
<li>some people may never (or almost never) take a trip out of the house because, for example, of a bad physical condition,</li>
<li>some people may take a trip infrequently (for example, twice a week) so that a 0 value may be reported if the survey concerns a Tuesday as the individual has taken a trip on Monday and Thursday.</li>
</ul>
<p>This question of zero vs.&nbsp;positive observations is closely related to the analysis of consumption expenditures based on individual data for which the value is 0 for a large part of the sample. For example, a large share of the individuals in the sample will report a null consumption of tobacco simply because they don’t smoke. Some other individuals will report a null consumption of fish because fish is bought infrequently (once a month, for example) and the length of the survey is 2 weeks.</p>
<section id="hurdle-models" class="level4"><h4 class="anchored" data-anchor-id="hurdle-models">Hurdle models</h4>
<p> For the first situation, <span class="citation" data-cites="CRAG:71">Cragg (<a href="#ref-CRAG:71" role="doc-biblioref">1971</a>)</span> proposed the hurdle model (presented in <a href="tobit.html#sec-tobit2"><span>Section&nbsp;11.6</span></a>), for which the level of consumption of a good is taken into account by two different models:</p>
<ul>
<li>a binomial model that explains the fact that the expenditure is zero or positive,</li>
<li>a model that explains the level of the expenditure if it is positive.</li>
</ul>
<p>This hurdle model has been adapted to count data by <span class="citation" data-cites="MULL:86">Mullahy (<a href="#ref-MULL:86" role="doc-biblioref">1986</a>)</span>. The first model returns the probability that <span class="math inline">\(y=0\)</span>. Therefore, the response is <span class="math inline">\(d_n=\mathbf{1}(y_n &gt; 0)\)</span>, which takes the two values of 0 (<span class="math inline">\(y_n\)</span> is 0) and 1 (<span class="math inline">\(y_n\)</span> is strictly positive). A set of covariates <span class="math inline">\(z_1\)</span> is used for this model, with corresponding coefficients denoted by <span class="math inline">\(\gamma_1\)</span>. For example, using a probit model, we would have <span class="math inline">\(\mbox{P}(d_n = 1) = \Phi(\gamma_1 ^ \top z_1)\)</span>. Another choice is to use a count distribution to modelize the probability that <span class="math inline">\(d_n = 0\)</span>. For example, using the Poisson distribution (<span class="math inline">\(\mbox{P}(y) = e^ {-\theta}\theta ^ y / y!\)</span>) and the log link (<span class="math inline">\(\theta = \exp(\gamma_1 ^ \top z_1\)</span>) we have <span class="math inline">\(\mbox{P}(d_n = 0) = \exp(e ^ {-\gamma_1 ^ \top z_1})\)</span>. Therefore the first model writes:</p>
<p><span id="eq-hurdle_part1"><span class="math display">\[
\left(\exp\left(- e^{\gamma_1 ^ \top z_{n1}}\right)\right)^{d_n}
\left(1 - \exp\left(-e^{\gamma_1 ^ \top z_{n1}}\right)\right) ^ {1 - d_n}
\tag{12.12}\]</span></span></p>
<p>The second model concerns the zero left-truncated sample, i.e., the subsample of individuals for which <span class="math inline">\(y&gt;0\)</span>. Any count model can be used, but the probabilities returned by the chosen distribution for every positive value of <span class="math inline">\(y\)</span> should be divided by their sum, so that they sum to 1. If once again, the Poisson distribution is used, the probabilities for positive values of <span class="math inline">\(y\)</span> are:</p>
<p><span id="eq-hurdle_part2"><span class="math display">\[
\displaystyle\frac{\exp\left(- e^{\gamma_2 ^ \top z_{n2}}\right) e^{y_n\gamma_2^\top z_{n2}} /
y_n !}{1 - \exp\left(- e^{\gamma_2 ^ \top z_{n2}}\right)}
\tag{12.13}\]</span></span></p>
<p>The hurdle model is a <strong>finite mixture</strong> obtained by combining the two distributions, one that generates the zero values and the other one that generates the positive values. As the two components of the hurdle model depend on a specific parameter’s vector (<span class="math inline">\(\gamma_1\)</span> and <span class="math inline">\(\gamma_2\)</span>), the estimation can be performed by independently fitting the two models. The general expression for the probability of one observation is the product of the two previous probabilities:</p>
<p><span class="math display">\[
\left(\exp\left(- e^{\gamma_1 ^ \top z_{n1}}\right)\right)^{1 - d_n}
\left(\frac{1 - \exp\left(-e^{\gamma_1 ^ \top z_{n1}}\right)}
{1 - \exp\left(-e^{\gamma_2 ^ \top z_{n2}}\right)}
\right) ^{d_n}
\left(\frac{\exp\left(- e^{\gamma_2 ^ \top z_{n2}}\right) e^{y_n\gamma_2^\top z_{n2}}}{y_n !}\right)^{1 - d_n}
\]</span></p>
<p>This expression illustrates the interest of using the same distribution (here the Poisson distribution) for the two parts of the model. In this case, if <span class="math inline">\(z_1 = z_2\)</span>, i.e., if the same set of covariates is used in the two models, the hurdle model is nested in the simple count model, the null hypothesis of the simple model being: <span class="math inline">\(\mbox{H}_0: \gamma_1 = \gamma_2\)</span>. The <strong>zero-inflated Poisson</strong> (or <strong>ZIP</strong> model),<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a> proposed by <span class="citation" data-cites="LAMB:92">Lambert (<a href="#ref-LAMB:92" role="doc-biblioref">1992</a>)</span> starts from a count model, for example a Poisson with a set of covariates denoted by <span class="math inline">\(z_2\)</span>, and corresponding coefficients <span class="math inline">\(\gamma_2\)</span>. The probability of 0 (<span class="math inline">\(e^{-\gamma_2^\top z_{n2}}\)</span>) is inflated using a further parameter <span class="math inline">\(\psi_n\)</span> between 0 and 1:</p>
<p><span class="math display">\[
P(Y = 0 | x_n) = \psi_n + (1 - \psi_n) e^{-\gamma_2^\top
z_{n2}} = e^{-\gamma_2^\top z_{n2}} + \psi_n \left(1 - e^{-\gamma_2^\top
z_{n2}}\right) &gt; e^{-\gamma_2^\top z_{n2}}
\]</span> The Poisson’s probabilities for positive values of <span class="math inline">\(y\)</span> are then deflated by <span class="math inline">\((1 - \psi_n)\)</span>, so that the probabilities for all the possible values of <span class="math inline">\(y\)</span> (0 and positive) sums to 1:</p>
<p><span class="math display">\[
\mbox{P}(y_n | z_{n2}) = (1 - \psi_n) \frac{e^{-\mu_n}\mu_n ^y}{y!} \mbox{ for
} y_n &gt; 0
\]</span></p>
<p><span class="math inline">\(\phi_n\)</span> can be a constant, or a function of covariates (<span class="math inline">\(z_1\)</span>) that returns a value between 0 and 1. For example, a logistic specification can be used:</p>
<p><span class="math display">\[
\psi_n = \frac{e^{\gamma_1^\top z_{n1}}}{1 + e^{\gamma_1^\top z_{n1}}}
\]</span> Hurdle and ZIP models are implemented in the <strong>countreg</strong> package.<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a> <code><a href="https://rdrr.io/pkg/countreg/man/hurdle.html">countreg::hurdle</a></code> and <code><a href="https://rdrr.io/pkg/countreg/man/zeroinfl.html">countreg::zeroinfl</a></code> both have a <code>formula</code> and a <code>dist</code> argument. The first is a two-part formula where the first part describes <span class="math inline">\(x_1\)</span> and the second <span class="math inline">\(x_2\)</span>. If a one-part formula is provided, the same set of covariates is used for the two parts of the model. The second a character indicating the count model family (<code>"poisson"</code> and <code>"negbin"</code> are the most common choices). <code><a href="https://rdrr.io/pkg/countreg/man/hurdle.html">countreg::hurdle</a></code> has a <code>zero.dist</code> argument which is a character indicating the distribution for the binomial part of the model (<code>"poisson"</code>, <code>"negbin"</code> or <code>"binomial"</code>; in the latter case, the link can be indicated using the <code>link</code> argument). The link used for <span class="math inline">\(\psi_n\)</span> is indicated in <code><a href="https://rdrr.io/pkg/countreg/man/zeroinfl.html">countreg::zeroinfl</a></code> by the <code>link</code> argument. </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">hdl_pois</span> <span class="op">&lt;-</span> <span class="fu">countreg</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/countreg/man/hurdle.html">hurdle</a></span><span class="op">(</span><span class="va">trips</span> <span class="op">~</span> <span class="va">workschl</span> <span class="op">+</span> <span class="va">size</span> <span class="op">+</span> <span class="va">dist</span> <span class="op">+</span> <span class="va">smsa</span> <span class="op">+</span> </span>
<span>                               <span class="va">fulltime</span> <span class="op">+</span> <span class="va">distnod</span> <span class="op">+</span> <span class="va">realinc</span> <span class="op">+</span> <span class="va">weekend</span> <span class="op">+</span> </span>
<span>                               <span class="va">car</span>, dist <span class="op">=</span> <span class="st">"poisson"</span>, </span>
<span>                             zero.dist <span class="op">=</span> <span class="st">"poisson"</span>, <span class="va">trips</span><span class="op">)</span></span>
<span><span class="va">hdl_nb2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">hdl_pois</span>, dist <span class="op">=</span> <span class="st">"negbin"</span>, zero.dist <span class="op">=</span> <span class="st">"negbin"</span>, <span class="va">trips</span><span class="op">)</span></span>
<span><span class="va">zip_pois</span> <span class="op">&lt;-</span> <span class="fu">countreg</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/countreg/man/zeroinfl.html">zeroinfl</a></span><span class="op">(</span><span class="va">trips</span> <span class="op">~</span> <span class="va">workschl</span> <span class="op">+</span> <span class="va">size</span> <span class="op">+</span> <span class="va">dist</span> <span class="op">+</span> <span class="va">smsa</span> <span class="op">+</span> </span>
<span>                               <span class="va">fulltime</span> <span class="op">+</span> <span class="va">distnod</span> <span class="op">+</span> <span class="va">realinc</span> <span class="op">+</span> <span class="va">weekend</span> <span class="op">+</span> </span>
<span>                               <span class="va">car</span>, dist <span class="op">=</span> <span class="st">"poisson"</span>, <span class="va">trips</span><span class="op">)</span></span>
<span><span class="va">zip_nb2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">zip_pois</span>, dist <span class="op">=</span> <span class="st">"negbin"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The rootograms for the Hurdle and the ZIP models are presented in <a href="#fig-root_nb2_hurdle_zip">Figure&nbsp;<span>12.5</span></a>. Using the AIC criteria, we can now compare all the models estimated in this section. The AIC of the basic model is: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/AIC.html">AIC</a></span><span class="op">(</span><span class="va">pois</span><span class="op">)</span></span>
<span><span class="co">## [1] 3341</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Adding either overdispersion (using a Negbin model) or an excess of 0 (using either a hurdle or a ZIP model) leads to: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/AIC.html">AIC</a></span><span class="op">(</span><span class="va">nb2</span><span class="op">)</span></span>
<span><span class="co">## [1] 2780</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/AIC.html">AIC</a></span><span class="op">(</span><span class="va">hdl_pois</span><span class="op">)</span></span>
<span><span class="co">## [1] 3009</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/AIC.html">AIC</a></span><span class="op">(</span><span class="va">zip_pois</span><span class="op">)</span></span>
<span><span class="co">## [1] 3028</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The performance of the hurdle model is slightly better than the ZIP model. The AIC is much less than the one of the Poisson model, but much larger than the one of the Negbin2 model. </p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-root_nb2_hurdle_zip" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="count_files/figure-html/fig-root_nb2_hurdle_zip-1.png" class="img-fluid figure-img" style="width:60.0%"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;12.5: Rootograms for the Negbin2, Hurdle and ZIP models</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Finally the Negbin2 hurdle or zip model can be compared either to the Negbin2 Poisson model (for which the treatment of excess of 0 is added) or to the hurdle or zip Poisson model (for which the treatment of overdispersion is added): </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/AIC.html">AIC</a></span><span class="op">(</span><span class="va">hdl_nb2</span><span class="op">)</span></span>
<span><span class="co">## [1] 2643</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/AIC.html">AIC</a></span><span class="op">(</span><span class="va">zip_nb2</span><span class="op">)</span></span>
<span><span class="co">## [1] 2699</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The AICs of these two models are much lower than the ones of their particular cases (<code>hdl_pois</code> and <code>nb2</code> for the first one <code>zip_pois</code> and <code>nb2</code> for the second one). Therefore, the conclusion of this analysis is that either the ZIP or the hurdle Negbin model should be favored. The rootograms for these two models are presented on <a href="#fig-root_exc0_nb">Figure&nbsp;<span>12.6</span></a>. </p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-root_exc0_nb" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="count_files/figure-html/fig-root_exc0_nb-1.png" class="img-fluid figure-img" style="width:60.0%"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;12.6: Rootograms for the Negbin Hurdle and ZIP models</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p> </p>
<!-- ## Panel data -->
<!-- ### Fixed effects model -->
<!-- Fixed effects Poisson and NegBin models are proposed by @HAUS:HALL:GRIL:84 . -->
<!-- #### Poisson model -->
<!-- The fixed effects Poisson model is very specific as it doesn't suffer -->
<!-- from the incidental parameter problem and can therefore be obtained -->
<!-- either by estimating the individual effects or by using a sufficient -->
<!-- statistic^[[see chap. 9 @CAME:TRIV:13].]. -->
<!-- In a panel context, the Poisson parameter for individual $\n$ in -->
<!-- period $\t$ is written: -->
<!-- $$ -->
<!-- \poispar_{\n \t}=\id_\n\poiscov_{\n \t}=\id_\n e^{\coef^\top \x_{\n \t}} -->
<!-- $$ -->
<!-- which means that the individual effect is multiplicative. For a given -->
<!-- value of the individual effect, the probability of observing -->
<!-- $\y_{\n \t}$ is: -->
<!-- $$ -->
<!-- \PR(\y_{\n \t} \mid x_{\n \t},\id_\n,\beta)= -->
<!-- \frac{e^{-\poispar_{\n \t}}\poispar_{\n \t}^{\y_{\n \t}}}{\y_{\n \t}!}  = -->
<!-- \frac{e^{-\id_\n\poiscov_{\n \t}}(\id_\n\poiscov_{\n \t})^{\y_{\n \t}}}{\y_{\n \t}!} -->
<!-- $$ -->
<!-- Let $\sumy_\n=\sum_{\t=1}^\T \y_{\n \t}$ be the sum of all the values of -->
<!--   the response for individual $\n$ and -->
<!--   $\sumpois_\n=\sum_{\t=1}^\T \poiscov_{\n \t}$ the sum of the Poisson -->
<!--   parameters. A sum of Poisson variables follows a Poisson -->
<!--   distribution with parameter equal to the sum of the parameters of -->
<!--   the summed variables. We therefore have: -->
<!-- $$ -->
<!-- \PR(\sumy_\n \mid x_\n,\id_\n,\beta)= -->
<!-- \frac{e^{-\id_\n\sumpois_\n}(\id_\n \sumpois_\n)^{\sumy_\n}}{\sumy_\n!} -->
<!-- $$ {#eq-sumy} -->
<!--   Let $\y_\n=(\y_{i1},\y_{i2},\ldots,\y_{\n \t})$ be the vector of values -->
<!--   of $\y$ for individual $\n$. We then have: -->
<!-- $$ -->
<!-- \PR(\y_\n \mid x_\n,\id_\n,\beta) = -->
<!-- \frac{e^{-\id_\n\sum_{\t=1}^\T\poiscov_{\n \t}}\prod_{\t=1}^\T(\id_\n\poiscov_{\n \t})^{\y_{\n \t}}}{\prod_{\t=1}^\T \y_{\n \t}!} -->
<!-- = -->
<!-- \frac{e^{-\id_\n\sumpois_{i}}\id_\n^{\sumy_\n}\prod_{\t=1}^\T\poiscov_{\n \t}^{\y_{\n \t}}}{\prod_{\t=1}^\T \y_{\n \t}!} -->
<!-- $$ {#eq-vecty} -->
<!-- Applying Bayes' theorem, we obtain: -->
<!-- $$ -->
<!-- \PR(\y_\n\mid x_\n, \id_\n, \beta)=\PR(\y_\n\mid x_\n, -->
<!-- \id_\n,\beta, \sumy_\n)\PR(\sumy_\n\mid x_\n, \id_\n, \beta) -->
<!-- $$ -->
<!--   i.e., the joint probability of the components of $\y_\n$ is -->
<!--   the product of the conditional probability of $\y_\n$ given $\sumy_\n$ -->
<!--   and the marginal distribution of $\sumy_\n$. This conditional -->
<!--   probability is: -->
<!-- $$ -->
<!-- \PR(\y_\n\mid x_\n, \id_\n, \beta, \sumy_\n) -->
<!-- =\frac{\PR(\y_\n\mid x_\n,\id_\n,\beta)} -->
<!-- {\PR(\sumy_\n\mid x_\n,\id_\n,\beta)} -->
<!-- $$ -->
<!-- which implies: -->
<!-- $$ -->
<!-- \PR(\y_\n\mid x_\n,\beta,\sumy_\n)= -->
<!-- \frac{\sumy_\n!}{\sumpois_\n^{\sumy_\n}}\prod_{\t=1}^\T\frac{\poiscov_{\n \t}^{\y_{\n \t}}}{\y_{\n \t}!} -->
<!-- $$ {#eq-pwith} -->
<!--   As for the logit model, $\sumy_\n$ is a sufficient statistic, which -->
<!--   means that it allows to get rid of the individual effects. Taking -->
<!--   the logarithm of this expression and summing over all individuals, -->
<!--   we obtain the within Poisson model: -->
<!-- $$ -->
<!-- \ln L (\y \mid x, \beta, \sumy)= -->
<!-- \sum_{\n=1}^\N\left(\ln \sumy_\n! - \sumy_\n \ln\sum_{\t=1}^\T\poiscov_{\n \t}+\sum_{\t=1}^\T\left(\y_{\n \t}\ln \poiscov_{\n \t}-\ln \y_{\n \t}!\right)\right) -->
<!-- $$ {#eq-loglwa} -->
<!--  or: -->
<!-- $$ -->
<!-- \begin{array}{rcl} -->
<!--   \ln L (\y \mid x, \beta, \sumy)&=& -->
<!--                                 \sum_{\n=1}^\N\left(\ln \sumy_\n! - \sum_{\t=1}^\T \ln \y_{\n \t}! + \sum_{\t=1}^\T \y_{\n \t} \ln\frac{\poiscov_{\n \t}}{\sum_{\t=1}^\T\poiscov_{\n \t}}\right) \\ -->
<!--                             &\propto& \sum_{\n=1}^\N\left(\sum_{\t=1}^\T \y_{\n \t} \ln\frac{\poiscov_{\n \t}}{\sum_{\t=1}^\T\poiscov_{\n \t}}\right) -->
<!-- \end{array} -->
<!-- $$ {#eq-loglw} -->
<!-- As stated previously, the Poisson model is not affected by the -->
<!--   incidental parameter problem, as the same estimator may be obtained -->
<!--   by estimating the individual effects. To show this result, we -->
<!--   take the logarithm of the joint probability for the $\T$ -->
<!--   observations of $\y$ for individual $\n$ (@eq-vecty), -->
<!--   in order to obtain the log likelihood function: -->
<!-- $$ -->
<!-- \ln \PR(\y_\n \mid x_\n,\id_\n,\beta) =-\id_\n\sum_t\poiscov_{\n \t} -->
<!-- + \sum_t\y_{\n \t}\ln(\id_\n\poiscov_{\n \t}) -\sum_t\ln \y_{\n \t}! -->
<!-- $$ {#eq-lvecty} -->
<!--   The first order condition for $\id_\n$ to maximise the log -->
<!--   likelihood function is: -->
<!-- $$ -->
<!-- \frac{\partial \ln \PR_\n}{\partial \id_\n} = -->
<!-- -\sum_t\poiscov_{\n \t}+\frac{1}{\id_\n}\sum_t\y_{\n \t} = 0 -->
<!-- $$ -->
<!--   which implies that: $\id_\n=\frac{\sum_t \y_{\n \t}}{\sum_t \poiscov_{\n \t}}$. -->
<!--   Introducing this expression in (@eq-lvecty) and summing over all -->
<!--   $\n$, we obtain the concentrated log-likelihood function: -->
<!-- $$ -->
<!-- \begin{array}{rcl} -->
<!-- \ln L_{\mbox{conc}}(\y \mid x,\beta) &=&\sum_\n\left(-\sumy_\n + \sumy_\n\ln \sumy_\n +\sum_t \y_{\n \t}\frac{\poiscov_{\n \t}}{\sum_t \poiscov_{\n \t}} - \sum_t \ln \y_{\n \t}!\right) \\ -->
<!-- &\propto& \sum_{\n=1}^\N\left(\sum_{\t=1}^\T \y_{\n \t} \ln\frac{\poiscov_{\n \t}}{\sum_{\t=1}^\T\poiscov_{\n \t}}\right) -->
<!-- \end{array} -->
<!-- $$ {#eq-llconc} -->
<!--   The two log-likelihood functions @eq-loglw} and -->
<!--   @eq-llconc are proportional, they therefore lead to the same -->
<!--   estimators of $\beta$. Moreover, if a logarithmic link is chosen, we -->
<!--   have: $\poiscov_{\n \t}=e^{\coef^\top \x}$. The likelihood is in -->
<!--   this case proportional to: -->
<!-- $$ -->
<!-- \Pi_{\n=1}^\N\Pi_{\t=1}^\T\left(\frac{e^{\coef^\top \x_{\n \t}}}{\sum_\t -->
<!--     e^{\coef^\top \x_{\n \t}}}\right)^{\y_{\n \t}} -->
<!-- $$ -->
<!--   which is similar to the likelihood of a multinomial logit -->
<!--   model for which $\N$ individuals -->
<!--   must choose one among $L$ exclusive alternatives. The difference is -->
<!--   that in this latter model $\y_{\n \t}$ is either equal to 0 or to 1 -->
<!--   and $\sum_{\t} \y_{\n \t}=1$, as in our context each $\y_{\n \t}$ is a -->
<!--   natural integer. -->
<!-- #### Negbin models -->
<!--   @HAUS:HALL:GRIL:84 also propose a fixed effects NegBin -->
<!--   model. We just present below without demonstration the joint -->
<!--   probability for individual $\n$: -->
<!-- $$ -->
<!-- \PR(\y_\n\mid x_\n, \beta, \sumy_\n) =  -->
<!-- \left(\prod_{\t=1}^\T\frac{\Gamma(\poiscov_{\n \t}+\y_{\n \t})}{\Gamma(\poiscov_{\n \t})\Gamma(\y_{\n \t}+1)}\right) -->
<!-- \frac{\Gamma(\sumpois_\n)\Gamma(\sumy_\n+1)}{\Gamma(\sumpois_\n+\sumy_\n)} -->
<!-- $$ {#eq-pnbwith} -->
<!-- \end{equation} -->
<!-- ### Random effects models -->
<!-- #### Poisson models -->
<!--   @HAUS:HALL:GRIL:84 also proposed a \emph{between} and a random -->
<!--   effects Poisson model, integrating out the relevant probabilities -->
<!--   (@eq-sumy and @eq-vecty respectively). A gamma distribution -->
<!--   hypothesis is made for the individual effects, with the following -->
<!--   density: -->
<!-- $$ -->
<!-- f(x,a,b)=\frac{a^b}{\Gamma(b)}e^{-ax}x^{b-1} -->
<!-- $$ -->
<!-- with: -->
<!-- $$ -->
<!-- \Gamma(z)=\int_0^{+\infty}t^{z-1}e^{-t}dt -->
<!-- $$ -->
<!--   the gamma function. The expected value and the variance of $x$ are -->
<!--   respectively: -->
<!-- $$\EV(x)=\frac{b}{a} \mbox{ and }  \mbox{V}(x)=\frac{b}{a^2}$$ -->
<!--   If the model contains an intercept, the expected value is not -->
<!--   identified and we can then suppose, whithout restriction, that it is -->
<!--   equal to 1, which implies $a=b$. We then obtain a gamma distribution -->
<!--   with one parameter (denoted $\gampar$): -->
<!-- $$ -->
<!-- f(\poisint)=\frac{\gampar^\gampar}{\Gamma(\gampar)}e^{-\gampar -->
<!--   \poisint}\poisint^{\gampar-1} -->
<!-- $$ -->
<!-- Integrating out the conditional probabilities (@eq-sumy and -->
<!--   @eq-vecty}), we obtain the unconditional probabilities for the -->
<!--   between and the random effects models: -->
<!-- $$ -->
<!-- \PR(\sumy_\n\mid \xp_\n, \beta) =  -->
<!-- \int_0^{+\infty}\PR(\sumy_\n,\xp_\n,\poisint,\coefp)f(\poisint)d\poisint -->
<!-- =\frac{{\sumpois_\n}^{\sumy_\n}}{\sumy_\n!}\frac{\gampar^\gampar}{\Gamma(\gampar)} -->
<!-- \frac{\Gamma(\sumy_\n+\gampar)}{(\sumpois_\n+\gampar)^{\sumy_\n+\gampar}} -->
<!-- $$ -->
<!-- $$ -->
<!-- \PR(\y_\n,\x_\n,\coef)= -->
<!-- \int_0^{+\infty}\PR(\y_\n,x_\n,\poisint,\beta)f(\poisint)d\poisint -->
<!-- =\prod_{\t=1}^\T\frac{\poiscov_{\n \t}^{\y_{\n \t}}}{\y_{\n \t}!} -->
<!-- \frac{\gampar^\gampar}{\Gamma(\gampar)} -->
<!-- \frac{\Gamma(\sumy_\n+\gampar)}{(\sumpois_\n+\gampar)^{\sumy_\n+\gampar}} -->
<!-- $$ -->
<!--   which leads to the following log likelihood functions: -->
<!-- $$ -->
<!-- \begin{array}{rcl} -->
<!-- \ln L (\sumy \mid \xp, \coefp)&=& -->
<!-- \sum_{\n=1}^\N\left[\sumy_\n\ln \sum_t \poiscov_{\n \t} - \ln \sumy_\n! +\gampar \ln \gampar\right. \\ -->
<!-- &-& \ln \Gamma(\gampar)+\ln \Gamma(\sumy_\n+\gampar)\\ -->
<!-- &-&\left. (\sumy_\n+\gampar)\ln \left(\sum_{\t=1}^\T\poiscov_{\n \t}+\gampar\right)\right] -->
<!-- \end{array} -->
<!-- $$ {#eq-loglb} -->
<!-- \end{equation} -->
<!-- $$ -->
<!-- \begin{array}{rcl} -->
<!--   \ln L (\y \mid \xp, \coefp)&=& -->
<!--   \sum_{\n=1}^\N\left[\sum_t\left(\y_{\n \t}\ln \poiscov_{\n \t} - \ln \y_{\n \t}!\right) +\gampar \ln \gampar\right. \\ -->
<!--   &-& \ln \Gamma(\gampar)+\ln \Gamma(\sumy_\n+\gampar) \\ -->
<!--    & -& \left.(\sumy_\n+\gampar)\ln \left(\sum_{\t=1}^\T\poiscov_{\n \t}+\gampar\right)\right] -->
<!-- \end{array} -->
<!-- $$ {#eq-loglr} -->
<!-- #### Negbin models -->
<!--   In addition to the Poisson, @HAUS:HALL:GRIL:84 also proposed -->
<!--   \emph{between} and random effects NegBin models. We just present -->
<!--   below without demonstration the joint probability for individual -->
<!--   $\n$. -->
<!-- $$ -->
<!-- \PR(\sumy_\n\mid \x_\n, \coefp)= -->
<!-- \frac{\Gamma(\sumpois_\n+\sumy_\n)}{\Gamma(\sumpois_\n)\Gamma(\sumy_\n+1)} -->
<!-- \frac{\Gamma(a+b)\Gamma(a+\sumpois_\n)\Gamma(b+\sumy_\n)} -->
<!-- {\Gamma(a)\Gamma(b)\Gamma(a+b+\sumpois_\n+\sumy_\n)} -->
<!-- $$ {#eq-pnbbet} -->
<!-- $$ -->
<!-- \PR(\y_\n,\x_\n,\coefp)= -->
<!-- \frac{\Gamma(a+b)\Gamma(a+\sumpois_\n)\Gamma(b+\sumy_\n)} -->
<!-- {\Gamma(a)\Gamma(b)\Gamma(a+b+\sumpois_\n+\sumy_\n)} -->
<!-- \left(\prod_{\t=1}^\T\frac{\Gamma(\poiscov_{\n \t}+\y_{\n \t})}{\Gamma(\poiscov_{\n \t})+\Gamma(\y_{\n \t}+1)}\right) -->
<!-- $$ {#eq-pnbre} -->
<!-- ```{r } -->
<!-- #| eval: true -->
<!-- #| cache: true -->
<!-- #| echo: false -->
<!-- form <- doctorco ~ sex + age + I(age ^ 2) + income + insurance + illness + actdays + hscore + chcond -->
<!-- ols <- lm(form, doctor_aus) -->
<!-- pois <- glm(form, doctor_aus, family = poisson) -->
<!-- qpois <- glm(form, doctor_aus, family = quasipoisson) -->
<!-- nb1 <- MASS::glm.nb(form, doctor_aus) -->
<!-- modelsummary::msummary(list(ols = ols, poisson =  pois, quasipois = qpois, "Negbin 2" = nb1), estimate = "{estimate} ({std.error})", statistic = NULL) -->
<!-- ``` -->
<!-- ```{r } -->
<!-- #| eval: false -->
<!-- #| echo: false -->
<!-- mdel <- p_majordrg -->
<!-- tb <- tibble(y = model.response(model.frame(mdel)), -->
<!--              mu = fitted(mdel), -->
<!--              e2 = (y - mu) ^ 2, -->
<!--              z = ( e2 - y) / mu) -->
<!-- nb1 <- lm(e2 ~ mu - 1, tb) -->
<!-- nb2 <- lm(e2 ~ mu + I(mu  ^2) - 1, tb) -->
<!-- ggplot(tb, aes(mu, e2)) + geom_point() + -->
<!-- #   scale_y_continuous(limits = c(0, 100)) + -->
<!--     geom_smooth(method = lm, formula = y ~ x - 1, se = FALSE) + -->
<!--     geom_smooth(method = lm, formula = y ~ x + I(x ^ 2) - 1, se = FALSE, color = 'red') -->
<!-- ggplot(tb, aes(mu, z)) + geom_point() + -->
<!-- #    coord_cartesian(ylim = c(-10, 50)) + -->
<!--     geom_smooth(method = lm, formula = y ~ 1, se = FALSE) + -->
<!--     geom_smooth(method = lm, formula = y ~ x - 1, se = FALSE, color = 'red') -->
<!-- countreg::disptest(cam_triv_86, type = "scoreNB1") -->
<!-- countreg::disptest(cam_triv_86, type = "scoreNB2") -->
<!-- mu <- fitted(cam_triv_86) -->
<!-- y <- model.response(model.frame(cam_triv_86)) -->
<!-- N <- nobs(cam_triv_86) -->
<!-- sum( ( (y - mu) ^ 2 - y) / mu) / sqrt(2 * N) -->
<!-- sum( ( (y - mu) ^ 2 - y)     ) / sqrt(2 * sum(mu ^ 2)) -->
<!-- lm( I( ((y - mu) ^ 2 - y) / mu) ~ mu - 1) %>% summary %>% coef %>% .[3] -->
<!-- ``` -->
<!-- ```{r } -->
<!-- N <- 1E05 -->
<!-- pz <- 0.3 -->
<!-- mu <- 2.5 -->
<!-- v <- dpois(0, mu) -->
<!-- M <- 20 -->
<!-- Probs <- c(pz, (1 - pz) * dpois(1:M, mu) / (1 - dpois(0, mu))) -->
<!-- S <- sample(0:M, size = N, replace = TRUE, prob = Probs) -->
<!-- c(mean(S), var(S)) -->
<!-- Eyp <- mu / (1 - v) -->
<!-- Vyp <- mu * (1 - v) - v * mu ^2 -->
<!-- c(Eyp, Vyp) -->
<!-- c(mean(S[S > 0]), var(S[S > 0])) -->
<!-- Ey <- (1 - pz) * Eyp -->
<!-- c(Eyp, Ey) -->
</section></section></section><section id="sec-endog_count" class="level2" data-number="12.4"><h2 data-number="12.4" class="anchored" data-anchor-id="sec-endog_count">
<span class="header-section-number">12.4</span> Endogeneity and selection</h2>
<section id="instrumental-variable-estimators-for-count-data" class="level3"><h3 class="anchored" data-anchor-id="instrumental-variable-estimators-for-count-data">Instrumental variable estimators for count data</h3>
<p> We’ve seen in <a href="endogeneity.html#sec-general_iv"><span>Section&nbsp;7.3</span></a> that, denoting <span class="math inline">\(W\)</span> the matrix of instruments, the IV estimator is <span class="math inline">\(\hat{\gamma} = (Z^\top P_W Z) ^ {-1} (Z^\top P_W y)\)</span> (<a href="endogeneity.html#eq-overidentified_iv">Equation&nbsp;<span>7.9</span></a>) and the GMM estimator is <span class="math inline">\(\hat{\gamma} = \left(Z^\top W \hat{S}^{-1} W ^ \top Z\right)^{-1}Z^\top W \hat{S}^{-1} W ^ \top y\)</span> (<a href="endogeneity.html#eq-two_steps_iv">Equation&nbsp;<span>7.10</span></a>), with <span class="math inline">\(\hat{S} = \sum_n \hat{\epsilon}_n ^ 2 w_n w_n^\top\)</span>, <span class="math inline">\(\hat{\epsilon}_n\)</span> being the residual of a consistent estimation.</p>
<section id="exponential-linear-conditional-mean-model" class="level4"><h4 class="anchored" data-anchor-id="exponential-linear-conditional-mean-model">Exponential linear conditional mean model</h4>
<p>The linear model is often inappropriate if the conditional distribution of <span class="math inline">\(y\)</span> is asymmetric. In this case, a common solution is to use <span class="math inline">\(\ln y\)</span> instead of <span class="math inline">\(y\)</span> as the response: <span class="math inline">\(\ln y_n = \gamma ^ \top z_n + \epsilon\)</span>. This is of course possible only if <span class="math inline">\(y_n &gt; 0\, \forall n\)</span>, which is usually not the case with count data. An alternative is to use an exponential linear conditional mean model <span class="citation" data-cites="MULL:97">(<a href="#ref-MULL:97" role="doc-biblioref">Mullahy 1997</a>)</span>, with additive (<span class="math inline">\(y_n = e^{\gamma^\top z_n} + \epsilon_n\)</span>) or multiplicative errors (<span class="math inline">\(y_n = e^{\gamma^\top z_n} \nu_n\)</span>). With additive errors, the empirical moments are then:</p>
<p><span class="math display">\[
\frac{1}{N}\sum_{n=1} ^ N (y_n  - e^{\gamma^\top z_n})w_n = W^\top (y  -
e^{Z\gamma}) / N
\]</span></p>
<p>If the errors are spherical, the variance of the empirical moments vector is: <span class="math inline">\(\sigma_{\epsilon} ^ 2 (W ^ \top W) / N ^2\)</span> and the IV estimator minimizes:</p>
<p><span class="math display">\[
\epsilon ^ \top W \left(\sigma ^ 2 W ^ \top W\right) ^ {-1} W ^ \top \epsilon/ \sigma ^ 2
= \epsilon ^ \top P_W \epsilon / \sigma ^  2
\]</span></p>
<p>Denoting <span class="math inline">\(\hat{\epsilon}\)</span> the residuals of this regression, the optimal weighting matrix <span class="math inline">\(\hat{S} = \sum_{n = 1} ^ N \hat{\epsilon}_n ^ 2 w_n w_n ^ \top\)</span> can be constructed and used in a second step to get the more efficient GMM estimator. With additive errors, the only difference with the linear case is that the minimization process results in a set of non linear equations, so that some numerical methods should be used. With multiplicative errors, we have: <span class="math inline">\(\nu_n = y_n / e^{\gamma^\top z_n}\)</span>. The moment conditions are then: <span class="math inline">\(\mbox{E}\left((y_n/e^{\gamma ^ \top z_n} - 1)^\top w_n\right)=0\)</span> which leads to the following empirical moments:</p>
<p><span class="math display">\[
\frac{1}{N}\sum_{n=1} ^ N (y_n/e^{\gamma^\top z_n} - 1)w_n = W^\top (y/
e^{Z^\top\gamma}- 1) / N = Z^\top \tau_n / N
\]</span> with <span class="math inline">\(\tau_n = y_n/e^{\gamma^\top z_n} - 1\)</span>. Minimizing the quadratic form of these empirical moments with <span class="math inline">\((W^\top W) ^{-1}\)</span> or <span class="math inline">\(\left(\sum_{n=1} ^ N \hat{\tau}_n ^ 2 w_n w_n^\top\right) ^ {- 1}\)</span> leads respectively to the IV and the GMM estimators. When the number of external instruments is greater that the number of endogenous variables, the Sargan test enables to test the hypothesis of exogeneity of all the instruments. The value of the objective function at convergence times the size of the sample is, under the null hypothesis that all the instruments are exogenous, a <span class="math inline">\(\chi^2\)</span> with a number of degrees of freedom equal to the difference between the number of instruments and the number of covariates. </p>
</section><section id="cigarette-smoking-behavior" class="level4"><h4 class="anchored" data-anchor-id="cigarette-smoking-behavior">Cigarette smoking behavior</h4>
<p><span class="citation" data-cites="MULL:97">Mullahy (<a href="#ref-MULL:97" role="doc-biblioref">1997</a>)</span> estimates a demand function for cigarettes which depends on the stock of smoking habits. This variable is quite similar to a lagged dependent variable and is likely to be endogenous as the unobservable determinants of current smoking behavior should be correlated with the unobservable determinants of past smoking behavior. The data set, called <code>cigmales</code>, contains observations of 6160 males in 1979 and 1980 from the smoking supplement to the 1979 National Health Interview Survey. The response <code>cigarettes</code> is the number of cigarettes smoked daily. The covariates are the habit “stock” <code>habit</code>, the current state-level average per-pack price of cigarettes <code>price</code>, a dummy indicating whether there is in the state of residence a restriction on smoking in restaurants <code>restaurant</code>, the age <code>age</code> and the number of years of schooling <code>educ</code> and their squares, the number of family members <code>famsize</code>, and a dummy <code>race</code> which indicates whether the individual is white or not. The external instruments are cubic terms in <code>age</code> and <code>educ</code> and their interaction, the one-year lagged price of a pack of cigarettes <code>lagprice</code> and the number of years the state’s restaurant smoking restrictions had been in place.</p>
<p>The starting point is a basic count model, i.e., a Poisson model with a log-link and robust standard errors: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">cigmales</span> <span class="op">&lt;-</span> <span class="va">cigmales</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>age2 <span class="op">=</span> <span class="va">age</span> <span class="op">^</span> <span class="fl">2</span>, educ2 <span class="op">=</span> <span class="va">educ</span> <span class="op">^</span> <span class="fl">2</span>,</span>
<span>           age3 <span class="op">=</span> <span class="va">age</span> <span class="op">^</span> <span class="fl">3</span>, educ3 <span class="op">=</span> <span class="va">educ</span> <span class="op">^</span> <span class="fl">3</span>,</span>
<span>           educage <span class="op">=</span> <span class="va">educ</span> <span class="op">*</span> <span class="va">age</span><span class="op">)</span>                                 </span>
<span><span class="va">pois_cig</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span><span class="va">cigarettes</span> <span class="op">~</span> <span class="va">habit</span> <span class="op">+</span> <span class="va">price</span> <span class="op">+</span> <span class="va">restaurant</span> <span class="op">+</span> <span class="va">income</span> <span class="op">+</span> </span>
<span>                  <span class="va">age</span> <span class="op">+</span> <span class="va">age2</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> <span class="va">educ2</span> <span class="op">+</span> <span class="va">famsize</span> <span class="op">+</span> <span class="va">race</span>, </span>
<span>                data <span class="op">=</span> <span class="va">cigmales</span>, family <span class="op">=</span> <span class="va">quasipoisson</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The IV and the GMM estimators are estimated using the <code><a href="https://rdrr.io/pkg/micsr/man/expreg.html">micsr::expreg</a></code> function. Its main argument is a two-part formula, the first part indicating the covariates and the second part the instruments. The <code>method</code> argument can be set to <code>"iv"</code> or <code>"gmm"</code> to estimate respectively the instrumental variable and the general method of moments estimators and the <code>error</code> argument can be equal to <code>"mult"</code> (the default) or <code>"add"</code> to select respectively multiplicative or additive errors. </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">iv_cig</span> <span class="op">&lt;-</span> <span class="fu">expreg</span><span class="op">(</span><span class="va">cigarettes</span> <span class="op">~</span> <span class="va">habit</span> <span class="op">+</span> <span class="va">price</span> <span class="op">+</span> <span class="va">restaurant</span> <span class="op">+</span> <span class="va">income</span> <span class="op">+</span> </span>
<span>                   <span class="va">age</span> <span class="op">+</span> <span class="va">age2</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> <span class="va">educ2</span> <span class="op">+</span> <span class="va">famsize</span> <span class="op">+</span> <span class="va">race</span> <span class="op">|</span> </span>
<span>                   <span class="va">.</span> <span class="op">-</span> <span class="va">habit</span> <span class="op">+</span> <span class="va">age3</span> <span class="op">+</span> <span class="va">educ3</span> <span class="op">+</span> <span class="va">educage</span> <span class="op">+</span> </span>
<span>                   <span class="va">lagprice</span> <span class="op">+</span> <span class="va">reslgth</span>, </span>
<span>                 data <span class="op">=</span> <span class="va">cigmales</span>, method <span class="op">=</span> <span class="st">"iv"</span><span class="op">)</span></span>
<span><span class="va">gmm_cig</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">iv_cig</span>, method <span class="op">=</span> <span class="st">"gmm"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div style="page-break-after: always;"></div>
<p>The results are presented in <a href="#tbl-cigarettes_iv">Table&nbsp;<span>12.2</span></a>. For the two flavors of instrumental variable estimators, the coefficient of <code>habit</code> is about half of the one of the Poisson model, indicating that this covariate is positively correlated with the unobserved determinants of smoking.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="tbl-cigarettes_iv" class="anchored">

<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<caption>Table&nbsp;12.2:  Cigarette consumption and smoking habits </caption>
 <thead><tr>
<th style="text-align:left;">   </th>
   <th style="text-align:center;"> ML </th>
   <th style="text-align:center;"> &nbsp;IV </th>
   <th style="text-align:center;"> GMM </th>
  </tr></thead>
<tbody>
<tr>
<td style="text-align:left;"> habit </td>
   <td style="text-align:center;"> 0.0055 </td>
   <td style="text-align:center;"> 0.0031 </td>
   <td style="text-align:center;"> 0.0032 </td>
  </tr>
<tr>
<td style="text-align:left;">  </td>
   <td style="text-align:center;"> (88.8791) </td>
   <td style="text-align:center;"> (1.2536) </td>
   <td style="text-align:center;"> (1.2009) </td>
  </tr>
<tr>
<td style="text-align:left;"> price </td>
   <td style="text-align:center;"> −0.0094 </td>
   <td style="text-align:center;"> −0.0106 </td>
   <td style="text-align:center;"> −0.0089 </td>
  </tr>
<tr>
<td style="text-align:left;">  </td>
   <td style="text-align:center;"> (−3.5253) </td>
   <td style="text-align:center;"> (−2.3333) </td>
   <td style="text-align:center;"> (−2.0623) </td>
  </tr>
<tr>
<td style="text-align:left;"> restaurant </td>
   <td style="text-align:center;"> −0.0469 </td>
   <td style="text-align:center;"> −0.0431 </td>
   <td style="text-align:center;"> −0.0619 </td>
  </tr>
<tr>
<td style="text-align:left;">  </td>
   <td style="text-align:center;"> (−1.4949) </td>
   <td style="text-align:center;"> (−0.7934) </td>
   <td style="text-align:center;"> (−1.0722) </td>
  </tr>
<tr>
<td style="text-align:left;"> income </td>
   <td style="text-align:center;"> −0.0028 </td>
   <td style="text-align:center;"> −0.0076 </td>
   <td style="text-align:center;"> −0.0064 </td>
  </tr>
<tr>
<td style="text-align:left;">  </td>
   <td style="text-align:center;"> (−1.7915) </td>
   <td style="text-align:center;"> (−2.9016) </td>
   <td style="text-align:center;"> (−2.3976) </td>
  </tr>
<tr>
<td style="text-align:left;"> age </td>
   <td style="text-align:center;"> 0.0087 </td>
   <td style="text-align:center;"> 0.0993 </td>
   <td style="text-align:center;"> 0.0928 </td>
  </tr>
<tr>
<td style="text-align:left;">  </td>
   <td style="text-align:center;"> (1.5697) </td>
   <td style="text-align:center;"> (2.8577) </td>
   <td style="text-align:center;"> (2.3338) </td>
  </tr>
<tr>
<td style="text-align:left;"> age2 </td>
   <td style="text-align:center;"> −0.0003 </td>
   <td style="text-align:center;"> −0.0013 </td>
   <td style="text-align:center;"> −0.0012 </td>
  </tr>
<tr>
<td style="text-align:left;">  </td>
   <td style="text-align:center;"> (−5.0396) </td>
   <td style="text-align:center;"> (−3.6384) </td>
   <td style="text-align:center;"> (−2.9454) </td>
  </tr>
<tr>
<td style="text-align:left;"> educ </td>
   <td style="text-align:center;"> 0.0353 </td>
   <td style="text-align:center;"> 0.1299 </td>
   <td style="text-align:center;"> 0.1408 </td>
  </tr>
<tr>
<td style="text-align:left;">  </td>
   <td style="text-align:center;"> (1.8457) </td>
   <td style="text-align:center;"> (3.0713) </td>
   <td style="text-align:center;"> (3.3685) </td>
  </tr>
<tr>
<td style="text-align:left;"> educ2 </td>
   <td style="text-align:center;"> −0.0031 </td>
   <td style="text-align:center;"> −0.0088 </td>
   <td style="text-align:center;"> −0.0093 </td>
  </tr>
<tr>
<td style="text-align:left;">  </td>
   <td style="text-align:center;"> (−3.7454) </td>
   <td style="text-align:center;"> (−3.9537) </td>
   <td style="text-align:center;"> (−4.1349) </td>
  </tr>
<tr>
<td style="text-align:left;"> famsize </td>
   <td style="text-align:center;"> −0.0081 </td>
   <td style="text-align:center;"> −0.0085 </td>
   <td style="text-align:center;"> −0.0119 </td>
  </tr>
<tr>
<td style="text-align:left;">  </td>
   <td style="text-align:center;"> (−1.0498) </td>
   <td style="text-align:center;"> (−0.6754) </td>
   <td style="text-align:center;"> (−0.9547) </td>
  </tr>
<tr>
<td style="text-align:left;"> racewhite </td>
   <td style="text-align:center;"> −0.0511 </td>
   <td style="text-align:center;"> −0.0311 </td>
   <td style="text-align:center;"> −0.0902 </td>
  </tr>
<tr>
<td style="text-align:left;box-shadow: 0px 1.5px">  </td>
   <td style="text-align:center;box-shadow: 0px 1.5px"> (−1.2462) </td>
   <td style="text-align:center;box-shadow: 0px 1.5px"> (−0.4485) </td>
   <td style="text-align:center;box-shadow: 0px 1.5px"> (−1.3005) </td>
  </tr>
<tr>
<td style="text-align:left;"> Num.Obs. </td>
   <td style="text-align:center;"> 6160 </td>
   <td style="text-align:center;"> 6160 </td>
   <td style="text-align:center;"> 6160 </td>
  </tr>
<tr>
<td style="text-align:left;"> F </td>
   <td style="text-align:center;"> 958.818 </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;">  </td>
  </tr>
<tr>
<td style="text-align:left;"> RMSE </td>
   <td style="text-align:center;"> 14.38 </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;">  </td>
  </tr>
</tbody>
</table>
</div>
</div>
</div>
<p>Computing the Sargan test: </p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># collapse: true</span></span>
<span><span class="fu">sargan</span><span class="op">(</span><span class="va">gmm_cig</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="va">gaze</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>chisq = 7.469, df: 4, pval = 0.113</code></pre>
</div>
</div>
<p>we conclude that the exogeneity of the instruments hypothesis is not rejected.</p>
</section></section><section id="sample-selection-and-endogenous-switching-for-count-data" class="level3"><h3 class="anchored" data-anchor-id="sample-selection-and-endogenous-switching-for-count-data">Sample selection and endogenous switching for count data</h3>
<p> In two seminal papers, Heckman <span class="citation" data-cites="HECK:76 HECK:79">(<a href="#ref-HECK:76" role="doc-biblioref">1976</a>, <a href="#ref-HECK:79" role="doc-biblioref">1979</a>)</span> considered the case where two variables are jointly determined, a binomial variable and an outcome continuous variable. For example, the continuous variable can be the wage and the binomial variable the labor force participation. In this case, the wage is observed only for the subsample of the individuals who work. If the unobserved determinants of labor force participation are correlated with the unobserved determinants of wage, estimating the wage equation only on the subset of individuals who work will result in an inconsistent estimator. This case is called the <strong>sample selection</strong> model and has been presented in <a href="tobit.html#sec-tobit2"><span>Section&nbsp;11.6</span></a>. Consider now the case where the binomial variable is a a dummy for private vs public sector. In this case the wage is observed for the whole sample (for the individuals in the public and in the private sector) but, once again, if the unobserved determinants of the chosen sector are correlated with those of the wage, estimating the wage equation only will lead to an inconsistent estimator. This case is called the <strong>endogenous switching</strong> model. Two consistent methods of estimation can be used in this context:</p>
<ul>
<li>a two-step method where, in a first step, a probit model for the binomial variable is estimated and, in a second step, the outcome equation is estimated by OLS with a supplementary covariate which is a function of the linear predictor of the probit,<a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a>
</li>
<li>the maximum likelihood estimation of the system of the two equations, assuming that the two errors are jointly normally distributed.</li>
</ul>
<p>Let <span class="math inline">\(y\)</span> be a count response (for the sake of simplicity a Poisson variable) and <span class="math inline">\(w\)</span> a binomial variable. The value of <span class="math inline">\(w_n\)</span> is given by the sign of <span class="math inline">\(\gamma ^ \top z_{n1} + \nu_{n}\)</span>, where <span class="math inline">\(\nu_n\)</span> is a standard normal deviate, <span class="math inline">\(z_{n1}\)</span> a vector of covariates and <span class="math inline">\(\gamma_1\)</span> the associated vector of unknown parameters. The distribution of <span class="math inline">\(y_n\)</span> is Poisson with parameter <span class="math inline">\(\lambda_n\)</span>, given by <span class="math inline">\(\lambda_n = e ^{\gamma_2 ^ \top z_{n2}} + \epsilon_n\)</span> where <span class="math inline">\(z_{n2}\)</span> is a second set of covariates (which can overlap with <span class="math inline">\(z_{n1}\)</span>), <span class="math inline">\(\gamma_2\)</span> is the corresponding set of unknown parameters and <span class="math inline">\(\epsilon_n\)</span> is a random normal deviate with 0 mean and a standard deviation equal to <span class="math inline">\(\sigma\)</span>. <span class="math inline">\(\epsilon\)</span> and <span class="math inline">\(\nu\)</span> being potentially correlated, their joint distribution has to be considered: </p>
<p><span id="eq-joint_dist_normal"><span class="math display">\[
\begin{array}{rcl}
f(\epsilon, \nu ; \sigma, \rho)  &amp;=&amp;
\frac{1}{2\pi\sqrt{1 - \rho ^ 2}\sigma}
e^{-\frac{1}{2} \frac{\left(\frac{\epsilon}{\sigma}\right) ^ 2 + \nu ^
2 - 2 \rho \left(\frac{\epsilon}{\sigma}\right)\nu}{1 - \rho ^2}} \\
&amp;=&amp; \frac{1}{\sqrt{2\pi}}\sigma e ^
{-\frac{1}{2}\left(\frac{\epsilon}{\sigma}\right) ^ 2}
\frac{1}{\sqrt{2\pi}\sqrt{1 - \rho ^ 2}}
e^{-\frac{1}{2}\left(\frac{(\nu - \rho \epsilon / \sigma)}{\sqrt{1 -
\rho ^ 2}}\right) ^ 2}
\end{array}
\tag{12.14}\]</span></span></p>
<p>The second expression gives the joint distribution of <span class="math inline">\(\epsilon\)</span> and <span class="math inline">\(\nu\)</span> as the product of the marginal distribution of <span class="math inline">\(\epsilon\)</span> and the conditional distribution of <span class="math inline">\(\nu\)</span>. The conditional distribution of <span class="math inline">\(y\)</span>, given <span class="math inline">\(\epsilon\)</span> is:</p>
<p><span class="math display">\[
g(y_n \mid z_{n2}, \epsilon_n;\gamma_2) = \frac{e ^
{-\exp(\gamma_2 ^ \top z_{n2} + \epsilon_n)}e^{y_n(\gamma_2^\top z_{n2} +
\epsilon_n)}}{y_n!}
\]</span> For <span class="math inline">\(w=1\)</span>, the unconditional distribution of <span class="math inline">\(y\)</span> is obtained by integrating out <span class="math inline">\(g\)</span> with the two random deviates <span class="math inline">\(\epsilon\)</span> and <span class="math inline">\(\nu\)</span>, using their joint distribution given by <a href="#eq-joint_dist_normal">Equation&nbsp;<span>12.14</span></a>:</p>
<p><span class="math display">\[
\begin{array}{rcl}
P(y_n \mid z_{n1}, z_{n2}, w_n = 1) &amp;=&amp; \displaystyle\int_{-\infty} ^ {+\infty}\int_{-\gamma_1 ^ \top
z_{n1}} ^ {+ \infty} g(y_n \mid z_{n2}, \epsilon_n;\gamma_2)
f(\epsilon, \nu;\sigma, \rho) d\epsilon d\nu\\
&amp;=&amp; \displaystyle\int_{-\infty} ^ {+\infty}
g(y_n \mid z_{n2}, \epsilon_n)
\left(\int_{-\gamma_1 ^ \top z_{n1}} ^ {+ \infty}
\frac{1}{\sqrt{2\pi}\sqrt{1 - \rho ^ 2}}
e^{-\frac{1}{2}\left(\frac{(\nu - \rho \epsilon / \sigma)}{\sqrt{1 -
\rho ^ 2}}\right) ^ 2}
d\nu\right)\\
&amp;\times&amp;\displaystyle \frac{1}{\sqrt{2\pi}\sigma} e ^
{-\frac{1}{2}\left(\frac{\epsilon}{\sigma}\right) ^ 2}
d\epsilon
\end{array}
\]</span></p>
<p>By symmetry of the normal distribution, the term in brackets is:</p>
<p><span class="math display">\[
\Phi\left(\frac{\gamma_1 ^ \top z_{n1} + \rho / \sigma \epsilon}{\sqrt{1 -
\rho ^ 2}}\right)
\]</span></p>
<p>which is the probability that <span class="math inline">\(w = 1\)</span> for a given value of <span class="math inline">\(\epsilon\)</span>. The density of <span class="math inline">\(y\)</span> given that <span class="math inline">\(w = 1\)</span> is then:</p>
<p><span id="eq-probyw1"><span class="math display">\[
\begin{array}{rcl}
P(y_n \mid z_{n1}, z_{n2}, w_n = 1) &amp;=&amp; \displaystyle\int_{-\infty} ^ {+\infty} \frac{e ^
{-\exp(\gamma_2 ^ \top z_{n2} + \epsilon_n)}e^{y_n(\gamma_2^\top z_{n2} +
\epsilon_n)}}{y_n!}\\
&amp;\times&amp;\Phi\left(\frac{\gamma_1 ^ \top z_{n1} + \rho / \sigma \epsilon}{\sqrt{1 -
\rho ^ 2}}\right)\frac{1}{\sqrt{2\pi}\sigma} e ^
{-\frac{1}{2}\left(\frac{\epsilon}{\sigma}\right) ^ 2} d\epsilon
\end{array}
\tag{12.15}\]</span></span></p>
<p>By symmetry, it is easily shown that <span class="math inline">\(P(y_n \mid z_{n1}, z_{n2}, w_n = 0)\)</span> is similar except that <span class="math inline">\(\Phi\left( (\gamma_1 ^ \top z_{n1} + \rho / \sigma \epsilon) / \sqrt{1 - \rho ^ 2}\right)\)</span> is replaced by <span class="math inline">\(\Phi\left( -(\gamma_1 ^ \top z_{n1} + \rho / \sigma \epsilon) / \sqrt{1 - \rho ^ 2}\right)\)</span>, so that a general formulation of the distribution of <span class="math inline">\(y_n\)</span> is, denoting <span class="math inline">\(q_n = 2 w_n -1\)</span>:</p>
<p><span id="eq-proby"><span class="math display">\[
\begin{array}{rcl}
P(y_n \mid z_{n1}, z_{n2}) &amp;=&amp; \displaystyle\int_{-\infty} ^ {+\infty} \frac{e ^
{-\exp(\gamma_2 ^ \top z_{n2} + \epsilon_n)}e^{y_n(\gamma_2^\top z_{n2} +
\epsilon_n)}}{y_n!}\\
&amp;\times&amp;\Phi\left(q_n\frac{\gamma_1 ^ \top z_{n1} + \rho / \sigma \epsilon}{\sqrt{1 -
\rho ^ 2}}\right)\frac{1}{\sqrt{2\pi}\sigma} e ^
{-\frac{1}{2}\left(\frac{\epsilon}{\sigma}\right) ^ 2} d\epsilon
\end{array}
\tag{12.16}\]</span></span></p>
<p>There is no closed form for this integral but, using the change of variable <span class="math inline">\(t = \epsilon / \sqrt{2} / \sigma\)</span>, we get:</p>
<p><span class="math display">\[
\begin{array}{rcl}
P(y_n \mid z_{n1}, z_{n2}) &amp;=&amp; \displaystyle\int_{-\infty} ^ {+\infty} \frac{e ^
{-\exp(\gamma_2 ^ \top z_{n2} + \sqrt{2} \sigma  t)}e^{y_n(\gamma_2^\top x_{n2} +
\sqrt{2}\sigma t)}}{y_n!}\\
&amp;\times&amp;\Phi\left(q_n\frac{\gamma_1 ^ \top z_{1n} + \sqrt{2} \rho  t_n}{\sqrt{1 - \rho ^ 2}}\right)\frac{1}{\sqrt{\pi}} e ^
{-t ^ 2} dt
\end{array}
\]</span></p>
<p>which can be approximated using Gauss-Hermite quadrature. Denoting <span class="math inline">\(t_r\)</span> the nodes and <span class="math inline">\(\omega_r\)</span> the weights:</p>
<p><span class="math display">\[
\begin{array}{rcl}
P(y_n \mid z_{n1}, z_{n2}) &amp;\approx&amp;
\sum_{r = 1} ^ R
\omega_r \frac{e ^
{-\exp(\gamma_2 ^ \top z_{n2} + \sqrt{2} \sigma  t_r)}e^{y_n(\gamma_2^\top z_{n2} +
\sqrt{2}\sigma t_r)}}{y_n!}\\
&amp;\times&amp;\Phi\left(q_n\frac{\gamma_1 ^ \top z_{n1} + \sqrt{2} \rho  t_r}{\sqrt{1 - \rho ^ 2}}\right)\frac{1}{\sqrt{\pi}} e ^ {-t_r ^ 2}
\end{array}
\]</span></p>
<p>For the exogenous switching model, the contribution of one observation to the likelihood is given by <a href="#eq-proby">Equation&nbsp;<span>12.16</span></a>. For the sample selection model, the contribution of one observation to the likelihood is given by <a href="#eq-probyw1">Equation&nbsp;<span>12.15</span></a> if <span class="math inline">\(w_n = 1\)</span>. If <span class="math inline">\(w_n = 0\)</span>, <span class="math inline">\(y\)</span> is unobserved and the contribution of such observations to the likelihood is the probability that <span class="math inline">\(w_n = 0\)</span>, which is:</p>
<p><span class="math display">\[
P(x_n = 0 \mid z_{n1}) = \int_{-\infty} ^ {+\infty}
\Phi\left(q_n\frac{\gamma_1 ^ \top z_{n1} + \rho / \sigma \epsilon}{\sqrt{1 -
\rho ^ 2}}\right)\frac{1}{\sqrt{2\pi}\sigma} e ^
{-\frac{1}{2}\left(\frac{\epsilon}{\sigma}\right) ^ 2} d\epsilon
\]</span></p>
<p> </p>
<p> </p>
<p>The ML estimator is computing-intensive, as the integral has no closed form. One alternative is to use non-linear least squares, by first computing the expectation of <span class="math inline">\(y\)</span>. <span class="citation" data-cites="TERZ:98">Terza (<a href="#ref-TERZ:98" role="doc-biblioref">1998</a>)</span> showed that this expectation is:</p>
<p><span class="math display">\[
\mbox{E}(y_n\mid z_{n1}, z_{n2}) = \exp\left(\gamma_2 ^ \top z_{n2} + \ln \frac{\Phi\left(q_n(\gamma_1 ^\top
z_{n1} + \theta)\right)}{\Phi\left(q_n(\gamma_1 ^\top z_{n1})\right)}\right)
\]</span> for the endogenous switching case and: <span class="math display">\[
\mbox{E}(y_n\mid z_{n1}, z_{n2}, w_n = 1) = \exp\left(\gamma_2 ^\top z_{n2} + \ln \frac{\Phi(\gamma_1 ^\top z_{n1} + \theta)}{\Phi(\gamma_1 ^ \top z_{n1})}\right)
\]</span> for the sample selection case, where <span class="math inline">\(\theta = \sigma\rho\)</span>. <span class="citation" data-cites="GREE:01">Greene (<a href="#ref-GREE:01" role="doc-biblioref">2001</a>)</span> noted that, taking a first order Taylor series of <span class="math inline">\(\ln \frac{\Phi(\gamma_1 ^\top z_{n1} + \theta)}{\Phi(\gamma_1 ^ \top z_{n1})}\)</span> around <span class="math inline">\(\theta = 0\)</span> gives: <span class="math inline">\(\theta \phi(\gamma_1 ^ \top z_{n1}) / \Phi(\gamma_1 ^ \top z_{n1})\)</span>, which is the inverse mills ratio that is used in the linear model in order to correct the inconsistency due to sample selection. As <span class="math inline">\(\gamma_1\)</span> can be consistently estimated by a probit model, the NLS estimator is obtained by minimizing with respect to <span class="math inline">\(\gamma_2\)</span> and <span class="math inline">\(\theta\)</span> the sum of squares of the following residuals:</p>
<p><span class="math display">\[
y_n - e^{\gamma_2 ^ \top z_{n2} + \ln
\frac{\Phi(\hat{\gamma_1} ^ \top z_{n1} + \theta)}{\Phi(\hat{\gamma_1}
^ \top z_{n1})}}
\]</span></p>
<p>As it is customary for a two-step estimator, the covariance matrix of the estimators should take into account the fact that <span class="math inline">\(\gamma_1\)</span> has been estimated in the first step. Moreover, only <span class="math inline">\(\theta = \rho \sigma\)</span> is estimated. To retrieve an estimator of <span class="math inline">\(\sigma\)</span>, <span class="citation" data-cites="TERZ:98">Terza (<a href="#ref-TERZ:98" role="doc-biblioref">1998</a>)</span> proposed to insert into the log-likelihood function the estimated values of <span class="math inline">\(\gamma_1\)</span>, <span class="math inline">\(\gamma_2\)</span> and <span class="math inline">\(\theta\)</span> and then to maximize it with respect to <span class="math inline">\(\sigma\)</span>.<a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a> </p>
<p>The <code><a href="https://rdrr.io/pkg/micsr/man/escount.html">micsr::escount</a></code> function estimates the endogenous switching and the sample selection model for count data. The first is obtained by setting the <code>model</code> argument to <code>'es'</code> (the default) and the second to <code>'ss'</code>. The estimation method is selected using the <code>method</code> argument, which can be either <code>"twostep"</code> for the two-step, non-linear least squares model (the default) or <code>"ml"</code> for maximum likelihood. The model is described by a two-part formula. On the left side, the outcome and the binomial responses are indicated. On the right side, the first part contains the covariates for the outcome equation and the second part the covariates of the selection equation. Relevant only for the ML method, the <code>hessian</code> argument is a boolean: if <code>TRUE</code>, the covariance matrix of the coefficients is estimated using the numerical hessian, which is computed using the <code>hessian</code> function of the <strong>numDeriv</strong> package; otherwise, the outer product of the gradient is used and <code>R</code> is an integer that indicates the number of points used for the Gauss-Hermite quadrature method. <code>escount</code> returns an object of class <code>escount</code> which inherits from <code>micsr</code>.</p>
<section id="physician-advice-and-alcohol-consumption" class="level4"><h4 class="anchored" data-anchor-id="physician-advice-and-alcohol-consumption">Physician advice and alcohol consumption</h4>
<p><span class="citation" data-cites="KENK:TERZ:01">Kenkel and Terza (<a href="#ref-KENK:TERZ:01" role="doc-biblioref">2001</a>)</span> investigate the effect of physician’s advice on alcohol consumption; the data set is called <code>drinks</code>. The outcome variable <code>drinks</code> is the number of drinks in the past 2 weeks and the selection variable <code>advice</code> is a dummy based on the respondents’ answer to the question: “Have you ever been told by a physician to drink less”. The unobserved part of the equation indicating the propensity to receive advice from the physician can obviously be correlated with the one of the alcohol consumption equation. The covariates are monthly income in thousands of dollars (<code>income</code>), <code>age</code> (a factor with six 10-year categories of age), education in years (<code>educ</code>), <code>race</code> (a factor with levels <code>white</code>, <code>black</code> and <code>other</code>), marital status (<code>marital</code>, a factor with levels <code>single</code>, <code>married</code>, <code>widow</code>, <code>separated</code>), employment status (a factor <code>empstatus</code> with levels <code>other</code>, <code>emp</code> and <code>unemp</code>) and region (<code>region</code>, a factor with levels <code>west</code>, <code>northeast</code>, <code>midwest</code> and <code>south</code>). For the binomial part of the model, the same covariates are used (except of course <code>advice</code>) and 10 supplementary covariates indicating insurance coverage and health status are added.</p>
<p><a href="#tbl-drinksres">Table&nbsp;<span>12.3</span></a> presents the results of a Poisson model and of the endogenous switching model, estimated by the two-step, non-linear least squares and by the maximum likelihood estimators.<a href="#fn10" class="footnote-ref" id="fnref10" role="doc-noteref"><sup>10</sup></a> The coefficient of <code>advice</code> in the alcohol demand equation is positive in the Poisson model, which would imply that a physician’s advice have a positive effect on alcohol consumption. The estimation of the endogenous switching model shows that this positive coefficient is due to the positive correlation between the error terms of the two equations (the unobserved propensities to drink and to receive advice from a physician are positively correlated). </p>
<div class="cell" data-layout-align="center" data-hash="count_cache/html/drinksest_1d98c9c195198d4a752ce0de119aea0a">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">kt_pois</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span><span class="va">drinks</span> <span class="op">~</span> <span class="va">advice</span> <span class="op">+</span> <span class="va">income</span> <span class="op">+</span> <span class="va">age</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> <span class="va">race</span> <span class="op">+</span> <span class="va">marital</span> <span class="op">+</span> </span>
<span>                 <span class="va">empstatus</span> <span class="op">+</span> <span class="va">region</span>, data <span class="op">=</span> <span class="va">drinks</span>, family <span class="op">=</span> <span class="va">poisson</span><span class="op">)</span></span>
<span><span class="va">kt_ml</span> <span class="op">&lt;-</span> <span class="fu">escount</span><span class="op">(</span><span class="va">drinks</span> <span class="op">+</span> <span class="va">advice</span> <span class="op">~</span> <span class="va">advice</span> <span class="op">+</span> <span class="va">income</span> <span class="op">+</span> <span class="va">age</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> <span class="va">race</span> <span class="op">+</span> </span>
<span>                   <span class="va">marital</span> <span class="op">+</span> <span class="va">empstatus</span> <span class="op">+</span> <span class="va">region</span> <span class="op">|</span> <span class="va">.</span> <span class="op">-</span> <span class="va">advice</span> <span class="op">+</span> <span class="va">medicare</span> <span class="op">+</span> </span>
<span>                   <span class="va">medicaid</span> <span class="op">+</span> <span class="va">champus</span> <span class="op">+</span> <span class="va">hlthins</span> <span class="op">+</span> <span class="va">regmed</span> <span class="op">+</span> <span class="va">dri</span> <span class="op">+</span> <span class="va">limits</span> <span class="op">+</span> </span>
<span>                   <span class="va">diabete</span> <span class="op">+</span> <span class="va">hearthcond</span> <span class="op">+</span> <span class="va">stroke</span>,</span>
<span>                 data <span class="op">=</span> <span class="va">drinks</span>, method <span class="op">=</span> <span class="st">"ml"</span><span class="op">)</span></span>
<span><span class="va">kt_2s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">kt_ml</span>, method <span class="op">=</span> <span class="st">"twostep"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="tbl-drinksres" class="anchored">

<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<caption>Table&nbsp;12.3:  Poisson and endogenous switching models for alcohol demand </caption>
 <thead><tr>
<th style="text-align:left;">   </th>
   <th style="text-align:center;"> Poisson </th>
   <th style="text-align:center;"> two-step </th>
   <th style="text-align:center;"> ML </th>
  </tr></thead>
<tbody>
<tr>
<td style="text-align:left;"> advice </td>
   <td style="text-align:center;"> 0.477 </td>
   <td style="text-align:center;"> −1.400 </td>
   <td style="text-align:center;"> −0.848 </td>
  </tr>
<tr>
<td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.011) </td>
   <td style="text-align:center;"> (0.338) </td>
   <td style="text-align:center;"> (0.022) </td>
  </tr>
<tr>
<td style="text-align:left;"> income </td>
   <td style="text-align:center;"> 0.003 </td>
   <td style="text-align:center;"> 0.001 </td>
   <td style="text-align:center;"> 0.009 </td>
  </tr>
<tr>
<td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.001) </td>
   <td style="text-align:center;"> (0.003) </td>
   <td style="text-align:center;"> (0.001) </td>
  </tr>
<tr>
<td style="text-align:left;"> educ </td>
   <td style="text-align:center;"> −0.026 </td>
   <td style="text-align:center;"> −0.061 </td>
   <td style="text-align:center;"> −0.055 </td>
  </tr>
<tr>
<td style="text-align:left;">  </td>
   <td style="text-align:center;"> (0.002) </td>
   <td style="text-align:center;"> (0.012) </td>
   <td style="text-align:center;"> (0.003) </td>
  </tr>
<tr>
<td style="text-align:left;"> theta </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> 1.142 </td>
   <td style="text-align:center;">  </td>
  </tr>
<tr>
<td style="text-align:left;">  </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> (0.319) </td>
   <td style="text-align:center;">  </td>
  </tr>
<tr>
<td style="text-align:left;"> sigma </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> 1.298 </td>
  </tr>
<tr>
<td style="text-align:left;">  </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> (0.011) </td>
  </tr>
<tr>
<td style="text-align:left;"> rho </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;"> 0.463 </td>
  </tr>
<tr>
<td style="text-align:left;box-shadow: 0px 1.5px">  </td>
   <td style="text-align:center;box-shadow: 0px 1.5px">  </td>
   <td style="text-align:center;box-shadow: 0px 1.5px">  </td>
   <td style="text-align:center;box-shadow: 0px 1.5px"> (0.022) </td>
  </tr>
<tr>
<td style="text-align:left;"> Num.Obs. </td>
   <td style="text-align:center;"> 2467 </td>
   <td style="text-align:center;"> 2467 </td>
   <td style="text-align:center;"> 2467 </td>
  </tr>
<tr>
<td style="text-align:left;"> F </td>
   <td style="text-align:center;"> 229.655 </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;">  </td>
  </tr>
<tr>
<td style="text-align:left;"> RMSE </td>
   <td style="text-align:center;"> 22.16 </td>
   <td style="text-align:center;">  </td>
   <td style="text-align:center;">  </td>
  </tr>
</tbody>
</table>
</div>
</div>
</div>


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography">
<div id="ref-CAME:JOHA:97" class="csl-entry" role="doc-biblioentry">
Cameron, A. Colin, and Per Johansson. 1997. <span>“Count Data Regression Using Series Expansions: With Applications.”</span> <em>Journal of Applied Econometrics</em> 12 (3): 203–23. <a href="https://doi.org/10.1002/(SICI)1099-1255(199705)12:3<203::AID-JAE446>3.0.CO;2-2">https://doi.org/10.1002/(SICI)1099-1255(199705)12:3&lt;203::AID-JAE446&gt;3.0.CO;2-2</a>.
</div>
<div id="ref-CAME:TRIV:86" class="csl-entry" role="doc-biblioentry">
Cameron, A. Colin, and Pravin K. Trivedi. 1986. <span>“Econometric Models Based on Count Data. Comparisons and Applications of Some Estimators and Tests.”</span> <em>Journal of Applied Econometrics</em> 1 (1): 29–53. <a href="https://doi.org/10.1002/jae.3950010104">https://doi.org/10.1002/jae.3950010104</a>.
</div>
<div id="ref-CRAG:71" class="csl-entry" role="doc-biblioentry">
Cragg, John G. 1971. <span>“Some Statistical Models for Limited Dependent Variables with Applications for the Demand for Durable Goods.”</span> <em>Econometrica</em> 39 (5): 829–44.
</div>
<div id="ref-DEAN:92" class="csl-entry" role="doc-biblioentry">
Dean, C. B. 1992. <span>“Testing for Overdispersion in Poisson and Binomial Regression Models.”</span> <em>Journal of the American Statistical Association</em> 87 (418): 451–57. <a href="http://www.jstor.org/stable/2290276">http://www.jstor.org/stable/2290276</a>.
</div>
<div id="ref-DEB:TRIV:97" class="csl-entry" role="doc-biblioentry">
Deb, Partha, and Pravin K. Trivedi. 1997. <span>“Demand for Medical Care by the Elderly: A Finite Mixture Approach.”</span> <em>Journal of Applied Econometrics</em> 12 (3): 313–36. <a href="http://www.jstor.org/stable/2285252">http://www.jstor.org/stable/2285252</a>.
</div>
<div id="ref-DEB:TRIV:02" class="csl-entry" role="doc-biblioentry">
———. 2002. <span>“The Structure of Demand for Health Care: Latent Class Versus Two-Part Models.”</span> <em>Journal of Health Economics</em> 21 (4): 601–25. <a href="https://doi.org/10.1016/S0167-6296(02)00008-5">https://doi.org/10.1016/S0167-6296(02)00008-5</a>.
</div>
<div id="ref-ELLI:SWAN:16" class="csl-entry" role="doc-biblioentry">
Ellison, Glenn, and Ashley Swanson. 2016. <span>“Do Schools Matter for High Math Achievement? Evidence from the American Mathematics Competitions.”</span> <em>American Economic Review</em> 106 (6): 1244–77. <a href="https://doi.org/10.1257/aer.20140308">https://doi.org/10.1257/aer.20140308</a>.
</div>
<div id="ref-GEIL:MILL:ROTT:ZIMM:97" class="csl-entry" role="doc-biblioentry">
Geil, Peter, Andreas Million, Ralph Rotte, and Klaus F. Zimmermann. 1997. <span>“Economic Incentives and Hospitalization in Germany.”</span> <em>Journal of Applied Econometrics</em> 12 (3): 295–311. <a href="http://www.jstor.org/stable/2285251">http://www.jstor.org/stable/2285251</a>.
</div>
<div id="ref-GREE:01" class="csl-entry" role="doc-biblioentry">
Greene, William H. 2001. <span>“Fiml Estimation of Sample Selection Models for Count Data.”</span> In <em>Economic Theory, Dynamics and Markets: Essays in Honor of Ryuzo Sato</em>, edited by Takashi Negishi, Rama V. Ramachandran, and Kazuo Mino, 73–91. Boston, MA: Springer US. <a href="https://doi.org/10.1007/978-1-4615-1677-4_6">https://doi.org/10.1007/978-1-4615-1677-4_6</a>.
</div>
<div id="ref-GURM:97" class="csl-entry" role="doc-biblioentry">
Gurmu, Shiferaw. 1997. <span>“Semi-Parametric Estimation of Hurdle Regression Models with an Application to Medicaid Utilization.”</span> <em>Journal of Applied Econometrics</em> 12 (3): 225–42. <a href="http://www.jstor.org/stable/2285247">http://www.jstor.org/stable/2285247</a>.
</div>
<div id="ref-HECK:76" class="csl-entry" role="doc-biblioentry">
Heckman, James J. 1976. <span>“The Common Structure of Statistical Models of Truncation, Sample Selection and Limited Dependent Variables and a Simple Estimator for Such Models,”</span> 475–92. <a href="https://EconPapers.repec.org/RePEc:nbr:nberch:10491">https://EconPapers.repec.org/RePEc:nbr:nberch:10491</a>.
</div>
<div id="ref-HECK:79" class="csl-entry" role="doc-biblioentry">
———. 1979. <span>“Sample Selection Bias as a Specification Error.”</span> <em>Econometrica</em> 47 (1): 153–61. <a href="http://www.jstor.org/stable/1912352">http://www.jstor.org/stable/1912352</a>.
</div>
<div id="ref-KENK:TERZ:01" class="csl-entry" role="doc-biblioentry">
Kenkel, Donald S., and Joseph V. Terza. 2001. <span>“The Effect of Physician Advice on Alcohol Consumption: Count Regression with an Endogenous Treatment Effect.”</span> <em>Journal of Applied Econometrics</em> 16 (2): 165–84. <a href="https://doi.org/10.1002/jae.596">https://doi.org/10.1002/jae.596</a>.
</div>
<div id="ref-KENN:85" class="csl-entry" role="doc-biblioentry">
Kennan, John. 1985. <span>“The Duration of Contract Strikes in u.s. Manufacturing.”</span> <em>Journal of Econometrics</em> 28 (1): 5–28. <a href="https://doi.org/10.1016/0304-4076(85)90064-8">https://doi.org/10.1016/0304-4076(85)90064-8</a>.
</div>
<div id="ref-KOEN:ZEIL:09" class="csl-entry" role="doc-biblioentry">
Koenker, Roger, and Achim Zeileis. 2009. <span>“On Reproducible Econometric Research.”</span> <em>Journal of Applied Econometrics</em> 24 (5): 833–47. <a href="https://doi.org/10.1002/jae.1083">https://doi.org/10.1002/jae.1083</a>.
</div>
<div id="ref-LAMB:92" class="csl-entry" role="doc-biblioentry">
Lambert, Diane. 1992. <span>“Zero-Inflated Poisson Regression, with an Application to Defects in Manufacturing.”</span> <em>Technometrics</em> 34 (1): 1–14. <a href="http://www.jstor.org/stable/1269547">http://www.jstor.org/stable/1269547</a>.
</div>
<div id="ref-LONG:97" class="csl-entry" role="doc-biblioentry">
Long, John Scott. 1997. <em>Regression Models for Categorical and Limited Dependent Variables</em>. Sage Publications.
</div>
<div id="ref-MILL:09" class="csl-entry" role="doc-biblioentry">
Miller, Nathan H. 2009. <span>“Strategic Leniency and Cartel Enforcement.”</span> <em>American Economic Review</em> 99 (3): 750–68. <a href="https://doi.org/10.1257/aer.99.3.750">https://doi.org/10.1257/aer.99.3.750</a>.
</div>
<div id="ref-MULL:86" class="csl-entry" role="doc-biblioentry">
Mullahy, John. 1986. <span>“Specification and Testing of Some Modified Count Data Models.”</span> <em>Journal of Econometrics</em> 33 (3): 341–65. <a href="https://doi.org/10.1016/0304-4076(86)90002-3">https://doi.org/10.1016/0304-4076(86)90002-3</a>.
</div>
<div id="ref-MULL:97" class="csl-entry" role="doc-biblioentry">
———. 1997. <span>“Instrumental-Variable Estimation of Count Data Models: Applications to Models of Cigarette Smoking Behavior.”</span> <em>The Review of Economics and Statistics</em> 79 (4): 586–93. <a href="http://www.jstor.org/stable/2951410">http://www.jstor.org/stable/2951410</a>.
</div>
<div id="ref-MULL:98" class="csl-entry" role="doc-biblioentry">
———. 1998. <span>“Much Ado about Two: Reconsidering Retransformation and the Two-Part Model in Health Econometrics.”</span> <em>Journal of Health Economics</em> 17 (3): 247–81. <a href="https://doi.org/10.1016/S0167-6296(98)00030-7">https://doi.org/10.1016/S0167-6296(98)00030-7</a>.
</div>
<div id="ref-SANT:WIND:01" class="csl-entry" role="doc-biblioentry">
Santos Silva, João M. C, and Frank Windmeijer. 2001. <span>“Two-Part Multiple Spell Models for Health Care Demand.”</span> <em>Journal of Econometrics</em> 104 (1): 67–89. <a href="https://doi.org/10.1016/S0304-4076(01)00059-8">https://doi.org/10.1016/S0304-4076(01)00059-8</a>.
</div>
<div id="ref-SELL:STOL:CHAV:85" class="csl-entry" role="doc-biblioentry">
Seller, Christine, John R. Stoll, and Jean-Paul Chavas. 1985. <span>“Validation of Empirical Measures of Welfare Change: A Comparison of Nonmarket Techniques.”</span> <em>Land Economics</em> 61 (2): 156–75. <a href="http://www.jstor.org/stable/3145808">http://www.jstor.org/stable/3145808</a>.
</div>
<div id="ref-TERZ:98" class="csl-entry" role="doc-biblioentry">
Terza, Joseph V. 1998. <span>“Estimating Count Data Models with Endogenous Switching: Sample Selection and Endogenous Treatment Effects.”</span> <em>Journal of Econometrics</em> 84 (1): 129–54. <a href="https://doi.org/10.1016/S0304-4076(97)00082-1">https://doi.org/10.1016/S0304-4076(97)00082-1</a>.
</div>
<div id="ref-WINK:04" class="csl-entry" role="doc-biblioentry">
Winkelmann, Rainer. 2004. <span>“Health Care Reform and the Number of Doctor Visits: An Econometric Analysis.”</span> <em>Journal of Applied Econometrics</em> 19 (4): 455–72. <a href="http://www.jstor.org/stable/25146297">http://www.jstor.org/stable/25146297</a>.
</div>
</div>
</section></section></section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><hr>
<ol>
<li id="fn1"><p>The <strong>topmodels</strong> package is not on CRAN; it can be installed using <code>install.packages("topmodels", repos="http://R-Forge.R-project.org")</code>.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>Note the use of <code><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">ggplot2::autoplot</a></code> that coerces a graphical object to a <code>ggplot</code> object.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>The other possible other links for the Poisson model are <code>"identity"</code> and <code>"sqrt"</code>, but the default <code>"log"</code> link is almost always used.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>Score tests that are not obtained from auxiliary regressions are presented by <span class="citation" data-cites="DEAN:92">Dean (<a href="#ref-DEAN:92" role="doc-biblioref">1992</a>)</span>.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>The NB2 model is implemented in <code><a href="https://rdrr.io/pkg/MASS/man/glm.nb.html">MASS::glm.nb</a></code>.<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6"><p>Also called with zeros model.<a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn7"><p>The <strong>countreg</strong> package is not on CRAN, it can be installed using <code>install.packages("countreg", repos="http://R-Forge.R-project.org")</code>.<a href="#fnref7" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn8"><p>More precisely the inverse Mills ratio.<a href="#fnref8" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn9"><p>This once again requires the use of Gauss-Hermite quadrature, but the problem is considerably simpler as the likelihood is maximized with respect with only one parameter.<a href="#fnref9" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn10"><p>The coefficients of <code>marital</code>, <code>empstatus</code>, <code>income</code>, <code>race</code> and <code>region</code> are omitted to save place.<a href="#fnref10" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="../chapters/tobit.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Censored and truncated models</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../chapters/duration.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Duration models</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb31" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Count data {#sec-count}</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"../_commonR.R"</span>)</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>It is often the case in economics that the response is a count, i.e., a</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>non-negative integer. In this case, fitting a linear model has a number of</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>drawbacks:</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>the integer nature of the response is not taken into account,</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>the fitted model can predict negative values for some values of the</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>  covariates,</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>if the distribution of the response is asymmetric, the logarithm</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>  transformation can't be used in the common case where the response is 0 for a subset of observations.</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>There is therefore the need for specific models that will be presented</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>in this chapter. In @sec-features_count, we'll illustrate the features of count data, using a survey of empirical studies.</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>@sec-poisson_model is devoted to the benchmark count model, the Poisson model. @sec-overdisp_zero discusses two common features of count data: overdispersion and excess of zero. Finally @sec-endog_count deals with the endogeneity problem with a count response. </span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a><span class="fu">## Features of count data {#sec-features_count}</span></span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a><span class="fu">### An empirical survey</span></span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>We start with the presentation of some data sets for which the</span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>response is a count. All these data are available in the **micsr.count**</span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>package and are summarized in @tbl-empsurvey.</span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-empsurvey</span></span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a><span class="co">#| cache: true</span></span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Empirical survey of count data sets"</span></span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"micsr.count"</span>)</span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"micsr"</span>)</span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"tidyverse"</span>)</span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a><span class="co"># CAME:TRIV:86 table 3 p. 47</span></span>
<span id="cb31-41"><a href="#cb31-41" aria-hidden="true" tabindex="-1"></a>p_doctor_aus <span class="ot">&lt;-</span> <span class="fu">glm</span>(doctorco <span class="sc">~</span> sex <span class="sc">+</span> age <span class="sc">+</span> <span class="fu">I</span>(age <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">+</span> income <span class="sc">+</span> insurance <span class="sc">+</span> illness <span class="sc">+</span> actdays <span class="sc">+</span> hscore <span class="sc">+</span> chcond,</span>
<span id="cb31-42"><a href="#cb31-42" aria-hidden="true" tabindex="-1"></a>                    <span class="at">data =</span> doctor_aus, <span class="at">family =</span> poisson)</span>
<span id="cb31-43"><a href="#cb31-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-44"><a href="#cb31-44" aria-hidden="true" tabindex="-1"></a><span class="co"># WINK:04 table 4 p. 468</span></span>
<span id="cb31-45"><a href="#cb31-45" aria-hidden="true" tabindex="-1"></a>p_health_reform <span class="ot">&lt;-</span> <span class="fu">glm</span>(visits <span class="sc">~</span> <span class="fu">I</span>(age <span class="sc">/</span> <span class="dv">10</span>) <span class="sc">+</span> <span class="fu">I</span>(age <span class="sc">^</span> <span class="dv">2</span> <span class="sc">/</span> <span class="fl">1E03</span>) <span class="sc">+</span> male <span class="sc">+</span> <span class="fu">I</span>(educ <span class="sc">/</span> <span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb31-46"><a href="#cb31-46" aria-hidden="true" tabindex="-1"></a>                        married <span class="sc">+</span> hsize <span class="sc">+</span> sport <span class="sc">+</span> health <span class="sc">+</span> sozh <span class="sc">+</span> <span class="fu">log</span>(income) <span class="sc">+</span> <span class="fu">factor</span>(year) <span class="sc">+</span></span>
<span id="cb31-47"><a href="#cb31-47" aria-hidden="true" tabindex="-1"></a>                        quarter <span class="sc">+</span> empl,  <span class="at">data =</span> health_reform, <span class="at">family =</span> poisson)</span>
<span id="cb31-48"><a href="#cb31-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-49"><a href="#cb31-49" aria-hidden="true" tabindex="-1"></a><span class="co"># KENN:85</span></span>
<span id="cb31-50"><a href="#cb31-50" aria-hidden="true" tabindex="-1"></a><span class="co">#strikes &lt;- strikes %&gt;% select(- duration) %&gt;% distinct</span></span>
<span id="cb31-51"><a href="#cb31-51" aria-hidden="true" tabindex="-1"></a>p_strikes <span class="ot">&lt;-</span> <span class="fu">glm</span>(strikes <span class="sc">~</span> output, <span class="at">data =</span> strikes, <span class="at">family =</span> poisson)</span>
<span id="cb31-52"><a href="#cb31-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-53"><a href="#cb31-53" aria-hidden="true" tabindex="-1"></a><span class="co"># TERZ:98 table 2 (pas identique car NLS)</span></span>
<span id="cb31-54"><a href="#cb31-54" aria-hidden="true" tabindex="-1"></a>p_trips <span class="ot">&lt;-</span> <span class="fu">glm</span>(trips <span class="sc">~</span> workschl <span class="sc">+</span> size <span class="sc">+</span> dist <span class="sc">+</span> smsa <span class="sc">+</span> fulltime <span class="sc">+</span> distnod <span class="sc">+</span></span>
<span id="cb31-55"><a href="#cb31-55" aria-hidden="true" tabindex="-1"></a>                   realinc <span class="sc">+</span> weekend <span class="sc">+</span> car, <span class="at">data =</span> trips, <span class="at">family =</span> poisson)</span>
<span id="cb31-56"><a href="#cb31-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-57"><a href="#cb31-57" aria-hidden="true" tabindex="-1"></a><span class="co"># MULL:97 (RES) table 1 p. 592</span></span>
<span id="cb31-58"><a href="#cb31-58" aria-hidden="true" tabindex="-1"></a>p_cigmales <span class="ot">&lt;-</span> <span class="fu">glm</span>(cigarettes <span class="sc">~</span> habit <span class="sc">+</span> price <span class="sc">+</span> restaurant <span class="sc">+</span> income <span class="sc">+</span> age <span class="sc">+</span> <span class="fu">I</span>(age <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb31-59"><a href="#cb31-59" aria-hidden="true" tabindex="-1"></a>                      educ <span class="sc">+</span> <span class="fu">I</span>(educ <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">+</span> famsize <span class="sc">+</span> race, <span class="at">data =</span> cigmales, <span class="at">family =</span> poisson)</span>
<span id="cb31-60"><a href="#cb31-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-61"><a href="#cb31-61" aria-hidden="true" tabindex="-1"></a><span class="co"># DEB:TRIV:02 table 4 p. 613 (pas de poisson mais negbin two-part et finite mixture)</span></span>
<span id="cb31-62"><a href="#cb31-62" aria-hidden="true" tabindex="-1"></a>p_health_ins <span class="ot">&lt;-</span> <span class="fu">glm</span>(mdu <span class="sc">~</span> <span class="fu">log</span>(<span class="dv">1</span> <span class="sc">+</span> coins) <span class="sc">+</span> idp <span class="sc">+</span> lpi <span class="sc">+</span> fmde <span class="sc">+</span> <span class="fu">log</span>(income) <span class="sc">+</span> <span class="fu">log</span>(size) <span class="sc">+</span></span>
<span id="cb31-63"><a href="#cb31-63" aria-hidden="true" tabindex="-1"></a>                        age <span class="sc">+</span> sex <span class="sc">*</span> child <span class="sc">+</span> race <span class="sc">+</span> educ <span class="sc">+</span> physlim <span class="sc">+</span> disease <span class="sc">+</span> health,</span>
<span id="cb31-64"><a href="#cb31-64" aria-hidden="true" tabindex="-1"></a>                    <span class="at">data =</span> health_ins, <span class="at">family =</span> poisson)</span>
<span id="cb31-65"><a href="#cb31-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-66"><a href="#cb31-66" aria-hidden="true" tabindex="-1"></a><span class="co"># DEB:TRIV:97 table 7 p 330 (pas de poisson mais negbin finite mixture)</span></span>
<span id="cb31-67"><a href="#cb31-67" aria-hidden="true" tabindex="-1"></a>p_elderly <span class="ot">&lt;-</span> <span class="fu">glm</span>(ofp <span class="sc">~</span> health <span class="sc">+</span> numchron <span class="sc">+</span> adldiff <span class="sc">+</span> region <span class="sc">+</span> age <span class="sc">+</span> race <span class="sc">+</span> sex <span class="sc">+</span> marital <span class="sc">+</span></span>
<span id="cb31-68"><a href="#cb31-68" aria-hidden="true" tabindex="-1"></a>                       school <span class="sc">+</span> income <span class="sc">+</span> emp <span class="sc">+</span> insurance, <span class="at">data =</span> elderly, <span class="at">family =</span> poisson)</span>
<span id="cb31-69"><a href="#cb31-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-70"><a href="#cb31-70" aria-hidden="true" tabindex="-1"></a><span class="co"># SANT:WIND:01 table 2 p. 82 (negbin_X)</span></span>
<span id="cb31-71"><a href="#cb31-71" aria-hidden="true" tabindex="-1"></a>p_doctor_ger <span class="ot">&lt;-</span> <span class="fu">glm</span>(sdoctor <span class="sc">~</span> female <span class="sc">+</span> single <span class="sc">+</span> age <span class="sc">+</span> <span class="fu">I</span>(age <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">+</span> income <span class="sc">+</span> chronic <span class="sc">+</span></span>
<span id="cb31-72"><a href="#cb31-72" aria-hidden="true" tabindex="-1"></a>                        privins <span class="sc">+</span> school<span class="sc">+</span> heavylab <span class="sc">+</span> stress <span class="sc">+</span> variety <span class="sc">+</span> selfdet <span class="sc">+</span> control <span class="sc">+</span></span>
<span id="cb31-73"><a href="#cb31-73" aria-hidden="true" tabindex="-1"></a>                        pop <span class="sc">+</span> physdens <span class="sc">+</span> unemp <span class="sc">+</span> hospm7 <span class="sc">+</span> sickm14 <span class="sc">+</span> disability,</span>
<span id="cb31-74"><a href="#cb31-74" aria-hidden="true" tabindex="-1"></a>                    <span class="at">data =</span> doctor_ger, <span class="at">family =</span> poisson)</span>
<span id="cb31-75"><a href="#cb31-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-76"><a href="#cb31-76" aria-hidden="true" tabindex="-1"></a><span class="co"># GEIL:MILL:ROTT:ZIMM:97</span></span>
<span id="cb31-77"><a href="#cb31-77" aria-hidden="true" tabindex="-1"></a>p_hospitalization <span class="ot">&lt;-</span> <span class="fu">glm</span>(hospital <span class="sc">~</span> age <span class="sc">+</span> <span class="fu">I</span>(age <span class="sc">^</span> <span class="dv">2</span> <span class="sc">/</span> <span class="fl">10E3</span>) <span class="sc">+</span> <span class="fu">I</span>(age <span class="sc">^</span> <span class="dv">3</span> <span class="sc">/</span> <span class="fl">1E04</span>) <span class="sc">+</span> copayment <span class="sc">+</span></span>
<span id="cb31-78"><a href="#cb31-78" aria-hidden="true" tabindex="-1"></a>                             (public <span class="sc">+</span> voluntary <span class="sc">+</span> family) <span class="sc">*</span> (additional <span class="sc">+</span> aok) <span class="sc">+</span></span>
<span id="cb31-79"><a href="#cb31-79" aria-hidden="true" tabindex="-1"></a>                             chronic <span class="sc">+</span> handicap <span class="sc">+</span> <span class="fu">I</span>(income <span class="sc">/</span> <span class="fl">1E05</span>) <span class="sc">+</span> distance <span class="sc">+</span> married <span class="sc">+</span> children <span class="sc">+</span></span>
<span id="cb31-80"><a href="#cb31-80" aria-hidden="true" tabindex="-1"></a>                             secondary <span class="sc">+</span> apprenticeship <span class="sc">+</span> university <span class="sc">+</span> healthjob <span class="sc">+</span> inlabour <span class="sc">+</span> bluecol <span class="sc">+</span> whitecol <span class="sc">+</span> civil <span class="sc">+</span></span>
<span id="cb31-81"><a href="#cb31-81" aria-hidden="true" tabindex="-1"></a>                             selfemp <span class="sc">+</span> ptjob <span class="sc">+</span> western <span class="sc">+</span> nationelse,</span>
<span id="cb31-82"><a href="#cb31-82" aria-hidden="true" tabindex="-1"></a>                         <span class="at">data =</span> hospitalization, <span class="at">family =</span> poisson)</span>
<span id="cb31-83"><a href="#cb31-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-84"><a href="#cb31-84" aria-hidden="true" tabindex="-1"></a><span class="co"># GURM:97 tableau 6 p.236 ne correspond pas exactement</span></span>
<span id="cb31-85"><a href="#cb31-85" aria-hidden="true" tabindex="-1"></a>doctor_cal <span class="ot">&lt;-</span> doctor_cal <span class="sc">%&gt;%</span> <span class="fu">filter</span>(sample <span class="sc">==</span> <span class="st">"SSI"</span>)</span>
<span id="cb31-86"><a href="#cb31-86" aria-hidden="true" tabindex="-1"></a>p_doctor_cal <span class="ot">&lt;-</span> <span class="fu">glm</span>(visits <span class="sc">~</span> children <span class="sc">+</span> age <span class="sc">+</span> <span class="fu">I</span>(age <span class="sc">^</span> <span class="dv">2</span> <span class="sc">/</span> <span class="fl">1E02</span>) <span class="sc">+</span> <span class="fu">I</span>(income <span class="sc">/</span> <span class="fl">1E04</span>)  <span class="sc">+</span> pc1 <span class="sc">+</span> pc2 <span class="sc">+</span> <span class="fu">I</span>(access <span class="sc">/</span> <span class="fl">1E2</span>) <span class="sc">+</span></span>
<span id="cb31-87"><a href="#cb31-87" aria-hidden="true" tabindex="-1"></a>                        marital <span class="sc">+</span> sex <span class="sc">+</span> race <span class="sc">+</span> <span class="fu">I</span>(school <span class="sc">/</span> <span class="dv">10</span>) <span class="sc">+</span> enroll, <span class="at">data =</span> doctor_cal, <span class="at">family =</span> poisson)</span>
<span id="cb31-88"><a href="#cb31-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-89"><a href="#cb31-89" aria-hidden="true" tabindex="-1"></a><span class="co"># CAME:JOHA:97 tableau 4 page 215</span></span>
<span id="cb31-90"><a href="#cb31-90" aria-hidden="true" tabindex="-1"></a>p_bids <span class="ot">&lt;-</span> <span class="fu">glm</span>(numbids <span class="sc">~</span> legrest <span class="sc">+</span> realrest <span class="sc">+</span> finrest <span class="sc">+</span> whtknght <span class="sc">+</span> bidprem <span class="sc">+</span></span>
<span id="cb31-91"><a href="#cb31-91" aria-hidden="true" tabindex="-1"></a>        insthold <span class="sc">+</span> size <span class="sc">+</span> <span class="fu">I</span>(size <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">+</span> regulation,</span>
<span id="cb31-92"><a href="#cb31-92" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> bids, <span class="at">family =</span> poisson)</span>
<span id="cb31-93"><a href="#cb31-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-94"><a href="#cb31-94" aria-hidden="true" tabindex="-1"></a><span class="co"># ELLI:SWAN:16 tableau 3 page 1255 (negbin)</span></span>
<span id="cb31-95"><a href="#cb31-95" aria-hidden="true" tabindex="-1"></a>p_amc12 <span class="ot">&lt;-</span> <span class="fu">glm</span>(over100 <span class="sc">~</span> <span class="fu">log</span>(students) <span class="sc">+</span> bachelors <span class="sc">+</span> graduates <span class="sc">+</span> asian <span class="sc">+</span> black <span class="sc">+</span> hispanic <span class="sc">+</span></span>
<span id="cb31-96"><a href="#cb31-96" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">log</span>(medinc) <span class="sc">+</span> freelunch <span class="sc">+</span> t1 <span class="sc">+</span> urban <span class="sc">+</span> female,</span>
<span id="cb31-97"><a href="#cb31-97" aria-hidden="true" tabindex="-1"></a>               <span class="at">data =</span> amc12, <span class="at">family =</span> poisson)</span>
<span id="cb31-98"><a href="#cb31-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-99"><a href="#cb31-99" aria-hidden="true" tabindex="-1"></a><span class="co"># KOEN:ZEIL:09 table 2 p. 843</span></span>
<span id="cb31-100"><a href="#cb31-100" aria-hidden="true" tabindex="-1"></a>p_asymptotic <span class="ot">&lt;-</span> <span class="fu">glm</span>(nreg <span class="sc">~</span> <span class="fu">log</span>(nobs), <span class="at">data =</span> asymptotic, <span class="at">family =</span> poisson, <span class="at">weights =</span> <span class="dv">1</span> <span class="sc">/</span> neq)</span>
<span id="cb31-101"><a href="#cb31-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-102"><a href="#cb31-102" aria-hidden="true" tabindex="-1"></a><span class="co"># MILL:09 table 2 p. 762</span></span>
<span id="cb31-103"><a href="#cb31-103" aria-hidden="true" tabindex="-1"></a>p_cartels <span class="ot">&lt;-</span> <span class="fu">glm</span>(ncaught <span class="sc">~</span> len <span class="sc">+</span>  <span class="fu">poly</span>(lent, <span class="dv">5</span>) <span class="sc">+</span> dgdp <span class="sc">+</span> funds <span class="sc">+</span> fines, <span class="at">data =</span> cartels, <span class="at">family =</span> poisson)</span>
<span id="cb31-104"><a href="#cb31-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-105"><a href="#cb31-105" aria-hidden="true" tabindex="-1"></a><span class="co"># MULL:98 table 3 p. 273 (différents modèles compliqués</span></span>
<span id="cb31-106"><a href="#cb31-106" aria-hidden="true" tabindex="-1"></a>p_doctor_us <span class="ot">&lt;-</span> <span class="fu">glm</span>(doctvisits <span class="sc">~</span> age <span class="sc">+</span> male <span class="sc">+</span> white <span class="sc">+</span> school <span class="sc">+</span> married <span class="sc">+</span> health, <span class="at">data =</span> doctor_us, <span class="at">family =</span> poisson)</span>
<span id="cb31-107"><a href="#cb31-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-108"><a href="#cb31-108" aria-hidden="true" tabindex="-1"></a><span class="co"># SELL:STOL:CHAV:85</span></span>
<span id="cb31-109"><a href="#cb31-109" aria-hidden="true" tabindex="-1"></a>p_somerville <span class="ot">&lt;-</span> <span class="fu">glm</span>(visits <span class="sc">~</span> quality <span class="sc">+</span> ski <span class="sc">+</span> income <span class="sc">+</span> feesom <span class="sc">+</span> costcon <span class="sc">+</span> costsom <span class="sc">+</span> costhoust,</span>
<span id="cb31-110"><a href="#cb31-110" aria-hidden="true" tabindex="-1"></a>                    <span class="at">data =</span> somerville, <span class="at">family =</span> poisson)</span>
<span id="cb31-111"><a href="#cb31-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-112"><a href="#cb31-112" aria-hidden="true" tabindex="-1"></a><span class="co"># FISH:MIGU:07</span></span>
<span id="cb31-113"><a href="#cb31-113" aria-hidden="true" tabindex="-1"></a>parking <span class="ot">&lt;-</span> parking <span class="sc">%&gt;%</span> as_tibble</span>
<span id="cb31-114"><a href="#cb31-114" aria-hidden="true" tabindex="-1"></a>p_parking <span class="ot">&lt;-</span> <span class="fu">glm</span>(violations <span class="sc">~</span> corruption <span class="sc">*</span> post <span class="sc">+</span> staff <span class="sc">+</span> <span class="fu">log</span>(gdp) <span class="sc">+</span> region, <span class="at">data =</span> parking, <span class="at">family =</span> poisson)</span>
<span id="cb31-115"><a href="#cb31-115" aria-hidden="true" tabindex="-1"></a><span class="co">#MASS::glm.nb(violations ~ corruption + post + staff + log(gdp) + region, data = parking)</span></span>
<span id="cb31-116"><a href="#cb31-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-117"><a href="#cb31-117" aria-hidden="true" tabindex="-1"></a><span class="co"># AGHI:VANR:ZING:13</span></span>
<span id="cb31-118"><a href="#cb31-118" aria-hidden="true" tabindex="-1"></a>p_innovation <span class="ot">&lt;-</span> <span class="fu">glm</span>(citations <span class="sc">~</span> shareinstit <span class="sc">+</span> <span class="fu">log</span>(kl) <span class="sc">+</span> <span class="fu">log</span>(rdstock) <span class="sc">+</span> <span class="fu">log</span>(sales) <span class="sc">+</span></span>
<span id="cb31-119"><a href="#cb31-119" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">factor</span>(sector) <span class="sc">+</span> <span class="fu">factor</span>(year), <span class="at">data =</span> innovation, <span class="at">family =</span> poisson)</span>
<span id="cb31-120"><a href="#cb31-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-121"><a href="#cb31-121" aria-hidden="true" tabindex="-1"></a><span class="co"># GREE:97</span></span>
<span id="cb31-122"><a href="#cb31-122" aria-hidden="true" tabindex="-1"></a>majordrg <span class="ot">&lt;-</span> majordrg <span class="sc">%&gt;%</span> <span class="fu">filter</span>(cardhldr <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb31-123"><a href="#cb31-123" aria-hidden="true" tabindex="-1"></a>p_majordrg <span class="ot">&lt;-</span> <span class="fu">glm</span>(majordrg <span class="sc">~</span> age <span class="sc">+</span> income <span class="sc">+</span> expinc <span class="sc">+</span> avgexp <span class="sc">+</span> major, <span class="at">data =</span> majordrg, <span class="at">family =</span> poisson)</span>
<span id="cb31-124"><a href="#cb31-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-125"><a href="#cb31-125" aria-hidden="true" tabindex="-1"></a>p_publications <span class="ot">&lt;-</span> <span class="fu">glm</span>(articles <span class="sc">~</span> sex <span class="sc">+</span> marital <span class="sc">+</span> kids <span class="sc">+</span> phd <span class="sc">+</span> mentor, <span class="at">data =</span> publications, <span class="at">family =</span> poisson)</span>
<span id="cb31-126"><a href="#cb31-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-127"><a href="#cb31-127" aria-hidden="true" tabindex="-1"></a>lrNB1 <span class="ot">&lt;-</span> <span class="cf">function</span>(x){</span>
<span id="cb31-128"><a href="#cb31-128" aria-hidden="true" tabindex="-1"></a>    y <span class="ot">&lt;-</span> <span class="fu">model.response</span>(<span class="fu">model.frame</span>(x))</span>
<span id="cb31-129"><a href="#cb31-129" aria-hidden="true" tabindex="-1"></a>    mu <span class="ot">&lt;-</span> <span class="fu">fitted</span>(x)</span>
<span id="cb31-130"><a href="#cb31-130" aria-hidden="true" tabindex="-1"></a>    areg <span class="ot">&lt;-</span> <span class="fu">lm</span>( <span class="fu">I</span>( ((y <span class="sc">-</span> mu) <span class="sc">^</span> <span class="dv">2</span> <span class="sc">-</span> y) <span class="sc">/</span> mu) <span class="sc">~</span> <span class="dv">1</span>)</span>
<span id="cb31-131"><a href="#cb31-131" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coef</span>(<span class="fu">summary</span>(areg))[<span class="dv">3</span>]</span>
<span id="cb31-132"><a href="#cb31-132" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-133"><a href="#cb31-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-134"><a href="#cb31-134" aria-hidden="true" tabindex="-1"></a>za <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb31-135"><a href="#cb31-135" aria-hidden="true" tabindex="-1"></a>    <span class="sc">~</span> data,     <span class="sc">~</span> response,</span>
<span id="cb31-136"><a href="#cb31-136" aria-hidden="true" tabindex="-1"></a>    <span class="st">"doctor_aus"</span>, <span class="st">"doctorco"</span>,</span>
<span id="cb31-137"><a href="#cb31-137" aria-hidden="true" tabindex="-1"></a>    <span class="st">"health_ins"</span>, <span class="st">"mdu"</span>,</span>
<span id="cb31-138"><a href="#cb31-138" aria-hidden="true" tabindex="-1"></a>    <span class="st">"elderly"</span>, <span class="st">"ofp"</span>,</span>
<span id="cb31-139"><a href="#cb31-139" aria-hidden="true" tabindex="-1"></a>    <span class="st">"doctor_ger"</span>, <span class="st">"sdoctor"</span>,</span>
<span id="cb31-140"><a href="#cb31-140" aria-hidden="true" tabindex="-1"></a>    <span class="st">"hospitalization"</span>, <span class="st">"hospital"</span>,</span>
<span id="cb31-141"><a href="#cb31-141" aria-hidden="true" tabindex="-1"></a>    <span class="st">"doctor_cal"</span>, <span class="st">"visits"</span>,</span>
<span id="cb31-142"><a href="#cb31-142" aria-hidden="true" tabindex="-1"></a>    <span class="st">"health_reform"</span>, <span class="st">"visits"</span>,</span>
<span id="cb31-143"><a href="#cb31-143" aria-hidden="true" tabindex="-1"></a>    <span class="st">"doctor_us"</span>, <span class="st">"doctvisits"</span>,</span>
<span id="cb31-144"><a href="#cb31-144" aria-hidden="true" tabindex="-1"></a>    <span class="st">"strikes"</span>, <span class="st">"strikes"</span>,</span>
<span id="cb31-145"><a href="#cb31-145" aria-hidden="true" tabindex="-1"></a>    <span class="st">"trips"</span>, <span class="st">"trips"</span>,</span>
<span id="cb31-146"><a href="#cb31-146" aria-hidden="true" tabindex="-1"></a>    <span class="st">"cigmales"</span>, <span class="st">"cigarettes"</span>,</span>
<span id="cb31-147"><a href="#cb31-147" aria-hidden="true" tabindex="-1"></a>    <span class="st">"bids"</span>, <span class="st">"numbids"</span>,</span>
<span id="cb31-148"><a href="#cb31-148" aria-hidden="true" tabindex="-1"></a>    <span class="st">"amc12"</span>, <span class="st">"over100"</span>,</span>
<span id="cb31-149"><a href="#cb31-149" aria-hidden="true" tabindex="-1"></a>    <span class="st">"asymptotic"</span>, <span class="st">"nreg"</span>,</span>
<span id="cb31-150"><a href="#cb31-150" aria-hidden="true" tabindex="-1"></a>    <span class="st">"cartels"</span>, <span class="st">"ncaught"</span>,</span>
<span id="cb31-151"><a href="#cb31-151" aria-hidden="true" tabindex="-1"></a>    <span class="st">"somerville"</span>, <span class="st">"visits"</span>,</span>
<span id="cb31-152"><a href="#cb31-152" aria-hidden="true" tabindex="-1"></a><span class="co">#    "parking", "violations",</span></span>
<span id="cb31-153"><a href="#cb31-153" aria-hidden="true" tabindex="-1"></a><span class="co">#    "innovation", "citations",</span></span>
<span id="cb31-154"><a href="#cb31-154" aria-hidden="true" tabindex="-1"></a>    <span class="st">"majordrg"</span>, <span class="st">"majordrg"</span>,</span>
<span id="cb31-155"><a href="#cb31-155" aria-hidden="true" tabindex="-1"></a>    <span class="st">"publications"</span>, <span class="st">"articles"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-156"><a href="#cb31-156" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">reg =</span> <span class="fu">paste</span>(<span class="st">"p"</span>, data, <span class="at">sep =</span> <span class="st">"_"</span>))</span>
<span id="cb31-157"><a href="#cb31-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-158"><a href="#cb31-158" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(za),</span>
<span id="cb31-159"><a href="#cb31-159" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">function</span>(i){</span>
<span id="cb31-160"><a href="#cb31-160" aria-hidden="true" tabindex="-1"></a>                        y <span class="ot">&lt;-</span> <span class="fu">eval</span>(<span class="fu">as.name</span>(za<span class="sc">$</span>data[i]))[[za<span class="sc">$</span>response[i]]] ;</span>
<span id="cb31-161"><a href="#cb31-161" aria-hidden="true" tabindex="-1"></a>                        D9 <span class="ot">=</span> <span class="fu">as.numeric</span>(<span class="fu">quantile</span>(y, .<span class="dv">9</span>))</span>
<span id="cb31-162"><a href="#cb31-162" aria-hidden="true" tabindex="-1"></a>                        mu <span class="ot">=</span> <span class="fu">mean</span>(y)</span>
<span id="cb31-163"><a href="#cb31-163" aria-hidden="true" tabindex="-1"></a>                        sig2 <span class="ot">=</span> <span class="fu">var</span>(y)</span>
<span id="cb31-164"><a href="#cb31-164" aria-hidden="true" tabindex="-1"></a>                        over <span class="ot">=</span> sig2 <span class="sc">/</span> mu</span>
<span id="cb31-165"><a href="#cb31-165" aria-hidden="true" tabindex="-1"></a>                        mdel <span class="ot">&lt;-</span> <span class="fu">eval</span>(<span class="fu">as.name</span>(za<span class="sc">$</span>reg[i]))</span>
<span id="cb31-166"><a href="#cb31-166" aria-hidden="true" tabindex="-1"></a>                        test <span class="ot">&lt;-</span> <span class="fu">lrNB1</span>(mdel)</span>
<span id="cb31-167"><a href="#cb31-167" aria-hidden="true" tabindex="-1"></a>                        zero <span class="ot">&lt;-</span> <span class="fu">mean</span>(y <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb31-168"><a href="#cb31-168" aria-hidden="true" tabindex="-1"></a>                        fzero <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">dpois</span>(<span class="fu">fitted</span>(mdel), <span class="at">x =</span> <span class="dv">0</span>))</span>
<span id="cb31-169"><a href="#cb31-169" aria-hidden="true" tabindex="-1"></a>                        <span class="fu">c</span>(<span class="at">mu =</span> mu, <span class="at">omega =</span> sig2, <span class="at">over =</span> over, <span class="at">D9 =</span> D9, <span class="at">over =</span> over, <span class="at">zero =</span> zero,</span>
<span id="cb31-170"><a href="#cb31-170" aria-hidden="true" tabindex="-1"></a>                          <span class="at">fzero =</span> fzero, <span class="at">exczero =</span> zero <span class="sc">/</span> fzero, <span class="at">test =</span> test)</span>
<span id="cb31-171"><a href="#cb31-171" aria-hidden="true" tabindex="-1"></a>                    }</span>
<span id="cb31-172"><a href="#cb31-172" aria-hidden="true" tabindex="-1"></a>                    ))</span>
<span id="cb31-173"><a href="#cb31-173" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(results) <span class="ot">&lt;-</span> za<span class="sc">$</span>reg</span>
<span id="cb31-174"><a href="#cb31-174" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"kableExtra"</span>)</span>
<span id="cb31-175"><a href="#cb31-175" aria-hidden="true" tabindex="-1"></a>results <span class="sc">%&gt;%</span> <span class="fu">as_tibble</span>(<span class="at">rownames =</span> <span class="st">"data"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb31-176"><a href="#cb31-176" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span> test) <span class="sc">%&gt;%</span> </span>
<span id="cb31-177"><a href="#cb31-177" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="st">"$</span><span class="sc">\\</span><span class="st">mu$"</span> <span class="ot">=</span> mu, <span class="st">"$</span><span class="sc">\\</span><span class="st">sigma ^ 2$"</span> <span class="ot">=</span> omega,</span>
<span id="cb31-178"><a href="#cb31-178" aria-hidden="true" tabindex="-1"></a>           <span class="st">"$</span><span class="sc">\\</span><span class="st">frac{</span><span class="sc">\\</span><span class="st">sigma ^ 2}{</span><span class="sc">\\</span><span class="st">mu}$"</span> <span class="ot">=</span> over,</span>
<span id="cb31-179"><a href="#cb31-179" aria-hidden="true" tabindex="-1"></a>           <span class="st">"$P(Y = 0)$"</span> <span class="ot">=</span> zero,</span>
<span id="cb31-180"><a href="#cb31-180" aria-hidden="true" tabindex="-1"></a>           <span class="st">"$</span><span class="sc">\\</span><span class="st">hat{P}(Y = 0)$"</span> <span class="ot">=</span> fzero,</span>
<span id="cb31-181"><a href="#cb31-181" aria-hidden="true" tabindex="-1"></a>           <span class="st">"$</span><span class="sc">\\</span><span class="st">frac{P(Y = 0)}{</span><span class="sc">\\</span><span class="st">hat{P}(Y = 0)}$"</span> <span class="ot">=</span> exczero) <span class="sc">%&gt;%</span></span>
<span id="cb31-182"><a href="#cb31-182" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">data =</span> <span class="fu">str_sub</span>(data, <span class="dv">3</span>),</span>
<span id="cb31-183"><a href="#cb31-183" aria-hidden="true" tabindex="-1"></a>           <span class="at">data =</span> <span class="fu">str_replace</span>(data, <span class="st">"_"</span>, <span class="st">"."</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-184"><a href="#cb31-184" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(data) <span class="sc">%&gt;%</span> </span>
<span id="cb31-185"><a href="#cb31-185" aria-hidden="true" tabindex="-1"></a><span class="co">#  add_column(ref = c("@CAME:TRIV:86", "@TERZ:98", rep("un", 16)), .before = 2) %&gt;% </span></span>
<span id="cb31-186"><a href="#cb31-186" aria-hidden="true" tabindex="-1"></a>    knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="at">digits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">1</span>), <span class="at">format =</span> <span class="st">"latex"</span>,</span>
<span id="cb31-187"><a href="#cb31-187" aria-hidden="true" tabindex="-1"></a>                 <span class="at">escape =</span> <span class="cn">FALSE</span>, <span class="at">booktabs =</span> <span class="cn">TRUE</span>)<span class="co"># %&gt;%</span></span>
<span id="cb31-188"><a href="#cb31-188" aria-hidden="true" tabindex="-1"></a>    <span class="co">#kable_styling()</span></span>
<span id="cb31-189"><a href="#cb31-189" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-190"><a href="#cb31-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-191"><a href="#cb31-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-192"><a href="#cb31-192" aria-hidden="true" tabindex="-1"></a>About half of these data sets concern demand for health</span>
<span id="cb31-193"><a href="#cb31-193" aria-hidden="true" tabindex="-1"></a>care. <span class="in">`doctor_aus`</span> <span class="co">[</span><span class="ot">@CAME:TRIV:86</span><span class="co">]</span>\idxdata{doctor<span class="sc">\_</span>aus}{micsr.count}, <span class="in">`doctor_cal`</span> <span class="co">[</span><span class="ot">@GURM:97</span><span class="co">]</span>\idxdata{doctor<span class="sc">\_</span>cal}{micsr.count}, <span class="in">`doctor_ger`</span></span>
<span id="cb31-194"><a href="#cb31-194" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">@SANT:WIND:01</span><span class="co">]</span>\idxdata{doctor<span class="sc">\_</span>ger}{micsr.count} and <span class="in">`doctor_us`</span> <span class="co">[</span><span class="ot">@MULL:98</span><span class="co">]</span>\idxdata{doctor<span class="sc">\_</span>us}{micsr.count} concern</span>
<span id="cb31-195"><a href="#cb31-195" aria-hidden="true" tabindex="-1"></a>annual doctor visits, respectively in Australia, California, Germany</span>
<span id="cb31-196"><a href="#cb31-196" aria-hidden="true" tabindex="-1"></a>and the United States. <span class="in">`health_ins`</span> <span class="co">[</span><span class="ot">@DEB:TRIV:02</span><span class="co">]</span>\idxdata{health<span class="sc">\_</span>ins}{micsr.count} focuses on the link between health insurance</span>
<span id="cb31-197"><a href="#cb31-197" aria-hidden="true" tabindex="-1"></a>and doctor visits using a randomized experiment in the United States,</span>
<span id="cb31-198"><a href="#cb31-198" aria-hidden="true" tabindex="-1"></a>as <span class="in">`health_reform`</span> <span class="co">[</span><span class="ot">@WINK:04</span><span class="co">]</span>\idxdata{health<span class="sc">\_</span>reform}{micsr.count} analyzes the effect of a health insurance reform in</span>
<span id="cb31-199"><a href="#cb31-199" aria-hidden="true" tabindex="-1"></a>Germany. <span class="in">`elderly`</span> <span class="co">[</span><span class="ot">@DEB:TRIV:97</span><span class="co">]</span>\idxdata{elderly}{micsr.count}  focus on the demand for health care by elderly in</span>
<span id="cb31-200"><a href="#cb31-200" aria-hidden="true" tabindex="-1"></a>the US and <span class="in">`hospitalization`</span> <span class="co">[</span><span class="ot">@GEIL:MILL:ROTT:ZIMM:97</span><span class="co">]</span>\idxdata{hospitalization}{micsr.count} uses as the response the number of stays in</span>
<span id="cb31-201"><a href="#cb31-201" aria-hidden="true" tabindex="-1"></a>the hospital.</span>
<span id="cb31-202"><a href="#cb31-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-203"><a href="#cb31-203" aria-hidden="true" tabindex="-1"></a>The response of <span class="in">`amc12`</span> <span class="co">[</span><span class="ot">@ELLI:SWAN:16</span><span class="co">]</span>\idxdata{amc12}{micsr.count} is the number of students per school who got a very high</span>
<span id="cb31-204"><a href="#cb31-204" aria-hidden="true" tabindex="-1"></a>score at the AMC12 test (a test in mathematics). <span class="in">`asymptotic`</span></span>
<span id="cb31-205"><a href="#cb31-205" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">@KOEN:ZEIL:09</span><span class="co">]</span>\idxdata{asymptotic}{micsr.count} is a</span>
<span id="cb31-206"><a href="#cb31-206" aria-hidden="true" tabindex="-1"></a>meta-analysis of wage equations reported in 156 papers and the</span>
<span id="cb31-207"><a href="#cb31-207" aria-hidden="true" tabindex="-1"></a>analysis stresses on the hypothesis used to get the consistency of an</span>
<span id="cb31-208"><a href="#cb31-208" aria-hidden="true" tabindex="-1"></a>estimator, i.e., that the number of regressors is fixed as the number of</span>
<span id="cb31-209"><a href="#cb31-209" aria-hidden="true" tabindex="-1"></a>observations increases. <span class="in">`bids`</span> <span class="co">[</span><span class="ot">@CAME:JOHA:97</span><span class="co">]</span>\idxdata{bids}{micsr.count} analyzes the number of bids received by</span>
<span id="cb31-210"><a href="#cb31-210" aria-hidden="true" tabindex="-1"></a>126 firms that were targets of tender offers. <span class="in">`cartels`</span> <span class="co">[</span><span class="ot">@MILL:09</span><span class="co">]</span>\idxdata{cartels}{micsr.count} is a time</span>
<span id="cb31-211"><a href="#cb31-211" aria-hidden="true" tabindex="-1"></a>series of bi-annual observations, the response being the number of</span>
<span id="cb31-212"><a href="#cb31-212" aria-hidden="true" tabindex="-1"></a>cartels discoveries and the main covariate the pre- and post-period</span>
<span id="cb31-213"><a href="#cb31-213" aria-hidden="true" tabindex="-1"></a>when a new leniency program was introduced. <span class="in">`cigmales`</span> <span class="co">[</span><span class="ot">@MULL:97</span><span class="co">]</span>\idxdata{cigmales}{micsr} measures the number of cigarettes smoked daily by males in the United</span>
<span id="cb31-214"><a href="#cb31-214" aria-hidden="true" tabindex="-1"></a>States. <span class="in">`majordrg`</span> <span class="co">[</span><span class="ot">@GREE:01</span><span class="co">]</span>\idxdata{majordrg}{micsr.count} contain data about the number of major derogatory</span>
<span id="cb31-215"><a href="#cb31-215" aria-hidden="true" tabindex="-1"></a>reports by cardholders. <span class="in">`publications`</span> <span class="co">[</span><span class="ot">@LONG:97</span><span class="co">]</span>\idxdata{publications}{micsr.count} analyzes the</span>
<span id="cb31-216"><a href="#cb31-216" aria-hidden="true" tabindex="-1"></a>scientific production (measured by the number of publications) of</span>
<span id="cb31-217"><a href="#cb31-217" aria-hidden="true" tabindex="-1"></a>individuals who got a PhD in biochemistry. <span class="in">`somerville`</span></span>
<span id="cb31-218"><a href="#cb31-218" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">@SELL:STOL:CHAV:85</span><span class="co">]</span>\idxdata{somerville}{micsr.count} reports the</span>
<span id="cb31-219"><a href="#cb31-219" aria-hidden="true" tabindex="-1"></a>number of recreational visits to a lake in Texas. <span class="in">`strikes`</span> <span class="co">[</span><span class="ot">@KENN:85</span><span class="co">]</span>\idxdata{strikes}{micsr.count} is a time</span>
<span id="cb31-220"><a href="#cb31-220" aria-hidden="true" tabindex="-1"></a>series that reports the number of strikes (and also their length) in</span>
<span id="cb31-221"><a href="#cb31-221" aria-hidden="true" tabindex="-1"></a>the United States.  <span class="in">`trips`</span> <span class="co">[</span><span class="ot">@TERZ:98</span><span class="co">]</span>\idxdata{trips}{micsr} contains the number of trips taken by</span>
<span id="cb31-222"><a href="#cb31-222" aria-hidden="true" tabindex="-1"></a>members of households the day prior the survey interview.</span>
<span id="cb31-223"><a href="#cb31-223" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Cameron}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Trivedi}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Winkelman}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Kennan}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Terza}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Mullahy}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Deb}</span>
<span id="cb31-224"><a href="#cb31-224" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Santos Silva}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Windmeijer}</span>
<span id="cb31-225"><a href="#cb31-225" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Geil}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Rotte}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Zimmermann}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Million}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Gurmu}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Johansson}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Ellison}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Swanson}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Koenker}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Zeileis}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Miller}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Seller}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Stoll}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Chavas}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Greene}</span>
<span id="cb31-226"><a href="#cb31-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-227"><a href="#cb31-227" aria-hidden="true" tabindex="-1"></a>As we have seen in @sec-poisson_ml, count data can be considered as a random variable that follows a Poisson distribution, which has a unique parameter, this parameter being the mean and the variance of the series. The ML estimator of this parameter is the sample mean, which is indicated in</span>
<span id="cb31-228"><a href="#cb31-228" aria-hidden="true" tabindex="-1"></a>the first column ($\mu$) of  @tbl-empsurvey. The empirical</span>
<span id="cb31-229"><a href="#cb31-229" aria-hidden="true" tabindex="-1"></a>variance ($\omega$) is reported in the second column. </span>
<span id="cb31-230"><a href="#cb31-230" aria-hidden="true" tabindex="-1"></a>Count data often take small values, and this is the case for almost all</span>
<span id="cb31-231"><a href="#cb31-231" aria-hidden="true" tabindex="-1"></a>our data sets. We report in @tbl-empsurvey the 9th decile, which is less</span>
<span id="cb31-232"><a href="#cb31-232" aria-hidden="true" tabindex="-1"></a>than 10 for a majority of the data sets. Noticeable exceptions are</span>
<span id="cb31-233"><a href="#cb31-233" aria-hidden="true" tabindex="-1"></a><span class="in">`asymptotic`</span>\idxdata{asymptotic}{micsr.count} (the number of covariates in an econometric equation) and</span>
<span id="cb31-234"><a href="#cb31-234" aria-hidden="true" tabindex="-1"></a><span class="in">`cigmales`</span>\idxdata{cigmales}{micsr} (the number of cigarettes smoked daily).</span>
<span id="cb31-235"><a href="#cb31-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-236"><a href="#cb31-236" aria-hidden="true" tabindex="-1"></a>While comparing real count data to Poisson distribution, one often</span>
<span id="cb31-237"><a href="#cb31-237" aria-hidden="true" tabindex="-1"></a>faces two problems:</span>
<span id="cb31-238"><a href="#cb31-238" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{overdispersion}\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{excess of zero}</span>
<span id="cb31-239"><a href="#cb31-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-240"><a href="#cb31-240" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**overdispersion**, which means that the variance is</span>
<span id="cb31-241"><a href="#cb31-241" aria-hidden="true" tabindex="-1"></a>  much greater than the mean,</span>
<span id="cb31-242"><a href="#cb31-242" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**excess of zero**, which means that</span>
<span id="cb31-243"><a href="#cb31-243" aria-hidden="true" tabindex="-1"></a>  the mean probability of a zero value computed using the Poisson</span>
<span id="cb31-244"><a href="#cb31-244" aria-hidden="true" tabindex="-1"></a>  distribution is often much less than the observed share of zero in</span>
<span id="cb31-245"><a href="#cb31-245" aria-hidden="true" tabindex="-1"></a>  the sample.</span>
<span id="cb31-246"><a href="#cb31-246" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-247"><a href="#cb31-247" aria-hidden="true" tabindex="-1"></a>\newpage</span>
<span id="cb31-248"><a href="#cb31-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-249"><a href="#cb31-249" aria-hidden="true" tabindex="-1"></a>The third column of @tbl-empsurvey contains the mean variance</span>
<span id="cb31-250"><a href="#cb31-250" aria-hidden="true" tabindex="-1"></a>ratio and shows that overdispersion seems to be the rule. The ratio is</span>
<span id="cb31-251"><a href="#cb31-251" aria-hidden="true" tabindex="-1"></a>in general much larger than 1, noticeable exceptions being <span class="in">`bids`</span>\idxdata{bids}{micsr.count},</span>
<span id="cb31-252"><a href="#cb31-252" aria-hidden="true" tabindex="-1"></a><span class="in">`cartels`</span>\idxdata{cartels}{micsr.count} and <span class="in">`majordrg`</span>\idxdata{majordrg}{micsr.count}. This overdispersion is important because we</span>
<span id="cb31-253"><a href="#cb31-253" aria-hidden="true" tabindex="-1"></a>consider that the Poisson parameter is the same for every observation. Adding covariates</span>
<span id="cb31-254"><a href="#cb31-254" aria-hidden="true" tabindex="-1"></a>will give specific values of the Poisson parameter for every observations and will therefore reduce</span>
<span id="cb31-255"><a href="#cb31-255" aria-hidden="true" tabindex="-1"></a>the (conditional) variance. Anyway, we'll see in subsequent sections</span>
<span id="cb31-256"><a href="#cb31-256" aria-hidden="true" tabindex="-1"></a>that the overdispersion problem is often still present even after introducing </span>
<span id="cb31-257"><a href="#cb31-257" aria-hidden="true" tabindex="-1"></a>covariates, because of unobserved heterogeneity. </span>
<span id="cb31-258"><a href="#cb31-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-259"><a href="#cb31-259" aria-hidden="true" tabindex="-1"></a>The excess of zero problem is difficult to distinguish from</span>
<span id="cb31-260"><a href="#cb31-260" aria-hidden="true" tabindex="-1"></a>overdispersion, as zero is an extreme value of the distribution and</span>
<span id="cb31-261"><a href="#cb31-261" aria-hidden="true" tabindex="-1"></a>therefore, an excess of zero leads to overdispersion. The excess of</span>
<span id="cb31-262"><a href="#cb31-262" aria-hidden="true" tabindex="-1"></a>zero can in part be explained by the fact that 0 is a special value</span>
<span id="cb31-263"><a href="#cb31-263" aria-hidden="true" tabindex="-1"></a>that may not be correctly explained by the same process that explains</span>
<span id="cb31-264"><a href="#cb31-264" aria-hidden="true" tabindex="-1"></a>strictly positive values. An example is <span class="in">`cigmales`</span>\idxdata{cigmales}{micsr}, where 0 means no smoking, and smoking vs. non-smoking is quite different in nature than</span>
<span id="cb31-265"><a href="#cb31-265" aria-hidden="true" tabindex="-1"></a>smoking a few or a lot of cigarettes. The eighth column of @tbl-empsurvey returns the</span>
<span id="cb31-266"><a href="#cb31-266" aria-hidden="true" tabindex="-1"></a>ratio between the empirical share of zero and the Poisson probability of 0 and, unsurprisingly, this ratio is huge for <span class="in">`cigmales`</span>\idxdata{cigmales}{micsr}.</span>
<span id="cb31-267"><a href="#cb31-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-268"><a href="#cb31-268" aria-hidden="true" tabindex="-1"></a><span class="fu">### Analyzing the number of trips</span></span>
<span id="cb31-269"><a href="#cb31-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-270"><a href="#cb31-270" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">(</span><span class="co">]</span>{trips}{micsr}</span>
<span id="cb31-271"><a href="#cb31-271" aria-hidden="true" tabindex="-1"></a>Throughout this chapter, we'll use the <span class="in">`trips`</span> data set. It was used by @TERZ:98\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Terza} and the response is the number of trips taken the day before the</span>
<span id="cb31-272"><a href="#cb31-272" aria-hidden="true" tabindex="-1"></a>interview. </span>
<span id="cb31-273"><a href="#cb31-273" aria-hidden="true" tabindex="-1"></a>We first consider the unconditional distribution of the number of</span>
<span id="cb31-274"><a href="#cb31-274" aria-hidden="true" tabindex="-1"></a><span class="in">`trips`</span>\idxdata{trips}{micsr}, computing the first two moments and the share of 0:</span>
<span id="cb31-275"><a href="#cb31-275" aria-hidden="true" tabindex="-1"></a>\idxfun{summarise}{dplyr}\idxfun{var}{stats}</span>
<span id="cb31-276"><a href="#cb31-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-277"><a href="#cb31-277" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb31-278"><a href="#cb31-278" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: true</span></span>
<span id="cb31-279"><a href="#cb31-279" aria-hidden="true" tabindex="-1"></a>trips <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">m =</span> <span class="fu">mean</span>(trips), <span class="at">v =</span> <span class="fu">var</span>(trips), </span>
<span id="cb31-280"><a href="#cb31-280" aria-hidden="true" tabindex="-1"></a>                    <span class="at">s0 =</span> <span class="fu">mean</span>(trips <span class="sc">==</span> <span class="dv">0</span>))</span>
<span id="cb31-281"><a href="#cb31-281" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-282"><a href="#cb31-282" aria-hidden="true" tabindex="-1"></a>This series exhibits important overdispersion, as the variance is</span>
<span id="cb31-283"><a href="#cb31-283" aria-hidden="true" tabindex="-1"></a>about 5 times larger than the mean. The ML estimator is the sample</span>
<span id="cb31-284"><a href="#cb31-284" aria-hidden="true" tabindex="-1"></a>mean, and therefore, the predicted probability of 0 for the Poisson model is:</span>
<span id="cb31-285"><a href="#cb31-285" aria-hidden="true" tabindex="-1"></a>\idxfun{dpois}{stats}</span>
<span id="cb31-286"><a href="#cb31-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-287"><a href="#cb31-287" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb31-288"><a href="#cb31-288" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: true</span></span>
<span id="cb31-289"><a href="#cb31-289" aria-hidden="true" tabindex="-1"></a><span class="fu">dpois</span>(<span class="dv">0</span>, <span class="fl">4.551</span>)</span>
<span id="cb31-290"><a href="#cb31-290" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-291"><a href="#cb31-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-292"><a href="#cb31-292" aria-hidden="true" tabindex="-1"></a>which is much lower than the actual percentage of 0 which is</span>
<span id="cb31-293"><a href="#cb31-293" aria-hidden="true" tabindex="-1"></a>18.5\%. There is therefore a large excess of 0, which also can be</span>
<span id="cb31-294"><a href="#cb31-294" aria-hidden="true" tabindex="-1"></a>associated with overdispersion as 0 is a value far from the mean of</span>
<span id="cb31-295"><a href="#cb31-295" aria-hidden="true" tabindex="-1"></a>4.551.</span>
<span id="cb31-296"><a href="#cb31-296" aria-hidden="true" tabindex="-1"></a>The **topmodels** package^[The **topmodels** package is not on CRAN; it can be installed using <span class="in">`install.packages("topmodels", repos="http://R-Forge.R-project.org")`</span>.] provides an interesting plotting function</span>
<span id="cb31-297"><a href="#cb31-297" aria-hidden="true" tabindex="-1"></a>called <span class="in">`rootogram`</span> to compare the actual and the fitted distribution</span>
<span id="cb31-298"><a href="#cb31-298" aria-hidden="true" tabindex="-1"></a>of a count. The first is represented by bars and the second by</span>
<span id="cb31-299"><a href="#cb31-299" aria-hidden="true" tabindex="-1"></a> a curve. The most simple representation is obtained</span>
<span id="cb31-300"><a href="#cb31-300" aria-hidden="true" tabindex="-1"></a>by setting the <span class="in">`style`</span> and the <span class="in">`scale`</span> parameters respectively to</span>
<span id="cb31-301"><a href="#cb31-301" aria-hidden="true" tabindex="-1"></a><span class="in">`"standing"`</span> and <span class="in">`"raw"`</span> (see @fig-tripsuncond). With the first, the bottom of all</span>
<span id="cb31-302"><a href="#cb31-302" aria-hidden="true" tabindex="-1"></a>the bars is on the horizontal axes; with the second one, the absolute</span>
<span id="cb31-303"><a href="#cb31-303" aria-hidden="true" tabindex="-1"></a>frequencies are displayed on the vertical axes. For example, for</span>
<span id="cb31-304"><a href="#cb31-304" aria-hidden="true" tabindex="-1"></a>$Y=0$, the absolute frequency is <span class="in">`r sum(trips$trips == 0)`</span> and, as</span>
<span id="cb31-305"><a href="#cb31-305" aria-hidden="true" tabindex="-1"></a>seen previously, the fitted probability is $0.01056$ which implies, as</span>
<span id="cb31-306"><a href="#cb31-306" aria-hidden="true" tabindex="-1"></a>the number of observations is <span class="in">`r nrow(trips)`</span>,  a fitted</span>
<span id="cb31-307"><a href="#cb31-307" aria-hidden="true" tabindex="-1"></a>frequency of $577 \times 0.01056 = 6.1$. The frequencies are clearly</span>
<span id="cb31-308"><a href="#cb31-308" aria-hidden="true" tabindex="-1"></a>over-estimated for values of the response close to the mean (3, 4, 5,</span>
<span id="cb31-309"><a href="#cb31-309" aria-hidden="true" tabindex="-1"></a>6) and under-estimated for extreme values. This is particularly the</span>
<span id="cb31-310"><a href="#cb31-310" aria-hidden="true" tabindex="-1"></a>case for 0, which indicates that a specific problem of excess of zero</span>
<span id="cb31-311"><a href="#cb31-311" aria-hidden="true" tabindex="-1"></a>may be present.^<span class="co">[</span><span class="ot">Note the use of `ggplot2::autoplot` that coerces a graphical object to a `ggplot` object.</span><span class="co">]</span></span>
<span id="cb31-312"><a href="#cb31-312" aria-hidden="true" tabindex="-1"></a>\idxfun{rootogram}{countreg}\idxfun{coord<span class="sc">\_</span>cartesian}{ggplot2}\idxfun{autoplot}{ggplot2}</span>
<span id="cb31-313"><a href="#cb31-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-314"><a href="#cb31-314" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb31-315"><a href="#cb31-315" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-tripsuncond</span></span>
<span id="cb31-316"><a href="#cb31-316" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Unconditional distribution of trips"</span></span>
<span id="cb31-317"><a href="#cb31-317" aria-hidden="true" tabindex="-1"></a>uncond_trips <span class="ot">&lt;-</span> <span class="fu">glm</span>(trips <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> trips, <span class="at">family =</span> <span class="st">"poisson"</span>)</span>
<span id="cb31-318"><a href="#cb31-318" aria-hidden="true" tabindex="-1"></a>topmodels<span class="sc">::</span><span class="fu">rootogram</span>(uncond_trips, <span class="at">plot =</span> <span class="cn">FALSE</span>, <span class="at">breaks =</span> (<span class="dv">0</span><span class="sc">:</span><span class="dv">16</span>) <span class="sc">-</span> <span class="fl">0.5</span>,</span>
<span id="cb31-319"><a href="#cb31-319" aria-hidden="true" tabindex="-1"></a>                    <span class="at">style =</span> <span class="st">"standing"</span>, <span class="at">scale =</span> <span class="st">"raw"</span>, <span class="at">confint =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-320"><a href="#cb31-320" aria-hidden="true" tabindex="-1"></a>  autoplot <span class="sc">+</span> <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">15</span>))</span>
<span id="cb31-321"><a href="#cb31-321" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-322"><a href="#cb31-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-323"><a href="#cb31-323" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">)</span><span class="co">]</span>{trips}{micsr}</span>
<span id="cb31-324"><a href="#cb31-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-325"><a href="#cb31-325" aria-hidden="true" tabindex="-1"></a><span class="fu">## Poisson model {#sec-poisson_model}</span></span>
<span id="cb31-326"><a href="#cb31-326" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{Poisson model|(}</span>
<span id="cb31-327"><a href="#cb31-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-328"><a href="#cb31-328" aria-hidden="true" tabindex="-1"></a><span class="fu">### Derivation of the Poisson model</span></span>
<span id="cb31-329"><a href="#cb31-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-330"><a href="#cb31-330" aria-hidden="true" tabindex="-1"></a>The basic count data model is the Poisson model. It relies on the</span>
<span id="cb31-331"><a href="#cb31-331" aria-hidden="true" tabindex="-1"></a>hypothesis that the response is a Poisson variable and therefore that the probability of a given value $y$ is:</span>
<span id="cb31-332"><a href="#cb31-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-333"><a href="#cb31-333" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-334"><a href="#cb31-334" aria-hidden="true" tabindex="-1"></a>\mbox{P}(Y = y, \mu) = \frac{e^{-\mu}{\mu} ^ y}{y !}</span>
<span id="cb31-335"><a href="#cb31-335" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-336"><a href="#cb31-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-337"><a href="#cb31-337" aria-hidden="true" tabindex="-1"></a>The Poisson distribution is defined by a unique parameter $\mu$,</span>
<span id="cb31-338"><a href="#cb31-338" aria-hidden="true" tabindex="-1"></a>which is the mean and the variance of the distribution. This is a</span>
<span id="cb31-339"><a href="#cb31-339" aria-hidden="true" tabindex="-1"></a>striking feature of the Poisson distribution which differs for</span>
<span id="cb31-340"><a href="#cb31-340" aria-hidden="true" tabindex="-1"></a>example from the normal distribution which has two separate position</span>
<span id="cb31-341"><a href="#cb31-341" aria-hidden="true" tabindex="-1"></a>and dispersion parameters (respectively the mean and the standard</span>
<span id="cb31-342"><a href="#cb31-342" aria-hidden="true" tabindex="-1"></a>deviation). The Poisson probability can also be written as:</span>
<span id="cb31-343"><a href="#cb31-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-344"><a href="#cb31-344" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-345"><a href="#cb31-345" aria-hidden="true" tabindex="-1"></a>\mbox{P}(Y = y, \mu) = e^{y \ln \mu-\mu- \ln y !}</span>
<span id="cb31-346"><a href="#cb31-346" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-347"><a href="#cb31-347" aria-hidden="true" tabindex="-1"></a>and therefore, the Poisson model belongs to the generalized linear model family (see @sec-glm), with $\theta = \ln \mu$, $b(\theta) = \mu = e^ \theta$, $\phi = 1$ and $c(y, \phi) = - \ln y !$. The mean is $b'(\theta) = e ^ \theta = \mu$ and the variance $\phi b''(\theta) = e ^ \theta  = \mu$. The link defines the relation between the linear predictor $\eta$ and the parameter of the distribution $\mu$: $\eta = g(\mu)$. The canonical link\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{link!canonical} is such that $\theta = \eta$ and it is therefore, for the Poisson model, the log link: $\eta = \ln \mu$. For a given set of covariates, the Poisson parameter for observation $n$ is $\mu_n = g ^ {-1}(\eta_n)$, with $\eta_n = \alpha + \beta ^ \top x_n = \gamma ^ \top z_n$ the linear predictor. Therefore:\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{link!log}</span>
<span id="cb31-348"><a href="#cb31-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-349"><a href="#cb31-349" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-350"><a href="#cb31-350" aria-hidden="true" tabindex="-1"></a>\mu_n = \mbox{E}(y \mid x_n) = e^{\alpha + \beta^\top x_n} = e^{\gamma ^ \top z_n}</span>
<span id="cb31-351"><a href="#cb31-351" aria-hidden="true" tabindex="-1"></a>$$ {#eq-condexp_poisson}</span>
<span id="cb31-352"><a href="#cb31-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-353"><a href="#cb31-353" aria-hidden="true" tabindex="-1"></a>and the log-likelihood function is:</span>
<span id="cb31-354"><a href="#cb31-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-355"><a href="#cb31-355" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-356"><a href="#cb31-356" aria-hidden="true" tabindex="-1"></a>\ln L (\gamma, y, Z) = \sum_{n=1} ^ N \ln \frac{e^{-e^{\gamma^\top z_n}}</span>
<span id="cb31-357"><a href="#cb31-357" aria-hidden="true" tabindex="-1"></a>e ^{y_n\gamma ^ \top z_n}}{y_n !} = \sum_{n=1} ^ N -e^{\gamma^\top z_n} +</span>
<span id="cb31-358"><a href="#cb31-358" aria-hidden="true" tabindex="-1"></a>y_n \gamma^\top z_n - \ln y_n !</span>
<span id="cb31-359"><a href="#cb31-359" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-360"><a href="#cb31-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-361"><a href="#cb31-361" aria-hidden="true" tabindex="-1"></a>The first-order conditions for a maximum are:</span>
<span id="cb31-362"><a href="#cb31-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-363"><a href="#cb31-363" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-364"><a href="#cb31-364" aria-hidden="true" tabindex="-1"></a>\frac{\partial \ln L}{\partial \gamma} = \sum_{n = 1} ^ N \left(y_n -</span>
<span id="cb31-365"><a href="#cb31-365" aria-hidden="true" tabindex="-1"></a>e^{\gamma^\top z_n}\right)z_n = 0</span>
<span id="cb31-366"><a href="#cb31-366" aria-hidden="true" tabindex="-1"></a>$$ {#eq-foc_poisson}</span>
<span id="cb31-367"><a href="#cb31-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-368"><a href="#cb31-368" aria-hidden="true" tabindex="-1"></a>which states, as in the OLS model, that the difference between the actual value of the response $y$</span>
<span id="cb31-369"><a href="#cb31-369" aria-hidden="true" tabindex="-1"></a>and the prediction of the model (which can be called the residual) should be</span>
<span id="cb31-370"><a href="#cb31-370" aria-hidden="true" tabindex="-1"></a>orthogonal to every covariate. It is a very important property, as it</span>
<span id="cb31-371"><a href="#cb31-371" aria-hidden="true" tabindex="-1"></a>implies that the Poisson model is consistent if the conditional</span>
<span id="cb31-372"><a href="#cb31-372" aria-hidden="true" tabindex="-1"></a>expectation function is correctly specified, whether or not the</span>
<span id="cb31-373"><a href="#cb31-373" aria-hidden="true" tabindex="-1"></a>hypothesis of the Poisson distribution is correct. Moreover, as the first element of $z_n$ is 1, the first element of @eq-foc_poisson implies that:</span>
<span id="cb31-374"><a href="#cb31-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-375"><a href="#cb31-375" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-376"><a href="#cb31-376" aria-hidden="true" tabindex="-1"></a>\bar{y} = \frac{1}{N} \sum_{n=1} ^N e ^ {\hat{\gamma}^\top z_n}</span>
<span id="cb31-377"><a href="#cb31-377" aria-hidden="true" tabindex="-1"></a>$$ {#eq-mean_me_poisson}</span>
<span id="cb31-378"><a href="#cb31-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-379"><a href="#cb31-379" aria-hidden="true" tabindex="-1"></a>which means that the mean of the predictions equals the mean value of $y$ in the sample.</span>
<span id="cb31-380"><a href="#cb31-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-381"><a href="#cb31-381" aria-hidden="true" tabindex="-1"></a>For the <span class="in">`trips`</span> data set, the covariates are the share of trips for work or school</span>
<span id="cb31-382"><a href="#cb31-382" aria-hidden="true" tabindex="-1"></a>(<span class="in">`workschl`</span>), the number of individuals in the household (<span class="in">`size`</span>), the</span>
<span id="cb31-383"><a href="#cb31-383" aria-hidden="true" tabindex="-1"></a>distance to the central business district (<span class="in">`dist`</span>), a dummy (<span class="in">`smsa`</span>)</span>
<span id="cb31-384"><a href="#cb31-384" aria-hidden="true" tabindex="-1"></a>for large urban area, the number of full-time</span>
<span id="cb31-385"><a href="#cb31-385" aria-hidden="true" tabindex="-1"></a>workers in a household (<span class="in">`fulltime`</span>), the distance from home to the nearest</span>
<span id="cb31-386"><a href="#cb31-386" aria-hidden="true" tabindex="-1"></a>transit node (<span class="in">`distnode`</span>), household income divided by the median income of the</span>
<span id="cb31-387"><a href="#cb31-387" aria-hidden="true" tabindex="-1"></a>census tract (<span class="in">`realinc`</span>), a dummy if the survey period is Saturday or</span>
<span id="cb31-388"><a href="#cb31-388" aria-hidden="true" tabindex="-1"></a>Sunday (<span class="in">`weekend`</span>) and a dummy for owning at least one car (<span class="in">`car`</span>). The Poisson model is fitted using the <span class="in">`glm`</span> function and setting the <span class="in">`family`</span> argument to <span class="in">`poisson`</span>. As for the binomial model, the <span class="in">`family`</span> argument can be a character, a function without argument (in this case, the default link is chosen) or a function with a link argument.^<span class="co">[</span><span class="ot">The other possible other links for the Poisson model are `"identity"` and `"sqrt"`, but the default `"log"` link is almost always used.</span><span class="co">]</span> For the sake of comparison, we also estimate a linear model using <span class="in">`lm`</span>:</span>
<span id="cb31-389"><a href="#cb31-389" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">(</span><span class="co">]</span>{trips}{micsr}</span>
<span id="cb31-390"><a href="#cb31-390" aria-hidden="true" tabindex="-1"></a>\idxfun{glm}{stats}\idxfun{lm}{stats}\idxfun{poisson}{stats}</span>
<span id="cb31-391"><a href="#cb31-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-394"><a href="#cb31-394" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-395"><a href="#cb31-395" aria-hidden="true" tabindex="-1"></a>ftrips <span class="ot">&lt;-</span> trips <span class="sc">~</span> workschl <span class="sc">+</span> size <span class="sc">+</span> dist <span class="sc">+</span> smsa <span class="sc">+</span> fulltime <span class="sc">+</span> distnod <span class="sc">+</span> </span>
<span id="cb31-396"><a href="#cb31-396" aria-hidden="true" tabindex="-1"></a>  realinc <span class="sc">+</span> weekend <span class="sc">+</span> car</span>
<span id="cb31-397"><a href="#cb31-397" aria-hidden="true" tabindex="-1"></a>pois_trips <span class="ot">&lt;-</span> <span class="fu">glm</span>(ftrips, <span class="at">family =</span> poisson, trips)</span>
<span id="cb31-398"><a href="#cb31-398" aria-hidden="true" tabindex="-1"></a>lm_trips <span class="ot">&lt;-</span> <span class="fu">lm</span>(ftrips, trips)</span>
<span id="cb31-399"><a href="#cb31-399" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-400"><a href="#cb31-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-401"><a href="#cb31-401" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb31-402"><a href="#cb31-402" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb31-403"><a href="#cb31-403" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb31-404"><a href="#cb31-404" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-regtrips</span></span>
<span id="cb31-405"><a href="#cb31-405" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Regressions for the trips data set"</span></span>
<span id="cb31-406"><a href="#cb31-406" aria-hidden="true" tabindex="-1"></a>     <span class="co"># gof_map: list of lists</span></span>
<span id="cb31-407"><a href="#cb31-407" aria-hidden="true" tabindex="-1"></a>     f1 <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">format</span>(<span class="fu">round</span>(x, <span class="dv">3</span>), <span class="at">big.mark=</span><span class="st">","</span>)</span>
<span id="cb31-408"><a href="#cb31-408" aria-hidden="true" tabindex="-1"></a>     f2 <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">format</span>(<span class="fu">round</span>(x, <span class="dv">0</span>), <span class="at">big.mark=</span><span class="st">","</span>)</span>
<span id="cb31-409"><a href="#cb31-409" aria-hidden="true" tabindex="-1"></a>     gm <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb31-410"><a href="#cb31-410" aria-hidden="true" tabindex="-1"></a>         <span class="fu">list</span>(<span class="st">"raw"</span> <span class="ot">=</span> <span class="st">"nobs"</span>, <span class="st">"clean"</span> <span class="ot">=</span> <span class="st">"N"</span>, <span class="st">"fmt"</span> <span class="ot">=</span> f2),</span>
<span id="cb31-411"><a href="#cb31-411" aria-hidden="true" tabindex="-1"></a>         <span class="fu">list</span>(<span class="st">"raw"</span> <span class="ot">=</span> <span class="st">"AIC"</span>, <span class="st">"clean"</span> <span class="ot">=</span> <span class="st">"aic"</span>, <span class="st">"fmt"</span> <span class="ot">=</span> f1))</span>
<span id="cb31-412"><a href="#cb31-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-413"><a href="#cb31-413" aria-hidden="true" tabindex="-1"></a>pois_trips <span class="ot">&lt;-</span> <span class="fu">glm</span>(trips <span class="sc">~</span> workschl <span class="sc">+</span> size <span class="sc">+</span> dist <span class="sc">+</span> smsa <span class="sc">+</span> fulltime <span class="sc">+</span> distnod <span class="sc">+</span></span>
<span id="cb31-414"><a href="#cb31-414" aria-hidden="true" tabindex="-1"></a>                   realinc <span class="sc">+</span> weekend <span class="sc">+</span> car, <span class="at">data =</span> trips, <span class="at">family =</span> poisson)</span>
<span id="cb31-415"><a href="#cb31-415" aria-hidden="true" tabindex="-1"></a>qpois_trips <span class="ot">&lt;-</span> <span class="fu">glm</span>(trips <span class="sc">~</span> workschl <span class="sc">+</span> size <span class="sc">+</span> dist <span class="sc">+</span> smsa <span class="sc">+</span> fulltime <span class="sc">+</span> distnod <span class="sc">+</span></span>
<span id="cb31-416"><a href="#cb31-416" aria-hidden="true" tabindex="-1"></a>                       realinc <span class="sc">+</span> weekend <span class="sc">+</span> car, <span class="at">data =</span> trips, <span class="at">family =</span> quasipoisson)</span>
<span id="cb31-417"><a href="#cb31-417" aria-hidden="true" tabindex="-1"></a>lm_trips <span class="ot">&lt;-</span> <span class="fu">lm</span>(trips <span class="sc">~</span> workschl <span class="sc">+</span> size <span class="sc">+</span> dist <span class="sc">+</span> smsa <span class="sc">+</span> fulltime <span class="sc">+</span> distnod <span class="sc">+</span></span>
<span id="cb31-418"><a href="#cb31-418" aria-hidden="true" tabindex="-1"></a>                   realinc <span class="sc">+</span> weekend <span class="sc">+</span> car, <span class="at">data =</span> trips)</span>
<span id="cb31-419"><a href="#cb31-419" aria-hidden="true" tabindex="-1"></a>modelsummary<span class="sc">::</span><span class="fu">msummary</span>(<span class="fu">list</span>(<span class="st">"linear model"</span> <span class="ot">=</span> lm_trips,</span>
<span id="cb31-420"><a href="#cb31-420" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"Poisson model"</span> <span class="ot">=</span> pois_trips,</span>
<span id="cb31-421"><a href="#cb31-421" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"quasi-Poisson model"</span> <span class="ot">=</span> qpois_trips),</span>
<span id="cb31-422"><a href="#cb31-422" aria-hidden="true" tabindex="-1"></a>                       <span class="at">estimate =</span> <span class="st">"{estimate} ({std.error}){stars}"</span>,</span>
<span id="cb31-423"><a href="#cb31-423" aria-hidden="true" tabindex="-1"></a>                       <span class="at">statistic  =</span> <span class="cn">NULL</span>,</span>
<span id="cb31-424"><a href="#cb31-424" aria-hidden="true" tabindex="-1"></a>                       <span class="at">gof_omit =</span> <span class="st">'DF|Deviance|R2|AIC|BIC|F|RMSE'</span>,</span>
<span id="cb31-425"><a href="#cb31-425" aria-hidden="true" tabindex="-1"></a>                       <span class="at">fmt =</span> <span class="dv">2</span>, <span class="at">output =</span> <span class="st">"kableExtra"</span>)</span>
<span id="cb31-426"><a href="#cb31-426" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-427"><a href="#cb31-427" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">)</span><span class="co">]</span>{trips}{micsr}</span>
<span id="cb31-428"><a href="#cb31-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-429"><a href="#cb31-429" aria-hidden="true" tabindex="-1"></a><span class="fu">### Interpretation of the coefficients</span></span>
<span id="cb31-430"><a href="#cb31-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-431"><a href="#cb31-431" aria-hidden="true" tabindex="-1"></a>As for any non-linear models, the marginal effects are not equal to the</span>
<span id="cb31-432"><a href="#cb31-432" aria-hidden="true" tabindex="-1"></a>coefficients. Taking the derivative of the conditional expectation</span>
<span id="cb31-433"><a href="#cb31-433" aria-hidden="true" tabindex="-1"></a>function (@eq-condexp_poisson) with the k^th^ covariate, we get the following marginal effect for observation $n$:</span>
<span id="cb31-434"><a href="#cb31-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-435"><a href="#cb31-435" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-436"><a href="#cb31-436" aria-hidden="true" tabindex="-1"></a>\frac{\partial \mbox{E}(y\mid x_n)}{\partial x_{nk}} = \beta_k e^{\gamma^\top z_n}</span>
<span id="cb31-437"><a href="#cb31-437" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-438"><a href="#cb31-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-439"><a href="#cb31-439" aria-hidden="true" tabindex="-1"></a>which can be consistently estimated by $\hat{\beta}_k</span>
<span id="cb31-440"><a href="#cb31-440" aria-hidden="true" tabindex="-1"></a>e^{\hat{\gamma}^\top z_n}$. Note that the ratio of the marginal effects</span>
<span id="cb31-441"><a href="#cb31-441" aria-hidden="true" tabindex="-1"></a>of two covariates $k$ and $l$ is $\beta_k / \beta_l$ and therefore</span>
<span id="cb31-442"><a href="#cb31-442" aria-hidden="true" tabindex="-1"></a>doesn't depend on the values of the covariates for a specific</span>
<span id="cb31-443"><a href="#cb31-443" aria-hidden="true" tabindex="-1"></a>observation. The average marginal effect (AME) for the $N$ observations is:</span>
<span id="cb31-444"><a href="#cb31-444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-445"><a href="#cb31-445" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-446"><a href="#cb31-446" aria-hidden="true" tabindex="-1"></a>\hat{\beta}_k \frac{\sum_{n=1}^N e^{\hat{\gamma}^\top z_n}}{N}</span>
<span id="cb31-447"><a href="#cb31-447" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-448"><a href="#cb31-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-449"><a href="#cb31-449" aria-hidden="true" tabindex="-1"></a>But, if the regression contains an intercept, the sample mean of the</span>
<span id="cb31-450"><a href="#cb31-450" aria-hidden="true" tabindex="-1"></a>predictions is the sample mean of the response (see @eq-mean_me_poisson). Therefore, the</span>
<span id="cb31-451"><a href="#cb31-451" aria-hidden="true" tabindex="-1"></a>average marginal effect is $\hat{\beta}_k</span>
<span id="cb31-452"><a href="#cb31-452" aria-hidden="true" tabindex="-1"></a>\bar{y}$. Therefore, we can for example compare the estimate slopes</span>
<span id="cb31-453"><a href="#cb31-453" aria-hidden="true" tabindex="-1"></a>in a linear model (which are directly the marginal effects) to the</span>
<span id="cb31-454"><a href="#cb31-454" aria-hidden="true" tabindex="-1"></a>Poisson estimators multiplied by the mean of the response. </span>
<span id="cb31-455"><a href="#cb31-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-456"><a href="#cb31-456" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">(</span><span class="co">]</span>{trips}{micsr}</span>
<span id="cb31-457"><a href="#cb31-457" aria-hidden="true" tabindex="-1"></a>\idxfun{coef}{stats}\idxfun{rbind}{base}</span>
<span id="cb31-458"><a href="#cb31-458" aria-hidden="true" tabindex="-1"></a>We now print the coefficients obtained for the Poisson and for the linear model:</span>
<span id="cb31-459"><a href="#cb31-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-462"><a href="#cb31-462" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-463"><a href="#cb31-463" aria-hidden="true" tabindex="-1"></a><span class="fu">rbind</span>(<span class="at">lm =</span> <span class="fu">coef</span>(lm_trips), <span class="at">poisson =</span> <span class="fu">coef</span>(pois_trips))</span>
<span id="cb31-464"><a href="#cb31-464" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-465"><a href="#cb31-465" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">)</span><span class="co">]</span>{trips}{micsr}</span>
<span id="cb31-466"><a href="#cb31-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-467"><a href="#cb31-467" aria-hidden="true" tabindex="-1"></a>An increase of 1 of <span class="in">`realinc`</span> means that household's</span>
<span id="cb31-468"><a href="#cb31-468" aria-hidden="true" tabindex="-1"></a>income increases by an amount equal to the local median income. The</span>
<span id="cb31-469"><a href="#cb31-469" aria-hidden="true" tabindex="-1"></a>linear models indicates that the number of trips then increases by $0.133$</span>
<span id="cb31-470"><a href="#cb31-470" aria-hidden="true" tabindex="-1"></a>trips (the sample mean for trips being 4.55). The Poisson model indicates that the relative increase of trips $dy /y$ is equal to $0.019$, i.e., 2%. At the sample mean, it corresponds to</span>
<span id="cb31-471"><a href="#cb31-471" aria-hidden="true" tabindex="-1"></a>an increase of $0.019 \times 4.55 = 0.086$ trips.</span>
<span id="cb31-472"><a href="#cb31-472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-473"><a href="#cb31-473" aria-hidden="true" tabindex="-1"></a>If the interview concerns a weekend day, the OLS coefficient is</span>
<span id="cb31-474"><a href="#cb31-474" aria-hidden="true" tabindex="-1"></a>$-0.48$, which indicates that the number of trips taken during the weekend</span>
<span id="cb31-475"><a href="#cb31-475" aria-hidden="true" tabindex="-1"></a>are about one-half less, compared to a weekday. For such a dummy</span>
<span id="cb31-476"><a href="#cb31-476" aria-hidden="true" tabindex="-1"></a>variable, denoting $\beta_w$ and $z_0$ a given vector of covariates such that $x_w = 0$,  $\gamma^\top z_0$ is the linear predictor for a weekday and $\gamma^\top z_0 + \beta_w$ the linear predictor for a week-end day. Therefore, the relative</span>
<span id="cb31-477"><a href="#cb31-477" aria-hidden="true" tabindex="-1"></a>difference $\tau$ of the number of trips between a weekend day and a weekday is:</span>
<span id="cb31-478"><a href="#cb31-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-479"><a href="#cb31-479" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-480"><a href="#cb31-480" aria-hidden="true" tabindex="-1"></a>\tau = \frac{e^{\gamma^\top z_0 + \beta_w}- e^{\gamma^\top</span>
<span id="cb31-481"><a href="#cb31-481" aria-hidden="true" tabindex="-1"></a>z_0}}{e^{\gamma^\top z_0}} = e^{\beta_w} - 1 = e^{-0.0738} - 1 = - 0.071</span>
<span id="cb31-482"><a href="#cb31-482" aria-hidden="true" tabindex="-1"></a>= 7.1\%</span>
<span id="cb31-483"><a href="#cb31-483" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-484"><a href="#cb31-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-485"><a href="#cb31-485" aria-hidden="true" tabindex="-1"></a>The previous expression indicates also that $\beta_w = \ln (1 +</span>
<span id="cb31-486"><a href="#cb31-486" aria-hidden="true" tabindex="-1"></a>\tau) \approx \tau$. For small values of $\beta_w$, the coefficient can be</span>
<span id="cb31-487"><a href="#cb31-487" aria-hidden="true" tabindex="-1"></a>interpreted as the relative difference of the response. In terms of</span>
<span id="cb31-488"><a href="#cb31-488" aria-hidden="true" tabindex="-1"></a>absolute value, at the sample mean, the absolute difference is $-</span>
<span id="cb31-489"><a href="#cb31-489" aria-hidden="true" tabindex="-1"></a>0.071 \times 4.55  = -0.323$, which is close to the OLS coefficient.</span>
<span id="cb31-490"><a href="#cb31-490" aria-hidden="true" tabindex="-1"></a>Of course the approximation is only relevant for small values of the</span>
<span id="cb31-491"><a href="#cb31-491" aria-hidden="true" tabindex="-1"></a>coefficient. If we consider the coefficient of <span class="in">`cars`</span>, the</span>
<span id="cb31-492"><a href="#cb31-492" aria-hidden="true" tabindex="-1"></a>value for the Poisson model is $1.413$ which implies an increase of</span>
<span id="cb31-493"><a href="#cb31-493" aria-hidden="true" tabindex="-1"></a>$e^{1.413} - 1 = 3.1 = 310$% much larger that the value of the coefficient.</span>
<span id="cb31-494"><a href="#cb31-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-495"><a href="#cb31-495" aria-hidden="true" tabindex="-1"></a><span class="fu">### Computation of the variance of the estimator</span></span>
<span id="cb31-496"><a href="#cb31-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-497"><a href="#cb31-497" aria-hidden="true" tabindex="-1"></a>The matrix of the second derivatives is:</span>
<span id="cb31-498"><a href="#cb31-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-499"><a href="#cb31-499" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-500"><a href="#cb31-500" aria-hidden="true" tabindex="-1"></a>\frac{\partial \ln L}{\partial \gamma\partial \gamma ^</span>
<span id="cb31-501"><a href="#cb31-501" aria-hidden="true" tabindex="-1"></a>\top}=-\sum_{n=1}^N e^{\gamma^\top z_n}z_n z_n^\top</span>
<span id="cb31-502"><a href="#cb31-502" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-503"><a href="#cb31-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-504"><a href="#cb31-504" aria-hidden="true" tabindex="-1"></a>The information matrix is the opposite of the hessian (as it</span>
<span id="cb31-505"><a href="#cb31-505" aria-hidden="true" tabindex="-1"></a>doesn't depend on $y$, it is equal to its expected value) and the</span>
<span id="cb31-506"><a href="#cb31-506" aria-hidden="true" tabindex="-1"></a>variance of the gradient. The latter is:</span>
<span id="cb31-507"><a href="#cb31-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-508"><a href="#cb31-508" aria-hidden="true" tabindex="-1"></a>$$ </span>
<span id="cb31-509"><a href="#cb31-509" aria-hidden="true" tabindex="-1"></a>\sum_{n=1} ^ N \mbox{E}\left( (y_n - e^{\gamma^\top z_n})^2 z_n</span>
<span id="cb31-510"><a href="#cb31-510" aria-hidden="true" tabindex="-1"></a>z_n^\top\right) = \sum_{n=1} ^ N e^{\gamma^\top z_n} z_n</span>
<span id="cb31-511"><a href="#cb31-511" aria-hidden="true" tabindex="-1"></a>z_n^\top</span>
<span id="cb31-512"><a href="#cb31-512" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-513"><a href="#cb31-513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-514"><a href="#cb31-514" aria-hidden="true" tabindex="-1"></a>as $\mbox{E}\left( (y_n - e^{\gamma^\top z_n}) ^2 \right)$ is the</span>
<span id="cb31-515"><a href="#cb31-515" aria-hidden="true" tabindex="-1"></a>conditional variance which equals the conditional expectation for a</span>
<span id="cb31-516"><a href="#cb31-516" aria-hidden="true" tabindex="-1"></a>Poisson distribution. The estimated variance of the estimator is therefore:</span>
<span id="cb31-517"><a href="#cb31-517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-518"><a href="#cb31-518" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-519"><a href="#cb31-519" aria-hidden="true" tabindex="-1"></a>\hat{\mbox{V}}(\hat{\beta}) = \left(\sum_{n=1} ^ N e^{\hat{\gamma}^\top z_n} z_n</span>
<span id="cb31-520"><a href="#cb31-520" aria-hidden="true" tabindex="-1"></a>z_n^\top\right) ^ {-1} = \left(\sum_{n=1} ^ N \hat{\mu}_n z_n</span>
<span id="cb31-521"><a href="#cb31-521" aria-hidden="true" tabindex="-1"></a>z_n^\top\right) ^ {-1}</span>
<span id="cb31-522"><a href="#cb31-522" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-523"><a href="#cb31-523" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{covariance matrix!Poisson!information based}</span>
<span id="cb31-524"><a href="#cb31-524" aria-hidden="true" tabindex="-1"></a>This estimator is consistent only if the distribution of the response is Poisson, </span>
<span id="cb31-525"><a href="#cb31-525" aria-hidden="true" tabindex="-1"></a>and therefore if the conditional variance equals the conditional mean. </span>
<span id="cb31-526"><a href="#cb31-526" aria-hidden="true" tabindex="-1"></a>A more general estimator is based on the sandwich formula:</span>
<span id="cb31-527"><a href="#cb31-527" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{covariance matrix!Poisson model!sandwich}</span>
<span id="cb31-528"><a href="#cb31-528" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{sandwich!Poisson model}</span>
<span id="cb31-529"><a href="#cb31-529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-530"><a href="#cb31-530" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-531"><a href="#cb31-531" aria-hidden="true" tabindex="-1"></a>\left(\sum_{n=1} ^ N \hat{\mu}_n z_n</span>
<span id="cb31-532"><a href="#cb31-532" aria-hidden="true" tabindex="-1"></a>z_n^\top\right) ^ {-1}</span>
<span id="cb31-533"><a href="#cb31-533" aria-hidden="true" tabindex="-1"></a>\left(\sum_{n=1} ^ N (y_n - \hat{\mu}_n)^2 z_n</span>
<span id="cb31-534"><a href="#cb31-534" aria-hidden="true" tabindex="-1"></a>z_n^\top\right)</span>
<span id="cb31-535"><a href="#cb31-535" aria-hidden="true" tabindex="-1"></a>\left(\sum_{n=1} ^ N \hat{\mu}_n z_n</span>
<span id="cb31-536"><a href="#cb31-536" aria-hidden="true" tabindex="-1"></a>z_n^\top\right) ^ {-1}</span>
<span id="cb31-537"><a href="#cb31-537" aria-hidden="true" tabindex="-1"></a>$$ {#eq-sandpois}</span>
<span id="cb31-538"><a href="#cb31-538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-539"><a href="#cb31-539" aria-hidden="true" tabindex="-1"></a>One alternative is to assume that the variance is proportional to the</span>
<span id="cb31-540"><a href="#cb31-540" aria-hidden="true" tabindex="-1"></a>mean: $\mbox{V}(y|x) = \phi \mbox{E}(y|x)$. $\phi$ can then be consistently estimated by:</span>
<span id="cb31-541"><a href="#cb31-541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-542"><a href="#cb31-542" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-543"><a href="#cb31-543" aria-hidden="true" tabindex="-1"></a>\hat{\phi} = \frac{1}{N}\sum_{n=1} ^ N \frac{(y_n - \hat{\mu}_n) ^ 2}{\mu_n}</span>
<span id="cb31-544"><a href="#cb31-544" aria-hidden="true" tabindex="-1"></a>$$ {#eq-qpoisvar}</span>
<span id="cb31-545"><a href="#cb31-545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-546"><a href="#cb31-546" aria-hidden="true" tabindex="-1"></a>which leads to the third estimator of the covariance matrix:</span>
<span id="cb31-547"><a href="#cb31-547" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-548"><a href="#cb31-548" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-549"><a href="#cb31-549" aria-hidden="true" tabindex="-1"></a>\hat{\mbox{V}}(\hat{\gamma}) = \hat{\phi}\left(\sum_{n=1} ^ N \hat{\mu}_n z_n z_n^\top\right) ^ {-1}</span>
<span id="cb31-550"><a href="#cb31-550" aria-hidden="true" tabindex="-1"></a>$$ {#eq-quasi-poisson}</span>
<span id="cb31-551"><a href="#cb31-551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-552"><a href="#cb31-552" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{quasi-Poisson model}</span>
<span id="cb31-553"><a href="#cb31-553" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{covariance matrix!Poisson model!quasi-Poisson}</span>
<span id="cb31-554"><a href="#cb31-554" aria-hidden="true" tabindex="-1"></a>The "quasi-Poisson" model is obtained by using the log link and @eq-quasi-poisson for the variance. It leads to the same estimator as the Poisson model and a variance that is</span>
<span id="cb31-555"><a href="#cb31-555" aria-hidden="true" tabindex="-1"></a>greater (respectively lower) than the one of the Poisson model if</span>
<span id="cb31-556"><a href="#cb31-556" aria-hidden="true" tabindex="-1"></a>there is overdispersion (respectively underdispersion). It can be fitted using <span class="in">`glm`</span> by setting the <span class="in">`family`</span> argument to <span class="in">`quasipoisson`</span>:</span>
<span id="cb31-557"><a href="#cb31-557" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">(</span><span class="co">]</span>{trips}{micsr}</span>
<span id="cb31-558"><a href="#cb31-558" aria-hidden="true" tabindex="-1"></a>\idxfun{update}{stats}\idxfun{quasipoisson}{stats}</span>
<span id="cb31-559"><a href="#cb31-559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-562"><a href="#cb31-562" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-563"><a href="#cb31-563" aria-hidden="true" tabindex="-1"></a>qpois_trips <span class="ot">&lt;-</span> <span class="fu">update</span>(pois_trips, <span class="at">family =</span> quasipoisson)</span>
<span id="cb31-564"><a href="#cb31-564" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-565"><a href="#cb31-565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-566"><a href="#cb31-566" aria-hidden="true" tabindex="-1"></a>Compared to the Poisson model, the standard</span>
<span id="cb31-567"><a href="#cb31-567" aria-hidden="true" tabindex="-1"></a>deviations of the quasi-Poisson model are inflated by a factor which</span>
<span id="cb31-568"><a href="#cb31-568" aria-hidden="true" tabindex="-1"></a>is the square root of the estimate of the variance-mean ratio. This</span>
<span id="cb31-569"><a href="#cb31-569" aria-hidden="true" tabindex="-1"></a>factor can be estimated using @eq-qpoisvar, which makes use</span>
<span id="cb31-570"><a href="#cb31-570" aria-hidden="true" tabindex="-1"></a>of the residuals of the Poisson regression. </span>
<span id="cb31-571"><a href="#cb31-571" aria-hidden="true" tabindex="-1"></a>\idxfun{model.frame}{stats}\idxfun{model.response}{stats}\idxfun{fitted}{stats}\idxfun{resid}{stats}</span>
<span id="cb31-572"><a href="#cb31-572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-573"><a href="#cb31-573" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb31-574"><a href="#cb31-574" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> pois_trips <span class="sc">%&gt;%</span> model.frame <span class="sc">%&gt;%</span> model.response</span>
<span id="cb31-575"><a href="#cb31-575" aria-hidden="true" tabindex="-1"></a>mu <span class="ot">&lt;-</span> pois_trips <span class="sc">%&gt;%</span> fitted</span>
<span id="cb31-576"><a href="#cb31-576" aria-hidden="true" tabindex="-1"></a>e_resp <span class="ot">&lt;-</span> pois_trips <span class="sc">%&gt;%</span> <span class="fu">resid</span>(<span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb31-577"><a href="#cb31-577" aria-hidden="true" tabindex="-1"></a>e_pears <span class="ot">&lt;-</span> pois_trips <span class="sc">%&gt;%</span> <span class="fu">resid</span>(<span class="at">type =</span> <span class="st">"pearson"</span>)</span>
<span id="cb31-578"><a href="#cb31-578" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-579"><a href="#cb31-579" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{residuals!Poisson!response}\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{residuals!Poisson!Pearson's}</span>
<span id="cb31-580"><a href="#cb31-580" aria-hidden="true" tabindex="-1"></a>The response residual is $y_n - \hat{\mu}_n$, and we get the Pearson residual</span>
<span id="cb31-581"><a href="#cb31-581" aria-hidden="true" tabindex="-1"></a>by dividing the response residual by the standard deviation, which is $\sqrt{\hat{\mu}_n}$.</span>
<span id="cb31-582"><a href="#cb31-582" aria-hidden="true" tabindex="-1"></a>Therefore, the estimation of the variance-mean ratio is simply the sum</span>
<span id="cb31-583"><a href="#cb31-583" aria-hidden="true" tabindex="-1"></a>of square of the Pearson residuals divided by the sample size (the</span>
<span id="cb31-584"><a href="#cb31-584" aria-hidden="true" tabindex="-1"></a>number of degrees of freedom can be used instead).</span>
<span id="cb31-585"><a href="#cb31-585" aria-hidden="true" tabindex="-1"></a>\idxfun{df.residual}{stats}</span>
<span id="cb31-586"><a href="#cb31-586" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-587"><a href="#cb31-587" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb31-588"><a href="#cb31-588" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: true</span></span>
<span id="cb31-589"><a href="#cb31-589" aria-hidden="true" tabindex="-1"></a>phi <span class="ot">&lt;-</span> <span class="fu">sum</span>(e_pears <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">/</span> <span class="fu">df.residual</span>(pois_trips)</span>
<span id="cb31-590"><a href="#cb31-590" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(phi, <span class="fu">sqrt</span>(phi))</span>
<span id="cb31-591"><a href="#cb31-591" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-592"><a href="#cb31-592" aria-hidden="true" tabindex="-1"></a>The estimated variance-mean ratio is more than 3, so that the standard</span>
<span id="cb31-593"><a href="#cb31-593" aria-hidden="true" tabindex="-1"></a>deviations of the quasi-Poisson model are almost 2 times larger than</span>
<span id="cb31-594"><a href="#cb31-594" aria-hidden="true" tabindex="-1"></a>those of the Poisson model (1.835). The sandwich estimator can be constructed by extracting from the fitted Poisson model the model matrix ($Z$), the fitted values ($\hat{\mu}_n$) and the response residuals ($y_n - \hat{\mu}_n$):</span>
<span id="cb31-595"><a href="#cb31-595" aria-hidden="true" tabindex="-1"></a>\idxfun{fitted}{stats}\idxfun{resid}{stats}\idxfun{model.matrix}{stats}</span>
<span id="cb31-596"><a href="#cb31-596" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{covariance matrix!Poisson model!sandwich|(}</span>
<span id="cb31-597"><a href="#cb31-597" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{sandwich!Poisson model|(}</span>
<span id="cb31-598"><a href="#cb31-598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-599"><a href="#cb31-599" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb31-600"><a href="#cb31-600" aria-hidden="true" tabindex="-1"></a>mu <span class="ot">&lt;-</span> pois_trips <span class="sc">%&gt;%</span> fitted</span>
<span id="cb31-601"><a href="#cb31-601" aria-hidden="true" tabindex="-1"></a>e <span class="ot">&lt;-</span> pois_trips <span class="sc">%&gt;%</span> <span class="fu">resid</span>(<span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb31-602"><a href="#cb31-602" aria-hidden="true" tabindex="-1"></a>Z <span class="ot">&lt;-</span> pois_trips <span class="sc">%&gt;%</span> model.matrix</span>
<span id="cb31-603"><a href="#cb31-603" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-604"><a href="#cb31-604" aria-hidden="true" tabindex="-1"></a>We can then compute the "bread" (<span class="in">`B`</span>) and the "meat" (<span class="in">`M`</span>):</span>
<span id="cb31-605"><a href="#cb31-605" aria-hidden="true" tabindex="-1"></a>\idxfun{crossprod}{base}</span>
<span id="cb31-606"><a href="#cb31-606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-607"><a href="#cb31-607" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb31-608"><a href="#cb31-608" aria-hidden="true" tabindex="-1"></a>B <span class="ot">&lt;-</span> <span class="fu">crossprod</span>(mu <span class="sc">*</span> Z, Z)</span>
<span id="cb31-609"><a href="#cb31-609" aria-hidden="true" tabindex="-1"></a>M <span class="ot">&lt;-</span> <span class="fu">crossprod</span>(e <span class="sc">^</span> <span class="dv">2</span> <span class="sc">*</span> Z, Z)</span>
<span id="cb31-610"><a href="#cb31-610" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-611"><a href="#cb31-611" aria-hidden="true" tabindex="-1"></a>Applying @eq-sandpois, and taking the square root of the</span>
<span id="cb31-612"><a href="#cb31-612" aria-hidden="true" tabindex="-1"></a>diagonal elements, we get:</span>
<span id="cb31-613"><a href="#cb31-613" aria-hidden="true" tabindex="-1"></a>\idxfun{solve}{base}\idxfun{stder}{micsr}\idxfun{head}{utils}</span>
<span id="cb31-614"><a href="#cb31-614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-615"><a href="#cb31-615" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb31-616"><a href="#cb31-616" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: true</span></span>
<span id="cb31-617"><a href="#cb31-617" aria-hidden="true" tabindex="-1"></a>sand_vcov <span class="ot">&lt;-</span> <span class="fu">solve</span>(B) <span class="sc">%*%</span> M <span class="sc">%*%</span> <span class="fu">solve</span>(B)</span>
<span id="cb31-618"><a href="#cb31-618" aria-hidden="true" tabindex="-1"></a>sand_vcov <span class="sc">%&gt;%</span> stder <span class="sc">%&gt;%</span> <span class="fu">head</span>(<span class="dv">4</span>)</span>
<span id="cb31-619"><a href="#cb31-619" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-620"><a href="#cb31-620" aria-hidden="true" tabindex="-1"></a>The <span class="in">`sandwich`</span> package provides the <span class="in">`vcovHC`</span> function which computes</span>
<span id="cb31-621"><a href="#cb31-621" aria-hidden="true" tabindex="-1"></a>different flavors of the sandwich estimator of the variance. The one</span>
<span id="cb31-622"><a href="#cb31-622" aria-hidden="true" tabindex="-1"></a>that corresponds to @eq-sandpois is obtained by setting <span class="in">`type`</span></span>
<span id="cb31-623"><a href="#cb31-623" aria-hidden="true" tabindex="-1"></a>to <span class="in">`HC`</span>.</span>
<span id="cb31-624"><a href="#cb31-624" aria-hidden="true" tabindex="-1"></a>\idxfun{vcovHC}{sandwich}\idxfun{stder}{micsr}\idxfun{head}{utils}</span>
<span id="cb31-625"><a href="#cb31-625" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-626"><a href="#cb31-626" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb31-627"><a href="#cb31-627" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: true</span></span>
<span id="cb31-628"><a href="#cb31-628" aria-hidden="true" tabindex="-1"></a>sandwich<span class="sc">::</span><span class="fu">vcovHC</span>(pois_trips, <span class="at">type =</span> <span class="st">"HC"</span>) <span class="sc">%&gt;%</span> stder <span class="sc">%&gt;%</span> <span class="fu">head</span>(<span class="dv">4</span>)</span>
<span id="cb31-629"><a href="#cb31-629" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-630"><a href="#cb31-630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-631"><a href="#cb31-631" aria-hidden="true" tabindex="-1"></a>The sandwich standard errors can also be extracted from the Poisson model using <span class="in">`stder`</span> with the <span class="in">`vcov`</span> and <span class="in">`type`</span> arguments (respectively equal to <span class="in">`sandwich::vcovHC`</span> and <span class="in">`"HC"`</span>):</span>
<span id="cb31-632"><a href="#cb31-632" aria-hidden="true" tabindex="-1"></a>\idxfun{vcovHC}{sandwich}\idxfun{stder}{micsr}\idxfun{head}{utils}</span>
<span id="cb31-633"><a href="#cb31-633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-636"><a href="#cb31-636" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-637"><a href="#cb31-637" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: true</span></span>
<span id="cb31-638"><a href="#cb31-638" aria-hidden="true" tabindex="-1"></a><span class="fu">stder</span>(pois_trips, <span class="at">vcov =</span> sandwich<span class="sc">::</span>vcovHC, <span class="at">type =</span> <span class="st">"HC"</span>) <span class="sc">%&gt;%</span> <span class="fu">head</span>(<span class="dv">4</span>)</span>
<span id="cb31-639"><a href="#cb31-639" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-640"><a href="#cb31-640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-641"><a href="#cb31-641" aria-hidden="true" tabindex="-1"></a>Taking the ratio of the simple standard deviations of the coefficients</span>
<span id="cb31-642"><a href="#cb31-642" aria-hidden="true" tabindex="-1"></a>and the sandwich estimator, we get:</span>
<span id="cb31-643"><a href="#cb31-643" aria-hidden="true" tabindex="-1"></a>\idxfun{stder}{micsr}</span>
<span id="cb31-644"><a href="#cb31-644" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-645"><a href="#cb31-645" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb31-646"><a href="#cb31-646" aria-hidden="true" tabindex="-1"></a><span class="fu">stder</span>(sand_vcov) <span class="sc">/</span> <span class="fu">stder</span>(pois_trips)</span>
<span id="cb31-647"><a href="#cb31-647" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-648"><a href="#cb31-648" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-649"><a href="#cb31-649" aria-hidden="true" tabindex="-1"></a>As previously, the robust standard deviations are about twice the</span>
<span id="cb31-650"><a href="#cb31-650" aria-hidden="true" tabindex="-1"></a>basic ones on average, but the ratio now depends on the coefficient.</span>
<span id="cb31-651"><a href="#cb31-651" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">)</span><span class="co">]</span>{trips}{micsr}</span>
<span id="cb31-652"><a href="#cb31-652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-653"><a href="#cb31-653" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{covariance matrix!Poisson model!sandwich|)}</span>
<span id="cb31-654"><a href="#cb31-654" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{sandwich!Poisson model|)}</span>
<span id="cb31-655"><a href="#cb31-655" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-656"><a href="#cb31-656" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{Poisson model|)}</span>
<span id="cb31-657"><a href="#cb31-657" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-658"><a href="#cb31-658" aria-hidden="true" tabindex="-1"></a><span class="fu">### Overdispersion</span></span>
<span id="cb31-659"><a href="#cb31-659" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-660"><a href="#cb31-660" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{overdispersion|(}</span>
<span id="cb31-661"><a href="#cb31-661" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{negbin|(}</span>
<span id="cb31-662"><a href="#cb31-662" aria-hidden="true" tabindex="-1"></a>A more general expression for the variance is the following Negbin</span>
<span id="cb31-663"><a href="#cb31-663" aria-hidden="true" tabindex="-1"></a>specification:</span>
<span id="cb31-664"><a href="#cb31-664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-665"><a href="#cb31-665" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-666"><a href="#cb31-666" aria-hidden="true" tabindex="-1"></a>\sigma_n ^ 2 = \mu_n + \alpha \mu_n ^ p</span>
<span id="cb31-667"><a href="#cb31-667" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-668"><a href="#cb31-668" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-669"><a href="#cb31-669" aria-hidden="true" tabindex="-1"></a>with two special cases:</span>
<span id="cb31-670"><a href="#cb31-670" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-671"><a href="#cb31-671" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$p = 1$ (**NB1**) which implies that the variance is proportional to the</span>
<span id="cb31-672"><a href="#cb31-672" aria-hidden="true" tabindex="-1"></a>  expectation, $\sigma_n ^ 2 = (1 + \alpha) \mu_n$,\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{negbin!NB1}</span>
<span id="cb31-673"><a href="#cb31-673" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>$p = 2$ (**NB2**) which implies that the variance is quadratic in the</span>
<span id="cb31-674"><a href="#cb31-674" aria-hidden="true" tabindex="-1"></a>  expectation, $\sigma_n ^ 2 = \mu_n + \alpha \mu_n ^ 2$. \index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{negbin!NB2}</span>
<span id="cb31-675"><a href="#cb31-675" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-676"><a href="#cb31-676" aria-hidden="true" tabindex="-1"></a>Tests for overdispersion can easily be implemented using one of the three</span>
<span id="cb31-677"><a href="#cb31-677" aria-hidden="true" tabindex="-1"></a>test principles: Wald, likelihood ratio and score tests. The first</span>
<span id="cb31-678"><a href="#cb31-678" aria-hidden="true" tabindex="-1"></a>two require the estimation of a more general model that doesn't impose</span>
<span id="cb31-679"><a href="#cb31-679" aria-hidden="true" tabindex="-1"></a>the equality between the conditional mean and the conditional variance. The score test requires only the estimation of the constrained (Poisson) model. It can take different forms; we'll just present here the test advocated by @CAME:TRIV:86\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Cameron}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Trivedi} who use an</span>
<span id="cb31-680"><a href="#cb31-680" aria-hidden="true" tabindex="-1"></a>auxiliary regression.^[Score tests that are not obtained from auxiliary regressions are</span>
<span id="cb31-681"><a href="#cb31-681" aria-hidden="true" tabindex="-1"></a>presented by @DEAN:92\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Dean}.] The null hypothesis is:</span>
<span id="cb31-682"><a href="#cb31-682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-683"><a href="#cb31-683" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-684"><a href="#cb31-684" aria-hidden="true" tabindex="-1"></a>\mbox{E}\left( (y_n - \mu_n) ^ 2 - y_n\right) = \sigma_n ^ 2 - \mu_n = 0</span>
<span id="cb31-685"><a href="#cb31-685" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-686"><a href="#cb31-686" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-687"><a href="#cb31-687" aria-hidden="true" tabindex="-1"></a>With the NB1 specification, the alternative is:\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{negbin!NB1}</span>
<span id="cb31-688"><a href="#cb31-688" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-689"><a href="#cb31-689" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-690"><a href="#cb31-690" aria-hidden="true" tabindex="-1"></a>\mbox{E}\left( (y_n - \mu_n) ^ 2 - y_n\right) = (1 + \alpha)\mu_n -</span>
<span id="cb31-691"><a href="#cb31-691" aria-hidden="true" tabindex="-1"></a>\mu_n = \alpha \mu_n</span>
<span id="cb31-692"><a href="#cb31-692" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-693"><a href="#cb31-693" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-694"><a href="#cb31-694" aria-hidden="true" tabindex="-1"></a>or:</span>
<span id="cb31-695"><a href="#cb31-695" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-696"><a href="#cb31-696" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-697"><a href="#cb31-697" aria-hidden="true" tabindex="-1"></a>\frac{\mbox{E}\left( (y_n - \mu_n) ^ 2 - y_n\right)}{\mu_n} = \alpha</span>
<span id="cb31-698"><a href="#cb31-698" aria-hidden="true" tabindex="-1"></a>$$ {#eq-aregnb1}</span>
<span id="cb31-699"><a href="#cb31-699" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-700"><a href="#cb31-700" aria-hidden="true" tabindex="-1"></a>The hypothesis of equidispersion (i.e., $\alpha = 0$) can be tested by</span>
<span id="cb31-701"><a href="#cb31-701" aria-hidden="true" tabindex="-1"></a>regressing $\frac{ (y_n - \hat{\mu}_n) ^ 2 - y_n}{\hat{\mu}_n}$ on a constant and</span>
<span id="cb31-702"><a href="#cb31-702" aria-hidden="true" tabindex="-1"></a>comparing the Student statistic to the relevant critical value.</span>
<span id="cb31-703"><a href="#cb31-703" aria-hidden="true" tabindex="-1"></a>With the NB2 specification, the alternative is:\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{negbin!NB2}</span>
<span id="cb31-704"><a href="#cb31-704" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-705"><a href="#cb31-705" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-706"><a href="#cb31-706" aria-hidden="true" tabindex="-1"></a>\mbox{E}\left( (y_n - \mu_n) ^ 2 - y_n\right) = \mu_n + \alpha\mu_n ^</span>
<span id="cb31-707"><a href="#cb31-707" aria-hidden="true" tabindex="-1"></a>2 - \mu_n = \alpha \mu_n ^2</span>
<span id="cb31-708"><a href="#cb31-708" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-709"><a href="#cb31-709" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-710"><a href="#cb31-710" aria-hidden="true" tabindex="-1"></a>or:</span>
<span id="cb31-711"><a href="#cb31-711" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-712"><a href="#cb31-712" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-713"><a href="#cb31-713" aria-hidden="true" tabindex="-1"></a>\frac{\mbox{E}\left( (y_n - \mu_n) ^ 2 - y_n\right)}{\mu_n} = \alpha \mu_n</span>
<span id="cb31-714"><a href="#cb31-714" aria-hidden="true" tabindex="-1"></a>$$ {#eq-aregnb2}</span>
<span id="cb31-715"><a href="#cb31-715" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-716"><a href="#cb31-716" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{overdispersion!test}</span>
<span id="cb31-717"><a href="#cb31-717" aria-hidden="true" tabindex="-1"></a>The hypothesis of equidispersion (i.e., $\alpha = 0$) can then be tested by</span>
<span id="cb31-718"><a href="#cb31-718" aria-hidden="true" tabindex="-1"></a>regressing $\frac{ (y_n - \hat{\mu}_n) ^ 2 - y_n}{\hat{\mu}_n}$ on $\hat{\mu}_n$ without an intercept and comparing the Student statistic to the relevant critical value. Note that the response in this auxiliary regression can be written as: $(y_n - \hat{\mu}_n) ^ 2 / \hat{\mu}  - y_n/\hat{\mu}_n$, which is the difference between the square of the Pearson residual and the ratio of the actual and the fitted value of the response:</span>
<span id="cb31-719"><a href="#cb31-719" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">(</span><span class="co">]</span>{trips}{micsr}</span>
<span id="cb31-720"><a href="#cb31-720" aria-hidden="true" tabindex="-1"></a>\idxfun{fitted}{stats}\idxfun{model.response}{stats}\idxfun{model.frame}{stats}</span>
<span id="cb31-721"><a href="#cb31-721" aria-hidden="true" tabindex="-1"></a>\idxfun{resid}{stats}\idxfun{lm}{stats}\idxfun{gaze}{micsr}</span>
<span id="cb31-722"><a href="#cb31-722" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-723"><a href="#cb31-723" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb31-724"><a href="#cb31-724" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: true</span></span>
<span id="cb31-725"><a href="#cb31-725" aria-hidden="true" tabindex="-1"></a>hmu <span class="ot">&lt;-</span> <span class="fu">fitted</span>(pois_trips)</span>
<span id="cb31-726"><a href="#cb31-726" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">model.response</span>(<span class="fu">model.frame</span>(pois_trips))</span>
<span id="cb31-727"><a href="#cb31-727" aria-hidden="true" tabindex="-1"></a>e_pears <span class="ot">&lt;-</span> <span class="fu">resid</span>(pois_trips, <span class="at">type =</span> <span class="st">"pearson"</span>)</span>
<span id="cb31-728"><a href="#cb31-728" aria-hidden="true" tabindex="-1"></a>resp_areg <span class="ot">&lt;-</span> e_pears <span class="sc">^</span> <span class="dv">2</span> <span class="sc">-</span> y <span class="sc">/</span> hmu</span>
<span id="cb31-729"><a href="#cb31-729" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(resp_areg <span class="sc">~</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> <span class="fu">gaze</span>(<span class="at">coef =</span> <span class="dv">1</span>)</span>
<span id="cb31-730"><a href="#cb31-730" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(resp_areg <span class="sc">~</span> hmu <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> gaze</span>
<span id="cb31-731"><a href="#cb31-731" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-732"><a href="#cb31-732" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-733"><a href="#cb31-733" aria-hidden="true" tabindex="-1"></a>In both regressions, the t statistic is much higher than 1.96, the</span>
<span id="cb31-734"><a href="#cb31-734" aria-hidden="true" tabindex="-1"></a>p-value is very close to zero so that the equidispersion hypothesis</span>
<span id="cb31-735"><a href="#cb31-735" aria-hidden="true" tabindex="-1"></a>is strongly rejected. </span>
<span id="cb31-736"><a href="#cb31-736" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-737"><a href="#cb31-737" aria-hidden="true" tabindex="-1"></a>To see to what extent the introduction of covariates has reduced the</span>
<span id="cb31-738"><a href="#cb31-738" aria-hidden="true" tabindex="-1"></a>overdispersion problem, we can produce once again a rootogram, this</span>
<span id="cb31-739"><a href="#cb31-739" aria-hidden="true" tabindex="-1"></a>time using the fitted Poisson model. We use the default style</span>
<span id="cb31-740"><a href="#cb31-740" aria-hidden="true" tabindex="-1"></a>which is <span class="in">`"hanging"`</span>, which means that the bars are vertically aligned</span>
<span id="cb31-741"><a href="#cb31-741" aria-hidden="true" tabindex="-1"></a>on the points that display the fitted frequencies and the default scale</span>
<span id="cb31-742"><a href="#cb31-742" aria-hidden="true" tabindex="-1"></a>which is <span class="in">`"sqrt"`</span>; the vertical axis indicates the square root of the</span>
<span id="cb31-743"><a href="#cb31-743" aria-hidden="true" tabindex="-1"></a>frequencies, to increase the readability of small frequencies.</span>
<span id="cb31-744"><a href="#cb31-744" aria-hidden="true" tabindex="-1"></a>Rootograms for the Poisson model are presented on</span>
<span id="cb31-745"><a href="#cb31-745" aria-hidden="true" tabindex="-1"></a>@fig-rootograms along with the previous rootogram for the</span>
<span id="cb31-746"><a href="#cb31-746" aria-hidden="true" tabindex="-1"></a>unconditional distribution of <span class="in">`trips`</span>. The two figures are first</span>
<span id="cb31-747"><a href="#cb31-747" aria-hidden="true" tabindex="-1"></a>created without being plotted by setting the <span class="in">`plot`</span> argument to</span>
<span id="cb31-748"><a href="#cb31-748" aria-hidden="true" tabindex="-1"></a><span class="in">`FALSE`</span>, and are then assembled in one figure using</span>
<span id="cb31-749"><a href="#cb31-749" aria-hidden="true" tabindex="-1"></a><span class="in">`ggpubr::ggarrange`</span>. The limits on the vertical axis are set</span>
<span id="cb31-750"><a href="#cb31-750" aria-hidden="true" tabindex="-1"></a>to the same values for the two plots so that the frequencies for the</span>
<span id="cb31-751"><a href="#cb31-751" aria-hidden="true" tabindex="-1"></a>two figures can be easily compared.</span>
<span id="cb31-752"><a href="#cb31-752" aria-hidden="true" tabindex="-1"></a>\idxfun{rootogram}{countreg}\idxfun{autoplot}{ggplot2}\idxfun{coord<span class="sc">\_</span>cartesian}{ggplot2}\idxfun{ggarrange}{ggpubr}</span>
<span id="cb31-753"><a href="#cb31-753" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-754"><a href="#cb31-754" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb31-755"><a href="#cb31-755" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-rootograms</span></span>
<span id="cb31-756"><a href="#cb31-756" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Rootograms for Poisson models with and without covariates"</span></span>
<span id="cb31-757"><a href="#cb31-757" aria-hidden="true" tabindex="-1"></a>uncond_trips <span class="ot">&lt;-</span> <span class="fu">glm</span>(trips <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> trips, <span class="at">family =</span> <span class="st">"poisson"</span>)</span>
<span id="cb31-758"><a href="#cb31-758" aria-hidden="true" tabindex="-1"></a>fig_raw <span class="ot">&lt;-</span> topmodels<span class="sc">::</span><span class="fu">rootogram</span>(uncond_trips, </span>
<span id="cb31-759"><a href="#cb31-759" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">plot =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-760"><a href="#cb31-760" aria-hidden="true" tabindex="-1"></a>    autoplot <span class="sc">+</span> <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">15</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>, <span class="dv">12</span>))</span>
<span id="cb31-761"><a href="#cb31-761" aria-hidden="true" tabindex="-1"></a>fig_covar <span class="ot">&lt;-</span> topmodels<span class="sc">::</span><span class="fu">rootogram</span>(pois_trips, <span class="at">plot =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-762"><a href="#cb31-762" aria-hidden="true" tabindex="-1"></a>    autoplot <span class="sc">+</span> <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">15</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>, <span class="dv">12</span>))</span>
<span id="cb31-763"><a href="#cb31-763" aria-hidden="true" tabindex="-1"></a>figure <span class="ot">&lt;-</span> ggpubr<span class="sc">::</span><span class="fu">ggarrange</span>(fig_raw, fig_covar,</span>
<span id="cb31-764"><a href="#cb31-764" aria-hidden="true" tabindex="-1"></a>                           <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"No covariates"</span>, <span class="st">"Covariates"</span>),</span>
<span id="cb31-765"><a href="#cb31-765" aria-hidden="true" tabindex="-1"></a>                           <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">nrow =</span> <span class="dv">1</span>)</span>
<span id="cb31-766"><a href="#cb31-766" aria-hidden="true" tabindex="-1"></a>figure</span>
<span id="cb31-767"><a href="#cb31-767" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-768"><a href="#cb31-768" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-769"><a href="#cb31-769" aria-hidden="true" tabindex="-1"></a>One can see that the bottom of the bars is closer to the horizontal axis</span>
<span id="cb31-770"><a href="#cb31-770" aria-hidden="true" tabindex="-1"></a>for the right figure (Poisson model with covariates), which indicates</span>
<span id="cb31-771"><a href="#cb31-771" aria-hidden="true" tabindex="-1"></a>that the inclusion of covariates reduces slightly the overdispersion</span>
<span id="cb31-772"><a href="#cb31-772" aria-hidden="true" tabindex="-1"></a>problem, which anyway still remains. Moreover, the excess of zero</span>
<span id="cb31-773"><a href="#cb31-773" aria-hidden="true" tabindex="-1"></a>largely remains, which suggests that a model that takes the specificity</span>
<span id="cb31-774"><a href="#cb31-774" aria-hidden="true" tabindex="-1"></a>of zero values should be used.</span>
<span id="cb31-775"><a href="#cb31-775" aria-hidden="true" tabindex="-1"></a>The overdispersion phenomenon can also be represented by plotting the</span>
<span id="cb31-776"><a href="#cb31-776" aria-hidden="true" tabindex="-1"></a>square of the residuals against the fitted values, the straight</span>
<span id="cb31-777"><a href="#cb31-777" aria-hidden="true" tabindex="-1"></a>line (NB1 hypothesis) and the parabola (NB2 hypothesis) that fit the</span>
<span id="cb31-778"><a href="#cb31-778" aria-hidden="true" tabindex="-1"></a>data. The result is presented in @fig-overpts. </span>
<span id="cb31-779"><a href="#cb31-779" aria-hidden="true" tabindex="-1"></a>\idxfun{tibble}{tibble}\idxfun{resid}{stats}\idxfun{fitted}{stats}\idxfun{aes}{ggplot2}</span>
<span id="cb31-780"><a href="#cb31-780" aria-hidden="true" tabindex="-1"></a>\idxfun{ggplot}{ggplot2}\idxfun{geom<span class="sc">\_</span>point}{ggplot2}\idxfun{geom<span class="sc">\_</span>smooth}{ggplot2}</span>
<span id="cb31-781"><a href="#cb31-781" aria-hidden="true" tabindex="-1"></a>\idxfun{coord<span class="sc">\_</span>cartesian}{ggplot2}</span>
<span id="cb31-782"><a href="#cb31-782" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-783"><a href="#cb31-783" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb31-784"><a href="#cb31-784" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-overpts</span></span>
<span id="cb31-785"><a href="#cb31-785" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Squared residuals and fitted values"</span></span>
<span id="cb31-786"><a href="#cb31-786" aria-hidden="true" tabindex="-1"></a>tb <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">e2 =</span> <span class="fu">resid</span>(pois_trips, <span class="at">type =</span> <span class="st">"response"</span>) <span class="sc">^</span> <span class="dv">2</span>,</span>
<span id="cb31-787"><a href="#cb31-787" aria-hidden="true" tabindex="-1"></a>             <span class="at">mu =</span> <span class="fu">fitted</span>(pois_trips))</span>
<span id="cb31-788"><a href="#cb31-788" aria-hidden="true" tabindex="-1"></a>tb <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(mu, e2)) <span class="sc">+</span> <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb31-789"><a href="#cb31-789" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">15</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">150</span>)) <span class="sc">+</span></span>
<span id="cb31-790"><a href="#cb31-790" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="at">method =</span> lm, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">formula =</span> y <span class="sc">~</span> x <span class="sc">-</span> <span class="dv">1</span>, </span>
<span id="cb31-791"><a href="#cb31-791" aria-hidden="true" tabindex="-1"></a>                <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb31-792"><a href="#cb31-792" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="at">method =</span> lm, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">formula =</span> y <span class="sc">~</span> x <span class="sc">+</span> <span class="fu">I</span>(x <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb31-793"><a href="#cb31-793" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-794"><a href="#cb31-794" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">)</span><span class="co">]</span>{trips}{micsr}</span>
<span id="cb31-795"><a href="#cb31-795" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{overdispersion|(}</span>
<span id="cb31-796"><a href="#cb31-796" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-797"><a href="#cb31-797" aria-hidden="true" tabindex="-1"></a><span class="fu">## Overdispersion and excess of zero {#sec-overdisp_zero}</span></span>
<span id="cb31-798"><a href="#cb31-798" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-799"><a href="#cb31-799" aria-hidden="true" tabindex="-1"></a>We describe in this section models that have been proposed to overcome the limits of the</span>
<span id="cb31-800"><a href="#cb31-800" aria-hidden="true" tabindex="-1"></a>Poisson model, namely the fact that it doesn't deal correctly with</span>
<span id="cb31-801"><a href="#cb31-801" aria-hidden="true" tabindex="-1"></a>overdispersion and the excess of zero.</span>
<span id="cb31-802"><a href="#cb31-802" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-803"><a href="#cb31-803" aria-hidden="true" tabindex="-1"></a><span class="fu">### Mixing model</span></span>
<span id="cb31-804"><a href="#cb31-804" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{mixing distribution!Poisson model|(}</span>
<span id="cb31-805"><a href="#cb31-805" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-806"><a href="#cb31-806" aria-hidden="true" tabindex="-1"></a>For the Poisson model with the log-link, the parameter of the Poisson distribution for individual $n$ is $\mu_n = e^ {\gamma ^ \top z_n}$. The problem of overdispersion occurs when the variance of $y$ is greater than its expectation, although the hypothesis underlying the use of the Poisson model is that they are equal. One solution is to define the Poisson parameter for individual $n$ as : $\lambda_n = \nu_n \mu_n = \nu_n e^ {\gamma ^ \top z_n}$. $\nu_n$ is an unobserved positive term that inflates the variance of $y$. Actually, for the same set of covariates $z$, two individuals $n$ and $m$  will be characterized by two different values of their Poisson parameters if $\nu_n \neq \nu_m$. For a given value of $\nu$, the probability of $y$ is still Poisson:</span>
<span id="cb31-807"><a href="#cb31-807" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-808"><a href="#cb31-808" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-809"><a href="#cb31-809" aria-hidden="true" tabindex="-1"></a>P(y_n \mid x_n, \nu_n ; \gamma) = \frac{e^{- \nu_n e^{\gamma ^ \top z_n}} \left(\nu_ne^{\gamma ^ \top z_n}\right) ^ {y_n}}{y_n !}</span>
<span id="cb31-810"><a href="#cb31-810" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-811"><a href="#cb31-811" aria-hidden="true" tabindex="-1"></a>but, as $\nu_n$ is unobserved, this probability can't be used to estimate the parameters of the model.</span>
<span id="cb31-812"><a href="#cb31-812" aria-hidden="true" tabindex="-1"></a>To get the distribution of $y$ conditional on $x$ only, we need to</span>
<span id="cb31-813"><a href="#cb31-813" aria-hidden="true" tabindex="-1"></a>integrate out $\nu_n$, assuming a specific distribution for $\nu$, called the **mixing distribution**. Two</span>
<span id="cb31-814"><a href="#cb31-814" aria-hidden="true" tabindex="-1"></a>popular choices are the gamma and the log-normal distributions. The gamma density is:</span>
<span id="cb31-815"><a href="#cb31-815" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{mixing distribution!Poisson model!gamma|(}</span>
<span id="cb31-816"><a href="#cb31-816" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-817"><a href="#cb31-817" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-818"><a href="#cb31-818" aria-hidden="true" tabindex="-1"></a>g(\nu; \delta, \gamma) = \nu ^ {\delta - 1} e ^ {- \gamma \nu} \gamma ^ \delta / \Gamma(\delta)</span>
<span id="cb31-819"><a href="#cb31-819" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-820"><a href="#cb31-820" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-821"><a href="#cb31-821" aria-hidden="true" tabindex="-1"></a>where $\delta$ and $\gamma$ are respectively called the shape and the</span>
<span id="cb31-822"><a href="#cb31-822" aria-hidden="true" tabindex="-1"></a>intensity parameters and $\Gamma(z) = \int_0 ^ {+\infty}t ^ {z-1}e^{-t} dt$ is the Gamma function. The expected value and the variance are</span>
<span id="cb31-823"><a href="#cb31-823" aria-hidden="true" tabindex="-1"></a>respectively $\delta / \gamma$ and $\delta / \gamma ^ 2$. As $\gamma$ contains an intercept $\alpha$, $\alpha$ and the expected value of $\nu$ can't be identified and a simple choice of normalization is to set $\delta = \gamma$, so that the expected value of $\nu$ is set to 1 and the variance is then $1 / \gamma$. The density of $\nu$ is then:</span>
<span id="cb31-824"><a href="#cb31-824" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-825"><a href="#cb31-825" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-826"><a href="#cb31-826" aria-hidden="true" tabindex="-1"></a>g(\nu; \delta) = \nu ^ {\delta - 1} e ^ {- \delta \nu} \delta ^ \delta / \Gamma(\delta)</span>
<span id="cb31-827"><a href="#cb31-827" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-828"><a href="#cb31-828" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{negative binomial distribution}</span>
<span id="cb31-829"><a href="#cb31-829" aria-hidden="true" tabindex="-1"></a>The distribution of $y$ conditional on $x_n$ only, called the **negative binomial** distribution, is then:</span>
<span id="cb31-830"><a href="#cb31-830" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-831"><a href="#cb31-831" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-832"><a href="#cb31-832" aria-hidden="true" tabindex="-1"></a>\begin{array}{rcl}</span>
<span id="cb31-833"><a href="#cb31-833" aria-hidden="true" tabindex="-1"></a>P(y_n \mid x_n ; \gamma, \delta) &amp;=&amp; \displaystyle \int_0 ^ {+\infty} P(y_n \mid</span>
<span id="cb31-834"><a href="#cb31-834" aria-hidden="true" tabindex="-1"></a>x_n, v ; \gamma) g(\nu; \delta) d\nu <span class="sc">\\</span></span>
<span id="cb31-835"><a href="#cb31-835" aria-hidden="true" tabindex="-1"></a>&amp;=&amp; \displaystyle \int_0 ^ {+\infty} </span>
<span id="cb31-836"><a href="#cb31-836" aria-hidden="true" tabindex="-1"></a>\frac{e^{- \mu_n \nu} (\mu_n\nu) ^{y_n}}{y_n !}</span>
<span id="cb31-837"><a href="#cb31-837" aria-hidden="true" tabindex="-1"></a>\nu ^ {\delta - 1} e ^ {- \delta \nu} \delta ^ \delta / \Gamma(\delta)</span>
<span id="cb31-838"><a href="#cb31-838" aria-hidden="true" tabindex="-1"></a>d\nu</span>
<span id="cb31-839"><a href="#cb31-839" aria-hidden="true" tabindex="-1"></a>\end{array}</span>
<span id="cb31-840"><a href="#cb31-840" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-841"><a href="#cb31-841" aria-hidden="true" tabindex="-1"></a>Rearranging terms, we get:</span>
<span id="cb31-842"><a href="#cb31-842" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-843"><a href="#cb31-843" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-844"><a href="#cb31-844" aria-hidden="true" tabindex="-1"></a>P(y_n \mid x_n ; \gamma, \delta) = </span>
<span id="cb31-845"><a href="#cb31-845" aria-hidden="true" tabindex="-1"></a>\frac{\mu_n ^ {y_n} \delta ^ \delta}{y_n !\Gamma(\delta)}</span>
<span id="cb31-846"><a href="#cb31-846" aria-hidden="true" tabindex="-1"></a>\int_0 ^ {+\infty} </span>
<span id="cb31-847"><a href="#cb31-847" aria-hidden="true" tabindex="-1"></a>e^{- (\mu_n + \delta) \nu} \nu ^ {y_n + \delta - 1}</span>
<span id="cb31-848"><a href="#cb31-848" aria-hidden="true" tabindex="-1"></a>d\nu</span>
<span id="cb31-849"><a href="#cb31-849" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-850"><a href="#cb31-850" aria-hidden="true" tabindex="-1"></a>with the change of variable $t = (\mu_n + \delta)\nu$, we finally get:</span>
<span id="cb31-851"><a href="#cb31-851" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-852"><a href="#cb31-852" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-853"><a href="#cb31-853" aria-hidden="true" tabindex="-1"></a>P(y_n \mid x_n ; \gamma, \delta) = </span>
<span id="cb31-854"><a href="#cb31-854" aria-hidden="true" tabindex="-1"></a>\frac{\mu ^ {y_n} \delta ^ \delta}{y_n !\Gamma(\delta)}</span>
<span id="cb31-855"><a href="#cb31-855" aria-hidden="true" tabindex="-1"></a>\frac{\Gamma(y_n + \delta)}{(\mu + \delta) ^{y_n + \delta}}</span>
<span id="cb31-856"><a href="#cb31-856" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-857"><a href="#cb31-857" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-858"><a href="#cb31-858" aria-hidden="true" tabindex="-1"></a>and finally, as, for integer values of $x$: $\Gamma(x + 1) = x!$:</span>
<span id="cb31-859"><a href="#cb31-859" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-860"><a href="#cb31-860" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-861"><a href="#cb31-861" aria-hidden="true" tabindex="-1"></a>P(y_n \mid x_n ; \gamma, \delta) = </span>
<span id="cb31-862"><a href="#cb31-862" aria-hidden="true" tabindex="-1"></a>\frac{\Gamma(y_n + \delta)}{\Gamma(y_n + 1)\Gamma(\delta)}</span>
<span id="cb31-863"><a href="#cb31-863" aria-hidden="true" tabindex="-1"></a>\left(\frac{\mu_n}{\mu_n + \delta}\right) ^ {y_n} \left(\frac{\delta}{\mu_n +</span>
<span id="cb31-864"><a href="#cb31-864" aria-hidden="true" tabindex="-1"></a>\delta}\right) ^ \delta</span>
<span id="cb31-865"><a href="#cb31-865" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-866"><a href="#cb31-866" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-867"><a href="#cb31-867" aria-hidden="true" tabindex="-1"></a>Conditional on $x_n$ and $\nu_n$, $\mbox{E}(y_n \mid x_n, \nu_n) = \mbox{V}(y_n \mid x_n, \nu_n) = \nu_n \mu_n$. Conditional on $x_n$ only, $\mbox{E}(y_n | x_n)= \mbox{E}_\nu(\nu \lambda_n) = \mu_n$ (as</span>
<span id="cb31-868"><a href="#cb31-868" aria-hidden="true" tabindex="-1"></a>$\mbox{E}(\nu) = 1$). To get the variance, we use the formula of</span>
<span id="cb31-869"><a href="#cb31-869" aria-hidden="true" tabindex="-1"></a>variance decomposition:\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{variance decomposition}</span>
<span id="cb31-870"><a href="#cb31-870" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-871"><a href="#cb31-871" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-872"><a href="#cb31-872" aria-hidden="true" tabindex="-1"></a>\begin{array}{rcl}</span>
<span id="cb31-873"><a href="#cb31-873" aria-hidden="true" tabindex="-1"></a>\mbox{V}(y_n |x_n) &amp;=&amp; \mbox{E}_\nu\left(\mbox{V}(y_n |x_n,</span>
<span id="cb31-874"><a href="#cb31-874" aria-hidden="true" tabindex="-1"></a>\nu_n)\right) + \mbox{V}_\nu\left(\mbox{E}(y_n |x_n,</span>
<span id="cb31-875"><a href="#cb31-875" aria-hidden="true" tabindex="-1"></a>\nu_n)\right) = </span>
<span id="cb31-876"><a href="#cb31-876" aria-hidden="true" tabindex="-1"></a>\mbox{E}_\nu(\lambda_n) +</span>
<span id="cb31-877"><a href="#cb31-877" aria-hidden="true" tabindex="-1"></a>\mbox{V}_\nu(\lambda_n)<span class="sc">\\</span></span>
<span id="cb31-878"><a href="#cb31-878" aria-hidden="true" tabindex="-1"></a>&amp;=&amp;</span>
<span id="cb31-879"><a href="#cb31-879" aria-hidden="true" tabindex="-1"></a>\mu_n + \mu_n ^ 2 \mbox{V}(\nu_n) = </span>
<span id="cb31-880"><a href="#cb31-880" aria-hidden="true" tabindex="-1"></a>\mu_n(1 + \mu_n/ \delta)</span>
<span id="cb31-881"><a href="#cb31-881" aria-hidden="true" tabindex="-1"></a>\end{array}</span>
<span id="cb31-882"><a href="#cb31-882" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-883"><a href="#cb31-883" aria-hidden="true" tabindex="-1"></a>Different parametrizations result in different flavors of the **Negbin model**. Replacing $\delta$ by $\sigma = 1 / \delta$ we get the NB2 model, with a quadratic conditional variance</span>
<span id="cb31-884"><a href="#cb31-884" aria-hidden="true" tabindex="-1"></a>function:</span>
<span id="cb31-885"><a href="#cb31-885" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{negbin!NB2}</span>
<span id="cb31-886"><a href="#cb31-886" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-887"><a href="#cb31-887" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-888"><a href="#cb31-888" aria-hidden="true" tabindex="-1"></a>\mbox{V}(y_n|x_n) = \mu_n + \sigma \mu_n ^ 2 = (1 + \sigma \mu_n)\mu_n</span>
<span id="cb31-889"><a href="#cb31-889" aria-hidden="true" tabindex="-1"></a>$$ {#eq-var_negbin2}</span>
<span id="cb31-890"><a href="#cb31-890" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-891"><a href="#cb31-891" aria-hidden="true" tabindex="-1"></a>Replacing $\delta$ by $\mu_n / \sigma$, we get the NB1 model, with a</span>
<span id="cb31-892"><a href="#cb31-892" aria-hidden="true" tabindex="-1"></a>linear conditional variance function:</span>
<span id="cb31-893"><a href="#cb31-893" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{negbin!NB1}</span>
<span id="cb31-894"><a href="#cb31-894" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-895"><a href="#cb31-895" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-896"><a href="#cb31-896" aria-hidden="true" tabindex="-1"></a>\mbox{V}(y_n\mid x_n) = (1 + \sigma) \mu_n</span>
<span id="cb31-897"><a href="#cb31-897" aria-hidden="true" tabindex="-1"></a>$$ {#eq-var_negbin1}</span>
<span id="cb31-898"><a href="#cb31-898" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-899"><a href="#cb31-899" aria-hidden="true" tabindex="-1"></a>Note that, as $\delta$ is positive, so is $\sigma$ in the versions of the Negbin model so that </span>
<span id="cb31-900"><a href="#cb31-900" aria-hidden="true" tabindex="-1"></a>the Negbin model exhibits necessarily overdispersion, with the</span>
<span id="cb31-901"><a href="#cb31-901" aria-hidden="true" tabindex="-1"></a>special case of equidispersion if $\sigma = 0$. Actually, in this case, $\delta \rightarrow \infty$, so that the variance of $\nu$ tends to 0 and the Poisson model is therefore obtained as</span>
<span id="cb31-902"><a href="#cb31-902" aria-hidden="true" tabindex="-1"></a>a limiting case. </span>
<span id="cb31-903"><a href="#cb31-903" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{mixing distribution!Poisson model!gamma|)}</span>
<span id="cb31-904"><a href="#cb31-904" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{mixing distribution!Poisson model!normal|(}</span>
<span id="cb31-905"><a href="#cb31-905" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-906"><a href="#cb31-906" aria-hidden="true" tabindex="-1"></a>Another choice for the mixing distribution is the log-normal distribution, with $\ln \nu \sim \mathcal{N} (0, \sigma)$. The first parameter of the distribution is set to 0. For a log-normal distribution, the exponential of this parameter is the median of the log-normal. Therefore, the choice of normalization for the log-normal distribution is to set the median (and not the mean as in the gamma distribution) to 0. The log-normal density is $\frac{1}{\sigma\nu}\phi(\ln \nu / \sigma)$ where $\phi()$ is the standard normal density. The probabilities are then given by:</span>
<span id="cb31-907"><a href="#cb31-907" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-908"><a href="#cb31-908" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-909"><a href="#cb31-909" aria-hidden="true" tabindex="-1"></a>P(y_n \mid x_n ; \gamma, \delta) =</span>
<span id="cb31-910"><a href="#cb31-910" aria-hidden="true" tabindex="-1"></a> \int_0 ^ {+\infty} </span>
<span id="cb31-911"><a href="#cb31-911" aria-hidden="true" tabindex="-1"></a>\frac{e^{- e ^ {\gamma ^ \top z_n} \nu_n} (e ^ {\gamma ^ \top z_n}\nu_n) ^ y}{y !}</span>
<span id="cb31-912"><a href="#cb31-912" aria-hidden="true" tabindex="-1"></a>\frac{1}{\sqrt{2\pi}\sigma\nu} e ^ {-\frac{1}{2}\left(\frac{\ln \nu}{\sigma}\right) ^ 2} d\nu</span>
<span id="cb31-913"><a href="#cb31-913" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-914"><a href="#cb31-914" aria-hidden="true" tabindex="-1"></a>using the change of variable $t = \ln \nu / (\sqrt{2}\sigma)$, we get:</span>
<span id="cb31-915"><a href="#cb31-915" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-916"><a href="#cb31-916" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-917"><a href="#cb31-917" aria-hidden="true" tabindex="-1"></a>P(y_n \mid x_n ; \gamma, \delta) =\frac{1}{\sqrt{\pi} y_n !}</span>
<span id="cb31-918"><a href="#cb31-918" aria-hidden="true" tabindex="-1"></a> \int_{- \infty} ^ {+\infty} </span>
<span id="cb31-919"><a href="#cb31-919" aria-hidden="true" tabindex="-1"></a>e^{- e ^ {\gamma ^ \top z_n + \sqrt{2}\sigma t}} e ^ {y(\gamma ^ \top z_n + \sqrt{2}\sigma t)}</span>
<span id="cb31-920"><a href="#cb31-920" aria-hidden="true" tabindex="-1"></a> e ^ {-t^2} dt</span>
<span id="cb31-921"><a href="#cb31-921" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-922"><a href="#cb31-922" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-923"><a href="#cb31-923" aria-hidden="true" tabindex="-1"></a>There is no closed form for this integral, but it can be approximated using Gauss-Hermite quadrature:</span>
<span id="cb31-924"><a href="#cb31-924" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{gaussian quadrature}</span>
<span id="cb31-925"><a href="#cb31-925" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-926"><a href="#cb31-926" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-927"><a href="#cb31-927" aria-hidden="true" tabindex="-1"></a>\int_{-\infty} ^ {+\infty}f(t) e ^ {-t ^ 2}dt \approx \sum_{r = 1} ^ R \omega_r f(t_r)</span>
<span id="cb31-928"><a href="#cb31-928" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-929"><a href="#cb31-929" aria-hidden="true" tabindex="-1"></a>where $R$ is the number of points for which the function is evaluated, $t_r$ are called the nodes and $\omega_r$ the weights.</span>
<span id="cb31-930"><a href="#cb31-930" aria-hidden="true" tabindex="-1"></a>For a log-normal variable, $\mbox{E}(x) = e ^ {\mu + 0.5 \sigma ^ 2}$ and $\mbox{V}(x) = e ^ {2\mu + \sigma ^ 2}(e ^ {\sigma ^ 2} - 1)$. As, we set $\mu$ to 0, $\mbox{E}(y_n\mid x_n) = \mbox{E}_\nu\left(\mbox{E}(y_n\mid, x_n, \nu)\right) = e^{\frac{1}{2}\sigma ^ 2}\mu_n$. Moreover, $\mbox{E}_\nu\left(\mbox{V}(y_n\mid, x_n, \nu)\right) = e^{\frac{1}{2}\sigma ^ 2}\mu_n$ and $\mbox{V}_\nu(\mbox{E}(y_n\mid, x_n, \nu)) = \mu_n ^ 2 e ^ {\sigma ^ 2}(e ^ {\sigma ^ 2} - 1)$ so that:</span>
<span id="cb31-931"><a href="#cb31-931" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-932"><a href="#cb31-932" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-933"><a href="#cb31-933" aria-hidden="true" tabindex="-1"></a>\mbox{V}(y_n \mid x_n) = e^{\frac{1}{2}\sigma ^ 2}\mu_n + e ^ {\sigma ^ 2}(e ^ {\sigma ^ 2} - 1) \mu_n ^ 2 =</span>
<span id="cb31-934"><a href="#cb31-934" aria-hidden="true" tabindex="-1"></a>\left(1 + (e ^ {\sigma ^ 2} - 1)\mbox{E}(y \mid  x_n)\right) \mbox{E}(y_n \mid  x_n)</span>
<span id="cb31-935"><a href="#cb31-935" aria-hidden="true" tabindex="-1"></a>$$ {#eq-var_lognorm}</span>
<span id="cb31-936"><a href="#cb31-936" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{mixing distribution!Poisson model!normal|)}</span>
<span id="cb31-937"><a href="#cb31-937" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{mixing distribution!Poisson model|)}</span>
<span id="cb31-938"><a href="#cb31-938" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-939"><a href="#cb31-939" aria-hidden="true" tabindex="-1"></a>We then estimate the Poisson model and the three mixed models we've just described. The <span class="in">`micsr::poisreg`</span> function enables the estimation of this mixed models. It has a <span class="in">`mixing`</span> argument. If <span class="in">`mixing = "none"`</span> (the default), the basic Poisson model is estimated. Setting <span class="in">`mixing`</span> to <span class="in">`"gamma"`</span> and <span class="in">`"lognorm"`</span> result respectively in the Negbin and the Log-normal-Poisson models. For the Negbin model, the two different flavors are obtained by setting <span class="in">`vlink`</span> either to <span class="in">`"nb1"`</span> (the default) or to <span class="in">`"nb2"`</span> to get respectively the Negbin1 and the Negbin2 models.^<span class="co">[</span><span class="ot">The NB2 model is implemented in `MASS::glm.nb`.</span><span class="co">]</span> The results are presented in @tbl-mixed_models.</span>
<span id="cb31-940"><a href="#cb31-940" aria-hidden="true" tabindex="-1"></a>\idxfun{poisreg}{micsr}\idxfun{update}{stats}</span>
<span id="cb31-941"><a href="#cb31-941" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">(</span><span class="co">]</span>{trips}{micsr}</span>
<span id="cb31-942"><a href="#cb31-942" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-945"><a href="#cb31-945" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-946"><a href="#cb31-946" aria-hidden="true" tabindex="-1"></a>pois <span class="ot">&lt;-</span> <span class="fu">poisreg</span>(trips <span class="sc">~</span> workschl <span class="sc">+</span> size <span class="sc">+</span> dist <span class="sc">+</span> smsa <span class="sc">+</span> fulltime <span class="sc">+</span> </span>
<span id="cb31-947"><a href="#cb31-947" aria-hidden="true" tabindex="-1"></a>                  distnod <span class="sc">+</span> realinc <span class="sc">+</span> weekend <span class="sc">+</span> car, trips)</span>
<span id="cb31-948"><a href="#cb31-948" aria-hidden="true" tabindex="-1"></a>nb1 <span class="ot">&lt;-</span> <span class="fu">update</span>(pois, <span class="at">mixing =</span> <span class="st">"gamma"</span>, <span class="at">vlink =</span> <span class="st">"nb1"</span>)</span>
<span id="cb31-949"><a href="#cb31-949" aria-hidden="true" tabindex="-1"></a>nb2 <span class="ot">&lt;-</span> <span class="fu">update</span>(pois, <span class="at">mixing =</span> <span class="st">"gamma"</span>, <span class="at">vlink =</span> <span class="st">"nb2"</span>)</span>
<span id="cb31-950"><a href="#cb31-950" aria-hidden="true" tabindex="-1"></a>ln <span class="ot">&lt;-</span> <span class="fu">update</span>(pois, <span class="at">mixing =</span> <span class="st">"lognorm"</span>)</span>
<span id="cb31-951"><a href="#cb31-951" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-952"><a href="#cb31-952" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-953"><a href="#cb31-953" aria-hidden="true" tabindex="-1"></a>The most striking result is the improvement of the fit. The coefficient of $\sigma$ in the three specifications is highly significant, and the AIC or the BIC conclude that the mixed models are much better than the Poisson model. Using these indicators, it is difficult to discriminate between these three models because the AIC and the BIC are almost the same.</span>
<span id="cb31-954"><a href="#cb31-954" aria-hidden="true" tabindex="-1"></a>The standard errors are much higher for the mixed models compared to the Poisson model, but remember that, when overdispersion is present, the standard errors of the Poisson model are downward biased.</span>
<span id="cb31-955"><a href="#cb31-955" aria-hidden="true" tabindex="-1"></a>Using respectively @eq-var_negbin1, @eq-var_negbin2 and @eq-var_lognorm, we compute the ratio of the variance and the expectation at the sample mean for the three models, i.e., using $\bar{y}$ instead of $\mbox{E}(y \mid x_n)$ in the three formulas:</span>
<span id="cb31-956"><a href="#cb31-956" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-959"><a href="#cb31-959" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-960"><a href="#cb31-960" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-mixed_models</span></span>
<span id="cb31-961"><a href="#cb31-961" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Mixed models for the demand for trips"</span></span>
<span id="cb31-962"><a href="#cb31-962" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb31-963"><a href="#cb31-963" aria-hidden="true" tabindex="-1"></a>modelsummary<span class="sc">::</span><span class="fu">msummary</span>(<span class="fu">list</span>(<span class="at">poisson =</span> pois, <span class="at">Negbin1 =</span> nb1, <span class="at">Negbin2 =</span> nb2, <span class="st">`</span><span class="at">Log-normal</span><span class="st">`</span> <span class="ot">=</span> ln),</span>
<span id="cb31-964"><a href="#cb31-964" aria-hidden="true" tabindex="-1"></a>                       <span class="at">output =</span> <span class="st">"kableExtra"</span>)</span>
<span id="cb31-965"><a href="#cb31-965" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-966"><a href="#cb31-966" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-967"><a href="#cb31-967" aria-hidden="true" tabindex="-1"></a>\idxfun{coef}{stats}</span>
<span id="cb31-968"><a href="#cb31-968" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-971"><a href="#cb31-971" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-972"><a href="#cb31-972" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: true</span></span>
<span id="cb31-973"><a href="#cb31-973" aria-hidden="true" tabindex="-1"></a>sig_nb1 <span class="ot">&lt;-</span> <span class="fu">coef</span>(nb1)[<span class="st">"sigma"</span>]</span>
<span id="cb31-974"><a href="#cb31-974" aria-hidden="true" tabindex="-1"></a>sig_nb2 <span class="ot">&lt;-</span> <span class="fu">coef</span>(nb2)[<span class="st">"sigma"</span>]</span>
<span id="cb31-975"><a href="#cb31-975" aria-hidden="true" tabindex="-1"></a>sig_ln <span class="ot">&lt;-</span> <span class="fu">coef</span>(ln)[<span class="st">"sigma"</span>]</span>
<span id="cb31-976"><a href="#cb31-976" aria-hidden="true" tabindex="-1"></a>yb <span class="ot">&lt;-</span> <span class="fu">mean</span>(trips<span class="sc">$</span>trips)</span>
<span id="cb31-977"><a href="#cb31-977" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="sc">+</span> sig_nb1</span>
<span id="cb31-978"><a href="#cb31-978" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="sc">+</span> sig_nb2 <span class="sc">*</span> yb</span>
<span id="cb31-979"><a href="#cb31-979" aria-hidden="true" tabindex="-1"></a>(<span class="dv">1</span> <span class="sc">+</span> (<span class="fu">exp</span>(sig_ln <span class="sc">^</span> <span class="dv">2</span>) <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> yb)</span>
<span id="cb31-980"><a href="#cb31-980" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-981"><a href="#cb31-981" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-982"><a href="#cb31-982" aria-hidden="true" tabindex="-1"></a>Therefore, the three mixing models predict the same level of overdispersion, the conditional variance being about 3.5 times larger than the conditional expectation. This value should be compared to the ratio of the sample variance (<span class="in">`r round(var(trips$trips), 1)`</span>) and the sample mean (<span class="in">`r round(mean(trips$trips), 1)`</span>), which is (<span class="in">`r round(var(trips$trips)/mean(trips$trips), 1)`</span>). @fig-rootograms_mixed presents the rootogram for the Poisson and the Negbin model. We can see that taking into account the overdispersion using a mixing model resolves most of the overdispersion problem.</span>
<span id="cb31-983"><a href="#cb31-983" aria-hidden="true" tabindex="-1"></a>\idxfun{glm}{stats}\idxfun{formula}{stats}\idxfun{glm.nb}{MASS}\idxfun{rootogram}{countreg}</span>
<span id="cb31-984"><a href="#cb31-984" aria-hidden="true" tabindex="-1"></a>\idxfun{autoplot}{ggplot2}\idxfun{coord<span class="sc">\_</span>cartesian}{ggplot2}\idxfun{ggarrange}{ggpubr}</span>
<span id="cb31-985"><a href="#cb31-985" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-986"><a href="#cb31-986" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb31-987"><a href="#cb31-987" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-rootograms_mixed</span></span>
<span id="cb31-988"><a href="#cb31-988" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Rootograms for the Poisson and the Negbin model"</span></span>
<span id="cb31-989"><a href="#cb31-989" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb31-990"><a href="#cb31-990" aria-hidden="true" tabindex="-1"></a>pois_glm <span class="ot">&lt;-</span> <span class="fu">glm</span>(<span class="fu">formula</span>(pois), <span class="at">family =</span> poisson, trips)</span>
<span id="cb31-991"><a href="#cb31-991" aria-hidden="true" tabindex="-1"></a>nb2_mass <span class="ot">&lt;-</span> MASS<span class="sc">::</span><span class="fu">glm.nb</span>(<span class="fu">formula</span>(pois), trips)</span>
<span id="cb31-992"><a href="#cb31-992" aria-hidden="true" tabindex="-1"></a>fig_pois <span class="ot">&lt;-</span> topmodels<span class="sc">::</span><span class="fu">rootogram</span>(pois_glm, <span class="at">plot =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-993"><a href="#cb31-993" aria-hidden="true" tabindex="-1"></a>    autoplot <span class="sc">+</span> <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">15</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>, <span class="dv">12</span>))</span>
<span id="cb31-994"><a href="#cb31-994" aria-hidden="true" tabindex="-1"></a>fig_nb2 <span class="ot">&lt;-</span>topmodels<span class="sc">::</span><span class="fu">rootogram</span>(nb2_mass, <span class="at">plot =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-995"><a href="#cb31-995" aria-hidden="true" tabindex="-1"></a>    autoplot <span class="sc">+</span> <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">15</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>, <span class="dv">12</span>))</span>
<span id="cb31-996"><a href="#cb31-996" aria-hidden="true" tabindex="-1"></a>figure <span class="ot">&lt;-</span> ggpubr<span class="sc">::</span><span class="fu">ggarrange</span>(fig_pois, fig_nb2,</span>
<span id="cb31-997"><a href="#cb31-997" aria-hidden="true" tabindex="-1"></a>                           <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Poisson"</span>, <span class="st">"Negbin2"</span>),</span>
<span id="cb31-998"><a href="#cb31-998" aria-hidden="true" tabindex="-1"></a>                           <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">nrow =</span> <span class="dv">1</span>)</span>
<span id="cb31-999"><a href="#cb31-999" aria-hidden="true" tabindex="-1"></a>figure</span>
<span id="cb31-1000"><a href="#cb31-1000" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-1001"><a href="#cb31-1001" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1002"><a href="#cb31-1002" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">)</span><span class="co">]</span>{trips}{micsr}</span>
<span id="cb31-1003"><a href="#cb31-1003" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1004"><a href="#cb31-1004" aria-hidden="true" tabindex="-1"></a><span class="fu">### Hurdle and ZIP models</span></span>
<span id="cb31-1005"><a href="#cb31-1005" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1006"><a href="#cb31-1006" aria-hidden="true" tabindex="-1"></a>As we have seen previously for the <span class="in">`trips`</span> data set, it seems that</span>
<span id="cb31-1007"><a href="#cb31-1007" aria-hidden="true" tabindex="-1"></a>the Poisson model is unable to model correctly the probability of $y =</span>
<span id="cb31-1008"><a href="#cb31-1008" aria-hidden="true" tabindex="-1"></a>0$. Different phenomena can explain zero values:</span>
<span id="cb31-1009"><a href="#cb31-1009" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1010"><a href="#cb31-1010" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>some people may never (or almost never) take a trip out of the house</span>
<span id="cb31-1011"><a href="#cb31-1011" aria-hidden="true" tabindex="-1"></a>  because, for example, of a bad physical condition,</span>
<span id="cb31-1012"><a href="#cb31-1012" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>some people may take a trip infrequently (for example, twice a week)</span>
<span id="cb31-1013"><a href="#cb31-1013" aria-hidden="true" tabindex="-1"></a>  so that a 0 value may be reported if the survey concerns a Tuesday</span>
<span id="cb31-1014"><a href="#cb31-1014" aria-hidden="true" tabindex="-1"></a>  as the individual has taken a trip on Monday and Thursday.</span>
<span id="cb31-1015"><a href="#cb31-1015" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-1016"><a href="#cb31-1016" aria-hidden="true" tabindex="-1"></a>This question of zero vs. positive observations is closely related to the analysis of consumption expenditures based on individual data for which the value is 0 for a large part of the sample. For example, a large share of the individuals in the sample will</span>
<span id="cb31-1017"><a href="#cb31-1017" aria-hidden="true" tabindex="-1"></a>report a null consumption of tobacco simply because they don't</span>
<span id="cb31-1018"><a href="#cb31-1018" aria-hidden="true" tabindex="-1"></a>smoke. Some other individuals will report a null consumption of fish</span>
<span id="cb31-1019"><a href="#cb31-1019" aria-hidden="true" tabindex="-1"></a>because fish is bought infrequently (once a month, for example) and the</span>
<span id="cb31-1020"><a href="#cb31-1020" aria-hidden="true" tabindex="-1"></a>length of the survey is 2 weeks. </span>
<span id="cb31-1021"><a href="#cb31-1021" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1022"><a href="#cb31-1022" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Hurdle models</span></span>
<span id="cb31-1023"><a href="#cb31-1023" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1024"><a href="#cb31-1024" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{hurdle model!count model|(}</span>
<span id="cb31-1025"><a href="#cb31-1025" aria-hidden="true" tabindex="-1"></a>For the first situation, @CRAG:71\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Cragg} proposed the hurdle model (presented in @sec-tobit2), for which</span>
<span id="cb31-1026"><a href="#cb31-1026" aria-hidden="true" tabindex="-1"></a>the level of consumption of a good is taken into account by two</span>
<span id="cb31-1027"><a href="#cb31-1027" aria-hidden="true" tabindex="-1"></a>different models:</span>
<span id="cb31-1028"><a href="#cb31-1028" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1029"><a href="#cb31-1029" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>a binomial model that explains the fact that the</span>
<span id="cb31-1030"><a href="#cb31-1030" aria-hidden="true" tabindex="-1"></a>  expenditure is zero or positive,</span>
<span id="cb31-1031"><a href="#cb31-1031" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>a model that explains the level of the expenditure if it is positive.</span>
<span id="cb31-1032"><a href="#cb31-1032" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1033"><a href="#cb31-1033" aria-hidden="true" tabindex="-1"></a>This hurdle model has been adapted to count data by @MULL:86\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Mullahy}. The first model</span>
<span id="cb31-1034"><a href="#cb31-1034" aria-hidden="true" tabindex="-1"></a>returns the probability that $y=0$. Therefore, the response is $d_n=\mathbf{1}(y_n &gt; 0)$, which takes the two values of 0 ($y_n$ is 0) and 1 ($y_n$ is strictly positive). A set of covariates $z_1$ is used for this model, with corresponding coefficients denoted by $\gamma_1$. For example, using a probit model, we would have $\mbox{P}(d_n = 1) = \Phi(\gamma_1 ^ \top z_1)$. Another choice is to use a count distribution to modelize the probability that $d_n = 0$. For example, using the Poisson distribution ($\mbox{P}(y) = e^ {-\theta}\theta ^ y / y!$) and the log link ($\theta = \exp(\gamma_1 ^ \top z_1$) we have $\mbox{P}(d_n = 0) = \exp(e ^ {-\gamma_1 ^ \top z_1})$. Therefore the first model writes:</span>
<span id="cb31-1035"><a href="#cb31-1035" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1036"><a href="#cb31-1036" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-1037"><a href="#cb31-1037" aria-hidden="true" tabindex="-1"></a>\left(\exp\left(- e^{\gamma_1 ^ \top z_{n1}}\right)\right)^{d_n}</span>
<span id="cb31-1038"><a href="#cb31-1038" aria-hidden="true" tabindex="-1"></a>\left(1 - \exp\left(-e^{\gamma_1 ^ \top z_{n1}}\right)\right) ^ {1 - d_n}</span>
<span id="cb31-1039"><a href="#cb31-1039" aria-hidden="true" tabindex="-1"></a>$$ {#eq-hurdle_part1}</span>
<span id="cb31-1040"><a href="#cb31-1040" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1041"><a href="#cb31-1041" aria-hidden="true" tabindex="-1"></a>The second model concerns the zero left-truncated sample, i.e., the subsample of individuals for which $y&gt;0$. Any count model can be used, but the probabilities returned by the chosen distribution for every positive value of $y$ should be divided by their sum, so that they sum to 1. If once again, the Poisson distribution is used, the probabilities for positive values of $y$ are:</span>
<span id="cb31-1042"><a href="#cb31-1042" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1043"><a href="#cb31-1043" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-1044"><a href="#cb31-1044" aria-hidden="true" tabindex="-1"></a>\displaystyle\frac{\exp\left(- e^{\gamma_2 ^ \top z_{n2}}\right) e^{y_n\gamma_2^\top z_{n2}} /</span>
<span id="cb31-1045"><a href="#cb31-1045" aria-hidden="true" tabindex="-1"></a>y_n !}{1 - \exp\left(- e^{\gamma_2 ^ \top z_{n2}}\right)}</span>
<span id="cb31-1046"><a href="#cb31-1046" aria-hidden="true" tabindex="-1"></a>$$ {#eq-hurdle_part2}</span>
<span id="cb31-1047"><a href="#cb31-1047" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1048"><a href="#cb31-1048" aria-hidden="true" tabindex="-1"></a>The hurdle model is a **finite mixture** obtained by combining the two</span>
<span id="cb31-1049"><a href="#cb31-1049" aria-hidden="true" tabindex="-1"></a>distributions, one that generates the zero values and the other one</span>
<span id="cb31-1050"><a href="#cb31-1050" aria-hidden="true" tabindex="-1"></a>that generates the positive values. </span>
<span id="cb31-1051"><a href="#cb31-1051" aria-hidden="true" tabindex="-1"></a>As the two components of the hurdle model depend on a specific</span>
<span id="cb31-1052"><a href="#cb31-1052" aria-hidden="true" tabindex="-1"></a>parameter's vector ($\gamma_1$ and $\gamma_2$), the estimation can be</span>
<span id="cb31-1053"><a href="#cb31-1053" aria-hidden="true" tabindex="-1"></a>performed by independently fitting the two models. The general expression for the probability of</span>
<span id="cb31-1054"><a href="#cb31-1054" aria-hidden="true" tabindex="-1"></a>one observation is the product of the two previous probabilities:</span>
<span id="cb31-1055"><a href="#cb31-1055" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1056"><a href="#cb31-1056" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-1057"><a href="#cb31-1057" aria-hidden="true" tabindex="-1"></a>\left(\exp\left(- e^{\gamma_1 ^ \top z_{n1}}\right)\right)^{1 - d_n}</span>
<span id="cb31-1058"><a href="#cb31-1058" aria-hidden="true" tabindex="-1"></a>\left(\frac{1 - \exp\left(-e^{\gamma_1 ^ \top z_{n1}}\right)}</span>
<span id="cb31-1059"><a href="#cb31-1059" aria-hidden="true" tabindex="-1"></a>{1 - \exp\left(-e^{\gamma_2 ^ \top z_{n2}}\right)}</span>
<span id="cb31-1060"><a href="#cb31-1060" aria-hidden="true" tabindex="-1"></a>\right) ^{d_n}</span>
<span id="cb31-1061"><a href="#cb31-1061" aria-hidden="true" tabindex="-1"></a>\left(\frac{\exp\left(- e^{\gamma_2 ^ \top z_{n2}}\right) e^{y_n\gamma_2^\top z_{n2}}}{y_n !}\right)^{1 - d_n}</span>
<span id="cb31-1062"><a href="#cb31-1062" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-1063"><a href="#cb31-1063" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1064"><a href="#cb31-1064" aria-hidden="true" tabindex="-1"></a>This expression illustrates the interest of using the same</span>
<span id="cb31-1065"><a href="#cb31-1065" aria-hidden="true" tabindex="-1"></a>distribution (here the Poisson distribution) for the two parts of the model. In this</span>
<span id="cb31-1066"><a href="#cb31-1066" aria-hidden="true" tabindex="-1"></a>case, if $z_1 = z_2$, i.e., if the same set of covariates is used in the two models, the hurdle model is nested in the simple count model, the null</span>
<span id="cb31-1067"><a href="#cb31-1067" aria-hidden="true" tabindex="-1"></a>hypothesis of the simple model being: $\mbox{H}_0: \gamma_1 = \gamma_2$.</span>
<span id="cb31-1068"><a href="#cb31-1068" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{hurdle model!count model|)}\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{zero inflated Poisson|(}</span>
<span id="cb31-1069"><a href="#cb31-1069" aria-hidden="true" tabindex="-1"></a>The **zero-inflated Poisson** (or **ZIP** model),^<span class="co">[</span><span class="ot">Also called with zeros model.</span><span class="co">]</span> proposed by @LAMB:92\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Lambert} starts from a count model, for example a Poisson with a set of covariates denoted by $z_2$, and corresponding coefficients $\gamma_2$. The probability of 0 ($e^{-\gamma_2^\top z_{n2}}$) is inflated using a further parameter $\psi_n$ between 0 and 1:</span>
<span id="cb31-1070"><a href="#cb31-1070" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1071"><a href="#cb31-1071" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-1072"><a href="#cb31-1072" aria-hidden="true" tabindex="-1"></a>P(Y = 0 | x_n) = \psi_n + (1 - \psi_n) e^{-\gamma_2^\top</span>
<span id="cb31-1073"><a href="#cb31-1073" aria-hidden="true" tabindex="-1"></a>z_{n2}} = e^{-\gamma_2^\top z_{n2}} + \psi_n \left(1 - e^{-\gamma_2^\top</span>
<span id="cb31-1074"><a href="#cb31-1074" aria-hidden="true" tabindex="-1"></a>z_{n2}}\right) &gt; e^{-\gamma_2^\top z_{n2}}</span>
<span id="cb31-1075"><a href="#cb31-1075" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-1076"><a href="#cb31-1076" aria-hidden="true" tabindex="-1"></a>The Poisson's probabilities for positive values of $y$ are then deflated by</span>
<span id="cb31-1077"><a href="#cb31-1077" aria-hidden="true" tabindex="-1"></a>$(1 - \psi_n)$, so that the probabilities for all the possible values of $y$ (0 and positive)</span>
<span id="cb31-1078"><a href="#cb31-1078" aria-hidden="true" tabindex="-1"></a>sums to 1:</span>
<span id="cb31-1079"><a href="#cb31-1079" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1080"><a href="#cb31-1080" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-1081"><a href="#cb31-1081" aria-hidden="true" tabindex="-1"></a>\mbox{P}(y_n | z_{n2}) = (1 - \psi_n) \frac{e^{-\mu_n}\mu_n ^y}{y!} \mbox{ for</span>
<span id="cb31-1082"><a href="#cb31-1082" aria-hidden="true" tabindex="-1"></a>} y_n &gt; 0</span>
<span id="cb31-1083"><a href="#cb31-1083" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-1084"><a href="#cb31-1084" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1085"><a href="#cb31-1085" aria-hidden="true" tabindex="-1"></a>$\phi_n$ can be a constant, or a function of covariates ($z_1$) that returns a</span>
<span id="cb31-1086"><a href="#cb31-1086" aria-hidden="true" tabindex="-1"></a>value between 0 and 1. For example, a logistic specification can be</span>
<span id="cb31-1087"><a href="#cb31-1087" aria-hidden="true" tabindex="-1"></a>used:</span>
<span id="cb31-1088"><a href="#cb31-1088" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1089"><a href="#cb31-1089" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-1090"><a href="#cb31-1090" aria-hidden="true" tabindex="-1"></a>\psi_n = \frac{e^{\gamma_1^\top z_{n1}}}{1 + e^{\gamma_1^\top z_{n1}}}</span>
<span id="cb31-1091"><a href="#cb31-1091" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-1092"><a href="#cb31-1092" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{zero inflated Poisson|)}</span>
<span id="cb31-1093"><a href="#cb31-1093" aria-hidden="true" tabindex="-1"></a>Hurdle and ZIP models are implemented in the **countreg** package.^[The **countreg** package is not on CRAN, it can be installed using <span class="in">`install.packages("countreg", repos="http://R-Forge.R-project.org")`</span>.] <span class="in">`countreg::hurdle`</span> and <span class="in">`countreg::zeroinfl`</span> both have a <span class="in">`formula`</span> and a <span class="in">`dist`</span> argument. The first is a two-part formula where the first part describes $x_1$ and the second $x_2$. If a one-part formula is provided, the same set of covariates is used for the two parts of the model. The second a character indicating the count model family (<span class="in">`"poisson"`</span> and <span class="in">`"negbin"`</span> are the most common choices). <span class="in">`countreg::hurdle`</span> has a <span class="in">`zero.dist`</span> argument which is a character indicating the distribution for the binomial part of the model (<span class="in">`"poisson"`</span>, <span class="in">`"negbin"`</span> or <span class="in">`"binomial"`</span>; in the latter case, the link can be indicated using the <span class="in">`link`</span> argument). The link used for $\psi_n$ is indicated in <span class="in">`countreg::zeroinfl`</span> by the <span class="in">`link`</span> argument. </span>
<span id="cb31-1094"><a href="#cb31-1094" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">(</span><span class="co">]</span>{trips}{micsr}</span>
<span id="cb31-1095"><a href="#cb31-1095" aria-hidden="true" tabindex="-1"></a>\idxfun{hurdle}{countreg}\idxfun{zeroinfl}{countreg}\idxfun{update}{stats}</span>
<span id="cb31-1096"><a href="#cb31-1096" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1099"><a href="#cb31-1099" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-1100"><a href="#cb31-1100" aria-hidden="true" tabindex="-1"></a>hdl_pois <span class="ot">&lt;-</span> countreg<span class="sc">::</span><span class="fu">hurdle</span>(trips <span class="sc">~</span> workschl <span class="sc">+</span> size <span class="sc">+</span> dist <span class="sc">+</span> smsa <span class="sc">+</span> </span>
<span id="cb31-1101"><a href="#cb31-1101" aria-hidden="true" tabindex="-1"></a>                               fulltime <span class="sc">+</span> distnod <span class="sc">+</span> realinc <span class="sc">+</span> weekend <span class="sc">+</span> </span>
<span id="cb31-1102"><a href="#cb31-1102" aria-hidden="true" tabindex="-1"></a>                               car, <span class="at">dist =</span> <span class="st">"poisson"</span>, </span>
<span id="cb31-1103"><a href="#cb31-1103" aria-hidden="true" tabindex="-1"></a>                             <span class="at">zero.dist =</span> <span class="st">"poisson"</span>, trips)</span>
<span id="cb31-1104"><a href="#cb31-1104" aria-hidden="true" tabindex="-1"></a>hdl_nb2 <span class="ot">&lt;-</span> <span class="fu">update</span>(hdl_pois, <span class="at">dist =</span> <span class="st">"negbin"</span>, <span class="at">zero.dist =</span> <span class="st">"negbin"</span>, trips)</span>
<span id="cb31-1105"><a href="#cb31-1105" aria-hidden="true" tabindex="-1"></a>zip_pois <span class="ot">&lt;-</span> countreg<span class="sc">::</span><span class="fu">zeroinfl</span>(trips <span class="sc">~</span> workschl <span class="sc">+</span> size <span class="sc">+</span> dist <span class="sc">+</span> smsa <span class="sc">+</span> </span>
<span id="cb31-1106"><a href="#cb31-1106" aria-hidden="true" tabindex="-1"></a>                               fulltime <span class="sc">+</span> distnod <span class="sc">+</span> realinc <span class="sc">+</span> weekend <span class="sc">+</span> </span>
<span id="cb31-1107"><a href="#cb31-1107" aria-hidden="true" tabindex="-1"></a>                               car, <span class="at">dist =</span> <span class="st">"poisson"</span>, trips)</span>
<span id="cb31-1108"><a href="#cb31-1108" aria-hidden="true" tabindex="-1"></a>zip_nb2 <span class="ot">&lt;-</span> <span class="fu">update</span>(zip_pois, <span class="at">dist =</span> <span class="st">"negbin"</span>)</span>
<span id="cb31-1109"><a href="#cb31-1109" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-1110"><a href="#cb31-1110" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb31-1111"><a href="#cb31-1111" aria-hidden="true" tabindex="-1"></a>The rootograms for the Hurdle and the ZIP models are presented in @fig-root_nb2_hurdle_zip.</span>
<span id="cb31-1112"><a href="#cb31-1112" aria-hidden="true" tabindex="-1"></a>Using the AIC criteria, we can now compare all the models estimated in this section. The AIC of the basic model is:</span>
<span id="cb31-1113"><a href="#cb31-1113" aria-hidden="true" tabindex="-1"></a>\idxfun{AIC}{stats}\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{Akaike information criteria|(}</span>
<span id="cb31-1114"><a href="#cb31-1114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1117"><a href="#cb31-1117" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-1118"><a href="#cb31-1118" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: true</span></span>
<span id="cb31-1119"><a href="#cb31-1119" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>(pois)</span>
<span id="cb31-1120"><a href="#cb31-1120" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-1121"><a href="#cb31-1121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1122"><a href="#cb31-1122" aria-hidden="true" tabindex="-1"></a>Adding either overdispersion (using a Negbin model) or an excess of 0 (using either a hurdle or a ZIP model) leads to:</span>
<span id="cb31-1123"><a href="#cb31-1123" aria-hidden="true" tabindex="-1"></a>\idxfun{AIC}{stats}</span>
<span id="cb31-1124"><a href="#cb31-1124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1127"><a href="#cb31-1127" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-1128"><a href="#cb31-1128" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: true</span></span>
<span id="cb31-1129"><a href="#cb31-1129" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>(nb2)</span>
<span id="cb31-1130"><a href="#cb31-1130" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>(hdl_pois)</span>
<span id="cb31-1131"><a href="#cb31-1131" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>(zip_pois)</span>
<span id="cb31-1132"><a href="#cb31-1132" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-1133"><a href="#cb31-1133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1134"><a href="#cb31-1134" aria-hidden="true" tabindex="-1"></a>The performance of the hurdle model is slightly better than the ZIP model. The AIC is much less than the one of the Poisson model, but much larger than the one of the Negbin2 model.</span>
<span id="cb31-1135"><a href="#cb31-1135" aria-hidden="true" tabindex="-1"></a>\idxfun{glm.nb}{MASS}\idxfun{formula}{stats}\idxfun{rootogram}{countreg}\idxfun{autoplot}{ggplot2}</span>
<span id="cb31-1136"><a href="#cb31-1136" aria-hidden="true" tabindex="-1"></a>\idxfun{coord<span class="sc">\_</span>cartesian}{ggplot2}\idxfun{ggarrange}{ggpubr}</span>
<span id="cb31-1137"><a href="#cb31-1137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1138"><a href="#cb31-1138" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb31-1139"><a href="#cb31-1139" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-root_nb2_hurdle_zip</span></span>
<span id="cb31-1140"><a href="#cb31-1140" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Rootograms for the Negbin2, Hurdle and ZIP models"</span></span>
<span id="cb31-1141"><a href="#cb31-1141" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb31-1142"><a href="#cb31-1142" aria-hidden="true" tabindex="-1"></a>nb2_mass <span class="ot">&lt;-</span> MASS<span class="sc">::</span><span class="fu">glm.nb</span>(<span class="fu">formula</span>(pois), trips)</span>
<span id="cb31-1143"><a href="#cb31-1143" aria-hidden="true" tabindex="-1"></a>fig_nb2 <span class="ot">&lt;-</span>topmodels<span class="sc">::</span><span class="fu">rootogram</span>(nb2_mass, <span class="at">plot =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-1144"><a href="#cb31-1144" aria-hidden="true" tabindex="-1"></a>    autoplot <span class="sc">+</span> <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">15</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>, <span class="dv">12</span>))</span>
<span id="cb31-1145"><a href="#cb31-1145" aria-hidden="true" tabindex="-1"></a>fig_hdl <span class="ot">&lt;-</span>topmodels<span class="sc">::</span><span class="fu">rootogram</span>(hdl_pois, <span class="at">plot =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-1146"><a href="#cb31-1146" aria-hidden="true" tabindex="-1"></a>    autoplot <span class="sc">+</span> <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">15</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>, <span class="dv">12</span>))</span>
<span id="cb31-1147"><a href="#cb31-1147" aria-hidden="true" tabindex="-1"></a>fig_zip <span class="ot">&lt;-</span>topmodels<span class="sc">::</span><span class="fu">rootogram</span>(zip_pois, <span class="at">plot =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-1148"><a href="#cb31-1148" aria-hidden="true" tabindex="-1"></a>    autoplot <span class="sc">+</span> <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">15</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>, <span class="dv">12</span>))</span>
<span id="cb31-1149"><a href="#cb31-1149" aria-hidden="true" tabindex="-1"></a>figure <span class="ot">&lt;-</span> ggpubr<span class="sc">::</span><span class="fu">ggarrange</span>(fig_nb2, fig_hdl, fig_zip,</span>
<span id="cb31-1150"><a href="#cb31-1150" aria-hidden="true" tabindex="-1"></a>                           <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Negbin2"</span>, <span class="st">"Hurdle"</span>, <span class="st">"ZIP"</span>),</span>
<span id="cb31-1151"><a href="#cb31-1151" aria-hidden="true" tabindex="-1"></a>                           <span class="at">ncol =</span> <span class="dv">3</span>, <span class="at">nrow =</span> <span class="dv">1</span>)</span>
<span id="cb31-1152"><a href="#cb31-1152" aria-hidden="true" tabindex="-1"></a>figure</span>
<span id="cb31-1153"><a href="#cb31-1153" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-1154"><a href="#cb31-1154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1155"><a href="#cb31-1155" aria-hidden="true" tabindex="-1"></a>Finally the Negbin2 hurdle or zip model can be compared either to the Negbin2 Poisson model (for which the treatment of excess of 0 is added) or to the hurdle or zip Poisson model (for which the treatment of overdispersion is added):</span>
<span id="cb31-1156"><a href="#cb31-1156" aria-hidden="true" tabindex="-1"></a>\idxfun{AIC}{stats}</span>
<span id="cb31-1157"><a href="#cb31-1157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1160"><a href="#cb31-1160" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb31-1161"><a href="#cb31-1161" aria-hidden="true" tabindex="-1"></a><span class="co">#| collapse: true</span></span>
<span id="cb31-1162"><a href="#cb31-1162" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>(hdl_nb2)</span>
<span id="cb31-1163"><a href="#cb31-1163" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>(zip_nb2)</span>
<span id="cb31-1164"><a href="#cb31-1164" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-1165"><a href="#cb31-1165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1166"><a href="#cb31-1166" aria-hidden="true" tabindex="-1"></a>The AICs of these two models are much lower than the ones of their particular cases (<span class="in">`hdl_pois`</span> and <span class="in">`nb2`</span> for the first one <span class="in">`zip_pois`</span> and <span class="in">`nb2`</span> for the second one). Therefore, the conclusion of this analysis is that either the  ZIP or the hurdle Negbin model should be favored. The rootograms for these two models are presented on @fig-root_exc0_nb.</span>
<span id="cb31-1167"><a href="#cb31-1167" aria-hidden="true" tabindex="-1"></a>\idxfun{rootogram}{countreg}\idxfun{autoplot}{ggplot2}\idxfun{coord<span class="sc">\_</span>cartesian}{ggplot2}\idxfun{ggarrange}{ggpubr}</span>
<span id="cb31-1168"><a href="#cb31-1168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1169"><a href="#cb31-1169" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb31-1170"><a href="#cb31-1170" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Rootograms for the Negbin Hurdle and ZIP models"</span></span>
<span id="cb31-1171"><a href="#cb31-1171" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-root_exc0_nb</span></span>
<span id="cb31-1172"><a href="#cb31-1172" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb31-1173"><a href="#cb31-1173" aria-hidden="true" tabindex="-1"></a>fig_hdl <span class="ot">&lt;-</span>topmodels<span class="sc">::</span><span class="fu">rootogram</span>(hdl_nb2, <span class="at">plot =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-1174"><a href="#cb31-1174" aria-hidden="true" tabindex="-1"></a>    autoplot <span class="sc">+</span> <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">15</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>, <span class="dv">12</span>))</span>
<span id="cb31-1175"><a href="#cb31-1175" aria-hidden="true" tabindex="-1"></a>fig_zip <span class="ot">&lt;-</span>topmodels<span class="sc">::</span><span class="fu">rootogram</span>(zip_nb2, <span class="at">plot =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-1176"><a href="#cb31-1176" aria-hidden="true" tabindex="-1"></a>    autoplot <span class="sc">+</span> <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">15</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>, <span class="dv">12</span>))</span>
<span id="cb31-1177"><a href="#cb31-1177" aria-hidden="true" tabindex="-1"></a>figure <span class="ot">&lt;-</span> ggpubr<span class="sc">::</span><span class="fu">ggarrange</span>(fig_hdl, fig_zip,</span>
<span id="cb31-1178"><a href="#cb31-1178" aria-hidden="true" tabindex="-1"></a>                           <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Hurdle"</span>, <span class="st">"ZIP"</span>),</span>
<span id="cb31-1179"><a href="#cb31-1179" aria-hidden="true" tabindex="-1"></a>                           <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">nrow =</span> <span class="dv">1</span>)</span>
<span id="cb31-1180"><a href="#cb31-1180" aria-hidden="true" tabindex="-1"></a>figure</span>
<span id="cb31-1181"><a href="#cb31-1181" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-1182"><a href="#cb31-1182" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{Akaike information criteria|)}</span>
<span id="cb31-1183"><a href="#cb31-1183" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">)</span><span class="co">]</span>{trips}{micsr}</span>
<span id="cb31-1184"><a href="#cb31-1184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1185"><a href="#cb31-1185" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ## Panel data --&gt;</span></span>
<span id="cb31-1186"><a href="#cb31-1186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1187"><a href="#cb31-1187" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- </span><span class="al">###</span><span class="co"> Fixed effects model --&gt;</span></span>
<span id="cb31-1188"><a href="#cb31-1188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1189"><a href="#cb31-1189" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Fixed effects Poisson and NegBin models are proposed by @HAUS:HALL:GRIL:84 . --&gt;</span></span>
<span id="cb31-1190"><a href="#cb31-1190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1191"><a href="#cb31-1191" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #### Poisson model --&gt;</span></span>
<span id="cb31-1192"><a href="#cb31-1192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1193"><a href="#cb31-1193" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- The fixed effects Poisson model is very specific as it doesn't suffer --&gt;</span></span>
<span id="cb31-1194"><a href="#cb31-1194" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- from the incidental parameter problem and can therefore be obtained --&gt;</span></span>
<span id="cb31-1195"><a href="#cb31-1195" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- either by estimating the individual effects or by using a sufficient --&gt;</span></span>
<span id="cb31-1196"><a href="#cb31-1196" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- statistic^[[see chap. 9 @CAME:TRIV:13].]. --&gt;</span></span>
<span id="cb31-1197"><a href="#cb31-1197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1198"><a href="#cb31-1198" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- In a panel context, the Poisson parameter for individual $\n$ in --&gt;</span></span>
<span id="cb31-1199"><a href="#cb31-1199" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- period $\t$ is written: --&gt;</span></span>
<span id="cb31-1200"><a href="#cb31-1200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1201"><a href="#cb31-1201" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb31-1202"><a href="#cb31-1202" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \poispar_{\n \t}=\id_\n\poiscov_{\n \t}=\id_\n e^{\coef^\top \x_{\n \t}} --&gt;</span></span>
<span id="cb31-1203"><a href="#cb31-1203" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb31-1204"><a href="#cb31-1204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1205"><a href="#cb31-1205" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- which means that the individual effect is multiplicative. For a given --&gt;</span></span>
<span id="cb31-1206"><a href="#cb31-1206" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- value of the individual effect, the probability of observing --&gt;</span></span>
<span id="cb31-1207"><a href="#cb31-1207" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $\y_{\n \t}$ is: --&gt;</span></span>
<span id="cb31-1208"><a href="#cb31-1208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1209"><a href="#cb31-1209" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb31-1210"><a href="#cb31-1210" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \PR(\y_{\n \t} \mid x_{\n \t},\id_\n,\beta)= --&gt;</span></span>
<span id="cb31-1211"><a href="#cb31-1211" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \frac{e^{-\poispar_{\n \t}}\poispar_{\n \t}^{\y_{\n \t</span><span class="re">}}}</span><span class="co">{\y_{\n \t}!}  = --&gt;</span></span>
<span id="cb31-1212"><a href="#cb31-1212" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \frac{e^{-\id_\n\poiscov_{\n \t}}(\id_\n\poiscov_{\n \t})^{\y_{\n \t</span><span class="re">}}}</span><span class="co">{\y_{\n \t}!} --&gt;</span></span>
<span id="cb31-1213"><a href="#cb31-1213" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb31-1214"><a href="#cb31-1214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1215"><a href="#cb31-1215" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Let $\sumy_\n=\sum_{\t=1}^\T \y_{\n \t}$ be the sum of all the values of --&gt;</span></span>
<span id="cb31-1216"><a href="#cb31-1216" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   the response for individual $\n$ and --&gt;</span></span>
<span id="cb31-1217"><a href="#cb31-1217" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   $\sumpois_\n=\sum_{\t=1}^\T \poiscov_{\n \t}$ the sum of the Poisson --&gt;</span></span>
<span id="cb31-1218"><a href="#cb31-1218" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   parameters. A sum of Poisson variables follows a Poisson --&gt;</span></span>
<span id="cb31-1219"><a href="#cb31-1219" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   distribution with parameter equal to the sum of the parameters of --&gt;</span></span>
<span id="cb31-1220"><a href="#cb31-1220" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   the summed variables. We therefore have: --&gt;</span></span>
<span id="cb31-1221"><a href="#cb31-1221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1222"><a href="#cb31-1222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1223"><a href="#cb31-1223" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb31-1224"><a href="#cb31-1224" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \PR(\sumy_\n \mid x_\n,\id_\n,\beta)= --&gt;</span></span>
<span id="cb31-1225"><a href="#cb31-1225" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \frac{e^{-\id_\n\sumpois_\n}(\id_\n \sumpois_\n)^{\sumy_\n}}{\sumy_\n!} --&gt;</span></span>
<span id="cb31-1226"><a href="#cb31-1226" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ {#eq-sumy} --&gt;</span></span>
<span id="cb31-1227"><a href="#cb31-1227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1228"><a href="#cb31-1228" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   Let $\y_\n=(\y_{i1},\y_{i2},\ldots,\y_{\n \t})$ be the vector of values --&gt;</span></span>
<span id="cb31-1229"><a href="#cb31-1229" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   of $\y$ for individual $\n$. We then have: --&gt;</span></span>
<span id="cb31-1230"><a href="#cb31-1230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1231"><a href="#cb31-1231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1232"><a href="#cb31-1232" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb31-1233"><a href="#cb31-1233" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \PR(\y_\n \mid x_\n,\id_\n,\beta) = --&gt;</span></span>
<span id="cb31-1234"><a href="#cb31-1234" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \frac{e^{-\id_\n\sum_{\t=1}^\T\poiscov_{\n \t}}\prod_{\t=1}^\T(\id_\n\poiscov_{\n \t})^{\y_{\n \t</span><span class="re">}}}</span><span class="co">{\prod_{\t=1}^\T \y_{\n \t}!} --&gt;</span></span>
<span id="cb31-1235"><a href="#cb31-1235" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- = --&gt;</span></span>
<span id="cb31-1236"><a href="#cb31-1236" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \frac{e^{-\id_\n\sumpois_{i}}\id_\n^{\sumy_\n}\prod_{\t=1}^\T\poiscov_{\n \t}^{\y_{\n \t</span><span class="re">}}}</span><span class="co">{\prod_{\t=1}^\T \y_{\n \t}!} --&gt;</span></span>
<span id="cb31-1237"><a href="#cb31-1237" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ {#eq-vecty} --&gt;</span></span>
<span id="cb31-1238"><a href="#cb31-1238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1239"><a href="#cb31-1239" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Applying Bayes' theorem, we obtain: --&gt;</span></span>
<span id="cb31-1240"><a href="#cb31-1240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1241"><a href="#cb31-1241" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb31-1242"><a href="#cb31-1242" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \PR(\y_\n\mid x_\n, \id_\n, \beta)=\PR(\y_\n\mid x_\n, --&gt;</span></span>
<span id="cb31-1243"><a href="#cb31-1243" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \id_\n,\beta, \sumy_\n)\PR(\sumy_\n\mid x_\n, \id_\n, \beta) --&gt;</span></span>
<span id="cb31-1244"><a href="#cb31-1244" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb31-1245"><a href="#cb31-1245" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   i.e., the joint probability of the components of $\y_\n$ is --&gt;</span></span>
<span id="cb31-1246"><a href="#cb31-1246" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   the product of the conditional probability of $\y_\n$ given $\sumy_\n$ --&gt;</span></span>
<span id="cb31-1247"><a href="#cb31-1247" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   and the marginal distribution of $\sumy_\n$. This conditional --&gt;</span></span>
<span id="cb31-1248"><a href="#cb31-1248" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   probability is: --&gt;</span></span>
<span id="cb31-1249"><a href="#cb31-1249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1250"><a href="#cb31-1250" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb31-1251"><a href="#cb31-1251" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \PR(\y_\n\mid x_\n, \id_\n, \beta, \sumy_\n) --&gt;</span></span>
<span id="cb31-1252"><a href="#cb31-1252" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- =\frac{\PR(\y_\n\mid x_\n,\id_\n,\beta)} --&gt;</span></span>
<span id="cb31-1253"><a href="#cb31-1253" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- {\PR(\sumy_\n\mid x_\n,\id_\n,\beta)} --&gt;</span></span>
<span id="cb31-1254"><a href="#cb31-1254" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb31-1255"><a href="#cb31-1255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1256"><a href="#cb31-1256" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- which implies: --&gt;</span></span>
<span id="cb31-1257"><a href="#cb31-1257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1258"><a href="#cb31-1258" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb31-1259"><a href="#cb31-1259" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \PR(\y_\n\mid x_\n,\beta,\sumy_\n)= --&gt;</span></span>
<span id="cb31-1260"><a href="#cb31-1260" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \frac{\sumy_\n!}{\sumpois_\n^{\sumy_\n}}\prod_{\t=1}^\T\frac{\poiscov_{\n \t}^{\y_{\n \t</span><span class="re">}}}</span><span class="co">{\y_{\n \t}!} --&gt;</span></span>
<span id="cb31-1261"><a href="#cb31-1261" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ {#eq-pwith} --&gt;</span></span>
<span id="cb31-1262"><a href="#cb31-1262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1263"><a href="#cb31-1263" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   As for the logit model, $\sumy_\n$ is a sufficient statistic, which --&gt;</span></span>
<span id="cb31-1264"><a href="#cb31-1264" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   means that it allows to get rid of the individual effects. Taking --&gt;</span></span>
<span id="cb31-1265"><a href="#cb31-1265" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   the logarithm of this expression and summing over all individuals, --&gt;</span></span>
<span id="cb31-1266"><a href="#cb31-1266" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   we obtain the within Poisson model: --&gt;</span></span>
<span id="cb31-1267"><a href="#cb31-1267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1268"><a href="#cb31-1268" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb31-1269"><a href="#cb31-1269" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \ln L (\y \mid x, \beta, \sumy)= --&gt;</span></span>
<span id="cb31-1270"><a href="#cb31-1270" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \sum_{\n=1}^\N\left(\ln \sumy_\n! - \sumy_\n \ln\sum_{\t=1}^\T\poiscov_{\n \t}+\sum_{\t=1}^\T\left(\y_{\n \t}\ln \poiscov_{\n \t}-\ln \y_{\n \t}!\right)\right) --&gt;</span></span>
<span id="cb31-1271"><a href="#cb31-1271" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ {#eq-loglwa} --&gt;</span></span>
<span id="cb31-1272"><a href="#cb31-1272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1273"><a href="#cb31-1273" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--  or: --&gt;</span></span>
<span id="cb31-1274"><a href="#cb31-1274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1275"><a href="#cb31-1275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1276"><a href="#cb31-1276" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb31-1277"><a href="#cb31-1277" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \begin{array}{rcl} --&gt;</span></span>
<span id="cb31-1278"><a href="#cb31-1278" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   \ln L (\y \mid x, \beta, \sumy)&amp;=&amp; --&gt;</span></span>
<span id="cb31-1279"><a href="#cb31-1279" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--                                 \sum_{\n=1}^\N\left(\ln \sumy_\n! - \sum_{\t=1}^\T \ln \y_{\n \t}! + \sum_{\t=1}^\T \y_{\n \t} \ln\frac{\poiscov_{\n \t}}{\sum_{\t=1}^\T\poiscov_{\n \t}}\right) \\ --&gt;</span></span>
<span id="cb31-1280"><a href="#cb31-1280" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--                             &amp;\propto&amp; \sum_{\n=1}^\N\left(\sum_{\t=1}^\T \y_{\n \t} \ln\frac{\poiscov_{\n \t}}{\sum_{\t=1}^\T\poiscov_{\n \t}}\right) --&gt;</span></span>
<span id="cb31-1281"><a href="#cb31-1281" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \end{array} --&gt;</span></span>
<span id="cb31-1282"><a href="#cb31-1282" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ {#eq-loglw} --&gt;</span></span>
<span id="cb31-1283"><a href="#cb31-1283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1284"><a href="#cb31-1284" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- As stated previously, the Poisson model is not affected by the --&gt;</span></span>
<span id="cb31-1285"><a href="#cb31-1285" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   incidental parameter problem, as the same estimator may be obtained --&gt;</span></span>
<span id="cb31-1286"><a href="#cb31-1286" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   by estimating the individual effects. To show this result, we --&gt;</span></span>
<span id="cb31-1287"><a href="#cb31-1287" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   take the logarithm of the joint probability for the $\T$ --&gt;</span></span>
<span id="cb31-1288"><a href="#cb31-1288" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   observations of $\y$ for individual $\n$ (@eq-vecty), --&gt;</span></span>
<span id="cb31-1289"><a href="#cb31-1289" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   in order to obtain the log likelihood function: --&gt;</span></span>
<span id="cb31-1290"><a href="#cb31-1290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1291"><a href="#cb31-1291" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb31-1292"><a href="#cb31-1292" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \ln \PR(\y_\n \mid x_\n,\id_\n,\beta) =-\id_\n\sum_t\poiscov_{\n \t} --&gt;</span></span>
<span id="cb31-1293"><a href="#cb31-1293" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- + \sum_t\y_{\n \t}\ln(\id_\n\poiscov_{\n \t}) -\sum_t\ln \y_{\n \t}! --&gt;</span></span>
<span id="cb31-1294"><a href="#cb31-1294" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ {#eq-lvecty} --&gt;</span></span>
<span id="cb31-1295"><a href="#cb31-1295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1296"><a href="#cb31-1296" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   The first order condition for $\id_\n$ to maximise the log --&gt;</span></span>
<span id="cb31-1297"><a href="#cb31-1297" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   likelihood function is: --&gt;</span></span>
<span id="cb31-1298"><a href="#cb31-1298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1299"><a href="#cb31-1299" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb31-1300"><a href="#cb31-1300" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \frac{\partial \ln \PR_\n}{\partial \id_\n} = --&gt;</span></span>
<span id="cb31-1301"><a href="#cb31-1301" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- -\sum_t\poiscov_{\n \t}+\frac{1}{\id_\n}\sum_t\y_{\n \t} = 0 --&gt;</span></span>
<span id="cb31-1302"><a href="#cb31-1302" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb31-1303"><a href="#cb31-1303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1304"><a href="#cb31-1304" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   which implies that: $\id_\n=\frac{\sum_t \y_{\n \t}}{\sum_t \poiscov_{\n \t}}$. --&gt;</span></span>
<span id="cb31-1305"><a href="#cb31-1305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1306"><a href="#cb31-1306" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   Introducing this expression in (@eq-lvecty) and summing over all --&gt;</span></span>
<span id="cb31-1307"><a href="#cb31-1307" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   $\n$, we obtain the concentrated log-likelihood function: --&gt;</span></span>
<span id="cb31-1308"><a href="#cb31-1308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1309"><a href="#cb31-1309" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb31-1310"><a href="#cb31-1310" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \begin{array}{rcl} --&gt;</span></span>
<span id="cb31-1311"><a href="#cb31-1311" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \ln L_{\mbox{conc}}(\y \mid x,\beta) &amp;=&amp;\sum_\n\left(-\sumy_\n + \sumy_\n\ln \sumy_\n +\sum_t \y_{\n \t}\frac{\poiscov_{\n \t}}{\sum_t \poiscov_{\n \t}} - \sum_t \ln \y_{\n \t}!\right) \\ --&gt;</span></span>
<span id="cb31-1312"><a href="#cb31-1312" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- &amp;\propto&amp; \sum_{\n=1}^\N\left(\sum_{\t=1}^\T \y_{\n \t} \ln\frac{\poiscov_{\n \t}}{\sum_{\t=1}^\T\poiscov_{\n \t}}\right) --&gt;</span></span>
<span id="cb31-1313"><a href="#cb31-1313" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \end{array} --&gt;</span></span>
<span id="cb31-1314"><a href="#cb31-1314" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ {#eq-llconc} --&gt;</span></span>
<span id="cb31-1315"><a href="#cb31-1315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1316"><a href="#cb31-1316" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   The two log-likelihood functions @eq-loglw} and --&gt;</span></span>
<span id="cb31-1317"><a href="#cb31-1317" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   @eq-llconc are proportional, they therefore lead to the same --&gt;</span></span>
<span id="cb31-1318"><a href="#cb31-1318" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   estimators of $\beta$. Moreover, if a logarithmic link is chosen, we --&gt;</span></span>
<span id="cb31-1319"><a href="#cb31-1319" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   have: $\poiscov_{\n \t}=e^{\coef^\top \x}$. The likelihood is in --&gt;</span></span>
<span id="cb31-1320"><a href="#cb31-1320" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   this case proportional to: --&gt;</span></span>
<span id="cb31-1321"><a href="#cb31-1321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1322"><a href="#cb31-1322" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb31-1323"><a href="#cb31-1323" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \Pi_{\n=1}^\N\Pi_{\t=1}^\T\left(\frac{e^{\coef^\top \x_{\n \t</span><span class="re">}}}</span><span class="co">{\sum_\t --&gt;</span></span>
<span id="cb31-1324"><a href="#cb31-1324" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     e^{\coef^\top \x_{\n \t</span><span class="re">}}}</span><span class="co">\right)^{\y_{\n \t}} --&gt;</span></span>
<span id="cb31-1325"><a href="#cb31-1325" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb31-1326"><a href="#cb31-1326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1327"><a href="#cb31-1327" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   which is similar to the likelihood of a multinomial logit --&gt;</span></span>
<span id="cb31-1328"><a href="#cb31-1328" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   model for which $\N$ individuals --&gt;</span></span>
<span id="cb31-1329"><a href="#cb31-1329" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   must choose one among $L$ exclusive alternatives. The difference is --&gt;</span></span>
<span id="cb31-1330"><a href="#cb31-1330" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   that in this latter model $\y_{\n \t}$ is either equal to 0 or to 1 --&gt;</span></span>
<span id="cb31-1331"><a href="#cb31-1331" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   and $\sum_{\t} \y_{\n \t}=1$, as in our context each $\y_{\n \t}$ is a --&gt;</span></span>
<span id="cb31-1332"><a href="#cb31-1332" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   natural integer. --&gt;</span></span>
<span id="cb31-1333"><a href="#cb31-1333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1334"><a href="#cb31-1334" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #### Negbin models --&gt;</span></span>
<span id="cb31-1335"><a href="#cb31-1335" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   @HAUS:HALL:GRIL:84 also propose a fixed effects NegBin --&gt;</span></span>
<span id="cb31-1336"><a href="#cb31-1336" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   model. We just present below without demonstration the joint --&gt;</span></span>
<span id="cb31-1337"><a href="#cb31-1337" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   probability for individual $\n$: --&gt;</span></span>
<span id="cb31-1338"><a href="#cb31-1338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1339"><a href="#cb31-1339" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb31-1340"><a href="#cb31-1340" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \PR(\y_\n\mid x_\n, \beta, \sumy_\n) =  --&gt;</span></span>
<span id="cb31-1341"><a href="#cb31-1341" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \left(\prod_{\t=1}^\T\frac{\Gamma(\poiscov_{\n \t}+\y_{\n \t})}{\Gamma(\poiscov_{\n \t})\Gamma(\y_{\n \t}+1)}\right) --&gt;</span></span>
<span id="cb31-1342"><a href="#cb31-1342" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \frac{\Gamma(\sumpois_\n)\Gamma(\sumy_\n+1)}{\Gamma(\sumpois_\n+\sumy_\n)} --&gt;</span></span>
<span id="cb31-1343"><a href="#cb31-1343" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ {#eq-pnbwith} --&gt;</span></span>
<span id="cb31-1344"><a href="#cb31-1344" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \end{equation} --&gt;</span></span>
<span id="cb31-1345"><a href="#cb31-1345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1346"><a href="#cb31-1346" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- </span><span class="al">###</span><span class="co"> Random effects models --&gt;</span></span>
<span id="cb31-1347"><a href="#cb31-1347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1348"><a href="#cb31-1348" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #### Poisson models --&gt;</span></span>
<span id="cb31-1349"><a href="#cb31-1349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1350"><a href="#cb31-1350" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   @HAUS:HALL:GRIL:84 also proposed a \emph{between} and a random --&gt;</span></span>
<span id="cb31-1351"><a href="#cb31-1351" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   effects Poisson model, integrating out the relevant probabilities --&gt;</span></span>
<span id="cb31-1352"><a href="#cb31-1352" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   (@eq-sumy and @eq-vecty respectively). A gamma distribution --&gt;</span></span>
<span id="cb31-1353"><a href="#cb31-1353" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   hypothesis is made for the individual effects, with the following --&gt;</span></span>
<span id="cb31-1354"><a href="#cb31-1354" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   density: --&gt;</span></span>
<span id="cb31-1355"><a href="#cb31-1355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1356"><a href="#cb31-1356" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb31-1357"><a href="#cb31-1357" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- f(x,a,b)=\frac{a^b}{\Gamma(b)}e^{-ax}x^{b-1} --&gt;</span></span>
<span id="cb31-1358"><a href="#cb31-1358" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb31-1359"><a href="#cb31-1359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1360"><a href="#cb31-1360" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- with: --&gt;</span></span>
<span id="cb31-1361"><a href="#cb31-1361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1362"><a href="#cb31-1362" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb31-1363"><a href="#cb31-1363" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \Gamma(z)=\int_0^{+\infty}t^{z-1}e^{-t}dt --&gt;</span></span>
<span id="cb31-1364"><a href="#cb31-1364" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb31-1365"><a href="#cb31-1365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1366"><a href="#cb31-1366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1367"><a href="#cb31-1367" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   the gamma function. The expected value and the variance of $x$ are --&gt;</span></span>
<span id="cb31-1368"><a href="#cb31-1368" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   respectively: --&gt;</span></span>
<span id="cb31-1369"><a href="#cb31-1369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1370"><a href="#cb31-1370" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$\EV(x)=\frac{b}{a} \mbox{ and }  \mbox{V}(x)=\frac{b}{a^2}$$ --&gt;</span></span>
<span id="cb31-1371"><a href="#cb31-1371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1372"><a href="#cb31-1372" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   If the model contains an intercept, the expected value is not --&gt;</span></span>
<span id="cb31-1373"><a href="#cb31-1373" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   identified and we can then suppose, whithout restriction, that it is --&gt;</span></span>
<span id="cb31-1374"><a href="#cb31-1374" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   equal to 1, which implies $a=b$. We then obtain a gamma distribution --&gt;</span></span>
<span id="cb31-1375"><a href="#cb31-1375" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   with one parameter (denoted $\gampar$): --&gt;</span></span>
<span id="cb31-1376"><a href="#cb31-1376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1377"><a href="#cb31-1377" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb31-1378"><a href="#cb31-1378" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- f(\poisint)=\frac{\gampar^\gampar}{\Gamma(\gampar)}e^{-\gampar --&gt;</span></span>
<span id="cb31-1379"><a href="#cb31-1379" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   \poisint}\poisint^{\gampar-1} --&gt;</span></span>
<span id="cb31-1380"><a href="#cb31-1380" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb31-1381"><a href="#cb31-1381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1382"><a href="#cb31-1382" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Integrating out the conditional probabilities (@eq-sumy and --&gt;</span></span>
<span id="cb31-1383"><a href="#cb31-1383" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   @eq-vecty}), we obtain the unconditional probabilities for the --&gt;</span></span>
<span id="cb31-1384"><a href="#cb31-1384" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   between and the random effects models: --&gt;</span></span>
<span id="cb31-1385"><a href="#cb31-1385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1386"><a href="#cb31-1386" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb31-1387"><a href="#cb31-1387" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \PR(\sumy_\n\mid \xp_\n, \beta) =  --&gt;</span></span>
<span id="cb31-1388"><a href="#cb31-1388" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \int_0^{+\infty}\PR(\sumy_\n,\xp_\n,\poisint,\coefp)f(\poisint)d\poisint --&gt;</span></span>
<span id="cb31-1389"><a href="#cb31-1389" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- =\frac{{\sumpois_\n}^{\sumy_\n}}{\sumy_\n!}\frac{\gampar^\gampar}{\Gamma(\gampar)} --&gt;</span></span>
<span id="cb31-1390"><a href="#cb31-1390" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \frac{\Gamma(\sumy_\n+\gampar)}{(\sumpois_\n+\gampar)^{\sumy_\n+\gampar}} --&gt;</span></span>
<span id="cb31-1391"><a href="#cb31-1391" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb31-1392"><a href="#cb31-1392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1393"><a href="#cb31-1393" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb31-1394"><a href="#cb31-1394" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \PR(\y_\n,\x_\n,\coef)= --&gt;</span></span>
<span id="cb31-1395"><a href="#cb31-1395" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \int_0^{+\infty}\PR(\y_\n,x_\n,\poisint,\beta)f(\poisint)d\poisint --&gt;</span></span>
<span id="cb31-1396"><a href="#cb31-1396" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- =\prod_{\t=1}^\T\frac{\poiscov_{\n \t}^{\y_{\n \t</span><span class="re">}}}</span><span class="co">{\y_{\n \t}!} --&gt;</span></span>
<span id="cb31-1397"><a href="#cb31-1397" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \frac{\gampar^\gampar}{\Gamma(\gampar)} --&gt;</span></span>
<span id="cb31-1398"><a href="#cb31-1398" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \frac{\Gamma(\sumy_\n+\gampar)}{(\sumpois_\n+\gampar)^{\sumy_\n+\gampar}} --&gt;</span></span>
<span id="cb31-1399"><a href="#cb31-1399" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb31-1400"><a href="#cb31-1400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1401"><a href="#cb31-1401" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   which leads to the following log likelihood functions: --&gt;</span></span>
<span id="cb31-1402"><a href="#cb31-1402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1403"><a href="#cb31-1403" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb31-1404"><a href="#cb31-1404" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \begin{array}{rcl} --&gt;</span></span>
<span id="cb31-1405"><a href="#cb31-1405" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \ln L (\sumy \mid \xp, \coefp)&amp;=&amp; --&gt;</span></span>
<span id="cb31-1406"><a href="#cb31-1406" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \sum_{\n=1}^\N\left[\sumy_\n\ln \sum_t \poiscov_{\n \t} - \ln \sumy_\n! +\gampar \ln \gampar\right. \\ --&gt;</span></span>
<span id="cb31-1407"><a href="#cb31-1407" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- &amp;-&amp; \ln \Gamma(\gampar)+\ln \Gamma(\sumy_\n+\gampar)\\ --&gt;</span></span>
<span id="cb31-1408"><a href="#cb31-1408" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- &amp;-&amp;\left. (\sumy_\n+\gampar)\ln \left(\sum_{\t=1}^\T\poiscov_{\n \t}+\gampar\right)\right] --&gt;</span></span>
<span id="cb31-1409"><a href="#cb31-1409" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \end{array} --&gt;</span></span>
<span id="cb31-1410"><a href="#cb31-1410" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ {#eq-loglb} --&gt;</span></span>
<span id="cb31-1411"><a href="#cb31-1411" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \end{equation} --&gt;</span></span>
<span id="cb31-1412"><a href="#cb31-1412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1413"><a href="#cb31-1413" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb31-1414"><a href="#cb31-1414" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \begin{array}{rcl} --&gt;</span></span>
<span id="cb31-1415"><a href="#cb31-1415" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   \ln L (\y \mid \xp, \coefp)&amp;=&amp; --&gt;</span></span>
<span id="cb31-1416"><a href="#cb31-1416" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   \sum_{\n=1}^\N\left[\sum_t\left(\y_{\n \t}\ln \poiscov_{\n \t} - \ln \y_{\n \t}!\right) +\gampar \ln \gampar\right. \\ --&gt;</span></span>
<span id="cb31-1417"><a href="#cb31-1417" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   &amp;-&amp; \ln \Gamma(\gampar)+\ln \Gamma(\sumy_\n+\gampar) \\ --&gt;</span></span>
<span id="cb31-1418"><a href="#cb31-1418" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--    &amp; -&amp; \left.(\sumy_\n+\gampar)\ln \left(\sum_{\t=1}^\T\poiscov_{\n \t}+\gampar\right)\right] --&gt;</span></span>
<span id="cb31-1419"><a href="#cb31-1419" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \end{array} --&gt;</span></span>
<span id="cb31-1420"><a href="#cb31-1420" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ {#eq-loglr} --&gt;</span></span>
<span id="cb31-1421"><a href="#cb31-1421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1422"><a href="#cb31-1422" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #### Negbin models --&gt;</span></span>
<span id="cb31-1423"><a href="#cb31-1423" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   In addition to the Poisson, @HAUS:HALL:GRIL:84 also proposed --&gt;</span></span>
<span id="cb31-1424"><a href="#cb31-1424" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   \emph{between} and random effects NegBin models. We just present --&gt;</span></span>
<span id="cb31-1425"><a href="#cb31-1425" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   below without demonstration the joint probability for individual --&gt;</span></span>
<span id="cb31-1426"><a href="#cb31-1426" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   $\n$. --&gt;</span></span>
<span id="cb31-1427"><a href="#cb31-1427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1428"><a href="#cb31-1428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1429"><a href="#cb31-1429" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb31-1430"><a href="#cb31-1430" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \PR(\sumy_\n\mid \x_\n, \coefp)= --&gt;</span></span>
<span id="cb31-1431"><a href="#cb31-1431" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \frac{\Gamma(\sumpois_\n+\sumy_\n)}{\Gamma(\sumpois_\n)\Gamma(\sumy_\n+1)} --&gt;</span></span>
<span id="cb31-1432"><a href="#cb31-1432" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \frac{\Gamma(a+b)\Gamma(a+\sumpois_\n)\Gamma(b+\sumy_\n)} --&gt;</span></span>
<span id="cb31-1433"><a href="#cb31-1433" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- {\Gamma(a)\Gamma(b)\Gamma(a+b+\sumpois_\n+\sumy_\n)} --&gt;</span></span>
<span id="cb31-1434"><a href="#cb31-1434" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ {#eq-pnbbet} --&gt;</span></span>
<span id="cb31-1435"><a href="#cb31-1435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1436"><a href="#cb31-1436" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ --&gt;</span></span>
<span id="cb31-1437"><a href="#cb31-1437" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \PR(\y_\n,\x_\n,\coefp)= --&gt;</span></span>
<span id="cb31-1438"><a href="#cb31-1438" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \frac{\Gamma(a+b)\Gamma(a+\sumpois_\n)\Gamma(b+\sumy_\n)} --&gt;</span></span>
<span id="cb31-1439"><a href="#cb31-1439" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- {\Gamma(a)\Gamma(b)\Gamma(a+b+\sumpois_\n+\sumy_\n)} --&gt;</span></span>
<span id="cb31-1440"><a href="#cb31-1440" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- \left(\prod_{\t=1}^\T\frac{\Gamma(\poiscov_{\n \t}+\y_{\n \t})}{\Gamma(\poiscov_{\n \t})+\Gamma(\y_{\n \t}+1)}\right) --&gt;</span></span>
<span id="cb31-1441"><a href="#cb31-1441" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- $$ {#eq-pnbre} --&gt;</span></span>
<span id="cb31-1442"><a href="#cb31-1442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1443"><a href="#cb31-1443" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ```{r } --&gt;</span></span>
<span id="cb31-1444"><a href="#cb31-1444" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #| eval: true --&gt;</span></span>
<span id="cb31-1445"><a href="#cb31-1445" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #| cache: true --&gt;</span></span>
<span id="cb31-1446"><a href="#cb31-1446" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #| echo: false --&gt;</span></span>
<span id="cb31-1447"><a href="#cb31-1447" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- form &lt;- doctorco ~ sex + age + I(age ^ 2) + income + insurance + illness + actdays + hscore + chcond --&gt;</span></span>
<span id="cb31-1448"><a href="#cb31-1448" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ols &lt;- lm(form, doctor_aus) --&gt;</span></span>
<span id="cb31-1449"><a href="#cb31-1449" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- pois &lt;- glm(form, doctor_aus, family = poisson) --&gt;</span></span>
<span id="cb31-1450"><a href="#cb31-1450" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- qpois &lt;- glm(form, doctor_aus, family = quasipoisson) --&gt;</span></span>
<span id="cb31-1451"><a href="#cb31-1451" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- nb1 &lt;- MASS::glm.nb(form, doctor_aus) --&gt;</span></span>
<span id="cb31-1452"><a href="#cb31-1452" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- modelsummary::msummary(list(ols = ols, poisson =  pois, quasipois = qpois, "Negbin 2" = nb1), estimate = "{estimate} ({std.error})", statistic = NULL) --&gt;</span></span>
<span id="cb31-1453"><a href="#cb31-1453" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ``` --&gt;</span></span>
<span id="cb31-1454"><a href="#cb31-1454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1455"><a href="#cb31-1455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1456"><a href="#cb31-1456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1457"><a href="#cb31-1457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1458"><a href="#cb31-1458" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ```{r } --&gt;</span></span>
<span id="cb31-1459"><a href="#cb31-1459" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #| eval: false --&gt;</span></span>
<span id="cb31-1460"><a href="#cb31-1460" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #| echo: false --&gt;</span></span>
<span id="cb31-1461"><a href="#cb31-1461" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- mdel &lt;- p_majordrg --&gt;</span></span>
<span id="cb31-1462"><a href="#cb31-1462" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- tb &lt;- tibble(y = model.response(model.frame(mdel)), --&gt;</span></span>
<span id="cb31-1463"><a href="#cb31-1463" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--              mu = fitted(mdel), --&gt;</span></span>
<span id="cb31-1464"><a href="#cb31-1464" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--              e2 = (y - mu) ^ 2, --&gt;</span></span>
<span id="cb31-1465"><a href="#cb31-1465" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--              z = ( e2 - y) / mu) --&gt;</span></span>
<span id="cb31-1466"><a href="#cb31-1466" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- nb1 &lt;- lm(e2 ~ mu - 1, tb) --&gt;</span></span>
<span id="cb31-1467"><a href="#cb31-1467" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- nb2 &lt;- lm(e2 ~ mu + I(mu  ^2) - 1, tb) --&gt;</span></span>
<span id="cb31-1468"><a href="#cb31-1468" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ggplot(tb, aes(mu, e2)) + geom_point() + --&gt;</span></span>
<span id="cb31-1469"><a href="#cb31-1469" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #   scale_y_continuous(limits = c(0, 100)) + --&gt;</span></span>
<span id="cb31-1470"><a href="#cb31-1470" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     geom_smooth(method = lm, formula = y ~ x - 1, se = FALSE) + --&gt;</span></span>
<span id="cb31-1471"><a href="#cb31-1471" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     geom_smooth(method = lm, formula = y ~ x + I(x ^ 2) - 1, se = FALSE, color = 'red') --&gt;</span></span>
<span id="cb31-1472"><a href="#cb31-1472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1473"><a href="#cb31-1473" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ggplot(tb, aes(mu, z)) + geom_point() + --&gt;</span></span>
<span id="cb31-1474"><a href="#cb31-1474" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #    coord_cartesian(ylim = c(-10, 50)) + --&gt;</span></span>
<span id="cb31-1475"><a href="#cb31-1475" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     geom_smooth(method = lm, formula = y ~ 1, se = FALSE) + --&gt;</span></span>
<span id="cb31-1476"><a href="#cb31-1476" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--     geom_smooth(method = lm, formula = y ~ x - 1, se = FALSE, color = 'red') --&gt;</span></span>
<span id="cb31-1477"><a href="#cb31-1477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1478"><a href="#cb31-1478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1479"><a href="#cb31-1479" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- countreg::disptest(cam_triv_86, type = "scoreNB1") --&gt;</span></span>
<span id="cb31-1480"><a href="#cb31-1480" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- countreg::disptest(cam_triv_86, type = "scoreNB2") --&gt;</span></span>
<span id="cb31-1481"><a href="#cb31-1481" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- mu &lt;- fitted(cam_triv_86) --&gt;</span></span>
<span id="cb31-1482"><a href="#cb31-1482" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- y &lt;- model.response(model.frame(cam_triv_86)) --&gt;</span></span>
<span id="cb31-1483"><a href="#cb31-1483" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- N &lt;- nobs(cam_triv_86) --&gt;</span></span>
<span id="cb31-1484"><a href="#cb31-1484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1485"><a href="#cb31-1485" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- sum( ( (y - mu) ^ 2 - y) / mu) / sqrt(2 * N) --&gt;</span></span>
<span id="cb31-1486"><a href="#cb31-1486" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- sum( ( (y - mu) ^ 2 - y)     ) / sqrt(2 * sum(mu ^ 2)) --&gt;</span></span>
<span id="cb31-1487"><a href="#cb31-1487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1488"><a href="#cb31-1488" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- lm( I( ((y - mu) ^ 2 - y) / mu) ~ mu - 1) %&gt;% summary %&gt;% coef %&gt;% .[3] --&gt;</span></span>
<span id="cb31-1489"><a href="#cb31-1489" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ``` --&gt;</span></span>
<span id="cb31-1490"><a href="#cb31-1490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1491"><a href="#cb31-1491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1492"><a href="#cb31-1492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1493"><a href="#cb31-1493" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ```{r } --&gt;</span></span>
<span id="cb31-1494"><a href="#cb31-1494" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- N &lt;- 1E05 --&gt;</span></span>
<span id="cb31-1495"><a href="#cb31-1495" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- pz &lt;- 0.3 --&gt;</span></span>
<span id="cb31-1496"><a href="#cb31-1496" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- mu &lt;- 2.5 --&gt;</span></span>
<span id="cb31-1497"><a href="#cb31-1497" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- v &lt;- dpois(0, mu) --&gt;</span></span>
<span id="cb31-1498"><a href="#cb31-1498" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- M &lt;- 20 --&gt;</span></span>
<span id="cb31-1499"><a href="#cb31-1499" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Probs &lt;- c(pz, (1 - pz) * dpois(1:M, mu) / (1 - dpois(0, mu))) --&gt;</span></span>
<span id="cb31-1500"><a href="#cb31-1500" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- S &lt;- sample(0:M, size = N, replace = TRUE, prob = Probs) --&gt;</span></span>
<span id="cb31-1501"><a href="#cb31-1501" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- c(mean(S), var(S)) --&gt;</span></span>
<span id="cb31-1502"><a href="#cb31-1502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1503"><a href="#cb31-1503" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Eyp &lt;- mu / (1 - v) --&gt;</span></span>
<span id="cb31-1504"><a href="#cb31-1504" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Vyp &lt;- mu * (1 - v) - v * mu ^2 --&gt;</span></span>
<span id="cb31-1505"><a href="#cb31-1505" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- c(Eyp, Vyp) --&gt;</span></span>
<span id="cb31-1506"><a href="#cb31-1506" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- c(mean(S[S &gt; 0]), var(S[S &gt; 0])) --&gt;</span></span>
<span id="cb31-1507"><a href="#cb31-1507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1508"><a href="#cb31-1508" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Ey &lt;- (1 - pz) * Eyp --&gt;</span></span>
<span id="cb31-1509"><a href="#cb31-1509" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- c(Eyp, Ey) --&gt;</span></span>
<span id="cb31-1510"><a href="#cb31-1510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1511"><a href="#cb31-1511" aria-hidden="true" tabindex="-1"></a><span class="fu">## Endogeneity and selection {#sec-endog_count}</span></span>
<span id="cb31-1512"><a href="#cb31-1512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1513"><a href="#cb31-1513" aria-hidden="true" tabindex="-1"></a><span class="fu">### Instrumental variable estimators for count data</span></span>
<span id="cb31-1514"><a href="#cb31-1514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1515"><a href="#cb31-1515" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{instrumental variable estimator!Poisson model|(}</span>
<span id="cb31-1516"><a href="#cb31-1516" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{exponential linear conditional mean model|(}</span>
<span id="cb31-1517"><a href="#cb31-1517" aria-hidden="true" tabindex="-1"></a>We've seen in @sec-general_iv that, denoting $W$ the matrix of instruments, the IV estimator is $\hat{\gamma} = (Z^\top P_W Z) ^ {-1} (Z^\top P_W y)$ (@eq-overidentified_iv) and the GMM estimator is  $\hat{\gamma} = \left(Z^\top W \hat{S}^{-1} W ^ \top Z\right)^{-1}Z^\top W \hat{S}^{-1} W ^ \top y$ (@eq-two_steps_iv), with</span>
<span id="cb31-1518"><a href="#cb31-1518" aria-hidden="true" tabindex="-1"></a>$\hat{S} = \sum_n \hat{\epsilon}_n ^ 2 w_n w_n^\top$, $\hat{\epsilon}_n$ being the residual of a consistent estimation. </span>
<span id="cb31-1519"><a href="#cb31-1519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1520"><a href="#cb31-1520" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Exponential linear conditional mean model</span></span>
<span id="cb31-1521"><a href="#cb31-1521" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1522"><a href="#cb31-1522" aria-hidden="true" tabindex="-1"></a>The linear model is often inappropriate if the conditional</span>
<span id="cb31-1523"><a href="#cb31-1523" aria-hidden="true" tabindex="-1"></a>distribution of $y$ is asymmetric. In this case, a common solution is</span>
<span id="cb31-1524"><a href="#cb31-1524" aria-hidden="true" tabindex="-1"></a>to use $\ln y$ instead of $y$ as the response: $\ln y_n = \gamma ^ \top z_n + \epsilon$.</span>
<span id="cb31-1525"><a href="#cb31-1525" aria-hidden="true" tabindex="-1"></a>This is of course possible only if $y_n &gt; 0\, \forall n$, which is usually not the case with count data. An alternative is to use an exponential linear conditional mean model <span class="co">[</span><span class="ot">@MULL:97</span><span class="co">]</span>\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Mullahy}, with additive ($y_n = e^{\gamma^\top z_n} + \epsilon_n$) or multiplicative errors ($y_n = e^{\gamma^\top z_n} \nu_n$).</span>
<span id="cb31-1526"><a href="#cb31-1526" aria-hidden="true" tabindex="-1"></a>With additive errors, the empirical moments are then:</span>
<span id="cb31-1527"><a href="#cb31-1527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1528"><a href="#cb31-1528" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-1529"><a href="#cb31-1529" aria-hidden="true" tabindex="-1"></a>\frac{1}{N}\sum_{n=1} ^ N (y_n  - e^{\gamma^\top z_n})w_n = W^\top (y  -</span>
<span id="cb31-1530"><a href="#cb31-1530" aria-hidden="true" tabindex="-1"></a>e^{Z\gamma}) / N</span>
<span id="cb31-1531"><a href="#cb31-1531" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-1532"><a href="#cb31-1532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1533"><a href="#cb31-1533" aria-hidden="true" tabindex="-1"></a>If the errors are spherical, the variance of the empirical moments vector is: $\sigma_{\epsilon} ^ 2 (W ^ \top W) / N ^2$ and the IV estimator minimizes:</span>
<span id="cb31-1534"><a href="#cb31-1534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1535"><a href="#cb31-1535" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-1536"><a href="#cb31-1536" aria-hidden="true" tabindex="-1"></a>\epsilon ^ \top W \left(\sigma ^ 2 W ^ \top W\right) ^ {-1} W ^ \top \epsilon/ \sigma ^ 2</span>
<span id="cb31-1537"><a href="#cb31-1537" aria-hidden="true" tabindex="-1"></a>= \epsilon ^ \top P_W \epsilon / \sigma ^  2</span>
<span id="cb31-1538"><a href="#cb31-1538" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-1539"><a href="#cb31-1539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1540"><a href="#cb31-1540" aria-hidden="true" tabindex="-1"></a>Denoting $\hat{\epsilon}$ the residuals of this regression, the optimal weighting matrix </span>
<span id="cb31-1541"><a href="#cb31-1541" aria-hidden="true" tabindex="-1"></a>$\hat{S} = \sum_{n = 1} ^ N \hat{\epsilon}_n ^ 2 w_n w_n ^ \top$ can be constructed and used in a second step to get the more efficient GMM estimator. \index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{general method of moments estimator!Poisson model}</span>
<span id="cb31-1542"><a href="#cb31-1542" aria-hidden="true" tabindex="-1"></a>With additive errors, the only difference with the linear case is that</span>
<span id="cb31-1543"><a href="#cb31-1543" aria-hidden="true" tabindex="-1"></a>the minimization process results in a set of non linear equations, so</span>
<span id="cb31-1544"><a href="#cb31-1544" aria-hidden="true" tabindex="-1"></a>that some numerical methods should be used. </span>
<span id="cb31-1545"><a href="#cb31-1545" aria-hidden="true" tabindex="-1"></a>With multiplicative errors, we have: $\nu_n = y_n / e^{\gamma^\top</span>
<span id="cb31-1546"><a href="#cb31-1546" aria-hidden="true" tabindex="-1"></a>z_n}$. The moment conditions are then: $\mbox{E}\left((y_n/e^{\gamma ^ \top z_n} - 1)^\top w_n\right)=0$</span>
<span id="cb31-1547"><a href="#cb31-1547" aria-hidden="true" tabindex="-1"></a>which leads to the following empirical moments:</span>
<span id="cb31-1548"><a href="#cb31-1548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1549"><a href="#cb31-1549" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-1550"><a href="#cb31-1550" aria-hidden="true" tabindex="-1"></a>\frac{1}{N}\sum_{n=1} ^ N (y_n/e^{\gamma^\top z_n} - 1)w_n = W^\top (y/</span>
<span id="cb31-1551"><a href="#cb31-1551" aria-hidden="true" tabindex="-1"></a>e^{Z^\top\gamma}- 1) / N = Z^\top \tau_n / N</span>
<span id="cb31-1552"><a href="#cb31-1552" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-1553"><a href="#cb31-1553" aria-hidden="true" tabindex="-1"></a>with $\tau_n = y_n/e^{\gamma^\top z_n} - 1$. </span>
<span id="cb31-1554"><a href="#cb31-1554" aria-hidden="true" tabindex="-1"></a>Minimizing the quadratic form of these empirical moments with $(W^\top</span>
<span id="cb31-1555"><a href="#cb31-1555" aria-hidden="true" tabindex="-1"></a>W) ^{-1}$ or $\left(\sum_{n=1} ^ N \hat{\tau}_n ^ 2 w_n</span>
<span id="cb31-1556"><a href="#cb31-1556" aria-hidden="true" tabindex="-1"></a>w_n^\top\right) ^ {- 1}$ leads respectively to the IV and the GMM</span>
<span id="cb31-1557"><a href="#cb31-1557" aria-hidden="true" tabindex="-1"></a>estimators.</span>
<span id="cb31-1558"><a href="#cb31-1558" aria-hidden="true" tabindex="-1"></a>When the number of external instruments is greater that the number of</span>
<span id="cb31-1559"><a href="#cb31-1559" aria-hidden="true" tabindex="-1"></a>endogenous variables, the Sargan test enables to test the hypothesis of exogeneity of all the instruments. The</span>
<span id="cb31-1560"><a href="#cb31-1560" aria-hidden="true" tabindex="-1"></a>value of the objective function at convergence times the size of the</span>
<span id="cb31-1561"><a href="#cb31-1561" aria-hidden="true" tabindex="-1"></a>sample is, under the null hypothesis that all the instruments are</span>
<span id="cb31-1562"><a href="#cb31-1562" aria-hidden="true" tabindex="-1"></a>exogenous, a $\chi^2$ with a number of degrees of freedom equal to</span>
<span id="cb31-1563"><a href="#cb31-1563" aria-hidden="true" tabindex="-1"></a>the difference between the number of instruments and the number of</span>
<span id="cb31-1564"><a href="#cb31-1564" aria-hidden="true" tabindex="-1"></a>covariates.</span>
<span id="cb31-1565"><a href="#cb31-1565" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{Sargan test}</span>
<span id="cb31-1566"><a href="#cb31-1566" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{instrumental variable estimator!Poisson model|)}</span>
<span id="cb31-1567"><a href="#cb31-1567" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{exponential linear conditional mean model|)}</span>
<span id="cb31-1568"><a href="#cb31-1568" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1569"><a href="#cb31-1569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1570"><a href="#cb31-1570" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Cigarette smoking behavior</span></span>
<span id="cb31-1571"><a href="#cb31-1571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1572"><a href="#cb31-1572" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">(</span><span class="co">]</span>{cigmales}{micsr}</span>
<span id="cb31-1573"><a href="#cb31-1573" aria-hidden="true" tabindex="-1"></a>@MULL:97\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Mullahy} estimates a demand function for cigarettes which depends on</span>
<span id="cb31-1574"><a href="#cb31-1574" aria-hidden="true" tabindex="-1"></a>the stock of smoking habits. This variable is quite similar to a</span>
<span id="cb31-1575"><a href="#cb31-1575" aria-hidden="true" tabindex="-1"></a>lagged dependent variable and is likely to be endogenous as the</span>
<span id="cb31-1576"><a href="#cb31-1576" aria-hidden="true" tabindex="-1"></a>unobservable determinants of current smoking behavior should be</span>
<span id="cb31-1577"><a href="#cb31-1577" aria-hidden="true" tabindex="-1"></a>correlated with the unobservable determinants of past smoking</span>
<span id="cb31-1578"><a href="#cb31-1578" aria-hidden="true" tabindex="-1"></a>behavior. The data set, called <span class="in">`cigmales`</span>, contains observations of 6160 males in 1979</span>
<span id="cb31-1579"><a href="#cb31-1579" aria-hidden="true" tabindex="-1"></a>and 1980 from the smoking supplement to the 1979 National Health</span>
<span id="cb31-1580"><a href="#cb31-1580" aria-hidden="true" tabindex="-1"></a>Interview Survey. The response <span class="in">`cigarettes`</span> is the number of</span>
<span id="cb31-1581"><a href="#cb31-1581" aria-hidden="true" tabindex="-1"></a>cigarettes smoked daily. The covariates are the habit "stock" <span class="in">`habit`</span>,</span>
<span id="cb31-1582"><a href="#cb31-1582" aria-hidden="true" tabindex="-1"></a>the current state-level average per-pack price of cigarettes <span class="in">`price`</span>,</span>
<span id="cb31-1583"><a href="#cb31-1583" aria-hidden="true" tabindex="-1"></a>a dummy indicating whether there is in the state of residence a</span>
<span id="cb31-1584"><a href="#cb31-1584" aria-hidden="true" tabindex="-1"></a>restriction on smoking in restaurants <span class="in">`restaurant`</span>, the age <span class="in">`age`</span> and the</span>
<span id="cb31-1585"><a href="#cb31-1585" aria-hidden="true" tabindex="-1"></a>number of years of schooling <span class="in">`educ`</span> and their squares, the number of</span>
<span id="cb31-1586"><a href="#cb31-1586" aria-hidden="true" tabindex="-1"></a>family members <span class="in">`famsize`</span>, and a dummy <span class="in">`race`</span> which indicates whether</span>
<span id="cb31-1587"><a href="#cb31-1587" aria-hidden="true" tabindex="-1"></a>the individual is white or not. The external instruments are cubic</span>
<span id="cb31-1588"><a href="#cb31-1588" aria-hidden="true" tabindex="-1"></a>terms in <span class="in">`age`</span> and <span class="in">`educ`</span> and their interaction, the one-year lagged</span>
<span id="cb31-1589"><a href="#cb31-1589" aria-hidden="true" tabindex="-1"></a>price of a pack of cigarettes <span class="in">`lagprice`</span> and the number of years the</span>
<span id="cb31-1590"><a href="#cb31-1590" aria-hidden="true" tabindex="-1"></a>state's restaurant smoking restrictions had been in place.</span>
<span id="cb31-1591"><a href="#cb31-1591" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1592"><a href="#cb31-1592" aria-hidden="true" tabindex="-1"></a>The starting point is a basic count model, i.e., a Poisson model with a</span>
<span id="cb31-1593"><a href="#cb31-1593" aria-hidden="true" tabindex="-1"></a>log-link and robust standard errors:</span>
<span id="cb31-1594"><a href="#cb31-1594" aria-hidden="true" tabindex="-1"></a>\idxfun{mutate}{dplyr}\idxfun{glm}{stats}\idxfun{quasipoisson}{stats}</span>
<span id="cb31-1595"><a href="#cb31-1595" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1596"><a href="#cb31-1596" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb31-1597"><a href="#cb31-1597" aria-hidden="true" tabindex="-1"></a><span class="co">#| message = FALSE</span></span>
<span id="cb31-1598"><a href="#cb31-1598" aria-hidden="true" tabindex="-1"></a>cigmales <span class="ot">&lt;-</span> cigmales <span class="sc">%&gt;%</span></span>
<span id="cb31-1599"><a href="#cb31-1599" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">age2 =</span> age <span class="sc">^</span> <span class="dv">2</span>, <span class="at">educ2 =</span> educ <span class="sc">^</span> <span class="dv">2</span>,</span>
<span id="cb31-1600"><a href="#cb31-1600" aria-hidden="true" tabindex="-1"></a>           <span class="at">age3 =</span> age <span class="sc">^</span> <span class="dv">3</span>, <span class="at">educ3 =</span> educ <span class="sc">^</span> <span class="dv">3</span>,</span>
<span id="cb31-1601"><a href="#cb31-1601" aria-hidden="true" tabindex="-1"></a>           <span class="at">educage =</span> educ <span class="sc">*</span> age)                                 </span>
<span id="cb31-1602"><a href="#cb31-1602" aria-hidden="true" tabindex="-1"></a>pois_cig <span class="ot">&lt;-</span> <span class="fu">glm</span>(cigarettes <span class="sc">~</span> habit <span class="sc">+</span> price <span class="sc">+</span> restaurant <span class="sc">+</span> income <span class="sc">+</span> </span>
<span id="cb31-1603"><a href="#cb31-1603" aria-hidden="true" tabindex="-1"></a>                  age <span class="sc">+</span> age2 <span class="sc">+</span> educ <span class="sc">+</span> educ2 <span class="sc">+</span> famsize <span class="sc">+</span> race, </span>
<span id="cb31-1604"><a href="#cb31-1604" aria-hidden="true" tabindex="-1"></a>                <span class="at">data =</span> cigmales, <span class="at">family =</span> quasipoisson)</span>
<span id="cb31-1605"><a href="#cb31-1605" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-1606"><a href="#cb31-1606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1607"><a href="#cb31-1607" aria-hidden="true" tabindex="-1"></a>The IV and the GMM estimators are estimated using the <span class="in">`micsr::expreg`</span></span>
<span id="cb31-1608"><a href="#cb31-1608" aria-hidden="true" tabindex="-1"></a>function. Its main argument is a two-part formula, the first</span>
<span id="cb31-1609"><a href="#cb31-1609" aria-hidden="true" tabindex="-1"></a>part indicating the covariates and the second part the instruments. The <span class="in">`method`</span> argument can be set to <span class="in">`"iv"`</span> or <span class="in">`"gmm"`</span> to estimate respectively the instrumental variable and the general method of moments estimators and the <span class="in">`error`</span> argument can be equal to <span class="in">`"mult"`</span> (the default) or <span class="in">`"add"`</span> to select respectively multiplicative or additive errors.</span>
<span id="cb31-1610"><a href="#cb31-1610" aria-hidden="true" tabindex="-1"></a>\idxfun{expreg}{micsr}\idxfun{update}{stats}</span>
<span id="cb31-1611"><a href="#cb31-1611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1612"><a href="#cb31-1612" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb31-1613"><a href="#cb31-1613" aria-hidden="true" tabindex="-1"></a>iv_cig <span class="ot">&lt;-</span> <span class="fu">expreg</span>(cigarettes <span class="sc">~</span> habit <span class="sc">+</span> price <span class="sc">+</span> restaurant <span class="sc">+</span> income <span class="sc">+</span> </span>
<span id="cb31-1614"><a href="#cb31-1614" aria-hidden="true" tabindex="-1"></a>                   age <span class="sc">+</span> age2 <span class="sc">+</span> educ <span class="sc">+</span> educ2 <span class="sc">+</span> famsize <span class="sc">+</span> race <span class="sc">|</span> </span>
<span id="cb31-1615"><a href="#cb31-1615" aria-hidden="true" tabindex="-1"></a>                   . <span class="sc">-</span> habit <span class="sc">+</span> age3 <span class="sc">+</span> educ3 <span class="sc">+</span> educage <span class="sc">+</span> </span>
<span id="cb31-1616"><a href="#cb31-1616" aria-hidden="true" tabindex="-1"></a>                   lagprice <span class="sc">+</span> reslgth, </span>
<span id="cb31-1617"><a href="#cb31-1617" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> cigmales, <span class="at">method =</span> <span class="st">"iv"</span>)</span>
<span id="cb31-1618"><a href="#cb31-1618" aria-hidden="true" tabindex="-1"></a>gmm_cig <span class="ot">&lt;-</span> <span class="fu">update</span>(iv_cig, <span class="at">method =</span> <span class="st">"gmm"</span>)</span>
<span id="cb31-1619"><a href="#cb31-1619" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-1620"><a href="#cb31-1620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1621"><a href="#cb31-1621" aria-hidden="true" tabindex="-1"></a>\newpage</span>
<span id="cb31-1622"><a href="#cb31-1622" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1623"><a href="#cb31-1623" aria-hidden="true" tabindex="-1"></a>The results are presented in @tbl-cigarettes_iv. For the two flavors of instrumental variable estimators, the coefficient of <span class="in">`habit`</span> is about half of the one of the Poisson model, indicating that this covariate is positively correlated with the unobserved determinants of smoking. </span>
<span id="cb31-1624"><a href="#cb31-1624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1625"><a href="#cb31-1625" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb31-1626"><a href="#cb31-1626" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-cigarettes_iv</span></span>
<span id="cb31-1627"><a href="#cb31-1627" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Cigarette consumption and smoking habits"</span></span>
<span id="cb31-1628"><a href="#cb31-1628" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb31-1629"><a href="#cb31-1629" aria-hidden="true" tabindex="-1"></a>modelsummary<span class="sc">::</span><span class="fu">msummary</span>(<span class="fu">list</span>(<span class="at">ML =</span> pois_cig, <span class="at">IV =</span> iv_cig, <span class="at">GMM =</span> gmm_cig),</span>
<span id="cb31-1630"><a href="#cb31-1630" aria-hidden="true" tabindex="-1"></a>                       <span class="at">fmt =</span> <span class="dv">4</span>, <span class="at">statistic =</span> <span class="st">'statistic'</span>, <span class="at">coef_omit =</span> <span class="st">"(Intercept)"</span>,</span>
<span id="cb31-1631"><a href="#cb31-1631" aria-hidden="true" tabindex="-1"></a>                       <span class="at">output =</span> <span class="st">"kableExtra"</span>)</span>
<span id="cb31-1632"><a href="#cb31-1632" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-1633"><a href="#cb31-1633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1634"><a href="#cb31-1634" aria-hidden="true" tabindex="-1"></a>Computing the Sargan test:</span>
<span id="cb31-1635"><a href="#cb31-1635" aria-hidden="true" tabindex="-1"></a>\idxfun{sargan}{micsr}\idxfun{gaze}{micsr}</span>
<span id="cb31-1636"><a href="#cb31-1636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1637"><a href="#cb31-1637" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb31-1638"><a href="#cb31-1638" aria-hidden="true" tabindex="-1"></a><span class="co"># collapse: true</span></span>
<span id="cb31-1639"><a href="#cb31-1639" aria-hidden="true" tabindex="-1"></a><span class="fu">sargan</span>(gmm_cig) <span class="sc">%&gt;%</span> gaze</span>
<span id="cb31-1640"><a href="#cb31-1640" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-1641"><a href="#cb31-1641" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">)</span><span class="co">]</span>{cigmales}{micsr}</span>
<span id="cb31-1642"><a href="#cb31-1642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1643"><a href="#cb31-1643" aria-hidden="true" tabindex="-1"></a>we conclude that the exogeneity of the instruments hypothesis is not rejected.</span>
<span id="cb31-1644"><a href="#cb31-1644" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1645"><a href="#cb31-1645" aria-hidden="true" tabindex="-1"></a><span class="fu">### Sample selection and endogenous switching for count data</span></span>
<span id="cb31-1646"><a href="#cb31-1646" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1647"><a href="#cb31-1647" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{sample selection!Poisson model|(}</span>
<span id="cb31-1648"><a href="#cb31-1648" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{endogenous switching!Poisson model|(}</span>
<span id="cb31-1649"><a href="#cb31-1649" aria-hidden="true" tabindex="-1"></a>In two seminal papers, Heckman <span class="co">[</span><span class="ot">-@HECK:76; -@HECK:79</span><span class="co">]</span>\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Heckman} considered the case where</span>
<span id="cb31-1650"><a href="#cb31-1650" aria-hidden="true" tabindex="-1"></a>two variables are jointly determined, a binomial variable and an</span>
<span id="cb31-1651"><a href="#cb31-1651" aria-hidden="true" tabindex="-1"></a>outcome continuous variable. For example, the continuous variable can</span>
<span id="cb31-1652"><a href="#cb31-1652" aria-hidden="true" tabindex="-1"></a>be the wage and the binomial variable the labor force</span>
<span id="cb31-1653"><a href="#cb31-1653" aria-hidden="true" tabindex="-1"></a>participation. In this case, the wage is observed only for the</span>
<span id="cb31-1654"><a href="#cb31-1654" aria-hidden="true" tabindex="-1"></a>subsample of the individuals who work. If the unobserved</span>
<span id="cb31-1655"><a href="#cb31-1655" aria-hidden="true" tabindex="-1"></a>determinants of labor force participation are correlated with the</span>
<span id="cb31-1656"><a href="#cb31-1656" aria-hidden="true" tabindex="-1"></a>unobserved determinants of wage, estimating the wage equation only on</span>
<span id="cb31-1657"><a href="#cb31-1657" aria-hidden="true" tabindex="-1"></a>the subset of individuals who work will result in an inconsistent</span>
<span id="cb31-1658"><a href="#cb31-1658" aria-hidden="true" tabindex="-1"></a>estimator. This case is called the **sample selection** model and has been presented in @sec-tobit2. Consider now the case where the binomial variable is a a dummy</span>
<span id="cb31-1659"><a href="#cb31-1659" aria-hidden="true" tabindex="-1"></a>for private vs public sector. In this case the wage is observed for</span>
<span id="cb31-1660"><a href="#cb31-1660" aria-hidden="true" tabindex="-1"></a>the whole sample (for the individuals in the public and in the private</span>
<span id="cb31-1661"><a href="#cb31-1661" aria-hidden="true" tabindex="-1"></a>sector) but, once again, if the unobserved determinants of the</span>
<span id="cb31-1662"><a href="#cb31-1662" aria-hidden="true" tabindex="-1"></a>chosen sector are correlated with those of the wage,</span>
<span id="cb31-1663"><a href="#cb31-1663" aria-hidden="true" tabindex="-1"></a>estimating the wage equation only will lead to an inconsistent</span>
<span id="cb31-1664"><a href="#cb31-1664" aria-hidden="true" tabindex="-1"></a>estimator. This case is called the **endogenous switching** model. </span>
<span id="cb31-1665"><a href="#cb31-1665" aria-hidden="true" tabindex="-1"></a>Two consistent methods of estimation can be used in this context:</span>
<span id="cb31-1666"><a href="#cb31-1666" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1667"><a href="#cb31-1667" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>a two-step method where, in a first step, a probit</span>
<span id="cb31-1668"><a href="#cb31-1668" aria-hidden="true" tabindex="-1"></a>  model for the binomial variable is estimated and, in a second step,</span>
<span id="cb31-1669"><a href="#cb31-1669" aria-hidden="true" tabindex="-1"></a>  the outcome equation is estimated by OLS with a supplementary</span>
<span id="cb31-1670"><a href="#cb31-1670" aria-hidden="true" tabindex="-1"></a>  covariate which is a function of the linear predictor of the</span>
<span id="cb31-1671"><a href="#cb31-1671" aria-hidden="true" tabindex="-1"></a>  probit,^<span class="co">[</span><span class="ot">More precisely the inverse Mills ratio.</span><span class="co">]</span></span>
<span id="cb31-1672"><a href="#cb31-1672" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>the maximum likelihood estimation of the system of</span>
<span id="cb31-1673"><a href="#cb31-1673" aria-hidden="true" tabindex="-1"></a>  the two equations, assuming that the two errors are jointly</span>
<span id="cb31-1674"><a href="#cb31-1674" aria-hidden="true" tabindex="-1"></a>  normally distributed.</span>
<span id="cb31-1675"><a href="#cb31-1675" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1676"><a href="#cb31-1676" aria-hidden="true" tabindex="-1"></a>Let $y$ be a count response (for the sake of simplicity a Poisson</span>
<span id="cb31-1677"><a href="#cb31-1677" aria-hidden="true" tabindex="-1"></a>variable) and $w$ a binomial variable. The value of $w_n$ is given by</span>
<span id="cb31-1678"><a href="#cb31-1678" aria-hidden="true" tabindex="-1"></a>the sign of $\gamma ^ \top z_{n1} + \nu_{n}$, where $\nu_n$ is a standard normal</span>
<span id="cb31-1679"><a href="#cb31-1679" aria-hidden="true" tabindex="-1"></a>deviate, $z_{n1}$ a vector of covariates and $\gamma_1$ the associated vector</span>
<span id="cb31-1680"><a href="#cb31-1680" aria-hidden="true" tabindex="-1"></a>of unknown parameters. The distribution of $y_n$ is Poisson with</span>
<span id="cb31-1681"><a href="#cb31-1681" aria-hidden="true" tabindex="-1"></a>parameter $\lambda_n$, given by $\lambda_n = e ^{\gamma_2 ^ \top z_{n2}} + \epsilon_n$ where $z_{n2}$ is a second set of covariates (which can overlap</span>
<span id="cb31-1682"><a href="#cb31-1682" aria-hidden="true" tabindex="-1"></a>with $z_{n1}$), $\gamma_2$ is the corresponding set of unknown parameters and</span>
<span id="cb31-1683"><a href="#cb31-1683" aria-hidden="true" tabindex="-1"></a>$\epsilon_n$ is a random normal deviate with 0 mean and a standard</span>
<span id="cb31-1684"><a href="#cb31-1684" aria-hidden="true" tabindex="-1"></a>deviation equal to $\sigma$. $\epsilon$ and $\nu$ being potentially</span>
<span id="cb31-1685"><a href="#cb31-1685" aria-hidden="true" tabindex="-1"></a>correlated, their joint distribution has to be considered:</span>
<span id="cb31-1686"><a href="#cb31-1686" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{sample selection!Poisson model!maximum likelihood|(}</span>
<span id="cb31-1687"><a href="#cb31-1687" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{endogenous switching!Poisson model!maximum likelihood|(}</span>
<span id="cb31-1688"><a href="#cb31-1688" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1689"><a href="#cb31-1689" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1690"><a href="#cb31-1690" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-1691"><a href="#cb31-1691" aria-hidden="true" tabindex="-1"></a>\begin{array}{rcl}</span>
<span id="cb31-1692"><a href="#cb31-1692" aria-hidden="true" tabindex="-1"></a>f(\epsilon, \nu ; \sigma, \rho)  &amp;=&amp; </span>
<span id="cb31-1693"><a href="#cb31-1693" aria-hidden="true" tabindex="-1"></a>\frac{1}{2\pi\sqrt{1 - \rho ^ 2}\sigma}</span>
<span id="cb31-1694"><a href="#cb31-1694" aria-hidden="true" tabindex="-1"></a>e^{-\frac{1}{2} \frac{\left(\frac{\epsilon}{\sigma}\right) ^ 2 + \nu ^</span>
<span id="cb31-1695"><a href="#cb31-1695" aria-hidden="true" tabindex="-1"></a>2 - 2 \rho \left(\frac{\epsilon}{\sigma}\right)\nu}{1 - \rho ^2}} <span class="sc">\\</span></span>
<span id="cb31-1696"><a href="#cb31-1696" aria-hidden="true" tabindex="-1"></a>&amp;=&amp; \frac{1}{\sqrt{2\pi}}\sigma e ^</span>
<span id="cb31-1697"><a href="#cb31-1697" aria-hidden="true" tabindex="-1"></a>{-\frac{1}{2}\left(\frac{\epsilon}{\sigma}\right) ^ 2}</span>
<span id="cb31-1698"><a href="#cb31-1698" aria-hidden="true" tabindex="-1"></a>\frac{1}{\sqrt{2\pi}\sqrt{1 - \rho ^ 2}}</span>
<span id="cb31-1699"><a href="#cb31-1699" aria-hidden="true" tabindex="-1"></a>e^{-\frac{1}{2}\left(\frac{(\nu - \rho \epsilon / \sigma)}{\sqrt{1 -</span>
<span id="cb31-1700"><a href="#cb31-1700" aria-hidden="true" tabindex="-1"></a>\rho ^ 2}}\right) ^ 2}</span>
<span id="cb31-1701"><a href="#cb31-1701" aria-hidden="true" tabindex="-1"></a>\end{array}</span>
<span id="cb31-1702"><a href="#cb31-1702" aria-hidden="true" tabindex="-1"></a>$$ {#eq-joint_dist_normal}</span>
<span id="cb31-1703"><a href="#cb31-1703" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1704"><a href="#cb31-1704" aria-hidden="true" tabindex="-1"></a>The second expression gives the joint distribution of $\epsilon$ and $\nu$ as the</span>
<span id="cb31-1705"><a href="#cb31-1705" aria-hidden="true" tabindex="-1"></a>product of the marginal distribution of $\epsilon$ and the conditional</span>
<span id="cb31-1706"><a href="#cb31-1706" aria-hidden="true" tabindex="-1"></a>distribution of $\nu$.</span>
<span id="cb31-1707"><a href="#cb31-1707" aria-hidden="true" tabindex="-1"></a>The conditional distribution of $y$, given $\epsilon$ is:</span>
<span id="cb31-1708"><a href="#cb31-1708" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1709"><a href="#cb31-1709" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-1710"><a href="#cb31-1710" aria-hidden="true" tabindex="-1"></a>g(y_n \mid z_{n2}, \epsilon_n;\gamma_2) = \frac{e ^</span>
<span id="cb31-1711"><a href="#cb31-1711" aria-hidden="true" tabindex="-1"></a>{-\exp(\gamma_2 ^ \top z_{n2} + \epsilon_n)}e^{y_n(\gamma_2^\top z_{n2} +</span>
<span id="cb31-1712"><a href="#cb31-1712" aria-hidden="true" tabindex="-1"></a>\epsilon_n)}}{y_n!}</span>
<span id="cb31-1713"><a href="#cb31-1713" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-1714"><a href="#cb31-1714" aria-hidden="true" tabindex="-1"></a>For $w=1$, the unconditional distribution of $y$ is obtained by</span>
<span id="cb31-1715"><a href="#cb31-1715" aria-hidden="true" tabindex="-1"></a>integrating out $g$ with the two random deviates $\epsilon$ and $\nu$, using their joint distribution given by @eq-joint_dist_normal:</span>
<span id="cb31-1716"><a href="#cb31-1716" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1717"><a href="#cb31-1717" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-1718"><a href="#cb31-1718" aria-hidden="true" tabindex="-1"></a>\begin{array}{rcl}</span>
<span id="cb31-1719"><a href="#cb31-1719" aria-hidden="true" tabindex="-1"></a>P(y_n \mid z_{n1}, z_{n2}, w_n = 1) &amp;=&amp; \displaystyle\int_{-\infty} ^ {+\infty}\int_{-\gamma_1 ^ \top</span>
<span id="cb31-1720"><a href="#cb31-1720" aria-hidden="true" tabindex="-1"></a>z_{n1}} ^ {+ \infty} g(y_n \mid z_{n2}, \epsilon_n;\gamma_2)</span>
<span id="cb31-1721"><a href="#cb31-1721" aria-hidden="true" tabindex="-1"></a>f(\epsilon, \nu;\sigma, \rho) d\epsilon d\nu<span class="sc">\\</span></span>
<span id="cb31-1722"><a href="#cb31-1722" aria-hidden="true" tabindex="-1"></a>&amp;=&amp; \displaystyle\int_{-\infty} ^ {+\infty}</span>
<span id="cb31-1723"><a href="#cb31-1723" aria-hidden="true" tabindex="-1"></a>g(y_n \mid z_{n2}, \epsilon_n)</span>
<span id="cb31-1724"><a href="#cb31-1724" aria-hidden="true" tabindex="-1"></a>\left(\int_{-\gamma_1 ^ \top z_{n1}} ^ {+ \infty} </span>
<span id="cb31-1725"><a href="#cb31-1725" aria-hidden="true" tabindex="-1"></a>\frac{1}{\sqrt{2\pi}\sqrt{1 - \rho ^ 2}}</span>
<span id="cb31-1726"><a href="#cb31-1726" aria-hidden="true" tabindex="-1"></a>e^{-\frac{1}{2}\left(\frac{(\nu - \rho \epsilon / \sigma)}{\sqrt{1 -</span>
<span id="cb31-1727"><a href="#cb31-1727" aria-hidden="true" tabindex="-1"></a>\rho ^ 2}}\right) ^ 2} </span>
<span id="cb31-1728"><a href="#cb31-1728" aria-hidden="true" tabindex="-1"></a>d\nu\right)<span class="sc">\\</span></span>
<span id="cb31-1729"><a href="#cb31-1729" aria-hidden="true" tabindex="-1"></a>&amp;\times&amp;\displaystyle \frac{1}{\sqrt{2\pi}\sigma} e ^</span>
<span id="cb31-1730"><a href="#cb31-1730" aria-hidden="true" tabindex="-1"></a>{-\frac{1}{2}\left(\frac{\epsilon}{\sigma}\right) ^ 2}</span>
<span id="cb31-1731"><a href="#cb31-1731" aria-hidden="true" tabindex="-1"></a>d\epsilon</span>
<span id="cb31-1732"><a href="#cb31-1732" aria-hidden="true" tabindex="-1"></a>\end{array}</span>
<span id="cb31-1733"><a href="#cb31-1733" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-1734"><a href="#cb31-1734" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1735"><a href="#cb31-1735" aria-hidden="true" tabindex="-1"></a>By symmetry of the normal distribution, the term in brackets is: </span>
<span id="cb31-1736"><a href="#cb31-1736" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1737"><a href="#cb31-1737" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-1738"><a href="#cb31-1738" aria-hidden="true" tabindex="-1"></a>\Phi\left(\frac{\gamma_1 ^ \top z_{n1} + \rho / \sigma \epsilon}{\sqrt{1 -</span>
<span id="cb31-1739"><a href="#cb31-1739" aria-hidden="true" tabindex="-1"></a>\rho ^ 2}}\right)</span>
<span id="cb31-1740"><a href="#cb31-1740" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-1741"><a href="#cb31-1741" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1742"><a href="#cb31-1742" aria-hidden="true" tabindex="-1"></a>which is the probability that $w = 1$ for a given value of</span>
<span id="cb31-1743"><a href="#cb31-1743" aria-hidden="true" tabindex="-1"></a>$\epsilon$. The density of $y$ given that $w = 1$ is then:</span>
<span id="cb31-1744"><a href="#cb31-1744" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1745"><a href="#cb31-1745" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-1746"><a href="#cb31-1746" aria-hidden="true" tabindex="-1"></a>\begin{array}{rcl}</span>
<span id="cb31-1747"><a href="#cb31-1747" aria-hidden="true" tabindex="-1"></a>P(y_n \mid z_{n1}, z_{n2}, w_n = 1) &amp;=&amp; \displaystyle\int_{-\infty} ^ {+\infty} \frac{e ^</span>
<span id="cb31-1748"><a href="#cb31-1748" aria-hidden="true" tabindex="-1"></a>{-\exp(\gamma_2 ^ \top z_{n2} + \epsilon_n)}e^{y_n(\gamma_2^\top z_{n2} +</span>
<span id="cb31-1749"><a href="#cb31-1749" aria-hidden="true" tabindex="-1"></a>\epsilon_n)}}{y_n!}<span class="sc">\\</span></span>
<span id="cb31-1750"><a href="#cb31-1750" aria-hidden="true" tabindex="-1"></a>&amp;\times&amp;\Phi\left(\frac{\gamma_1 ^ \top z_{n1} + \rho / \sigma \epsilon}{\sqrt{1 -</span>
<span id="cb31-1751"><a href="#cb31-1751" aria-hidden="true" tabindex="-1"></a>\rho ^ 2}}\right)\frac{1}{\sqrt{2\pi}\sigma} e ^</span>
<span id="cb31-1752"><a href="#cb31-1752" aria-hidden="true" tabindex="-1"></a>{-\frac{1}{2}\left(\frac{\epsilon}{\sigma}\right) ^ 2} d\epsilon</span>
<span id="cb31-1753"><a href="#cb31-1753" aria-hidden="true" tabindex="-1"></a>\end{array}</span>
<span id="cb31-1754"><a href="#cb31-1754" aria-hidden="true" tabindex="-1"></a>$$ {#eq-probyw1}</span>
<span id="cb31-1755"><a href="#cb31-1755" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1756"><a href="#cb31-1756" aria-hidden="true" tabindex="-1"></a>By symmetry, it is easily shown that $P(y_n \mid z_{n1}, z_{n2}, w_n = 0)$ is</span>
<span id="cb31-1757"><a href="#cb31-1757" aria-hidden="true" tabindex="-1"></a>similar except that $\Phi\left( (\gamma_1 ^ \top z_{n1} + \rho / \sigma \epsilon) / \sqrt{1 - \rho ^ 2}\right)$ is replaced by $\Phi\left( -(\gamma_1 ^ \top z_{n1} + \rho / \sigma \epsilon) / \sqrt{1 - \rho ^ 2}\right)$, so that a general formulation of the</span>
<span id="cb31-1758"><a href="#cb31-1758" aria-hidden="true" tabindex="-1"></a>distribution of $y_n$ is, denoting $q_n = 2 w_n -1$:</span>
<span id="cb31-1759"><a href="#cb31-1759" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1760"><a href="#cb31-1760" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-1761"><a href="#cb31-1761" aria-hidden="true" tabindex="-1"></a>\begin{array}{rcl}</span>
<span id="cb31-1762"><a href="#cb31-1762" aria-hidden="true" tabindex="-1"></a>P(y_n \mid z_{n1}, z_{n2}) &amp;=&amp; \displaystyle\int_{-\infty} ^ {+\infty} \frac{e ^</span>
<span id="cb31-1763"><a href="#cb31-1763" aria-hidden="true" tabindex="-1"></a>{-\exp(\gamma_2 ^ \top z_{n2} + \epsilon_n)}e^{y_n(\gamma_2^\top z_{n2} +</span>
<span id="cb31-1764"><a href="#cb31-1764" aria-hidden="true" tabindex="-1"></a>\epsilon_n)}}{y_n!}<span class="sc">\\</span></span>
<span id="cb31-1765"><a href="#cb31-1765" aria-hidden="true" tabindex="-1"></a>&amp;\times&amp;\Phi\left(q_n\frac{\gamma_1 ^ \top z_{n1} + \rho / \sigma \epsilon}{\sqrt{1 -</span>
<span id="cb31-1766"><a href="#cb31-1766" aria-hidden="true" tabindex="-1"></a>\rho ^ 2}}\right)\frac{1}{\sqrt{2\pi}\sigma} e ^</span>
<span id="cb31-1767"><a href="#cb31-1767" aria-hidden="true" tabindex="-1"></a>{-\frac{1}{2}\left(\frac{\epsilon}{\sigma}\right) ^ 2} d\epsilon</span>
<span id="cb31-1768"><a href="#cb31-1768" aria-hidden="true" tabindex="-1"></a>\end{array}</span>
<span id="cb31-1769"><a href="#cb31-1769" aria-hidden="true" tabindex="-1"></a>$$ {#eq-proby}</span>
<span id="cb31-1770"><a href="#cb31-1770" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1771"><a href="#cb31-1771" aria-hidden="true" tabindex="-1"></a>There is no closed form for this integral but, using the change of</span>
<span id="cb31-1772"><a href="#cb31-1772" aria-hidden="true" tabindex="-1"></a>variable $t = \epsilon / \sqrt{2} / \sigma$, we get:</span>
<span id="cb31-1773"><a href="#cb31-1773" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1774"><a href="#cb31-1774" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-1775"><a href="#cb31-1775" aria-hidden="true" tabindex="-1"></a>\begin{array}{rcl}</span>
<span id="cb31-1776"><a href="#cb31-1776" aria-hidden="true" tabindex="-1"></a>P(y_n \mid z_{n1}, z_{n2}) &amp;=&amp; \displaystyle\int_{-\infty} ^ {+\infty} \frac{e ^</span>
<span id="cb31-1777"><a href="#cb31-1777" aria-hidden="true" tabindex="-1"></a>{-\exp(\gamma_2 ^ \top z_{n2} + \sqrt{2} \sigma  t)}e^{y_n(\gamma_2^\top x_{n2} +</span>
<span id="cb31-1778"><a href="#cb31-1778" aria-hidden="true" tabindex="-1"></a>\sqrt{2}\sigma t)}}{y_n!}<span class="sc">\\</span></span>
<span id="cb31-1779"><a href="#cb31-1779" aria-hidden="true" tabindex="-1"></a>&amp;\times&amp;\Phi\left(q_n\frac{\gamma_1 ^ \top z_{1n} + \sqrt{2} \rho  t_n}{\sqrt{1 - \rho ^ 2}}\right)\frac{1}{\sqrt{\pi}} e ^</span>
<span id="cb31-1780"><a href="#cb31-1780" aria-hidden="true" tabindex="-1"></a>{-t ^ 2} dt</span>
<span id="cb31-1781"><a href="#cb31-1781" aria-hidden="true" tabindex="-1"></a>\end{array}</span>
<span id="cb31-1782"><a href="#cb31-1782" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-1783"><a href="#cb31-1783" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1784"><a href="#cb31-1784" aria-hidden="true" tabindex="-1"></a>which can be approximated using Gauss-Hermite quadrature. Denoting</span>
<span id="cb31-1785"><a href="#cb31-1785" aria-hidden="true" tabindex="-1"></a>$t_r$ the nodes and $\omega_r$ the weights:\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{gaussian quadrature}</span>
<span id="cb31-1786"><a href="#cb31-1786" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1787"><a href="#cb31-1787" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-1788"><a href="#cb31-1788" aria-hidden="true" tabindex="-1"></a>\begin{array}{rcl}</span>
<span id="cb31-1789"><a href="#cb31-1789" aria-hidden="true" tabindex="-1"></a>P(y_n \mid z_{n1}, z_{n2}) &amp;\approx&amp; </span>
<span id="cb31-1790"><a href="#cb31-1790" aria-hidden="true" tabindex="-1"></a>\sum_{r = 1} ^ R</span>
<span id="cb31-1791"><a href="#cb31-1791" aria-hidden="true" tabindex="-1"></a>\omega_r \frac{e ^</span>
<span id="cb31-1792"><a href="#cb31-1792" aria-hidden="true" tabindex="-1"></a>{-\exp(\gamma_2 ^ \top z_{n2} + \sqrt{2} \sigma  t_r)}e^{y_n(\gamma_2^\top z_{n2} +</span>
<span id="cb31-1793"><a href="#cb31-1793" aria-hidden="true" tabindex="-1"></a>\sqrt{2}\sigma t_r)}}{y_n!}<span class="sc">\\</span></span>
<span id="cb31-1794"><a href="#cb31-1794" aria-hidden="true" tabindex="-1"></a>&amp;\times&amp;\Phi\left(q_n\frac{\gamma_1 ^ \top z_{n1} + \sqrt{2} \rho  t_r}{\sqrt{1 - \rho ^ 2}}\right)\frac{1}{\sqrt{\pi}} e ^ {-t_r ^ 2}</span>
<span id="cb31-1795"><a href="#cb31-1795" aria-hidden="true" tabindex="-1"></a>\end{array}</span>
<span id="cb31-1796"><a href="#cb31-1796" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-1797"><a href="#cb31-1797" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1798"><a href="#cb31-1798" aria-hidden="true" tabindex="-1"></a>For the exogenous switching model, the contribution of one observation</span>
<span id="cb31-1799"><a href="#cb31-1799" aria-hidden="true" tabindex="-1"></a>to the likelihood is given by @eq-proby. </span>
<span id="cb31-1800"><a href="#cb31-1800" aria-hidden="true" tabindex="-1"></a>For the sample selection model, the contribution of one observation to</span>
<span id="cb31-1801"><a href="#cb31-1801" aria-hidden="true" tabindex="-1"></a>the likelihood is given by @eq-probyw1 if $w_n = 1$. If $w_n =</span>
<span id="cb31-1802"><a href="#cb31-1802" aria-hidden="true" tabindex="-1"></a>0$, $y$ is unobserved and the contribution of such observations to the</span>
<span id="cb31-1803"><a href="#cb31-1803" aria-hidden="true" tabindex="-1"></a>likelihood is the probability that $w_n = 0$, which is:</span>
<span id="cb31-1804"><a href="#cb31-1804" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1805"><a href="#cb31-1805" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-1806"><a href="#cb31-1806" aria-hidden="true" tabindex="-1"></a>P(x_n = 0 \mid z_{n1}) = \int_{-\infty} ^ {+\infty}</span>
<span id="cb31-1807"><a href="#cb31-1807" aria-hidden="true" tabindex="-1"></a>\Phi\left(q_n\frac{\gamma_1 ^ \top z_{n1} + \rho / \sigma \epsilon}{\sqrt{1 -</span>
<span id="cb31-1808"><a href="#cb31-1808" aria-hidden="true" tabindex="-1"></a>\rho ^ 2}}\right)\frac{1}{\sqrt{2\pi}\sigma} e ^</span>
<span id="cb31-1809"><a href="#cb31-1809" aria-hidden="true" tabindex="-1"></a>{-\frac{1}{2}\left(\frac{\epsilon}{\sigma}\right) ^ 2} d\epsilon</span>
<span id="cb31-1810"><a href="#cb31-1810" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-1811"><a href="#cb31-1811" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1812"><a href="#cb31-1812" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{sample selection!Poisson model!maximum likelihood|)}</span>
<span id="cb31-1813"><a href="#cb31-1813" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{endogenous switching!Poisson model!maximum likelihood|)}</span>
<span id="cb31-1814"><a href="#cb31-1814" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1815"><a href="#cb31-1815" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{sample selection!Poisson model!two-step estimator|(}</span>
<span id="cb31-1816"><a href="#cb31-1816" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{endogenous switching!Poisson model!two-step estimator|(}</span>
<span id="cb31-1817"><a href="#cb31-1817" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{two-step estimator!Poisson model|(}</span>
<span id="cb31-1818"><a href="#cb31-1818" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1819"><a href="#cb31-1819" aria-hidden="true" tabindex="-1"></a>The ML estimator is computing-intensive, as the integral has no closed</span>
<span id="cb31-1820"><a href="#cb31-1820" aria-hidden="true" tabindex="-1"></a>form. One alternative is to use non-linear least squares, by first</span>
<span id="cb31-1821"><a href="#cb31-1821" aria-hidden="true" tabindex="-1"></a>computing the expectation of $y$. @TERZ:98\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Terza} showed that this expectation is:</span>
<span id="cb31-1822"><a href="#cb31-1822" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1823"><a href="#cb31-1823" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-1824"><a href="#cb31-1824" aria-hidden="true" tabindex="-1"></a>\mbox{E}(y_n\mid z_{n1}, z_{n2}) = \exp\left(\gamma_2 ^ \top z_{n2} + \ln \frac{\Phi\left(q_n(\gamma_1 ^\top</span>
<span id="cb31-1825"><a href="#cb31-1825" aria-hidden="true" tabindex="-1"></a>z_{n1} + \theta)\right)}{\Phi\left(q_n(\gamma_1 ^\top z_{n1})\right)}\right)</span>
<span id="cb31-1826"><a href="#cb31-1826" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-1827"><a href="#cb31-1827" aria-hidden="true" tabindex="-1"></a>for the endogenous switching case and:</span>
<span id="cb31-1828"><a href="#cb31-1828" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-1829"><a href="#cb31-1829" aria-hidden="true" tabindex="-1"></a>\mbox{E}(y_n\mid z_{n1}, z_{n2}, w_n = 1) = \exp\left(\gamma_2 ^\top z_{n2} + \ln \frac{\Phi(\gamma_1 ^\top z_{n1} + \theta)}{\Phi(\gamma_1 ^ \top z_{n1})}\right)</span>
<span id="cb31-1830"><a href="#cb31-1830" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-1831"><a href="#cb31-1831" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{non-linear least squares}</span>
<span id="cb31-1832"><a href="#cb31-1832" aria-hidden="true" tabindex="-1"></a>for the sample selection case, where $\theta = \sigma\rho$.</span>
<span id="cb31-1833"><a href="#cb31-1833" aria-hidden="true" tabindex="-1"></a>@GREE:01\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Greene} noted that, taking a first order Taylor series of $\ln</span>
<span id="cb31-1834"><a href="#cb31-1834" aria-hidden="true" tabindex="-1"></a>\frac{\Phi(\gamma_1 ^\top z_{n1} + \theta)}{\Phi(\gamma_1 ^ \top z_{n1})}$</span>
<span id="cb31-1835"><a href="#cb31-1835" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{Taylor series}</span>
<span id="cb31-1836"><a href="#cb31-1836" aria-hidden="true" tabindex="-1"></a>around $\theta = 0$ gives: $\theta \phi(\gamma_1 ^ \top z_{n1}) /</span>
<span id="cb31-1837"><a href="#cb31-1837" aria-hidden="true" tabindex="-1"></a>\Phi(\gamma_1 ^ \top z_{n1})$, which is the inverse mills ratio that is</span>
<span id="cb31-1838"><a href="#cb31-1838" aria-hidden="true" tabindex="-1"></a>used in the linear model in order to correct the inconsistency due to</span>
<span id="cb31-1839"><a href="#cb31-1839" aria-hidden="true" tabindex="-1"></a>sample selection. As $\gamma_1$ can be consistently estimated by a</span>
<span id="cb31-1840"><a href="#cb31-1840" aria-hidden="true" tabindex="-1"></a>probit model, the NLS estimator is obtained by minimizing with respect</span>
<span id="cb31-1841"><a href="#cb31-1841" aria-hidden="true" tabindex="-1"></a>to $\gamma_2$ and $\theta$ the sum of squares of the following residuals:</span>
<span id="cb31-1842"><a href="#cb31-1842" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1843"><a href="#cb31-1843" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-1844"><a href="#cb31-1844" aria-hidden="true" tabindex="-1"></a>y_n - e^{\gamma_2 ^ \top z_{n2} + \ln</span>
<span id="cb31-1845"><a href="#cb31-1845" aria-hidden="true" tabindex="-1"></a>\frac{\Phi(\hat{\gamma_1} ^ \top z_{n1} + \theta)}{\Phi(\hat{\gamma_1}</span>
<span id="cb31-1846"><a href="#cb31-1846" aria-hidden="true" tabindex="-1"></a>^ \top z_{n1})}}</span>
<span id="cb31-1847"><a href="#cb31-1847" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb31-1848"><a href="#cb31-1848" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1849"><a href="#cb31-1849" aria-hidden="true" tabindex="-1"></a>As it is customary for a two-step estimator, the covariance</span>
<span id="cb31-1850"><a href="#cb31-1850" aria-hidden="true" tabindex="-1"></a>matrix of the estimators should take into account the fact that</span>
<span id="cb31-1851"><a href="#cb31-1851" aria-hidden="true" tabindex="-1"></a>$\gamma_1$ has been estimated in the first step. Moreover, only $\theta</span>
<span id="cb31-1852"><a href="#cb31-1852" aria-hidden="true" tabindex="-1"></a>= \rho \sigma$ is estimated. To retrieve an estimator of $\sigma$,</span>
<span id="cb31-1853"><a href="#cb31-1853" aria-hidden="true" tabindex="-1"></a>@TERZ:98\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Terza} proposed to insert into the log-likelihood function the</span>
<span id="cb31-1854"><a href="#cb31-1854" aria-hidden="true" tabindex="-1"></a>estimated values of $\gamma_1$, $\gamma_2$ and $\theta$ and then to</span>
<span id="cb31-1855"><a href="#cb31-1855" aria-hidden="true" tabindex="-1"></a>maximize it with respect to $\sigma$.^[This once again requires the use of</span>
<span id="cb31-1856"><a href="#cb31-1856" aria-hidden="true" tabindex="-1"></a>Gauss-Hermite quadrature, but the problem is considerably simpler as</span>
<span id="cb31-1857"><a href="#cb31-1857" aria-hidden="true" tabindex="-1"></a>the likelihood is maximized with respect with only one parameter.]</span>
<span id="cb31-1858"><a href="#cb31-1858" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{sample selection!Poisson model!two-step estimator|)}</span>
<span id="cb31-1859"><a href="#cb31-1859" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{endogenous switching!Poisson model!two-step estimator|)}</span>
<span id="cb31-1860"><a href="#cb31-1860" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{two-step estimator!Poisson model|}</span>
<span id="cb31-1861"><a href="#cb31-1861" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{sample selection!Poisson model|)}</span>
<span id="cb31-1862"><a href="#cb31-1862" aria-hidden="true" tabindex="-1"></a>\index<span class="co">[</span><span class="ot">general</span><span class="co">]</span>{endogenous switching!Poisson model|)}</span>
<span id="cb31-1863"><a href="#cb31-1863" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1864"><a href="#cb31-1864" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1865"><a href="#cb31-1865" aria-hidden="true" tabindex="-1"></a>\idxfun{escount}{micsr}</span>
<span id="cb31-1866"><a href="#cb31-1866" aria-hidden="true" tabindex="-1"></a>The <span class="in">`micsr::escount`</span> function estimates the endogenous switching and the</span>
<span id="cb31-1867"><a href="#cb31-1867" aria-hidden="true" tabindex="-1"></a>sample selection model for count data. The first is obtained by</span>
<span id="cb31-1868"><a href="#cb31-1868" aria-hidden="true" tabindex="-1"></a>setting the <span class="in">`model`</span> argument to <span class="in">`'es'`</span> (the default) and the second</span>
<span id="cb31-1869"><a href="#cb31-1869" aria-hidden="true" tabindex="-1"></a>to <span class="in">`'ss'`</span>. The estimation method is selected using the <span class="in">`method`</span></span>
<span id="cb31-1870"><a href="#cb31-1870" aria-hidden="true" tabindex="-1"></a>argument, which can be either <span class="in">`"twostep"`</span> for the two-step, non-linear</span>
<span id="cb31-1871"><a href="#cb31-1871" aria-hidden="true" tabindex="-1"></a>least squares model (the default) or <span class="in">`"ml"`</span> for maximum</span>
<span id="cb31-1872"><a href="#cb31-1872" aria-hidden="true" tabindex="-1"></a>likelihood. The model is described by a two-part formula. On the left side, the outcome and the binomial responses are indicated. On the right side, the first part contains the covariates for the outcome equation and  the second part the covariates of the selection equation. Relevant only for the ML method, the</span>
<span id="cb31-1873"><a href="#cb31-1873" aria-hidden="true" tabindex="-1"></a><span class="in">`hessian`</span> argument is a boolean: if <span class="in">`TRUE`</span>, the covariance matrix of</span>
<span id="cb31-1874"><a href="#cb31-1874" aria-hidden="true" tabindex="-1"></a>the coefficients is estimated using the numerical hessian, which is</span>
<span id="cb31-1875"><a href="#cb31-1875" aria-hidden="true" tabindex="-1"></a>computed using the <span class="in">`hessian`</span> function of the **numDeriv**</span>
<span id="cb31-1876"><a href="#cb31-1876" aria-hidden="true" tabindex="-1"></a>package; otherwise, the outer product of the gradient is used and <span class="in">`R`</span> is an integer that indicates the number of points used for the</span>
<span id="cb31-1877"><a href="#cb31-1877" aria-hidden="true" tabindex="-1"></a>Gauss-Hermite quadrature method.</span>
<span id="cb31-1878"><a href="#cb31-1878" aria-hidden="true" tabindex="-1"></a><span class="in">`escount`</span> returns an object of class <span class="in">`escount`</span> which inherits from <span class="in">`micsr`</span>. </span>
<span id="cb31-1879"><a href="#cb31-1879" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1880"><a href="#cb31-1880" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Physician advice and alcohol consumption</span></span>
<span id="cb31-1881"><a href="#cb31-1881" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1882"><a href="#cb31-1882" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">(</span><span class="co">]</span>{drinks}{micsr}</span>
<span id="cb31-1883"><a href="#cb31-1883" aria-hidden="true" tabindex="-1"></a>@KENK:TERZ:01\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Kenkel}\index<span class="co">[</span><span class="ot">author</span><span class="co">]</span>{Terza} investigate the effect of physician's advice on alcohol</span>
<span id="cb31-1884"><a href="#cb31-1884" aria-hidden="true" tabindex="-1"></a>consumption; the data set is called <span class="in">`drinks`</span>. The outcome variable <span class="in">`drinks`</span> is the number of drinks in</span>
<span id="cb31-1885"><a href="#cb31-1885" aria-hidden="true" tabindex="-1"></a>the past 2 weeks and the selection variable <span class="in">`advice`</span> is a dummy based</span>
<span id="cb31-1886"><a href="#cb31-1886" aria-hidden="true" tabindex="-1"></a>on the respondents' answer to the question: "Have you ever been told</span>
<span id="cb31-1887"><a href="#cb31-1887" aria-hidden="true" tabindex="-1"></a>by a physician to drink less". The unobserved part of the equation</span>
<span id="cb31-1888"><a href="#cb31-1888" aria-hidden="true" tabindex="-1"></a>indicating the propensity to receive advice from the physician can</span>
<span id="cb31-1889"><a href="#cb31-1889" aria-hidden="true" tabindex="-1"></a>obviously be correlated with the one of the alcohol consumption</span>
<span id="cb31-1890"><a href="#cb31-1890" aria-hidden="true" tabindex="-1"></a>equation. The covariates are monthly income in thousands of dollars</span>
<span id="cb31-1891"><a href="#cb31-1891" aria-hidden="true" tabindex="-1"></a>(<span class="in">`income`</span>), <span class="in">`age`</span> (a factor with six 10-year categories of age),</span>
<span id="cb31-1892"><a href="#cb31-1892" aria-hidden="true" tabindex="-1"></a>education in years (<span class="in">`educ`</span>), <span class="in">`race`</span> (a factor with levels <span class="in">`white`</span>,</span>
<span id="cb31-1893"><a href="#cb31-1893" aria-hidden="true" tabindex="-1"></a><span class="in">`black`</span> and <span class="in">`other`</span>), marital status (<span class="in">`marital`</span>, a factor with</span>
<span id="cb31-1894"><a href="#cb31-1894" aria-hidden="true" tabindex="-1"></a>levels <span class="in">`single`</span>, <span class="in">`married`</span>, <span class="in">`widow`</span>, <span class="in">`separated`</span>), employment</span>
<span id="cb31-1895"><a href="#cb31-1895" aria-hidden="true" tabindex="-1"></a>status (a factor <span class="in">`empstatus`</span> with levels <span class="in">`other`</span>, <span class="in">`emp`</span> and <span class="in">`unemp`</span>)</span>
<span id="cb31-1896"><a href="#cb31-1896" aria-hidden="true" tabindex="-1"></a>and region (<span class="in">`region`</span>, a factor with levels <span class="in">`west`</span>, <span class="in">`northeast`</span>,</span>
<span id="cb31-1897"><a href="#cb31-1897" aria-hidden="true" tabindex="-1"></a><span class="in">`midwest`</span> and <span class="in">`south`</span>). For the binomial part of the model, the same</span>
<span id="cb31-1898"><a href="#cb31-1898" aria-hidden="true" tabindex="-1"></a>covariates are used (except of course <span class="in">`advice`</span>) and 10 supplementary</span>
<span id="cb31-1899"><a href="#cb31-1899" aria-hidden="true" tabindex="-1"></a>covariates indicating insurance coverage and health status are</span>
<span id="cb31-1900"><a href="#cb31-1900" aria-hidden="true" tabindex="-1"></a>added.</span>
<span id="cb31-1901"><a href="#cb31-1901" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1902"><a href="#cb31-1902" aria-hidden="true" tabindex="-1"></a>@tbl-drinksres presents the results of a Poisson</span>
<span id="cb31-1903"><a href="#cb31-1903" aria-hidden="true" tabindex="-1"></a>model and of the endogenous switching model, estimated by the</span>
<span id="cb31-1904"><a href="#cb31-1904" aria-hidden="true" tabindex="-1"></a>two-step, non-linear least squares and by the maximum likelihood estimators.^[The</span>
<span id="cb31-1905"><a href="#cb31-1905" aria-hidden="true" tabindex="-1"></a>coefficients of <span class="in">`marital`</span>, <span class="in">`empstatus`</span>, <span class="in">`income`</span>, <span class="in">`race`</span> and <span class="in">`region`</span> are omitted to</span>
<span id="cb31-1906"><a href="#cb31-1906" aria-hidden="true" tabindex="-1"></a>save place.]</span>
<span id="cb31-1907"><a href="#cb31-1907" aria-hidden="true" tabindex="-1"></a>The coefficient of <span class="in">`advice`</span> in the alcohol demand equation is positive</span>
<span id="cb31-1908"><a href="#cb31-1908" aria-hidden="true" tabindex="-1"></a>in the Poisson model, which would imply that a physician's advice have a positive effect on alcohol consumption. The estimation of the</span>
<span id="cb31-1909"><a href="#cb31-1909" aria-hidden="true" tabindex="-1"></a>endogenous switching model shows that this positive coefficient is</span>
<span id="cb31-1910"><a href="#cb31-1910" aria-hidden="true" tabindex="-1"></a>due to the positive correlation between the error terms of the two</span>
<span id="cb31-1911"><a href="#cb31-1911" aria-hidden="true" tabindex="-1"></a>equations (the unobserved propensities to drink and to receive</span>
<span id="cb31-1912"><a href="#cb31-1912" aria-hidden="true" tabindex="-1"></a>advice from a physician are positively correlated).</span>
<span id="cb31-1913"><a href="#cb31-1913" aria-hidden="true" tabindex="-1"></a>\idxfun{glm}{stats}\idxfun{escount}{micsr}\idxfun{update}{stats}</span>
<span id="cb31-1914"><a href="#cb31-1914" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1915"><a href="#cb31-1915" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb31-1916"><a href="#cb31-1916" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: drinksest</span></span>
<span id="cb31-1917"><a href="#cb31-1917" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb31-1918"><a href="#cb31-1918" aria-hidden="true" tabindex="-1"></a><span class="co">#| cache: true</span></span>
<span id="cb31-1919"><a href="#cb31-1919" aria-hidden="true" tabindex="-1"></a>kt_pois <span class="ot">&lt;-</span> <span class="fu">glm</span>(drinks <span class="sc">~</span> advice <span class="sc">+</span> income <span class="sc">+</span> age <span class="sc">+</span> educ <span class="sc">+</span> race <span class="sc">+</span> marital <span class="sc">+</span> </span>
<span id="cb31-1920"><a href="#cb31-1920" aria-hidden="true" tabindex="-1"></a>                 empstatus <span class="sc">+</span> region, <span class="at">data =</span> drinks, <span class="at">family =</span> poisson)</span>
<span id="cb31-1921"><a href="#cb31-1921" aria-hidden="true" tabindex="-1"></a>kt_ml <span class="ot">&lt;-</span> <span class="fu">escount</span>(drinks <span class="sc">+</span> advice <span class="sc">~</span> advice <span class="sc">+</span> income <span class="sc">+</span> age <span class="sc">+</span> educ <span class="sc">+</span> race <span class="sc">+</span> </span>
<span id="cb31-1922"><a href="#cb31-1922" aria-hidden="true" tabindex="-1"></a>                   marital <span class="sc">+</span> empstatus <span class="sc">+</span> region <span class="sc">|</span> . <span class="sc">-</span> advice <span class="sc">+</span> medicare <span class="sc">+</span> </span>
<span id="cb31-1923"><a href="#cb31-1923" aria-hidden="true" tabindex="-1"></a>                   medicaid <span class="sc">+</span> champus <span class="sc">+</span> hlthins <span class="sc">+</span> regmed <span class="sc">+</span> dri <span class="sc">+</span> limits <span class="sc">+</span> </span>
<span id="cb31-1924"><a href="#cb31-1924" aria-hidden="true" tabindex="-1"></a>                   diabete <span class="sc">+</span> hearthcond <span class="sc">+</span> stroke,</span>
<span id="cb31-1925"><a href="#cb31-1925" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> drinks, <span class="at">method =</span> <span class="st">"ml"</span>)</span>
<span id="cb31-1926"><a href="#cb31-1926" aria-hidden="true" tabindex="-1"></a>kt_2s <span class="ot">&lt;-</span> <span class="fu">update</span>(kt_ml, <span class="at">method =</span> <span class="st">"twostep"</span>)</span>
<span id="cb31-1927"><a href="#cb31-1927" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-1928"><a href="#cb31-1928" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1929"><a href="#cb31-1929" aria-hidden="true" tabindex="-1"></a><span class="in">```{r }</span></span>
<span id="cb31-1930"><a href="#cb31-1930" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-drinksres</span></span>
<span id="cb31-1931"><a href="#cb31-1931" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb31-1932"><a href="#cb31-1932" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb31-1933"><a href="#cb31-1933" aria-hidden="true" tabindex="-1"></a><span class="co">#| results: true</span></span>
<span id="cb31-1934"><a href="#cb31-1934" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Poisson and endogenous switching models for alcohol demand"</span></span>
<span id="cb31-1935"><a href="#cb31-1935" aria-hidden="true" tabindex="-1"></a>modelsummary<span class="sc">::</span><span class="fu">msummary</span>(<span class="fu">list</span>(<span class="st">"Poisson"</span> <span class="ot">=</span> kt_pois, <span class="st">"two-step"</span> <span class="ot">=</span> kt_2s, <span class="st">"ML"</span> <span class="ot">=</span> kt_ml),</span>
<span id="cb31-1936"><a href="#cb31-1936" aria-hidden="true" tabindex="-1"></a>         <span class="at">gof_omit =</span> <span class="st">"AIC|BIC|Log.Lik."</span>,</span>
<span id="cb31-1937"><a href="#cb31-1937" aria-hidden="true" tabindex="-1"></a>         <span class="at">label =</span> <span class="st">"tbl-drinksres"</span>,</span>
<span id="cb31-1938"><a href="#cb31-1938" aria-hidden="true" tabindex="-1"></a>         <span class="at">coef_omit =</span> <span class="st">"region|marital|empstatus|age|Intercept|race|incomes"</span>,</span>
<span id="cb31-1939"><a href="#cb31-1939" aria-hidden="true" tabindex="-1"></a>         <span class="at">output =</span> <span class="st">"kableExtra"</span>)</span>
<span id="cb31-1940"><a href="#cb31-1940" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb31-1941"><a href="#cb31-1941" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-1942"><a href="#cb31-1942" aria-hidden="true" tabindex="-1"></a>\idxdata<span class="co">[</span><span class="ot">)</span><span class="co">]</span>{drinks}{micsr}</span>
<span id="cb31-1943"><a href="#cb31-1943" aria-hidden="true" tabindex="-1"></a>\clearpage</span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



</body></html>